var Mg=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);import*as nc from"https://cdn.jsdelivr.net/npm/web-ifc@0.0.51/web-ifc-api.js";var yF=Mg((Pl,ra)=>{(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))s(t);new MutationObserver(t=>{for(const o of t)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function i(t){const o={};return t.integrity&&(o.integrity=t.integrity),t.referrerPolicy&&(o.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?o.credentials="include":t.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(t){if(t.ep)return;t.ep=!0;const o=i(t);fetch(t.href,o)}})();class Ci{constructor(e,i){this.items=e||[],this._lastUniqueId=(i||0)+1}addItem(){let e;if(arguments.length===2){const i=arguments[0];if(e=arguments[1],this.items[i])throw"ID clash: '"+i+"'";return this.items[i]=e,i}else for(e=arguments[0]||{};;){const i=this._lastUniqueId++;if(!this.items[i])return this.items[i]=e,i}}removeItem(e){const i=this.items[e];return delete this.items[e],i}}const ac=new Ci;class Sg{constructor(e){this.id=e,this.parentItem=null,this.groups=[],this.menuElement=null,this.shown=!1,this.mouseOver=0}}class Tg{constructor(){this.items=[]}}class Dg{constructor(e,i,s,t,o){this.id=e,this.getTitle=i,this.doAction=s,this.getEnabled=t,this.getShown=o,this.itemElement=null,this.subMenu=null,this.enabled=!0}}class RA{constructor(e={}){this._id=ac.addItem(),this._context=null,this._enabled=!1,this._itemsCfg=[],this._rootMenu=null,this._menuList=[],this._menuMap={},this._itemList=[],this._itemMap={},this._shown=!1,this._nextId=0,this._eventSubs={},e.hideOnMouseDown!==!1&&(document.addEventListener("mousedown",i=>{i.target.classList.contains("xeokit-context-menu-item")||this.hide()}),document.addEventListener("touchstart",this._canvasTouchStartHandler=i=>{i.target.classList.contains("xeokit-context-menu-item")||this.hide()})),e.items&&(this.items=e.items),this._hideOnAction=e.hideOnAction!==!1,this.context=e.context,this.enabled=e.enabled!==!1,this.hide()}on(e,i){let s=this._eventSubs[e];s||(s=[],this._eventSubs[e]=s),s.push(i)}fire(e,i){const s=this._eventSubs[e];if(s)for(let t=0,o=s.length;t<o;t++)s[t](i)}set items(e){this._clear(),this._itemsCfg=e||[],this._parseItems(e),this._createUI()}get items(){return this._itemsCfg}set enabled(e){e=!!e,e!==this._enabled&&(this._enabled=e,this._enabled||this.hide())}get enabled(){return this._enabled}set context(e){this._context=e}get context(){return this._context}show(e,i){if(!this._context){console.error("ContextMenu cannot be shown without a context - set context first");return}this._enabled&&(this._shown||(this._hideAllMenus(),this._updateItemsTitles(),this._updateItemsEnabledStatus(),this._showMenu(this._rootMenu.id,e,i),this._shown=!0,this.fire("shown",{})))}get shown(){return this._shown}hide(){this._enabled&&this._shown&&(this._hideAllMenus(),this._shown=!1,this.fire("hidden",{}))}destroy(){this._context=null,this._clear(),this._id!==null&&(ac.removeItem(this._id),this._id=null)}_clear(){for(let e=0,i=this._menuList.length;e<i;e++){const t=this._menuList[e].menuElement;t.parentElement.removeChild(t)}this._itemsCfg=[],this._rootMenu=null,this._menuList=[],this._menuMap={},this._itemList=[],this._itemMap={}}_parseItems(e){const i=s=>{const t=this._getNextId(),o=new Sg(t);for(let n=0,a=s.length;n<a;n++){const A=s[n],l=new Tg;o.groups.push(l);for(let h=0,d=A.length;h<d;h++){const f=A[h],m=f.items,_=m&&m.length>0,u=this._getNextId(),P=f.getTitle||(()=>f.title||""),y=f.doAction||f.callback||(()=>{}),x=f.getEnabled||(()=>!0),B=f.getShown||(()=>!0),v=new Dg(u,P,y,x,B);if(v.parentMenu=o,l.items.push(v),_){const w=i(m);v.subMenu=w,w.parentItem=v}this._itemList.push(v),this._itemMap[v.id]=v}}return this._menuList.push(o),this._menuMap[o.id]=o,o};this._rootMenu=i(e)}_getNextId(){return"ContextMenu_"+this._id+"_"+this._nextId++}_createUI(){const e=i=>{this._createMenuUI(i);const s=i.groups;for(let t=0,o=s.length;t<o;t++){const a=s[t].items;for(let A=0,l=a.length;A<l;A++){const d=a[A].subMenu;d&&e(d)}}};e(this._rootMenu)}_createMenuUI(e){const i=e.groups,s=[];if(s.push('<div class="xeokit-context-menu '+e.id+'" style="z-index:300000; position: absolute;">'),s.push("<ul>"),i)for(let A=0,l=i.length;A<l;A++){const h=i[A],d=A,f=l,m=h.items;if(m)for(let _=0,u=m.length;_<u;_++){const P=m[_],y=P.subMenu,x=P.title||"";y?s.push('<li id="'+P.id+'" class="xeokit-context-menu-item" style="'+(d===f-1||_<u-1?"border-bottom: 0":"border-bottom: 1px solid black")+'">'+x+" [MORE]</li>"):s.push('<li id="'+P.id+'" class="xeokit-context-menu-item" style="'+(d===f-1||_<u-1?"border-bottom: 0":"border-bottom: 1px solid black")+'">'+x+"</li>")}}s.push("</ul>"),s.push("</div>");const t=s.join("");document.body.insertAdjacentHTML("beforeend",t);const o=document.querySelector("."+e.id);e.menuElement=o,o.style["border-radius"]="4px",o.style.display="none",o.style["z-index"]=3e5,o.style.background="white",o.style.border="1px solid black",o.style["box-shadow"]="0 4px 5px 0 gray",o.oncontextmenu=A=>{A.preventDefault()};const n=this;let a=null;if(i)for(let A=0,l=i.length;A<l;A++){const d=i[A].items;if(d)for(let f=0,m=d.length;f<m;f++){const _=d[f],u=_.subMenu;if(_.itemElement=document.getElementById(_.id),!_.itemElement){console.error("ContextMenu item element not found: "+_.id);continue}_.itemElement.addEventListener("mouseenter",P=>{P.preventDefault();const y=_.subMenu;if(!y){a&&(n._hideMenu(a.id),a=null);return}if(a&&a.id!==y.id&&(n._hideMenu(a.id),a=null),_.enabled===!1)return;const x=_.itemElement,B=y.menuElement,v=x.getBoundingClientRect();B.getBoundingClientRect();const w=200;v.right+w>window.innerWidth?n._showMenu(y.id,v.left-w,v.top-1):n._showMenu(y.id,v.right-5,v.top-1),a=y}),u||(_.itemElement.addEventListener("click",P=>{P.preventDefault(),n._context&&_.enabled!==!1&&(_.doAction&&_.doAction(n._context),this._hideOnAction?n.hide():(n._updateItemsTitles(),n._updateItemsEnabledStatus()))}),_.itemElement.addEventListener("mouseup",P=>{P.which===3&&(P.preventDefault(),n._context&&_.enabled!==!1&&(_.doAction&&_.doAction(n._context),this._hideOnAction?n.hide():(n._updateItemsTitles(),n._updateItemsEnabledStatus())))}),_.itemElement.addEventListener("mouseenter",P=>{P.preventDefault(),_.enabled!==!1&&_.doHover&&_.doHover(n._context)}))}}}_updateItemsTitles(){if(this._context)for(let e=0,i=this._itemList.length;e<i;e++){const s=this._itemList[e],t=s.itemElement;if(!t)continue;const o=s.getShown;if(!o||!o(this._context))continue;const n=s.getTitle(this._context);s.subMenu,t.innerText=n}}_updateItemsEnabledStatus(){if(this._context)for(let e=0,i=this._itemList.length;e<i;e++){const s=this._itemList[e],t=s.itemElement;if(!t)continue;const o=s.getEnabled;if(!o)continue;const n=s.getShown;if(!n)continue;const a=n(this._context);if(s.shown=a,a)t.style.visibility="visible",t.style.height="auto",t.style.padding=null;else{t.style.visibility="hidden",t.style.height="0",t.style.padding="0";continue}const A=o(this._context);s.enabled=A,A?t.classList.remove("disabled"):t.classList.add("disabled")}}_showMenu(e,i,s){const t=this._menuMap[e];if(!t){console.error("Menu not found: "+e);return}if(t.shown)return;const o=t.menuElement;o&&(this._showMenuElement(o,i,s),t.shown=!0)}_hideMenu(e){const i=this._menuMap[e];if(!i){console.error("Menu not found: "+e);return}if(!i.shown)return;const s=i.menuElement;s&&(this._hideMenuElement(s),i.shown=!1)}_hideAllMenus(){for(let e=0,i=this._menuList.length;e<i;e++){const s=this._menuList[e];this._hideMenu(s.id)}}_showMenuElement(e,i,s){e.style.display="block";const t=e.offsetHeight,o=e.offsetWidth;s+t>window.innerHeight&&(s=window.innerHeight-t),i+o>window.innerWidth&&(i=window.innerWidth-o),e.style.left=i+"px",e.style.top=s+"px"}_hideMenuElement(e){e.style.display="none"}}let mn=!0,ye=mn?Float64Array:Float32Array;const Ms=new ye(3),Eo=new ye(16),Io=new ye(16),Rg=new ye(4),c={setDoublePrecisionEnabled(r){mn=r,ye=mn?Float64Array:Float32Array},getDoublePrecisionEnabled(){return mn},MIN_DOUBLE:-Number.MAX_SAFE_INTEGER,MAX_DOUBLE:Number.MAX_SAFE_INTEGER,MAX_INT:1e7,DEGTORAD:.0174532925,RADTODEG:57.295779513,unglobalizeObjectId(r,e){const i=e.indexOf("#");return i===r.length&&e.startsWith(r)?e.substring(i+1):e},globalizeObjectId(r,e){return r+"#"+e},safeInv(r){const e=1/r;return isNaN(e)||!isFinite(e)?1:e},vec2(r){return new ye(r||2)},vec3(r){return new ye(r||3)},vec4(r){return new ye(r||4)},mat3(r){return new ye(r||9)},mat3ToMat4(r,e=new ye(16)){return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=0,e[4]=r[3],e[5]=r[4],e[6]=r[5],e[7]=0,e[8]=r[6],e[9]=r[7],e[10]=r[8],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},mat4(r){return new ye(r||16)},mat4ToMat3(r,e){},doublesToFloats(r,e,i){const s=new ye(2);for(let t=0,o=r.length;t<o;t++)c.splitDouble(r[t],s),e[t]=s[0],i[t]=s[1]},splitDouble(r,e){const i=ye.from([r])[0],s=r-i;e[0]=i,e[1]=s},createUUID:(()=>{const r=[];for(let e=0;e<256;e++)r[e]=(e<16?"0":"")+e.toString(16);return()=>{const e=Math.random()*4294967295|0,i=Math.random()*4294967295|0,s=Math.random()*4294967295|0,t=Math.random()*4294967295|0;return`${r[e&255]+r[e>>8&255]+r[e>>16&255]+r[e>>24&255]}-${r[i&255]}${r[i>>8&255]}-${r[i>>16&15|64]}${r[i>>24&255]}-${r[s&63|128]}${r[s>>8&255]}-${r[s>>16&255]}${r[s>>24&255]}${r[t&255]}${r[t>>8&255]}${r[t>>16&255]}${r[t>>24&255]}`}})(),clamp(r,e,i){return Math.max(e,Math.min(i,r))},fmod(r,e){if(r<e)return console.error("math.fmod : Attempting to find modulus within negative range - would be infinite loop - ignoring"),r;for(;e<=r;)r-=e;return r},compareVec3(r,e){return r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2]},negateVec3(r,e){return e||(e=r),e[0]=-r[0],e[1]=-r[1],e[2]=-r[2],e},negateVec4(r,e){return e||(e=r),e[0]=-r[0],e[1]=-r[1],e[2]=-r[2],e[3]=-r[3],e},addVec4(r,e,i){return i||(i=r),i[0]=r[0]+e[0],i[1]=r[1]+e[1],i[2]=r[2]+e[2],i[3]=r[3]+e[3],i},addVec4Scalar(r,e,i){return i||(i=r),i[0]=r[0]+e,i[1]=r[1]+e,i[2]=r[2]+e,i[3]=r[3]+e,i},addVec3(r,e,i){return i||(i=r),i[0]=r[0]+e[0],i[1]=r[1]+e[1],i[2]=r[2]+e[2],i},addVec3Scalar(r,e,i){return i||(i=r),i[0]=r[0]+e,i[1]=r[1]+e,i[2]=r[2]+e,i},subVec4(r,e,i){return i||(i=r),i[0]=r[0]-e[0],i[1]=r[1]-e[1],i[2]=r[2]-e[2],i[3]=r[3]-e[3],i},subVec3(r,e,i){return i||(i=r),i[0]=r[0]-e[0],i[1]=r[1]-e[1],i[2]=r[2]-e[2],i},subVec2(r,e,i){return i||(i=r),i[0]=r[0]-e[0],i[1]=r[1]-e[1],i},geometricMeanVec2(...r){const e=new ye(r[0]);for(let i=1;i<r.length;i++)e[0]+=r[i][0],e[1]+=r[i][1];return e[0]/=r.length,e[1]/=r.length,e},subVec4Scalar(r,e,i){return i||(i=r),i[0]=r[0]-e,i[1]=r[1]-e,i[2]=r[2]-e,i[3]=r[3]-e,i},subScalarVec4(r,e,i){return i||(i=r),i[0]=e-r[0],i[1]=e-r[1],i[2]=e-r[2],i[3]=e-r[3],i},mulVec4(r,e,i){return i||(i=r),i[0]=r[0]*e[0],i[1]=r[1]*e[1],i[2]=r[2]*e[2],i[3]=r[3]*e[3],i},mulVec4Scalar(r,e,i){return i||(i=r),i[0]=r[0]*e,i[1]=r[1]*e,i[2]=r[2]*e,i[3]=r[3]*e,i},mulVec3Scalar(r,e,i){return i||(i=r),i[0]=r[0]*e,i[1]=r[1]*e,i[2]=r[2]*e,i},mulVec2Scalar(r,e,i){return i||(i=r),i[0]=r[0]*e,i[1]=r[1]*e,i},divVec3(r,e,i){return i||(i=r),i[0]=r[0]/e[0],i[1]=r[1]/e[1],i[2]=r[2]/e[2],i},divVec4(r,e,i){return i||(i=r),i[0]=r[0]/e[0],i[1]=r[1]/e[1],i[2]=r[2]/e[2],i[3]=r[3]/e[3],i},divScalarVec3(r,e,i){return i||(i=e),i[0]=r/e[0],i[1]=r/e[1],i[2]=r/e[2],i},divVec3Scalar(r,e,i){return i||(i=r),i[0]=r[0]/e,i[1]=r[1]/e,i[2]=r[2]/e,i},divVec4Scalar(r,e,i){return i||(i=r),i[0]=r[0]/e,i[1]=r[1]/e,i[2]=r[2]/e,i[3]=r[3]/e,i},divScalarVec4(r,e,i){return i||(i=e),i[0]=r/e[0],i[1]=r/e[1],i[2]=r/e[2],i[3]=r/e[3],i},dotVec4(r,e){return r[0]*e[0]+r[1]*e[1]+r[2]*e[2]+r[3]*e[3]},cross3Vec4(r,e){const i=r[0],s=r[1],t=r[2],o=e[0],n=e[1],a=e[2];return[s*a-t*n,t*o-i*a,i*n-s*o,0]},cross3Vec3(r,e,i){i||(i=r);const s=r[0],t=r[1],o=r[2],n=e[0],a=e[1],A=e[2];return i[0]=t*A-o*a,i[1]=o*n-s*A,i[2]=s*a-t*n,i},sqLenVec4(r){return c.dotVec4(r,r)},lenVec4(r){return Math.sqrt(c.sqLenVec4(r))},dotVec3(r,e){return r[0]*e[0]+r[1]*e[1]+r[2]*e[2]},dotVec2(r,e){return r[0]*e[0]+r[1]*e[1]},sqLenVec3(r){return c.dotVec3(r,r)},sqLenVec2(r){return c.dotVec2(r,r)},lenVec3(r){return Math.sqrt(c.sqLenVec3(r))},distVec3:(()=>{const r=new ye(3);return(e,i)=>c.lenVec3(c.subVec3(e,i,r))})(),lenVec2(r){return Math.sqrt(c.sqLenVec2(r))},distVec2:(()=>{const r=new ye(2);return(e,i)=>c.lenVec2(c.subVec2(e,i,r))})(),rcpVec3(r,e){return c.divScalarVec3(1,r,e)},normalizeVec4(r,e){const i=1/c.lenVec4(r);return c.mulVec4Scalar(r,i,e)},normalizeVec3(r,e){const i=1/c.lenVec3(r);return c.mulVec3Scalar(r,i,e)},normalizeVec2(r,e){const i=1/c.lenVec2(r);return c.mulVec2Scalar(r,i,e)},angleVec3(r,e){let i=c.dotVec3(r,e)/Math.sqrt(c.sqLenVec3(r)*c.sqLenVec3(e));return i=i<-1?-1:i>1?1:i,Math.acos(i)},vec3FromMat4Scale:(()=>{const r=new ye(3);return(e,i)=>(r[0]=e[0],r[1]=e[1],r[2]=e[2],i[0]=c.lenVec3(r),r[0]=e[4],r[1]=e[5],r[2]=e[6],i[1]=c.lenVec3(r),r[0]=e[8],r[1]=e[9],r[2]=e[10],i[2]=c.lenVec3(r),i)})(),vecToArray:(()=>{function r(e){return Math.round(e*1e5)/1e5}return e=>{e=Array.prototype.slice.call(e);for(let i=0,s=e.length;i<s;i++)e[i]=r(e[i]);return e}})(),xyzArrayToObject(r){return{x:r[0],y:r[1],z:r[2]}},xyzObjectToArray(r,e){return e=e||c.vec3(),e[0]=r.x,e[1]=r.y,e[2]=r.z,e},dupMat4(r){return r.slice(0,16)},mat4To3(r){return[r[0],r[1],r[2],r[4],r[5],r[6],r[8],r[9],r[10]]},m4s(r){return[r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r]},setMat4ToZeroes(){return c.m4s(0)},setMat4ToOnes(){return c.m4s(1)},diagonalMat4v(r){return new ye([r[0],0,0,0,0,r[1],0,0,0,0,r[2],0,0,0,0,r[3]])},diagonalMat4c(r,e,i,s){return c.diagonalMat4v([r,e,i,s])},diagonalMat4s(r){return c.diagonalMat4c(r,r,r,r)},identityMat4(r=new ye(16)){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r},identityMat3(r=new ye(9)){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=0,r[7]=0,r[8]=1,r},isIdentityMat4(r){return!(r[0]!==1||r[1]!==0||r[2]!==0||r[3]!==0||r[4]!==0||r[5]!==1||r[6]!==0||r[7]!==0||r[8]!==0||r[9]!==0||r[10]!==1||r[11]!==0||r[12]!==0||r[13]!==0||r[14]!==0||r[15]!==1)},negateMat4(r,e){return e||(e=r),e[0]=-r[0],e[1]=-r[1],e[2]=-r[2],e[3]=-r[3],e[4]=-r[4],e[5]=-r[5],e[6]=-r[6],e[7]=-r[7],e[8]=-r[8],e[9]=-r[9],e[10]=-r[10],e[11]=-r[11],e[12]=-r[12],e[13]=-r[13],e[14]=-r[14],e[15]=-r[15],e},addMat4(r,e,i){return i||(i=r),i[0]=r[0]+e[0],i[1]=r[1]+e[1],i[2]=r[2]+e[2],i[3]=r[3]+e[3],i[4]=r[4]+e[4],i[5]=r[5]+e[5],i[6]=r[6]+e[6],i[7]=r[7]+e[7],i[8]=r[8]+e[8],i[9]=r[9]+e[9],i[10]=r[10]+e[10],i[11]=r[11]+e[11],i[12]=r[12]+e[12],i[13]=r[13]+e[13],i[14]=r[14]+e[14],i[15]=r[15]+e[15],i},addMat4Scalar(r,e,i){return i||(i=r),i[0]=r[0]+e,i[1]=r[1]+e,i[2]=r[2]+e,i[3]=r[3]+e,i[4]=r[4]+e,i[5]=r[5]+e,i[6]=r[6]+e,i[7]=r[7]+e,i[8]=r[8]+e,i[9]=r[9]+e,i[10]=r[10]+e,i[11]=r[11]+e,i[12]=r[12]+e,i[13]=r[13]+e,i[14]=r[14]+e,i[15]=r[15]+e,i},addScalarMat4(r,e,i){return c.addMat4Scalar(e,r,i)},subMat4(r,e,i){return i||(i=r),i[0]=r[0]-e[0],i[1]=r[1]-e[1],i[2]=r[2]-e[2],i[3]=r[3]-e[3],i[4]=r[4]-e[4],i[5]=r[5]-e[5],i[6]=r[6]-e[6],i[7]=r[7]-e[7],i[8]=r[8]-e[8],i[9]=r[9]-e[9],i[10]=r[10]-e[10],i[11]=r[11]-e[11],i[12]=r[12]-e[12],i[13]=r[13]-e[13],i[14]=r[14]-e[14],i[15]=r[15]-e[15],i},subMat4Scalar(r,e,i){return i||(i=r),i[0]=r[0]-e,i[1]=r[1]-e,i[2]=r[2]-e,i[3]=r[3]-e,i[4]=r[4]-e,i[5]=r[5]-e,i[6]=r[6]-e,i[7]=r[7]-e,i[8]=r[8]-e,i[9]=r[9]-e,i[10]=r[10]-e,i[11]=r[11]-e,i[12]=r[12]-e,i[13]=r[13]-e,i[14]=r[14]-e,i[15]=r[15]-e,i},subScalarMat4(r,e,i){return i||(i=e),i[0]=r-e[0],i[1]=r-e[1],i[2]=r-e[2],i[3]=r-e[3],i[4]=r-e[4],i[5]=r-e[5],i[6]=r-e[6],i[7]=r-e[7],i[8]=r-e[8],i[9]=r-e[9],i[10]=r-e[10],i[11]=r-e[11],i[12]=r-e[12],i[13]=r-e[13],i[14]=r-e[14],i[15]=r-e[15],i},mulMat4(r,e,i){i||(i=r);const s=r[0],t=r[1],o=r[2],n=r[3],a=r[4],A=r[5],l=r[6],h=r[7],d=r[8],f=r[9],m=r[10],_=r[11],u=r[12],P=r[13],y=r[14],x=r[15],B=e[0],v=e[1],w=e[2],C=e[3],I=e[4],E=e[5],S=e[6],R=e[7],D=e[8],K=e[9],G=e[10],z=e[11],le=e[12],ue=e[13],ae=e[14],Pe=e[15];return i[0]=B*s+v*a+w*d+C*u,i[1]=B*t+v*A+w*f+C*P,i[2]=B*o+v*l+w*m+C*y,i[3]=B*n+v*h+w*_+C*x,i[4]=I*s+E*a+S*d+R*u,i[5]=I*t+E*A+S*f+R*P,i[6]=I*o+E*l+S*m+R*y,i[7]=I*n+E*h+S*_+R*x,i[8]=D*s+K*a+G*d+z*u,i[9]=D*t+K*A+G*f+z*P,i[10]=D*o+K*l+G*m+z*y,i[11]=D*n+K*h+G*_+z*x,i[12]=le*s+ue*a+ae*d+Pe*u,i[13]=le*t+ue*A+ae*f+Pe*P,i[14]=le*o+ue*l+ae*m+Pe*y,i[15]=le*n+ue*h+ae*_+Pe*x,i},mulMat3(r,e,i){i||(i=new ye(9));const s=r[0],t=r[3],o=r[6],n=r[1],a=r[4],A=r[7],l=r[2],h=r[5],d=r[8],f=e[0],m=e[3],_=e[6],u=e[1],P=e[4],y=e[7],x=e[2],B=e[5],v=e[8];return i[0]=s*f+t*u+o*x,i[3]=s*m+t*P+o*B,i[6]=s*_+t*y+o*v,i[1]=n*f+a*u+A*x,i[4]=n*m+a*P+A*B,i[7]=n*_+a*y+A*v,i[2]=l*f+h*u+d*x,i[5]=l*m+h*P+d*B,i[8]=l*_+h*y+d*v,i},mulMat4Scalar(r,e,i){return i||(i=r),i[0]=r[0]*e,i[1]=r[1]*e,i[2]=r[2]*e,i[3]=r[3]*e,i[4]=r[4]*e,i[5]=r[5]*e,i[6]=r[6]*e,i[7]=r[7]*e,i[8]=r[8]*e,i[9]=r[9]*e,i[10]=r[10]*e,i[11]=r[11]*e,i[12]=r[12]*e,i[13]=r[13]*e,i[14]=r[14]*e,i[15]=r[15]*e,i},mulMat4v4(r,e,i=c.vec4()){const s=e[0],t=e[1],o=e[2],n=e[3];return i[0]=r[0]*s+r[4]*t+r[8]*o+r[12]*n,i[1]=r[1]*s+r[5]*t+r[9]*o+r[13]*n,i[2]=r[2]*s+r[6]*t+r[10]*o+r[14]*n,i[3]=r[3]*s+r[7]*t+r[11]*o+r[15]*n,i},transposeMat4(r,e){const i=r[4],s=r[14],t=r[8],o=r[13],n=r[12],a=r[9];if(!e||r===e){const A=r[1],l=r[2],h=r[3],d=r[6],f=r[7],m=r[11];return r[1]=i,r[2]=t,r[3]=n,r[4]=A,r[6]=a,r[7]=o,r[8]=l,r[9]=d,r[11]=s,r[12]=h,r[13]=f,r[14]=m,r}return e[0]=r[0],e[1]=i,e[2]=t,e[3]=n,e[4]=r[1],e[5]=r[5],e[6]=a,e[7]=o,e[8]=r[2],e[9]=r[6],e[10]=r[10],e[11]=s,e[12]=r[3],e[13]=r[7],e[14]=r[11],e[15]=r[15],e},transposeMat3(r,e){if(e===r){const i=r[1],s=r[2],t=r[5];e[1]=r[3],e[2]=r[6],e[3]=i,e[5]=r[7],e[6]=s,e[7]=t}else e[0]=r[0],e[1]=r[3],e[2]=r[6],e[3]=r[1],e[4]=r[4],e[5]=r[7],e[6]=r[2],e[7]=r[5],e[8]=r[8];return e},determinantMat4(r){const e=r[0],i=r[1],s=r[2],t=r[3],o=r[4],n=r[5],a=r[6],A=r[7],l=r[8],h=r[9],d=r[10],f=r[11],m=r[12],_=r[13],u=r[14],P=r[15];return m*h*a*t-l*_*a*t-m*n*d*t+o*_*d*t+l*n*u*t-o*h*u*t-m*h*s*A+l*_*s*A+m*i*d*A-e*_*d*A-l*i*u*A+e*h*u*A+m*n*s*f-o*_*s*f-m*i*a*f+e*_*a*f+o*i*u*f-e*n*u*f-l*n*s*P+o*h*s*P+l*i*a*P-e*h*a*P-o*i*d*P+e*n*d*P},inverseMat4(r,e){e||(e=r);const i=r[0],s=r[1],t=r[2],o=r[3],n=r[4],a=r[5],A=r[6],l=r[7],h=r[8],d=r[9],f=r[10],m=r[11],_=r[12],u=r[13],P=r[14],y=r[15],x=i*a-s*n,B=i*A-t*n,v=i*l-o*n,w=s*A-t*a,C=s*l-o*a,I=t*l-o*A,E=h*u-d*_,S=h*P-f*_,R=h*y-m*_,D=d*P-f*u,K=d*y-m*u,G=f*y-m*P,z=1/(x*G-B*K+v*D+w*R-C*S+I*E);return e[0]=(a*G-A*K+l*D)*z,e[1]=(-s*G+t*K-o*D)*z,e[2]=(u*I-P*C+y*w)*z,e[3]=(-d*I+f*C-m*w)*z,e[4]=(-n*G+A*R-l*S)*z,e[5]=(i*G-t*R+o*S)*z,e[6]=(-_*I+P*v-y*B)*z,e[7]=(h*I-f*v+m*B)*z,e[8]=(n*K-a*R+l*E)*z,e[9]=(-i*K+s*R-o*E)*z,e[10]=(_*C-u*v+y*x)*z,e[11]=(-h*C+d*v-m*x)*z,e[12]=(-n*D+a*S-A*E)*z,e[13]=(i*D-s*S+t*E)*z,e[14]=(-_*w+u*B-P*x)*z,e[15]=(h*w-d*B+f*x)*z,e},traceMat4(r){return r[0]+r[5]+r[10]+r[15]},translationMat4v(r,e){const i=e||c.identityMat4();return i[12]=r[0],i[13]=r[1],i[14]=r[2],i},translationMat3v(r,e){const i=e||c.identityMat3();return i[6]=r[0],i[7]=r[1],i},translationMat4c:(()=>{const r=new ye(3);return(e,i,s,t)=>(r[0]=e,r[1]=i,r[2]=s,c.translationMat4v(r,t))})(),translationMat4s(r,e){return c.translationMat4c(r,r,r,e)},translateMat4v(r,e){return c.translateMat4c(r[0],r[1],r[2],e)},translateMat4c(r,e,i,s){const t=s[3];s[0]+=t*r,s[1]+=t*e,s[2]+=t*i;const o=s[7];s[4]+=o*r,s[5]+=o*e,s[6]+=o*i;const n=s[11];s[8]+=n*r,s[9]+=n*e,s[10]+=n*i;const a=s[15];return s[12]+=a*r,s[13]+=a*e,s[14]+=a*i,s},setMat4Translation(r,e,i){return i[0]=r[0],i[1]=r[1],i[2]=r[2],i[3]=r[3],i[4]=r[4],i[5]=r[5],i[6]=r[6],i[7]=r[7],i[8]=r[8],i[9]=r[9],i[10]=r[10],i[11]=r[11],i[12]=e[0],i[13]=e[1],i[14]=e[2],i[15]=r[15],i},rotationMat4v(r,e,i){const s=c.normalizeVec4([e[0],e[1],e[2],0],[]),t=Math.sin(r),o=Math.cos(r),n=1-o,a=s[0],A=s[1],l=s[2];let h,d,f,m,_,u;return h=a*A,d=A*l,f=l*a,m=a*t,_=A*t,u=l*t,i=i||c.mat4(),i[0]=n*a*a+o,i[1]=n*h+u,i[2]=n*f-_,i[3]=0,i[4]=n*h-u,i[5]=n*A*A+o,i[6]=n*d+m,i[7]=0,i[8]=n*f+_,i[9]=n*d-m,i[10]=n*l*l+o,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i},rotationMat4c(r,e,i,s,t){return c.rotationMat4v(r,[e,i,s],t)},scalingMat4v(r,e=c.identityMat4()){return e[0]=r[0],e[5]=r[1],e[10]=r[2],e},scalingMat3v(r,e=c.identityMat3()){return e[0]=r[0],e[4]=r[1],e},scalingMat4c:(()=>{const r=new ye(3);return(e,i,s,t)=>(r[0]=e,r[1]=i,r[2]=s,c.scalingMat4v(r,t))})(),scaleMat4c(r,e,i,s){return s[0]*=r,s[4]*=e,s[8]*=i,s[1]*=r,s[5]*=e,s[9]*=i,s[2]*=r,s[6]*=e,s[10]*=i,s[3]*=r,s[7]*=e,s[11]*=i,s},scaleMat4v(r,e){const i=r[0],s=r[1],t=r[2];return e[0]*=i,e[4]*=s,e[8]*=t,e[1]*=i,e[5]*=s,e[9]*=t,e[2]*=i,e[6]*=s,e[10]*=t,e[3]*=i,e[7]*=s,e[11]*=t,e},scalingMat4s(r){return c.scalingMat4c(r,r,r)},rotationTranslationMat4(r,e,i=c.mat4()){const s=r[0],t=r[1],o=r[2],n=r[3],a=s+s,A=t+t,l=o+o,h=s*a,d=s*A,f=s*l,m=t*A,_=t*l,u=o*l,P=n*a,y=n*A,x=n*l;return i[0]=1-(m+u),i[1]=d+x,i[2]=f-y,i[3]=0,i[4]=d-x,i[5]=1-(h+u),i[6]=_+P,i[7]=0,i[8]=f+y,i[9]=_-P,i[10]=1-(h+m),i[11]=0,i[12]=e[0],i[13]=e[1],i[14]=e[2],i[15]=1,i},mat4ToEuler(r,e,i=c.vec4()){const s=c.clamp,t=r[0],o=r[4],n=r[8],a=r[1],A=r[5],l=r[9],h=r[2],d=r[6],f=r[10];return e==="XYZ"?(i[1]=Math.asin(s(n,-1,1)),Math.abs(n)<.99999?(i[0]=Math.atan2(-l,f),i[2]=Math.atan2(-o,t)):(i[0]=Math.atan2(d,A),i[2]=0)):e==="YXZ"?(i[0]=Math.asin(-s(l,-1,1)),Math.abs(l)<.99999?(i[1]=Math.atan2(n,f),i[2]=Math.atan2(a,A)):(i[1]=Math.atan2(-h,t),i[2]=0)):e==="ZXY"?(i[0]=Math.asin(s(d,-1,1)),Math.abs(d)<.99999?(i[1]=Math.atan2(-h,f),i[2]=Math.atan2(-o,A)):(i[1]=0,i[2]=Math.atan2(a,t))):e==="ZYX"?(i[1]=Math.asin(-s(h,-1,1)),Math.abs(h)<.99999?(i[0]=Math.atan2(d,f),i[2]=Math.atan2(a,t)):(i[0]=0,i[2]=Math.atan2(-o,A))):e==="YZX"?(i[2]=Math.asin(s(a,-1,1)),Math.abs(a)<.99999?(i[0]=Math.atan2(-l,A),i[1]=Math.atan2(-h,t)):(i[0]=0,i[1]=Math.atan2(n,f))):e==="XZY"&&(i[2]=Math.asin(-s(o,-1,1)),Math.abs(o)<.99999?(i[0]=Math.atan2(d,A),i[1]=Math.atan2(n,t)):(i[0]=Math.atan2(-l,f),i[1]=0)),i},composeMat4(r,e,i,s=c.mat4()){return c.quaternionToRotationMat4(e,s),c.scaleMat4v(i,s),c.translateMat4v(r,s),s},decomposeMat4:(()=>{const r=new ye(3),e=new ye(16);return function(s,t,o,n){r[0]=s[0],r[1]=s[1],r[2]=s[2];let a=c.lenVec3(r);r[0]=s[4],r[1]=s[5],r[2]=s[6];const A=c.lenVec3(r);r[8]=s[8],r[9]=s[9],r[10]=s[10];const l=c.lenVec3(r);c.determinantMat4(s)<0&&(a=-a),t[0]=s[12],t[1]=s[13],t[2]=s[14],e.set(s);const d=1/a,f=1/A,m=1/l;return e[0]*=d,e[1]*=d,e[2]*=d,e[4]*=f,e[5]*=f,e[6]*=f,e[8]*=m,e[9]*=m,e[10]*=m,c.mat4ToQuaternion(e,o),n[0]=a,n[1]=A,n[2]=l,this}})(),getColMat4(r,e){const i=e*4;return[r[i],r[i+1],r[i+2],r[i+3]]},setRowMat4(r,e,i){r[e]=i[0],r[e+4]=i[1],r[e+8]=i[2],r[e+12]=i[3]},lookAtMat4v(r,e,i,s){s||(s=c.mat4());const t=r[0],o=r[1],n=r[2],a=i[0],A=i[1],l=i[2],h=e[0],d=e[1],f=e[2];if(t===h&&o===d&&n===f)return c.identityMat4();let m,_,u,P,y,x,B,v,w,C;return m=t-h,_=o-d,u=n-f,C=1/Math.sqrt(m*m+_*_+u*u),m*=C,_*=C,u*=C,P=A*u-l*_,y=l*m-a*u,x=a*_-A*m,C=Math.sqrt(P*P+y*y+x*x),C?(C=1/C,P*=C,y*=C,x*=C):(P=0,y=0,x=0),B=_*x-u*y,v=u*P-m*x,w=m*y-_*P,C=Math.sqrt(B*B+v*v+w*w),C?(C=1/C,B*=C,v*=C,w*=C):(B=0,v=0,w=0),s[0]=P,s[1]=B,s[2]=m,s[3]=0,s[4]=y,s[5]=v,s[6]=_,s[7]=0,s[8]=x,s[9]=w,s[10]=u,s[11]=0,s[12]=-(P*t+y*o+x*n),s[13]=-(B*t+v*o+w*n),s[14]=-(m*t+_*o+u*n),s[15]=1,s},lookAtMat4c(r,e,i,s,t,o,n,a,A){return c.lookAtMat4v([r,e,i],[s,t,o],[n,a,A],[])},orthoMat4c(r,e,i,s,t,o,n){n||(n=c.mat4());const a=e-r,A=s-i,l=o-t;return n[0]=2/a,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=2/A,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=-2/l,n[11]=0,n[12]=-(r+e)/a,n[13]=-(s+i)/A,n[14]=-(o+t)/l,n[15]=1,n},frustumMat4v(r,e,i){i||(i=c.mat4());const s=[r[0],r[1],r[2],0],t=[e[0],e[1],e[2],0];c.addVec4(t,s,Eo),c.subVec4(t,s,Io);const o=2*s[2],n=Io[0],a=Io[1],A=Io[2];return i[0]=o/n,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=o/a,i[6]=0,i[7]=0,i[8]=Eo[0]/n,i[9]=Eo[1]/a,i[10]=-Eo[2]/A,i[11]=-1,i[12]=0,i[13]=0,i[14]=-o*t[2]/A,i[15]=0,i},frustumMat4(r,e,i,s,t,o,n){n||(n=c.mat4());const a=e-r,A=s-i,l=o-t;return n[0]=t*2/a,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=t*2/A,n[6]=0,n[7]=0,n[8]=(e+r)/a,n[9]=(s+i)/A,n[10]=-(o+t)/l,n[11]=-1,n[12]=0,n[13]=0,n[14]=-(o*t*2)/l,n[15]=0,n},perspectiveMat4(r,e,i,s,t){const o=[],n=[];return o[2]=i,n[2]=s,n[1]=o[2]*Math.tan(r/2),o[1]=-n[1],n[0]=n[1]*e,o[0]=-n[0],c.frustumMat4v(o,n,t)},compareMat4(r,e){return r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2]&&r[3]===e[3]&&r[4]===e[4]&&r[5]===e[5]&&r[6]===e[6]&&r[7]===e[7]&&r[8]===e[8]&&r[9]===e[9]&&r[10]===e[10]&&r[11]===e[11]&&r[12]===e[12]&&r[13]===e[13]&&r[14]===e[14]&&r[15]===e[15]},transformPoint3(r,e,i=c.vec3()){const s=e[0],t=e[1],o=e[2];return i[0]=r[0]*s+r[4]*t+r[8]*o+r[12],i[1]=r[1]*s+r[5]*t+r[9]*o+r[13],i[2]=r[2]*s+r[6]*t+r[10]*o+r[14],i},transformPoint4(r,e,i=c.vec4()){return i[0]=r[0]*e[0]+r[4]*e[1]+r[8]*e[2]+r[12]*e[3],i[1]=r[1]*e[0]+r[5]*e[1]+r[9]*e[2]+r[13]*e[3],i[2]=r[2]*e[0]+r[6]*e[1]+r[10]*e[2]+r[14]*e[3],i[3]=r[3]*e[0]+r[7]*e[1]+r[11]*e[2]+r[15]*e[3],i},transformPoints3(r,e,i){const s=i||[],t=e.length;let o,n,a,A;const l=r[0],h=r[1],d=r[2],f=r[3],m=r[4],_=r[5],u=r[6],P=r[7],y=r[8],x=r[9],B=r[10],v=r[11],w=r[12],C=r[13],I=r[14],E=r[15];let S;for(let R=0;R<t;++R)A=e[R],o=A[0],n=A[1],a=A[2],S=s[R]||(s[R]=[0,0,0]),S[0]=l*o+m*n+y*a+w,S[1]=h*o+_*n+x*a+C,S[2]=d*o+u*n+B*a+I,S[3]=f*o+P*n+v*a+E;return s.length=t,s},transformPositions3(r,e,i=e){let s;const t=e.length;let o,n,a;const A=r[0],l=r[1],h=r[2];r[3];const d=r[4],f=r[5],m=r[6];r[7];const _=r[8],u=r[9],P=r[10];r[11];const y=r[12],x=r[13],B=r[14];for(r[15],s=0;s<t;s+=3)o=e[s+0],n=e[s+1],a=e[s+2],i[s+0]=A*o+d*n+_*a+y,i[s+1]=l*o+f*n+u*a+x,i[s+2]=h*o+m*n+P*a+B;return i},transformPositions4(r,e,i=e){let s;const t=e.length;let o,n,a;const A=r[0],l=r[1],h=r[2],d=r[3],f=r[4],m=r[5],_=r[6],u=r[7],P=r[8],y=r[9],x=r[10],B=r[11],v=r[12],w=r[13],C=r[14],I=r[15];for(s=0;s<t;s+=4)o=e[s+0],n=e[s+1],a=e[s+2],i[s+0]=A*o+f*n+P*a+v,i[s+1]=l*o+m*n+y*a+w,i[s+2]=h*o+_*n+x*a+C,i[s+3]=d*o+u*n+B*a+I;return i},transformVec3(r,e,i){const s=e[0],t=e[1],o=e[2];return i=i||this.vec3(),i[0]=r[0]*s+r[4]*t+r[8]*o,i[1]=r[1]*s+r[5]*t+r[9]*o,i[2]=r[2]*s+r[6]*t+r[10]*o,i},transformVec4(r,e,i){const s=e[0],t=e[1],o=e[2],n=e[3];return i=i||c.vec4(),i[0]=r[0]*s+r[4]*t+r[8]*o+r[12]*n,i[1]=r[1]*s+r[5]*t+r[9]*o+r[13]*n,i[2]=r[2]*s+r[6]*t+r[10]*o+r[14]*n,i[3]=r[3]*s+r[7]*t+r[11]*o+r[15]*n,i},rotateVec2(r,e,i,s=r){const t=Math.cos(i),o=Math.sin(i),n=r[0]-e[0],a=r[1]-e[1];return s[0]=n*t-a*o+e[0],s[1]=n*o+a*t+e[1],r},rotateVec3X(r,e,i,s){const t=[],o=[];return t[0]=r[0]-e[0],t[1]=r[1]-e[1],t[2]=r[2]-e[2],o[0]=t[0],o[1]=t[1]*Math.cos(i)-t[2]*Math.sin(i),o[2]=t[1]*Math.sin(i)+t[2]*Math.cos(i),s[0]=o[0]+e[0],s[1]=o[1]+e[1],s[2]=o[2]+e[2],s},rotateVec3Y(r,e,i,s){const t=[],o=[];return t[0]=r[0]-e[0],t[1]=r[1]-e[1],t[2]=r[2]-e[2],o[0]=t[2]*Math.sin(i)+t[0]*Math.cos(i),o[1]=t[1],o[2]=t[2]*Math.cos(i)-t[0]*Math.sin(i),s[0]=o[0]+e[0],s[1]=o[1]+e[1],s[2]=o[2]+e[2],s},rotateVec3Z(r,e,i,s){const t=[],o=[];return t[0]=r[0]-e[0],t[1]=r[1]-e[1],t[2]=r[2]-e[2],o[0]=t[0]*Math.cos(i)-t[1]*Math.sin(i),o[1]=t[0]*Math.sin(i)+t[1]*Math.cos(i),o[2]=t[2],s[0]=o[0]+e[0],s[1]=o[1]+e[1],s[2]=o[2]+e[2],s},projectVec4(r,e){const i=1/r[3];return e=e||c.vec2(),e[0]=r[0]*i,e[1]=r[1]*i,e},unprojectVec3:(()=>{const r=new ye(16),e=new ye(16),i=new ye(16);return function(s,t,o,n){return this.transformVec3(this.mulMat4(this.inverseMat4(t,r),this.inverseMat4(o,e),i),s,n)}})(),lerpVec3(r,e,i,s,t,o){const n=o||c.vec3(),a=(r-e)/(i-e);return n[0]=s[0]+a*(t[0]-s[0]),n[1]=s[1]+a*(t[1]-s[1]),n[2]=s[2]+a*(t[2]-s[2]),n},lerpMat4(r,e,i,s,t,o){const n=o||c.mat4(),a=(r-e)/(i-e);return n[0]=s[0]+a*(t[0]-s[0]),n[1]=s[1]+a*(t[1]-s[1]),n[2]=s[2]+a*(t[2]-s[2]),n[3]=s[3]+a*(t[3]-s[3]),n[4]=s[4]+a*(t[4]-s[4]),n[5]=s[5]+a*(t[5]-s[5]),n[6]=s[6]+a*(t[6]-s[6]),n[7]=s[7]+a*(t[7]-s[7]),n[8]=s[8]+a*(t[8]-s[8]),n[9]=s[9]+a*(t[9]-s[9]),n[10]=s[10]+a*(t[10]-s[10]),n[11]=s[11]+a*(t[11]-s[11]),n[12]=s[12]+a*(t[12]-s[12]),n[13]=s[13]+a*(t[13]-s[13]),n[14]=s[14]+a*(t[14]-s[14]),n[15]=s[15]+a*(t[15]-s[15]),n},flatten(r){const e=[];let i,s,t,o,n;for(i=0,s=r.length;i<s;i++)for(n=r[i],t=0,o=n.length;t<o;t++)e.push(n[t]);return e},identityQuaternion(r=c.vec4()){return r[0]=0,r[1]=0,r[2]=0,r[3]=1,r},eulerToQuaternion(r,e,i=c.vec4()){const s=r[0]*c.DEGTORAD/2,t=r[1]*c.DEGTORAD/2,o=r[2]*c.DEGTORAD/2,n=Math.cos(s),a=Math.cos(t),A=Math.cos(o),l=Math.sin(s),h=Math.sin(t),d=Math.sin(o);return e==="XYZ"?(i[0]=l*a*A+n*h*d,i[1]=n*h*A-l*a*d,i[2]=n*a*d+l*h*A,i[3]=n*a*A-l*h*d):e==="YXZ"?(i[0]=l*a*A+n*h*d,i[1]=n*h*A-l*a*d,i[2]=n*a*d-l*h*A,i[3]=n*a*A+l*h*d):e==="ZXY"?(i[0]=l*a*A-n*h*d,i[1]=n*h*A+l*a*d,i[2]=n*a*d+l*h*A,i[3]=n*a*A-l*h*d):e==="ZYX"?(i[0]=l*a*A-n*h*d,i[1]=n*h*A+l*a*d,i[2]=n*a*d-l*h*A,i[3]=n*a*A+l*h*d):e==="YZX"?(i[0]=l*a*A+n*h*d,i[1]=n*h*A+l*a*d,i[2]=n*a*d-l*h*A,i[3]=n*a*A-l*h*d):e==="XZY"&&(i[0]=l*a*A-n*h*d,i[1]=n*h*A-l*a*d,i[2]=n*a*d+l*h*A,i[3]=n*a*A+l*h*d),i},mat4ToQuaternion(r,e=c.vec4()){const i=r[0],s=r[4],t=r[8],o=r[1],n=r[5],a=r[9],A=r[2],l=r[6],h=r[10];let d;const f=i+n+h;return f>0?(d=.5/Math.sqrt(f+1),e[3]=.25/d,e[0]=(l-a)*d,e[1]=(t-A)*d,e[2]=(o-s)*d):i>n&&i>h?(d=2*Math.sqrt(1+i-n-h),e[3]=(l-a)/d,e[0]=.25*d,e[1]=(s+o)/d,e[2]=(t+A)/d):n>h?(d=2*Math.sqrt(1+n-i-h),e[3]=(t-A)/d,e[0]=(s+o)/d,e[1]=.25*d,e[2]=(a+l)/d):(d=2*Math.sqrt(1+h-i-n),e[3]=(o-s)/d,e[0]=(t+A)/d,e[1]=(a+l)/d,e[2]=.25*d),e},vec3PairToQuaternion(r,e,i=c.vec4()){const s=Math.sqrt(c.dotVec3(r,r)*c.dotVec3(e,e));let t=s+c.dotVec3(r,e);return t<1e-8*s?(t=0,Math.abs(r[0])>Math.abs(r[2])?(i[0]=-r[1],i[1]=r[0],i[2]=0):(i[0]=0,i[1]=-r[2],i[2]=r[1])):c.cross3Vec3(r,e,i),i[3]=t,c.normalizeQuaternion(i)},angleAxisToQuaternion(r,e=c.vec4()){const i=r[3]/2,s=Math.sin(i);return e[0]=s*r[0],e[1]=s*r[1],e[2]=s*r[2],e[3]=Math.cos(i),e},quaternionToEuler:(()=>{const r=new ye(16);return(e,i,s)=>(s=s||c.vec3(),c.quaternionToRotationMat4(e,r),c.mat4ToEuler(r,i,s),s)})(),mulQuaternions(r,e,i=c.vec4()){const s=r[0],t=r[1],o=r[2],n=r[3],a=e[0],A=e[1],l=e[2],h=e[3];return i[0]=n*a+s*h+t*l-o*A,i[1]=n*A+t*h+o*a-s*l,i[2]=n*l+o*h+s*A-t*a,i[3]=n*h-s*a-t*A-o*l,i},vec3ApplyQuaternion(r,e,i=c.vec3()){const s=e[0],t=e[1],o=e[2],n=r[0],a=r[1],A=r[2],l=r[3],h=l*s+a*o-A*t,d=l*t+A*s-n*o,f=l*o+n*t-a*s,m=-n*s-a*t-A*o;return i[0]=h*l+m*-n+d*-A-f*-a,i[1]=d*l+m*-a+f*-n-h*-A,i[2]=f*l+m*-A+h*-a-d*-n,i},quaternionToMat4(r,e){e=c.identityMat4(e);const i=r[0],s=r[1],t=r[2],o=r[3],n=2*i,a=2*s,A=2*t,l=n*o,h=a*o,d=A*o,f=n*i,m=a*i,_=A*i,u=a*s,P=A*s,y=A*t;return e[0]=1-(u+y),e[1]=m+d,e[2]=_-h,e[4]=m-d,e[5]=1-(f+y),e[6]=P+l,e[8]=_+h,e[9]=P-l,e[10]=1-(f+u),e},quaternionToRotationMat4(r,e){const i=r[0],s=r[1],t=r[2],o=r[3],n=i+i,a=s+s,A=t+t,l=i*n,h=i*a,d=i*A,f=s*a,m=s*A,_=t*A,u=o*n,P=o*a,y=o*A;return e[0]=1-(f+_),e[4]=h-y,e[8]=d+P,e[1]=h+y,e[5]=1-(l+_),e[9]=m-u,e[2]=d-P,e[6]=m+u,e[10]=1-(l+f),e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},normalizeQuaternion(r,e=r){const i=c.lenVec4([r[0],r[1],r[2],r[3]]);return e[0]=r[0]/i,e[1]=r[1]/i,e[2]=r[2]/i,e[3]=r[3]/i,e},conjugateQuaternion(r,e=r){return e[0]=-r[0],e[1]=-r[1],e[2]=-r[2],e[3]=r[3],e},inverseQuaternion(r,e){return c.normalizeQuaternion(c.conjugateQuaternion(r,e))},quaternionToAngleAxis(r,e=c.vec4()){r=c.normalizeQuaternion(r,Rg);const i=r[3],s=2*Math.acos(i),t=Math.sqrt(1-i*i);return t<.001?(e[0]=r[0],e[1]=r[1],e[2]=r[2]):(e[0]=r[0]/t,e[1]=r[1]/t,e[2]=r[2]/t),e[3]=s,e},AABB3(r){return new ye(r||6)},AABB2(r){return new ye(r||4)},OBB3(r){return new ye(r||32)},OBB2(r){return new ye(r||16)},Sphere3(r,e,i,s){return new ye([r,e,i,s])},transformOBB3(r,e,i=e){let s;const t=e.length;let o,n,a;const A=r[0],l=r[1],h=r[2],d=r[3],f=r[4],m=r[5],_=r[6],u=r[7],P=r[8],y=r[9],x=r[10],B=r[11],v=r[12],w=r[13],C=r[14],I=r[15];for(s=0;s<t;s+=4)o=e[s+0],n=e[s+1],a=e[s+2],i[s+0]=A*o+f*n+P*a+v,i[s+1]=l*o+m*n+y*a+w,i[s+2]=h*o+_*n+x*a+C,i[s+3]=d*o+u*n+B*a+I;return i},containsAABB3:function(r,e){return r[0]<=e[0]&&e[3]<=r[3]&&r[1]<=e[1]&&e[4]<=r[4]&&r[2]<=e[2]&&e[5]<=r[5]},getAABB3Diag:(()=>{const r=new ye(3),e=new ye(3),i=new ye(3);return s=>(r[0]=s[0],r[1]=s[1],r[2]=s[2],e[0]=s[3],e[1]=s[4],e[2]=s[5],c.subVec3(e,r,i),Math.abs(c.lenVec3(i)))})(),getAABB3DiagPoint:(()=>{const r=new ye(3),e=new ye(3),i=new ye(3);return(s,t)=>{r[0]=s[0],r[1]=s[1],r[2]=s[2],e[0]=s[3],e[1]=s[4],e[2]=s[5];const o=c.subVec3(e,r,i),n=t[0]-s[0],a=s[3]-t[0],A=t[1]-s[1],l=s[4]-t[1],h=t[2]-s[2],d=s[5]-t[2];return o[0]+=n>a?n:a,o[1]+=A>l?A:l,o[2]+=h>d?h:d,Math.abs(c.lenVec3(o))}})(),getAABB3Area(r){const e=r[3]-r[0],i=r[4]-r[1],s=r[5]-r[2];return e*i*s},getAABB3Center(r,e){const i=e||c.vec3();return i[0]=(r[0]+r[3])/2,i[1]=(r[1]+r[4])/2,i[2]=(r[2]+r[5])/2,i},getAABB2Center(r,e){const i=e||c.vec2();return i[0]=(r[2]+r[0])/2,i[1]=(r[3]+r[1])/2,i},collapseAABB3(r=c.AABB3()){return r[0]=c.MAX_DOUBLE,r[1]=c.MAX_DOUBLE,r[2]=c.MAX_DOUBLE,r[3]=c.MIN_DOUBLE,r[4]=c.MIN_DOUBLE,r[5]=c.MIN_DOUBLE,r},AABB3ToOBB3(r,e=c.OBB3()){return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=1,e[4]=r[3],e[5]=r[1],e[6]=r[2],e[7]=1,e[8]=r[3],e[9]=r[4],e[10]=r[2],e[11]=1,e[12]=r[0],e[13]=r[4],e[14]=r[2],e[15]=1,e[16]=r[0],e[17]=r[1],e[18]=r[5],e[19]=1,e[20]=r[3],e[21]=r[1],e[22]=r[5],e[23]=1,e[24]=r[3],e[25]=r[4],e[26]=r[5],e[27]=1,e[28]=r[0],e[29]=r[4],e[30]=r[5],e[31]=1,e},positions3ToAABB3:(()=>{const r=new ye(3);return(e,i,s)=>{i=i||c.AABB3();let t=c.MAX_DOUBLE,o=c.MAX_DOUBLE,n=c.MAX_DOUBLE,a=c.MIN_DOUBLE,A=c.MIN_DOUBLE,l=c.MIN_DOUBLE,h,d,f;for(let m=0,_=e.length;m<_;m+=3)s?(r[0]=e[m+0],r[1]=e[m+1],r[2]=e[m+2],c.decompressPosition(r,s,r),h=r[0],d=r[1],f=r[2]):(h=e[m+0],d=e[m+1],f=e[m+2]),h<t&&(t=h),d<o&&(o=d),f<n&&(n=f),h>a&&(a=h),d>A&&(A=d),f>l&&(l=f);return i[0]=t,i[1]=o,i[2]=n,i[3]=a,i[4]=A,i[5]=l,i}})(),OBB3ToAABB3(r,e=c.AABB3()){let i=c.MAX_DOUBLE,s=c.MAX_DOUBLE,t=c.MAX_DOUBLE,o=c.MIN_DOUBLE,n=c.MIN_DOUBLE,a=c.MIN_DOUBLE,A,l,h;for(let d=0,f=r.length;d<f;d+=4)A=r[d+0],l=r[d+1],h=r[d+2],A<i&&(i=A),l<s&&(s=l),h<t&&(t=h),A>o&&(o=A),l>n&&(n=l),h>a&&(a=h);return e[0]=i,e[1]=s,e[2]=t,e[3]=o,e[4]=n,e[5]=a,e},points3ToAABB3(r,e=c.AABB3()){let i=c.MAX_DOUBLE,s=c.MAX_DOUBLE,t=c.MAX_DOUBLE,o=c.MIN_DOUBLE,n=c.MIN_DOUBLE,a=c.MIN_DOUBLE,A,l,h;for(let d=0,f=r.length;d<f;d++)A=r[d][0],l=r[d][1],h=r[d][2],A<i&&(i=A),l<s&&(s=l),h<t&&(t=h),A>o&&(o=A),l>n&&(n=l),h>a&&(a=h);return e[0]=i,e[1]=s,e[2]=t,e[3]=o,e[4]=n,e[5]=a,e},points3ToSphere3:(()=>{const r=new ye(3);return(e,i)=>{i=i||c.vec4();let s=0,t=0,o=0,n;const a=e.length;for(n=0;n<a;n++)s+=e[n][0],t+=e[n][1],o+=e[n][2];i[0]=s/a,i[1]=t/a,i[2]=o/a;let A=0,l;for(n=0;n<a;n++)l=Math.abs(c.lenVec3(c.subVec3(e[n],i,r))),l>A&&(A=l);return i[3]=A,i}})(),positions3ToSphere3:(()=>{const r=new ye(3),e=new ye(3);return(i,s)=>{s=s||c.vec4();let t=0,o=0,n=0,a;const A=i.length;let l=0;for(a=0;a<A;a+=3)t+=i[a],o+=i[a+1],n+=i[a+2];const h=A/3;s[0]=t/h,s[1]=o/h,s[2]=n/h;let d;for(a=0;a<A;a+=3)r[0]=i[a],r[1]=i[a+1],r[2]=i[a+2],d=Math.abs(c.lenVec3(c.subVec3(r,s,e))),d>l&&(l=d);return s[3]=l,s}})(),OBB3ToSphere3:(()=>{const r=new ye(3),e=new ye(3);return(i,s)=>{s=s||c.vec4();let t=0,o=0,n=0,a;const A=i.length,l=A/4;for(a=0;a<A;a+=4)t+=i[a+0],o+=i[a+1],n+=i[a+2];s[0]=t/l,s[1]=o/l,s[2]=n/l;let h=0,d;for(a=0;a<A;a+=4)r[0]=i[a+0],r[1]=i[a+1],r[2]=i[a+2],d=Math.abs(c.lenVec3(c.subVec3(r,s,e))),d>h&&(h=d);return s[3]=h,s}})(),getSphere3Center(r,e=c.vec3()){return e[0]=r[0],e[1]=r[1],e[2]=r[2],e},getPositionsCenter(r,e=c.vec3()){let i=0,s=0,t=0;for(var o=0,n=r.length;o<n;o+=3)i+=r[o+0],s+=r[o+1],t+=r[o+2];const a=r.length/3;return e[0]=i/a,e[1]=s/a,e[2]=t/a,e},expandAABB3(r,e){return r[0]>e[0]&&(r[0]=e[0]),r[1]>e[1]&&(r[1]=e[1]),r[2]>e[2]&&(r[2]=e[2]),r[3]<e[3]&&(r[3]=e[3]),r[4]<e[4]&&(r[4]=e[4]),r[5]<e[5]&&(r[5]=e[5]),r},expandAABB3Point3(r,e){return r[0]>e[0]&&(r[0]=e[0]),r[1]>e[1]&&(r[1]=e[1]),r[2]>e[2]&&(r[2]=e[2]),r[3]<e[0]&&(r[3]=e[0]),r[4]<e[1]&&(r[4]=e[1]),r[5]<e[2]&&(r[5]=e[2]),r},expandAABB3Points3(r,e){for(var i,s,t,o=0,n=e.length;o<n;o+=3)i=e[o],s=e[o+1],t=e[o+2],r[0]>i&&(r[0]=i),r[1]>s&&(r[1]=s),r[2]>t&&(r[2]=t),r[3]<i&&(r[3]=i),r[4]<s&&(r[4]=s),r[5]<t&&(r[5]=t);return r},collapseAABB2(r=c.AABB2()){return r[0]=c.MAX_DOUBLE,r[1]=c.MAX_DOUBLE,r[2]=c.MIN_DOUBLE,r[3]=c.MIN_DOUBLE,r},point3AABB3Intersect(r,e){return r[0]>e[0]||r[3]<e[0]||r[1]>e[1]||r[4]<e[1]||r[2]>e[2]||r[5]<e[2]},planeAABB3Intersect(r,e,i){let s,t;return r[0]>0?(s=r[0]*i[0],t=r[0]*i[3]):(s=r[0]*i[3],t=r[0]*i[0]),r[1]>0?(s+=r[1]*i[1],t+=r[1]*i[4]):(s+=r[1]*i[4],t+=r[1]*i[1]),r[2]>0?(s+=r[2]*i[2],t+=r[2]*i[5]):(s+=r[2]*i[5],t+=r[2]*i[2]),s<=-e&&t<=-e?-1:s>=-e&&t>=-e?1:0},OBB3ToAABB2(r,e=c.AABB2()){let i=c.MAX_DOUBLE,s=c.MAX_DOUBLE,t=c.MIN_DOUBLE,o=c.MIN_DOUBLE,n,a,A,l;for(let h=0,d=r.length;h<d;h+=4)n=r[h+0],a=r[h+1],A=r[h+3]||1,l=1/A,n*=l,a*=l,n<i&&(i=n),a<s&&(s=a),n>t&&(t=n),a>o&&(o=a);return e[0]=i,e[1]=s,e[2]=t,e[3]=o,e},expandAABB2(r,e){return r[0]>e[0]&&(r[0]=e[0]),r[1]>e[1]&&(r[1]=e[1]),r[2]<e[2]&&(r[2]=e[2]),r[3]<e[3]&&(r[3]=e[3]),r},expandAABB2Point2(r,e){return r[0]>e[0]&&(r[0]=e[0]),r[1]>e[1]&&(r[1]=e[1]),r[2]<e[0]&&(r[2]=e[0]),r[3]<e[1]&&(r[3]=e[1]),r},AABB2ToCanvas(r,e,i,s=r){const t=(r[0]+1)*.5,o=(r[1]+1)*.5,n=(r[2]+1)*.5,a=(r[3]+1)*.5;return s[0]=Math.floor(t*e),s[1]=i-Math.floor(a*i),s[2]=Math.floor(n*e),s[3]=i-Math.floor(o*i),s},tangentQuadraticBezier(r,e,i,s){return 2*(1-r)*(i-e)+2*r*(s-i)},tangentQuadraticBezier3(r,e,i,s,t){return-3*e*(1-r)*(1-r)+3*i*(1-r)*(1-r)-6*r*i*(1-r)+6*r*s*(1-r)-3*r*r*s+3*r*r*t},tangentSpline(r){const e=6*r*r-6*r,i=3*r*r-4*r+1,s=-6*r*r+6*r,t=3*r*r-2*r;return e+i+s+t},catmullRomInterpolate(r,e,i,s,t){const o=(i-r)*.5,n=(s-e)*.5,a=t*t,A=t*a;return(2*e-2*i+o+n)*A+(-3*e+3*i-2*o-n)*a+o*t+e},b2p0(r,e){const i=1-r;return i*i*e},b2p1(r,e){return 2*(1-r)*r*e},b2p2(r,e){return r*r*e},b2(r,e,i,s){return this.b2p0(r,e)+this.b2p1(r,i)+this.b2p2(r,s)},b3p0(r,e){const i=1-r;return i*i*i*e},b3p1(r,e){const i=1-r;return 3*i*i*r*e},b3p2(r,e){return 3*(1-r)*r*r*e},b3p3(r,e){return r*r*r*e},b3(r,e,i,s,t){return this.b3p0(r,e)+this.b3p1(r,i)+this.b3p2(r,s)+this.b3p3(r,t)},triangleNormal(r,e,i,s=c.vec3()){const t=e[0]-r[0],o=e[1]-r[1],n=e[2]-r[2],a=i[0]-r[0],A=i[1]-r[1],l=i[2]-r[2],h=o*l-n*A,d=n*a-t*l,f=t*A-o*a,m=Math.sqrt(h*h+d*d+f*f);return m===0?(s[0]=0,s[1]=0,s[2]=0):(s[0]=h/m,s[1]=d/m,s[2]=f/m),s},rayTriangleIntersect:(()=>{const r=new ye(3),e=new ye(3),i=new ye(3),s=new ye(3),t=new ye(3);return(o,n,a,A,l,h)=>{h=h||c.vec3();const d=1e-6,f=c.subVec3(A,a,r),m=c.subVec3(l,a,e),_=c.cross3Vec3(n,m,i),u=c.dotVec3(f,_);if(u<d)return null;const P=c.subVec3(o,a,s),y=c.dotVec3(P,_);if(y<0||y>u)return null;const x=c.cross3Vec3(P,f,t),B=c.dotVec3(n,x);if(B<0||y+B>u)return null;const v=c.dotVec3(m,x)/u;return h[0]=o[0]+v*n[0],h[1]=o[1]+v*n[1],h[2]=o[2]+v*n[2],h}})(),rayPlaneIntersect:(()=>{const r=new ye(3),e=new ye(3),i=new ye(3),s=new ye(3);return(t,o,n,a,A,l)=>{l=l||c.vec3(),o=c.normalizeVec3(o,r);const h=c.subVec3(a,n,e),d=c.subVec3(A,n,i),f=c.cross3Vec3(h,d,s);c.normalizeVec3(f,f);const m=-c.dotVec3(n,f),_=-(c.dotVec3(t,f)+m)/c.dotVec3(o,f);return l[0]=t[0]+_*o[0],l[1]=t[1]+_*o[1],l[2]=t[2]+_*o[2],l}})(),cartesianToBarycentric:(()=>{const r=new ye(3),e=new ye(3),i=new ye(3);return(s,t,o,n,a)=>{const A=c.subVec3(n,t,r),l=c.subVec3(o,t,e),h=c.subVec3(s,t,i),d=c.dotVec3(A,A),f=c.dotVec3(A,l),m=c.dotVec3(A,h),_=c.dotVec3(l,l),u=c.dotVec3(l,h),P=d*_-f*f;if(P===0)return null;const y=1/P,x=(_*m-f*u)*y,B=(d*u-f*m)*y;return a[0]=1-x-B,a[1]=B,a[2]=x,a}})(),barycentricInsideTriangle(r){const e=r[1],i=r[2];return i>=0&&e>=0&&i+e<1},barycentricToCartesian(r,e,i,s,t=c.vec3()){const o=r[0],n=r[1],a=r[2];return t[0]=e[0]*o+i[0]*n+s[0]*a,t[1]=e[1]*o+i[1]*n+s[1]*a,t[2]=e[2]*o+i[2]*n+s[2]*a,t},mergeVertices(r,e,i,s){const t={},o=[],n=[],a=e?[]:null,A=i?[]:null,l=[];let h,d,f,m;const u=10**4;let P,y,x=0;for(P=0,y=r.length;P<y;P+=3)h=r[P],d=r[P+1],f=r[P+2],m=`${Math.round(h*u)}_${Math.round(d*u)}_${Math.round(f*u)}`,t[m]===void 0&&(t[m]=n.length/3,n.push(h),n.push(d),n.push(f),e&&(a.push(e[P]),a.push(e[P+1]),a.push(e[P+2])),i&&(A.push(i[x]),A.push(i[x+1]))),o[P/3]=t[m],x+=2;for(P=0,y=s.length;P<y;P++)l[P]=o[s[P]];const B={positions:n,indices:l};return a&&(B.normals=a),A&&(B.uv=A),B},buildNormals:(()=>{const r=new ye(3),e=new ye(3),i=new ye(3),s=new ye(3),t=new ye(3),o=new ye(3);return(n,a,A)=>{let l,h;const d=new Array(n.length/3);let f,m,_;for(l=0,h=a.length;l<h;l+=3){f=a[l],m=a[l+1],_=a[l+2],r[0]=n[f*3],r[1]=n[f*3+1],r[2]=n[f*3+2],e[0]=n[m*3],e[1]=n[m*3+1],e[2]=n[m*3+2],i[0]=n[_*3],i[1]=n[_*3+1],i[2]=n[_*3+2],c.subVec3(e,r,s),c.subVec3(i,r,t);const B=c.vec3();c.normalizeVec3(c.cross3Vec3(s,t,o),B),d[f]||(d[f]=[]),d[m]||(d[m]=[]),d[_]||(d[_]=[]),d[f].push(B),d[m].push(B),d[_].push(B)}A=A&&A.length===n.length?A:new Float32Array(n.length);let u,P,y,x;for(l=0,h=d.length;l<h;l++){u=d[l].length,P=0,y=0,x=0;for(let B=0;B<u;B++)P+=d[l][B][0],y+=d[l][B][1],x+=d[l][B][2];A[l*3]=P/u,A[l*3+1]=y/u,A[l*3+2]=x/u}return A}})(),buildTangents:(()=>{const r=new ye(3),e=new ye(3),i=new ye(3),s=new ye(3),t=new ye(3),o=new ye(3),n=new ye(3);return(a,A,l)=>{const h=new Float32Array(a.length);for(let d=0;d<A.length;d+=3){let f=A[d];const m=a.subarray(f*3,f*3+3),_=l.subarray(f*2,f*2+2);f=A[d+1];const u=a.subarray(f*3,f*3+3),P=l.subarray(f*2,f*2+2);f=A[d+2];const y=a.subarray(f*3,f*3+3),x=l.subarray(f*2,f*2+2),B=c.subVec3(u,m,r),v=c.subVec3(y,m,e),w=c.subVec2(P,_,i),C=c.subVec2(x,_,s),I=1/(w[0]*C[1]-w[1]*C[0]),E=c.mulVec3Scalar(c.subVec3(c.mulVec3Scalar(B,C[1],t),c.mulVec3Scalar(v,w[1],o),n),I,o);let S;for(let R=0;R<3;R++)S=A[d+R]*3,h[S]+=E[0],h[S+1]+=E[1],h[S+2]+=E[2]}return h}})(),buildPickTriangles(r,e,i){const s=e.length,t=i?new Uint16Array(s*9):new Float32Array(s*9),o=new Uint8Array(s*12);let n=0,a,A=0,l=0,h,d,f,m,_;for(let u=0;u<s;u+=3)_=n>>24&255,m=n>>16&255,f=n>>8&255,d=n&255,h=e[u],a=h*3,t[A++]=r[a],t[A++]=r[a+1],t[A++]=r[a+2],o[l++]=d,o[l++]=f,o[l++]=m,o[l++]=_,h=e[u+1],a=h*3,t[A++]=r[a],t[A++]=r[a+1],t[A++]=r[a+2],o[l++]=d,o[l++]=f,o[l++]=m,o[l++]=_,h=e[u+2],a=h*3,t[A++]=r[a],t[A++]=r[a+1],t[A++]=r[a+2],o[l++]=d,o[l++]=f,o[l++]=m,o[l++]=_,n++;return{positions:t,colors:o}},faceToVertexNormals(r,e,i={}){const s=i.smoothNormalsAngleThreshold||20,t={},o=[],n={};let a,A,l,h,d;const m=10**4;let _,u,P,y,x,B;for(u=0,y=r.length;u<y;u+=3){_=u/3,A=r[u],l=r[u+1],h=r[u+2],d=`${Math.round(A*m)}_${Math.round(l*m)}_${Math.round(h*m)}`,t[d]===void 0?t[d]=[_]:t[d].push(_);const v=c.normalizeVec3([e[u],e[u+1],e[u+2]]);o[_]=v,a=c.vec4([v[0],v[1],v[2],1]),n[_]=a}for(d in t)if(t.hasOwnProperty(d)){const v=t[d],w=v.length;for(u=0;u<w;u++){const C=v[u];for(a=n[C],P=0;P<w;P++){if(u===P)continue;const I=v[P];x=o[C],B=o[I],Math.abs(c.angleVec3(x,B)/c.DEGTORAD)<s&&(a[0]+=B[0],a[1]+=B[1],a[2]+=B[2],a[3]+=1)}}}for(u=0,y=e.length;u<y;u+=3)a=n[u/3],e[u+0]=a[0]/a[3],e[u+1]=a[1]/a[3],e[u+2]=a[2]/a[3]},transformRay:(()=>{const r=new ye(4),e=new ye(4);return(i,s,t,o,n)=>{r[0]=s[0],r[1]=s[1],r[2]=s[2],r[3]=1,c.transformVec4(i,r,e),o[0]=e[0],o[1]=e[1],o[2]=e[2],r[0]=t[0],r[1]=t[1],r[2]=t[2],c.transformVec3(i,r,e),c.normalizeVec3(e),n[0]=e[0],n[1]=e[1],n[2]=e[2]}})(),canvasPosToWorldRay:(()=>{const r=new ye(16),e=new ye(16),i=new ye(4),s=new ye(4),t=new ye(4),o=new ye(4);return(n,a,A,l,h,d)=>{const f=c.mulMat4(A,a,r),m=c.inverseMat4(f,e),_=n.width,u=n.height,P=(l[0]-_/2)/(_/2),y=-(l[1]-u/2)/(u/2);i[0]=P,i[1]=y,i[2]=-1,i[3]=1,c.transformVec4(m,i,s),c.mulVec4Scalar(s,1/s[3]),t[0]=P,t[1]=y,t[2]=1,t[3]=1,c.transformVec4(m,t,o),c.mulVec4Scalar(o,1/o[3]),h[0]=o[0],h[1]=o[1],h[2]=o[2],c.subVec3(o,s,d),c.normalizeVec3(d)}})(),canvasPosToLocalRay:(()=>{const r=new ye(3),e=new ye(3);return(i,s,t,o,n,a,A)=>{c.canvasPosToWorldRay(i,s,t,n,r,e),c.worldRayToLocalRay(o,r,e,a,A)}})(),worldRayToLocalRay:(()=>{const r=new ye(16),e=new ye(4),i=new ye(4);return(s,t,o,n,a)=>{const A=c.inverseMat4(s,r);e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=1,c.transformVec4(A,e,i),n[0]=i[0],n[1]=i[1],n[2]=i[2],c.transformVec3(A,o,a)}})(),buildKDTree:(()=>{const i=new Float32Array;function s(t,o,n,a){const A=new ye(6),l={triangles:null,left:null,right:null,leaf:!1,splitDim:0,aabb:A};A[0]=A[1]=A[2]=Number.POSITIVE_INFINITY,A[3]=A[4]=A[5]=Number.NEGATIVE_INFINITY;let h,d;for(h=0,d=t.length;h<d;++h){var f=t[h]*3;for(let B=0;B<3;++B){const v=o[f+B]*3;n[v]<A[0]&&(A[0]=n[v]),n[v]>A[3]&&(A[3]=n[v]),n[v+1]<A[1]&&(A[1]=n[v+1]),n[v+1]>A[4]&&(A[4]=n[v+1]),n[v+2]<A[2]&&(A[2]=n[v+2]),n[v+2]>A[5]&&(A[5]=n[v+2])}}if(t.length<20||a>10)return l.triangles=t,l.leaf=!0,l;i[0]=A[3]-A[0],i[1]=A[4]-A[1],i[2]=A[5]-A[2];let m=0;i[1]>i[m]&&(m=1),i[2]>i[m]&&(m=2),l.splitDim=m;const _=(A[m]+A[m+3])/2,u=new Array(t.length);let P=0;const y=new Array(t.length);let x=0;for(h=0,d=t.length;h<d;++h){var f=t[h]*3;const v=o[f],w=o[f+1],C=o[f+2],I=v*3,E=w*3,S=C*3;n[I+m]<=_||n[E+m]<=_||n[S+m]<=_?u[P++]=t[h]:y[x++]=t[h]}return u.length=P,y.length=x,l.left=s(u,o,n,a+1),l.right=s(y,o,n,a+1),l}return(t,o)=>{const n=t.length/3,a=new Array(n);for(let A=0;A<n;++A)a[A]=A;return s(a,t,o,0)}})(),decompressPosition(r,e,i){i=i||r,i[0]=r[0]*e[0]+e[12],i[1]=r[1]*e[5]+e[13],i[2]=r[2]*e[10]+e[14]},decompressPositions(r,e,i=new Float32Array(r.length)){for(let s=0,t=r.length;s<t;s+=3)i[s+0]=r[s+0]*e[0]+e[12],i[s+1]=r[s+1]*e[5]+e[13],i[s+2]=r[s+2]*e[10]+e[14];return i},decompressUV(r,e,i){i[0]=r[0]*e[0]+e[6],i[1]=r[1]*e[4]+e[7]},decompressUVs(r,e,i=new Float32Array(r.length)){for(let s=0,t=r.length;s<t;s+=3)i[s+0]=r[s+0]*e[0]+e[6],i[s+1]=r[s+1]*e[4]+e[7];return i},octDecodeVec2(r,e){let i=r[0],s=r[1];i=(2*i+1)/255,s=(2*s+1)/255;const t=1-Math.abs(i)-Math.abs(s);t<0&&(i=(1-Math.abs(s))*(i>=0?1:-1),s=(1-Math.abs(i))*(s>=0?1:-1));const o=Math.sqrt(i*i+s*s+t*t);return e[0]=i/o,e[1]=s/o,e[2]=t/o,e},octDecodeVec2s(r,e){for(let i=0,s=0,t=r.length;i<t;i+=2){let o=r[i+0],n=r[i+1];o=(2*o+1)/255,n=(2*n+1)/255;const a=1-Math.abs(o)-Math.abs(n);a<0&&(o=(1-Math.abs(n))*(o>=0?1:-1),n=(1-Math.abs(o))*(n>=0?1:-1));const A=Math.sqrt(o*o+n*n+a*a);e[s+0]=o/A,e[s+1]=n/A,e[s+2]=a/A,s+=3}return e}};c.buildEdgeIndices=function(){const r=[],e=[],i=[],s=[],t=[];let o=0;const n=new Uint16Array(3),a=new Uint16Array(3),A=new Uint16Array(3),l=c.vec3(),h=c.vec3(),d=c.vec3(),f=c.vec3(),m=c.vec3(),_=c.vec3(),u=c.vec3();function P(x,B){const v={};let w,C,I,E;const R=Math.pow(10,4);let D,K,G=0;for(D=0,K=x.length;D<K;D+=3)w=x[D],C=x[D+1],I=x[D+2],E=Math.round(w*R)+"_"+Math.round(C*R)+"_"+Math.round(I*R),v[E]===void 0&&(v[E]=G/3,r[G++]=w,r[G++]=C,r[G++]=I),e[D/3]=v[E];for(D=0,K=B.length;D<K;D++)s[D]=e[B[D]],i[s[D]]=B[D]}function y(x,B){o=0;for(let v=0,w=x;v<w;v+=3){const C=s[v]*3,I=s[v+1]*3,E=s[v+2]*3;B?(n[0]=r[C],n[1]=r[C+1],n[2]=r[C+2],a[0]=r[I],a[1]=r[I+1],a[2]=r[I+2],A[0]=r[E],A[1]=r[E+1],A[2]=r[E+2],c.decompressPosition(n,B,l),c.decompressPosition(a,B,h),c.decompressPosition(A,B,d)):(l[0]=r[C],l[1]=r[C+1],l[2]=r[C+2],h[0]=r[I],h[1]=r[I+1],h[2]=r[I+2],d[0]=r[E],d[1]=r[E+1],d[2]=r[E+2]),c.subVec3(d,h,f),c.subVec3(l,h,m),c.cross3Vec3(f,m,_),c.normalizeVec3(_,u);const S=t[o]||(t[o]={normal:c.vec3()});S.normal[0]=u[0],S.normal[1]=u[1],S.normal[2]=u[2],o++}}return function(x,B,v,w){P(x,B),y(B.length,v);const C=[],I=Math.cos(c.DEGTORAD*w),E={};let S,R,D,K,G,z=!1,le,ue,ae,Pe,be,xe;for(let Ie=0,Fe=B.length;Ie<Fe;Ie+=3){const Qe=Ie/3;for(let Ve=0;Ve<3;Ve++)S=s[Ie+Ve],R=s[Ie+(Ve+1)%3],D=Math.min(S,R),K=Math.max(S,R),G=D+","+K,E[G]===void 0?E[G]={index1:D,index2:K,face1:Qe,face2:void 0}:E[G].face2=Qe}for(G in E)le=E[G],!(le.face2!==void 0&&(ue=t[le.face1].normal,ae=t[le.face2].normal,Pe=c.dotVec3(ue,ae),Pe>I))&&(be=i[le.index1],xe=i[le.index2],(!z&&be>65535||xe>65535)&&(z=!0),C.push(be),C.push(xe));return z?new Uint32Array(C):new Uint16Array(C)}}();c.planeClipsPositions3=function(r,e,i,s=3){for(let t=0,o=i.length;t<o;t+=s)if(Ms[0]=i[t+0]-r[0],Ms[1]=i[t+1]-r[1],Ms[2]=i[t+2]-r[2],Ms[0]*e[0]+Ms[1]*e[1]+Ms[2]*e[2]<0)return!0;return!1};class Lg{constructor(){this._head=[],this._headLength=0,this._tail=[],this._index=0,this._length=0}get length(){return this._length}shift(){if(this._index>=this._headLength){const i=this._head;if(i.length=0,this._head=this._tail,this._tail=i,this._index=0,this._headLength=this._head.length,!this._headLength)return}const e=this._head[this._index];return this._index<0?delete this._head[this._index++]:this._head[this._index++]=void 0,this._length--,e}push(e){return this._length++,this._tail.push(e),this}unshift(e){return this._head[--this._index]=e,this._length++,this}}const vt={build:{version:"0.8"},client:{browser:navigator&&navigator.userAgent?navigator.userAgent:"n/a"},components:{scenes:0,models:0,meshes:0,objects:0},memory:{meshes:0,positions:0,colors:0,normals:0,uvs:0,indices:0,textures:0,transforms:0,materials:0,programs:0},frame:{frameCount:0,fps:0,useProgram:0,bindTexture:0,bindArray:0,drawElements:0,drawArrays:0,tasksRun:0,tasksScheduled:0}};function sp(r,e){if(r.nodeType===r.TEXT_NODE){var i=r.nodeValue;if(i.match(/^\s+$/)===null)return i}else if(r.nodeType===r.ELEMENT_NODE||r.nodeType===r.DOCUMENT_NODE){var s={type:r.nodeName,children:[]};if(r.nodeType===r.ELEMENT_NODE)for(var t=0;t<r.attributes.length;t++){var o=r.attributes[t],n=e[o.nodeName]||o.nodeName;s[n]=o.nodeValue}for(var a=0;a<r.childNodes.length;a++){var A=r.childNodes[a],t=sp(A,e);t&&s.children.push(t)}return s}}function Ug(r){return JSON.parse(JSON.stringify(r))}var Og=[["0",10],["A",26],["a",26],["_",1],["$",1]].map(function(r){for(var e=[],i=r[0].charCodeAt(0),s=i+r[1],t=i;t<s;++t)e.push(t);return String.fromCharCode.apply(null,e)}).join("");function Ac(r,e){var i=!e||e===4?[0,6,12,18]:[0,6];return i.map(function(s){return Og.substr(parseInt(r/(1<<s))%64,1)}).reverse().join("")}function kg(r){var e=[0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30].map(function(i){return parseInt(r.substr(i,2),16)});return Ac(e[0],2)+[1,4,7,10,13].map(function(i){return Ac((e[i]<<16)+(e[i+1]<<8)+e[i+2])}).join("")}function Ng(r,e){var i=[],s=function(t){t.type===e&&i.push(t),(t.children||[]).forEach(function(o){s(o)})};return s(r),i}function Qg(r){return new Promise(function(e,i){setTimeout(e,r)})}function Hg(r){return new Promise(function(e,i){var s=new XMLHttpRequest;s.open(r.method||"GET",r.url,!0),s.onload=function(t){s.readyState===4&&(s.status===200?e(s.responseXML):i(s.statusText))},s.send(null)})}const Vg=function(){for(var r={},e=window.location.search.substring(1),i=e.split("&"),s=0;s<i.length;s++){var t=i[s].split("=");if(typeof r[t[0]]>"u")r[t[0]]=decodeURIComponent(t[1]);else if(typeof r[t[0]]=="string"){var o=[r[t[0]],decodeURIComponent(t[1])];r[t[0]]=o}else r[t[0]].push(decodeURIComponent(t[1]))}return r}();function jg(r,e,i){var s=o=>{};e=e||s,i=i||s;var t=new XMLHttpRequest;t.overrideMimeType("application/json"),t.open("GET",r,!0),t.addEventListener("load",function(o){var n=o.target.response;if(this.status===200){var a;try{a=JSON.parse(n)}catch(A){i(`utils.loadJSON(): Failed to parse JSON response - ${A}`)}e(a)}else if(this.status===0){console.warn("loadFile: HTTP Status 0 received.");try{e(JSON.parse(n))}catch(A){i(`utils.loadJSON(): Failed to parse JSON response - ${A}`)}}else i(o)},!1),t.addEventListener("error",function(o){i(o)},!1),t.send(null)}function Gg(r,e,i){var s=A=>{};e=e||s,i=i||s;const t=/^data:(.*?)(;base64)?,(.*)$/,o=r.match(t);if(o){const A=!!o[2];var n=o[3];n=window.decodeURIComponent(n),A&&(n=window.atob(n));try{const l=new ArrayBuffer(n.length),h=new Uint8Array(l);for(var a=0;a<n.length;a++)h[a]=n.charCodeAt(a);xt.scheduleTask(()=>{e(l)})}catch(l){xt.scheduleTask(()=>{i(l)})}}else{const A=new XMLHttpRequest;A.open("GET",r,!0),A.responseType="arraybuffer",A.onreadystatechange=function(){A.readyState===4&&(A.status===200?e(A.response):i("loadArrayBuffer error : "+A.response))},A.send(null)}}function zg(r){return r&&!r.propertyIsEnumerable("length")&&typeof r=="object"&&typeof r.length=="number"}function Kg(r){return typeof r=="string"||r instanceof String}function Wg(r){return!isNaN(parseFloat(r))&&isFinite(r)}function Xg(r){return Le.isString(r)||Le.isNumeric(r)}function Yg(r,e){if(!r||!e)return!1;const i=Le.isNumeric(r)||Le.isString(r)?`${r}`:r.id,s=Le.isNumeric(e)||Le.isString(e)?`${e}`:e.id;return i===s}function $g(r){return typeof r=="function"}function Zg(r){const e={}.constructor;return!!r&&r.constructor===e}function qg(r){return Le.apply(r,{})}function Jg(r,e){for(const i in r)r.hasOwnProperty(i)&&(e[i]=r[i]);return e}function em(r,e){for(const i in r)r.hasOwnProperty(i)&&r[i]!==void 0&&r[i]!==null&&(e[i]=r[i]);return e}function tm(r,e){for(const i in r)r.hasOwnProperty(i)&&(e[i]===void 0||e[i]===null)&&(e[i]=r[i]);return e}function im(r){for(const e in r)if(r.hasOwnProperty(e))return!1;return!0}function sm(r){return Le.isNumeric(r)?`${r}`:`'${r}'`}function rm(r,e){const i=new r.constructor(r.length+e.length);return i.set(r),i.set(e,r.length),i}function om(r){var e=[];function i(s){s.id=s.uuid,delete s.oid,e.push(s);var t=s.children;if(t)for(var o=0,n=t.length;o<n;o++){const a=t[o];a.parent=s.id,i(t[o])}s.children=[]}return i(r),e}const Le={xmlToJson:sp,clone:Ug,compressGuid:kg,findNodeOfType:Ng,timeout:Qg,httpRequest:Hg,loadJSON:jg,loadArraybuffer:Gg,queryString:Vg,isArray:zg,isString:Kg,isNumeric:Wg,isID:Xg,isSameComponent:Yg,isFunction:$g,isObject:Zg,copy:qg,apply:Jg,apply2:em,applyIf:tm,isEmptyObject:im,inQuotes:sm,concat:rm,flattenParentChildHierarchy:om},In={},lc=new Ci,Ss=new Lg,Hi={sceneId:null,time:null,startTime:null,prevTime:null,deltaTime:null},cc=10,os=[],rp=30;let $r=0,rr,or=0;function nm(){this.version="1.0.0",this.scenes={},this._superTypes={},this._addScene=function(r){if(r.id){if(xt.scenes[r.id]){console.error(`[ERROR] Scene ${Le.inQuotes(r.id)} already exists`);return}}else r.id=lc.addItem({});xt.scenes[r.id]=r;const e=r.ticksPerOcclusionTest,i=r.ticksPerRender;In[r.id]={ticksPerOcclusionTest:e,ticksPerRender:i,renderCountdown:i},vt.components.scenes++,r.once("destroyed",()=>{lc.removeItem(r.id),delete xt.scenes[r.id],delete In[r.id],vt.components.scenes--})},this.clear=function(){let r;for(const e in xt.scenes)xt.scenes.hasOwnProperty(e)&&(r=xt.scenes[e],e==="default.scene"?r.clear():(r.destroy(),delete xt.scenes[r.id]))},this.scheduleTask=function(r,e=null){Ss.push(r),Ss.push(e)},this.runTasks=function(r=-1){let e=new Date().getTime(),i,s,t=0;for(;Ss.length>0&&(r<0||e<r);)i=Ss.shift(),s=Ss.shift(),s?i.call(s):i(),e=new Date().getTime(),t++;return t},this.getNumTasks=function(){return Ss.length}}const xt=new nm,op=function(){let r=Date.now();if(rr=r-$r,$r>0&&rr>0){var e=1e3/rr;or+=e,os.push(e),os.length>=rp&&(or-=os.shift()),vt.frame.fps=Math.round(or/os.length)}for(let i in xt.scenes)xt.scenes[i].compile();ap(r),$r=r};function am(r,e){let i=Date.now()+e;function s(){const t=Date.now()-i;r(),i+=e,setTimeout(s,Math.max(0,e-t))}return s(),{cancel:function(){}}}am(()=>{op()},100);const np=function(){let r=Date.now();if(rr=r-$r,$r>0&&rr>0){var e=1e3/rr;or+=e,os.push(e),os.length>=rp&&(or-=os.shift()),vt.frame.fps=Math.round(or/os.length)}ap(r),Am(r),lm(),window.requestPostAnimationFrame!==void 0?window.requestPostAnimationFrame(op):requestAnimationFrame(np)};np();function ap(r){const e=xt.runTasks(r+cc),i=xt.getNumTasks();vt.frame.tasksRun=e,vt.frame.tasksScheduled=i,vt.frame.tasksBudget=cc}function Am(r){Hi.time=r;for(var e in xt.scenes)if(xt.scenes.hasOwnProperty(e)){var i=xt.scenes[e];Hi.sceneId=e,Hi.startTime=i.startTime,Hi.deltaTime=Hi.prevTime!=null?Hi.time-Hi.prevTime:0,i.fire("tick",Hi,!0)}Hi.prevTime=r}function lm(){const r=xt.scenes,e=!1;let i,s,t,o,n;for(n in r)r.hasOwnProperty(n)&&(i=r[n],s=In[n],s||(s=In[n]={}),t=i.ticksPerOcclusionTest,s.ticksPerOcclusionTest!==t&&(s.ticksPerOcclusionTest=t,s.renderCountdown=t),--i.occlusionTestCountdown<=0&&(i.doOcclusionTest(),i.occlusionTestCountdown=t),o=i.ticksPerRender,s.ticksPerRender!==o&&(s.ticksPerRender=o,s.renderCountdown=o),--s.renderCountdown===0&&(i.render(e),s.renderCountdown=o))}class Et{get type(){return"Component"}get isComponent(){return!0}constructor(e=null,i={}){if(this.scene=null,this.type==="Scene")this.scene=this,this.viewer=i.viewer;else{if(e.type==="Scene")this.scene=e;else if(e instanceof Et)this.scene=e.scene;else throw"Invalid param: owner must be a Component";this._owner=e}this._dontClear=!!i.dontClear,this._renderer=this.scene._renderer,this.meta=i.meta||{},this.id=i.id,this.destroyed=!1,this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._eventSubsNum=null,this._events=null,this._eventCallDepth=0,this._ownedComponents=null,this!==this.scene&&this.scene._addComponent(this),this._updateScheduled=!1,e&&e._own(this)}glRedraw(){this._renderer&&(this._renderer.imageDirty(),this.castsShadow&&this._renderer.shadowsDirty())}glResort(){this._renderer&&this._renderer.needStateSort()}get owner(){return this._owner}isType(e){return this.type===e}fire(e,i,s){this._events||(this._events={}),this._eventSubs||(this._eventSubs={},this._eventSubsNum={}),s!==!0&&(this._events[e]=i||!0);const t=this._eventSubs[e];let o;if(t)for(const n in t)t.hasOwnProperty(n)&&(o=t[n],this._eventCallDepth++,this._eventCallDepth<300?o.callback.call(o.scope,i):this.error("fire: potential stack overflow from recursive event '"+e+"' - dropping this event"),this._eventCallDepth--)}on(e,i,s){this._events||(this._events={}),this._subIdMap||(this._subIdMap=new Ci),this._subIdEvents||(this._subIdEvents={}),this._eventSubs||(this._eventSubs={}),this._eventSubsNum||(this._eventSubsNum={});let t=this._eventSubs[e];t?this._eventSubsNum[e]++:(t={},this._eventSubs[e]=t,this._eventSubsNum[e]=1);const o=this._subIdMap.addItem();t[o]={callback:i,scope:s||this},this._subIdEvents[o]=e;const n=this._events[e];return n!==void 0&&i.call(s||this,n),o}off(e){if(e==null||!this._subIdEvents)return;const i=this._subIdEvents[e];if(i){delete this._subIdEvents[e];const s=this._eventSubs[i];s&&(delete s[e],this._eventSubsNum[i]--),this._subIdMap.removeItem(e)}}once(e,i,s){const t=this,o=this.on(e,function(n){t.off(o),i.call(s||this,n)},s)}hasSubs(e){return this._eventSubsNum&&this._eventSubsNum[e]>0}log(e){e="[LOG]"+this._message(e),window.console.log(e),this.scene.fire("log",e)}_message(e){return" ["+this.type+" "+Le.inQuotes(this.id)+"]: "+e}warn(e){e="[WARN]"+this._message(e),window.console.warn(e),this.scene.fire("warn",e)}error(e){e="[ERROR]"+this._message(e),window.console.error(e),this.scene.fire("error",e)}_attach(e){const i=e.name;if(!i){this.error("Component 'name' expected");return}let s=e.component;const t=e.sceneDefault,o=e.sceneSingleton,n=e.type,a=e.on,A=e.recompiles!==!1;let l=!1;if(s&&(Le.isNumeric(s)||Le.isString(s))){const _=s;if(s=this.scene.components[_],!s){this.error("Component not found: "+Le.inQuotes(_));return}}if(!s){if(o===!0){const _=this.scene.types[n];for(const u in _)if(_.hasOwnProperty){s=_[u];break}if(!s)return this.error("Scene has no default component for '"+i+"'"),null}else if(t===!0&&(s=this.scene[i],!s))return this.error("Scene has no default component for '"+i+"'"),null}if(s){if(s.scene.id!==this.scene.id){this.error("Not in same scene: "+s.type+" "+Le.inQuotes(s.id));return}if(n&&!s.isType(n)){this.error("Expected a "+n+" type or subtype: "+s.type+" "+Le.inQuotes(s.id));return}}this._attachments||(this._attachments={});const h=this._attached[i];let d,f,m;if(h){if(s&&h.id===s.id)return;const _=this._attachments[h.id];for(d=_.subs,f=0,m=d.length;f<m;f++)h.off(d[f]);delete this._attached[i],delete this._attachments[h.id];const u=_.params.onDetached;u&&(Le.isFunction(u)?u(h):u.scope?u.callback.call(u.scope,h):u.callback(h)),_.managingLifecycle&&h.destroy()}if(s){const _={params:e,component:s,subs:[],managingLifecycle:l};_.subs.push(s.once("destroyed",function(){_.params.component=null,this._attach(_.params)},this)),A&&_.subs.push(s.on("dirty",function(){this.fire("dirty",this)},this)),this._attached[i]=s,this._attachments[s.id]=_;const u=e.onAttached;if(u&&(Le.isFunction(u)?u(s):u.scope?u.callback.call(u.scope,s):u.callback(s)),a){let P,y,x,B;for(P in a)if(a.hasOwnProperty(P)){if(y=a[P],Le.isFunction(y)?(x=y,B=null):(x=y.callback,B=y.scope),!x)continue;_.subs.push(s.on(P,x,B))}}}return A&&this.fire("dirty",this),this.fire(i,s),s}_checkComponent(e,i){if(!i.isComponent)if(Le.isID(i)){const s=i;if(i=this.scene.components[s],!i){this.error("Component not found: "+s);return}}else{this.error("Expected a Component or ID");return}if(e!==i.type){this.error("Expected a "+e+" Component");return}if(i.scene.id!==this.scene.id){this.error("Not in same scene: "+i.type);return}return i}_checkComponent2(e,i){if(!i.isComponent)if(Le.isID(i)){const o=i;if(i=this.scene.components[o],!i){this.error("Component not found: "+o);return}}else{this.error("Expected a Component or ID");return}if(i.scene.id!==this.scene.id){this.error("Not in same scene: "+i.type);return}for(var s=0,t=e.length;s<t;s++)if(e[s]===i.type)return i;return this.error("Expected component types: "+e),null}_own(e){this._ownedComponents||(this._ownedComponents={}),this._ownedComponents[e.id]||(this._ownedComponents[e.id]=e),e.once("destroyed",()=>{delete this._ownedComponents[e.id]},this)}_needUpdate(e){this._updateScheduled||(this._updateScheduled=!0,e===0?this._doUpdate():xt.scheduleTask(this._doUpdate,this))}_doUpdate(){this._updateScheduled&&(this._updateScheduled=!1,this._update&&this._update())}scheduleTask(e){xt.scheduleTask(e,null)}_update(){}clear(){if(this._ownedComponents)for(var e in this._ownedComponents)this._ownedComponents.hasOwnProperty(e)&&(this._ownedComponents[e].destroy(),delete this._ownedComponents[e])}destroy(){if(this.destroyed)return;this.fire("destroyed",this.destroyed=!0);let e,i,s,t,o,n;if(this._attachments){for(e in this._attachments)if(this._attachments.hasOwnProperty(e)){for(i=this._attachments[e],s=i.component,t=i.subs,o=0,n=t.length;o<n;o++)s.off(t[o]);i.managingLifecycle&&s.destroy()}}if(this._ownedComponents)for(e in this._ownedComponents)this._ownedComponents.hasOwnProperty(e)&&(s=this._ownedComponents[e],s.destroy(),delete this._ownedComponents[e]);this.scene._removeComponent(this),this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._events=null,this._eventCallDepth=0,this._ownedComponents=null,this._updateScheduled=!1}}const cm=c.vec3(),hm=c.vec3(),um=c.mat4();class Ts{constructor(){this.normal=c.vec3(),this.offset=0,this.testVertex=c.vec3()}set(e,i,s,t){const o=1/Math.sqrt(e*e+i*i+s*s);this.normal[0]=e*o,this.normal[1]=i*o,this.normal[2]=s*o,this.offset=t*o,this.testVertex[0]=this.normal[0]>=0?1:0,this.testVertex[1]=this.normal[1]>=0?1:0,this.testVertex[2]=this.normal[2]>=0?1:0}}class vi{constructor(){this.planes=[new Ts,new Ts,new Ts,new Ts,new Ts,new Ts]}}vi.INSIDE=0;vi.INTERSECT=1;vi.OUTSIDE=2;function dm(r,e,i){const s=c.mulMat4(i,e,um),t=s[0],o=s[1],n=s[2],a=s[3],A=s[4],l=s[5],h=s[6],d=s[7],f=s[8],m=s[9],_=s[10],u=s[11],P=s[12],y=s[13],x=s[14],B=s[15];r.planes[0].set(a-t,d-A,u-f,B-P),r.planes[1].set(a+t,d+A,u+f,B+P),r.planes[2].set(a-o,d-l,u-m,B-y),r.planes[3].set(a+o,d+l,u+m,B+y),r.planes[4].set(a-n,d-h,u-_,B-x),r.planes[5].set(a+n,d+h,u+_,B+x)}function fa(r,e){let i=vi.INSIDE;const s=cm,t=hm;s[0]=e[0],s[1]=e[1],s[2]=e[2],t[0]=e[3],t[1]=e[4],t[2]=e[5];const o=[s,t];for(let n=0;n<6;++n){const a=r.planes[n];if(a.normal[0]*o[a.testVertex[0]][0]+a.normal[1]*o[a.testVertex[1]][1]+a.normal[2]*o[a.testVertex[2]][2]+a.offset<0)return vi.OUTSIDE;a.normal[0]*o[1-a.testVertex[0]][0]+a.normal[1]*o[1-a.testVertex[1]][1]+a.normal[2]*o[1-a.testVertex[2]][2]+a.offset<0&&(i=vi.INTERSECT)}return i}class Bs extends Et{constructor(e={}){if(!e.viewer)throw"[MarqueePicker] Missing config: viewer";if(!e.objectsKdTree3)throw"[MarqueePicker] Missing config: objectsKdTree3";super(e.viewer.scene,e),this.viewer=e.viewer,this._objectsKdTree3=e.objectsKdTree3,this._canvasMarqueeCorner1=c.vec2(),this._canvasMarqueeCorner2=c.vec2(),this._canvasMarquee=c.AABB2(),this._marqueeFrustum=new vi,this._marqueeFrustumProjMat=c.mat4(),this._pickMode=!1,this._marqueeElement=document.createElement("div"),document.body.appendChild(this._marqueeElement),this._marqueeElement.style.position="absolute",this._marqueeElement.style["z-index"]="40000005",this._marqueeElement.style.width="8px",this._marqueeElement.style.height="8px",this._marqueeElement.style.visibility="hidden",this._marqueeElement.style.top="0px",this._marqueeElement.style.left="0px",this._marqueeElement.style["box-shadow"]="0 2px 5px 0 #182A3D;",this._marqueeElement.style.opacity=1,this._marqueeElement.style["pointer-events"]="none"}setMarqueeCorner1(e){this._canvasMarqueeCorner1.set(e),this._canvasMarqueeCorner2.set(e),this._updateMarquee()}setMarqueeCorner2(e){this._canvasMarqueeCorner2.set(e),this._updateMarquee()}setMarquee(e,i){this._canvasMarqueeCorner1.set(e),this._canvasMarqueeCorner2.set(i),this._updateMarquee()}setMarqueeVisible(e){this._marqueVisible=e,this._marqueeElement.style.visibility=e?"visible":"hidden"}getMarqueeVisible(){return this._marqueVisible}setPickMode(e){if(e!==Bs.PICK_MODE_INSIDE&&e!==Bs.PICK_MODE_INTERSECTS)throw"Illegal MarqueePicker pickMode: must be MarqueePicker.PICK_MODE_INSIDE or MarqueePicker.PICK_MODE_INTERSECTS";e!==this._pickMode&&(this._marqueeElement.style["background-image"]=e===Bs.PICK_MODE_INSIDE?`url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='6' ry='6' stroke='%23333' stroke-width='4'/%3e%3c/svg%3e")`:`url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='6' ry='6' stroke='%23333' stroke-width='4' stroke-dasharray='6%2c 14' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e")`,this._pickMode=e)}getPickMode(){return this._pickMode}clear(){this.fire("clear",{})}pick(){this._updateMarquee(),this._buildMarqueeFrustum();const e=[],i=(s,t=vi.INTERSECT)=>{if(t===vi.INTERSECT&&(t=fa(this._marqueeFrustum,s.aabb)),t!==vi.OUTSIDE){if(s.entities){const o=s.entities;for(let n=0,a=o.length;n<a;n++){const A=o[n];if(!A.visible)continue;const l=A.aabb;this._pickMode===Bs.PICK_MODE_INSIDE?fa(this._marqueeFrustum,l)===vi.INSIDE&&e.push(A.id):fa(this._marqueeFrustum,l)!==vi.OUTSIDE&&e.push(A.id)}}s.left&&i(s.left,t),s.right&&i(s.right,t)}};return(this._canvasMarquee[2]-this._canvasMarquee[0]>3||this._canvasMarquee[3]-this._canvasMarquee[1]>3)&&i(this._objectsKdTree3.root),this.fire("picked",e),e}_updateMarquee(){this._canvasMarquee[0]=Math.min(this._canvasMarqueeCorner1[0],this._canvasMarqueeCorner2[0]),this._canvasMarquee[1]=Math.min(this._canvasMarqueeCorner1[1],this._canvasMarqueeCorner2[1]),this._canvasMarquee[2]=Math.max(this._canvasMarqueeCorner1[0],this._canvasMarqueeCorner2[0]),this._canvasMarquee[3]=Math.max(this._canvasMarqueeCorner1[1],this._canvasMarqueeCorner2[1]),this._marqueeElement.style.width=`${this._canvasMarquee[2]-this._canvasMarquee[0]}px`,this._marqueeElement.style.height=`${this._canvasMarquee[3]-this._canvasMarquee[1]}px`,this._marqueeElement.style.left=`${this._canvasMarquee[0]}px`,this._marqueeElement.style.top=`${this._canvasMarquee[1]}px`}_buildMarqueeFrustum(){const e=this.viewer.scene.canvas.canvas,i=e.clientWidth,s=e.clientHeight,t=e.clientLeft,o=e.clientTop,n=2/i,a=2/s,A=17,l=e.clientHeight/e.clientWidth,h=1e4,d=(this._canvasMarquee[0]-t)*n+-1,f=(this._canvasMarquee[2]-t)*n+-1,m=-(this._canvasMarquee[3]-o)*a+1,_=-(this._canvasMarquee[1]-o)*a+1,u=this.viewer.scene.camera.frustum.near*(A*l),P=h;c.frustumMat4(d,f,m*l,_*l,u,P,this._marqueeFrustumProjMat),dm(this._marqueeFrustum,this.viewer.scene.camera.viewMatrix,this._marqueeFrustumProjMat)}destroy(){super.destroy(),this._marqueeElement.parentElement&&(this._marqueeElement.parentElement.removeChild(this._marqueeElement),this._marqueeElement=null,this._objectsKdTree3=null)}}Bs.PICK_MODE_INTERSECTS=0;Bs.PICK_MODE_INSIDE=1;class Ap{constructor(e,i,s){this.id=s&&s.id?s.id:e,this.viewer=i,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._eventSubsNum=null,this._events=null,this._eventCallDepth=0,i.addPlugin(this)}scheduleTask(e){xt.scheduleTask(e,null)}fire(e,i,s){this._events||(this._events={}),this._eventSubs||(this._eventSubs={},this._eventSubsNum={}),s!==!0&&(this._events[e]=i||!0);const t=this._eventSubs[e];let o;if(t)for(const n in t)t.hasOwnProperty(n)&&(o=t[n],this._eventCallDepth++,this._eventCallDepth<300?o.callback.call(o.scope,i):this.error("fire: potential stack overflow from recursive event '"+e+"' - dropping this event"),this._eventCallDepth--)}on(e,i,s){this._events||(this._events={}),this._subIdMap||(this._subIdMap=new Ci),this._subIdEvents||(this._subIdEvents={}),this._eventSubs||(this._eventSubs={}),this._eventSubsNum||(this._eventSubsNum={});let t=this._eventSubs[e];t?this._eventSubsNum[e]++:(t={},this._eventSubs[e]=t,this._eventSubsNum[e]=1);const o=this._subIdMap.addItem();t[o]={callback:i,scope:s||this},this._subIdEvents[o]=e;const n=this._events[e];return n!==void 0&&i.call(s||this,n),o}off(e){if(e==null||!this._subIdEvents)return;const i=this._subIdEvents[e];if(i){delete this._subIdEvents[e];const s=this._eventSubs[i];s&&(delete s[e],this._eventSubsNum[i]--),this._subIdMap.removeItem(e)}}once(e,i,s){const t=this,o=this.on(e,function(n){t.off(o),i.call(s||this,n)},s)}hasSubs(e){return this._eventSubsNum&&this._eventSubsNum[e]>0}log(e){console.log(`[xeokit plugin ${this.id}]: ${e}`)}warn(e){console.warn(`[xeokit plugin ${this.id}]: ${e}`)}error(e){console.error(`[xeokit plugin ${this.id}]: ${e}`)}send(e,i){}destroy(){this.viewer.removePlugin(this)}}const lp=c.vec3(),ft=function(){const r=new Float64Array(16),e=new Float64Array(4),i=new Float64Array(4);return function(s,t,o){return o=o||r,e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=1,c.transformVec4(s,e,i),c.setMat4Translation(s,i,o),o.slice()}}();function hc(r,e,i){const s=Float32Array.from([r[0]])[0],t=r[0]-s,o=Float32Array.from([r[1]])[0],n=r[1]-o,a=Float32Array.from([r[2]])[0],A=r[2]-a;e[0]=s,e[1]=o,e[2]=a,i[0]=t,i[1]=n,i[2]=A}function LA(r,e,i,s=1e3){const t=c.getPositionsCenter(r,lp),o=Math.round(t[0]/s)*s,n=Math.round(t[1]/s)*s,a=Math.round(t[2]/s)*s;i[0]=o,i[1]=n,i[2]=a;const A=i[0]!==0||i[1]!==0||i[2]!==0;if(A)for(let l=0,h=r.length;l<h;l+=3)e[l+0]=r[l+0]-o,e[l+1]=r[l+1]-n,e[l+2]=r[l+2]-a;return A}function Ut(r,e,i,s){const t=c.dotVec3(e,i)+r,o=c.normalizeVec3(e,lp);return c.mulVec3Scalar(o,-t,s),s}const k={VISIBLE:1,CULLED:4,PICKABLE:8,CLIPPABLE:16,COLLIDABLE:32,CAST_SHADOW:64,RECEIVE_SHADOW:128,XRAYED:256,HIGHLIGHTED:512,SELECTED:1024,EDGES:2048,BACKFACES:4096,TRANSPARENT:8192},Fo=new Float32Array([0,0,0]),Mo=new Uint16Array([0,0,0]);c.OBB3();class pm{constructor(e,i,s,t,o,n){this._isObject=i,this.scene=e.scene,this.model=e,this.meshes=t,this._numPrimitives=0;for(let a=0,A=this.meshes.length;a<A;a++){const l=this.meshes[a];l.parent=this,l.entity=this,this._numPrimitives+=l.numPrimitives}this.id=s,this.originalSystemId=c.unglobalizeObjectId(e.id,s),this._flags=o,this._aabb=c.AABB3(),this._aabbDirty=!0,this._offset=c.vec3(),this._colorizeUpdated=!1,this._opacityUpdated=!1,this._lodCullable=!!n,this._culled=!1,this._culledVFC=!1,this._culledLOD=!1,this._isObject&&e.scene._registerObject(this)}_transformDirty(){this._aabbDirty=!0,this.model._transformDirty()}_sceneModelDirty(){this._aabbDirty=!0;for(let e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._sceneModelDirty()}get aabb(){if(this._aabbDirty){c.collapseAABB3(this._aabb);for(let e=0,i=this.meshes.length;e<i;e++)c.expandAABB3(this._aabb,this.meshes[e].aabb);this._aabbDirty=!1}return this._aabb}get isEntity(){return!0}get isModel(){return!1}get isObject(){return this._isObject}get numPrimitives(){return this._numPrimitives}get numTriangles(){return this._numPrimitives}get visible(){return this._getFlag(k.VISIBLE)}set visible(e){if(!!(this._flags&k.VISIBLE)!==e){e?this._flags=this._flags|k.VISIBLE:this._flags=this._flags&~k.VISIBLE;for(let i=0,s=this.meshes.length;i<s;i++)this.meshes[i]._setVisible(this._flags);this._isObject&&this.model.scene._objectVisibilityUpdated(this),this.model.glRedraw()}}get highlighted(){return this._getFlag(k.HIGHLIGHTED)}set highlighted(e){if(!!(this._flags&k.HIGHLIGHTED)!==e){e?this._flags=this._flags|k.HIGHLIGHTED:this._flags=this._flags&~k.HIGHLIGHTED;for(var i=0,s=this.meshes.length;i<s;i++)this.meshes[i]._setHighlighted(this._flags);this._isObject&&this.model.scene._objectHighlightedUpdated(this),this.model.glRedraw()}}get xrayed(){return this._getFlag(k.XRAYED)}set xrayed(e){if(!!(this._flags&k.XRAYED)!==e){e?this._flags=this._flags|k.XRAYED:this._flags=this._flags&~k.XRAYED;for(let i=0,s=this.meshes.length;i<s;i++)this.meshes[i]._setXRayed(this._flags);this._isObject&&this.model.scene._objectXRayedUpdated(this),this.model.glRedraw()}}get selected(){return this._getFlag(k.SELECTED)}set selected(e){if(!!(this._flags&k.SELECTED)!==e){e?this._flags=this._flags|k.SELECTED:this._flags=this._flags&~k.SELECTED;for(let i=0,s=this.meshes.length;i<s;i++)this.meshes[i]._setSelected(this._flags);this._isObject&&this.model.scene._objectSelectedUpdated(this),this.model.glRedraw()}}get edges(){return this._getFlag(k.EDGES)}set edges(e){if(!!(this._flags&k.EDGES)!==e){e?this._flags=this._flags|k.EDGES:this._flags=this._flags&~k.EDGES;for(var i=0,s=this.meshes.length;i<s;i++)this.meshes[i]._setEdges(this._flags);this.model.glRedraw()}}get culledVFC(){return!!this._culledVFC}set culledVFC(e){this._culledVFC=e,this._setCulled()}get culledLOD(){return!!this._culledLOD}set culledLOD(e){this._culledLOD=e,this._setCulled()}get culled(){return!!this._culled}set culled(e){this._culled=e,this._setCulled()}_setCulled(){let e=!!this._culled||!!(this._culledLOD&&this._lodCullable)||!!this._culledVFC;if(!!(this._flags&k.CULLED)!==e){e?this._flags=this._flags|k.CULLED:this._flags=this._flags&~k.CULLED;for(var i=0,s=this.meshes.length;i<s;i++)this.meshes[i]._setCulled(this._flags);this.model.glRedraw()}}get clippable(){return this._getFlag(k.CLIPPABLE)}set clippable(e){if(!!(this._flags&k.CLIPPABLE)!==e){e?this._flags=this._flags|k.CLIPPABLE:this._flags=this._flags&~k.CLIPPABLE;for(var i=0,s=this.meshes.length;i<s;i++)this.meshes[i]._setClippable(this._flags);this.model.glRedraw()}}get collidable(){return this._getFlag(k.COLLIDABLE)}set collidable(e){if(!!(this._flags&k.COLLIDABLE)!==e){e?this._flags=this._flags|k.COLLIDABLE:this._flags=this._flags&~k.COLLIDABLE;for(var i=0,s=this.meshes.length;i<s;i++)this.meshes[i]._setCollidable(this._flags)}}get pickable(){return this._getFlag(k.PICKABLE)}set pickable(e){if(!!(this._flags&k.PICKABLE)!==e){e?this._flags=this._flags|k.PICKABLE:this._flags=this._flags&~k.PICKABLE;for(var i=0,s=this.meshes.length;i<s;i++)this.meshes[i]._setPickable(this._flags)}}get colorize(){if(this.meshes.length===0)return null;const e=this.meshes[0]._colorize;return Fo[0]=e[0]/255,Fo[1]=e[1]/255,Fo[2]=e[2]/255,Fo}set colorize(e){if(e){Mo[0]=Math.floor(e[0]*255),Mo[1]=Math.floor(e[1]*255),Mo[2]=Math.floor(e[2]*255);for(let i=0,s=this.meshes.length;i<s;i++)this.meshes[i]._setColorize(Mo)}else for(let i=0,s=this.meshes.length;i<s;i++)this.meshes[i]._setColorize(null);if(this._isObject){const i=!!e;this.scene._objectColorizeUpdated(this,i),this._colorizeUpdated=i}this.model.glRedraw()}get opacity(){return this.meshes.length>0?this.meshes[0]._colorize[3]/255:1}set opacity(e){if(this.meshes.length===0)return;const i=e!=null,s=this.meshes[0]._colorize[3];let t=255;if(i){if(e<0?e=0:e>1&&(e=1),t=Math.floor(e*255),s===t)return}else if(t=255,s===t)return;for(let o=0,n=this.meshes.length;o<n;o++)this.meshes[o]._setOpacity(t,this._flags);this._isObject&&(this.scene._objectOpacityUpdated(this,i),this._opacityUpdated=i),this.model.glRedraw()}get offset(){return this._offset}set offset(e){e?(this._offset[0]=e[0],this._offset[1]=e[1],this._offset[2]=e[2]):(this._offset[0]=0,this._offset[1]=0,this._offset[2]=0);for(let i=0,s=this.meshes.length;i<s;i++)this.meshes[i]._setOffset(this._offset);this._aabbDirty=!0,this.model._aabbDirty=!0,this.scene._aabbDirty=!0,this.scene._objectOffsetUpdated(this,e),this.model.glRedraw()}get saoEnabled(){return this.model.saoEnabled}getEachVertex(e){for(let i=0,s=this.meshes.length;i<s;i++)this.meshes[i].getEachVertex(e)}_getFlag(e){return!!(this._flags&e)}_finalize(){const e=this.model.scene;this._isObject&&(this.visible&&e._objectVisibilityUpdated(this),this.highlighted&&e._objectHighlightedUpdated(this),this.xrayed&&e._objectXRayedUpdated(this),this.selected&&e._objectSelectedUpdated(this));for(let i=0,s=this.meshes.length;i<s;i++)this.meshes[i]._finalize(this._flags)}_finalize2(){for(let e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._finalize2()}_destroy(){const e=this.model.scene;this._isObject&&(e._deregisterObject(this),this.visible&&e._deRegisterVisibleObject(this),this.xrayed&&e._deRegisterXRayedObject(this),this.selected&&e._deRegisterSelectedObject(this),this.highlighted&&e._deRegisterHighlightedObject(this),this._colorizeUpdated&&this.scene._deRegisterColorizedObject(this),this._opacityUpdated&&this.scene._deRegisterOpacityObject(this),this._offset&&(this._offset[0]!==0||this._offset[1]!==0||this._offset[2]!==0)&&this.scene._deRegisterOffsetObject(this));for(let i=0,s=this.meshes.length;i<s;i++)this.meshes[i]._destroy();e._aabbDirty=!0}}c.vec4();c.vec4();c.vec3();c.vec3();c.vec3();c.vec3();c.vec3();const fm=".sk-fading-circle {        background: transparent;        margin: 20px auto;        width: 50px;        height:50px;        position: relative;        }        .sk-fading-circle .sk-circle {        width: 120%;        height: 120%;        position: absolute;        left: 0;        top: 0;        }        .sk-fading-circle .sk-circle:before {        content: '';        display: block;        margin: 0 auto;        width: 15%;        height: 15%;        background-color: #ff8800;        border-radius: 100%;        -webkit-animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        }        .sk-fading-circle .sk-circle2 {        -webkit-transform: rotate(30deg);        -ms-transform: rotate(30deg);        transform: rotate(30deg);    }    .sk-fading-circle .sk-circle3 {        -webkit-transform: rotate(60deg);        -ms-transform: rotate(60deg);        transform: rotate(60deg);    }    .sk-fading-circle .sk-circle4 {        -webkit-transform: rotate(90deg);        -ms-transform: rotate(90deg);        transform: rotate(90deg);    }    .sk-fading-circle .sk-circle5 {        -webkit-transform: rotate(120deg);        -ms-transform: rotate(120deg);        transform: rotate(120deg);    }    .sk-fading-circle .sk-circle6 {        -webkit-transform: rotate(150deg);        -ms-transform: rotate(150deg);        transform: rotate(150deg);    }    .sk-fading-circle .sk-circle7 {        -webkit-transform: rotate(180deg);        -ms-transform: rotate(180deg);        transform: rotate(180deg);    }    .sk-fading-circle .sk-circle8 {        -webkit-transform: rotate(210deg);        -ms-transform: rotate(210deg);        transform: rotate(210deg);    }    .sk-fading-circle .sk-circle9 {        -webkit-transform: rotate(240deg);        -ms-transform: rotate(240deg);        transform: rotate(240deg);    }    .sk-fading-circle .sk-circle10 {        -webkit-transform: rotate(270deg);        -ms-transform: rotate(270deg);        transform: rotate(270deg);    }    .sk-fading-circle .sk-circle11 {        -webkit-transform: rotate(300deg);        -ms-transform: rotate(300deg);        transform: rotate(300deg);    }    .sk-fading-circle .sk-circle12 {        -webkit-transform: rotate(330deg);        -ms-transform: rotate(330deg);        transform: rotate(330deg);    }    .sk-fading-circle .sk-circle2:before {        -webkit-animation-delay: -1.1s;        animation-delay: -1.1s;    }    .sk-fading-circle .sk-circle3:before {        -webkit-animation-delay: -1s;        animation-delay: -1s;    }    .sk-fading-circle .sk-circle4:before {        -webkit-animation-delay: -0.9s;        animation-delay: -0.9s;    }    .sk-fading-circle .sk-circle5:before {        -webkit-animation-delay: -0.8s;        animation-delay: -0.8s;    }    .sk-fading-circle .sk-circle6:before {        -webkit-animation-delay: -0.7s;        animation-delay: -0.7s;    }    .sk-fading-circle .sk-circle7:before {        -webkit-animation-delay: -0.6s;        animation-delay: -0.6s;    }    .sk-fading-circle .sk-circle8:before {        -webkit-animation-delay: -0.5s;        animation-delay: -0.5s;    }    .sk-fading-circle .sk-circle9:before {        -webkit-animation-delay: -0.4s;        animation-delay: -0.4s;    }    .sk-fading-circle .sk-circle10:before {        -webkit-animation-delay: -0.3s;        animation-delay: -0.3s;    }    .sk-fading-circle .sk-circle11:before {        -webkit-animation-delay: -0.2s;        animation-delay: -0.2s;    }    .sk-fading-circle .sk-circle12:before {        -webkit-animation-delay: -0.1s;        animation-delay: -0.1s;    }    @-webkit-keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }    @keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }";class gm extends Et{get type(){return"Spinner"}constructor(e,i={}){super(e,i),this._canvas=i.canvas,this._element=null,this._isCustom=!1,i.elementId&&(this._element=document.getElementById(i.elementId),this._element?this._adjustPosition():this.error("Can't find given Spinner HTML element: '"+i.elementId+"' - will automatically create default element")),this._element||this._createDefaultSpinner(),this.processes=0}_createDefaultSpinner(){this._injectDefaultCSS();const e=document.createElement("div"),i=e.style;i["z-index"]="9000",i.position="absolute",e.innerHTML='<div class="sk-fading-circle">                <div class="sk-circle1 sk-circle"></div>                <div class="sk-circle2 sk-circle"></div>                <div class="sk-circle3 sk-circle"></div>                <div class="sk-circle4 sk-circle"></div>                <div class="sk-circle5 sk-circle"></div>                <div class="sk-circle6 sk-circle"></div>                <div class="sk-circle7 sk-circle"></div>                <div class="sk-circle8 sk-circle"></div>                <div class="sk-circle9 sk-circle"></div>                <div class="sk-circle10 sk-circle"></div>                <div class="sk-circle11 sk-circle"></div>                <div class="sk-circle12 sk-circle"></div>                </div>',this._canvas.parentElement.appendChild(e),this._element=e,this._isCustom=!1,this._adjustPosition()}_injectDefaultCSS(){const e="xeokit-spinner-css";if(document.getElementById(e))return;const i=document.createElement("style");i.innerHTML=fm,i.id=e,document.body.appendChild(i)}_adjustPosition(){if(this._isCustom)return;const e=this._canvas,i=this._element,s=i.style;s.left=e.offsetLeft+e.clientWidth*.5-i.clientWidth*.5+"px",s.top=e.offsetTop+e.clientHeight*.5-i.clientHeight*.5+"px"}set processes(e){if(e=e||0,this._processes===e||e<0)return;const i=this._processes;this._processes=e;const s=this._element;s&&(s.style.visibility=this._processes>0?"visible":"hidden"),this.fire("processes",this._processes),this._processes===0&&this._processes!==i&&this.fire("zeroProcesses",this._processes)}get processes(){return this._processes}_destroy(){this._element&&!this._isCustom&&(this._element.parentNode.removeChild(this._element),this._element=null);const e=document.getElementById("xeokit-spinner-css");e&&e.parentNode.removeChild(e)}}const uc=["webgl2","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"];class mm extends Et{constructor(e,i={}){super(e,i),this._backgroundColor=c.vec3([i.backgroundColor?i.backgroundColor[0]:1,i.backgroundColor?i.backgroundColor[1]:1,i.backgroundColor?i.backgroundColor[2]:1]),this._backgroundColorFromAmbientLight=!!i.backgroundColorFromAmbientLight,this.canvas=i.canvas,this.gl=null,this.webgl2=!1,this.transparent=!!i.transparent,this.contextAttr=i.contextAttr||{},this.contextAttr.alpha=this.transparent,this.contextAttr.preserveDrawingBuffer=!!this.contextAttr.preserveDrawingBuffer,this.contextAttr.stencil=!1,this.contextAttr.premultipliedAlpha=!!this.contextAttr.premultipliedAlpha,this.contextAttr.antialias=this.contextAttr.antialias!==!1,this.resolutionScale=i.resolutionScale,this.canvas.width=Math.round(this.canvas.clientWidth*this._resolutionScale),this.canvas.height=Math.round(this.canvas.clientHeight*this._resolutionScale),this.boundary=[this.canvas.offsetLeft,this.canvas.offsetTop,this.canvas.clientWidth,this.canvas.clientHeight],this._initWebGL(i);const s=this;this.canvas.addEventListener("webglcontextlost",this._webglcontextlostListener=function(n){console.time("webglcontextrestored"),s.scene._webglContextLost(),s.fire("webglcontextlost"),n.preventDefault()},!1),this.canvas.addEventListener("webglcontextrestored",this._webglcontextrestoredListener=function(n){s._initWebGL(),s.gl&&(s.scene._webglContextRestored(s.gl),s.fire("webglcontextrestored",s.gl),n.preventDefault()),console.timeEnd("webglcontextrestored")},!1);let t=!0;new ResizeObserver(n=>{for(const a of n)a.contentBoxSize&&(t=!0)}).observe(this.canvas),this._tick=this.scene.on("tick",()=>{t&&(t=!1,s.canvas.width=Math.round(s.canvas.clientWidth*s._resolutionScale),s.canvas.height=Math.round(s.canvas.clientHeight*s._resolutionScale),s.boundary[0]=s.canvas.offsetLeft,s.boundary[1]=s.canvas.offsetTop,s.boundary[2]=s.canvas.clientWidth,s.boundary[3]=s.canvas.clientHeight,s.fire("boundary",s.boundary))}),this._spinner=new gm(this.scene,{canvas:this.canvas,elementId:i.spinnerElementId})}get type(){return"Canvas"}get backgroundColorFromAmbientLight(){return this._backgroundColorFromAmbientLight}set backgroundColorFromAmbientLight(e){this._backgroundColorFromAmbientLight=e!==!1,this.glRedraw()}get backgroundColor(){return this._backgroundColor}set backgroundColor(e){e?(this._backgroundColor[0]=e[0],this._backgroundColor[1]=e[1],this._backgroundColor[2]=e[2]):(this._backgroundColor[0]=1,this._backgroundColor[1]=1,this._backgroundColor[2]=1),this.glRedraw()}get resolutionScale(){return this._resolutionScale}set resolutionScale(e){if(e=e||1,e===this._resolutionScale)return;this._resolutionScale=e;const i=this.canvas;i.width=Math.round(i.clientWidth*this._resolutionScale),i.height=Math.round(i.clientHeight*this._resolutionScale),this.glRedraw()}get spinner(){return this._spinner}_createCanvas(){const e="xeokit-canvas-"+c.createUUID(),i=document.getElementsByTagName("body")[0],s=document.createElement("div"),t=s.style;t.height="100%",t.width="100%",t.padding="0",t.margin="0",t.background="rgba(0,0,0,0);",t.float="left",t.left="0",t.top="0",t.position="absolute",t.opacity="1.0",t["z-index"]="-10000",s.innerHTML+='<canvas id="'+e+'" style="width: 100%; height: 100%; float: left; margin: 0; padding: 0;"></canvas>',i.appendChild(s),this.canvas=document.getElementById(e)}_getElementXY(e){let i=0,s=0;for(;e;)i+=e.offsetLeft-e.scrollLeft,s+=e.offsetTop-e.scrollTop,e=e.offsetParent;return{x:i,y:s}}_initWebGL(){if(!this.gl)for(let e=0;!this.gl&&e<uc.length;e++)try{this.gl=this.canvas.getContext(uc[e],this.contextAttr)}catch{}this.gl||(this.error("Failed to get a WebGL context"),this.fire("webglContextFailed",!0,!0));{const e=this.gl;let i="__",s=e.activeTexture;e.activeTexture=function(n){i!==n&&(i=n,s.call(this,n))};let t={},o=e.bindTexture;e.bindTexture=function(n,a){t[i]!==a&&(t[i]=a,o.call(this,n,a))}}this.gl&&this.webgl2&&(this.gl.hint(this.gl.FRAGMENT_SHADER_DERIVATIVE_HINT,this.gl.FASTEST),this.gl instanceof WebGL2RenderingContext)}getSnapshot(e){throw"Canvas#getSnapshot() has been replaced by Viewer#getSnapshot() - use that method instead."}readPixels(e,i,s,t){return this.scene._renderer.readPixels(e,i,s,t)}loseWebGLContext(){this.canvas.loseContext&&this.canvas.loseContext()}destroy(){this.scene.off(this._tick),this._spinner._destroy(),this.canvas.removeEventListener("webglcontextlost",this._webglcontextlostListener),this.canvas.removeEventListener("webglcontextrestored",this._webglcontextrestoredListener),this.gl=null,super.destroy()}}class _m{constructor(e){this._scene=e,this._matPool=[],this._matPoolNextFreeIndex=0,this._rtcViewMats={},this._rtcPickViewMats={},this.reset()}reset(){this._matPoolNextFreeIndex=0,this._rtcViewMats={},this._rtcPickViewMats={},this.gl=this._scene.canvas.gl,this.lastProgramId=null,this.pbrEnabled=!1,this.colorTextureEnabled=!1,this.withSAO=!1,this.backfaces=!1,this.frontface=!0,this.textureUnit=0,this.drawElements=0,this.drawArrays=0,this.useProgram=0,this.bindTexture=0,this.bindArray=0,this.pass=0,this.shadowViewMatrix=null,this.shadowProjMatrix=null,this.pickViewMatrix=null,this.pickProjMatrix=null,this.pickZNear=.01,this.pickZFar=5e3,this.pickInvisible=!1,this.pickElementsCount=null,this.pickElementsOffset=null,this.lineWidth=1,this.snapPickLayerParams={},this.snapPickLayerNumber=0,this.snapPickCoordinateScale=c.vec3(),this.snapPickOrigin=c.vec3()}getRTCViewMatrix(e,i){let s=this._rtcViewMats[e];return s||(s=this._getNewMat(),ft(this._scene.camera.viewMatrix,i,s),this._rtcViewMats[e]=s),s}getRTCPickViewMatrix(e,i){let s=this._rtcPickViewMats[e];if(!s){s=this._getNewMat();const t=this.pickViewMatrix||this._scene.camera.viewMatrix;ft(t,i,s),this._rtcPickViewMats[e]=s}return s}_getNewMat(){let e=this._matPool[this._matPoolNextFreeIndex];return e||(e=c.mat4(),this._matPool[this._matPoolNextFreeIndex]=e),this._matPoolNextFreeIndex++,e}}const _t={WEBGL:!1,SUPPORTED_EXTENSIONS:{}},ga=document.createElement("canvas");if(ga){const r=ga.getContext("webgl",{antialias:!0})||ga.getContext("experimental-webgl",{antialias:!0});_t.WEBGL=!!r,_t.WEBGL&&(_t.ANTIALIAS=r.getContextAttributes().antialias,r.getShaderPrecisionFormat?r.getShaderPrecisionFormat(r.FRAGMENT_SHADER,r.HIGH_FLOAT).precision>0?_t.FS_MAX_FLOAT_PRECISION="highp":r.getShaderPrecisionFormat(r.FRAGMENT_SHADER,r.MEDIUM_FLOAT).precision>0?_t.FS_MAX_FLOAT_PRECISION="mediump":_t.FS_MAX_FLOAT_PRECISION="lowp":_t.FS_MAX_FLOAT_PRECISION="mediump",_t.DEPTH_BUFFER_BITS=r.getParameter(r.DEPTH_BITS),_t.MAX_TEXTURE_SIZE=r.getParameter(r.MAX_TEXTURE_SIZE),_t.MAX_CUBE_MAP_SIZE=r.getParameter(r.MAX_CUBE_MAP_TEXTURE_SIZE),_t.MAX_RENDERBUFFER_SIZE=r.getParameter(r.MAX_RENDERBUFFER_SIZE),_t.MAX_TEXTURE_UNITS=r.getParameter(r.MAX_COMBINED_TEXTURE_IMAGE_UNITS),_t.MAX_TEXTURE_IMAGE_UNITS=r.getParameter(r.MAX_TEXTURE_IMAGE_UNITS),_t.MAX_VERTEX_ATTRIBS=r.getParameter(r.MAX_VERTEX_ATTRIBS),_t.MAX_VERTEX_UNIFORM_VECTORS=r.getParameter(r.MAX_VERTEX_UNIFORM_VECTORS),_t.MAX_FRAGMENT_UNIFORM_VECTORS=r.getParameter(r.MAX_FRAGMENT_UNIFORM_VECTORS),_t.MAX_VARYING_VECTORS=r.getParameter(r.MAX_VARYING_VECTORS),r.getSupportedExtensions().forEach(function(e){_t.SUPPORTED_EXTENSIONS[e]=!0}))}class UA{constructor(){this.entity=null,this.primitive=null,this.primIndex=-1,this.pickSurfacePrecision=!1,this.touchInput=!1,this.snappedToEdge=!1,this.snappedToVertex=!1,this._origin=new Float64Array([0,0,0]),this._direction=new Float64Array([0,0,0]),this._indices=new Int32Array(3),this._localPos=new Float64Array([0,0,0]),this._worldPos=new Float64Array([0,0,0]),this._viewPos=new Float64Array([0,0,0]),this._canvasPos=new Int16Array([0,0]),this._snappedCanvasPos=new Int16Array([0,0]),this._bary=new Float64Array([0,0,0]),this._worldNormal=new Float64Array([0,0,0]),this._uv=new Float64Array([0,0]),this.reset()}get canvasPos(){return this._gotCanvasPos?this._canvasPos:null}set canvasPos(e){e?(this._canvasPos[0]=e[0],this._canvasPos[1]=e[1],this._gotCanvasPos=!0):this._gotCanvasPos=!1}get origin(){return this._gotOrigin?this._origin:null}set origin(e){e?(this._origin[0]=e[0],this._origin[1]=e[1],this._origin[2]=e[2],this._gotOrigin=!0):this._gotOrigin=!1}get direction(){return this._gotDirection?this._direction:null}set direction(e){e?(this._direction[0]=e[0],this._direction[1]=e[1],this._direction[2]=e[2],this._gotDirection=!0):this._gotDirection=!1}get indices(){return this.entity&&this._gotIndices?this._indices:null}set indices(e){e?(this._indices[0]=e[0],this._indices[1]=e[1],this._indices[2]=e[2],this._gotIndices=!0):this._gotIndices=!1}get localPos(){return this.entity&&this._gotLocalPos?this._localPos:null}set localPos(e){e?(this._localPos[0]=e[0],this._localPos[1]=e[1],this._localPos[2]=e[2],this._gotLocalPos=!0):this._gotLocalPos=!1}get snappedCanvasPos(){return this._gotSnappedCanvasPos?this._snappedCanvasPos:null}set snappedCanvasPos(e){e?(this._snappedCanvasPos[0]=e[0],this._snappedCanvasPos[1]=e[1],this._gotSnappedCanvasPos=!0):this._gotSnappedCanvasPos=!1}get worldPos(){return this._gotWorldPos?this._worldPos:null}set worldPos(e){e?(this._worldPos[0]=e[0],this._worldPos[1]=e[1],this._worldPos[2]=e[2],this._gotWorldPos=!0):this._gotWorldPos=!1}get viewPos(){return this.entity&&this._gotViewPos?this._viewPos:null}set viewPos(e){e?(this._viewPos[0]=e[0],this._viewPos[1]=e[1],this._viewPos[2]=e[2],this._gotViewPos=!0):this._gotViewPos=!1}get bary(){return this.entity&&this._gotBary?this._bary:null}set bary(e){e?(this._bary[0]=e[0],this._bary[1]=e[1],this._bary[2]=e[2],this._gotBary=!0):this._gotBary=!1}get worldNormal(){return this.entity&&this._gotWorldNormal?this._worldNormal:null}set worldNormal(e){e?(this._worldNormal[0]=e[0],this._worldNormal[1]=e[1],this._worldNormal[2]=e[2],this._gotWorldNormal=!0):this._gotWorldNormal=!1}get uv(){return this.entity&&this._gotUV?this._uv:null}set uv(e){e?(this._uv[0]=e[0],this._uv[1]=e[1],this._gotUV=!0):this._gotUV=!1}get snapped(){return this.snappedToEdge||this.snappedToVertex}reset(){this.entity=null,this.primIndex=-1,this.primitive=null,this.pickSurfacePrecision=!1,this._gotCanvasPos=!1,this._gotSnappedCanvasPos=!1,this._gotOrigin=!1,this._gotDirection=!1,this._gotIndices=!1,this._gotLocalPos=!1,this._gotWorldPos=!1,this._gotViewPos=!1,this._gotBary=!1,this._gotWorldNormal=!1,this._gotUV=!1,this.touchInput=!1,this.snappedToEdge=!1,this.snappedToVertex=!1}}class dc{constructor(e,i,s){if(this.allocated=!1,this.compiled=!1,this.handle=e.createShader(i),!this.handle){this.errors=["Failed to allocate"];return}if(this.allocated=!0,e.shaderSource(this.handle,s),e.compileShader(this.handle),this.compiled=e.getShaderParameter(this.handle,e.COMPILE_STATUS),!this.compiled&&!e.isContextLost()){const t=s.split(`
`),o=[];for(let n=0;n<t.length;n++)o.push(n+1+": "+t[n]+`
`);this.errors=[],this.errors.push(""),this.errors.push(e.getShaderInfoLog(this.handle)),this.errors=this.errors.concat(o.join(""))}}destroy(){}}class pc{constructor(e,i){this.bindTexture=function(s,t){return s.bind(t)?(e.uniform1i(i,t),!0):!1}}}class vm{constructor(e,i){this._gl=e,this.location=i}bindArrayBuffer(e){e&&(e.bind(),this._gl.enableVertexAttribArray(this.location),this._gl.vertexAttribPointer(this.location,e.itemSize,e.itemType,e.normalized,e.stride,e.offset))}}const fc=new Ci({});function gc(r){const e=[];let i,s;for(let t=0,o=r.length;t<o;t++)i=r[t],s=i.indexOf("/"),s>0&&i.charAt(s+1)==="/"&&(i=i.substring(0,s)),e.push(i);return e.join(`
`)}function wr(r){console.error(r.join(`
`))}class It{constructor(e,i){this.id=fc.addItem({}),this.source=i,this.init(e)}init(e){if(this.gl=e,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errors=null,this.uniforms={},this.samplers={},this.attributes={},this._vertexShader=new dc(e,e.VERTEX_SHADER,gc(this.source.vertex)),this._fragmentShader=new dc(e,e.FRAGMENT_SHADER,gc(this.source.fragment)),!this._vertexShader.allocated){this.errors=["Vertex shader failed to allocate"].concat(this._vertexShader.errors),wr(this.errors);return}if(!this._fragmentShader.allocated){this.errors=["Fragment shader failed to allocate"].concat(this._fragmentShader.errors),wr(this.errors);return}if(this.allocated=!0,!this._vertexShader.compiled){this.errors=["Vertex shader failed to compile"].concat(this._vertexShader.errors),wr(this.errors);return}if(!this._fragmentShader.compiled){this.errors=["Fragment shader failed to compile"].concat(this._fragmentShader.errors),wr(this.errors);return}this.compiled=!0;let i,s,t,o,n;if(this.handle=e.createProgram(),!this.handle){this.errors=["Failed to allocate program"];return}if(e.attachShader(this.handle,this._vertexShader.handle),e.attachShader(this.handle,this._fragmentShader.handle),e.linkProgram(this.handle),this.linked=e.getProgramParameter(this.handle,e.LINK_STATUS),this.validated=!0,!this.linked||!this.validated){this.errors=[],this.errors.push(""),this.errors.push(e.getProgramInfoLog(this.handle)),this.errors.push(`
Vertex shader:
`),this.errors=this.errors.concat(this.source.vertex),this.errors.push(`
Fragment shader:
`),this.errors=this.errors.concat(this.source.fragment),wr(this.errors);return}const a=e.getProgramParameter(this.handle,e.ACTIVE_UNIFORMS);for(s=0;s<a;++s)t=e.getActiveUniform(this.handle,s),t&&(o=t.name,o[o.length-1]==="\0"&&(o=o.substr(0,o.length-1)),n=e.getUniformLocation(this.handle,o),t.type===e.SAMPLER_2D||t.type===e.SAMPLER_CUBE||t.type===35682?this.samplers[o]=new pc(e,n):e instanceof WebGL2RenderingContext&&(t.type===e.UNSIGNED_INT_SAMPLER_2D||t.type===e.INT_SAMPLER_2D)?this.samplers[o]=new pc(e,n):this.uniforms[o]=n);const A=e.getProgramParameter(this.handle,e.ACTIVE_ATTRIBUTES);for(s=0;s<A;s++)i=e.getActiveAttrib(this.handle,s),i&&(n=e.getAttribLocation(this.handle,i.name),this.attributes[i.name]=new vm(e,n));this.allocated=!0}bind(){this.allocated&&this.gl.useProgram(this.handle)}getLocation(e){if(this.allocated)return this.uniforms[e]}getAttribute(e){if(this.allocated)return this.attributes[e]}bindTexture(e,i,s){if(!this.allocated)return!1;const t=this.samplers[e];return t?t.bindTexture(i,s):!1}destroy(){this.allocated&&(fc.removeItem(this.id),this.gl.deleteProgram(this.handle),this.gl.deleteShader(this._vertexShader.handle),this.gl.deleteShader(this._fragmentShader.handle),this.handle=null,this.attributes=null,this.uniforms=null,this.samplers=null,this.allocated=!1)}}class Ee{constructor(e,i,s,t,o,n,a,A,l){switch(this._gl=e,this.type=i,this.allocated=!1,s.constructor){case Uint8Array:this.itemType=e.UNSIGNED_BYTE,this.itemByteSize=1;break;case Int8Array:this.itemType=e.BYTE,this.itemByteSize=1;break;case Uint16Array:this.itemType=e.UNSIGNED_SHORT,this.itemByteSize=2;break;case Int16Array:this.itemType=e.SHORT,this.itemByteSize=2;break;case Uint32Array:this.itemType=e.UNSIGNED_INT,this.itemByteSize=4;break;case Int32Array:this.itemType=e.INT,this.itemByteSize=4;break;default:this.itemType=e.FLOAT,this.itemByteSize=4}this.usage=n,this.length=0,this.dataLength=t,this.numItems=0,this.itemSize=o,this.normalized=!!a,this.stride=A||0,this.offset=l||0,this._allocate(s)}_allocate(e){if(this.allocated=!1,this._handle=this._gl.createBuffer(),!this._handle)throw"Failed to allocate WebGL ArrayBuffer";this._handle&&(this._gl.bindBuffer(this.type,this._handle),this._gl.bufferData(this.type,e.length>this.dataLength?e.slice(0,this.dataLength):e,this.usage),this._gl.bindBuffer(this.type,null),this.length=e.length,this.numItems=this.length/this.itemSize,this.allocated=!0)}setData(e,i){this.allocated&&(e.length+(i||0)>this.length?(this.destroy(),this._allocate(e)):(this._gl.bindBuffer(this.type,this._handle),i||i===0?this._gl.bufferSubData(this.type,i*this.itemByteSize,e):this._gl.bufferData(this.type,e,this.usage),this._gl.bindBuffer(this.type,null)))}bind(){this.allocated&&this._gl.bindBuffer(this.type,this._handle)}unbind(){this.allocated&&this._gl.bindBuffer(this.type,null)}destroy(){this.allocated&&(this._gl.deleteBuffer(this._handle),this._handle=null,this.allocated=!1)}}class mc{constructor(e,i){this.scene=e,this.aabb=c.AABB3(),this.origin=c.vec3(i),this.originHash=this.origin.join(),this.numMarkers=0,this.markers={},this.markerList=[],this.markerIndices={},this.positions=[],this.indices=[],this.positionsBuf=null,this.lenPositionsBuf=0,this.indicesBuf=null,this.sectionPlanesActive=[],this.culledBySectionPlanes=!1,this.occlusionTestList=[],this.lenOcclusionTestList=0,this.pixels=[],this.aabbDirty=!1,this.markerListDirty=!1,this.positionsDirty=!0,this.occlusionTestListDirty=!1}addMarker(e){this.markers[e.id]=e,this.markerListDirty=!0,this.numMarkers++}markerWorldPosUpdated(e){if(!this.markers[e.id])return;const i=this.markerIndices[e.id];this.positions[i*3+0]=e.worldPos[0],this.positions[i*3+1]=e.worldPos[1],this.positions[i*3+2]=e.worldPos[2],this.positionsDirty=!0}removeMarker(e){delete this.markers[e.id],this.markerListDirty=!0,this.numMarkers--}update(){this.markerListDirty&&(this._buildMarkerList(),this.markerListDirty=!1,this.positionsDirty=!0,this.occlusionTestListDirty=!0),this.positionsDirty&&(this._buildPositions(),this.positionsDirty=!1,this.aabbDirty=!0,this.vbosDirty=!0),this.aabbDirty&&(this._buildAABB(),this.aabbDirty=!1),this.vbosDirty&&(this._buildVBOs(),this.vbosDirty=!1),this.occlusionTestListDirty&&this._buildOcclusionTestList(),this._updateActiveSectionPlanes()}_buildMarkerList(){this.numMarkers=0;for(var e in this.markers)this.markers.hasOwnProperty(e)&&(this.markerList[this.numMarkers]=this.markers[e],this.markerIndices[e]=this.numMarkers,this.numMarkers++);this.markerList.length=this.numMarkers}_buildPositions(){let e=0;for(let i=0;i<this.numMarkers;i++)if(this.markerList[i]){const t=this.markerList[i].worldPos;this.positions[e++]=t[0],this.positions[e++]=t[1],this.positions[e++]=t[2],this.indices[i]=i}this.positions.length=this.numMarkers*3,this.indices.length=this.numMarkers}_buildAABB(){const e=this.aabb;c.collapseAABB3(e),c.expandAABB3Points3(e,this.positions);const i=this.origin;e[0]+=i[0],e[1]+=i[1],e[2]+=i[2],e[3]+=i[0],e[4]+=i[1],e[5]+=i[2]}_buildVBOs(){if(this.positionsBuf){if(this.lenPositionsBuf===this.positions.length){this.positionsBuf.setData(this.positions);return}this.positionsBuf.destroy(),this.positionsBuf=null,this.indicesBuf.destroy(),this.indicesBuf=null}const e=this.scene.canvas.gl,i=this.numMarkers*3,s=this.numMarkers;this.positionsBuf=new Ee(e,e.ARRAY_BUFFER,new Float32Array(this.positions),i,3,e.STATIC_DRAW),this.indicesBuf=new Ee(e,e.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),s,1,e.STATIC_DRAW),this.lenPositionsBuf=this.positions.length}_buildOcclusionTestList(){const e=this.scene.canvas,i=this.scene.camera.perspective.near,s=e.boundary,t=s[2],o=s[3];let n=0;this.lenOcclusionTestList=0;for(let a=0;a<this.numMarkers;a++){const A=this.markerList[a];if(A.viewPos[2]>-i){A._setVisible(!1);continue}const h=A.canvasPos,d=h[0],f=h[1];if(d+10<0||f+10<0||d-10>t||f-10>o){A._setVisible(!1);continue}if(A.entity&&!A.entity.visible){A._setVisible(!1);continue}if(A.occludable){this.occlusionTestList[this.lenOcclusionTestList++]=A,this.pixels[n++]=d,this.pixels[n++]=f;continue}A._setVisible(!0)}}_updateActiveSectionPlanes(){const e=this.scene._sectionPlanesState.sectionPlanes,i=e.length;if(i>0)for(let s=0;s<i;s++){const t=e[s];if(!t.active)this.sectionPlanesActive[s]=!1;else{const o=c.planeAABB3Intersect(t.dir,t.dist,this.aabb);if(o===-1){this.culledBySectionPlanes=!0;return}const a=o===0;this.sectionPlanesActive[s]=a}}this.culledBySectionPlanes=!1}destroy(){this.markers={},this.markerList.length=0,this.positionsBuf&&this.positionsBuf.destroy(),this.indicesBuf&&this.indicesBuf.destroy()}}const ma=c.vec3([1,0,0]),Pm=20,Bm=-.001,ym=c.vec3();class xm{constructor(e,i){this._scene=e,this._renderBufferManager=i,this._occlusionLayers={},this._occlusionLayersList=[],this._occlusionLayersListDirty=!1,this._shaderSource=null,this._program=null,this._shaderSourceHash=null,this._shaderSourceDirty=!0,this._programDirty=!1,this._markersToOcclusionLayersMap={},this._onCameraViewMatrix=e.camera.on("viewMatrix",()=>{this._occlusionTestListDirty=!0}),this._onCameraProjMatrix=e.camera.on("projMatrix",()=>{this._occlusionTestListDirty=!0}),this._onCanvasBoundary=e.canvas.on("boundary",()=>{this._occlusionTestListDirty=!0})}addMarker(e){const i=e.origin.join();let s=this._occlusionLayers[i];s||(s=new mc(this._scene,e.origin),this._occlusionLayers[s.originHash]=s,this._occlusionLayersListDirty=!0),s.addMarker(e),this._markersToOcclusionLayersMap[e.id]=s,this._occlusionTestListDirty=!0}markerWorldPosUpdated(e){const i=this._markersToOcclusionLayersMap[e.id];if(!i)return;const s=e.origin.join();if(s!==i.originHash){i.numMarkers===1?(i.destroy(),delete this._occlusionLayers[i.originHash],this._occlusionLayersListDirty=!0):i.removeMarker(e);let t=this._occlusionLayers[s];t||(t=new mc(this._scene,e.origin),this._occlusionLayers[s]=i,this._occlusionLayersListDirty=!0),t.addMarker(e),this._markersToOcclusionLayersMap[e.id]=t}else i.markerWorldPosUpdated(e)}removeMarker(e){const i=e.origin.join();let s=this._occlusionLayers[i];s&&(s.numMarkers===1?(s.destroy(),delete this._occlusionLayers[s.originHash],this._occlusionLayersListDirty=!0):s.removeMarker(e),delete this._markersToOcclusionLayersMap[e.id])}get needOcclusionTest(){return this._occlusionTestListDirty}bindRenderBuf(){const e=[this._scene.canvas.canvas.id,this._scene._sectionPlanesState.getHash()].join(";");if(e!==this._shaderSourceHash&&(this._shaderSourceHash=e,this._shaderSourceDirty=!0),this._shaderSourceDirty&&(this._buildShaderSource(),this._shaderSourceDirty=!1,this._programDirty=!0),this._programDirty&&(this._buildProgram(),this._programDirty=!1,this._occlusionTestListDirty=!0),this._occlusionLayersListDirty&&(this._buildOcclusionLayersList(),this._occlusionLayersListDirty=!1),this._occlusionTestListDirty){for(let i=0,s=this._occlusionLayersList.length;i<s;i++){const t=this._occlusionLayersList[i];t.occlusionTestListDirty=!0}this._occlusionTestListDirty=!1}this._readPixelBuf=this._renderBufferManager.getRenderBuffer("occlusionReadPix"),this._readPixelBuf.bind(),this._readPixelBuf.clear()}_buildOcclusionLayersList(){let e=0;for(let i in this._occlusionLayers)this._occlusionLayers.hasOwnProperty(i)&&(this._occlusionLayersList[e++]=this._occlusionLayers[i]);this._occlusionLayersList.length=e}_buildShaderSource(){this._shaderSource={vertex:this._buildVertexShaderSource(),fragment:this._buildFragmentShaderSource()}}_buildVertexShaderSource(){const e=this._scene,i=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// OcclusionTester vertex shader"),s.push("in vec3 position;"),s.push("uniform mat4 modelMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),i&&s.push("out vec4 vWorldPosition;"),s.push("void main(void) {"),s.push("vec4 worldPosition = vec4(position, 1.0); "),s.push("   vec4 viewPosition = viewMatrix * worldPosition;"),i&&s.push("   vWorldPosition = worldPosition;"),s.push("   vec4 clipPos = projMatrix * viewPosition;"),s.push("   gl_PointSize = "+Pm+".0;"),e.logarithmicDepthBufferEnabled?s.push("vFragDepth = 1.0 + clipPos.w;"):s.push("clipPos.z += "+Bm+";"),s.push("   gl_Position = clipPos;"),s.push("}"),s}_buildFragmentShaderSource(){const e=this._scene,i=e._sectionPlanesState,s=i.sectionPlanes.length>0,t=[];if(t.push("#version 300 es"),t.push("// OcclusionTester fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),s){t.push("in vec4 vWorldPosition;");for(let n=0;n<i.sectionPlanes.length;n++)t.push("uniform bool sectionPlaneActive"+n+";"),t.push("uniform vec3 sectionPlanePos"+n+";"),t.push("uniform vec3 sectionPlaneDir"+n+";")}if(t.push("out vec4 outColor;"),t.push("void main(void) {"),s){t.push("  float dist = 0.0;");for(var o=0;o<i.sectionPlanes.length;o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("  if (dist > 0.0) { discard; }")}return e.logarithmicDepthBufferEnabled&&t.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("   outColor = vec4(1.0, 0.0, 0.0, 1.0); "),t.push("}"),t}_buildProgram(){this._program&&this._program.destroy();const e=this._scene,i=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new It(i,this._shaderSource),this._program.errors){this.errors=this._program.errors;return}const t=this._program;this._uViewMatrix=t.getLocation("viewMatrix"),this._uProjMatrix=t.getLocation("projMatrix"),this._uSectionPlanes=[];const o=s.sectionPlanes;for(let n=0,a=o.length;n<a;n++)this._uSectionPlanes.push({active:t.getLocation("sectionPlaneActive"+n),pos:t.getLocation("sectionPlanePos"+n),dir:t.getLocation("sectionPlaneDir"+n)});this._aPosition=t.getAttribute("position"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=t.getLocation("logDepthBufFC"))}drawMarkers(){const e=this._scene,i=e.canvas.gl,s=this._program,t=e._sectionPlanesState,o=e.camera,n=e.camera.project;if(s.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,o._project._state.matrix),e.logarithmicDepthBufferEnabled){const a=2/(Math.log(n.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,a)}for(let a=0,A=this._occlusionLayersList.length;a<A;a++){const l=this._occlusionLayersList[a];if(l.update(),l.culledBySectionPlanes)continue;const h=l.origin;i.uniformMatrix4fv(this._uViewMatrix,!1,ft(o.viewMatrix,h));const d=t.sectionPlanes.length;if(d>0){const m=t.sectionPlanes;for(let _=0;_<d;_++){const u=this._uSectionPlanes[_];if(u){const P=l.sectionPlanesActive[_];if(i.uniform1i(u.active,P?1:0),P){const y=m[_];i.uniform3fv(u.pos,Ut(y.dist,y.dir,h,ym)),i.uniform3fv(u.dir,y.dir)}}}}this._aPosition.bindArrayBuffer(l.positionsBuf);const f=l.indicesBuf;f.bind(),i.drawElements(i.POINTS,f.numItems,f.itemType,0)}}doOcclusionTest(){{const e=this._scene.canvas.resolutionScale,i=ma[0]*255,s=ma[1]*255,t=ma[2]*255;for(let o=0,n=this._occlusionLayersList.length;o<n;o++){const a=this._occlusionLayersList[o];for(let A=0;A<a.lenOcclusionTestList;A++){const l=a.occlusionTestList[A],h=A*2,d=this._readPixelBuf.read(Math.round(a.pixels[h]*e),Math.round(a.pixels[h+1]*e)),f=d[0]===i&&d[1]===s&&d[2]===t;l._setVisible(f)}}}}unbindRenderBuf(){this._readPixelBuf.unbind()}destroy(){if(!this.destroyed){for(let e=0,i=this._occlusionLayersList.length;e<i;e++)this._occlusionLayersList[e].destroy();this._program&&this._program.destroy(),this._scene.camera.off(this._onCameraViewMatrix),this._scene.camera.off(this._onCameraProjMatrix),this._scene.canvas.off(this._onCanvasBoundary),this.destroyed=!0}}}const _a=c.vec2();class wm{constructor(e){this._scene=e,this._numSamples=null,this._program=null,this._programError=!1,this._aPosition=null,this._aUV=null,this._uDepthTexture="uDepthTexture",this._uCameraNear=null,this._uCameraFar=null,this._uCameraProjectionMatrix=null,this._uCameraInverseProjectionMatrix=null,this._uScale=null,this._uIntensity=null,this._uBias=null,this._uKernelRadius=null,this._uMinResolution=null,this._uRandomSeed=null,this._uvBuf=null,this._positionsBuf=null,this._indicesBuf=null}render(e){if(this._build(),this._programError)return;this._getInverseProjectMat||(this._getInverseProjectMat=(()=>{let P=!0;this._scene.camera.on("projMatrix",function(){P=!0});const y=c.mat4();return()=>(P&&c.inverseMat4(t.camera.projMatrix,y),y)})());const i=this._scene.canvas.gl,s=this._program,t=this._scene,o=t.sao,n=i.drawingBufferWidth,a=i.drawingBufferHeight,A=t.camera.project._state,l=A.near,h=A.far,d=A.matrix,f=this._getInverseProjectMat(),m=Math.random(),_=t.camera.projection==="perspective";_a[0]=n,_a[1]=a,i.viewport(0,0,n,a),i.clearColor(0,0,0,1),i.disable(i.DEPTH_TEST),i.disable(i.BLEND),i.frontFace(i.CCW),i.clear(i.COLOR_BUFFER_BIT),s.bind(),i.uniform1f(this._uCameraNear,l),i.uniform1f(this._uCameraFar,h),i.uniformMatrix4fv(this._uCameraProjectionMatrix,!1,d),i.uniformMatrix4fv(this._uCameraInverseProjectionMatrix,!1,f),i.uniform1i(this._uPerspective,_),i.uniform1f(this._uScale,o.scale*(h/5)),i.uniform1f(this._uIntensity,o.intensity),i.uniform1f(this._uBias,o.bias),i.uniform1f(this._uKernelRadius,o.kernelRadius),i.uniform1f(this._uMinResolution,o.minResolution),i.uniform2fv(this._uViewport,_a),i.uniform1f(this._uRandomSeed,m);const u=e.getDepthTexture();s.bindTexture(this._uDepthTexture,u,0),this._aUV.bindArrayBuffer(this._uvBuf),this._aPosition.bindArrayBuffer(this._positionsBuf),this._indicesBuf.bind(),i.drawElements(i.TRIANGLES,this._indicesBuf.numItems,this._indicesBuf.itemType,0)}_build(){let e=!1;const i=this._scene.sao;if(i.numSamples!==this._numSamples&&(this._numSamples=Math.floor(i.numSamples),e=!0),!e)return;const s=this._scene.canvas.gl;if(this._program&&(this._program.destroy(),this._program=null),this._program=new It(s,{vertex:[`#version 300 es
                    precision highp float;
                    precision highp int;
                    
                    in vec3 aPosition;
                    in vec2 aUV;            
                    
                    out vec2 vUV;
                    
                    void main () {
                        gl_Position = vec4(aPosition, 1.0);
                        vUV = aUV;
                    }`],fragment:[`#version 300 es      
                precision highp float;
                precision highp int;           
                
                #define NORMAL_TEXTURE 0
                #define PI 3.14159265359
                #define PI2 6.28318530718
                #define EPSILON 1e-6
                #define NUM_SAMPLES ${this._numSamples}
                #define NUM_RINGS 4              
            
                in vec2        vUV;
            
                uniform sampler2D   uDepthTexture;
               
                uniform float       uCameraNear;
                uniform float       uCameraFar;
                uniform mat4        uProjectMatrix;
                uniform mat4        uInverseProjectMatrix;
                
                uniform bool        uPerspective;

                uniform float       uScale;
                uniform float       uIntensity;
                uniform float       uBias;
                uniform float       uKernelRadius;
                uniform float       uMinResolution;
                uniform vec2        uViewport;
                uniform float       uRandomSeed;

                float pow2( const in float x ) { return x*x; }
                
                highp float rand( const in vec2 uv ) {
                    const highp float a = 12.9898, b = 78.233, c = 43758.5453;
                    highp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );
                    return fract(sin(sn) * c);
                }

                vec3 packNormalToRGB( const in vec3 normal ) {
                    return normalize( normal ) * 0.5 + 0.5;
                }

                vec3 unpackRGBToNormal( const in vec3 rgb ) {
                    return 2.0 * rgb.xyz - 1.0;
                }

                const float packUpscale = 256. / 255.;
                const float unpackDownScale = 255. / 256.; 

                const vec3 packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );
                const vec4 unPackFactors = unpackDownScale / vec4( packFactors, 1. );   

                const float shiftRights = 1. / 256.;

                vec4 packFloatToRGBA( const in float v ) {
                    vec4 r = vec4( fract( v * packFactors ), v );
                    r.yzw -= r.xyz * shiftRights; 
                    return r * packUpscale;
                }

                float unpackRGBAToFloat( const in vec4 v ) {                   
                    return dot( floor( v * 255.0 + 0.5 ) / 255.0, unPackFactors );
                }
                
                float perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {
                    return ( near * far ) / ( ( far - near ) * invClipZ - far );
                }

                float orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {
                    return linearClipZ * ( near - far ) - near;
                }
                
                float getDepth( const in vec2 screenPosition ) {
                    return vec4(texture(uDepthTexture, screenPosition)).r;
                }

                float getViewZ( const in float depth ) {
                     if (uPerspective) {
                         return perspectiveDepthToViewZ( depth, uCameraNear, uCameraFar );
                     } else {
                        return orthographicDepthToViewZ( depth, uCameraNear, uCameraFar );
                     }
                }

                vec3 getViewPos( const in vec2 screenPos, const in float depth, const in float viewZ ) {
                	float clipW = uProjectMatrix[2][3] * viewZ + uProjectMatrix[3][3];
                	vec4 clipPosition = vec4( ( vec3( screenPos, depth ) - 0.5 ) * 2.0, 1.0 );
                	clipPosition *= clipW; 
                	return ( uInverseProjectMatrix * clipPosition ).xyz;
                }

                vec3 getViewNormal( const in vec3 viewPosition, const in vec2 screenPos ) {               
                    return normalize( cross( dFdx( viewPosition ), dFdy( viewPosition ) ) );
                }

                float scaleDividedByCameraFar;
                float minResolutionMultipliedByCameraFar;

                float getOcclusion( const in vec3 centerViewPosition, const in vec3 centerViewNormal, const in vec3 sampleViewPosition ) {
                	vec3 viewDelta = sampleViewPosition - centerViewPosition;
                	float viewDistance = length( viewDelta );
                	float scaledScreenDistance = scaleDividedByCameraFar * viewDistance;
                	return max(0.0, (dot(centerViewNormal, viewDelta) - minResolutionMultipliedByCameraFar) / scaledScreenDistance - uBias) / (1.0 + pow2( scaledScreenDistance ) );
                }

                const float ANGLE_STEP = PI2 * float( NUM_RINGS ) / float( NUM_SAMPLES );
                const float INV_NUM_SAMPLES = 1.0 / float( NUM_SAMPLES );

                float getAmbientOcclusion( const in vec3 centerViewPosition ) {
            
                	scaleDividedByCameraFar = uScale / uCameraFar;
                	minResolutionMultipliedByCameraFar = uMinResolution * uCameraFar;
                	vec3 centerViewNormal = getViewNormal( centerViewPosition, vUV );

                	float angle = rand( vUV + uRandomSeed ) * PI2;
                	vec2 radius = vec2( uKernelRadius * INV_NUM_SAMPLES ) / uViewport;
                	vec2 radiusStep = radius;

                	float occlusionSum = 0.0;
                	float weightSum = 0.0;

                	for( int i = 0; i < NUM_SAMPLES; i ++ ) {
                		vec2 sampleUv = vUV + vec2( cos( angle ), sin( angle ) ) * radius;
                		radius += radiusStep;
                		angle += ANGLE_STEP;

                		float sampleDepth = getDepth( sampleUv );
                		if( sampleDepth >= ( 1.0 - EPSILON ) ) {
                			continue;
                		}

                		float sampleViewZ = getViewZ( sampleDepth );
                		vec3 sampleViewPosition = getViewPos( sampleUv, sampleDepth, sampleViewZ );
                		occlusionSum += getOcclusion( centerViewPosition, centerViewNormal, sampleViewPosition );
                		weightSum += 1.0;
                	}

                	if( weightSum == 0.0 ) discard;

                	return occlusionSum * ( uIntensity / weightSum );
                }

                out vec4 outColor;
   
                void main() {
                
                	float centerDepth = getDepth( vUV );
                	
                	if( centerDepth >= ( 1.0 - EPSILON ) ) {
                		discard;
                	}

                	float centerViewZ = getViewZ( centerDepth );
                	vec3 viewPosition = getViewPos( vUV, centerDepth, centerViewZ );

                	float ambientOcclusion = getAmbientOcclusion( viewPosition );
                
                	outColor = packFloatToRGBA(  1.0- ambientOcclusion );
                }`]}),this._program.errors){console.error(this._program.errors.join(`
`)),this._programError=!0;return}const t=new Float32Array([1,1,0,1,0,0,1,0]),o=new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),n=new Uint32Array([0,1,2,0,2,3]);this._positionsBuf=new Ee(s,s.ARRAY_BUFFER,o,o.length,3,s.STATIC_DRAW),this._uvBuf=new Ee(s,s.ARRAY_BUFFER,t,t.length,2,s.STATIC_DRAW),this._indicesBuf=new Ee(s,s.ELEMENT_ARRAY_BUFFER,n,n.length,1,s.STATIC_DRAW),this._program.bind(),this._uCameraNear=this._program.getLocation("uCameraNear"),this._uCameraFar=this._program.getLocation("uCameraFar"),this._uCameraProjectionMatrix=this._program.getLocation("uProjectMatrix"),this._uCameraInverseProjectionMatrix=this._program.getLocation("uInverseProjectMatrix"),this._uPerspective=this._program.getLocation("uPerspective"),this._uScale=this._program.getLocation("uScale"),this._uIntensity=this._program.getLocation("uIntensity"),this._uBias=this._program.getLocation("uBias"),this._uKernelRadius=this._program.getLocation("uKernelRadius"),this._uMinResolution=this._program.getLocation("uMinResolution"),this._uViewport=this._program.getLocation("uViewport"),this._uRandomSeed=this._program.getLocation("uRandomSeed"),this._aPosition=this._program.getAttribute("aPosition"),this._aUV=this._program.getAttribute("aUV"),this._dirty=!1}destroy(){this._program&&(this._program.destroy(),this._program=null)}}const bm=4,Cm=.01,Kn=16,Em=new Float32Array(cp(Kn+1,[0,1])),Im=new Float32Array(cp(Kn+1,[1,0])),Fm=new Float32Array(Sm(Kn+1,bm)),va=new Float32Array(2);class Mm{constructor(e){this._scene=e,this._program=null,this._programError=!1,this._aPosition=null,this._aUV=null,this._uDepthTexture="uDepthTexture",this._uOcclusionTexture="uOcclusionTexture",this._uViewport=null,this._uCameraNear=null,this._uCameraFar=null,this._uCameraProjectionMatrix=null,this._uCameraInverseProjectionMatrix=null,this._uvBuf=null,this._positionsBuf=null,this._indicesBuf=null,this.init()}init(){const e=this._scene.canvas.gl;if(this._program=new It(e,{vertex:[`#version 300 es
                precision highp float;
                precision highp int;
                    
                in vec3 aPosition;
                in vec2 aUV;
                uniform vec2 uViewport;
                out vec2 vUV;
                out vec2 vInvSize;
                void main () {
                    vUV = aUV;
                    vInvSize = 1.0 / uViewport;
                    gl_Position = vec4(aPosition, 1.0);
                }`],fragment:[`#version 300 es
                precision highp float;
                precision highp int;
                    
                #define PI 3.14159265359
                #define PI2 6.28318530718
                #define EPSILON 1e-6

                #define KERNEL_RADIUS ${Kn}

                in vec2        vUV;
                in vec2        vInvSize;
            
                uniform sampler2D   uDepthTexture;
                uniform sampler2D   uOcclusionTexture;              
               
                uniform float       uCameraNear;
                uniform float       uCameraFar;               
                uniform float       uDepthCutoff;

                uniform vec2        uSampleOffsets[ KERNEL_RADIUS + 1 ];
                uniform float       uSampleWeights[ KERNEL_RADIUS + 1 ];

                const float         unpackDownscale = 255. / 256.; 

                const vec3          packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );
                const vec4          unpackFactors = unpackDownscale / vec4( packFactors, 1. );   

                const float packUpscale = 256. / 255.;
       
                const float shiftRights = 1. / 256.;
                
                float unpackRGBAToFloat( const in vec4 v ) {
                    return dot( floor( v * 255.0 + 0.5 ) / 255.0, unpackFactors );
                }               

                vec4 packFloatToRGBA( const in float v ) {
                    vec4 r = vec4( fract( v * packFactors ), v );
                    r.yzw -= r.xyz * shiftRights; 
                    return r * packUpscale;
                }

                float viewZToOrthographicDepth( const in float viewZ) {
                    return ( viewZ + uCameraNear ) / ( uCameraNear - uCameraFar );
                }
              
                float orthographicDepthToViewZ( const in float linearClipZ) {
                    return linearClipZ * ( uCameraNear - uCameraFar ) - uCameraNear;
                }

                float viewZToPerspectiveDepth( const in float viewZ) {
                    return (( uCameraNear + viewZ ) * uCameraFar ) / (( uCameraFar - uCameraNear ) * viewZ );
                }
                
                float perspectiveDepthToViewZ( const in float invClipZ) {
                    return ( uCameraNear * uCameraFar ) / ( ( uCameraFar - uCameraNear ) * invClipZ - uCameraFar );
                }

                float getDepth( const in vec2 screenPosition ) {
                    return vec4(texture(uDepthTexture, screenPosition)).r;
                }

                float getViewZ( const in float depth ) {
                     return perspectiveDepthToViewZ( depth );
                }

                out vec4 outColor;
        
                void main() {
                
                    float depth = getDepth( vUV );
                    if( depth >= ( 1.0 - EPSILON ) ) {
                        discard;
                    }

                    float centerViewZ = -getViewZ( depth );
                    bool rBreak = false;
                    bool lBreak = false;

                    float weightSum = uSampleWeights[0];
                    float occlusionSum = unpackRGBAToFloat(texture( uOcclusionTexture, vUV )) * weightSum;

                    for( int i = 1; i <= KERNEL_RADIUS; i ++ ) {

                        float sampleWeight = uSampleWeights[i];
                        vec2 sampleUVOffset = uSampleOffsets[i] * vInvSize;

                        vec2 sampleUV = vUV + sampleUVOffset;
                        float viewZ = -getViewZ( getDepth( sampleUV ) );

                        if( abs( viewZ - centerViewZ ) > uDepthCutoff ) {
                            rBreak = true;
                        }

                        if( ! rBreak ) {
                            occlusionSum += unpackRGBAToFloat(texture( uOcclusionTexture, sampleUV )) * sampleWeight;
                            weightSum += sampleWeight;
                        }

                        sampleUV = vUV - sampleUVOffset;
                        viewZ = -getViewZ( getDepth( sampleUV ) );

                        if( abs( viewZ - centerViewZ ) > uDepthCutoff ) {
                            lBreak = true;
                        }

                        if( ! lBreak ) {
                            occlusionSum += unpackRGBAToFloat(texture( uOcclusionTexture, sampleUV )) * sampleWeight;
                            weightSum += sampleWeight;
                        }
                    }

                    outColor = packFloatToRGBA(occlusionSum / weightSum);
                }`]}),this._program.errors){console.error(this._program.errors.join(`
`)),this._programError=!0;return}const i=new Float32Array([1,1,0,1,0,0,1,0]),s=new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),t=new Uint32Array([0,1,2,0,2,3]);this._positionsBuf=new Ee(e,e.ARRAY_BUFFER,s,s.length,3,e.STATIC_DRAW),this._uvBuf=new Ee(e,e.ARRAY_BUFFER,i,i.length,2,e.STATIC_DRAW),this._indicesBuf=new Ee(e,e.ELEMENT_ARRAY_BUFFER,t,t.length,1,e.STATIC_DRAW),this._program.bind(),this._uViewport=this._program.getLocation("uViewport"),this._uCameraNear=this._program.getLocation("uCameraNear"),this._uCameraFar=this._program.getLocation("uCameraFar"),this._uDepthCutoff=this._program.getLocation("uDepthCutoff"),this._uSampleOffsets=e.getUniformLocation(this._program.handle,"uSampleOffsets"),this._uSampleWeights=e.getUniformLocation(this._program.handle,"uSampleWeights"),this._aPosition=this._program.getAttribute("aPosition"),this._aUV=this._program.getAttribute("aUV")}render(e,i,s){if(this._programError)return;this._getInverseProjectMat||(this._getInverseProjectMat=(()=>{let _=!0;this._scene.camera.on("projMatrix",function(){_=!0});const u=c.mat4();return()=>(_&&c.inverseMat4(n.camera.projMatrix,u),u)})());const t=this._scene.canvas.gl,o=this._program,n=this._scene,a=t.drawingBufferWidth,A=t.drawingBufferHeight,l=n.camera.project._state,h=l.near,d=l.far;t.viewport(0,0,a,A),t.clearColor(0,0,0,1),t.enable(t.DEPTH_TEST),t.disable(t.BLEND),t.frontFace(t.CCW),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),o.bind(),va[0]=a,va[1]=A,t.uniform2fv(this._uViewport,va),t.uniform1f(this._uCameraNear,h),t.uniform1f(this._uCameraFar,d),t.uniform1f(this._uDepthCutoff,Cm),s===0?t.uniform2fv(this._uSampleOffsets,Im):t.uniform2fv(this._uSampleOffsets,Em),t.uniform1fv(this._uSampleWeights,Fm);const f=e.getDepthTexture(),m=i.getTexture();o.bindTexture(this._uDepthTexture,f,0),o.bindTexture(this._uOcclusionTexture,m,1),this._aUV.bindArrayBuffer(this._uvBuf),this._aPosition.bindArrayBuffer(this._positionsBuf),this._indicesBuf.bind(),t.drawElements(t.TRIANGLES,this._indicesBuf.numItems,this._indicesBuf.itemType,0)}destroy(){this._program.destroy()}}function Sm(r,e){const i=[];for(let s=0;s<=r;s++)i.push(Tm(s,e));return i}function Tm(r,e){return Math.exp(-(r*r)/(2*(e*e)))/(Math.sqrt(2*Math.PI)*e)}function cp(r,e){const i=[];for(let s=0;s<=r;s++)i.push(e[0]*s),i.push(e[1]*s);return i}class hp{constructor(e,i,s){s=s||{},this.gl=i,this.allocated=!1,this.canvas=e,this.buffer=null,this.bound=!1,this.size=s.size,this._hasDepthTexture=!!s.depthTexture}setSize(e){this.size=e}webglContextRestored(e){this.gl=e,this.buffer=null,this.allocated=!1,this.bound=!1}bind(...e){if(this._touch(...e),this.bound)return;const i=this.gl;i.bindFramebuffer(i.FRAMEBUFFER,this.buffer.framebuf),this.bound=!0}createTexture(e,i,s=null){const t=this.gl,o=t.createTexture();return t.bindTexture(t.TEXTURE_2D,o),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),s?t.texStorage2D(t.TEXTURE_2D,1,s,e,i):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e,i,0,t.RGBA,t.UNSIGNED_BYTE,null),o}_touch(...e){let i,s;const t=this.gl;if(this.size?(i=this.size[0],s=this.size[1]):(i=t.drawingBufferWidth,s=t.drawingBufferHeight),this.buffer){if(this.buffer.width===i&&this.buffer.height===s)return;this.buffer.textures.forEach(h=>t.deleteTexture(h)),t.deleteFramebuffer(this.buffer.framebuf),t.deleteRenderbuffer(this.buffer.renderbuf)}const o=[];e.length>0?o.push(...e.map(h=>this.createTexture(i,s,h))):o.push(this.createTexture(i,s));let n;this._hasDepthTexture&&(n=t.createTexture(),t.bindTexture(t.TEXTURE_2D,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.DEPTH_COMPONENT32F,i,s,0,t.DEPTH_COMPONENT,t.FLOAT,null));const a=t.createRenderbuffer();t.bindRenderbuffer(t.RENDERBUFFER,a),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT32F,i,s);const A=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,A);for(let h=0;h<o.length;h++)t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+h,t.TEXTURE_2D,o[h],0);if(e.length>0&&t.drawBuffers(o.map((h,d)=>t.COLOR_ATTACHMENT0+d)),this._hasDepthTexture?t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,n,0):t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,a),t.bindTexture(t.TEXTURE_2D,null),t.bindRenderbuffer(t.RENDERBUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,A),!t.isFramebuffer(A))throw"Invalid framebuffer";t.bindFramebuffer(t.FRAMEBUFFER,null);const l=t.checkFramebufferStatus(t.FRAMEBUFFER);switch(l){case t.FRAMEBUFFER_COMPLETE:break;case t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case t.FRAMEBUFFER_UNSUPPORTED:throw"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"Incomplete framebuffer: "+l}this.buffer={framebuf:A,renderbuf:a,texture:o[0],textures:o,depthTexture:n,width:i,height:s},this.bound=!1}clear(){if(!this.bound)throw"Render buffer not bound";const e=this.gl;e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}read(e,i,s=null,t=null,o=Uint8Array,n=4,a=0){const A=e,l=this.buffer.height?this.buffer.height-i-1:this.gl.drawingBufferHeight-i,h=new o(n),d=this.gl;return d.readBuffer(d.COLOR_ATTACHMENT0+a),d.readPixels(A,l,1,1,s||d.RGBA,t||d.UNSIGNED_BYTE,h,0),h}readArray(e=null,i=null,s=Uint8Array,t=4,o=0){const n=new s(this.buffer.width*this.buffer.height*t),a=this.gl;return a.readBuffer(a.COLOR_ATTACHMENT0+o),a.readPixels(0,0,this.buffer.width,this.buffer.height,e||a.RGBA,i||a.UNSIGNED_BYTE,n,0),n}readImageAsCanvas(){const e=this.gl,i=this._getImageDataCache(),s=i.pixelData,t=i.canvas,o=i.imageData,n=i.context;e.readPixels(0,0,this.buffer.width,this.buffer.height,e.RGBA,e.UNSIGNED_BYTE,s);const a=this.buffer.width,A=this.buffer.height,l=A/2|0,h=a*4,d=new Uint8Array(a*4);for(let f=0;f<l;++f){const m=f*h,_=(A-f-1)*h;d.set(s.subarray(m,m+h)),s.copyWithin(m,_,_+h),s.set(d,_)}return o.data.set(s),n.putImageData(o,0,0),t}readImage(e){const i=this.gl,s=this._getImageDataCache(),t=s.pixelData,o=s.canvas,n=s.imageData,a=s.context,{width:A,height:l}=this.buffer;i.readPixels(0,0,A,l,i.RGBA,i.UNSIGNED_BYTE,t),n.data.set(t),a.putImageData(n,0,0),a.save(),a.globalCompositeOperation="copy",a.scale(1,-1),a.drawImage(o,0,-l,A,l),a.restore();let h=e.format||"png";return h!=="jpeg"&&h!=="png"&&h!=="bmp"&&(console.error("Unsupported image format: '"+h+"' - supported types are 'jpeg', 'bmp' and 'png' - defaulting to 'png'"),h="png"),o.toDataURL(`image/${h}`)}_getImageDataCache(e=Uint8Array,i=4){const s=this.buffer.width,t=this.buffer.height;let o=this._imageDataCache;if(o&&(o.width!==s||o.height!==t)&&(this._imageDataCache=null,o=null),!o){const n=document.createElement("canvas"),a=n.getContext("2d");n.width=s,n.height=t,o={pixelData:new e(s*t*i),canvas:n,context:a,imageData:a.createImageData(s,t),width:s,height:t},this._imageDataCache=o}return o.context.resetTransform(),o}unbind(){const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),this.bound=!1}getTexture(e=0){const i=this;return this._texture||(this._texture={renderBuffer:this,bind:function(s){return i.buffer&&i.buffer.textures[e]?(i.gl.activeTexture(i.gl["TEXTURE"+s]),i.gl.bindTexture(i.gl.TEXTURE_2D,i.buffer.textures[e]),!0):!1},unbind:function(s){i.buffer&&i.buffer.textures[e]&&(i.gl.activeTexture(i.gl["TEXTURE"+s]),i.gl.bindTexture(i.gl.TEXTURE_2D,null))}})}hasDepthTexture(){return this._hasDepthTexture}getDepthTexture(){if(!this._hasDepthTexture)return null;const e=this;return this._depthTexture||(this._dethTexture={renderBuffer:this,bind:function(i){return e.buffer&&e.buffer.depthTexture?(e.gl.activeTexture(e.gl["TEXTURE"+i]),e.gl.bindTexture(e.gl.TEXTURE_2D,e.buffer.depthTexture),!0):!1},unbind:function(i){e.buffer&&e.buffer.depthTexture&&(e.gl.activeTexture(e.gl["TEXTURE"+i]),e.gl.bindTexture(e.gl.TEXTURE_2D,null))}})}destroy(){if(this.allocated){const e=this.gl;this.buffer.textures.forEach(i=>e.deleteTexture(i)),e.deleteTexture(this.buffer.depthTexture),e.deleteFramebuffer(this.buffer.framebuf),e.deleteRenderbuffer(this.buffer.renderbuf),this.allocated=!1,this.buffer=null,this.bound=!1}this._imageDataCache=null,this._texture=null,this._depthTexture=null}}class Dm{constructor(e){this.scene=e,this._renderBuffersBasic={},this._renderBuffersScaled={}}getRenderBuffer(e,i){const s=this.scene.canvas.resolutionScale===1?this._renderBuffersBasic:this._renderBuffersScaled;let t=s[e];return t||(t=new hp(this.scene.canvas.canvas,this.scene.canvas.gl,i),s[e]=t),t}destroy(){for(let e in this._renderBuffersBasic)this._renderBuffersBasic[e].destroy();for(let e in this._renderBuffersScaled)this._renderBuffersScaled[e].destroy()}}function ai(r,e){if(r._cachedExtensions===void 0&&(r._cachedExtensions={}),r._cachedExtensions[e]!==void 0)return r._cachedExtensions[e];let i;switch(e){case"WEBGL_depth_texture":i=r.getExtension("WEBGL_depth_texture")||r.getExtension("MOZ_WEBGL_depth_texture")||r.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":i=r.getExtension("EXT_texture_filter_anisotropic")||r.getExtension("MOZ_EXT_texture_filter_anisotropic")||r.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":i=r.getExtension("WEBGL_compressed_texture_s3tc")||r.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||r.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":i=r.getExtension("WEBGL_compressed_texture_pvrtc")||r.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:i=r.getExtension(e)}return r._cachedExtensions[e]=i,i}const Rm=function(r,e){e=e||{};const i=new _m(r),s=r.canvas.canvas,t=r.canvas.gl,o=!!e.transparent,n=e.alphaDepthMask,a=new Ci({});let A={},l={},h=!0,d=!0,f=!0,m=!0,_=!0,u=!0,P=!0,y=!0;const x=new Dm(r);let B=!1;const v=new wm(r),w=new Mm(r);this.scene=r,this._occlusionTester=null,this.capabilities={astcSupported:!!ai(t,"WEBGL_compressed_texture_astc"),etc1Supported:!0,etc2Supported:!!ai(t,"WEBGL_compressed_texture_etc"),dxtSupported:!!ai(t,"WEBGL_compressed_texture_s3tc"),bptcSupported:!!ai(t,"EXT_texture_compression_bptc"),pvrtcSupported:!!(ai(t,"WEBGL_compressed_texture_pvrtc")||ai(t,"WEBKIT_WEBGL_compressed_texture_pvrtc"))},this.setTransparentEnabled=function(V){m=V,f=!0},this.setEdgesEnabled=function(V){_=V,f=!0},this.setSAOEnabled=function(V){u=V,f=!0},this.setPBREnabled=function(V){P=V,f=!0},this.setColorTextureEnabled=function(V){y=V,f=!0},this.needStateSort=function(){d=!0},this.shadowsDirty=function(){},this.imageDirty=function(){f=!0},this.webglContextLost=function(){},this.webglContextRestored=function(V){v.init(),w.init(),f=!0},this.addDrawable=function(V,Z){const L=Z.type;if(!L){console.error("Renderer#addDrawable() : drawable with ID "+V+" has no 'type' - ignoring");return}let Q=A[L];Q||(Q={type:Z.type,count:0,isStateSortable:Z.isStateSortable,stateSortCompare:Z.stateSortCompare,drawableMap:{},drawableListPreCull:[],drawableList:[]},A[L]=Q),Q.count++,Q.drawableMap[V]=Z,l[V]=Z,h=!0},this.removeDrawable=function(V){const Z=l[V];if(!Z){console.error("Renderer#removeDrawable() : drawable not found with ID "+V+" - ignoring");return}const L=Z.type,Q=A[L];--Q.count<=0?delete A[L]:delete Q.drawableMap[V],delete l[V],h=!0},this.getPickID=function(V){return a.addItem(V)},this.putPickID=function(V){a.removeItem(V)},this.clear=function(V){if(t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight),o)t.clearColor(1,1,1,1);else{const Z=r.canvas.backgroundColorFromAmbientLight?this.lights.getAmbientColorAndIntensity():r.canvas.backgroundColor;t.clearColor(Z[0],Z[1],Z[2],1)}t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)},this.needsRender=function(){return f||h||d},this.render=function(V){V=V||{},V.force&&(f=!0),C(),f&&(R(V),vt.frame.frameCount++,f=!1)};function C(){h&&(I(),h=!1,d=!0),d&&(E(),d=!1,f=!0),f&&S()}function I(){for(let V in A)if(A.hasOwnProperty(V)){const Z=A[V],L=Z.drawableMap,Q=Z.drawableListPreCull;let O=0;for(let W in L)L.hasOwnProperty(W)&&(Q[O++]=L[W]);Q.length=O}}function E(){for(let V in A)if(A.hasOwnProperty(V)){const Z=A[V];Z.isStateSortable&&Z.drawableListPreCull.sort(Z.stateSortCompare)}}function S(){for(let V in A)if(A.hasOwnProperty(V)){const Z=A[V],L=Z.drawableListPreCull,Q=Z.drawableList;let O=0;for(let W=0,X=L.length;W<X;W++){const te=L[W];te.rebuildRenderFlags(),te.renderFlags.culled||(Q[O++]=te)}Q.length=O}}function R(V){const Z=r.sao;u&&Z.possible&&D(V),G(),le(V)}function D(V){const Z=r.sao,L=x.getRenderBuffer("saoDepth",{depthTexture:!0});L.bind(),L.clear(),K(V),L.unbind();const Q=x.getRenderBuffer("saoOcclusion");if(Q.bind(),Q.clear(),v.render(L),Q.unbind(),Z.blur){const O=x.getRenderBuffer("saoOcclusion2");O.bind(),O.clear(),w.render(L,Q,0),O.unbind(),Q.bind(),Q.clear(),w.render(L,O,1),Q.unbind()}}function K(V){i.reset(),i.pass=V.pass,t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight),t.clearColor(0,0,0,0),t.enable(t.DEPTH_TEST),t.frontFace(t.CCW),t.enable(t.CULL_FACE),t.depthMask(!0),V.clear!==!1&&t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT);for(let Z in A)if(A.hasOwnProperty(Z)){const Q=A[Z].drawableList;for(let O=0,W=Q.length;O<W;O++){const X=Q[O];X.culled===!0||X.visible===!1||!X.drawDepth||!X.saoEnabled||X.renderFlags.colorOpaque&&X.drawDepth(i)}}}function G(){let V=r._lightsState.lights;for(let Z=0,L=V.length;Z<L;Z++){const Q=V[Z];Q.castsShadow&&z(Q)}}function z(V){if(!V.castsShadow)return;const L=V.getShadowRenderBuf();if(L){L.bind(),i.reset(),i.backfaces=!0,i.frontface=!0,i.shadowViewMatrix=V.getShadowViewMatrix(),i.shadowProjMatrix=V.getShadowProjMatrix(),t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight),t.clearColor(0,0,0,1),t.enable(t.DEPTH_TEST),t.disable(t.BLEND),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT);for(let Q in A)if(A.hasOwnProperty(Q)){const W=A[Q].drawableList;for(let X=0,te=W.length;X<te;X++){const se=W[X];se.visible===!1||!se.castsShadow||!se.drawShadow||se.renderFlags.colorOpaque&&se.drawShadow(i)}}L.unbind()}}function le(V){const Z=[],L=[],Q=[],O=[],W=[],X=[],te=[],se=[],ie=[],oe=[],he=[],ce=[],J=[],ee=[],ge=[],re=[],me=r._lightsState.getAmbientColorAndIntensity();if(i.reset(),i.pass=V.pass,i.withSAO=!1,i.pbrEnabled=P&&!!r.pbrEnabled,i.colorTextureEnabled=y&&!!r.colorTextureEnabled,t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight),o)t.clearColor(0,0,0,0);else{const gt=r.canvas.backgroundColorFromAmbientLight?me:r.canvas.backgroundColor;t.clearColor(gt[0],gt[1],gt[2],1)}t.enable(t.DEPTH_TEST),t.frontFace(t.CCW),t.enable(t.CULL_FACE),t.depthMask(!0),t.lineWidth(1),i.lineWidth=1;const de=r.sao.possible;if(u&&de){const gt=x.getRenderBuffer("saoOcclusion");i.occlusionTexture=gt?gt.getTexture():null}else i.occlusionTexture=null;let Y,Ue,pe;const Te=Date.now();V.clear!==!1&&t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT);let fe=0,je=0,Ae=0,De=0,Ge=0,ne=0,ke=0,ze=0,Ne=0,tt=0,$e=0,at=0,Ce=0,ot=0,Ye=0,Se=0;for(let gt in A)if(A.hasOwnProperty(gt)){const xi=A[gt].drawableList;for(Y=0,Ue=xi.length;Y<Ue;Y++){if(pe=xi[Y],pe.culled===!0||pe.visible===!1)continue;const Bt=pe.renderFlags;Bt.colorOpaque&&(u&&de&&pe.saoEnabled?Z[fe++]=pe:pe.drawColorOpaque(i)),m&&Bt.colorTransparent&&(Q[Ae++]=pe),Bt.xrayedSilhouetteTransparent&&(te[ke++]=pe),Bt.xrayedSilhouetteOpaque&&(W[Ge++]=pe),Bt.highlightedSilhouetteTransparent&&(he[$e++]=pe),Bt.highlightedSilhouetteOpaque&&(ie[Ne++]=pe),Bt.selectedSilhouetteTransparent&&(ge[Ye++]=pe),Bt.selectedSilhouetteOpaque&&(J[Ce++]=pe),pe.edges&&_&&(Bt.edgesOpaque&&(L[je++]=pe),Bt.edgesTransparent&&(O[De++]=pe),Bt.selectedEdgesTransparent&&(re[Se++]=pe),Bt.selectedEdgesOpaque&&(ee[ot++]=pe),Bt.xrayedEdgesTransparent&&(se[ze++]=pe),Bt.xrayedEdgesOpaque&&(X[ne++]=pe),Bt.highlightedEdgesTransparent&&(ce[at++]=pe),Bt.highlightedEdgesOpaque&&(oe[tt++]=pe))}}if(fe>0)for(i.withSAO=!0,Y=0;Y<fe;Y++)Z[Y].drawColorOpaque(i);if(je>0)for(Y=0;Y<je;Y++)L[Y].drawEdgesColorOpaque(i);if(Ge>0)for(Y=0;Y<Ge;Y++)W[Y].drawSilhouetteXRayed(i);if(ne>0)for(Y=0;Y<ne;Y++)X[Y].drawEdgesXRayed(i);if(ke>0||ze>0||Ae>0||De>0){if(t.enable(t.CULL_FACE),t.enable(t.BLEND),o?(t.blendEquation(t.FUNC_ADD),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA)):(t.blendEquation(t.FUNC_ADD),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA)),i.backfaces=!1,n||t.depthMask(!1),(Ae>0||De>0)&&t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),De>0)for(Y=0;Y<De;Y++)pe=O[Y],pe.drawEdgesColorTransparent(i);if(Ae>0)for(Y=0;Y<Ae;Y++)pe=Q[Y],pe.drawColorTransparent(i);if(ze>0)for(Y=0;Y<ze;Y++)se[Y].drawEdgesXRayed(i);if(ke>0)for(Y=0;Y<ke;Y++)te[Y].drawSilhouetteXRayed(i);t.disable(t.BLEND),n||t.depthMask(!0)}if(Ne>0||tt>0){if(i.lastProgramId=null,r.highlightMaterial.glowThrough&&t.clear(t.DEPTH_BUFFER_BIT),tt>0)for(Y=0;Y<tt;Y++)oe[Y].drawEdgesHighlighted(i);if(Ne>0)for(Y=0;Y<Ne;Y++)ie[Y].drawSilhouetteHighlighted(i)}if($e>0||at>0||Ne>0){if(i.lastProgramId=null,r.selectedMaterial.glowThrough&&t.clear(t.DEPTH_BUFFER_BIT),t.enable(t.BLEND),o?(t.blendEquation(t.FUNC_ADD),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA)):t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.enable(t.CULL_FACE),at>0)for(Y=0;Y<at;Y++)ce[Y].drawEdgesHighlighted(i);if($e>0)for(Y=0;Y<$e;Y++)he[Y].drawSilhouetteHighlighted(i);t.disable(t.BLEND)}if(Ce>0||ot>0){if(i.lastProgramId=null,r.selectedMaterial.glowThrough&&t.clear(t.DEPTH_BUFFER_BIT),ot>0)for(Y=0;Y<ot;Y++)ee[Y].drawEdgesSelected(i);if(Ce>0)for(Y=0;Y<Ce;Y++)J[Y].drawSilhouetteSelected(i)}if(Ye>0||Se>0){if(i.lastProgramId=null,r.selectedMaterial.glowThrough&&t.clear(t.DEPTH_BUFFER_BIT),t.enable(t.CULL_FACE),t.enable(t.BLEND),o?(t.blendEquation(t.FUNC_ADD),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA)):t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),Se>0)for(Y=0;Y<Se;Y++)re[Y].drawEdgesSelected(i);if(Ye>0)for(Y=0;Y<Ye;Y++)ge[Y].drawSilhouetteSelected(i);t.disable(t.BLEND)}const Be=Date.now(),ht=vt.frame;ht.renderTime=(Be-Te)/1e3,ht.drawElements=i.drawElements,ht.drawArrays=i.drawArrays,ht.useProgram=i.useProgram,ht.bindTexture=i.bindTexture,ht.bindArray=i.bindArray;const Mt=_t.MAX_TEXTURE_IMAGE_UNITS;for(let gt=0;gt<Mt;gt++)t.activeTexture(t.TEXTURE0+gt);t.bindTexture(t.TEXTURE_CUBE_MAP,null),t.bindTexture(t.TEXTURE_2D,null);const ut=_t.MAX_VERTEX_ATTRIBS;for(let gt=0;gt<ut;gt++)t.disableVertexAttribArray(gt)}this.pick=function(){const V=c.vec3();c.mat4();const Z=c.mat4(),L=c.vec3(),Q=c.vec3([0,1,0]),O=new UA,W=c.vec2(),X=c.vec3(),te=c.vec3(),se=c.vec3();return c.vec3(),c.vec3(),function(ie,oe=O){oe.reset(),C();let he,ce=null,J=null;oe.pickSurface=ie.pickSurface,ie.canvasPos?(X[0]=ie.canvasPos[0],X[1]=ie.canvasPos[1],ce=r.camera.viewMatrix,J=r.camera.projMatrix,oe.canvasPos=ie.canvasPos):(ie.matrix?(ce=ie.matrix,J=r.camera.projMatrix):(te.set(ie.origin||[0,0,0]),se.set(ie.direction||[0,0,1]),he=c.addVec3(te,se,V),L[0]=Math.random(),L[1]=Math.random(),L[2]=Math.random(),c.normalizeVec3(L),c.cross3Vec3(se,L,Q),ce=c.lookAtMat4v(te,he,Q,Z),J=r.camera.ortho.matrix,oe.origin=te,oe.direction=se),X[0]=s.clientWidth*.5,X[1]=s.clientHeight*.5);for(let me in A)if(A.hasOwnProperty(me)){const de=A[me].drawableList;for(let Y=0,Ue=de.length;Y<Ue;Y++){const pe=de[Y];pe.setPickMatrices&&pe.setPickMatrices(ce,J)}}const ee=x.getRenderBuffer("pick",{size:[1,1]});ee.bind();const ge=ue(ee,X,ce,J,ie,oe);if(!ge)return ee.unbind(),null;const re=ge.delegatePickedEntity?ge.delegatePickedEntity():ge;return re?(ie.pickSurface&&(ge.canPickTriangle&&ge.canPickTriangle()?(ae(ee,ge,X,ce,J,oe),ge.pickTriangleSurface(ce,J,oe),oe.pickSurfacePrecision=!1):ge.canPickWorldPos&&ge.canPickWorldPos()&&(W[0]=r.camera.project.near,W[1]=r.camera.project.far,Pe(ee,ge,X,ce,J,W,oe),ie.pickSurfaceNormal!==!1&&Ve(ee,ge,X,ce,J,oe),oe.pickSurfacePrecision=!1)),ee.unbind(),oe.entity=re,oe):(ee.unbind(),null)}}();function ue(V,Z,L,Q,O,W){const X=r.canvas.resolutionScale;i.reset(),i.backfaces=!0,i.frontface=!0,i.pickOrigin=W.origin,i.pickViewMatrix=L,i.pickProjMatrix=Q,i.pickInvisible=!!O.pickInvisible,i.pickClipPos=[Ie(Z[0]*X,t.drawingBufferWidth),Fe(Z[1]*X,t.drawingBufferHeight)],t.viewport(0,0,1,1),t.depthMask(!0),t.enable(t.DEPTH_TEST),t.disable(t.CULL_FACE),t.disable(t.BLEND),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT);const te=O.includeEntityIds,se=O.excludeEntityIds;for(let ce in A)if(A.hasOwnProperty(ce)){const ee=A[ce].drawableList;for(let ge=0,re=ee.length;ge<re;ge++){const me=ee[ge];!me.drawPickMesh||O.pickInvisible!==!0&&me.visible===!1||me.pickable===!1||te&&!te[me.id]||se&&se[me.id]||me.drawPickMesh(i)}}const ie=V.read(0,0),oe=ie[0]+(ie[1]<<8)+(ie[2]<<16)+(ie[3]<<24);return oe<0?void 0:a.items[oe]}function ae(V,Z,L,Q,O,W){if(!Z.drawPickTriangles)return;const X=r.canvas.resolutionScale;i.reset(),i.backfaces=!0,i.frontface=!0,i.pickOrigin=W.origin,i.pickViewMatrix=Q,i.pickProjMatrix=O,i.pickClipPos=[Ie(L[0]*X,t.drawingBufferWidth),Fe(L[1]*X,t.drawingBufferHeight)],t.viewport(0,0,1,1),t.clearColor(0,0,0,0),t.enable(t.DEPTH_TEST),t.disable(t.CULL_FACE),t.disable(t.BLEND),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),Z.drawPickTriangles(i);const te=V.read(0,0);let se=te[0]+te[1]*256+te[2]*256*256+te[3]*256*256*256;se*=3,W.primIndex=se}const Pe=function(){const V=c.vec4(),Z=c.vec4(),L=c.vec4(),Q=c.vec4(),O=c.vec4(),W=c.mat4(),X=c.mat4(),te=c.mat4();return function(se,ie,oe,he,ce,J,ee){const ge=r.canvas.resolutionScale;i.reset(),i.backfaces=!0,i.frontface=!0,i.pickOrigin=ee.origin,i.pickViewMatrix=he,i.pickProjMatrix=ce,i.pickZNear=J[0],i.pickZFar=J[1],i.pickElementsCount=ie.pickElementsCount,i.pickElementsOffset=ie.pickElementsOffset,i.pickClipPos=[Ie(oe[0]*ge,t.drawingBufferWidth),Fe(oe[1]*ge,t.drawingBufferHeight)],t.viewport(0,0,1,1),t.clearColor(0,0,0,0),t.depthMask(!0),t.enable(t.DEPTH_TEST),t.disable(t.CULL_FACE),t.disable(t.BLEND),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),ie.drawPickDepths(i);const re=se.read(0,0),me=Qe(re),de=(oe[0]-s.clientWidth/2)/(s.clientWidth/2),Y=-(oe[1]-s.clientHeight/2)/(s.clientHeight/2),Ue=ie.origin;let pe;if(Ue){const Ge=ft(he,Ue,W);pe=c.mulMat4(ce,Ge,X)}else pe=c.mulMat4(ce,he,X);const Te=c.inverseMat4(pe,te);V[0]=de,V[1]=Y,V[2]=-1,V[3]=1;let fe=c.transformVec4(Te,V);fe=c.mulVec4Scalar(fe,1/fe[3]),Z[0]=de,Z[1]=Y,Z[2]=1,Z[3]=1;let je=c.transformVec4(Te,Z);je=c.mulVec4Scalar(je,1/je[3]);const Ae=c.subVec3(je,fe,L),De=c.addVec3(fe,c.mulVec4Scalar(Ae,me,Q),O);Ue&&c.addVec3(De,Ue),ee.worldPos=De}}();function be(V){V.snapPickLayerParams=[],V.snapPickLayerNumber=0;for(let Z in A){const Q=A[Z].drawableList;for(let O=0,W=Q.length;O<W;O++){const X=Q[O];X.drawSnapInit&&!X.culled&&X.visible&&X.pickable&&X.drawSnapInit(V)}}return V.snapPickLayerParams}function xe(V){V.snapPickLayerParams=V.snapPickLayerParams||[],V.snapPickLayerNumber=V.snapPickLayerParams.length;for(let Z in A){const Q=A[Z].drawableList;for(let O=0,W=Q.length;O<W;O++){const X=Q[O];X.drawSnap&&!X.culled&&X.visible&&X.pickable&&X.drawSnap(V)}}return V.snapPickLayerParams}function Ie(V,Z){return 2*(V/Z)-1}function Fe(V,Z){return 1-2*(V/Z)}this.snapPick=function(){const V=new UA;return function(Z,L,Q,O,W=V){if(!Q&&!O)return this.pick({canvasPos:Z,pickSurface:!0});const X=r.canvas.resolutionScale;i.reset(),i.backfaces=!0,i.frontface=!0,i.pickZNear=r.camera.project.near,i.pickZFar=r.camera.project.far,L=L||30;const te=x.getRenderBuffer("uniquePickColors-aabs",{depthTexture:!0,size:[2*L+1,2*L+1]});i.snapVectorA=[Ie(Z[0]*X,t.drawingBufferWidth),Fe(Z[1]*X,t.drawingBufferHeight)],i.snapInvVectorAB=[t.drawingBufferWidth/(2*L),t.drawingBufferHeight/(2*L)],te.bind(t.RGBA32I,t.RGBA32I,t.RGBA8UI),t.viewport(0,0,te.size[0],te.size[1]),t.enable(t.DEPTH_TEST),t.frontFace(t.CCW),t.disable(t.CULL_FACE),t.depthMask(!0),t.disable(t.BLEND),t.depthFunc(t.LEQUAL),t.clear(t.DEPTH_BUFFER_BIT),t.clearBufferiv(t.COLOR,0,new Int32Array([0,0,0,0])),t.clearBufferiv(t.COLOR,1,new Int32Array([0,0,0,0])),t.clearBufferuiv(t.COLOR,2,new Uint32Array([0,0,0,0]));const se=r.camera.viewMatrix,ie=r.camera.projMatrix;for(let ke in A)if(A.hasOwnProperty(ke)){const ze=A[ke].drawableList;for(let Ne=0,tt=ze.length;Ne<tt;Ne++){const $e=ze[Ne];$e.setPickMatrices&&$e.setPickMatrices(se,ie)}}t.drawBuffers([t.COLOR_ATTACHMENT0,t.COLOR_ATTACHMENT1,t.COLOR_ATTACHMENT2]);const oe=be(i),he=[];i.snapPickLayerParams=he,t.depthMask(!1),t.drawBuffers([t.COLOR_ATTACHMENT0]),Q&&O?(i.snapMode="edge",xe(i),i.snapMode="vertex",i.snapPickLayerNumber++,xe(i)):(i.snapMode=Q?"vertex":"edge",xe(i)),t.depthMask(!0);const ce=te.readArray(t.RGBA_INTEGER,t.INT,Int32Array,4),J=te.readArray(t.RGBA_INTEGER,t.INT,Int32Array,4,1),ee=te.readArray(t.RGBA_INTEGER,t.UNSIGNED_INT,Uint32Array,4,2);te.unbind();let ge=null;const re=L,me=L,de=re*4+me*te.size[0]*4,Y=ce.slice(de,de+4),Ue=J.slice(de,de+4),pe=ee.slice(de,de+4);if(Y[3]!==0){const ke=oe[Math.abs(Y[3])%oe.length],ze=ke.origin,Ne=ke.coordinateScale;ge=[Y[0]*Ne[0]+ze[0],Y[1]*Ne[1]+ze[1],Y[2]*Ne[2]+ze[2]],c.normalizeVec3([Ue[0]/c.MAX_INT,Ue[1]/c.MAX_INT,Ue[2]/c.MAX_INT]);const tt=pe[0]+(pe[1]<<8)+(pe[2]<<16)+(pe[3]<<24);a.items[tt]}let Te=[];for(let ke=0;ke<ce.length;ke+=4)if(ce[ke+3]>0){const ze=Math.floor(ke/4),Ne=te.size[0],tt=ze%Ne-Math.floor(Ne/2),$e=Math.floor(ze/Ne)-Math.floor(Ne/2),at=Math.sqrt(Math.pow(tt,2)+Math.pow($e,2));Te.push({x:tt,y:$e,dist:at,isVertex:Q&&O?ce[ke+3]>he.length/2:Q,result:[ce[ke+0],ce[ke+1],ce[ke+2],ce[ke+3]],normal:[J[ke+0],J[ke+1],J[ke+2],J[ke+3]],id:[ee[ke+0],ee[ke+1],ee[ke+2],ee[ke+3]]})}let fe=null,je=null,Ae=null,De=null;if(Te.length>0){Te.sort((Ce,ot)=>Ce.isVertex!==ot.isVertex?Ce.isVertex?-1:1:Ce.dist-ot.dist),De=Te[0].isVertex?"vertex":"edge";const ke=Te[0].result,ze=Te[0].normal,Ne=Te[0].id,tt=he[ke[3]],$e=tt.origin,at=tt.coordinateScale;je=c.normalizeVec3([ze[0]/c.MAX_INT,ze[1]/c.MAX_INT,ze[2]/c.MAX_INT]),fe=[ke[0]*at[0]+$e[0],ke[1]*at[1]+$e[1],ke[2]*at[2]+$e[2]],Ae=a.items[Ne[0]+(Ne[1]<<8)+(Ne[2]<<16)+(Ne[3]<<24)]}if(ge===null&&fe==null)return null;let Ge=null;fe!==null&&(Ge=r.camera.projectWorldPos(fe));const ne=Ae&&Ae.delegatePickedEntity?Ae.delegatePickedEntity():Ae;return W.reset(),W.snappedToEdge=De==="edge",W.snappedToVertex=De==="vertex",W.worldPos=fe,W.worldNormal=je,W.entity=ne,W.canvasPos=Z,W.snappedCanvasPos=Ge||Z,W}}();function Qe(V){const Z=[V[0]/256,V[1]/256,V[2]/256,V[3]/256],L=[1/(256*256*256),1/(256*256),1/256,1];return c.dotVec4(Z,L)}function Ve(V,Z,L,Q,O,W){const X=r.canvas.resolutionScale;i.reset(),i.backfaces=!0,i.frontface=!0,i.pickOrigin=W.origin,i.pickViewMatrix=Q,i.pickProjMatrix=O,i.pickClipPos=[Ie(L[0]*X,t.drawingBufferWidth),Fe(L[1]*X,t.drawingBufferHeight)];const te=x.getRenderBuffer("pick-normal",{size:[3,3]});te.bind(t.RGBA32I),t.viewport(0,0,te.size[0],te.size[1]),t.enable(t.DEPTH_TEST),t.disable(t.CULL_FACE),t.disable(t.BLEND),t.clear(t.DEPTH_BUFFER_BIT),t.clearBufferiv(t.COLOR,0,new Int32Array([0,0,0,0])),Z.drawPickNormals(i);const se=te.read(1,1,t.RGBA_INTEGER,t.INT,Int32Array,4);te.unbind();const ie=[se[0]/c.MAX_INT,se[1]/c.MAX_INT,se[2]/c.MAX_INT];c.normalizeVec3(ie),W.worldNormal=ie}this.addMarker=function(V){this._occlusionTester=this._occlusionTester||new xm(r,x),this._occlusionTester.addMarker(V),r.occlusionTestCountdown=0},this.markerWorldPosUpdated=function(V){this._occlusionTester.markerWorldPosUpdated(V)},this.removeMarker=function(V){this._occlusionTester.removeMarker(V)},this.doOcclusionTest=function(){if(this._occlusionTester&&this._occlusionTester.needOcclusionTest){C(),this._occlusionTester.bindRenderBuf(),i.reset(),i.backfaces=!0,i.frontface=!0,t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight),t.clearColor(0,0,0,0),t.enable(t.DEPTH_TEST),t.disable(t.CULL_FACE),t.disable(t.BLEND),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT);for(let V in A)if(A.hasOwnProperty(V)){const L=A[V].drawableList;for(let Q=0,O=L.length;Q<O;Q++){const W=L[Q];!W.drawOcclusion||W.culled===!0||W.visible===!1||W.pickable===!1||W.drawOcclusion(i)}}this._occlusionTester.drawMarkers(i),this._occlusionTester.doOcclusionTest(),this._occlusionTester.unbindRenderBuf()}},this.readPixels=function(V,Z,L,Q){const O=x.getRenderBuffer("snapshot");O.bind(),O.clear(),this.render({force:!0,opaqueOnly:Q});let W,X,te,se;for(X=0;X<L;X++)te=X*2,se=X*4,W=O.read(V[te],V[te+1]),Z[se]=W[0],Z[se+1]=W[1],Z[se+2]=W[2],Z[se+3]=W[3];O.unbind(),f=!0},this.beginSnapshot=function(V={}){const Z=x.getRenderBuffer("snapshot");V.width&&V.height&&Z.setSize([V.width,V.height]),Z.bind(),Z.clear(),B=!0},this.renderSnapshot=function(){if(!B)return;x.getRenderBuffer("snapshot").clear(),this.render({force:!0,opaqueOnly:!1}),f=!0},this.readSnapshot=function(V){return x.getRenderBuffer("snapshot").readImage(V)},this.readSnapshotAsCanvas=function(){return x.getRenderBuffer("snapshot").readImageAsCanvas()},this.endSnapshot=function(){if(!B)return;x.getRenderBuffer("snapshot").unbind(),B=!1},this.destroy=function(){A={},l={},x.destroy(),v.destroy(),w.destroy(),this._occlusionTester&&this._occlusionTester.destroy()}};class Lm extends Et{constructor(e,i={}){super(e,i),this.KEY_BACKSPACE=8,this.KEY_TAB=9,this.KEY_ENTER=13,this.KEY_SHIFT=16,this.KEY_CTRL=17,this.KEY_ALT=18,this.KEY_PAUSE_BREAK=19,this.KEY_CAPS_LOCK=20,this.KEY_ESCAPE=27,this.KEY_PAGE_UP=33,this.KEY_PAGE_DOWN=34,this.KEY_END=35,this.KEY_HOME=36,this.KEY_LEFT_ARROW=37,this.KEY_UP_ARROW=38,this.KEY_RIGHT_ARROW=39,this.KEY_DOWN_ARROW=40,this.KEY_INSERT=45,this.KEY_DELETE=46,this.KEY_NUM_0=48,this.KEY_NUM_1=49,this.KEY_NUM_2=50,this.KEY_NUM_3=51,this.KEY_NUM_4=52,this.KEY_NUM_5=53,this.KEY_NUM_6=54,this.KEY_NUM_7=55,this.KEY_NUM_8=56,this.KEY_NUM_9=57,this.KEY_A=65,this.KEY_B=66,this.KEY_C=67,this.KEY_D=68,this.KEY_E=69,this.KEY_F=70,this.KEY_G=71,this.KEY_H=72,this.KEY_I=73,this.KEY_J=74,this.KEY_K=75,this.KEY_L=76,this.KEY_M=77,this.KEY_N=78,this.KEY_O=79,this.KEY_P=80,this.KEY_Q=81,this.KEY_R=82,this.KEY_S=83,this.KEY_T=84,this.KEY_U=85,this.KEY_V=86,this.KEY_W=87,this.KEY_X=88,this.KEY_Y=89,this.KEY_Z=90,this.KEY_LEFT_WINDOW=91,this.KEY_RIGHT_WINDOW=92,this.KEY_SELECT_KEY=93,this.KEY_NUMPAD_0=96,this.KEY_NUMPAD_1=97,this.KEY_NUMPAD_2=98,this.KEY_NUMPAD_3=99,this.KEY_NUMPAD_4=100,this.KEY_NUMPAD_5=101,this.KEY_NUMPAD_6=102,this.KEY_NUMPAD_7=103,this.KEY_NUMPAD_8=104,this.KEY_NUMPAD_9=105,this.KEY_MULTIPLY=106,this.KEY_ADD=107,this.KEY_SUBTRACT=109,this.KEY_DECIMAL_POINT=110,this.KEY_DIVIDE=111,this.KEY_F1=112,this.KEY_F2=113,this.KEY_F3=114,this.KEY_F4=115,this.KEY_F5=116,this.KEY_F6=117,this.KEY_F7=118,this.KEY_F8=119,this.KEY_F9=120,this.KEY_F10=121,this.KEY_F11=122,this.KEY_F12=123,this.KEY_NUM_LOCK=144,this.KEY_SCROLL_LOCK=145,this.KEY_SEMI_COLON=186,this.KEY_EQUAL_SIGN=187,this.KEY_COMMA=188,this.KEY_DASH=189,this.KEY_PERIOD=190,this.KEY_FORWARD_SLASH=191,this.KEY_GRAVE_ACCENT=192,this.KEY_OPEN_BRACKET=219,this.KEY_BACK_SLASH=220,this.KEY_CLOSE_BRACKET=221,this.KEY_SINGLE_QUOTE=222,this.KEY_SPACE=32,this.element=i.element,this.altDown=!1,this.ctrlDown=!1,this.mouseDownLeft=!1,this.mouseDownMiddle=!1,this.mouseDownRight=!1,this.keyDown=[],this.enabled=!0,this.keyboardEnabled=!0,this.mouseover=!1,this.mouseCanvasPos=c.vec2(),this._keyboardEventsElement=i.keyboardEventsElement||document,this._bindEvents()}_bindEvents(){if(this._eventsBound)return;this._keyboardEventsElement.addEventListener("keydown",this._keyDownListener=s=>{!this.enabled||!this.keyboardEnabled||s.target.tagName!=="INPUT"&&s.target.tagName!=="TEXTAREA"&&(s.keyCode===this.KEY_CTRL?this.ctrlDown=!0:s.keyCode===this.KEY_ALT?this.altDown=!0:s.keyCode===this.KEY_SHIFT&&(this.shiftDown=!0),this.keyDown[s.keyCode]=!0,this.fire("keydown",s.keyCode,!0))},!1),this._keyboardEventsElement.addEventListener("keyup",this._keyUpListener=s=>{!this.enabled||!this.keyboardEnabled||s.target.tagName!=="INPUT"&&s.target.tagName!=="TEXTAREA"&&(s.keyCode===this.KEY_CTRL?this.ctrlDown=!1:s.keyCode===this.KEY_ALT?this.altDown=!1:s.keyCode===this.KEY_SHIFT&&(this.shiftDown=!1),this.keyDown[s.keyCode]=!1,this.fire("keyup",s.keyCode,!0))}),this.element.addEventListener("mouseenter",this._mouseEnterListener=s=>{this.enabled&&(this.mouseover=!0,this._getMouseCanvasPos(s),this.fire("mouseenter",this.mouseCanvasPos,!0))}),this.element.addEventListener("mouseleave",this._mouseLeaveListener=s=>{this.enabled&&(this.mouseover=!1,this._getMouseCanvasPos(s),this.fire("mouseleave",this.mouseCanvasPos,!0))}),this.element.addEventListener("mousedown",this._mouseDownListener=s=>{if(this.enabled){switch(s.which){case 1:this.mouseDownLeft=!0;break;case 2:this.mouseDownMiddle=!0;break;case 3:this.mouseDownRight=!0;break}this._getMouseCanvasPos(s),this.element.focus(),this.fire("mousedown",this.mouseCanvasPos,!0),this.mouseover&&s.preventDefault()}}),document.addEventListener("mouseup",this._mouseUpListener=s=>{if(this.enabled){switch(s.which){case 1:this.mouseDownLeft=!1;break;case 2:this.mouseDownMiddle=!1;break;case 3:this.mouseDownRight=!1;break}this.fire("mouseup",this.mouseCanvasPos,!0)}},!0),document.addEventListener("click",this._clickListener=s=>{if(this.enabled){switch(s.which){case 1:this.mouseDownLeft=!1,this.mouseDownRight=!1;break;case 2:this.mouseDownMiddle=!1;break;case 3:this.mouseDownLeft=!1,this.mouseDownRight=!1;break}this._getMouseCanvasPos(s),this.fire("click",this.mouseCanvasPos,!0),this.mouseover&&s.preventDefault()}}),document.addEventListener("dblclick",this._dblClickListener=s=>{if(this.enabled){switch(s.which){case 1:this.mouseDownLeft=!1,this.mouseDownRight=!1;break;case 2:this.mouseDownMiddle=!1;break;case 3:this.mouseDownLeft=!1,this.mouseDownRight=!1;break}this._getMouseCanvasPos(s),this.fire("dblclick",this.mouseCanvasPos,!0),this.mouseover&&s.preventDefault()}});const e=this.scene.tickify(()=>this.fire("mousemove",this.mouseCanvasPos,!0));this.element.addEventListener("mousemove",this._mouseMoveListener=s=>{this.enabled&&(this._getMouseCanvasPos(s),e(),this.mouseover&&s.preventDefault())});const i=this.scene.tickify(s=>{this.fire("mousewheel",s,!0)});this.element.addEventListener("wheel",this._mouseWheelListener=(s,t)=>{if(!this.enabled)return;const o=Math.max(-1,Math.min(1,-s.deltaY*40));i(o)},{passive:!0});{let s,t;this.on("mousedown",n=>{s=n[0],t=n[1]}),this.on("mouseup",n=>{s>=n[0]-2&&s<=n[0]+2&&t>=n[1]-2&&t<=n[1]+2&&this.fire("mouseclicked",n,!0)})}this._eventsBound=!0}_unbindEvents(){this._eventsBound&&(this._keyboardEventsElement.removeEventListener("keydown",this._keyDownListener),this._keyboardEventsElement.removeEventListener("keyup",this._keyUpListener),this.element.removeEventListener("mouseenter",this._mouseEnterListener),this.element.removeEventListener("mouseleave",this._mouseLeaveListener),this.element.removeEventListener("mousedown",this._mouseDownListener),document.removeEventListener("mouseup",this._mouseDownListener),document.removeEventListener("click",this._clickListener),document.removeEventListener("dblclick",this._dblClickListener),this.element.removeEventListener("mousemove",this._mouseMoveListener),this.element.removeEventListener("wheel",this._mouseWheelListener),window.OrientationChangeEvent&&window.removeEventListener("orientationchange",this._orientationchangedListener),window.DeviceMotionEvent&&window.removeEventListener("devicemotion",this._deviceMotionListener),window.DeviceOrientationEvent&&window.removeEventListener("deviceorientation",this._deviceOrientListener),this._eventsBound=!1)}_getMouseCanvasPos(e){if(!e)e=window.event,this.mouseCanvasPos[0]=e.x,this.mouseCanvasPos[1]=e.y;else{let i=e.target,s=0,t=0;for(;i.offsetParent;)s+=i.offsetLeft,t+=i.offsetTop,i=i.offsetParent;this.mouseCanvasPos[0]=e.pageX-s,this.mouseCanvasPos[1]=e.pageY-t}}setEnabled(e){this.enabled!==e&&this.fire("enabled",this.enabled=e)}getEnabled(){return this.enabled}setKeyboardEnabled(e){this.keyboardEnabled=e}getKeyboardEnabled(){return this.keyboardEnabled}destroy(){super.destroy(),this._unbindEvents()}}const _c=new Ci({});class Ft{constructor(e){this.id=_c.addItem({});for(const i in e)e.hasOwnProperty(i)&&(this[i]=e[i])}destroy(){_c.removeItem(this.id)}}class Um extends Et{get type(){return"Viewport"}constructor(e,i={}){super(e,i),this._state=new Ft({boundary:[0,0,100,100]}),this.boundary=i.boundary,this.autoBoundary=i.autoBoundary}set boundary(e){if(!this._autoBoundary){if(!e){const i=this.scene.canvas.boundary,s=i[2],t=i[3];e=[0,0,s,t]}this._state.boundary=e,this.glRedraw(),this.fire("boundary",this._state.boundary)}}get boundary(){return this._state.boundary}set autoBoundary(e){e=!!e,e!==this._autoBoundary&&(this._autoBoundary=e,this._autoBoundary?this._onCanvasSize=this.scene.canvas.on("boundary",function(i){const s=i[2],t=i[3];this._state.boundary=[0,0,s,t],this.glRedraw(),this.fire("boundary",this._state.boundary)},this):this._onCanvasSize&&(this.scene.canvas.off(this._onCanvasSize),this._onCanvasSize=null),this.fire("autoBoundary",this._autoBoundary))}get autoBoundary(){return this._autoBoundary}_getState(){return this._state}destroy(){super.destroy(),this._state.destroy()}}class Om extends Et{get type(){return"Perspective"}constructor(e,i={}){super(e,i),this.camera=e,this._state=new Ft({matrix:c.mat4(),inverseMatrix:c.mat4(),transposedMatrix:c.mat4(),near:.1,far:1e4}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this._fov=60,this._canvasResized=this.scene.canvas.on("boundary",this._needUpdate,this),this.fov=i.fov,this.fovAxis=i.fovAxis,this.near=i.near,this.far=i.far}_update(){const s=this.scene.canvas.boundary,t=s[2]/s[3],o=this._fovAxis;let n=this._fov;(o==="x"||o==="min"&&t<1||o==="max"&&t>1)&&(n=n/t),n=Math.min(n,120),c.perspectiveMat4(n*(Math.PI/180),t,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.camera._updateScheduled=!0,this.fire("matrix",this._state.matrix)}set fov(e){e=e??60,e!==this._fov&&(this._fov=e,this._needUpdate(0),this.fire("fov",this._fov))}get fov(){return this._fov}set fovAxis(e){e=e||"min",this._fovAxis!==e&&(e!=="x"&&e!=="y"&&e!=="min"&&(this.error("Unsupported value for 'fovAxis': "+e+" - defaulting to 'min'"),e="min"),this._fovAxis=e,this._needUpdate(0),this.fire("fovAxis",this._fovAxis))}get fovAxis(){return this._fovAxis}set near(e){const i=e??.1;this._state.near!==i&&(this._state.near=i,this._needUpdate(0),this.fire("near",this._state.near))}get near(){return this._state.near}set far(e){const i=e??1e4;this._state.far!==i&&(this._state.far=i,this._needUpdate(0),this.fire("far",this._state.far))}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(c.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(c.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(e,i,s,t,o){const n=this.scene.canvas.canvas,a=n.offsetWidth/2,A=n.offsetHeight/2;return s[0]=(e[0]-a)/a,s[1]=(e[1]-A)/A,s[2]=i,s[3]=1,c.mulMat4v4(this.inverseMatrix,s,t),c.mulVec3Scalar(t,1/t[3]),t[3]=1,t[1]*=-1,c.mulMat4v4(this.camera.inverseViewMatrix,t,o),o}destroy(){super.destroy(),this._state.destroy(),this.scene.canvas.off(this._canvasResized)}}class km extends Et{get type(){return"Ortho"}constructor(e,i={}){super(e,i),this.camera=e,this._state=new Ft({matrix:c.mat4(),inverseMatrix:c.mat4(),transposedMatrix:c.mat4(),near:.1,far:1e4}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.scale=i.scale,this.near=i.near,this.far=i.far,this._onCanvasBoundary=this.scene.canvas.on("boundary",this._needUpdate,this)}_update(){const s=this.scene,o=.5*this._scale,n=s.canvas.boundary,a=n[2],A=n[3],l=a/A;let h,d,f,m;a>A?(h=-o,d=o,f=o/l,m=-o/l):(h=-o*l,d=o*l,f=o,m=-o),c.orthoMat4c(h,d,m,f,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}set scale(e){e==null&&(e=1),e<=0&&(e=.01),this._scale=e,this._needUpdate(0),this.fire("scale",this._scale)}get scale(){return this._scale}set near(e){const i=e??.1;this._state.near!==i&&(this._state.near=i,this._needUpdate(0),this.fire("near",this._state.near))}get near(){return this._state.near}set far(e){const i=e??1e4;this._state.far!==i&&(this._state.far=i,this._needUpdate(0),this.fire("far",this._state.far))}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(c.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(c.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(e,i,s,t,o){const n=this.scene.canvas.canvas,a=n.offsetWidth/2,A=n.offsetHeight/2;return s[0]=(e[0]-a)/a,s[1]=(e[1]-A)/A,s[2]=i,s[3]=1,c.mulMat4v4(this.inverseMatrix,s,t),c.mulVec3Scalar(t,1/t[3]),t[3]=1,t[1]*=-1,c.mulMat4v4(this.camera.inverseViewMatrix,t,o),o}destroy(){super.destroy(),this._state.destroy(),this.scene.canvas.off(this._onCanvasBoundary)}}class Nm extends Et{get type(){return"Frustum"}constructor(e,i={}){super(e,i),this.camera=e,this._state=new Ft({matrix:c.mat4(),inverseMatrix:c.mat4(),transposedMatrix:c.mat4(),near:.1,far:1e4}),this._left=-1,this._right=1,this._bottom=-1,this._top=1,this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.left=i.left,this.right=i.right,this.bottom=i.bottom,this.top=i.top,this.near=i.near,this.far=i.far}_update(){c.frustumMat4(this._left,this._right,this._bottom,this._top,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}set left(e){this._left=e??-1,this._needUpdate(0),this.fire("left",this._left)}get left(){return this._left}set right(e){this._right=e??1,this._needUpdate(0),this.fire("right",this._right)}get right(){return this._right}set top(e){this._top=e??1,this._needUpdate(0),this.fire("top",this._top)}get top(){return this._top}set bottom(e){this._bottom=e??-1,this._needUpdate(0),this.fire("bottom",this._bottom)}get bottom(){return this._bottom}set near(e){this._state.near=e??.1,this._needUpdate(0),this.fire("near",this._state.near)}get near(){return this._state.near}set far(e){this._state.far=e??1e4,this._needUpdate(0),this.fire("far",this._state.far)}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(c.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(c.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(e,i,s,t,o){const n=this.scene.canvas.canvas,a=n.offsetWidth/2,A=n.offsetHeight/2;return s[0]=(e[0]-a)/a,s[1]=(e[1]-A)/A,s[2]=i,s[3]=1,c.mulMat4v4(this.inverseMatrix,s,t),c.mulVec3Scalar(t,1/t[3]),t[3]=1,t[1]*=-1,c.mulMat4v4(this.camera.inverseViewMatrix,t,o),o}destroy(){super.destroy(),this._state.destroy(),super.destroy()}}class Qm extends Et{get type(){return"CustomProjection"}constructor(e,i={}){super(e,i),this.camera=e,this._state=new Ft({matrix:c.mat4(),inverseMatrix:c.mat4(),transposedMatrix:c.mat4()}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!1,this.matrix=i.matrix}set matrix(e){this._state.matrix.set(e||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}get matrix(){return this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(c.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(c.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(e,i,s,t,o){const n=this.scene.canvas.canvas,a=n.offsetWidth/2,A=n.offsetHeight/2;return s[0]=(e[0]-a)/a,s[1]=(e[1]-A)/A,s[2]=i,s[3]=1,c.mulMat4v4(this.inverseMatrix,s,t),c.mulVec3Scalar(t,1/t[3]),t[3]=1,t[1]*=-1,c.mulMat4v4(this.camera.inverseViewMatrix,t,o),o}destroy(){super.destroy(),this._state.destroy()}}const fs=c.vec3(),Ds=c.vec3(),Rs=c.vec3(),Ls=c.vec3(),Pa=c.vec3(),Ba=c.vec3(),Hm=c.vec4(),Vm=c.vec4(),jm=c.vec4(),fi=c.mat4(),vc=c.mat4(),Pc=c.vec3(),Bc=c.vec3(),yc=c.vec3(),xc=c.vec3();class Gm extends Et{get type(){return"Camera"}constructor(e,i={}){super(e,i),this._state=new Ft({deviceMatrix:c.mat4(),hasDeviceMatrix:!1,matrix:c.mat4(),normalMatrix:c.mat4(),inverseMatrix:c.mat4()}),this._perspective=new Om(this),this._ortho=new km(this),this._frustum=new Nm(this),this._customProjection=new Qm(this),this._project=this._perspective,this._eye=c.vec3([0,0,10]),this._look=c.vec3([0,0,0]),this._up=c.vec3([0,1,0]),this._worldUp=c.vec3([0,1,0]),this._worldRight=c.vec3([1,0,0]),this._worldForward=c.vec3([0,0,-1]),this.deviceMatrix=i.deviceMatrix,this.eye=i.eye,this.look=i.look,this.up=i.up,this.worldAxis=i.worldAxis,this.gimbalLock=i.gimbalLock,this.constrainPitch=i.constrainPitch,this.projection=i.projection,this._perspective.on("matrix",()=>{this._projectionType==="perspective"&&this.fire("projMatrix",this._perspective.matrix)}),this._ortho.on("matrix",()=>{this._projectionType==="ortho"&&this.fire("projMatrix",this._ortho.matrix)}),this._frustum.on("matrix",()=>{this._projectionType==="frustum"&&this.fire("projMatrix",this._frustum.matrix)}),this._customProjection.on("matrix",()=>{this._projectionType==="customProjection"&&this.fire("projMatrix",this._customProjection.matrix)})}_update(){const e=this._state;let i;this.projection==="ortho"?(c.subVec3(this._eye,this._look,Pc),c.normalizeVec3(Pc,Bc),c.mulVec3Scalar(Bc,1e3,yc),c.addVec3(this._look,yc,xc),i=xc):i=this._eye,e.hasDeviceMatrix?(c.lookAtMat4v(i,this._look,this._up,vc),c.mulMat4(e.deviceMatrix,vc,e.matrix)):c.lookAtMat4v(i,this._look,this._up,e.matrix),c.inverseMat4(this._state.matrix,this._state.inverseMatrix),c.transposeMat4(this._state.inverseMatrix,this._state.normalMatrix),this.glRedraw(),this.fire("matrix",this._state.matrix),this.fire("viewMatrix",this._state.matrix)}orbitYaw(e){let i=c.subVec3(this._eye,this._look,fs);c.rotationMat4v(e*.0174532925,this._gimbalLock?this._worldUp:this._up,fi),i=c.transformPoint3(fi,i,Ds),this.eye=c.addVec3(this._look,i,Rs),this.up=c.transformPoint3(fi,this._up,Ls)}orbitPitch(e){if(this._constrainPitch&&(e=c.dotVec3(this._up,this._worldUp)/c.DEGTORAD,e<1))return;let i=c.subVec3(this._eye,this._look,fs);const s=c.cross3Vec3(c.normalizeVec3(i,Ds),c.normalizeVec3(this._up,Rs));c.rotationMat4v(e*.0174532925,s,fi),i=c.transformPoint3(fi,i,Ls),this.up=c.transformPoint3(fi,this._up,Pa),this.eye=c.addVec3(i,this._look,Ba)}yaw(e){let i=c.subVec3(this._look,this._eye,fs);c.rotationMat4v(e*.0174532925,this._gimbalLock?this._worldUp:this._up,fi),i=c.transformPoint3(fi,i,Ds),this.look=c.addVec3(i,this._eye,Rs),this._gimbalLock&&(this.up=c.transformPoint3(fi,this._up,Ls))}pitch(e){if(this._constrainPitch&&(e=c.dotVec3(this._up,this._worldUp)/c.DEGTORAD,e<1))return;let i=c.subVec3(this._look,this._eye,fs);const s=c.cross3Vec3(c.normalizeVec3(i,Ds),c.normalizeVec3(this._up,Rs));c.rotationMat4v(e*.0174532925,s,fi),this.up=c.transformPoint3(fi,this._up,Ba),i=c.transformPoint3(fi,i,Ls),this.look=c.addVec3(i,this._eye,Pa)}pan(e){const i=c.subVec3(this._eye,this._look,fs),s=[0,0,0];let t;if(e[0]!==0){const o=c.cross3Vec3(c.normalizeVec3(i,[]),c.normalizeVec3(this._up,Ds));t=c.mulVec3Scalar(o,e[0]),s[0]+=t[0],s[1]+=t[1],s[2]+=t[2]}e[1]!==0&&(t=c.mulVec3Scalar(c.normalizeVec3(this._up,Rs),e[1]),s[0]+=t[0],s[1]+=t[1],s[2]+=t[2]),e[2]!==0&&(t=c.mulVec3Scalar(c.normalizeVec3(i,Ls),e[2]),s[0]+=t[0],s[1]+=t[1],s[2]+=t[2]),this.eye=c.addVec3(this._eye,s,Pa),this.look=c.addVec3(this._look,s,Ba)}zoom(e){const i=c.subVec3(this._eye,this._look,fs),s=Math.abs(c.lenVec3(i,Ds)),t=Math.abs(s+e);if(t<.5)return;const o=c.normalizeVec3(i,Rs);this.eye=c.addVec3(this._look,c.mulVec3Scalar(o,t),Ls)}set eye(e){this._eye.set(e||[0,0,10]),this._needUpdate(0),this.fire("eye",this._eye)}get eye(){return this._eye}set look(e){this._look.set(e||[0,0,0]),this._needUpdate(0),this.fire("look",this._look)}get look(){return this._look}set up(e){this._up.set(e||[0,1,0]),this._needUpdate(0),this.fire("up",this._up)}get up(){return this._up}set deviceMatrix(e){this._state.deviceMatrix.set(e||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._state.hasDeviceMatrix=!!e,this._needUpdate(0),this.fire("deviceMatrix",this._state.deviceMatrix)}get deviceMatrix(){return this._state.deviceMatrix}set worldAxis(e){e=e||[1,0,0,0,1,0,0,0,1],this._worldAxis?this._worldAxis.set(e):this._worldAxis=c.vec3(e),this._worldRight[0]=this._worldAxis[0],this._worldRight[1]=this._worldAxis[1],this._worldRight[2]=this._worldAxis[2],this._worldUp[0]=this._worldAxis[3],this._worldUp[1]=this._worldAxis[4],this._worldUp[2]=this._worldAxis[5],this._worldForward[0]=this._worldAxis[6],this._worldForward[1]=this._worldAxis[7],this._worldForward[2]=this._worldAxis[8],this.fire("worldAxis",this._worldAxis)}get worldAxis(){return this._worldAxis}get worldUp(){return this._worldUp}get xUp(){return this._worldUp[0]>this._worldUp[1]&&this._worldUp[0]>this._worldUp[2]}get yUp(){return this._worldUp[1]>this._worldUp[0]&&this._worldUp[1]>this._worldUp[2]}get zUp(){return this._worldUp[2]>this._worldUp[0]&&this._worldUp[2]>this._worldUp[1]}get worldRight(){return this._worldRight}get worldForward(){return this._worldForward}set gimbalLock(e){this._gimbalLock=e!==!1,this.fire("gimbalLock",this._gimbalLock)}get gimbalLock(){return this._gimbalLock}set constrainPitch(e){this._constrainPitch=!!e,this.fire("constrainPitch",this._constrainPitch)}get eyeLookDist(){return c.lenVec3(c.subVec3(this._look,this._eye,fs))}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get viewMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get normalMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}get viewNormalMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}get inverseViewMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.inverseMatrix}get projMatrix(){return this[this.projection].matrix}get perspective(){return this._perspective}get ortho(){return this._ortho}get frustum(){return this._frustum}get customProjection(){return this._customProjection}set projection(e){e=e||"perspective",this._projectionType!==e&&(e==="perspective"?this._project=this._perspective:e==="ortho"?this._project=this._ortho:e==="frustum"?this._project=this._frustum:e==="customProjection"?this._project=this._customProjection:(this.error("Unsupported value for 'projection': "+e+" defaulting to 'perspective'"),this._project=this._perspective,e="perspective"),this._project._update(),this._projectionType=e,this.glRedraw(),this._update(),this.fire("dirty"),this.fire("projection",this._projectionType),this.fire("projMatrix",this._project.matrix))}get projection(){return this._projectionType}get project(){return this._project}projectWorldPos(e){const i=Hm,s=Vm,t=jm;i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=1,c.mulMat4v4(this.viewMatrix,i,s),c.mulMat4v4(this.projMatrix,s,t),c.mulVec3Scalar(t,1/t[3]),t[3]=1,t[1]*=-1;const o=this.scene.canvas.canvas,n=o.offsetWidth/2,a=o.offsetHeight/2;return[t[0]*n+n,t[1]*a+a]}destroy(){super.destroy(),this._state.destroy()}}class up extends Et{get type(){return"Light"}get isLight(){return!0}constructor(e,i={}){super(e,i)}}class wc extends up{get type(){return"DirLight"}constructor(e,i={}){super(e,i),this._shadowRenderBuf=null,this._shadowViewMatrix=null,this._shadowProjMatrix=null,this._shadowViewMatrixDirty=!0,this._shadowProjMatrixDirty=!0;const s=this.scene.camera,t=this.scene.canvas;this._onCameraViewMatrix=s.on("viewMatrix",()=>{this._shadowViewMatrixDirty=!0}),this._onCameraProjMatrix=s.on("projMatrix",()=>{this._shadowProjMatrixDirty=!0}),this._onCanvasBoundary=t.on("boundary",()=>{this._shadowProjMatrixDirty=!0}),this._state=new Ft({type:"dir",dir:c.vec3([1,1,1]),color:c.vec3([.7,.7,.8]),intensity:1,space:i.space||"view",castsShadow:!1,getShadowViewMatrix:()=>{if(this._shadowViewMatrixDirty){this._shadowViewMatrix||(this._shadowViewMatrix=c.identityMat4());const o=this.scene.camera,n=this._state.dir,a=o.look,A=[a[0]-n[0],a[1]-n[1],a[2]-n[2]],l=[0,1,0];c.lookAtMat4v(A,a,l,this._shadowViewMatrix),this._shadowViewMatrixDirty=!1}return this._shadowViewMatrix},getShadowProjMatrix:()=>(this._shadowProjMatrixDirty&&(this._shadowProjMatrix||(this._shadowProjMatrix=c.identityMat4()),c.orthoMat4c(-40,40,-40,40,-40,80,this._shadowProjMatrix),this._shadowProjMatrixDirty=!1),this._shadowProjMatrix),getShadowRenderBuf:()=>(this._shadowRenderBuf||(this._shadowRenderBuf=new hp(this.scene.canvas.canvas,this.scene.canvas.gl,{size:[1024,1024]})),this._shadowRenderBuf)}),this.dir=i.dir,this.color=i.color,this.intensity=i.intensity,this.castsShadow=i.castsShadow,this.scene._lightCreated(this)}set dir(e){this._state.dir.set(e||[1,1,1]),this._shadowViewMatrixDirty=!0,this.glRedraw()}get dir(){return this._state.dir}set color(e){this._state.color.set(e||[.7,.7,.8]),this.glRedraw()}get color(){return this._state.color}set intensity(e){e=e!==void 0?e:1,this._state.intensity=e,this.glRedraw()}get intensity(){return this._state.intensity}set castsShadow(e){e=!!e,this._state.castsShadow!==e&&(this._state.castsShadow=e,this._shadowViewMatrixDirty=!0,this.glRedraw())}get castsShadow(){return this._state.castsShadow}destroy(){const e=this.scene.camera,i=this.scene.canvas;e.off(this._onCameraViewMatrix),e.off(this._onCameraProjMatrix),i.off(this._onCanvasBoundary),super.destroy(),this._state.destroy(),this._shadowRenderBuf&&this._shadowRenderBuf.destroy(),this.scene._lightDestroyed(this),this.glRedraw()}}class zm extends up{get type(){return"AmbientLight"}constructor(e,i={}){super(e,i),this._state={type:"ambient",color:c.vec3([.7,.7,.7]),intensity:1},this.color=i.color,this.intensity=i.intensity,this.scene._lightCreated(this)}set color(e){this._state.color.set(e||[.7,.7,.8]),this.glRedraw()}get color(){return this._state.color}set intensity(e){this._state.intensity=e!==void 0?e:1,this.glRedraw()}get intensity(){return this._state.intensity}destroy(){super.destroy(),this.scene._lightDestroyed(this)}}class dp extends Et{get type(){return"Geometry"}get isGeometry(){return!0}constructor(e,i={}){super(e,i),vt.memory.meshes++}destroy(){super.destroy(),vt.memory.meshes--}}var ts=function(){const r=[],e=[],i=[],s=[],t=[];let o=0;const n=new Uint16Array(3),a=new Uint16Array(3),A=new Uint16Array(3),l=c.vec3(),h=c.vec3(),d=c.vec3(),f=c.vec3(),m=c.vec3(),_=c.vec3(),u=c.vec3();function P(x,B){const v={};let w,C,I,E;const R=Math.pow(10,4);let D,K,G=0;for(D=0,K=x.length;D<K;D+=3)w=x[D],C=x[D+1],I=x[D+2],E=Math.round(w*R)+"_"+Math.round(C*R)+"_"+Math.round(I*R),v[E]===void 0&&(v[E]=G/3,r[G++]=w,r[G++]=C,r[G++]=I),e[D/3]=v[E];for(D=0,K=B.length;D<K;D++)s[D]=e[B[D]],i[s[D]]=B[D]}function y(x,B){o=0;for(let v=0,w=x;v<w;v+=3){const C=s[v]*3,I=s[v+1]*3,E=s[v+2]*3;B?(n[0]=r[C],n[1]=r[C+1],n[2]=r[C+2],a[0]=r[I],a[1]=r[I+1],a[2]=r[I+2],A[0]=r[E],A[1]=r[E+1],A[2]=r[E+2],c.decompressPosition(n,B,l),c.decompressPosition(a,B,h),c.decompressPosition(A,B,d)):(l[0]=r[C],l[1]=r[C+1],l[2]=r[C+2],h[0]=r[I],h[1]=r[I+1],h[2]=r[I+2],d[0]=r[E],d[1]=r[E+1],d[2]=r[E+2]),c.subVec3(d,h,f),c.subVec3(l,h,m),c.cross3Vec3(f,m,_),c.normalizeVec3(_,u);const S=t[o]||(t[o]={normal:c.vec3()});S.normal[0]=u[0],S.normal[1]=u[1],S.normal[2]=u[2],o++}}return function(x,B,v,w){P(x,B),y(B.length,v);const C=[],I=Math.cos(c.DEGTORAD*w),E={};let S,R,D,K,G,z=!1,le,ue,ae,Pe,be,xe;for(let Ie=0,Fe=B.length;Ie<Fe;Ie+=3){const Qe=Ie/3;for(let Ve=0;Ve<3;Ve++)S=s[Ie+Ve],R=s[Ie+(Ve+1)%3],D=Math.min(S,R),K=Math.max(S,R),G=D+","+K,E[G]===void 0?E[G]={index1:D,index2:K,face1:Qe,face2:void 0}:E[G].face2=Qe}for(G in E)le=E[G],!(le.face2!==void 0&&(ue=t[le.face1].normal,ae=t[le.face2].normal,Pe=c.dotVec3(ue,ae),Pe>I))&&(be=i[le.index1],xe=i[le.index2],(!z&&be>65535||xe>65535)&&(z=!0),C.push(be),C.push(xe));return z?new Uint32Array(C):new Uint16Array(C)}}();function Km(r){const e=new Float32Array(3),i=new Float32Array(3);let s,t;for(s=0;s<3;s++)e[s]=Number.MAX_VALUE,i[s]=-Number.MAX_VALUE;for(s=0;s<r.length;s+=3)for(t=0;t<3;t++)e[t]=Math.min(e[t],r[s+t]),i[t]=Math.max(i[t],r[s+t]);return{min:e,max:i}}const Wm=function(){const r=c.mat4(),e=c.mat4();return function(i,s){s=s||c.mat4();const t=i[0],o=i[1],n=i[2],a=i[3]-t,A=i[4]-o,l=i[5]-n,h=65535;return c.identityMat4(r),c.translationMat4v(i,r),c.identityMat4(e),c.scalingMat4v([a/h,A/h,l/h],e),c.mulMat4(r,e,s),s}}();var Xm=function(){const r=c.mat4(),e=c.mat4();return function(i,s,t){const o=new Uint16Array(i.length),n=new Float32Array([t[0]!==s[0]?65535/(t[0]-s[0]):0,t[1]!==s[1]?65535/(t[1]-s[1]):0,t[2]!==s[2]?65535/(t[2]-s[2]):0]);let a;for(a=0;a<i.length;a+=3)o[a+0]=Math.max(0,Math.min(65535,Math.floor((i[a+0]-s[0])*n[0]))),o[a+1]=Math.max(0,Math.min(65535,Math.floor((i[a+1]-s[1])*n[1]))),o[a+2]=Math.max(0,Math.min(65535,Math.floor((i[a+2]-s[2])*n[2])));c.identityMat4(r),c.translationMat4v(s,r),c.identityMat4(e),c.scalingMat4v([(t[0]-s[0])/65535,(t[1]-s[1])/65535,(t[2]-s[2])/65535],e);const A=c.mulMat4(r,e,c.identityMat4());return{quantized:o,decodeMatrix:A}}}();function Ym(r,e,i){const s=new Float32Array([e[3]!==e[0]?65535/(e[3]-e[0]):0,e[4]!==e[1]?65535/(e[4]-e[1]):0,e[5]!==e[2]?65535/(e[5]-e[2]):0]);i[0]=Math.max(0,Math.min(65535,Math.floor((r[0]-e[0])*s[0]))),i[1]=Math.max(0,Math.min(65535,Math.floor((r[1]-e[1])*s[1]))),i[2]=Math.max(0,Math.min(65535,Math.floor((r[2]-e[2])*s[2])))}function $m(r,e,i){return i[0]=r[0]*e[0]+e[12],i[1]=r[1]*e[5]+e[13],i[2]=r[2]*e[10]+e[14],i}function Zm(r,e,i=r){return i[0]=r[0]*e[0]+e[12],i[1]=r[1]*e[5]+e[13],i[2]=r[2]*e[10]+e[14],i[3]=r[3]*e[0]+e[12],i[4]=r[4]*e[5]+e[13],i[5]=r[5]*e[10]+e[14],i}function qm(r,e,i=new Float32Array(r.length)){for(let s=0,t=r.length;s<t;s+=3)i[s+0]=r[s+0]*e[0]+e[12],i[s+1]=r[s+1]*e[5]+e[13],i[s+2]=r[s+2]*e[10]+e[14];return i}function Jm(r){const e=new Float32Array(2),i=new Float32Array(2);let s,t;for(s=0;s<2;s++)e[s]=Number.MAX_VALUE,i[s]=-Number.MAX_VALUE;for(s=0;s<r.length;s+=2)for(t=0;t<2;t++)e[t]=Math.min(e[t],r[s+t]),i[t]=Math.max(i[t],r[s+t]);return{min:e,max:i}}var e_=function(){const r=c.mat3(),e=c.mat3();return function(i,s,t){const o=new Uint16Array(i.length),n=new Float32Array([65535/(t[0]-s[0]),65535/(t[1]-s[1])]);let a;for(a=0;a<i.length;a+=2)o[a+0]=Math.max(0,Math.min(65535,Math.floor((i[a+0]-s[0])*n[0]))),o[a+1]=Math.max(0,Math.min(65535,Math.floor((i[a+1]-s[1])*n[1])));c.identityMat3(r),c.translationMat3v(s,r),c.identityMat3(e),c.scalingMat3v([(t[0]-s[0])/65535,(t[1]-s[1])/65535],e);const A=c.mulMat3(r,e,c.identityMat3());return{quantized:o,decodeMatrix:A}}}();function t_(r){const e=new Int8Array(r.length);let i,s,t,o,n;for(let a=0;a<r.length;a+=3)t=i=So(r,a,"floor","floor"),s=To(i),o=n=Do(r,a,s),i=So(r,a,"ceil","floor"),s=To(i),o=Do(r,a,s),o>n&&(t=i,n=o),i=So(r,a,"floor","ceil"),s=To(i),o=Do(r,a,s),o>n&&(t=i,n=o),i=So(r,a,"ceil","ceil"),s=To(i),o=Do(r,a,s),o>n&&(t=i,n=o),e[a]=t[0],e[a+1]=t[1];return e}function So(r,e,i,s){let t=r[e]/(Math.abs(r[e])+Math.abs(r[e+1])+Math.abs(r[e+2])),o=r[e+1]/(Math.abs(r[e])+Math.abs(r[e+1])+Math.abs(r[e+2]));if(r[e+2]<0){let n=(1-Math.abs(o))*(t>=0?1:-1),a=(1-Math.abs(t))*(o>=0?1:-1);t=n,o=a}return new Int8Array([Math[i](t*127.5+(t<0?-1:0)),Math[s](o*127.5+(o<0?-1:0))])}function To(r){let e=r[0],i=r[1];e/=e<0?127:128,i/=i<0?127:128;const s=1-Math.abs(e)-Math.abs(i);s<0&&(e=(1-Math.abs(i))*(e>=0?1:-1),i=(1-Math.abs(e))*(i>=0?1:-1));const t=Math.sqrt(e*e+i*i+s*s);return[e/t,i/t,s/t]}function Do(r,e,i){return r[e]*i[0]+r[e+1]*i[1]+r[e+2]*i[2]}function i_(r,e,i){i[0]=r[0]*e[0]+e[6],i[1]=r[1]*e[4]+e[7]}function s_(r,e,i=new Float32Array(r.length)){for(let s=0,t=r.length;s<t;s+=3)i[s+0]=r[s+0]*e[0]+e[6],i[s+1]=r[s+1]*e[4]+e[7];return i}function r_(r,e){let i=r[0],s=r[1];i=(2*i+1)/255,s=(2*s+1)/255;const t=1-Math.abs(i)-Math.abs(s);t<0&&(i=(1-Math.abs(s))*(i>=0?1:-1),s=(1-Math.abs(i))*(s>=0?1:-1));const o=Math.sqrt(i*i+s*s+t*t);return e[0]=i/o,e[1]=s/o,e[2]=t/o,e}function o_(r,e){for(let i=0,s=0,t=r.length;i<t;i+=2){let o=r[i+0],n=r[i+1];o=(2*o+1)/255,n=(2*n+1)/255;const a=1-Math.abs(o)-Math.abs(n);a<0&&(o=(1-Math.abs(n))*(o>=0?1:-1),n=(1-Math.abs(o))*(n>=0?1:-1));const A=Math.sqrt(o*o+n*n+a*a);e[s+0]=o/A,e[s+1]=n/A,e[s+2]=a/A,s+=3}return e}const st={getPositionsBounds:Km,createPositionsDecodeMatrix:Wm,compressPositions:Xm,compressPosition:Ym,decompressPositions:qm,decompressPosition:$m,decompressAABB:Zm,getUVBounds:Jm,compressUVs:e_,decompressUVs:s_,decompressUV:i_,compressNormals:t_,decompressNormals:o_,decompressNormal:r_},Ii=vt.memory,bc=c.AABB3();class n_ extends dp{get type(){return"ReadableGeometry"}get isReadableGeometry(){return!0}constructor(e,i={}){super(e,i),this._state=new Ft({compressGeometry:!!i.compressGeometry,primitive:null,primitiveName:null,positions:null,normals:null,colors:null,uv:null,indices:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,positionsBuf:null,normalsBuf:null,colorsbuf:null,uvBuf:null,indicesBuf:null,hash:""}),this._numTriangles=0,this._edgeThreshold=i.edgeThreshold||10,this._edgeIndicesBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._aabbDirty=!0,this._boundingSphere=!0,this._aabb=null,this._aabbDirty=!0,this._obb=null,this._obbDirty=!0;const s=this._state,t=this.scene.canvas.gl;switch(i.primitive=i.primitive||"triangles",i.primitive){case"points":s.primitive=t.POINTS,s.primitiveName=i.primitive;break;case"lines":s.primitive=t.LINES,s.primitiveName=i.primitive;break;case"line-loop":s.primitive=t.LINE_LOOP,s.primitiveName=i.primitive;break;case"line-strip":s.primitive=t.LINE_STRIP,s.primitiveName=i.primitive;break;case"triangles":s.primitive=t.TRIANGLES,s.primitiveName=i.primitive;break;case"triangle-strip":s.primitive=t.TRIANGLE_STRIP,s.primitiveName=i.primitive;break;case"triangle-fan":s.primitive=t.TRIANGLE_FAN,s.primitiveName=i.primitive;break;default:this.error("Unsupported value for 'primitive': '"+i.primitive+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),s.primitive=t.TRIANGLES,s.primitiveName=i.primitive}if(i.positions)if(this._state.compressGeometry){const o=st.getPositionsBounds(i.positions),n=st.compressPositions(i.positions,o.min,o.max);s.positions=n.quantized,s.positionsDecodeMatrix=n.decodeMatrix}else s.positions=i.positions.constructor===Float32Array?i.positions:new Float32Array(i.positions);if(i.colors&&(s.colors=i.colors.constructor===Float32Array?i.colors:new Float32Array(i.colors)),i.uv)if(this._state.compressGeometry){const o=st.getUVBounds(i.uv),n=st.compressUVs(i.uv,o.min,o.max);s.uv=n.quantized,s.uvDecodeMatrix=n.decodeMatrix}else s.uv=i.uv.constructor===Float32Array?i.uv:new Float32Array(i.uv);i.normals&&(this._state.compressGeometry?s.normals=st.compressNormals(i.normals):s.normals=i.normals.constructor===Float32Array?i.normals:new Float32Array(i.normals)),i.indices&&(s.indices=i.indices.constructor===Uint32Array||i.indices.constructor===Uint16Array?i.indices:new Uint32Array(i.indices),this._state.primitiveName==="triangles"&&(this._numTriangles=i.indices.length/3)),this._buildHash(),Ii.meshes++,this._buildVBOs()}_buildVBOs(){const e=this._state,i=this.scene.canvas.gl;if(e.indices&&(e.indicesBuf=new Ee(i,i.ELEMENT_ARRAY_BUFFER,e.indices,e.indices.length,1,i.STATIC_DRAW),Ii.indices+=e.indicesBuf.numItems),e.positions&&(e.positionsBuf=new Ee(i,i.ARRAY_BUFFER,e.positions,e.positions.length,3,i.STATIC_DRAW),Ii.positions+=e.positionsBuf.numItems),e.normals){let s=e.compressGeometry;e.normalsBuf=new Ee(i,i.ARRAY_BUFFER,e.normals,e.normals.length,3,i.STATIC_DRAW,s),Ii.normals+=e.normalsBuf.numItems}e.colors&&(e.colorsBuf=new Ee(i,i.ARRAY_BUFFER,e.colors,e.colors.length,4,i.STATIC_DRAW),Ii.colors+=e.colorsBuf.numItems),e.uv&&(e.uvBuf=new Ee(i,i.ARRAY_BUFFER,e.uv,e.uv.length,2,i.STATIC_DRAW),Ii.uvs+=e.uvBuf.numItems)}_buildHash(){const e=this._state,i=["/g"];i.push("/"+e.primitive+";"),e.positions&&i.push("p"),e.colors&&i.push("c"),(e.normals||e.autoVertexNormals)&&i.push("n"),e.uv&&i.push("u"),e.compressGeometry&&i.push("cp"),i.push(";"),e.hash=i.join("")}_getEdgeIndices(){return this._edgeIndicesBuf||this._buildEdgeIndices(),this._edgeIndicesBuf}_getPickTrianglePositions(){return this._pickTrianglePositionsBuf||this._buildPickTriangleVBOs(),this._pickTrianglePositionsBuf}_getPickTriangleColors(){return this._pickTriangleColorsBuf||this._buildPickTriangleVBOs(),this._pickTriangleColorsBuf}_buildEdgeIndices(){const e=this._state;if(!e.positions||!e.indices)return;const i=this.scene.canvas.gl,s=ts(e.positions,e.indices,e.positionsDecodeMatrix,this._edgeThreshold);this._edgeIndicesBuf=new Ee(i,i.ELEMENT_ARRAY_BUFFER,s,s.length,1,i.STATIC_DRAW),Ii.indices+=this._edgeIndicesBuf.numItems}_buildPickTriangleVBOs(){const e=this._state;if(!e.positions||!e.indices)return;const i=this.scene.canvas.gl,s=c.buildPickTriangles(e.positions,e.indices,e.compressGeometry),t=s.positions,o=s.colors;this._pickTrianglePositionsBuf=new Ee(i,i.ARRAY_BUFFER,t,t.length,3,i.STATIC_DRAW),this._pickTriangleColorsBuf=new Ee(i,i.ARRAY_BUFFER,o,o.length,4,i.STATIC_DRAW,!0),Ii.positions+=this._pickTrianglePositionsBuf.numItems,Ii.colors+=this._pickTriangleColorsBuf.numItems}_buildPickVertexVBOs(){}_webglContextLost(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextLost()}_webglContextRestored(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextRestored(),this._buildVBOs(),this._edgeIndicesBuf=null,this._pickVertexPositionsBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._pickVertexPositionsBuf=null,this._pickVertexColorsBuf=null}get primitive(){return this._state.primitiveName}get compressGeometry(){return this._state.compressGeometry}get positions(){return this._state.positions?this._state.compressGeometry?(this._decompressedPositions||(this._decompressedPositions=new Float32Array(this._state.positions.length),st.decompressPositions(this._state.positions,this._state.positionsDecodeMatrix,this._decompressedPositions)),this._decompressedPositions):this._state.positions:null}set positions(e){const i=this._state,s=i.positions;if(!s){this.error("can't update geometry positions - geometry has no positions");return}if(s.length!==e.length){this.error("can't update geometry positions - new positions are wrong length");return}if(this._state.compressGeometry){const t=st.getPositionsBounds(e),o=st.compressPositions(e,t.min,t.max);e=o.quantized,i.positionsDecodeMatrix=o.decodeMatrix}s.set(e),i.positionsBuf&&i.positionsBuf.setData(s),this._setAABBDirty(),this.glRedraw()}get normals(){if(this._state.normals){if(!this._state.compressGeometry)return this._state.normals;if(!this._decompressedNormals){const e=this._state.normals.length,i=e+e/2;this._decompressedNormals=new Float32Array(i),st.decompressNormals(this._state.normals,this._decompressedNormals)}return this._decompressedNormals}}set normals(e){if(this._state.compressGeometry){this.error("can't update geometry normals - quantized geometry is immutable");return}const i=this._state,s=i.normals;if(!s){this.error("can't update geometry normals - geometry has no normals");return}if(s.length!==e.length){this.error("can't update geometry normals - new normals are wrong length");return}s.set(e),i.normalsBuf&&i.normalsBuf.setData(s),this.glRedraw()}get uv(){return this._state.uv?this._state.compressGeometry?(this._decompressedUV||(this._decompressedUV=new Float32Array(this._state.uv.length),st.decompressUVs(this._state.uv,this._state.uvDecodeMatrix,this._decompressedUV)),this._decompressedUV):this._state.uv:null}set uv(e){if(this._state.compressGeometry){this.error("can't update geometry UVs - quantized geometry is immutable");return}const i=this._state,s=i.uv;if(!s){this.error("can't update geometry UVs - geometry has no UVs");return}if(s.length!==e.length){this.error("can't update geometry UVs - new UVs are wrong length");return}s.set(e),i.uvBuf&&i.uvBuf.setData(s),this.glRedraw()}get colors(){return this._state.colors}set colors(e){if(this._state.compressGeometry){this.error("can't update geometry colors - quantized geometry is immutable");return}const i=this._state,s=i.colors;if(!s){this.error("can't update geometry colors - geometry has no colors");return}if(s.length!==e.length){this.error("can't update geometry colors - new colors are wrong length");return}s.set(e),i.colorsBuf&&i.colorsBuf.setData(s),this.glRedraw()}get indices(){return this._state.indices}get aabb(){return this._aabbDirty&&(this._aabb||(this._aabb=c.AABB3()),c.positions3ToAABB3(this._state.positions,this._aabb,this._state.positionsDecodeMatrix),this._aabbDirty=!1),this._aabb}get obb(){return this._obbDirty&&(this._obb||(this._obb=c.OBB3()),c.positions3ToAABB3(this._state.positions,bc,this._state.positionsDecodeMatrix),c.AABB3ToOBB3(bc,this._obb),this._obbDirty=!1),this._obb}get numTriangles(){return this._numTriangles}_setAABBDirty(){this._aabbDirty||(this._aabbDirty=!0,this._aabbDirty=!0,this._obbDirty=!0)}_getState(){return this._state}destroy(){super.destroy();const e=this._state;e.indicesBuf&&e.indicesBuf.destroy(),e.positionsBuf&&e.positionsBuf.destroy(),e.normalsBuf&&e.normalsBuf.destroy(),e.uvBuf&&e.uvBuf.destroy(),e.colorsBuf&&e.colorsBuf.destroy(),this._edgeIndicesBuf&&this._edgeIndicesBuf.destroy(),this._pickTrianglePositionsBuf&&this._pickTrianglePositionsBuf.destroy(),this._pickTriangleColorsBuf&&this._pickTriangleColorsBuf.destroy(),this._pickVertexPositionsBuf&&this._pickVertexPositionsBuf.destroy(),this._pickVertexColorsBuf&&this._pickVertexColorsBuf.destroy(),e.destroy(),Ii.meshes--}}function a_(r={}){let e=r.xSize||1;e<0&&(console.error("negative xSize not allowed - will invert"),e*=-1);let i=r.ySize||1;i<0&&(console.error("negative ySize not allowed - will invert"),i*=-1);let s=r.zSize||1;s<0&&(console.error("negative zSize not allowed - will invert"),s*=-1);const t=r.center,o=t?t[0]:0,n=t?t[1]:0,a=t?t[2]:0,A=-e+o,l=-i+n,h=-s+a,d=e+o,f=i+n,m=s+a;return Le.apply(r,{positions:[d,f,m,A,f,m,A,l,m,d,l,m,d,f,m,d,l,m,d,l,h,d,f,h,d,f,m,d,f,h,A,f,h,A,f,m,A,f,m,A,f,h,A,l,h,A,l,m,A,l,h,d,l,h,d,l,m,A,l,m,d,l,h,A,l,h,A,f,h,d,f,h],normals:[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],uv:[1,0,0,0,0,1,1,1,0,0,0,1,1,1,1,0,1,1,1,0,0,0,0,1,1,0,0,0,0,1,1,1,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]})}class co extends Et{get type(){return"Material"}constructor(e,i={}){super(e,i),vt.memory.materials++}destroy(){super.destroy(),vt.memory.materials--}}const A_={opaque:0,mask:1,blend:2},l_=["opaque","mask","blend"];class pp extends co{get type(){return"PhongMaterial"}constructor(e,i={}){super(e,i),this._state=new Ft({type:"PhongMaterial",ambient:c.vec3([1,1,1]),diffuse:c.vec3([1,1,1]),specular:c.vec3([1,1,1]),emissive:c.vec3([0,0,0]),alpha:null,shininess:null,reflectivity:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this.ambient=i.ambient,this.diffuse=i.diffuse,this.specular=i.specular,this.emissive=i.emissive,this.alpha=i.alpha,this.shininess=i.shininess,this.reflectivity=i.reflectivity,this.lineWidth=i.lineWidth,this.pointSize=i.pointSize,i.ambientMap&&(this._ambientMap=this._checkComponent("Texture",i.ambientMap)),i.diffuseMap&&(this._diffuseMap=this._checkComponent("Texture",i.diffuseMap)),i.specularMap&&(this._specularMap=this._checkComponent("Texture",i.specularMap)),i.emissiveMap&&(this._emissiveMap=this._checkComponent("Texture",i.emissiveMap)),i.alphaMap&&(this._alphaMap=this._checkComponent("Texture",i.alphaMap)),i.reflectivityMap&&(this._reflectivityMap=this._checkComponent("Texture",i.reflectivityMap)),i.normalMap&&(this._normalMap=this._checkComponent("Texture",i.normalMap)),i.occlusionMap&&(this._occlusionMap=this._checkComponent("Texture",i.occlusionMap)),i.diffuseFresnel&&(this._diffuseFresnel=this._checkComponent("Fresnel",i.diffuseFresnel)),i.specularFresnel&&(this._specularFresnel=this._checkComponent("Fresnel",i.specularFresnel)),i.emissiveFresnel&&(this._emissiveFresnel=this._checkComponent("Fresnel",i.emissiveFresnel)),i.alphaFresnel&&(this._alphaFresnel=this._checkComponent("Fresnel",i.alphaFresnel)),i.reflectivityFresnel&&(this._reflectivityFresnel=this._checkComponent("Fresnel",i.reflectivityFresnel)),this.alphaMode=i.alphaMode,this.alphaCutoff=i.alphaCutoff,this.backfaces=i.backfaces,this.frontface=i.frontface,this._makeHash()}_makeHash(){const e=this._state,i=["/p"];this._normalMap&&(i.push("/nm"),this._normalMap.hasMatrix&&i.push("/mat")),this._ambientMap&&(i.push("/am"),this._ambientMap.hasMatrix&&i.push("/mat"),i.push("/"+this._ambientMap.encoding)),this._diffuseMap&&(i.push("/dm"),this._diffuseMap.hasMatrix&&i.push("/mat"),i.push("/"+this._diffuseMap.encoding)),this._specularMap&&(i.push("/sm"),this._specularMap.hasMatrix&&i.push("/mat")),this._emissiveMap&&(i.push("/em"),this._emissiveMap.hasMatrix&&i.push("/mat"),i.push("/"+this._emissiveMap.encoding)),this._alphaMap&&(i.push("/opm"),this._alphaMap.hasMatrix&&i.push("/mat")),this._reflectivityMap&&(i.push("/rm"),this._reflectivityMap.hasMatrix&&i.push("/mat")),this._occlusionMap&&(i.push("/ocm"),this._occlusionMap.hasMatrix&&i.push("/mat")),this._diffuseFresnel&&i.push("/df"),this._specularFresnel&&i.push("/sf"),this._emissiveFresnel&&i.push("/ef"),this._alphaFresnel&&i.push("/of"),this._reflectivityFresnel&&i.push("/rf"),i.push(";"),e.hash=i.join("")}set ambient(e){let i=this._state.ambient;if(!i)i=this._state.ambient=new Float32Array(3);else if(e&&i[0]===e[0]&&i[1]===e[1]&&i[2]===e[2])return;e?(i[0]=e[0],i[1]=e[1],i[2]=e[2]):(i[0]=.2,i[1]=.2,i[2]=.2),this.glRedraw()}get ambient(){return this._state.ambient}set diffuse(e){let i=this._state.diffuse;if(!i)i=this._state.diffuse=new Float32Array(3);else if(e&&i[0]===e[0]&&i[1]===e[1]&&i[2]===e[2])return;e?(i[0]=e[0],i[1]=e[1],i[2]=e[2]):(i[0]=1,i[1]=1,i[2]=1),this.glRedraw()}get diffuse(){return this._state.diffuse}set specular(e){let i=this._state.specular;if(!i)i=this._state.specular=new Float32Array(3);else if(e&&i[0]===e[0]&&i[1]===e[1]&&i[2]===e[2])return;e?(i[0]=e[0],i[1]=e[1],i[2]=e[2]):(i[0]=1,i[1]=1,i[2]=1),this.glRedraw()}get specular(){return this._state.specular}set emissive(e){let i=this._state.emissive;if(!i)i=this._state.emissive=new Float32Array(3);else if(e&&i[0]===e[0]&&i[1]===e[1]&&i[2]===e[2])return;e?(i[0]=e[0],i[1]=e[1],i[2]=e[2]):(i[0]=0,i[1]=0,i[2]=0),this.glRedraw()}get emissive(){return this._state.emissive}set alpha(e){e=e??1,this._state.alpha!==e&&(this._state.alpha=e,this.glRedraw())}get alpha(){return this._state.alpha}set shininess(e){this._state.shininess=e!==void 0?e:80,this.glRedraw()}get shininess(){return this._state.shininess}set lineWidth(e){this._state.lineWidth=e||1,this.glRedraw()}get lineWidth(){return this._state.lineWidth}set pointSize(e){this._state.pointSize=e||1,this.glRedraw()}get pointSize(){return this._state.pointSize}set reflectivity(e){this._state.reflectivity=e!==void 0?e:1,this.glRedraw()}get reflectivity(){return this._state.reflectivity}get normalMap(){return this._normalMap}get ambientMap(){return this._ambientMap}get diffuseMap(){return this._diffuseMap}get specularMap(){return this._specularMap}get emissiveMap(){return this._emissiveMap}get alphaMap(){return this._alphaMap}get reflectivityMap(){return this._reflectivityMap}get occlusionMap(){return this._occlusionMap}get diffuseFresnel(){return this._diffuseFresnel}get specularFresnel(){return this._specularFresnel}get emissiveFresnel(){return this._emissiveFresnel}get alphaFresnel(){return this._alphaFresnel}get reflectivityFresnel(){return this._reflectivityFresnel}set alphaMode(e){e=e||"opaque";let i=A_[e];i===void 0&&(this.error("Unsupported value for 'alphaMode': "+e+" - defaulting to 'opaque'"),i="opaque"),this._state.alphaMode!==i&&(this._state.alphaMode=i,this.glRedraw())}get alphaMode(){return l_[this._state.alphaMode]}set alphaCutoff(e){e==null&&(e=.5),this._state.alphaCutoff!==e&&(this._state.alphaCutoff=e)}get alphaCutoff(){return this._state.alphaCutoff}set backfaces(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this.glRedraw())}get backfaces(){return this._state.backfaces}set frontface(e){e=e!=="cw",this._state.frontface!==e&&(this._state.frontface=e,this.glRedraw())}get frontface(){return this._state.frontface?"ccw":"cw"}destroy(){super.destroy(),this._state.destroy()}}const ya={default:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1},defaultWhiteBG:{fill:!0,fillColor:[1,1,1],fillAlpha:.6,edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1},defaultDarkBG:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.5,.5,.5],edgeAlpha:.5,edgeWidth:1},phosphorous:{fill:!0,fillColor:[0,0,0],fillAlpha:.4,edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:2},sunset:{fill:!0,fillColor:[.9,.9,.6],fillAlpha:.2,edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:1},vectorscope:{fill:!0,fillColor:[0,0,0],fillAlpha:.7,edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:2},battlezone:{fill:!0,fillColor:[0,0,0],fillAlpha:1,edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:3},sepia:{fill:!0,fillColor:[.970588207244873,.7965892553329468,.6660899519920349],fillAlpha:.4,edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1},yellowHighlight:{fill:!0,fillColor:[1,1,0],fillAlpha:.5,edges:!0,edgeColor:[1,1,1],edgeAlpha:1,edgeWidth:1},greenSelected:{fill:!0,fillColor:[0,1,0],fillAlpha:.5,edges:!0,edgeColor:[1,1,1],edgeAlpha:1,edgeWidth:1},gamegrid:{fill:!0,fillColor:[.2,.2,.7],fillAlpha:.9,edges:!0,edgeColor:[.4,.4,1.6],edgeAlpha:.8,edgeWidth:3}};class xa extends co{get type(){return"EmphasisMaterial"}get presets(){return ya}constructor(e,i={}){super(e,i),this._state=new Ft({type:"EmphasisMaterial",fill:null,fillColor:null,fillAlpha:null,edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null,backfaces:!0,glowThrough:!0}),this._preset="default",i.preset?(this.preset=i.preset,i.fill!==void 0&&(this.fill=i.fill),i.fillColor&&(this.fillColor=i.fillColor),i.fillAlpha!==void 0&&(this.fillAlpha=i.fillAlpha),i.edges!==void 0&&(this.edges=i.edges),i.edgeColor&&(this.edgeColor=i.edgeColor),i.edgeAlpha!==void 0&&(this.edgeAlpha=i.edgeAlpha),i.edgeWidth!==void 0&&(this.edgeWidth=i.edgeWidth),i.backfaces!==void 0&&(this.backfaces=i.backfaces),i.glowThrough!==void 0&&(this.glowThrough=i.glowThrough)):(this.fill=i.fill,this.fillColor=i.fillColor,this.fillAlpha=i.fillAlpha,this.edges=i.edges,this.edgeColor=i.edgeColor,this.edgeAlpha=i.edgeAlpha,this.edgeWidth=i.edgeWidth,this.backfaces=i.backfaces,this.glowThrough=i.glowThrough)}set fill(e){e=e!==!1,this._state.fill!==e&&(this._state.fill=e,this.glRedraw())}get fill(){return this._state.fill}set fillColor(e){let i=this._state.fillColor;if(!i)i=this._state.fillColor=new Float32Array(3);else if(e&&i[0]===e[0]&&i[1]===e[1]&&i[2]===e[2])return;e?(i[0]=e[0],i[1]=e[1],i[2]=e[2]):(i[0]=.4,i[1]=.4,i[2]=.4),this.glRedraw()}get fillColor(){return this._state.fillColor}set fillAlpha(e){e=e??.2,this._state.fillAlpha!==e&&(this._state.fillAlpha=e,this.glRedraw())}get fillAlpha(){return this._state.fillAlpha}set edges(e){e=e!==!1,this._state.edges!==e&&(this._state.edges=e,this.glRedraw())}get edges(){return this._state.edges}set edgeColor(e){let i=this._state.edgeColor;if(!i)i=this._state.edgeColor=new Float32Array(3);else if(e&&i[0]===e[0]&&i[1]===e[1]&&i[2]===e[2])return;e?(i[0]=e[0],i[1]=e[1],i[2]=e[2]):(i[0]=.2,i[1]=.2,i[2]=.2),this.glRedraw()}get edgeColor(){return this._state.edgeColor}set edgeAlpha(e){e=e??.5,this._state.edgeAlpha!==e&&(this._state.edgeAlpha=e,this.glRedraw())}get edgeAlpha(){return this._state.edgeAlpha}set edgeWidth(e){this._state.edgeWidth=e||1,this.glRedraw()}get edgeWidth(){return this._state.edgeWidth}set backfaces(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this.glRedraw())}get backfaces(){return this._state.backfaces}set glowThrough(e){e=e!==!1,this._state.glowThrough!==e&&(this._state.glowThrough=e,this.glRedraw())}get glowThrough(){return this._state.glowThrough}set preset(e){if(e=e||"default",this._preset===e)return;const i=ya[e];if(!i){this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(ya).join(", "));return}this.fill=i.fill,this.fillColor=i.fillColor,this.fillAlpha=i.fillAlpha,this.edges=i.edges,this.edgeColor=i.edgeColor,this.edgeAlpha=i.edgeAlpha,this.edgeWidth=i.edgeWidth,this.glowThrough=i.glowThrough,this._preset=e}get preset(){return this._preset}destroy(){super.destroy(),this._state.destroy()}}const wa={default:{edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1},defaultWhiteBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultDarkBG:{edgeColor:[.5,.5,.5],edgeAlpha:1,edgeWidth:1}};class c_ extends co{get type(){return"EdgeMaterial"}get presets(){return wa}constructor(e,i={}){super(e,i),this._state=new Ft({type:"EdgeMaterial",edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null}),this._preset="default",i.preset?(this.preset=i.preset,i.edgeColor&&(this.edgeColor=i.edgeColor),i.edgeAlpha!==void 0&&(this.edgeAlpha=i.edgeAlpha),i.edgeWidth!==void 0&&(this.edgeWidth=i.edgeWidth)):(this.edgeColor=i.edgeColor,this.edgeAlpha=i.edgeAlpha,this.edgeWidth=i.edgeWidth),this.edges=i.edges!==!1}set edges(e){e=e!==!1,this._state.edges!==e&&(this._state.edges=e,this.glRedraw())}get edges(){return this._state.edges}set edgeColor(e){let i=this._state.edgeColor;if(!i)i=this._state.edgeColor=new Float32Array(3);else if(e&&i[0]===e[0]&&i[1]===e[1]&&i[2]===e[2])return;e?(i[0]=e[0],i[1]=e[1],i[2]=e[2]):(i[0]=.2,i[1]=.2,i[2]=.2),this.glRedraw()}get edgeColor(){return this._state.edgeColor}set edgeAlpha(e){e=e??1,this._state.edgeAlpha!==e&&(this._state.edgeAlpha=e,this.glRedraw())}get edgeAlpha(){return this._state.edgeAlpha}set edgeWidth(e){this._state.edgeWidth=e||1,this.glRedraw()}get edgeWidth(){return this._state.edgeWidth}set preset(e){if(e=e||"default",this._preset===e)return;const i=wa[e];if(!i){this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(wa).join(", "));return}this.edgeColor=i.edgeColor,this.edgeAlpha=i.edgeAlpha,this.edgeWidth=i.edgeWidth,this._preset=e}get preset(){return this._preset}destroy(){super.destroy(),this._state.destroy()}}const Cc={meters:{abbrev:"m"},metres:{abbrev:"m"},centimeters:{abbrev:"cm"},centimetres:{abbrev:"cm"},millimeters:{abbrev:"mm"},millimetres:{abbrev:"mm"},yards:{abbrev:"yd"},feet:{abbrev:"ft"},inches:{abbrev:"in"}};class h_ extends Et{constructor(e,i={}){super(e,i),this._units="meters",this._scale=1,this._origin=c.vec3([0,0,0]),this.units=i.units,this.scale=i.scale,this.origin=i.origin}get unitsInfo(){return Cc}set units(e){e||(e="meters"),Cc[e]||(this.error("Unsupported value for 'units': "+e+" defaulting to 'meters'"),e="meters"),this._units=e,this.fire("units",this._units)}get units(){return this._units}set scale(e){if(e=e||1,e<=0){this.error("scale value should be larger than zero");return}this._scale=e,this.fire("scale",this._scale)}get scale(){return this._scale}set origin(e){if(!e){this._origin[0]=0,this._origin[1]=0,this._origin[2]=0;return}this._origin[0]=e[0],this._origin[1]=e[1],this._origin[2]=e[2],this.fire("origin",this._origin)}get origin(){return this._origin}worldToRealPos(e,i=c.vec3(3)){i[0]=this._origin[0]+this._scale*e[0],i[1]=this._origin[1]+this._scale*e[1],i[2]=this._origin[2]+this._scale*e[2]}realToWorldPos(e,i=c.vec3(3)){return i[0]=(e[0]-this._origin[0])/this._scale,i[1]=(e[1]-this._origin[1])/this._scale,i[2]=(e[2]-this._origin[2])/this._scale,i}}class u_ extends Et{constructor(e,i={}){super(e,i),this._supported=_t.SUPPORTED_EXTENSIONS.OES_standard_derivatives,this.enabled=i.enabled,this.kernelRadius=i.kernelRadius,this.intensity=i.intensity,this.bias=i.bias,this.scale=i.scale,this.minResolution=i.minResolution,this.numSamples=i.numSamples,this.blur=i.blur,this.blendCutoff=i.blendCutoff,this.blendFactor=i.blendFactor}get supported(){return this._supported}set enabled(e){e=!!e,this._enabled!==e&&(this._enabled=e,this.glRedraw())}get enabled(){return this._enabled}get possible(){if(!this._supported||!this._enabled)return!1;const e=this.scene.camera.projection;return!(e==="customProjection"||e==="frustum")}get active(){return this._active}set kernelRadius(e){e==null&&(e=100),this._kernelRadius!==e&&(this._kernelRadius=e,this.glRedraw())}get kernelRadius(){return this._kernelRadius}set intensity(e){e==null&&(e=.15),this._intensity!==e&&(this._intensity=e,this.glRedraw())}get intensity(){return this._intensity}set bias(e){e==null&&(e=.5),this._bias!==e&&(this._bias=e,this.glRedraw())}get bias(){return this._bias}set scale(e){e==null&&(e=1),this._scale!==e&&(this._scale=e,this.glRedraw())}get scale(){return this._scale}set minResolution(e){e==null&&(e=0),this._minResolution!==e&&(this._minResolution=e,this.glRedraw())}get minResolution(){return this._minResolution}set numSamples(e){e==null&&(e=10),this._numSamples!==e&&(this._numSamples=e,this.glRedraw())}get numSamples(){return this._numSamples}set blur(e){e=e!==!1,this._blur!==e&&(this._blur=e,this.glRedraw())}get blur(){return this._blur}set blendCutoff(e){e==null&&(e=.3),this._blendCutoff!==e&&(this._blendCutoff=e,this.glRedraw())}get blendCutoff(){return this._blendCutoff}set blendFactor(e){e==null&&(e=1),this._blendFactor!==e&&(this._blendFactor=e,this.glRedraw())}get blendFactor(){return this._blendFactor}destroy(){super.destroy()}}class d_ extends Et{constructor(e,i={}){super(e,i),this.sliceColor=i.sliceColor,this.sliceThickness=i.sliceThickness}set sliceThickness(e){e==null&&(e=0),this._sliceThickness!==e&&(this._sliceThickness=e,this.glRedraw())}get sliceThickness(){return this._sliceThickness}set sliceColor(e){e==null&&(e=[0,0,0,1]),this._sliceColor!==e&&(this._sliceColor=e,this.glRedraw())}get sliceColor(){return this._sliceColor}destroy(){super.destroy()}}const ba={default:{pointSize:4,roundPoints:!0,perspectivePoints:!0},square:{pointSize:4,roundPoints:!1,perspectivePoints:!0},round:{pointSize:4,roundPoints:!0,perspectivePoints:!0}};class p_ extends co{get type(){return"PointsMaterial"}get presets(){return ba}constructor(e,i={}){super(e,i),this._state=new Ft({type:"PointsMaterial",pointSize:null,roundPoints:null,perspectivePoints:null,minPerspectivePointSize:null,maxPerspectivePointSize:null,filterIntensity:null,minIntensity:null,maxIntensity:null}),i.preset?(this.preset=i.preset,i.pointSize!==void 0&&(this.pointSize=i.pointSize),i.roundPoints!==void 0&&(this.roundPoints=i.roundPoints),i.perspectivePoints!==void 0&&(this.perspectivePoints=i.perspectivePoints),i.minPerspectivePointSize!==void 0&&(this.minPerspectivePointSize=i.minPerspectivePointSize),i.maxPerspectivePointSize!==void 0&&(this.maxPerspectivePointSize=i.minPerspectivePointSize)):(this._preset="default",this.pointSize=i.pointSize,this.roundPoints=i.roundPoints,this.perspectivePoints=i.perspectivePoints,this.minPerspectivePointSize=i.minPerspectivePointSize,this.maxPerspectivePointSize=i.maxPerspectivePointSize),this.filterIntensity=i.filterIntensity,this.minIntensity=i.minIntensity,this.maxIntensity=i.maxIntensity}set pointSize(e){this._state.pointSize=e||2,this.glRedraw()}get pointSize(){return this._state.pointSize}set roundPoints(e){e=e!==!1,this._state.roundPoints!==e&&(this._state.roundPoints=e,this.scene._needRecompile=!0,this.glRedraw())}get roundPoints(){return this._state.roundPoints}set perspectivePoints(e){e=e!==!1,this._state.perspectivePoints!==e&&(this._state.perspectivePoints=e,this.scene._needRecompile=!0,this.glRedraw())}get perspectivePoints(){return this._state.perspectivePoints}set minPerspectivePointSize(e){this._state.minPerspectivePointSize=e||1,this.scene._needRecompile=!0,this.glRedraw()}get minPerspectivePointSize(){return this._state.minPerspectivePointSize}set maxPerspectivePointSize(e){this._state.maxPerspectivePointSize=e||6,this.scene._needRecompile=!0,this.glRedraw()}get maxPerspectivePointSize(){return this._state.maxPerspectivePointSize}set filterIntensity(e){e=e!==!1,this._state.filterIntensity!==e&&(this._state.filterIntensity=e,this.scene._needRecompile=!0,this.glRedraw())}get filterIntensity(){return this._state.filterIntensity}set minIntensity(e){this._state.minIntensity=e??0,this.glRedraw()}get minIntensity(){return this._state.minIntensity}set maxIntensity(e){this._state.maxIntensity=e??1,this.glRedraw()}get maxIntensity(){return this._state.maxIntensity}set preset(e){if(e=e||"default",this._preset===e)return;const i=ba[e];if(!i){this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(ba).join(", "));return}this.pointSize=i.pointSize,this.roundPoints=i.roundPoints,this.perspectivePoints=i.perspectivePoints,this.minPerspectivePointSize=i.minPerspectivePointSize,this.maxPerspectivePointSize=i.maxPerspectivePointSize,this._preset=e}get preset(){return this._preset}get hash(){return[this.pointSize,this.roundPoints,this.perspectivePoints,this.minPerspectivePointSize,this.maxPerspectivePointSize,this.filterIntensity].join(";")}destroy(){super.destroy(),this._state.destroy()}}const Ca={default:{lineWidth:1},thick:{lineWidth:2},thicker:{lineWidth:4}};class f_ extends co{get type(){return"LinesMaterial"}get presets(){return Ca}constructor(e,i={}){super(e,i),this._state=new Ft({type:"LinesMaterial",lineWidth:null}),i.preset?(this.preset=i.preset,i.lineWidth!==void 0&&(this.lineWidth=i.lineWidth)):(this._preset="default",this.lineWidth=i.lineWidth)}set lineWidth(e){this._state.lineWidth=e||1,this.glRedraw()}get lineWidth(){return this._state.lineWidth}set preset(e){if(e=e||"default",this._preset===e)return;const i=Ca[e];if(!i){this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(Ca).join(", "));return}this.lineWidth=i.lineWidth,this._preset=e}get preset(){return this._preset}get hash(){return[""+this.lineWidth].join(";")}destroy(){super.destroy(),this._state.destroy()}}function Ec(r,e){const i={};let s,t;for(let o=0,n=e.length;o<n;o++){if(s=e[o],t=r.components[s],!t){r.warn("pick(): Component not found: "+s);continue}if(!t.isEntity){r.warn("pick(): Component is not an Entity: "+s);continue}i[s]=!0}return i}class g_ extends Et{get type(){return"Scene"}constructor(e,i={}){super(null,i);const s=i.canvasElement||document.getElementById(i.canvasId);if(!(s instanceof HTMLCanvasElement))throw"Mandatory config expected: valid canvasId or canvasElement";this._tickifiedFunctions={};const t=!!i.transparent,o=!!i.alphaDepthMask;this._aabbDirty=!0,this.viewer=e,this.occlusionTestCountdown=0,this.loading=0,this.startTime=new Date().getTime(),this.models={},this.objects={},this._numObjects=0,this.visibleObjects={},this._numVisibleObjects=0,this.xrayedObjects={},this._numXRayedObjects=0,this.highlightedObjects={},this._numHighlightedObjects=0,this.selectedObjects={},this._numSelectedObjects=0,this.colorizedObjects={},this._numColorizedObjects=0,this.opacityObjects={},this._numOpacityObjects=0,this.offsetObjects={},this._numOffsetObjects=0,this._modelIds=null,this._objectIds=null,this._visibleObjectIds=null,this._xrayedObjectIds=null,this._highlightedObjectIds=null,this._selectedObjectIds=null,this._colorizedObjectIds=null,this._opacityObjectIds=null,this._offsetObjectIds=null,this._collidables={},this._compilables={},this._needRecompile=!1,this.types={},this.components={},this.sectionPlanes={},this.lights={},this.lightMaps={},this.reflectionMaps={},this.bitmaps={},this.lineSets={},this.realWorldOffset=i.realWorldOffset||new Float64Array([0,0,0]),this.canvas=new mm(this,{dontClear:!0,canvas:s,spinnerElementId:i.spinnerElementId,transparent:t,webgl2:i.webgl2!==!1,contextAttr:i.contextAttr||{},backgroundColor:i.backgroundColor,backgroundColorFromAmbientLight:i.backgroundColorFromAmbientLight,premultipliedAlpha:i.premultipliedAlpha}),this.canvas.on("boundary",()=>{this.glRedraw()}),this.canvas.on("webglContextFailed",()=>{alert("xeokit failed to find WebGL!")}),this._renderer=new Rm(this,{transparent:t,alphaDepthMask:o}),this._sectionPlanesState=new function(){this.sectionPlanes=[],this.clippingCaps=!1,this._numCachedSectionPlanes=0;let n=null;this.getHash=function(){if(n)return n;const a=this.getNumAllocatedSectionPlanes();if(this.sectionPlanes,a===0)return this.hash=";";const A=[];for(let l=0,h=a;l<h;l++)A.push("cp");return A.push(";"),n=A.join(""),n},this.addSectionPlane=function(a){this.sectionPlanes.push(a),n=null},this.removeSectionPlane=function(a){for(let A=0,l=this.sectionPlanes.length;A<l;A++)if(this.sectionPlanes[A].id===a.id){this.sectionPlanes.splice(A,1),n=null;return}},this.setNumCachedSectionPlanes=function(a){this._numCachedSectionPlanes=a,n=null},this.getNumCachedSectionPlanes=function(){return this._numCachedSectionPlanes},this.getNumAllocatedSectionPlanes=function(){const a=this.sectionPlanes.length;return a>this._numCachedSectionPlanes?a:this._numCachedSectionPlanes}},this._sectionPlanesState.setNumCachedSectionPlanes(i.numCachedSectionPlanes||0),this._lightsState=new function(){const n=c.vec4([0,0,0,0]),a=c.vec4();this.lights=[],this.reflectionMaps=[],this.lightMaps=[];let A=null,l=null;this.getHash=function(){if(A)return A;const h=[],d=this.lights;let f;for(let m=0,_=d.length;m<_;m++)f=d[m],h.push("/"),h.push(f.type),h.push(f.space==="world"?"w":"v"),f.castsShadow&&h.push("sh");return this.lightMaps.length>0&&h.push("/lm"),this.reflectionMaps.length>0&&h.push("/rm"),h.push(";"),A=h.join(""),A},this.addLight=function(h){this.lights.push(h),l=null,A=null},this.removeLight=function(h){for(let d=0,f=this.lights.length;d<f;d++)if(this.lights[d].id===h.id){this.lights.splice(d,1),l&&l.id===h.id&&(l=null),A=null;return}},this.addReflectionMap=function(h){this.reflectionMaps.push(h),A=null},this.removeReflectionMap=function(h){for(let d=0,f=this.reflectionMaps.length;d<f;d++)if(this.reflectionMaps[d].id===h.id){this.reflectionMaps.splice(d,1),A=null;return}},this.addLightMap=function(h){this.lightMaps.push(h),A=null},this.removeLightMap=function(h){for(let d=0,f=this.lightMaps.length;d<f;d++)if(this.lightMaps[d].id===h.id){this.lightMaps.splice(d,1),A=null;return}},this.getAmbientColorAndIntensity=function(){if(!l)for(let h=0,d=this.lights.length;h<d;h++){const f=this.lights[h];if(f.type==="ambient"){l=f;break}}if(l){const h=l.color,d=l.intensity;return a[0]=h[0],a[1]=h[1],a[2]=h[2],a[3]=d,a}else return n}},this.input=new Lm(this,{dontClear:!0,element:this.canvas.canvas,keyboardEventsElement:i.keyboardEventsElement}),this.metrics=new h_(this,{units:i.units,scale:i.scale,origin:i.origin}),this.sao=new u_(this,{enabled:i.saoEnabled}),this.crossSections=new d_(this,{}),this.ticksPerRender=i.ticksPerRender,this.ticksPerOcclusionTest=i.ticksPerOcclusionTest,this.passes=i.passes,this.clearEachPass=i.clearEachPass,this.gammaInput=i.gammaInput,this.gammaOutput=i.gammaOutput,this.gammaFactor=i.gammaFactor,this._entityOffsetsEnabled=!!i.entityOffsetsEnabled,this._logarithmicDepthBufferEnabled=!!i.logarithmicDepthBufferEnabled,this._dtxEnabled=i.dtxEnabled!==!1,this._pbrEnabled=!!i.pbrEnabled,this._colorTextureEnabled=i.colorTextureEnabled!==!1,this._dtxEnabled=!!i.dtxEnabled,xt._addScene(this),this._initDefaults(),this._viewport=new Um(this,{id:"default.viewport",autoBoundary:!0,dontClear:!0}),this._camera=new Gm(this,{id:"default.camera",dontClear:!0}),new zm(this,{color:[1,1,1],intensity:.7}),new wc(this,{dir:[.8,-.5,-.5],color:[.67,.67,1],intensity:.7,space:"world"}),new wc(this,{dir:[-.8,-1,.5],color:[1,1,.9],intensity:.9,space:"world"}),this._camera.on("dirty",()=>{this._renderer.imageDirty()})}_initDefaults(){}_addComponent(e){if(e.id&&this.components[e.id]&&(this.error("Component "+Le.inQuotes(e.id)+" already exists in Scene - ignoring ID, will randomly-generate instead"),e.id=null),!e.id)for(window.nextID===void 0&&(window.nextID=0),e.id="__"+window.nextID++;this.components[e.id];)e.id=c.createUUID();this.components[e.id]=e;const i=e.type;let s=this.types[e.type];s||(s=this.types[i]={}),s[e.id]=e,e.compile&&(this._compilables[e.id]=e),e.isDrawable&&(this._renderer.addDrawable(e.id,e),this._collidables[e.id]=e)}_removeComponent(e){var i=e.id,s=e.type;delete this.components[i];const t=this.types[s];t&&(delete t[i],Le.isEmptyObject(t)&&delete this.types[s]),e.compile&&delete this._compilables[e.id],e.isDrawable&&(this._renderer.removeDrawable(e.id),delete this._collidables[e.id])}_sectionPlaneCreated(e){this.sectionPlanes[e.id]=e,this.scene._sectionPlanesState.addSectionPlane(e._state),this.scene.fire("sectionPlaneCreated",e,!0),this._needRecompile=!0}_bitmapCreated(e){this.bitmaps[e.id]=e,this.scene.fire("bitmapCreated",e,!0)}_lineSetCreated(e){this.lineSets[e.id]=e,this.scene.fire("lineSetCreated",e,!0)}_lightCreated(e){this.lights[e.id]=e,this.scene._lightsState.addLight(e._state),this._needRecompile=!0}_lightMapCreated(e){this.lightMaps[e.id]=e,this.scene._lightsState.addLightMap(e._state),this._needRecompile=!0}_reflectionMapCreated(e){this.reflectionMaps[e.id]=e,this.scene._lightsState.addReflectionMap(e._state),this._needRecompile=!0}_sectionPlaneDestroyed(e){delete this.sectionPlanes[e.id],this.scene._sectionPlanesState.removeSectionPlane(e._state),this.scene.fire("sectionPlaneDestroyed",e,!0),this._needRecompile=!0}_bitmapDestroyed(e){delete this.bitmaps[e.id],this.scene.fire("bitmapDestroyed",e,!0)}_lineSetDestroyed(e){delete this.lineSets[e.id],this.scene.fire("lineSetDestroyed",e,!0)}_lightDestroyed(e){delete this.lights[e.id],this.scene._lightsState.removeLight(e._state),this._needRecompile=!0}_lightMapDestroyed(e){delete this.lightMaps[e.id],this.scene._lightsState.removeLightMap(e._state),this._needRecompile=!0}_reflectionMapDestroyed(e){delete this.reflectionMaps[e.id],this.scene._lightsState.removeReflectionMap(e._state),this._needRecompile=!0}_registerModel(e){this.models[e.id]=e,this._modelIds=null}_deregisterModel(e){const i=e.id;delete this.models[i],this._modelIds=null,this.fire("modelUnloaded",i)}_registerObject(e){this.objects[e.id]=e,this._numObjects++,this._objectIds=null}_deregisterObject(e){delete this.objects[e.id],this._numObjects--,this._objectIds=null}_objectVisibilityUpdated(e,i=!0){e.visible?(this.visibleObjects[e.id]=e,this._numVisibleObjects++):(delete this.visibleObjects[e.id],this._numVisibleObjects--),this._visibleObjectIds=null,i&&this.fire("objectVisibility",e,!0)}_deRegisterVisibleObject(e){delete this.visibleObjects[e.id],this._numVisibleObjects--,this._visibleObjectIds=null}_objectXRayedUpdated(e,i=!0){e.xrayed?(this.xrayedObjects[e.id]=e,this._numXRayedObjects++):(delete this.xrayedObjects[e.id],this._numXRayedObjects--),this._xrayedObjectIds=null,i&&this.fire("objectXRayed",e,!0)}_deRegisterXRayedObject(e){delete this.xrayedObjects[e.id],this._numXRayedObjects--,this._xrayedObjectIds=null}_objectHighlightedUpdated(e){e.highlighted?(this.highlightedObjects[e.id]=e,this._numHighlightedObjects++):(delete this.highlightedObjects[e.id],this._numHighlightedObjects--),this._highlightedObjectIds=null}_deRegisterHighlightedObject(e){delete this.highlightedObjects[e.id],this._numHighlightedObjects--,this._highlightedObjectIds=null}_objectSelectedUpdated(e,i=!0){e.selected?(this.selectedObjects[e.id]=e,this._numSelectedObjects++):(delete this.selectedObjects[e.id],this._numSelectedObjects--),this._selectedObjectIds=null,i&&this.fire("objectSelected",e,!0)}_deRegisterSelectedObject(e){delete this.selectedObjects[e.id],this._numSelectedObjects--,this._selectedObjectIds=null}_objectColorizeUpdated(e,i){i?(this.colorizedObjects[e.id]=e,this._numColorizedObjects++):(delete this.colorizedObjects[e.id],this._numColorizedObjects--),this._colorizedObjectIds=null}_deRegisterColorizedObject(e){delete this.colorizedObjects[e.id],this._numColorizedObjects--,this._colorizedObjectIds=null}_objectOpacityUpdated(e,i){i?(this.opacityObjects[e.id]=e,this._numOpacityObjects++):(delete this.opacityObjects[e.id],this._numOpacityObjects--),this._opacityObjectIds=null}_deRegisterOpacityObject(e){delete this.opacityObjects[e.id],this._numOpacityObjects--,this._opacityObjectIds=null}_objectOffsetUpdated(e,i){!i||i[0]===0&&i[1]===0&&i[2]===0?(this.offsetObjects[e.id]=e,this._numOffsetObjects++):(delete this.offsetObjects[e.id],this._numOffsetObjects--),this._offsetObjectIds=null}_deRegisterOffsetObject(e){delete this.offsetObjects[e.id],this._numOffsetObjects--,this._offsetObjectIds=null}_webglContextLost(){this.canvas.spinner.processes++;for(const e in this.components)if(this.components.hasOwnProperty(e)){const i=this.components[e];i._webglContextLost&&i._webglContextLost()}this._renderer.webglContextLost()}_webglContextRestored(){const e=this.canvas.gl;for(const i in this.components)if(this.components.hasOwnProperty(i)){const s=this.components[i];s._webglContextRestored&&s._webglContextRestored(e)}this._renderer.webglContextRestored(e),this.canvas.spinner.processes--}get capabilities(){return this._renderer.capabilities}get entityOffsetsEnabled(){return this._entityOffsetsEnabled}get pickSurfacePrecisionEnabled(){return!1}get logarithmicDepthBufferEnabled(){return this._logarithmicDepthBufferEnabled}set numCachedSectionPlanes(e){e=e||0,this._sectionPlanesState.getNumCachedSectionPlanes()!==e&&(this._sectionPlanesState.setNumCachedSectionPlanes(e),this._needRecompile=!0,this.glRedraw())}get numCachedSectionPlanes(){return this._sectionPlanesState.getNumCachedSectionPlanes()}set pbrEnabled(e){this._pbrEnabled=!!e,this.glRedraw()}get pbrEnabled(){return this._pbrEnabled}set dtxEnabled(e){e=!!e,this._dtxEnabled!==e&&(this._dtxEnabled=e)}get dtxEnabled(){return this._dtxEnabled}set colorTextureEnabled(e){this._colorTextureEnabled=!!e,this.glRedraw()}get colorTextureEnabled(){return this._colorTextureEnabled}doOcclusionTest(){this._needRecompile&&(this._recompile(),this._needRecompile=!1),this._renderer.doOcclusionTest()}render(e){e&&xt.runTasks();const i={sceneId:null,pass:0};if(this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1),!e&&!this._renderer.needsRender())return;i.sceneId=this.id;const s=this._passes,t=this._clearEachPass;let o,n;for(o=0;o<s;o++)i.pass=o,this.fire("rendering",i,!0),n=t||o===0,this._renderer.render({pass:o,clear:n,force:e}),this.fire("rendered",i,!0);this._saveAmbientColor()}compile(){this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1)}_recompile(){for(const e in this._compilables)this._compilables.hasOwnProperty(e)&&this._compilables[e].compile();this._renderer.shadowsDirty(),this.fire("compile",this,!0)}_saveAmbientColor(){const e=this.canvas;if(!e.transparent&&!e.backgroundImage&&!e.backgroundColor){const i=this._lightsState.getAmbientColorAndIntensity();(!this._lastAmbientColor||this._lastAmbientColor[0]!==i[0]||this._lastAmbientColor[1]!==i[1]||this._lastAmbientColor[2]!==i[2]||this._lastAmbientColor[3]!==i[3])&&(e.backgroundColor=i,this._lastAmbientColor||(this._lastAmbientColor=c.vec4([0,0,0,1])),this._lastAmbientColor.set(i))}else this._lastAmbientColor=null}get modelIds(){return this._modelIds||(this._modelIds=Object.keys(this.models)),this._modelIds}get numObjects(){return this._numObjects}get objectIds(){return this._objectIds||(this._objectIds=Object.keys(this.objects)),this._objectIds}get numVisibleObjects(){return this._numVisibleObjects}get visibleObjectIds(){return this._visibleObjectIds||(this._visibleObjectIds=Object.keys(this.visibleObjects)),this._visibleObjectIds}get numXRayedObjects(){return this._numXRayedObjects}get xrayedObjectIds(){return this._xrayedObjectIds||(this._xrayedObjectIds=Object.keys(this.xrayedObjects)),this._xrayedObjectIds}get numHighlightedObjects(){return this._numHighlightedObjects}get highlightedObjectIds(){return this._highlightedObjectIds||(this._highlightedObjectIds=Object.keys(this.highlightedObjects)),this._highlightedObjectIds}get numSelectedObjects(){return this._numSelectedObjects}get selectedObjectIds(){return this._selectedObjectIds||(this._selectedObjectIds=Object.keys(this.selectedObjects)),this._selectedObjectIds}get numColorizedObjects(){return this._numColorizedObjects}get colorizedObjectIds(){return this._colorizedObjectIds||(this._colorizedObjectIds=Object.keys(this.colorizedObjects)),this._colorizedObjectIds}get opacityObjectIds(){return this._opacityObjectIds||(this._opacityObjectIds=Object.keys(this.opacityObjects)),this._opacityObjectIds}get offsetObjectIds(){return this._offsetObjectIds||(this._offsetObjectIds=Object.keys(this.offsetObjects)),this._offsetObjectIds}set ticksPerRender(e){e==null?e=1:(!Le.isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'ticksPerRender': '"+e+"' - should be an integer greater than zero."),e=1),e!==this._ticksPerRender&&(this._ticksPerRender=e)}get ticksPerRender(){return this._ticksPerRender}set ticksPerOcclusionTest(e){e==null?e=20:(!Le.isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'ticksPerOcclusionTest': '"+e+"' - should be an integer greater than zero."),e=20),e!==this._ticksPerOcclusionTest&&(this._ticksPerOcclusionTest=e)}get ticksPerOcclusionTest(){return this._ticksPerOcclusionTest}set passes(e){e==null?e=1:(!Le.isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'passes': '"+e+"' - should be an integer greater than zero."),e=1),e!==this._passes&&(this._passes=e,this.glRedraw())}get passes(){return this._passes}set clearEachPass(e){e=!!e,e!==this._clearEachPass&&(this._clearEachPass=e,this.glRedraw())}get clearEachPass(){return this._clearEachPass}set gammaInput(e){e=e!==!1,e!==this._renderer.gammaInput&&(this._renderer.gammaInput=e,this._needRecompile=!0,this.glRedraw())}get gammaInput(){return this._renderer.gammaInput}set gammaOutput(e){e=!!e,e!==this._renderer.gammaOutput&&(this._renderer.gammaOutput=e,this._needRecompile=!0,this.glRedraw())}get gammaOutput(){return this._renderer.gammaOutput}set gammaFactor(e){e=e??2.2,e!==this._renderer.gammaFactor&&(this._renderer.gammaFactor=e,this.glRedraw())}get gammaFactor(){return this._renderer.gammaFactor}get geometry(){return this.components["default.geometry"]||a_(n_)}get material(){return this.components["default.material"]||new pp(this,{id:"default.material",emissive:[.4,.4,.4],dontClear:!0})}get xrayMaterial(){return this.components["default.xrayMaterial"]||new xa(this,{id:"default.xrayMaterial",preset:"sepia",dontClear:!0})}get highlightMaterial(){return this.components["default.highlightMaterial"]||new xa(this,{id:"default.highlightMaterial",preset:"yellowHighlight",dontClear:!0})}get selectedMaterial(){return this.components["default.selectedMaterial"]||new xa(this,{id:"default.selectedMaterial",preset:"greenSelected",dontClear:!0})}get edgeMaterial(){return this.components["default.edgeMaterial"]||new c_(this,{id:"default.edgeMaterial",preset:"default",edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1,dontClear:!0})}get pointsMaterial(){return this.components["default.pointsMaterial"]||new p_(this,{id:"default.pointsMaterial",preset:"default",dontClear:!0})}get linesMaterial(){return this.components["default.linesMaterial"]||new f_(this,{id:"default.linesMaterial",preset:"default",dontClear:!0})}get viewport(){return this._viewport}get camera(){return this._camera}get center(){if(this._aabbDirty||!this._center){(!this._center||!this._center)&&(this._center=c.vec3());const e=this.aabb;this._center[0]=(e[0]+e[3])/2,this._center[1]=(e[1]+e[4])/2,this._center[2]=(e[2]+e[5])/2}return this._center}get aabb(){if(this._aabbDirty){this._aabb||(this._aabb=c.AABB3());let e=c.MAX_DOUBLE,i=c.MAX_DOUBLE,s=c.MAX_DOUBLE,t=c.MIN_DOUBLE,o=c.MIN_DOUBLE,n=c.MIN_DOUBLE,a;const A=this._collidables;let l,h=!1;for(const d in A)if(A.hasOwnProperty(d)){if(l=A[d],l.collidable===!1)continue;a=l.aabb,a[0]<e&&(e=a[0]),a[1]<i&&(i=a[1]),a[2]<s&&(s=a[2]),a[3]>t&&(t=a[3]),a[4]>o&&(o=a[4]),a[5]>n&&(n=a[5]),h=!0}h||(e=-100,i=-100,s=-100,t=100,o=100,n=100),this._aabb[0]=e,this._aabb[1]=i,this._aabb[2]=s,this._aabb[3]=t,this._aabb[4]=o,this._aabb[5]=n,this._aabbDirty=!1}return this._aabb}_setAABBDirty(){this._aabbDirty=!0,this.fire("boundary")}pick(e,i){if(this.canvas.boundary[2]===0||this.canvas.boundary[3]===0)return this.error("Picking not allowed while canvas has zero width or height"),null;e=e||{},e.pickSurface=e.pickSurface||e.rayPick,!e.canvasPos&&!e.matrix&&(!e.origin||!e.direction)&&this.warn("picking without canvasPos, matrix, or ray origin and direction");const s=e.includeEntities||e.include;s&&(e.includeEntityIds=Ec(this,s));const t=e.excludeEntities||e.exclude;return t&&(e.excludeEntityIds=Ec(this,t)),this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1),e.snapToEdge||e.snapToVertex?i=this._renderer.snapPick(e.canvasPos,e.snapRadius||30,e.snapToVertex,e.snapToEdge,i):i=this._renderer.pick(e,i),i&&i.entity&&i.entity.fire&&i.entity.fire("picked",i),i}snapPick(e){return this._warnSnapPickDeprecated===void 0&&(this._warnSnapPickDeprecated=!0,this.warn("Scene.snapPick() is deprecated since v2.4.2 - use Scene.pick() instead")),this._renderer.snapPick(e.canvasPos,e.snapRadius||30,e.snapToVertex,e.snapToEdge)}clear(){var e;for(const i in this.components)this.components.hasOwnProperty(i)&&(e=this.components[i],e._dontClear||e.destroy())}clearLights(){const e=Object.keys(this.lights);for(let i=0,s=e.length;i<s;i++)this.lights[e[i]].destroy()}clearSectionPlanes(){const e=Object.keys(this.sectionPlanes);for(let i=0,s=e.length;i<s;i++)this.sectionPlanes[e[i]].destroy()}clearBitmaps(){const e=Object.keys(this.bitmaps);for(let i=0,s=e.length;i<s;i++)this.bitmaps[e[i]].destroy()}clearLines(){const e=Object.keys(this.lineSets);for(let i=0,s=e.length;i<s;i++)this.lineSets[e[i]].destroy()}getAABB(e){if(e===void 0)return this.aabb;if(Le.isString(e)){const l=this.objects[e];if(l&&l.aabb)return l.aabb;e=[e]}if(e.length===0)return this.aabb;let i=c.MAX_DOUBLE,s=c.MAX_DOUBLE,t=c.MAX_DOUBLE,o=c.MIN_DOUBLE,n=c.MIN_DOUBLE,a=c.MIN_DOUBLE,A;if(this.withObjects(e,l=>{if(l.collidable){const h=l.aabb;h[0]<i&&(i=h[0]),h[1]<s&&(s=h[1]),h[2]<t&&(t=h[2]),h[3]>o&&(o=h[3]),h[4]>n&&(n=h[4]),h[5]>a&&(a=h[5]),A=!0}}),A){const l=c.AABB3();return l[0]=i,l[1]=s,l[2]=t,l[3]=o,l[4]=n,l[5]=a,l}else return this.aabb}setObjectsVisible(e,i){return this.withObjects(e,s=>{const t=s.visible!==i;return s.visible=i,t})}setObjectsCollidable(e,i){return this.withObjects(e,s=>{const t=s.collidable!==i;return s.collidable=i,t})}setObjectsCulled(e,i){return this.withObjects(e,s=>{const t=s.culled!==i;return s.culled=i,t})}setObjectsSelected(e,i){return this.withObjects(e,s=>{const t=s.selected!==i;return s.selected=i,t})}setObjectsHighlighted(e,i){return this.withObjects(e,s=>{const t=s.highlighted!==i;return s.highlighted=i,t})}setObjectsXRayed(e,i){return this.withObjects(e,s=>{const t=s.xrayed!==i;return s.xrayed=i,t})}setObjectsEdges(e,i){return this.withObjects(e,s=>{const t=s.edges!==i;return s.edges=i,t})}setObjectsColorized(e,i){return this.withObjects(e,s=>{s.colorize=i})}setObjectsOpacity(e,i){return this.withObjects(e,s=>{const t=s.opacity!==i;return s.opacity=i,t})}setObjectsPickable(e,i){return this.withObjects(e,s=>{const t=s.pickable!==i;return s.pickable=i,t})}setObjectsOffset(e,i){this.withObjects(e,s=>{s.offset=i})}withObjects(e,i){Le.isString(e)&&(e=[e]);let s=!1;for(let t=0,o=e.length;t<o;t++){const n=e[t];let a=this.objects[n];if(a)s=i(a)||s;else{const A=this.modelIds;for(let l=0,h=A.length;l<h;l++){const d=A[l],f=c.globalizeObjectId(d,n);a=this.objects[f],a&&(s=i(a)||s)}}}return s}tickify(e){const i=e.toString();if(i in this._tickifiedFunctions)return this._tickifiedFunctions[i].wrapperFunc;let s=0,t=0,o;const n=function(...A){o=A,t++},a=this.on("tick",()=>{const A=t;A>s&&(s=A,e(...o))});return this._tickifiedFunctions[i]={tickSubId:a,wrapperFunc:n},n}destroy(){super.destroy();for(const e in this.components)this.components.hasOwnProperty(e)&&this.components[e].destroy();this.canvas.gl=null,this.components=null,this.models=null,this.objects=null,this.visibleObjects=null,this.xrayedObjects=null,this.highlightedObjects=null,this.selectedObjects=null,this.colorizedObjects=null,this.opacityObjects=null,this.sectionPlanes=null,this.lights=null,this.lightMaps=null,this.reflectionMaps=null,this._objectIds=null,this._visibleObjectIds=null,this._xrayedObjectIds=null,this._highlightedObjectIds=null,this._selectedObjectIds=null,this._colorizedObjectIds=null,this.types=null,this.components=null,this.canvas=null,this._renderer=null,this.input=null,this._viewport=null,this._camera=null}}const ui=1e3,_n=1001,Ea=1002,Bl=1003,fp=1004,m_=1004,__=1005,gp=1005,ys=1006,mp=1007,Zr=1008,v_=1008,_p=1009,P_=1010,B_=1011,y_=1012,x_=1013,w_=1014,b_=1015,C_=1016,E_=1017,I_=1018,F_=1020,M_=1021,S_=1022,Fn=1023,T_=1024,D_=1025,R_=1026,L_=1027,U_=1028,O_=1029,k_=1030,N_=1031,Q_=1033,vn=33776,Ia=33777,Fa=33778,Pn=33779,OA=35840,Ic=35841,kA=35842,Fc=35843,vp=36196,NA=37492,QA=37496,HA=37808,Mc=37809,Sc=37810,Tc=37811,Dc=37812,Rc=37813,Lc=37814,Uc=37815,Oc=37816,kc=37817,Nc=37818,Qc=37819,Hc=37820,Vc=37821,VA=36492,nr=3e3,Ct=3001,H_=10001,V_=10002,j_=function(r){r._material._state.type==="LambertMaterial"?(this.vertex=z_(r),this.fragment=K_(r)):(this.vertex=W_(r),this.fragment=X_(r))},is={};is[nr]="linearToLinear";is[Ct]="sRGBToLinear";function Pp(r){if(!r.receivesShadow)return!1;const e=r.scene._lightsState.lights;if(!e||e.length===0)return!1;for(let i=0,s=e.length;i<s;i++)if(e[i].castsShadow)return!0;return!1}function G_(r){if(!r._geometry._state.uvBuf)return!1;const e=r._material;return!!(e._ambientMap||e._occlusionMap||e._baseColorMap||e._diffuseMap||e._alphaMap||e._specularMap||e._glossinessMap||e._specularGlossinessMap||e._emissiveMap||e._metallicMap||e._roughnessMap||e._metallicRoughnessMap||e._reflectivityMap||e._normalMap)}function Bp(r){const e=r._geometry._state.primitiveName;return!!((r._geometry._state.autoVertexNormals||r._geometry._state.normalsBuf)&&(e==="triangles"||e==="triangle-strip"||e==="triangle-fan"))}function z_(r){const e=r.scene,i=r.scene._sectionPlanesState,s=r.scene._lightsState,t=r._geometry._state,o=r._state.billboard,n=r._state.stationary,a=i.getNumAllocatedSectionPlanes()>0,A=!!t.compressGeometry,l=[];if(l.push("#version 300 es"),l.push("// Lambertian drawing vertex shader"),l.push("in vec3 position;"),l.push("uniform mat4 modelMatrix;"),l.push("uniform mat4 viewMatrix;"),l.push("uniform mat4 projMatrix;"),l.push("uniform vec4 colorize;"),l.push("uniform vec3 offset;"),A&&l.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(l.push("uniform float logDepthBufFC;"),l.push("out float vFragDepth;"),l.push("bool isPerspectiveMatrix(mat4 m) {"),l.push("    return (m[2][3] == - 1.0);"),l.push("}"),l.push("out float isPerspective;")),a&&l.push("out vec4 vWorldPosition;"),l.push("uniform vec4 lightAmbient;"),l.push("uniform vec4 materialColor;"),l.push("uniform vec3 materialEmissive;"),t.normalsBuf){l.push("in vec3 normal;"),l.push("uniform mat4 modelNormalMatrix;"),l.push("uniform mat4 viewNormalMatrix;");for(let h=0,d=s.lights.length;h<d;h++){const f=s.lights[h];f.type!=="ambient"&&(l.push("uniform vec4 lightColor"+h+";"),f.type==="dir"&&l.push("uniform vec3 lightDir"+h+";"),f.type==="point"&&l.push("uniform vec3 lightPos"+h+";"),f.type==="spot"&&(l.push("uniform vec3 lightPos"+h+";"),l.push("uniform vec3 lightDir"+h+";")))}A&&(l.push("vec3 octDecode(vec2 oct) {"),l.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),l.push("    if (v.z < 0.0) {"),l.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),l.push("    }"),l.push("    return normalize(v);"),l.push("}"))}if(l.push("out vec4 vColor;"),t.primitiveName==="points"&&l.push("uniform float pointSize;"),(o==="spherical"||o==="cylindrical")&&(l.push("void billboard(inout mat4 mat) {"),l.push("   mat[0][0] = 1.0;"),l.push("   mat[0][1] = 0.0;"),l.push("   mat[0][2] = 0.0;"),o==="spherical"&&(l.push("   mat[1][0] = 0.0;"),l.push("   mat[1][1] = 1.0;"),l.push("   mat[1][2] = 0.0;")),l.push("   mat[2][0] = 0.0;"),l.push("   mat[2][1] = 0.0;"),l.push("   mat[2][2] =1.0;"),l.push("}")),l.push("void main(void) {"),l.push("vec4 localPosition = vec4(position, 1.0); "),l.push("vec4 worldPosition;"),A&&l.push("localPosition = positionsDecodeMatrix * localPosition;"),t.normalsBuf&&(A?l.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):l.push("vec4 localNormal = vec4(normal, 0.0); "),l.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),l.push("mat4 viewNormalMatrix2 = viewNormalMatrix;")),l.push("mat4 viewMatrix2 = viewMatrix;"),l.push("mat4 modelMatrix2 = modelMatrix;"),n&&l.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),o==="spherical"||o==="cylindrical"?(l.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),l.push("billboard(modelMatrix2);"),l.push("billboard(viewMatrix2);"),l.push("billboard(modelViewMatrix);"),t.normalsBuf&&(l.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),l.push("billboard(modelNormalMatrix2);"),l.push("billboard(viewNormalMatrix2);"),l.push("billboard(modelViewNormalMatrix);")),l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("worldPosition.xyz = worldPosition.xyz + offset;"),l.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("worldPosition.xyz = worldPosition.xyz + offset;"),l.push("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),t.normalsBuf&&l.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);"),l.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),l.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),l.push("float lambertian = 1.0;"),t.normalsBuf)for(let h=0,d=s.lights.length;h<d;h++){const f=s.lights[h];if(f.type!=="ambient"){if(f.type==="dir")f.space==="view"?l.push("viewLightDir = normalize(lightDir"+h+");"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+h+", 0.0)).xyz);");else if(f.type==="point")f.space==="view"?l.push("viewLightDir = -normalize(lightPos"+h+" - viewPosition.xyz);"):l.push("viewLightDir = -normalize((viewMatrix2 * vec4(lightPos"+h+", 0.0)).xyz);");else if(f.type==="spot")f.space==="view"?l.push("viewLightDir = normalize(lightDir"+h+");"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+h+", 0.0)).xyz);");else continue;l.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),l.push("reflectedColor += lambertian * (lightColor"+h+".rgb * lightColor"+h+".a);")}}return l.push("vColor = vec4((lightAmbient.rgb * lightAmbient.a * materialColor.rgb) + materialEmissive.rgb + (reflectedColor * materialColor.rgb), materialColor.a) * colorize;"),a&&l.push("vWorldPosition = worldPosition;"),t.primitiveName==="points"&&l.push("gl_PointSize = pointSize;"),l.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(l.push("vFragDepth = 1.0 + clipPos.w;"),l.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),l.push("gl_Position = clipPos;"),l.push("}"),l}function K_(r){const e=r.scene,i=e._sectionPlanesState;r._material._state;const s=r._geometry._state,t=i.getNumAllocatedSectionPlanes()>0,o=e.gammaOutput,n=[];if(n.push("#version 300 es"),n.push("// Lambertian drawing fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),t){n.push("in vec4 vWorldPosition;"),n.push("uniform bool clippable;");for(let a=0,A=i.getNumAllocatedSectionPlanes();a<A;a++)n.push("uniform bool sectionPlaneActive"+a+";"),n.push("uniform vec3 sectionPlanePos"+a+";"),n.push("uniform vec3 sectionPlaneDir"+a+";")}if(n.push("in vec4 vColor;"),o&&(n.push("uniform float gammaFactor;"),n.push("    vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),n.push("    return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),n.push("}")),n.push("out vec4 outColor;"),n.push("void main(void) {"),t){n.push("if (clippable) {"),n.push("  float dist = 0.0;");for(let a=0,A=i.getNumAllocatedSectionPlanes();a<A;a++)n.push("if (sectionPlaneActive"+a+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > 0.0) { discard; }"),n.push("}")}return s.primitiveName==="points"&&(n.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),n.push("float r = dot(cxy, cxy);"),n.push("if (r > 1.0) {"),n.push("   discard;"),n.push("}")),e.logarithmicDepthBufferEnabled&&n.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),o?n.push("outColor = linearToGamma(vColor, gammaFactor);"):n.push("outColor = vColor;"),n.push("}"),n}function W_(r){const e=r.scene;r._material;const i=r._state,s=e._sectionPlanesState,t=r._geometry._state,o=e._lightsState;let n;const a=i.billboard,A=i.background,l=i.stationary,h=G_(r),d=Bp(r),f=s.getNumAllocatedSectionPlanes()>0,m=Pp(r),_=!!t.compressGeometry,u=[];if(u.push("#version 300 es"),u.push("// Drawing vertex shader"),u.push("in  vec3 position;"),_&&u.push("uniform mat4 positionsDecodeMatrix;"),u.push("uniform  mat4 modelMatrix;"),u.push("uniform  mat4 viewMatrix;"),u.push("uniform  mat4 projMatrix;"),u.push("out  vec3 vViewPosition;"),u.push("uniform  vec3 offset;"),f&&u.push("out vec4 vWorldPosition;"),e.logarithmicDepthBufferEnabled&&(u.push("uniform float logDepthBufFC;"),u.push("out float vFragDepth;"),u.push("bool isPerspectiveMatrix(mat4 m) {"),u.push("    return (m[2][3] == - 1.0);"),u.push("}"),u.push("out float isPerspective;")),o.lightMaps.length>0&&u.push("out    vec3 vWorldNormal;"),d){u.push("in  vec3 normal;"),u.push("uniform    mat4 modelNormalMatrix;"),u.push("uniform    mat4 viewNormalMatrix;"),u.push("out    vec3 vViewNormal;");for(let P=0,y=o.lights.length;P<y;P++)n=o.lights[P],n.type!=="ambient"&&(n.type==="dir"&&u.push("uniform vec3 lightDir"+P+";"),n.type==="point"&&u.push("uniform vec3 lightPos"+P+";"),n.type==="spot"&&(u.push("uniform vec3 lightPos"+P+";"),u.push("uniform vec3 lightDir"+P+";")),n.type==="dir"&&n.space==="view"||u.push("out vec4 vViewLightReverseDirAndDist"+P+";"));_&&(u.push("vec3 octDecode(vec2 oct) {"),u.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),u.push("    if (v.z < 0.0) {"),u.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),u.push("    }"),u.push("    return normalize(v);"),u.push("}"))}if(h&&(u.push("in vec2 uv;"),u.push("out vec2 vUV;"),_&&u.push("uniform mat3 uvDecodeMatrix;")),t.colors&&(u.push("in vec4 color;"),u.push("out vec4 vColor;")),t.primitiveName==="points"&&u.push("uniform float pointSize;"),(a==="spherical"||a==="cylindrical")&&(u.push("void billboard(inout mat4 mat) {"),u.push("   mat[0][0] = 1.0;"),u.push("   mat[0][1] = 0.0;"),u.push("   mat[0][2] = 0.0;"),a==="spherical"&&(u.push("   mat[1][0] = 0.0;"),u.push("   mat[1][1] = 1.0;"),u.push("   mat[1][2] = 0.0;")),u.push("   mat[2][0] = 0.0;"),u.push("   mat[2][1] = 0.0;"),u.push("   mat[2][2] =1.0;"),u.push("}")),m){u.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);");for(let P=0,y=o.lights.length;P<y;P++)o.lights[P].castsShadow&&(u.push("uniform mat4 shadowViewMatrix"+P+";"),u.push("uniform mat4 shadowProjMatrix"+P+";"),u.push("out vec4 vShadowPosFromLight"+P+";"))}if(u.push("void main(void) {"),u.push("vec4 localPosition = vec4(position, 1.0); "),u.push("vec4 worldPosition;"),_&&u.push("localPosition = positionsDecodeMatrix * localPosition;"),d&&(_?u.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):u.push("vec4 localNormal = vec4(normal, 0.0); "),u.push("mat4 modelNormalMatrix2    = modelNormalMatrix;"),u.push("mat4 viewNormalMatrix2     = viewNormalMatrix;")),u.push("mat4 viewMatrix2           = viewMatrix;"),u.push("mat4 modelMatrix2          = modelMatrix;"),l?u.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"):A&&u.push("viewMatrix2[3] = vec4(0.0, 0.0, 0.0 ,1.0);"),a==="spherical"||a==="cylindrical"?(u.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),u.push("billboard(modelMatrix2);"),u.push("billboard(viewMatrix2);"),u.push("billboard(modelViewMatrix);"),d&&(u.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),u.push("billboard(modelNormalMatrix2);"),u.push("billboard(viewNormalMatrix2);"),u.push("billboard(modelViewNormalMatrix);")),u.push("worldPosition = modelMatrix2 * localPosition;"),u.push("worldPosition.xyz = worldPosition.xyz + offset;"),u.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(u.push("worldPosition = modelMatrix2 * localPosition;"),u.push("worldPosition.xyz = worldPosition.xyz + offset;"),u.push("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),d){u.push("vec3 worldNormal = (modelNormalMatrix2 * localNormal).xyz; "),o.lightMaps.length>0&&u.push("vWorldNormal = worldNormal;"),u.push("vViewNormal = normalize((viewNormalMatrix2 * vec4(worldNormal, 1.0)).xyz);"),u.push("vec3 tmpVec3;"),u.push("float lightDist;");for(let P=0,y=o.lights.length;P<y;P++)n=o.lights[P],n.type!=="ambient"&&(n.type==="dir"&&n.space==="world"&&(u.push("tmpVec3 = vec3(viewMatrix2 * vec4(lightDir"+P+", 0.0) ).xyz;"),u.push("vViewLightReverseDirAndDist"+P+" = vec4(-tmpVec3, 0.0);")),n.type==="point"&&(n.space==="world"?(u.push("tmpVec3 = (viewMatrix2 * vec4(lightPos"+P+", 1.0)).xyz - viewPosition.xyz;"),u.push("lightDist = abs(length(tmpVec3));")):(u.push("tmpVec3 = lightPos"+P+".xyz - viewPosition.xyz;"),u.push("lightDist = abs(length(tmpVec3));")),u.push("vViewLightReverseDirAndDist"+P+" = vec4(tmpVec3, lightDist);")))}if(h&&(_?u.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"):u.push("vUV = uv;")),t.colors&&u.push("vColor = color;"),t.primitiveName==="points"&&u.push("gl_PointSize = pointSize;"),f&&u.push("vWorldPosition = worldPosition;"),u.push("   vViewPosition = viewPosition.xyz;"),u.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(u.push("vFragDepth = 1.0 + clipPos.w;"),u.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),A&&u.push("clipPos.z = clipPos.w;"),u.push("gl_Position = clipPos;"),m){u.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);"),u.push("vec4 tempx; ");for(let P=0,y=o.lights.length;P<y;P++)o.lights[P].castsShadow&&u.push("vShadowPosFromLight"+P+" = texUnitConverter * shadowProjMatrix"+P+" * (shadowViewMatrix"+P+" * worldPosition); ")}return u.push("}"),u}function X_(r){const e=r.scene;e.canvas.gl;const i=r._material,s=r._geometry._state,t=r.scene._sectionPlanesState,o=r.scene._lightsState,n=r._material._state,a=t.getNumAllocatedSectionPlanes()>0,A=Bp(r),l=s.uvBuf,h=n.type==="PhongMaterial",d=n.type==="MetallicMaterial",f=n.type==="SpecularMaterial",m=Pp(r);e.gammaInput;const _=e.gammaOutput,u=[];if(u.push("#version 300 es"),u.push("// Drawing fragment shader"),u.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),u.push("precision highp float;"),u.push("precision highp int;"),u.push("#else"),u.push("precision mediump float;"),u.push("precision mediump int;"),u.push("#endif"),e.logarithmicDepthBufferEnabled&&(u.push("in float isPerspective;"),u.push("uniform float logDepthBufFC;"),u.push("in float vFragDepth;")),m&&(u.push("float unpackDepth (vec4 color) {"),u.push("  const vec4 bitShift = vec4(1.0, 1.0/256.0, 1.0/(256.0 * 256.0), 1.0/(256.0*256.0*256.0));"),u.push("  return dot(color, bitShift);"),u.push("}")),u.push("uniform float gammaFactor;"),u.push("vec4 linearToLinear( in vec4 value ) {"),u.push("  return value;"),u.push("}"),u.push("vec4 sRGBToLinear( in vec4 value ) {"),u.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),u.push("}"),u.push("vec4 gammaToLinear( in vec4 value) {"),u.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),u.push("}"),_&&(u.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),u.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),u.push("}")),a){u.push("in vec4 vWorldPosition;"),u.push("uniform bool clippable;");for(var P=0;P<t.getNumAllocatedSectionPlanes();P++)u.push("uniform bool sectionPlaneActive"+P+";"),u.push("uniform vec3 sectionPlanePos"+P+";"),u.push("uniform vec3 sectionPlaneDir"+P+";")}if(A&&(o.lightMaps.length>0&&(u.push("uniform samplerCube lightMap;"),u.push("uniform mat4 viewNormalMatrix;")),o.reflectionMaps.length>0&&u.push("uniform samplerCube reflectionMap;"),(o.lightMaps.length>0||o.reflectionMaps.length>0)&&u.push("uniform mat4 viewMatrix;"),u.push("#define PI 3.14159265359"),u.push("#define RECIPROCAL_PI 0.31830988618"),u.push("#define RECIPROCAL_PI2 0.15915494"),u.push("#define EPSILON 1e-6"),u.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),u.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),u.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),u.push("}"),u.push("struct IncidentLight {"),u.push("   vec3 color;"),u.push("   vec3 direction;"),u.push("};"),u.push("struct ReflectedLight {"),u.push("   vec3 diffuse;"),u.push("   vec3 specular;"),u.push("};"),u.push("struct Geometry {"),u.push("   vec3 position;"),u.push("   vec3 viewNormal;"),u.push("   vec3 worldNormal;"),u.push("   vec3 viewEyeDir;"),u.push("};"),u.push("struct Material {"),u.push("   vec3    diffuseColor;"),u.push("   float   specularRoughness;"),u.push("   vec3    specularColor;"),u.push("   float   shine;"),u.push("};"),h&&((o.lightMaps.length>0||o.reflectionMaps.length>0)&&(u.push("void computePhongLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),o.lightMaps.length>0&&(u.push("   vec3 irradiance = "+is[o.lightMaps[0].encoding]+"(texture(lightMap, geometry.worldNormal)).rgb;"),u.push("   irradiance *= PI;"),u.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),u.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),o.reflectionMaps.length>0&&(u.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),u.push("   vec3 radiance               = texture(reflectionMap, reflectVec).rgb * 0.2;"),u.push("   radiance *= PI;"),u.push("   reflectedLight.specular     += radiance;")),u.push("}")),u.push("void computePhongLighting(const in IncidentLight directLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),u.push("   float dotNL     = saturate(dot(geometry.viewNormal, directLight.direction));"),u.push("   vec3 irradiance = dotNL * directLight.color * PI;"),u.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),u.push("   reflectedLight.specular += directLight.color * material.specularColor * pow(max(dot(reflect(-directLight.direction, -geometry.viewNormal), geometry.viewEyeDir), 0.0), material.shine);"),u.push("}")),(d||f)&&(u.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),u.push("   float r = ggxRoughness + 0.0001;"),u.push("   return (2.0 / (r * r) - 2.0);"),u.push("}"),u.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),u.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),u.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),u.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),u.push("}"),o.reflectionMaps.length>0&&(u.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),u.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),u.push("   vec3 envMapColor = "+is[o.reflectionMaps[0].encoding]+"(texture(reflectionMap, reflectVec, mipLevel)).rgb;"),u.push("  return envMapColor;"),u.push("}")),u.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),u.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),u.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),u.push("}"),u.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),u.push("   float a2 = ( alpha * alpha );"),u.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),u.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),u.push("   return 1.0 / ( gl * gv );"),u.push("}"),u.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),u.push("   float a2 = ( alpha * alpha );"),u.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),u.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),u.push("   return 0.5 / max( gv + gl, EPSILON );"),u.push("}"),u.push("float D_GGX(const in float alpha, const in float dotNH) {"),u.push("   float a2 = ( alpha * alpha );"),u.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),u.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),u.push("}"),u.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),u.push("   float alpha = ( roughness * roughness );"),u.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),u.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),u.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),u.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),u.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),u.push("   vec3  F = F_Schlick( specularColor, dotLH );"),u.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),u.push("   float D = D_GGX( alpha, dotNH );"),u.push("   return F * (G * D);"),u.push("}"),u.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),u.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),u.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),u.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),u.push("   vec4 r = roughness * c0 + c1;"),u.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),u.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),u.push("   return specularColor * AB.x + AB.y;"),u.push("}"),(o.lightMaps.length>0||o.reflectionMaps.length>0)&&(u.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),o.lightMaps.length>0&&(u.push("   vec3 irradiance = sRGBToLinear(texture(lightMap, geometry.worldNormal)).rgb;"),u.push("   irradiance *= PI;"),u.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),u.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),o.reflectionMaps.length>0&&(u.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),u.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),u.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),u.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),u.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),u.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),u.push("}")),u.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),u.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),u.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),u.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),u.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),u.push("}"))),u.push("in vec3 vViewPosition;"),s.colors&&u.push("in vec4 vColor;"),l&&(A&&i._normalMap||i._ambientMap||i._baseColorMap||i._diffuseMap||i._emissiveMap||i._metallicMap||i._roughnessMap||i._metallicRoughnessMap||i._specularMap||i._glossinessMap||i._specularGlossinessMap||i._occlusionMap||i._alphaMap)&&u.push("in vec2 vUV;"),A&&(o.lightMaps.length>0&&u.push("in vec3 vWorldNormal;"),u.push("in vec3 vViewNormal;")),n.ambient&&u.push("uniform vec3 materialAmbient;"),n.baseColor&&u.push("uniform vec3 materialBaseColor;"),n.alpha!==void 0&&n.alpha!==null&&u.push("uniform vec4 materialAlphaModeCutoff;"),n.emissive&&u.push("uniform vec3 materialEmissive;"),n.diffuse&&u.push("uniform vec3 materialDiffuse;"),n.glossiness!==void 0&&n.glossiness!==null&&u.push("uniform float materialGlossiness;"),n.shininess!==void 0&&n.shininess!==null&&u.push("uniform float materialShininess;"),n.specular&&u.push("uniform vec3 materialSpecular;"),n.metallic!==void 0&&n.metallic!==null&&u.push("uniform float materialMetallic;"),n.roughness!==void 0&&n.roughness!==null&&u.push("uniform float materialRoughness;"),n.specularF0!==void 0&&n.specularF0!==null&&u.push("uniform float materialSpecularF0;"),l&&i._ambientMap&&(u.push("uniform sampler2D ambientMap;"),i._ambientMap._state.matrix&&u.push("uniform mat4 ambientMapMatrix;")),l&&i._baseColorMap&&(u.push("uniform sampler2D baseColorMap;"),i._baseColorMap._state.matrix&&u.push("uniform mat4 baseColorMapMatrix;")),l&&i._diffuseMap&&(u.push("uniform sampler2D diffuseMap;"),i._diffuseMap._state.matrix&&u.push("uniform mat4 diffuseMapMatrix;")),l&&i._emissiveMap&&(u.push("uniform sampler2D emissiveMap;"),i._emissiveMap._state.matrix&&u.push("uniform mat4 emissiveMapMatrix;")),A&&l&&i._metallicMap&&(u.push("uniform sampler2D metallicMap;"),i._metallicMap._state.matrix&&u.push("uniform mat4 metallicMapMatrix;")),A&&l&&i._roughnessMap&&(u.push("uniform sampler2D roughnessMap;"),i._roughnessMap._state.matrix&&u.push("uniform mat4 roughnessMapMatrix;")),A&&l&&i._metallicRoughnessMap&&(u.push("uniform sampler2D metallicRoughnessMap;"),i._metallicRoughnessMap._state.matrix&&u.push("uniform mat4 metallicRoughnessMapMatrix;")),A&&i._normalMap&&(u.push("uniform sampler2D normalMap;"),i._normalMap._state.matrix&&u.push("uniform mat4 normalMapMatrix;"),u.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),u.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),u.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),u.push("      vec2 st0 = dFdx( uv.st );"),u.push("      vec2 st1 = dFdy( uv.st );"),u.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),u.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),u.push("      vec3 N = normalize( surf_norm );"),u.push("      vec3 mapN = texture( normalMap, uv ).xyz * 2.0 - 1.0;"),u.push("      mat3 tsn = mat3( S, T, N );"),u.push("      return normalize( tsn * mapN );"),u.push("}")),l&&i._occlusionMap&&(u.push("uniform sampler2D occlusionMap;"),i._occlusionMap._state.matrix&&u.push("uniform mat4 occlusionMapMatrix;")),l&&i._alphaMap&&(u.push("uniform sampler2D alphaMap;"),i._alphaMap._state.matrix&&u.push("uniform mat4 alphaMapMatrix;")),A&&l&&i._specularMap&&(u.push("uniform sampler2D specularMap;"),i._specularMap._state.matrix&&u.push("uniform mat4 specularMapMatrix;")),A&&l&&i._glossinessMap&&(u.push("uniform sampler2D glossinessMap;"),i._glossinessMap._state.matrix&&u.push("uniform mat4 glossinessMapMatrix;")),A&&l&&i._specularGlossinessMap&&(u.push("uniform sampler2D materialSpecularGlossinessMap;"),i._specularGlossinessMap._state.matrix&&u.push("uniform mat4 materialSpecularGlossinessMapMatrix;")),A&&(i._diffuseFresnel||i._specularFresnel||i._alphaFresnel||i._emissiveFresnel||i._reflectivityFresnel)&&(u.push("float fresnel(vec3 eyeDir, vec3 normal, float edgeBias, float centerBias, float power) {"),u.push("    float fr = abs(dot(eyeDir, normal));"),u.push("    float finalFr = clamp((fr - edgeBias) / (centerBias - edgeBias), 0.0, 1.0);"),u.push("    return pow(finalFr, power);"),u.push("}"),i._diffuseFresnel&&(u.push("uniform float  diffuseFresnelCenterBias;"),u.push("uniform float  diffuseFresnelEdgeBias;"),u.push("uniform float  diffuseFresnelPower;"),u.push("uniform vec3   diffuseFresnelCenterColor;"),u.push("uniform vec3   diffuseFresnelEdgeColor;")),i._specularFresnel&&(u.push("uniform float  specularFresnelCenterBias;"),u.push("uniform float  specularFresnelEdgeBias;"),u.push("uniform float  specularFresnelPower;"),u.push("uniform vec3   specularFresnelCenterColor;"),u.push("uniform vec3   specularFresnelEdgeColor;")),i._alphaFresnel&&(u.push("uniform float  alphaFresnelCenterBias;"),u.push("uniform float  alphaFresnelEdgeBias;"),u.push("uniform float  alphaFresnelPower;"),u.push("uniform vec3   alphaFresnelCenterColor;"),u.push("uniform vec3   alphaFresnelEdgeColor;")),i._reflectivityFresnel&&(u.push("uniform float  materialSpecularF0FresnelCenterBias;"),u.push("uniform float  materialSpecularF0FresnelEdgeBias;"),u.push("uniform float  materialSpecularF0FresnelPower;"),u.push("uniform vec3   materialSpecularF0FresnelCenterColor;"),u.push("uniform vec3   materialSpecularF0FresnelEdgeColor;")),i._emissiveFresnel&&(u.push("uniform float  emissiveFresnelCenterBias;"),u.push("uniform float  emissiveFresnelEdgeBias;"),u.push("uniform float  emissiveFresnelPower;"),u.push("uniform vec3   emissiveFresnelCenterColor;"),u.push("uniform vec3   emissiveFresnelEdgeColor;"))),u.push("uniform vec4   lightAmbient;"),A)for(let y=0,x=o.lights.length;y<x;y++){const B=o.lights[y];B.type!=="ambient"&&(u.push("uniform vec4 lightColor"+y+";"),B.type==="point"&&u.push("uniform vec3 lightAttenuation"+y+";"),B.type==="dir"&&B.space==="view"&&u.push("uniform vec3 lightDir"+y+";"),B.type==="point"&&B.space==="view"?u.push("uniform vec3 lightPos"+y+";"):u.push("in vec4 vViewLightReverseDirAndDist"+y+";"))}if(m)for(let y=0,x=o.lights.length;y<x;y++)o.lights[y].castsShadow&&(u.push("in vec4 vShadowPosFromLight"+y+";"),u.push("uniform sampler2D shadowMap"+y+";"));if(u.push("uniform vec4 colorize;"),u.push("out vec4 outColor;"),u.push("void main(void) {"),a){u.push("if (clippable) {"),u.push("  float dist = 0.0;");for(var P=0;P<t.getNumAllocatedSectionPlanes();P++)u.push("if (sectionPlaneActive"+P+") {"),u.push("   dist += clamp(dot(-sectionPlaneDir"+P+".xyz, vWorldPosition.xyz - sectionPlanePos"+P+".xyz), 0.0, 1000.0);"),u.push("}");u.push("  if (dist > 0.0) { discard; }"),u.push("}")}if(s.primitiveName==="points"&&(u.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),u.push("float r = dot(cxy, cxy);"),u.push("if (r > 1.0) {"),u.push("   discard;"),u.push("}")),u.push("float occlusion = 1.0;"),n.ambient?u.push("vec3 ambientColor = materialAmbient;"):u.push("vec3 ambientColor = vec3(1.0, 1.0, 1.0);"),n.diffuse?u.push("vec3 diffuseColor = materialDiffuse;"):n.baseColor?u.push("vec3 diffuseColor = materialBaseColor;"):u.push("vec3 diffuseColor = vec3(1.0, 1.0, 1.0);"),s.colors&&u.push("diffuseColor *= vColor.rgb;"),n.emissive?u.push("vec3 emissiveColor = materialEmissive;"):u.push("vec3  emissiveColor = vec3(0.0, 0.0, 0.0);"),n.specular?u.push("vec3 specular = materialSpecular;"):u.push("vec3 specular = vec3(1.0, 1.0, 1.0);"),n.alpha!==void 0?u.push("float alpha = materialAlphaModeCutoff[0];"):u.push("float alpha = 1.0;"),s.colors&&u.push("alpha *= vColor.a;"),n.glossiness!==void 0?u.push("float glossiness = materialGlossiness;"):u.push("float glossiness = 1.0;"),n.metallic!==void 0?u.push("float metallic = materialMetallic;"):u.push("float metallic = 1.0;"),n.roughness!==void 0?u.push("float roughness = materialRoughness;"):u.push("float roughness = 1.0;"),n.specularF0!==void 0?u.push("float specularF0 = materialSpecularF0;"):u.push("float specularF0 = 1.0;"),l&&(A&&i._normalMap||i._ambientMap||i._baseColorMap||i._diffuseMap||i._occlusionMap||i._emissiveMap||i._metallicMap||i._roughnessMap||i._metallicRoughnessMap||i._specularMap||i._glossinessMap||i._specularGlossinessMap||i._alphaMap)&&(u.push("vec4 texturePos = vec4(vUV.s, vUV.t, 1.0, 1.0);"),u.push("vec2 textureCoord;")),l&&i._ambientMap&&(i._ambientMap._state.matrix?u.push("textureCoord = (ambientMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("vec4 ambientTexel = texture(ambientMap, textureCoord).rgb;"),u.push("ambientTexel = "+is[i._ambientMap._state.encoding]+"(ambientTexel);"),u.push("ambientColor *= ambientTexel.rgb;")),l&&i._diffuseMap&&(i._diffuseMap._state.matrix?u.push("textureCoord = (diffuseMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("vec4 diffuseTexel = texture(diffuseMap, textureCoord);"),u.push("diffuseTexel = "+is[i._diffuseMap._state.encoding]+"(diffuseTexel);"),u.push("diffuseColor *= diffuseTexel.rgb;"),u.push("alpha *= diffuseTexel.a;")),l&&i._baseColorMap&&(i._baseColorMap._state.matrix?u.push("textureCoord = (baseColorMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("vec4 baseColorTexel = texture(baseColorMap, textureCoord);"),u.push("baseColorTexel = "+is[i._baseColorMap._state.encoding]+"(baseColorTexel);"),u.push("diffuseColor *= baseColorTexel.rgb;"),u.push("alpha *= baseColorTexel.a;")),l&&i._emissiveMap&&(i._emissiveMap._state.matrix?u.push("textureCoord = (emissiveMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("vec4 emissiveTexel = texture(emissiveMap, textureCoord);"),u.push("emissiveTexel = "+is[i._emissiveMap._state.encoding]+"(emissiveTexel);"),u.push("emissiveColor = emissiveTexel.rgb;")),l&&i._alphaMap&&(i._alphaMap._state.matrix?u.push("textureCoord = (alphaMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("alpha *= texture(alphaMap, textureCoord).r;")),l&&i._occlusionMap&&(i._occlusionMap._state.matrix?u.push("textureCoord = (occlusionMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("occlusion *= texture(occlusionMap, textureCoord).r;")),A&&(o.lights.length>0||o.lightMaps.length>0||o.reflectionMaps.length>0)){l&&i._normalMap?(i._normalMap._state.matrix?u.push("textureCoord = (normalMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("vec3 viewNormal = perturbNormal2Arb( vViewPosition, normalize(vViewNormal), textureCoord );")):u.push("vec3 viewNormal = normalize(vViewNormal);"),l&&i._specularMap&&(i._specularMap._state.matrix?u.push("textureCoord = (specularMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("specular *= texture(specularMap, textureCoord).rgb;")),l&&i._glossinessMap&&(i._glossinessMap._state.matrix?u.push("textureCoord = (glossinessMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("glossiness *= texture(glossinessMap, textureCoord).r;")),l&&i._specularGlossinessMap&&(i._specularGlossinessMap._state.matrix?u.push("textureCoord = (materialSpecularGlossinessMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("vec4 specGlossRGB = texture(materialSpecularGlossinessMap, textureCoord).rgba;"),u.push("specular *= specGlossRGB.rgb;"),u.push("glossiness *= specGlossRGB.a;")),l&&i._metallicMap&&(i._metallicMap._state.matrix?u.push("textureCoord = (metallicMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("metallic *= texture(metallicMap, textureCoord).r;")),l&&i._roughnessMap&&(i._roughnessMap._state.matrix?u.push("textureCoord = (roughnessMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("roughness *= texture(roughnessMap, textureCoord).r;")),l&&i._metallicRoughnessMap&&(i._metallicRoughnessMap._state.matrix?u.push("textureCoord = (metallicRoughnessMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("vec3 metalRoughRGB = texture(metallicRoughnessMap, textureCoord).rgb;"),u.push("metallic *= metalRoughRGB.b;"),u.push("roughness *= metalRoughRGB.g;")),u.push("vec3 viewEyeDir = normalize(-vViewPosition);"),i._diffuseFresnel&&(u.push("float diffuseFresnel = fresnel(viewEyeDir, viewNormal, diffuseFresnelEdgeBias, diffuseFresnelCenterBias, diffuseFresnelPower);"),u.push("diffuseColor *= mix(diffuseFresnelEdgeColor, diffuseFresnelCenterColor, diffuseFresnel);")),i._specularFresnel&&(u.push("float specularFresnel = fresnel(viewEyeDir, viewNormal, specularFresnelEdgeBias, specularFresnelCenterBias, specularFresnelPower);"),u.push("specular *= mix(specularFresnelEdgeColor, specularFresnelCenterColor, specularFresnel);")),i._alphaFresnel&&(u.push("float alphaFresnel = fresnel(viewEyeDir, viewNormal, alphaFresnelEdgeBias, alphaFresnelCenterBias, alphaFresnelPower);"),u.push("alpha *= mix(alphaFresnelEdgeColor.r, alphaFresnelCenterColor.r, alphaFresnel);")),i._emissiveFresnel&&(u.push("float emissiveFresnel = fresnel(viewEyeDir, viewNormal, emissiveFresnelEdgeBias, emissiveFresnelCenterBias, emissiveFresnelPower);"),u.push("emissiveColor *= mix(emissiveFresnelEdgeColor, emissiveFresnelCenterColor, emissiveFresnel);")),u.push("if (materialAlphaModeCutoff[1] == 1.0 && alpha < materialAlphaModeCutoff[2]) {"),u.push("   discard;"),u.push("}"),u.push("IncidentLight  light;"),u.push("Material       material;"),u.push("Geometry       geometry;"),u.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),u.push("vec3           viewLightDir;"),h&&(u.push("material.diffuseColor      = diffuseColor;"),u.push("material.specularColor     = specular;"),u.push("material.shine             = materialShininess;")),f&&(u.push("float oneMinusSpecularStrength = 1.0 - max(max(specular.r, specular.g ),specular.b);"),u.push("material.diffuseColor      = diffuseColor * oneMinusSpecularStrength;"),u.push("material.specularRoughness = clamp( 1.0 - glossiness, 0.04, 1.0 );"),u.push("material.specularColor     = specular;")),d&&(u.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),u.push("material.diffuseColor      = diffuseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),u.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),u.push("material.specularColor     = mix(vec3(dielectricSpecular), diffuseColor, metallic);")),u.push("geometry.position      = vViewPosition;"),o.lightMaps.length>0&&u.push("geometry.worldNormal   = normalize(vWorldNormal);"),u.push("geometry.viewNormal    = viewNormal;"),u.push("geometry.viewEyeDir    = viewEyeDir;"),h&&(o.lightMaps.length>0||o.reflectionMaps.length>0)&&u.push("computePhongLightMapping(geometry, material, reflectedLight);"),(f||d)&&(o.lightMaps.length>0||o.reflectionMaps.length>0)&&u.push("computePBRLightMapping(geometry, material, reflectedLight);"),u.push("float shadow = 1.0;"),u.push("float shadowAcneRemover = 0.007;"),u.push("vec3 fragmentDepth;"),u.push("float texelSize = 1.0 / 1024.0;"),u.push("float amountInLight = 0.0;"),u.push("vec3 shadowCoord;"),u.push("vec4 rgbaDepth;"),u.push("float depth;");for(let y=0,x=o.lights.length;y<x;y++){const B=o.lights[y];B.type!=="ambient"&&(B.type==="dir"&&B.space==="view"?u.push("viewLightDir = -normalize(lightDir"+y+");"):B.type==="point"&&B.space==="view"?u.push("viewLightDir = normalize(lightPos"+y+" - vViewPosition);"):u.push("viewLightDir = normalize(vViewLightReverseDirAndDist"+y+".xyz);"),m&&B.castsShadow?(u.push("shadow = 0.0;"),u.push("fragmentDepth = vShadowPosFromLight"+y+".xyz;"),u.push("fragmentDepth.z -= shadowAcneRemover;"),u.push("for (int x = -3; x <= 3; x++) {"),u.push("  for (int y = -3; y <= 3; y++) {"),u.push("      float texelDepth = unpackDepth(texture(shadowMap"+y+", fragmentDepth.xy + vec2(x, y) * texelSize));"),u.push("      if (fragmentDepth.z < texelDepth) {"),u.push("          shadow += 1.0;"),u.push("      }"),u.push("  }"),u.push("}"),u.push("shadow = shadow / 9.0;"),u.push("light.color =  lightColor"+y+".rgb * (lightColor"+y+".a * shadow);")):u.push("light.color =  lightColor"+y+".rgb * (lightColor"+y+".a );"),u.push("light.direction = viewLightDir;"),h&&u.push("computePhongLighting(light, geometry, material, reflectedLight);"),(f||d)&&u.push("computePBRLighting(light, geometry, material, reflectedLight);"))}h?u.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * diffuseColor) + ((occlusion * (( reflectedLight.diffuse + reflectedLight.specular)))) + emissiveColor;"):u.push("vec3 outgoingLight = (occlusion * (reflectedLight.diffuse)) + (occlusion * reflectedLight.specular) + emissiveColor;")}else u.push("ambientColor *= (lightAmbient.rgb * lightAmbient.a);"),u.push("vec3 outgoingLight = emissiveColor + ambientColor;");return u.push("vec4 fragColor = vec4(outgoingLight, alpha) * colorize;"),_&&u.push("fragColor = linearToGamma(fragColor, gammaFactor);"),u.push("outColor = fragColor;"),e.logarithmicDepthBufferEnabled&&u.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),u.push("}"),u}const Y_=c.vec3(),yp=new Ci({}),Ri=function(r,e){this.id=yp.addItem({}),this._hash=r,this._scene=e.scene,this._useCount=0,this._shaderSource=new j_(e),this._allocate(e)},jA={};Ri.get=function(r){const e=r.scene,i=[e.canvas.canvas.id,(e.gammaInput?"gi;":";")+(e.gammaOutput?"go":""),e._lightsState.getHash(),e._sectionPlanesState.getHash(),r._geometry._state.hash,r._material._state.hash,r._state.drawHash].join(";");let s=jA[i];if(!s){if(s=new Ri(i,r),s.errors)return console.log(s.errors.join(`
`)),null;jA[i]=s,vt.memory.programs++}return s._useCount++,s};Ri.prototype.put=function(){--this._useCount===0&&(yp.removeItem(this.id),this._program&&this._program.destroy(),delete jA[this._hash],vt.memory.programs--)};Ri.prototype.webglContextRestored=function(){this._program=null};Ri.prototype.drawMesh=function(r,e){this._program||this._allocate(e);const i=_t.MAX_TEXTURE_UNITS,s=e.scene,t=e._material,o=s.canvas.gl,n=this._program,a=e._state,A=e._material._state,l=e._geometry._state,h=s.camera,d=e.origin,f=a.background;if(r.lastProgramId!==this._program.id&&(r.lastProgramId=this._program.id,f&&o.depthFunc(o.LEQUAL),this._bindProgram(r)),o.uniformMatrix4fv(this._uViewMatrix,!1,d?r.getRTCViewMatrix(a.originHash,d):h.viewMatrix),o.uniformMatrix4fv(this._uViewNormalMatrix,!1,h.viewNormalMatrix),a.clippable){const y=s._sectionPlanesState.getNumAllocatedSectionPlanes(),x=s._sectionPlanesState.sectionPlanes.length;if(y>0){const B=s._sectionPlanesState.sectionPlanes,v=e.renderFlags;for(let w=0;w<y;w++){const C=this._uSectionPlanes[w];if(C)if(w<x){const I=v.sectionPlanesActivePerLayer[w];if(o.uniform1i(C.active,I?1:0),I){const E=B[w];if(d){const S=Ut(E.dist,E.dir,d,Y_);o.uniform3fv(C.pos,S)}else o.uniform3fv(C.pos,E.pos);o.uniform3fv(C.dir,E.dir)}}else o.uniform1i(C.active,0)}}}if(A.id!==this._lastMaterialId){r.textureUnit=this._baseTextureUnit;const y=A.backfaces;r.backfaces!==y&&(y?o.disable(o.CULL_FACE):o.enable(o.CULL_FACE),r.backfaces=y);const x=A.frontface;switch(r.frontface!==x&&(x?o.frontFace(o.CCW):o.frontFace(o.CW),r.frontface=x),r.lineWidth!==A.lineWidth&&(o.lineWidth(A.lineWidth),r.lineWidth=A.lineWidth),this._uPointSize&&o.uniform1f(this._uPointSize,A.pointSize),A.type){case"LambertMaterial":this._uMaterialAmbient&&o.uniform3fv(this._uMaterialAmbient,A.ambient),this._uMaterialColor&&o.uniform4f(this._uMaterialColor,A.color[0],A.color[1],A.color[2],A.alpha),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,A.emissive);break;case"PhongMaterial":this._uMaterialShininess&&o.uniform1f(this._uMaterialShininess,A.shininess),this._uMaterialAmbient&&o.uniform3fv(this._uMaterialAmbient,A.ambient),this._uMaterialDiffuse&&o.uniform3fv(this._uMaterialDiffuse,A.diffuse),this._uMaterialSpecular&&o.uniform3fv(this._uMaterialSpecular,A.specular),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,A.emissive),this._uAlphaModeCutoff&&o.uniform4f(this._uAlphaModeCutoff,1*A.alpha,A.alphaMode===1?1:0,A.alphaCutoff,0),t._ambientMap&&t._ambientMap._state.texture&&this._uMaterialAmbientMap&&(n.bindTexture(this._uMaterialAmbientMap,t._ambientMap._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%i,r.bindTexture++,this._uMaterialAmbientMapMatrix&&o.uniformMatrix4fv(this._uMaterialAmbientMapMatrix,!1,t._ambientMap._state.matrix)),t._diffuseMap&&t._diffuseMap._state.texture&&this._uDiffuseMap&&(n.bindTexture(this._uDiffuseMap,t._diffuseMap._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%i,r.bindTexture++,this._uDiffuseMapMatrix&&o.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,t._diffuseMap._state.matrix)),t._specularMap&&t._specularMap._state.texture&&this._uSpecularMap&&(n.bindTexture(this._uSpecularMap,t._specularMap._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%i,r.bindTexture++,this._uSpecularMapMatrix&&o.uniformMatrix4fv(this._uSpecularMapMatrix,!1,t._specularMap._state.matrix)),t._emissiveMap&&t._emissiveMap._state.texture&&this._uEmissiveMap&&(n.bindTexture(this._uEmissiveMap,t._emissiveMap._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%i,r.bindTexture++,this._uEmissiveMapMatrix&&o.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,t._emissiveMap._state.matrix)),t._alphaMap&&t._alphaMap._state.texture&&this._uAlphaMap&&(n.bindTexture(this._uAlphaMap,t._alphaMap._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%i,r.bindTexture++,this._uAlphaMapMatrix&&o.uniformMatrix4fv(this._uAlphaMapMatrix,!1,t._alphaMap._state.matrix)),t._reflectivityMap&&t._reflectivityMap._state.texture&&this._uReflectivityMap&&(n.bindTexture(this._uReflectivityMap,t._reflectivityMap._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%i,this._uReflectivityMapMatrix&&o.uniformMatrix4fv(this._uReflectivityMapMatrix,!1,t._reflectivityMap._state.matrix)),t._normalMap&&t._normalMap._state.texture&&this._uNormalMap&&(n.bindTexture(this._uNormalMap,t._normalMap._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%i,r.bindTexture++,this._uNormalMapMatrix&&o.uniformMatrix4fv(this._uNormalMapMatrix,!1,t._normalMap._state.matrix)),t._occlusionMap&&t._occlusionMap._state.texture&&this._uOcclusionMap&&(n.bindTexture(this._uOcclusionMap,t._occlusionMap._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%i,r.bindTexture++,this._uOcclusionMapMatrix&&o.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,t._occlusionMap._state.matrix)),t._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias&&o.uniform1f(this._uDiffuseFresnelEdgeBias,t._diffuseFresnel.edgeBias),this._uDiffuseFresnelCenterBias&&o.uniform1f(this._uDiffuseFresnelCenterBias,t._diffuseFresnel.centerBias),this._uDiffuseFresnelEdgeColor&&o.uniform3fv(this._uDiffuseFresnelEdgeColor,t._diffuseFresnel.edgeColor),this._uDiffuseFresnelCenterColor&&o.uniform3fv(this._uDiffuseFresnelCenterColor,t._diffuseFresnel.centerColor),this._uDiffuseFresnelPower&&o.uniform1f(this._uDiffuseFresnelPower,t._diffuseFresnel.power)),t._specularFresnel&&(this._uSpecularFresnelEdgeBias&&o.uniform1f(this._uSpecularFresnelEdgeBias,t._specularFresnel.edgeBias),this._uSpecularFresnelCenterBias&&o.uniform1f(this._uSpecularFresnelCenterBias,t._specularFresnel.centerBias),this._uSpecularFresnelEdgeColor&&o.uniform3fv(this._uSpecularFresnelEdgeColor,t._specularFresnel.edgeColor),this._uSpecularFresnelCenterColor&&o.uniform3fv(this._uSpecularFresnelCenterColor,t._specularFresnel.centerColor),this._uSpecularFresnelPower&&o.uniform1f(this._uSpecularFresnelPower,t._specularFresnel.power)),t._alphaFresnel&&(this._uAlphaFresnelEdgeBias&&o.uniform1f(this._uAlphaFresnelEdgeBias,t._alphaFresnel.edgeBias),this._uAlphaFresnelCenterBias&&o.uniform1f(this._uAlphaFresnelCenterBias,t._alphaFresnel.centerBias),this._uAlphaFresnelEdgeColor&&o.uniform3fv(this._uAlphaFresnelEdgeColor,t._alphaFresnel.edgeColor),this._uAlphaFresnelCenterColor&&o.uniform3fv(this._uAlphaFresnelCenterColor,t._alphaFresnel.centerColor),this._uAlphaFresnelPower&&o.uniform1f(this._uAlphaFresnelPower,t._alphaFresnel.power)),t._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias&&o.uniform1f(this._uReflectivityFresnelEdgeBias,t._reflectivityFresnel.edgeBias),this._uReflectivityFresnelCenterBias&&o.uniform1f(this._uReflectivityFresnelCenterBias,t._reflectivityFresnel.centerBias),this._uReflectivityFresnelEdgeColor&&o.uniform3fv(this._uReflectivityFresnelEdgeColor,t._reflectivityFresnel.edgeColor),this._uReflectivityFresnelCenterColor&&o.uniform3fv(this._uReflectivityFresnelCenterColor,t._reflectivityFresnel.centerColor),this._uReflectivityFresnelPower&&o.uniform1f(this._uReflectivityFresnelPower,t._reflectivityFresnel.power)),t._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias&&o.uniform1f(this._uEmissiveFresnelEdgeBias,t._emissiveFresnel.edgeBias),this._uEmissiveFresnelCenterBias&&o.uniform1f(this._uEmissiveFresnelCenterBias,t._emissiveFresnel.centerBias),this._uEmissiveFresnelEdgeColor&&o.uniform3fv(this._uEmissiveFresnelEdgeColor,t._emissiveFresnel.edgeColor),this._uEmissiveFresnelCenterColor&&o.uniform3fv(this._uEmissiveFresnelCenterColor,t._emissiveFresnel.centerColor),this._uEmissiveFresnelPower&&o.uniform1f(this._uEmissiveFresnelPower,t._emissiveFresnel.power));break;case"MetallicMaterial":this._uBaseColor&&o.uniform3fv(this._uBaseColor,A.baseColor),this._uMaterialMetallic&&o.uniform1f(this._uMaterialMetallic,A.metallic),this._uMaterialRoughness&&o.uniform1f(this._uMaterialRoughness,A.roughness),this._uMaterialSpecularF0&&o.uniform1f(this._uMaterialSpecularF0,A.specularF0),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,A.emissive),this._uAlphaModeCutoff&&o.uniform4f(this._uAlphaModeCutoff,1*A.alpha,A.alphaMode===1?1:0,A.alphaCutoff,0);const B=t._baseColorMap;B&&B._state.texture&&this._uBaseColorMap&&(n.bindTexture(this._uBaseColorMap,B._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%i,r.bindTexture++,this._uBaseColorMapMatrix&&o.uniformMatrix4fv(this._uBaseColorMapMatrix,!1,B._state.matrix));const v=t._metallicMap;v&&v._state.texture&&this._uMetallicMap&&(n.bindTexture(this._uMetallicMap,v._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%i,r.bindTexture++,this._uMetallicMapMatrix&&o.uniformMatrix4fv(this._uMetallicMapMatrix,!1,v._state.matrix));const w=t._roughnessMap;w&&w._state.texture&&this._uRoughnessMap&&(n.bindTexture(this._uRoughnessMap,w._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%i,r.bindTexture++,this._uRoughnessMapMatrix&&o.uniformMatrix4fv(this._uRoughnessMapMatrix,!1,w._state.matrix));const C=t._metallicRoughnessMap;C&&C._state.texture&&this._uMetallicRoughnessMap&&(n.bindTexture(this._uMetallicRoughnessMap,C._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%i,r.bindTexture++,this._uMetallicRoughnessMapMatrix&&o.uniformMatrix4fv(this._uMetallicRoughnessMapMatrix,!1,C._state.matrix));var m=t._emissiveMap;m&&m._state.texture&&this._uEmissiveMap&&(n.bindTexture(this._uEmissiveMap,m._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%i,r.bindTexture++,this._uEmissiveMapMatrix&&o.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,m._state.matrix));var _=t._occlusionMap;_&&t._occlusionMap._state.texture&&this._uOcclusionMap&&(n.bindTexture(this._uOcclusionMap,_._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%i,r.bindTexture++,this._uOcclusionMapMatrix&&o.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,_._state.matrix));var u=t._alphaMap;u&&u._state.texture&&this._uAlphaMap&&(n.bindTexture(this._uAlphaMap,u._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%i,r.bindTexture++,this._uAlphaMapMatrix&&o.uniformMatrix4fv(this._uAlphaMapMatrix,!1,u._state.matrix));var P=t._normalMap;P&&P._state.texture&&this._uNormalMap&&(n.bindTexture(this._uNormalMap,P._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%i,r.bindTexture++,this._uNormalMapMatrix&&o.uniformMatrix4fv(this._uNormalMapMatrix,!1,P._state.matrix));break;case"SpecularMaterial":this._uMaterialDiffuse&&o.uniform3fv(this._uMaterialDiffuse,A.diffuse),this._uMaterialSpecular&&o.uniform3fv(this._uMaterialSpecular,A.specular),this._uMaterialGlossiness&&o.uniform1f(this._uMaterialGlossiness,A.glossiness),this._uMaterialReflectivity&&o.uniform1f(this._uMaterialReflectivity,A.reflectivity),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,A.emissive),this._uAlphaModeCutoff&&o.uniform4f(this._uAlphaModeCutoff,1*A.alpha,A.alphaMode===1?1:0,A.alphaCutoff,0);const I=t._diffuseMap;I&&I._state.texture&&this._uDiffuseMap&&(n.bindTexture(this._uDiffuseMap,I._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%i,r.bindTexture++,this._uDiffuseMapMatrix&&o.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,I._state.matrix));const E=t._specularMap;E&&E._state.texture&&this._uSpecularMap&&(n.bindTexture(this._uSpecularMap,E._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%i,r.bindTexture++,this._uSpecularMapMatrix&&o.uniformMatrix4fv(this._uSpecularMapMatrix,!1,E._state.matrix));const S=t._glossinessMap;S&&S._state.texture&&this._uGlossinessMap&&(n.bindTexture(this._uGlossinessMap,S._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%i,r.bindTexture++,this._uGlossinessMapMatrix&&o.uniformMatrix4fv(this._uGlossinessMapMatrix,!1,S._state.matrix));const R=t._specularGlossinessMap;R&&R._state.texture&&this._uSpecularGlossinessMap&&(n.bindTexture(this._uSpecularGlossinessMap,R._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%i,r.bindTexture++,this._uSpecularGlossinessMapMatrix&&o.uniformMatrix4fv(this._uSpecularGlossinessMapMatrix,!1,R._state.matrix));var m=t._emissiveMap;m&&m._state.texture&&this._uEmissiveMap&&(n.bindTexture(this._uEmissiveMap,m._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%i,r.bindTexture++,this._uEmissiveMapMatrix&&o.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,m._state.matrix));var _=t._occlusionMap;_&&_._state.texture&&this._uOcclusionMap&&(n.bindTexture(this._uOcclusionMap,_._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%i,r.bindTexture++,this._uOcclusionMapMatrix&&o.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,_._state.matrix));var u=t._alphaMap;u&&u._state.texture&&this._uAlphaMap&&(n.bindTexture(this._uAlphaMap,u._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%i,r.bindTexture++,this._uAlphaMapMatrix&&o.uniformMatrix4fv(this._uAlphaMapMatrix,!1,u._state.matrix));var P=t._normalMap;P&&P._state.texture&&this._uNormalMap&&(n.bindTexture(this._uNormalMap,P._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%i,r.bindTexture++,this._uNormalMapMatrix&&o.uniformMatrix4fv(this._uNormalMapMatrix,!1,P._state.matrix));break}this._lastMaterialId=A.id}if(o.uniformMatrix4fv(this._uModelMatrix,o.FALSE,e.worldMatrix),this._uModelNormalMatrix&&o.uniformMatrix4fv(this._uModelNormalMatrix,o.FALSE,e.worldNormalMatrix),this._uClippable&&o.uniform1i(this._uClippable,a.clippable),this._uColorize){const y=a.colorize,x=this._lastColorize;(x[0]!==y[0]||x[1]!==y[1]||x[2]!==y[2]||x[3]!==y[3])&&(o.uniform4fv(this._uColorize,y),x[0]=y[0],x[1]=y[1],x[2]=y[2],x[3]=y[3])}o.uniform3fv(this._uOffset,a.offset),l.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._uUVDecodeMatrix&&o.uniformMatrix3fv(this._uUVDecodeMatrix,!1,l.uvDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(l.positionsBuf),r.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(l.normalsBuf),r.bindArray++),this._aUV&&(this._aUV.bindArrayBuffer(l.uvBuf),r.bindArray++),this._aColor&&(this._aColor.bindArrayBuffer(l.colorsBuf),r.bindArray++),this._aFlags&&(this._aFlags.bindArrayBuffer(l.flagsBuf),r.bindArray++),l.indicesBuf&&(l.indicesBuf.bind(),r.bindArray++),this._lastGeometryId=l.id),l.indicesBuf?(o.drawElements(l.primitive,l.indicesBuf.numItems,l.indicesBuf.itemType,0),r.drawElements++):l.positions&&(o.drawArrays(o.TRIANGLES,0,l.positions.numItems),r.drawArrays++),f&&o.depthFunc(o.LESS)};Ri.prototype._allocate=function(r){const e=r.scene,i=e.canvas.gl,s=r._material,t=e._lightsState,o=e._sectionPlanesState,n=r._material._state;if(this._program=new It(i,this._shaderSource),this._program.errors){this.errors=this._program.errors;return}const a=this._program;this._uPositionsDecodeMatrix=a.getLocation("positionsDecodeMatrix"),this._uUVDecodeMatrix=a.getLocation("uvDecodeMatrix"),this._uModelMatrix=a.getLocation("modelMatrix"),this._uModelNormalMatrix=a.getLocation("modelNormalMatrix"),this._uViewMatrix=a.getLocation("viewMatrix"),this._uViewNormalMatrix=a.getLocation("viewNormalMatrix"),this._uProjMatrix=a.getLocation("projMatrix"),this._uGammaFactor=a.getLocation("gammaFactor"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[],this._uShadowViewMatrix=[],this._uShadowProjMatrix=[],e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=a.getLocation("logDepthBufFC"));const A=t.lights;let l;for(var h=0,d=A.length;h<d;h++){switch(l=A[h],l.type){case"ambient":this._uLightAmbient[h]=a.getLocation("lightAmbient");break;case"dir":this._uLightColor[h]=a.getLocation("lightColor"+h),this._uLightPos[h]=null,this._uLightDir[h]=a.getLocation("lightDir"+h);break;case"point":this._uLightColor[h]=a.getLocation("lightColor"+h),this._uLightPos[h]=a.getLocation("lightPos"+h),this._uLightDir[h]=null,this._uLightAttenuation[h]=a.getLocation("lightAttenuation"+h);break;case"spot":this._uLightColor[h]=a.getLocation("lightColor"+h),this._uLightPos[h]=a.getLocation("lightPos"+h),this._uLightDir[h]=a.getLocation("lightDir"+h),this._uLightAttenuation[h]=a.getLocation("lightAttenuation"+h);break}l.castsShadow&&(this._uShadowViewMatrix[h]=a.getLocation("shadowViewMatrix"+h),this._uShadowProjMatrix[h]=a.getLocation("shadowProjMatrix"+h))}t.lightMaps.length>0&&(this._uLightMap="lightMap"),t.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),this._uSectionPlanes=[];const f=o.sectionPlanes;for(var h=0,d=f.length;h<d;h++)this._uSectionPlanes.push({active:a.getLocation("sectionPlaneActive"+h),pos:a.getLocation("sectionPlanePos"+h),dir:a.getLocation("sectionPlaneDir"+h)});switch(this._uPointSize=a.getLocation("pointSize"),n.type){case"LambertMaterial":this._uMaterialColor=a.getLocation("materialColor"),this._uMaterialEmissive=a.getLocation("materialEmissive"),this._uAlphaModeCutoff=a.getLocation("materialAlphaModeCutoff");break;case"PhongMaterial":this._uMaterialAmbient=a.getLocation("materialAmbient"),this._uMaterialDiffuse=a.getLocation("materialDiffuse"),this._uMaterialSpecular=a.getLocation("materialSpecular"),this._uMaterialEmissive=a.getLocation("materialEmissive"),this._uAlphaModeCutoff=a.getLocation("materialAlphaModeCutoff"),this._uMaterialShininess=a.getLocation("materialShininess"),s._ambientMap&&(this._uMaterialAmbientMap="ambientMap",this._uMaterialAmbientMapMatrix=a.getLocation("ambientMapMatrix")),s._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=a.getLocation("diffuseMapMatrix")),s._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=a.getLocation("specularMapMatrix")),s._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=a.getLocation("emissiveMapMatrix")),s._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=a.getLocation("alphaMapMatrix")),s._reflectivityMap&&(this._uReflectivityMap="reflectivityMap",this._uReflectivityMapMatrix=a.getLocation("reflectivityMapMatrix")),s._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=a.getLocation("normalMapMatrix")),s._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=a.getLocation("occlusionMapMatrix")),s._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias=a.getLocation("diffuseFresnelEdgeBias"),this._uDiffuseFresnelCenterBias=a.getLocation("diffuseFresnelCenterBias"),this._uDiffuseFresnelEdgeColor=a.getLocation("diffuseFresnelEdgeColor"),this._uDiffuseFresnelCenterColor=a.getLocation("diffuseFresnelCenterColor"),this._uDiffuseFresnelPower=a.getLocation("diffuseFresnelPower")),s._specularFresnel&&(this._uSpecularFresnelEdgeBias=a.getLocation("specularFresnelEdgeBias"),this._uSpecularFresnelCenterBias=a.getLocation("specularFresnelCenterBias"),this._uSpecularFresnelEdgeColor=a.getLocation("specularFresnelEdgeColor"),this._uSpecularFresnelCenterColor=a.getLocation("specularFresnelCenterColor"),this._uSpecularFresnelPower=a.getLocation("specularFresnelPower")),s._alphaFresnel&&(this._uAlphaFresnelEdgeBias=a.getLocation("alphaFresnelEdgeBias"),this._uAlphaFresnelCenterBias=a.getLocation("alphaFresnelCenterBias"),this._uAlphaFresnelEdgeColor=a.getLocation("alphaFresnelEdgeColor"),this._uAlphaFresnelCenterColor=a.getLocation("alphaFresnelCenterColor"),this._uAlphaFresnelPower=a.getLocation("alphaFresnelPower")),s._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias=a.getLocation("reflectivityFresnelEdgeBias"),this._uReflectivityFresnelCenterBias=a.getLocation("reflectivityFresnelCenterBias"),this._uReflectivityFresnelEdgeColor=a.getLocation("reflectivityFresnelEdgeColor"),this._uReflectivityFresnelCenterColor=a.getLocation("reflectivityFresnelCenterColor"),this._uReflectivityFresnelPower=a.getLocation("reflectivityFresnelPower")),s._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias=a.getLocation("emissiveFresnelEdgeBias"),this._uEmissiveFresnelCenterBias=a.getLocation("emissiveFresnelCenterBias"),this._uEmissiveFresnelEdgeColor=a.getLocation("emissiveFresnelEdgeColor"),this._uEmissiveFresnelCenterColor=a.getLocation("emissiveFresnelCenterColor"),this._uEmissiveFresnelPower=a.getLocation("emissiveFresnelPower"));break;case"MetallicMaterial":this._uBaseColor=a.getLocation("materialBaseColor"),this._uMaterialMetallic=a.getLocation("materialMetallic"),this._uMaterialRoughness=a.getLocation("materialRoughness"),this._uMaterialSpecularF0=a.getLocation("materialSpecularF0"),this._uMaterialEmissive=a.getLocation("materialEmissive"),this._uAlphaModeCutoff=a.getLocation("materialAlphaModeCutoff"),s._baseColorMap&&(this._uBaseColorMap="baseColorMap",this._uBaseColorMapMatrix=a.getLocation("baseColorMapMatrix")),s._metallicMap&&(this._uMetallicMap="metallicMap",this._uMetallicMapMatrix=a.getLocation("metallicMapMatrix")),s._roughnessMap&&(this._uRoughnessMap="roughnessMap",this._uRoughnessMapMatrix=a.getLocation("roughnessMapMatrix")),s._metallicRoughnessMap&&(this._uMetallicRoughnessMap="metallicRoughnessMap",this._uMetallicRoughnessMapMatrix=a.getLocation("metallicRoughnessMapMatrix")),s._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=a.getLocation("emissiveMapMatrix")),s._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=a.getLocation("occlusionMapMatrix")),s._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=a.getLocation("alphaMapMatrix")),s._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=a.getLocation("normalMapMatrix"));break;case"SpecularMaterial":this._uMaterialDiffuse=a.getLocation("materialDiffuse"),this._uMaterialSpecular=a.getLocation("materialSpecular"),this._uMaterialGlossiness=a.getLocation("materialGlossiness"),this._uMaterialReflectivity=a.getLocation("reflectivityFresnel"),this._uMaterialEmissive=a.getLocation("materialEmissive"),this._uAlphaModeCutoff=a.getLocation("materialAlphaModeCutoff"),s._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=a.getLocation("diffuseMapMatrix")),s._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=a.getLocation("specularMapMatrix")),s._glossinessMap&&(this._uGlossinessMap="glossinessMap",this._uGlossinessMapMatrix=a.getLocation("glossinessMapMatrix")),s._specularGlossinessMap&&(this._uSpecularGlossinessMap="materialSpecularGlossinessMap",this._uSpecularGlossinessMapMatrix=a.getLocation("materialSpecularGlossinessMapMatrix")),s._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=a.getLocation("emissiveMapMatrix")),s._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=a.getLocation("occlusionMapMatrix")),s._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=a.getLocation("alphaMapMatrix")),s._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=a.getLocation("normalMapMatrix"));break}this._aPosition=a.getAttribute("position"),this._aNormal=a.getAttribute("normal"),this._aUV=a.getAttribute("uv"),this._aColor=a.getAttribute("color"),this._aFlags=a.getAttribute("flags"),this._uClippable=a.getLocation("clippable"),this._uColorize=a.getLocation("colorize"),this._uOffset=a.getLocation("offset"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize=new Float32Array(4),this._baseTextureUnit=0};Ri.prototype._bindProgram=function(r){const e=_t.MAX_TEXTURE_UNITS,i=this._scene,s=i.canvas.gl,t=i._lightsState,o=i.camera.project;let n;const a=this._program;if(a.bind(),r.useProgram++,r.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize[0]=-1,this._lastColorize[1]=-1,this._lastColorize[2]=-1,this._lastColorize[3]=-1,s.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),i.logarithmicDepthBufferEnabled){const h=2/(Math.log(o.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,h)}for(var A=0,l=t.lights.length;A<l;A++)if(n=t.lights[A],this._uLightAmbient[A])s.uniform4f(this._uLightAmbient[A],n.color[0],n.color[1],n.color[2],n.intensity);else if(this._uLightColor[A]&&s.uniform4f(this._uLightColor[A],n.color[0],n.color[1],n.color[2],n.intensity),this._uLightPos[A]&&(s.uniform3fv(this._uLightPos[A],n.pos),this._uLightAttenuation[A]&&s.uniform1f(this._uLightAttenuation[A],n.attenuation)),this._uLightDir[A]&&s.uniform3fv(this._uLightDir[A],n.dir),n.castsShadow){this._uShadowViewMatrix[A]&&s.uniformMatrix4fv(this._uShadowViewMatrix[A],!1,n.getShadowViewMatrix()),this._uShadowProjMatrix[A]&&s.uniformMatrix4fv(this._uShadowProjMatrix[A],!1,n.getShadowProjMatrix());const h=n.getShadowRenderBuf();h&&(a.bindTexture("shadowMap"+A,h.getTexture(),r.textureUnit),r.textureUnit=(r.textureUnit+1)%e,r.bindTexture++)}t.lightMaps.length>0&&t.lightMaps[0].texture&&this._uLightMap&&(a.bindTexture(this._uLightMap,t.lightMaps[0].texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%e,r.bindTexture++),t.reflectionMaps.length>0&&t.reflectionMaps[0].texture&&this._uReflectionMap&&(a.bindTexture(this._uReflectionMap,t.reflectionMaps[0].texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%e,r.bindTexture++),this._uGammaFactor&&s.uniform1f(this._uGammaFactor,i.gammaFactor),this._baseTextureUnit=r.textureUnit};class $_{constructor(e){this.vertex=Z_(e),this.fragment=J_(e)}}function Z_(r){const e=r.scene,i=e._lightsState,s=q_(r),o=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,n=!!r._geometry._state.compressGeometry,a=r._state.billboard,A=r._state.stationary,l=[];if(l.push("#version 300 es"),l.push("// EmphasisFillShaderSource vertex shader"),l.push("in vec3 position;"),l.push("uniform mat4 modelMatrix;"),l.push("uniform mat4 viewMatrix;"),l.push("uniform mat4 projMatrix;"),l.push("uniform vec4 colorize;"),l.push("uniform vec3 offset;"),n&&l.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(l.push("uniform float logDepthBufFC;"),l.push("out float vFragDepth;"),l.push("bool isPerspectiveMatrix(mat4 m) {"),l.push("    return (m[2][3] == - 1.0);"),l.push("}"),l.push("out float isPerspective;")),o&&l.push("out vec4 vWorldPosition;"),l.push("uniform vec4   lightAmbient;"),l.push("uniform vec4   fillColor;"),s){l.push("in vec3 normal;"),l.push("uniform mat4 modelNormalMatrix;"),l.push("uniform mat4 viewNormalMatrix;");for(let h=0,d=i.lights.length;h<d;h++){const f=i.lights[h];f.type!=="ambient"&&(l.push("uniform vec4 lightColor"+h+";"),f.type==="dir"&&l.push("uniform vec3 lightDir"+h+";"),f.type==="point"&&l.push("uniform vec3 lightPos"+h+";"),f.type==="spot"&&l.push("uniform vec3 lightPos"+h+";"))}n&&(l.push("vec3 octDecode(vec2 oct) {"),l.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),l.push("    if (v.z < 0.0) {"),l.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),l.push("    }"),l.push("    return normalize(v);"),l.push("}"))}if(l.push("out vec4 vColor;"),(a==="spherical"||a==="cylindrical")&&(l.push("void billboard(inout mat4 mat) {"),l.push("   mat[0][0] = 1.0;"),l.push("   mat[0][1] = 0.0;"),l.push("   mat[0][2] = 0.0;"),a==="spherical"&&(l.push("   mat[1][0] = 0.0;"),l.push("   mat[1][1] = 1.0;"),l.push("   mat[1][2] = 0.0;")),l.push("   mat[2][0] = 0.0;"),l.push("   mat[2][1] = 0.0;"),l.push("   mat[2][2] =1.0;"),l.push("}")),l.push("void main(void) {"),l.push("vec4 localPosition = vec4(position, 1.0); "),l.push("vec4 worldPosition;"),n&&l.push("localPosition = positionsDecodeMatrix * localPosition;"),s&&(n?l.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):l.push("vec4 localNormal = vec4(normal, 0.0); "),l.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),l.push("mat4 viewNormalMatrix2 = viewNormalMatrix;")),l.push("mat4 viewMatrix2 = viewMatrix;"),l.push("mat4 modelMatrix2 = modelMatrix;"),A&&l.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),a==="spherical"||a==="cylindrical"?(l.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),l.push("billboard(modelMatrix2);"),l.push("billboard(viewMatrix2);"),l.push("billboard(modelViewMatrix);"),s&&(l.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),l.push("billboard(modelNormalMatrix2);"),l.push("billboard(viewNormalMatrix2);"),l.push("billboard(modelViewNormalMatrix);")),l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("worldPosition.xyz = worldPosition.xyz + offset;"),l.push("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),s&&l.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);"),l.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),l.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),l.push("float lambertian = 1.0;"),s)for(let h=0,d=i.lights.length;h<d;h++){const f=i.lights[h];if(f.type!=="ambient"){if(f.type==="dir")f.space==="view"?l.push("viewLightDir = normalize(lightDir"+h+");"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+h+", 0.0)).xyz);");else if(f.type==="point")f.space==="view"?l.push("viewLightDir = normalize(lightPos"+h+" - viewPosition.xyz);"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightPos"+h+", 0.0)).xyz);");else continue;l.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),l.push("reflectedColor += lambertian * (lightColor"+h+".rgb * lightColor"+h+".a);")}}return l.push("vColor = vec4(reflectedColor * fillColor.rgb, fillColor.a);"),o&&l.push("vWorldPosition = worldPosition;"),r._geometry._state.primitiveName==="points"&&l.push("gl_PointSize = pointSize;"),l.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(l.push("vFragDepth = 1.0 + clipPos.w;"),l.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),l.push("gl_Position = clipPos;"),l.push("}"),l}function q_(r){const e=r._geometry._state.primitiveName;return!!((r._geometry._state.autoVertexNormals||r._geometry._state.normalsBuf)&&(e==="triangles"||e==="triangle-strip"||e==="triangle-fan"))}function J_(r){const e=r.scene,i=r.scene._sectionPlanesState,s=r.scene.gammaOutput,t=i.getNumAllocatedSectionPlanes()>0,o=[];if(o.push("#version 300 es"),o.push("// Lambertian drawing fragment shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&(o.push("in float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),s&&(o.push("uniform float gammaFactor;"),o.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}")),t){o.push("in vec4 vWorldPosition;"),o.push("uniform bool clippable;");for(let n=0,a=i.getNumAllocatedSectionPlanes();n<a;n++)o.push("uniform bool sectionPlaneActive"+n+";"),o.push("uniform vec3 sectionPlanePos"+n+";"),o.push("uniform vec3 sectionPlaneDir"+n+";")}if(o.push("in vec4 vColor;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),t){o.push("if (clippable) {"),o.push("  float dist = 0.0;");for(let n=0,a=i.getNumAllocatedSectionPlanes();n<a;n++)o.push("if (sectionPlaneActive"+n+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}return r._geometry._state.primitiveName==="points"&&(o.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),o.push("float r = dot(cxy, cxy);"),o.push("if (r > 1.0) {"),o.push("   discard;"),o.push("}")),e.logarithmicDepthBufferEnabled&&o.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s?o.push("outColor = linearToGamma(vColor, gammaFactor);"):o.push("outColor = vColor;"),o.push("}"),o}const xp=new Ci({}),e0=c.vec3(),bi=function(r,e){this.id=xp.addItem({}),this._hash=r,this._scene=e.scene,this._useCount=0,this._shaderSource=new $_(e),this._allocate(e)},GA={};bi.get=function(r){const e=[r.scene.id,r.scene.gammaOutput?"go":"",r.scene._sectionPlanesState.getHash(),r._geometry._state.normalsBuf?"n":"",r._geometry._state.compressGeometry?"cp":"",r._state.hash].join(";");let i=GA[e];return i||(i=new bi(e,r),GA[e]=i,vt.memory.programs++),i._useCount++,i};bi.prototype.put=function(){--this._useCount===0&&(xp.removeItem(this.id),this._program&&this._program.destroy(),delete GA[this._hash],vt.memory.programs--)};bi.prototype.webglContextRestored=function(){this._program=null};bi.prototype.drawMesh=function(r,e,i){this._program||this._allocate(e);const s=this._scene,t=s.camera,o=s.canvas.gl,n=i===0?e._xrayMaterial._state:i===1?e._highlightMaterial._state:e._selectedMaterial._state,a=e._state,A=e._geometry._state,l=e.origin;if(r.lastProgramId!==this._program.id&&(r.lastProgramId=this._program.id,this._bindProgram(r)),o.uniformMatrix4fv(this._uViewMatrix,!1,l?r.getRTCViewMatrix(a.originHash,l):t.viewMatrix),o.uniformMatrix4fv(this._uViewNormalMatrix,!1,t.viewNormalMatrix),a.clippable){const h=s._sectionPlanesState.getNumAllocatedSectionPlanes(),d=s._sectionPlanesState.sectionPlanes.length;if(h>0){const f=s._sectionPlanesState.sectionPlanes,m=e.renderFlags;for(let _=0;_<h;_++){const u=this._uSectionPlanes[_];if(u)if(_<d){const P=m.sectionPlanesActivePerLayer[_];if(o.uniform1i(u.active,P?1:0),P){const y=f[_];if(l){const x=Ut(y.dist,y.dir,l,e0);o.uniform3fv(u.pos,x)}else o.uniform3fv(u.pos,y.pos);o.uniform3fv(u.dir,y.dir)}}else o.uniform1i(u.active,0)}}}if(n.id!==this._lastMaterialId){const h=n.fillColor,d=n.backfaces;r.backfaces!==d&&(d?o.disable(o.CULL_FACE):o.enable(o.CULL_FACE),r.backfaces=d),o.uniform4f(this._uFillColor,h[0],h[1],h[2],n.fillAlpha),this._lastMaterialId=n.id}o.uniformMatrix4fv(this._uModelMatrix,o.FALSE,e.worldMatrix),this._uModelNormalMatrix&&o.uniformMatrix4fv(this._uModelNormalMatrix,o.FALSE,e.worldNormalMatrix),this._uClippable&&o.uniform1i(this._uClippable,a.clippable),o.uniform3fv(this._uOffset,a.offset),A.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,A.positionsDecodeMatrix),this._uUVDecodeMatrix&&o.uniformMatrix3fv(this._uUVDecodeMatrix,!1,A.uvDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(A.positionsBuf),r.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(A.normalsBuf),r.bindArray++),A.indicesBuf?(A.indicesBuf.bind(),r.bindArray++):A.positionsBuf,this._lastGeometryId=A.id),A.indicesBuf?(o.drawElements(A.primitive,A.indicesBuf.numItems,A.indicesBuf.itemType,0),r.drawElements++):A.positionsBuf&&(o.drawArrays(o.TRIANGLES,0,A.positionsBuf.numItems),r.drawArrays++)};bi.prototype._allocate=function(r){const e=r.scene,i=e._lightsState,s=e._sectionPlanesState,t=e.canvas.gl;if(this._program=new It(t,this._shaderSource),this._program.errors){this.errors=this._program.errors;return}const o=this._program;this._uPositionsDecodeMatrix=o.getLocation("positionsDecodeMatrix"),this._uModelMatrix=o.getLocation("modelMatrix"),this._uModelNormalMatrix=o.getLocation("modelNormalMatrix"),this._uViewMatrix=o.getLocation("viewMatrix"),this._uViewNormalMatrix=o.getLocation("viewNormalMatrix"),this._uProjMatrix=o.getLocation("projMatrix"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(let n=0,a=i.lights.length;n<a;n++)switch(i.lights[n].type){case"ambient":this._uLightAmbient[n]=o.getLocation("lightAmbient");break;case"dir":this._uLightColor[n]=o.getLocation("lightColor"+n),this._uLightPos[n]=null,this._uLightDir[n]=o.getLocation("lightDir"+n);break;case"point":this._uLightColor[n]=o.getLocation("lightColor"+n),this._uLightPos[n]=o.getLocation("lightPos"+n),this._uLightDir[n]=null,this._uLightAttenuation[n]=o.getLocation("lightAttenuation"+n);break}this._uSectionPlanes=[];for(let n=0,a=s.getNumAllocatedSectionPlanes();n<a;n++)this._uSectionPlanes.push({active:o.getLocation("sectionPlaneActive"+n),pos:o.getLocation("sectionPlanePos"+n),dir:o.getLocation("sectionPlaneDir"+n)});this._uFillColor=o.getLocation("fillColor"),this._aPosition=o.getAttribute("position"),this._aNormal=o.getAttribute("normal"),this._uClippable=o.getLocation("clippable"),this._uGammaFactor=o.getLocation("gammaFactor"),this._uOffset=o.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=o.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null};bi.prototype._bindProgram=function(r){const e=this._scene,i=e.canvas.gl,s=e._lightsState,t=e.camera,o=t.project;if(this._program.bind(),r.useProgram++,r.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastIndicesBufId=null,i.uniformMatrix4fv(this._uViewNormalMatrix,!1,t.normalMatrix),i.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),e.logarithmicDepthBufferEnabled){const a=2/(Math.log(o.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,a)}for(let a=0,A=s.lights.length;a<A;a++){const l=s.lights[a];this._uLightAmbient[a]?i.uniform4f(this._uLightAmbient[a],l.color[0],l.color[1],l.color[2],l.intensity):(this._uLightColor[a]&&i.uniform4f(this._uLightColor[a],l.color[0],l.color[1],l.color[2],l.intensity),this._uLightPos[a]&&(i.uniform3fv(this._uLightPos[a],l.pos),this._uLightAttenuation[a]&&i.uniform1f(this._uLightAttenuation[a],l.attenuation)),this._uLightDir[a]&&i.uniform3fv(this._uLightDir[a],l.dir))}this._uGammaFactor&&i.uniform1f(this._uGammaFactor,e.gammaFactor)};class t0{constructor(e){this.vertex=i0(e),this.fragment=s0(e)}}function i0(r){const e=r.scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=!!r._geometry._state.compressGeometry,o=r._state.billboard,n=r._state.stationary,a=[];return a.push("#version 300 es"),a.push("// Edges drawing vertex shader"),a.push("in vec3 position;"),a.push("uniform mat4 modelMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("uniform vec4 edgeColor;"),a.push("uniform vec3 offset;"),t&&a.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),a.push("out float vFragDepth;"),a.push("bool isPerspectiveMatrix(mat4 m) {"),a.push("    return (m[2][3] == - 1.0);"),a.push("}"),a.push("out float isPerspective;")),s&&a.push("out vec4 vWorldPosition;"),a.push("out vec4 vColor;"),(o==="spherical"||o==="cylindrical")&&(a.push("void billboard(inout mat4 mat) {"),a.push("   mat[0][0] = 1.0;"),a.push("   mat[0][1] = 0.0;"),a.push("   mat[0][2] = 0.0;"),o==="spherical"&&(a.push("   mat[1][0] = 0.0;"),a.push("   mat[1][1] = 1.0;"),a.push("   mat[1][2] = 0.0;")),a.push("   mat[2][0] = 0.0;"),a.push("   mat[2][1] = 0.0;"),a.push("   mat[2][2] =1.0;"),a.push("}")),a.push("void main(void) {"),a.push("vec4 localPosition = vec4(position, 1.0); "),a.push("vec4 worldPosition;"),t&&a.push("localPosition = positionsDecodeMatrix * localPosition;"),a.push("mat4 viewMatrix2 = viewMatrix;"),a.push("mat4 modelMatrix2 = modelMatrix;"),n&&a.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),o==="spherical"||o==="cylindrical"?(a.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),a.push("billboard(modelMatrix2);"),a.push("billboard(viewMatrix2);"),a.push("billboard(modelViewMatrix);"),a.push("worldPosition = modelMatrix2 * localPosition;"),a.push("worldPosition.xyz = worldPosition.xyz + offset;"),a.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(a.push("worldPosition = modelMatrix2 * localPosition;"),a.push("worldPosition.xyz = worldPosition.xyz + offset;"),a.push("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),a.push("vColor = edgeColor;"),s&&a.push("vWorldPosition = worldPosition;"),a.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(a.push("vFragDepth = 1.0 + clipPos.w;"),a.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),a.push("gl_Position = clipPos;"),a.push("}"),a}function s0(r){const e=r.scene,i=r.scene._sectionPlanesState,s=r.scene.gammaOutput,t=i.getNumAllocatedSectionPlanes()>0,o=[];if(o.push("#version 300 es"),o.push("// Edges drawing fragment shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&(o.push("in float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),s&&(o.push("uniform float gammaFactor;"),o.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}")),t){o.push("in vec4 vWorldPosition;"),o.push("uniform bool clippable;");for(let n=0,a=i.getNumAllocatedSectionPlanes();n<a;n++)o.push("uniform bool sectionPlaneActive"+n+";"),o.push("uniform vec3 sectionPlanePos"+n+";"),o.push("uniform vec3 sectionPlaneDir"+n+";")}if(o.push("in vec4 vColor;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),t){o.push("if (clippable) {"),o.push("  float dist = 0.0;");for(let n=0,a=i.getNumAllocatedSectionPlanes();n<a;n++)o.push("if (sectionPlaneActive"+n+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}return e.logarithmicDepthBufferEnabled&&o.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s?o.push("outColor = linearToGamma(vColor, gammaFactor);"):o.push("outColor = vColor;"),o.push("}"),o}const wp=new Ci({}),r0=c.vec3(),di=function(r,e){this.id=wp.addItem({}),this._hash=r,this._scene=e.scene,this._useCount=0,this._shaderSource=new t0(e),this._allocate(e)},zA={};di.get=function(r){const e=[r.scene.id,r.scene.gammaOutput?"go":"",r.scene._sectionPlanesState.getHash(),r._geometry._state.compressGeometry?"cp":"",r._state.hash].join(";");let i=zA[e];return i||(i=new di(e,r),zA[e]=i,vt.memory.programs++),i._useCount++,i};di.prototype.put=function(){--this._useCount===0&&(wp.removeItem(this.id),this._program&&this._program.destroy(),delete zA[this._hash],vt.memory.programs--)};di.prototype.webglContextRestored=function(){this._program=null};di.prototype.drawMesh=function(r,e,i){this._program||this._allocate(e);const s=this._scene,t=s.camera,o=s.canvas.gl;let n;const a=e._state,A=e._geometry,l=A._state,h=e.origin;if(r.lastProgramId!==this._program.id&&(r.lastProgramId=this._program.id,this._bindProgram(r)),o.uniformMatrix4fv(this._uViewMatrix,!1,h?r.getRTCViewMatrix(a.originHash,h):t.viewMatrix),a.clippable){const f=s._sectionPlanesState.getNumAllocatedSectionPlanes(),m=s._sectionPlanesState.sectionPlanes.length;if(f>0){const _=s._sectionPlanesState.sectionPlanes,u=e.renderFlags;for(let P=0;P<f;P++){const y=this._uSectionPlanes[P];if(y)if(P<m){const x=u.sectionPlanesActivePerLayer[P];if(o.uniform1i(y.active,x?1:0),x){const B=_[P];if(h){const v=Ut(B.dist,B.dir,h,r0);o.uniform3fv(y.pos,v)}else o.uniform3fv(y.pos,B.pos);o.uniform3fv(y.dir,B.dir)}}else o.uniform1i(y.active,0)}}}switch(i){case 0:n=e._xrayMaterial._state;break;case 1:n=e._highlightMaterial._state;break;case 2:n=e._selectedMaterial._state;break;case 3:default:n=e._edgeMaterial._state;break}if(n.id!==this._lastMaterialId){const f=n.backfaces;if(r.backfaces!==f&&(f?o.disable(o.CULL_FACE):o.enable(o.CULL_FACE),r.backfaces=f),r.lineWidth!==n.edgeWidth&&(o.lineWidth(n.edgeWidth),r.lineWidth=n.edgeWidth),this._uEdgeColor){const m=n.edgeColor,_=n.edgeAlpha;o.uniform4f(this._uEdgeColor,m[0],m[1],m[2],_)}this._lastMaterialId=n.id}o.uniformMatrix4fv(this._uModelMatrix,o.FALSE,e.worldMatrix),this._uClippable&&o.uniform1i(this._uClippable,a.clippable),o.uniform3fv(this._uOffset,a.offset);let d;l.primitive===o.TRIANGLES?d=A._getEdgeIndices():l.primitive===o.LINES&&(d=l.indicesBuf),d&&(l.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(l.positionsBuf,l.compressGeometry?o.UNSIGNED_SHORT:o.FLOAT),r.bindArray++),d.bind(),r.bindArray++,this._lastGeometryId=l.id),o.drawElements(o.LINES,d.numItems,d.itemType,0),r.drawElements++)};di.prototype._allocate=function(r){const e=r.scene,i=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new It(i,this._shaderSource),this._program.errors){this.errors=this._program.errors;return}const t=this._program;this._uPositionsDecodeMatrix=t.getLocation("positionsDecodeMatrix"),this._uModelMatrix=t.getLocation("modelMatrix"),this._uViewMatrix=t.getLocation("viewMatrix"),this._uProjMatrix=t.getLocation("projMatrix"),this._uSectionPlanes=[];for(let o=0,n=s.getNumAllocatedSectionPlanes();o<n;o++)this._uSectionPlanes.push({active:t.getLocation("sectionPlaneActive"+o),pos:t.getLocation("sectionPlanePos"+o),dir:t.getLocation("sectionPlaneDir"+o)});this._uEdgeColor=t.getLocation("edgeColor"),this._aPosition=t.getAttribute("position"),this._uClippable=t.getLocation("clippable"),this._uGammaFactor=t.getLocation("gammaFactor"),this._uOffset=t.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=t.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null};di.prototype._bindProgram=function(r){const e=this._program,i=this._scene,s=i.canvas.gl,o=i.camera.project;if(e.bind(),r.useProgram++,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,s.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),i.logarithmicDepthBufferEnabled){const n=2/(Math.log(o.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,n)}this._uGammaFactor&&s.uniform1f(this._uGammaFactor,i.gammaFactor)};class o0{constructor(e){this.vertex=n0(e),this.fragment=a0(e)}}function n0(r){const e=r.scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=!!r._geometry._state.compressGeometry,o=r._state.billboard,n=r._state.stationary,a=[];return a.push("#version 300 es"),a.push("// Mesh picking vertex shader"),a.push("in vec3 position;"),a.push("uniform mat4 modelMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("out vec4 vViewPosition;"),a.push("uniform vec3 offset;"),t&&a.push("uniform mat4 positionsDecodeMatrix;"),s&&a.push("out vec4 vWorldPosition;"),e.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),a.push("out float vFragDepth;"),a.push("bool isPerspectiveMatrix(mat4 m) {"),a.push("    return (m[2][3] == - 1.0);"),a.push("}"),a.push("out float isPerspective;")),(o==="spherical"||o==="cylindrical")&&(a.push("void billboard(inout mat4 mat) {"),a.push("   mat[0][0] = 1.0;"),a.push("   mat[0][1] = 0.0;"),a.push("   mat[0][2] = 0.0;"),o==="spherical"&&(a.push("   mat[1][0] = 0.0;"),a.push("   mat[1][1] = 1.0;"),a.push("   mat[1][2] = 0.0;")),a.push("   mat[2][0] = 0.0;"),a.push("   mat[2][1] = 0.0;"),a.push("   mat[2][2] =1.0;"),a.push("}")),a.push("uniform vec2 pickClipPos;"),a.push("vec4 remapClipPos(vec4 clipPos) {"),a.push("    clipPos.xy /= clipPos.w;"),a.push("    clipPos.xy -= pickClipPos;"),a.push("    clipPos.xy *= clipPos.w;"),a.push("    return clipPos;"),a.push("}"),a.push("void main(void) {"),a.push("vec4 localPosition = vec4(position, 1.0); "),t&&a.push("localPosition = positionsDecodeMatrix * localPosition;"),a.push("mat4 viewMatrix2 = viewMatrix;"),a.push("mat4 modelMatrix2 = modelMatrix;"),n&&a.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),(o==="spherical"||o==="cylindrical")&&(a.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),a.push("billboard(modelMatrix2);"),a.push("billboard(viewMatrix2);")),a.push("   vec4 worldPosition = modelMatrix2 * localPosition;"),a.push("   worldPosition.xyz = worldPosition.xyz + offset;"),a.push("   vec4 viewPosition = viewMatrix2 * worldPosition;"),s&&a.push("   vWorldPosition = worldPosition;"),a.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(a.push("vFragDepth = 1.0 + clipPos.w;"),a.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),a.push("gl_Position = remapClipPos(clipPos);"),a.push("}"),a}function a0(r){const e=r.scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Mesh picking fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),t.push("uniform vec4 pickColor;"),s){t.push("uniform bool clippable;"),t.push("in vec4 vWorldPosition;");for(var o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("out vec4 outColor;"),t.push("void main(void) {"),s){t.push("if (clippable) {"),t.push("  float dist = 0.0;");for(var o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("  if (dist > 0.0) { discard; }"),t.push("}")}return e.logarithmicDepthBufferEnabled&&t.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("   outColor = pickColor; "),t.push("}"),t}const A0=c.vec3(),$i=function(r,e){this._hash=r,this._shaderSource=new o0(e),this._scene=e.scene,this._useCount=0,this._allocate(e)},KA={};$i.get=function(r){const e=[r.scene.canvas.canvas.id,r.scene._sectionPlanesState.getHash(),r._geometry._state.hash,r._state.hash].join(";");let i=KA[e];if(!i){if(i=new $i(e,r),i.errors)return console.log(i.errors.join(`
`)),null;KA[e]=i,vt.memory.programs++}return i._useCount++,i};$i.prototype.put=function(){--this._useCount===0&&(this._program&&this._program.destroy(),delete KA[this._hash],vt.memory.programs--)};$i.prototype.webglContextRestored=function(){this._program=null};$i.prototype.drawMesh=function(r,e){this._program||this._allocate(e);const i=this._scene,s=i.canvas.gl,t=e._state,o=e._material._state,n=e._geometry._state,a=e.origin;if(r.lastProgramId!==this._program.id&&(r.lastProgramId=this._program.id,this._bindProgram(r)),s.uniformMatrix4fv(this._uViewMatrix,!1,a?r.getRTCPickViewMatrix(t.originHash,a):r.pickViewMatrix),t.clippable){const m=i._sectionPlanesState.getNumAllocatedSectionPlanes(),_=i._sectionPlanesState.sectionPlanes.length;if(m>0){const u=i._sectionPlanesState.sectionPlanes,P=e.renderFlags;for(let y=0;y<m;y++){const x=this._uSectionPlanes[y];if(x)if(y<_){const B=P.sectionPlanesActivePerLayer[y];if(s.uniform1i(x.active,B?1:0),B){const v=u[y];if(a){const w=Ut(v.dist,v.dir,a,A0);s.uniform3fv(x.pos,w)}else s.uniform3fv(x.pos,v.pos);s.uniform3fv(x.dir,v.dir)}}else s.uniform1i(x.active,0)}}}if(o.id!==this._lastMaterialId){const m=o.backfaces;r.backfaces!==m&&(m?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),r.backfaces=m);const _=o.frontface;r.frontface!==_&&(_?s.frontFace(s.CCW):s.frontFace(s.CW),r.frontface=_),this._lastMaterialId=o.id}s.uniformMatrix4fv(this._uProjMatrix,!1,r.pickProjMatrix),s.uniformMatrix4fv(this._uModelMatrix,!1,e.worldMatrix),this._uClippable&&s.uniform1i(this._uClippable,e._state.clippable),s.uniform3fv(this._uOffset,e._state.offset),n.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,n.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(n.positionsBuf,n.compressGeometry?s.UNSIGNED_SHORT:s.FLOAT),r.bindArray++),n.indicesBuf&&(n.indicesBuf.bind(),r.bindArray++),this._lastGeometryId=n.id);var A=e._state.pickID;const l=A>>24&255,h=A>>16&255,d=A>>8&255,f=A&255;s.uniform4f(this._uPickColor,f/255,d/255,h/255,l/255),s.uniform2fv(this._uPickClipPos,r.pickClipPos),n.indicesBuf?(s.drawElements(n.primitive,n.indicesBuf.numItems,n.indicesBuf.itemType,0),r.drawElements++):n.positions&&s.drawArrays(s.TRIANGLES,0,n.positions.numItems)};$i.prototype._allocate=function(r){const e=r.scene,i=e.canvas.gl;if(this._program=new It(i,this._shaderSource),this._program.errors){this.errors=this._program.errors;return}const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];const t=e._sectionPlanesState.sectionPlanes;for(let o=0,n=t.length;o<n;o++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+o),pos:s.getLocation("sectionPlanePos"+o),dir:s.getLocation("sectionPlaneDir"+o)});this._aPosition=s.getAttribute("position"),this._uClippable=s.getLocation("clippable"),this._uPickColor=s.getLocation("pickColor"),this._uPickClipPos=s.getLocation("pickClipPos"),this._uOffset=s.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastGeometryId=null};$i.prototype._bindProgram=function(r){const e=this._scene,i=e.canvas.gl,s=e.camera.project;if(this._program.bind(),r.useProgram++,e.logarithmicDepthBufferEnabled){const t=2/(Math.log(s.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,t)}this._lastMaterialId=null,this._lastGeometryId=null};class l0{constructor(e){this.vertex=c0(e),this.fragment=h0(e)}}function c0(r){const e=r.scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=!!r._geometry._state.compressGeometry,o=[];return o.push("#version 300 es"),o.push("// Surface picking vertex shader"),o.push("in vec3 position;"),o.push("in vec4 color;"),o.push("uniform mat4 modelMatrix;"),o.push("uniform mat4 viewMatrix;"),o.push("uniform mat4 projMatrix;"),o.push("uniform vec3 offset;"),s&&(o.push("uniform bool clippable;"),o.push("out vec4 vWorldPosition;")),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;"),o.push("bool isPerspectiveMatrix(mat4 m) {"),o.push("    return (m[2][3] == - 1.0);"),o.push("}"),o.push("out float isPerspective;")),o.push("uniform vec2 pickClipPos;"),o.push("vec4 remapClipPos(vec4 clipPos) {"),o.push("    clipPos.xy /= clipPos.w;"),o.push("    clipPos.xy -= pickClipPos;"),o.push("    clipPos.xy *= clipPos.w;"),o.push("    return clipPos;"),o.push("}"),o.push("out vec4 vColor;"),t&&o.push("uniform mat4 positionsDecodeMatrix;"),o.push("void main(void) {"),o.push("vec4 localPosition = vec4(position, 1.0); "),t&&o.push("localPosition = positionsDecodeMatrix * localPosition;"),o.push("   vec4 worldPosition = modelMatrix * localPosition; "),o.push("   worldPosition.xyz = worldPosition.xyz + offset;"),o.push("   vec4 viewPosition = viewMatrix * worldPosition;"),s&&o.push("   vWorldPosition = worldPosition;"),o.push("   vColor = color;"),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),o.push("gl_Position = remapClipPos(clipPos);"),o.push("}"),o}function h0(r){const e=r.scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Surface picking fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),t.push("in vec4 vColor;"),e.logarithmicDepthBufferEnabled&&(t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),s){t.push("uniform bool clippable;"),t.push("in vec4 vWorldPosition;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("out vec4 outColor;"),t.push("void main(void) {"),s){t.push("if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("  if (dist > 0.0) { discard; }"),t.push("}")}return e.logarithmicDepthBufferEnabled&&t.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("   outColor = vColor;"),t.push("}"),t}const u0=c.vec3(),Is=function(r,e){this._hash=r,this._scene=e.scene,this._useCount=0,this._shaderSource=new l0(e),this._allocate(e)},WA={};Is.get=function(r){const e=[r.scene.canvas.canvas.id,r.scene._sectionPlanesState.getHash(),r._geometry._state.compressGeometry?"cp":"",r._state.hash].join(";");let i=WA[e];if(!i){if(i=new Is(e,r),i.errors)return console.log(i.errors.join(`
`)),null;WA[e]=i,vt.memory.programs++}return i._useCount++,i};Is.prototype.put=function(){--this._useCount===0&&(this._program&&this._program.destroy(),delete WA[this._hash],vt.memory.programs--)};Is.prototype.webglContextRestored=function(){this._program=null};Is.prototype.drawMesh=function(r,e){this._program||this._allocate(e);const i=this._scene,s=i.canvas.gl,t=e._state,o=e._material._state,n=e._geometry,a=e._geometry._state,A=e.origin,l=o.backfaces,h=o.frontface,d=i.camera.project,f=n._getPickTrianglePositions(),m=n._getPickTriangleColors();if(this._program.bind(),r.useProgram++,i.logarithmicDepthBufferEnabled){const _=2/(Math.log(d.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,_)}if(s.uniformMatrix4fv(this._uViewMatrix,!1,A?r.getRTCPickViewMatrix(t.originHash,A):r.pickViewMatrix),t.clippable){const _=i._sectionPlanesState.getNumAllocatedSectionPlanes(),u=i._sectionPlanesState.sectionPlanes.length;if(_>0){const P=i._sectionPlanesState.sectionPlanes,y=e.renderFlags;for(let x=0;x<_;x++){const B=this._uSectionPlanes[x];if(B)if(x<u){const v=y.sectionPlanesActivePerLayer[x];if(s.uniform1i(B.active,v?1:0),v){const w=P[x];if(A){const C=Ut(w.dist,w.dir,A,u0);s.uniform3fv(B.pos,C)}else s.uniform3fv(B.pos,w.pos);s.uniform3fv(B.dir,w.dir)}}else s.uniform1i(B.active,0)}}}s.uniformMatrix4fv(this._uProjMatrix,!1,r.pickProjMatrix),i.logarithmicDepthBufferEnabled&&s.uniform1f(this._uZFar,i.camera.project.far),r.backfaces!==l&&(l?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),r.backfaces=l),r.frontface!==h&&(h?s.frontFace(s.CCW):s.frontFace(s.CW),r.frontface=h),s.uniformMatrix4fv(this._uModelMatrix,!1,e.worldMatrix),this._uClippable&&s.uniform1i(this._uClippable,e._state.clippable),s.uniform3fv(this._uOffset,e._state.offset),this._uPositionsDecodeMatrix?(s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,a.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(f,a.compressGeometry?s.UNSIGNED_SHORT:s.FLOAT)):this._aPosition.bindArrayBuffer(f),s.uniform2fv(this._uPickClipPos,r.pickClipPos),m.bind(),s.enableVertexAttribArray(this._aColor.location),s.vertexAttribPointer(this._aColor.location,m.itemSize,m.itemType,!0,0,0),s.drawArrays(a.primitive,0,f.numItems/3)};Is.prototype._allocate=function(r){const e=r.scene,i=e.canvas.gl;if(this._program=new It(i,this._shaderSource),this._useCount=0,this._program.errors){this.errors=this._program.errors;return}const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];const t=e._sectionPlanesState.sectionPlanes;for(let o=0,n=t.length;o<n;o++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+o),pos:s.getLocation("sectionPlanePos"+o),dir:s.getLocation("sectionPlaneDir"+o)});this._aPosition=s.getAttribute("position"),this._aColor=s.getAttribute("color"),this._uPickClipPos=s.getLocation("pickClipPos"),this._uClippable=s.getLocation("clippable"),this._uOffset=s.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))};class d0{constructor(e){this.vertex=p0(e),this.fragment=f0(e)}}function p0(r){const e=r.scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=!!r._geometry._state.compressGeometry,o=r._state.billboard,n=r._state.stationary,a=[];return a.push("#version 300 es"),a.push("// Mesh occlusion vertex shader"),a.push("in vec3 position;"),a.push("uniform mat4 modelMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("uniform vec3 offset;"),t&&a.push("uniform mat4 positionsDecodeMatrix;"),s&&a.push("out vec4 vWorldPosition;"),e.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),a.push("out float vFragDepth;"),a.push("bool isPerspectiveMatrix(mat4 m) {"),a.push("    return (m[2][3] == - 1.0);"),a.push("}"),a.push("out float isPerspective;")),(o==="spherical"||o==="cylindrical")&&(a.push("void billboard(inout mat4 mat) {"),a.push("   mat[0][0] = 1.0;"),a.push("   mat[0][1] = 0.0;"),a.push("   mat[0][2] = 0.0;"),o==="spherical"&&(a.push("   mat[1][0] = 0.0;"),a.push("   mat[1][1] = 1.0;"),a.push("   mat[1][2] = 0.0;")),a.push("   mat[2][0] = 0.0;"),a.push("   mat[2][1] = 0.0;"),a.push("   mat[2][2] =1.0;"),a.push("}")),a.push("void main(void) {"),a.push("vec4 localPosition = vec4(position, 1.0); "),a.push("vec4 worldPosition;"),t&&a.push("localPosition = positionsDecodeMatrix * localPosition;"),a.push("mat4 viewMatrix2 = viewMatrix;"),a.push("mat4 modelMatrix2 = modelMatrix;"),n&&a.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),o==="spherical"||o==="cylindrical"?(a.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),a.push("billboard(modelMatrix2);"),a.push("billboard(viewMatrix2);"),a.push("billboard(modelViewMatrix);"),a.push("worldPosition = modelMatrix2 * localPosition;"),a.push("worldPosition.xyz = worldPosition.xyz + offset;"),a.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(a.push("worldPosition = modelMatrix2 * localPosition;"),a.push("worldPosition.xyz = worldPosition.xyz + offset;"),a.push("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),s&&a.push("   vWorldPosition = worldPosition;"),a.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(a.push("vFragDepth = 1.0 + clipPos.w;"),a.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),a.push("gl_Position = clipPos;"),a.push("}"),a}function f0(r){const e=r.scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Mesh occlusion fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),s){t.push("uniform bool clippable;"),t.push("in vec4 vWorldPosition;");for(var o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("out vec4 outColor;"),t.push("void main(void) {"),s){t.push("if (clippable) {"),t.push("  float dist = 0.0;");for(var o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("  if (dist > 0.0) { discard; }"),t.push("}")}return t.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),e.logarithmicDepthBufferEnabled&&t.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("}"),t}const g0=c.vec3(),Zi=function(r,e){this._hash=r,this._shaderSource=new d0(e),this._scene=e.scene,this._useCount=0,this._allocate(e)},XA={};Zi.get=function(r){const e=[r.scene.canvas.canvas.id,r.scene._sectionPlanesState.getHash(),r._geometry._state.hash,r._state.occlusionHash].join(";");let i=XA[e];if(!i){if(i=new Zi(e,r),i.errors)return console.log(i.errors.join(`
`)),null;XA[e]=i,vt.memory.programs++}return i._useCount++,i};Zi.prototype.put=function(){--this._useCount===0&&(this._program&&this._program.destroy(),delete XA[this._hash],vt.memory.programs--)};Zi.prototype.webglContextRestored=function(){this._program=null};Zi.prototype.drawMesh=function(r,e){this._program||this._allocate(e);const i=this._scene,s=i.canvas.gl,t=e._material._state,o=e._state,n=e._geometry._state,a=e.origin;if(t.alpha<1)return;if(r.lastProgramId!==this._program.id&&(r.lastProgramId=this._program.id,this._bindProgram(r)),t.id!==this._lastMaterialId){const l=t.backfaces;r.backfaces!==l&&(l?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),r.backfaces=l);const h=t.frontface;r.frontface!==h&&(h?s.frontFace(s.CCW):s.frontFace(s.CW),r.frontface=h),this._lastMaterialId=t.id}const A=i.camera;if(s.uniformMatrix4fv(this._uViewMatrix,!1,a?r.getRTCViewMatrix(o.originHash,a):A.viewMatrix),o.clippable){const l=i._sectionPlanesState.getNumAllocatedSectionPlanes(),h=i._sectionPlanesState.sectionPlanes.length;if(l>0){const d=i._sectionPlanesState.sectionPlanes,f=e.renderFlags;for(let m=0;m<l;m++){const _=this._uSectionPlanes[m];if(_)if(m<h){const u=f.sectionPlanesActivePerLayer[m];if(s.uniform1i(_.active,u?1:0),u){const P=d[m];if(a){const y=Ut(P.dist,P.dir,a,g0);s.uniform3fv(_.pos,y)}else s.uniform3fv(_.pos,P.pos);s.uniform3fv(_.dir,P.dir)}}else s.uniform1i(_.active,0)}}}s.uniformMatrix4fv(this._uProjMatrix,!1,A._project._state.matrix),s.uniformMatrix4fv(this._uModelMatrix,s.FALSE,e.worldMatrix),this._uClippable&&s.uniform1i(this._uClippable,e._state.clippable),s.uniform3fv(this._uOffset,e._state.offset),n.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,n.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(n.positionsBuf,n.compressGeometry?s.UNSIGNED_SHORT:s.FLOAT),r.bindArray++),n.indicesBuf&&(n.indicesBuf.bind(),r.bindArray++),this._lastGeometryId=n.id),n.indicesBuf?(s.drawElements(n.primitive,n.indicesBuf.numItems,n.indicesBuf.itemType,0),r.drawElements++):n.positions&&s.drawArrays(s.TRIANGLES,0,n.positions.numItems)};Zi.prototype._allocate=function(r){const e=r.scene,i=e.canvas.gl;if(this._program=new It(i,this._shaderSource),this._program.errors){this.errors=this._program.errors;return}const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];const t=e._sectionPlanesState.sectionPlanes;for(let o=0,n=t.length;o<n;o++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+o),pos:s.getLocation("sectionPlanePos"+o),dir:s.getLocation("sectionPlaneDir"+o)});this._aPosition=s.getAttribute("position"),this._uClippable=s.getLocation("clippable"),this._uOffset=s.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null};Zi.prototype._bindProgram=function(r){const e=this._scene,i=e.camera.project,s=e.canvas.gl;if(this._program.bind(),r.useProgram++,s.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,t)}this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null};class m0{constructor(e){this.vertex=_0(e),this.fragment=v0(e)}}function _0(r){const i=r.scene._sectionPlanesState.sectionPlanes.length>0,s=!!r._geometry._state.compressGeometry,t=[];return t.push("// Mesh shadow vertex shader"),t.push("in vec3 position;"),t.push("uniform mat4 modelMatrix;"),t.push("uniform mat4 shadowViewMatrix;"),t.push("uniform mat4 shadowProjMatrix;"),t.push("uniform vec3 offset;"),s&&t.push("uniform mat4 positionsDecodeMatrix;"),i&&t.push("out vec4 vWorldPosition;"),t.push("void main(void) {"),t.push("vec4 localPosition = vec4(position, 1.0); "),t.push("vec4 worldPosition;"),s&&t.push("localPosition = positionsDecodeMatrix * localPosition;"),t.push("worldPosition = modelMatrix * localPosition;"),t.push("worldPosition.xyz = worldPosition.xyz + offset;"),t.push("vec4 viewPosition  = shadowViewMatrix * worldPosition; "),i&&t.push("vWorldPosition = worldPosition;"),t.push("   gl_Position = shadowProjMatrix * viewPosition;"),t.push("}"),t}function v0(r){const e=r.scene;e.canvas.gl;const i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("// Mesh shadow fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),s){t.push("uniform bool clippable;"),t.push("in vec4 vWorldPosition;");for(var o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("vec4 encodeFloat( const in float depth ) {"),t.push("  const vec4 bitShift = vec4(256 * 256 * 256, 256 * 256, 256, 1.0);"),t.push("  const vec4 bitMask = vec4(0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);"),t.push("  vec4 comp = fract(depth * bitShift);"),t.push("  comp -= comp.xxyz * bitMask;"),t.push("  return comp;"),t.push("}"),t.push("out vec4 outColor;"),t.push("void main(void) {"),s){t.push("if (clippable) {"),t.push("  float dist = 0.0;");for(var o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("  if (dist > 0.0) { discard; }"),t.push("}")}return t.push("outColor = encodeFloat(gl_FragCoord.z);"),t.push("}"),t}const hs=function(r,e){this._hash=r,this._shaderSource=new m0(e),this._scene=e.scene,this._useCount=0,this._allocate(e)},YA={};hs.get=function(r){const e=r.scene,i=[e.canvas.canvas.id,e._sectionPlanesState.getHash(),r._geometry._state.hash,r._state.hash].join(";");let s=YA[i];if(!s){if(s=new hs(i,r),s.errors)return console.log(s.errors.join(`
`)),null;YA[i]=s,vt.memory.programs++}return s._useCount++,s};hs.prototype.put=function(){--this._useCount===0&&(this._program&&this._program.destroy(),delete YA[this._hash],vt.memory.programs--)};hs.prototype.webglContextRestored=function(){this._program=null};hs.prototype.drawMesh=function(r,e){this._program||this._allocate(e);const s=this._scene.canvas.gl,t=e._material._state,o=e._geometry._state;if(r.lastProgramId!==this._program.id&&(r.lastProgramId=this._program.id,this._bindProgram(r)),t.id!==this._lastMaterialId){const n=t.backfaces;r.backfaces!==n&&(n?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),r.backfaces=n);const a=t.frontface;r.frontface!==a&&(a?s.frontFace(s.CCW):s.frontFace(s.CW),r.frontface=a),r.lineWidth!==t.lineWidth&&(s.lineWidth(t.lineWidth),r.lineWidth=t.lineWidth),this._uPointSize&&s.uniform1i(this._uPointSize,t.pointSize),this._lastMaterialId=t.id}if(s.uniformMatrix4fv(this._uModelMatrix,s.FALSE,e.worldMatrix),o.combineGeometry){const n=e.vertexBufs;n.id!==this._lastVertexBufsId&&(n.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(n.positionsBuf,n.compressGeometry?s.UNSIGNED_SHORT:s.FLOAT),r.bindArray++),this._lastVertexBufsId=n.id)}this._uClippable&&s.uniform1i(this._uClippable,e._state.clippable),s.uniform3fv(this._uOffset,e._state.offset),o.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,o.positionsDecodeMatrix),o.combineGeometry?o.indicesBufCombined&&(o.indicesBufCombined.bind(),r.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(o.positionsBuf,o.compressGeometry?s.UNSIGNED_SHORT:s.FLOAT),r.bindArray++),o.indicesBuf&&(o.indicesBuf.bind(),r.bindArray++)),this._lastGeometryId=o.id),o.combineGeometry?o.indicesBufCombined&&(s.drawElements(o.primitive,o.indicesBufCombined.numItems,o.indicesBufCombined.itemType,0),r.drawElements++):o.indicesBuf?(s.drawElements(o.primitive,o.indicesBuf.numItems,o.indicesBuf.itemType,0),r.drawElements++):o.positions&&(s.drawArrays(s.TRIANGLES,0,o.positions.numItems),r.drawArrays++)};hs.prototype._allocate=function(r){const e=r.scene,i=e.canvas.gl;if(this._program=new It(i,this._shaderSource),this._scene=e,this._useCount=0,this._program.errors){this.errors=this._program.errors;return}const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uShadowViewMatrix=s.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=s.getLocation("shadowProjMatrix"),this._uSectionPlanes={};const t=e._sectionPlanesState.sectionPlanes;for(let o=0,n=t.length;o<n;o++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+o),pos:s.getLocation("sectionPlanePos"+o),dir:s.getLocation("sectionPlaneDir"+o)});this._aPosition=s.getAttribute("position"),this._uClippable=s.getLocation("clippable"),this._uOffset=s.getLocation("offset"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null};hs.prototype._bindProgram=function(r){this._program||this._allocate(mesh);const e=this._scene,i=e.canvas.gl,s=e._sectionPlanesState;if(this._program.bind(),r.useProgram++,i.uniformMatrix4fv(this._uShadowViewMatrix,!1,r.shadowViewMatrix),i.uniformMatrix4fv(this._uShadowProjMatrix,!1,r.shadowProjMatrix),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,s.getNumAllocatedSectionPlanes()>0){let t,o,n,a,A;for(let l=0,h=this._uSectionPlanes.length;l<h;l++)t=this._uSectionPlanes[l],o=t.active,n=s.sectionPlanes[l],o&&i.uniform1i(o,n.active),a=t.pos,a&&i.uniform3fv(t.pos,n.pos),A=t.dir,A&&i.uniform3fv(t.dir,n.dir)}};class bp{constructor(){this.visibleLayers=[],this.sectionPlanesActivePerLayer=[],this.reset()}reset(){this.culled=!1,this.sectioned=!1,this.numLayers=0,this.numVisibleLayers=0,this.colorOpaque=!1,this.colorTransparent=!1,this.edgesOpaque=!1,this.edgesTransparent=!1,this.xrayedSilhouetteOpaque=!1,this.xrayedEdgesOpaque=!1,this.xrayedSilhouetteTransparent=!1,this.xrayedEdgesTransparent=!1,this.highlightedSilhouetteOpaque=!1,this.highlightedEdgesOpaque=!1,this.highlightedSilhouetteTransparent=!1,this.highlightedEdgesTransparent=!1,this.selectedSilhouetteOpaque=!1,this.selectedEdgesOpaque=!1,this.selectedSilhouetteTransparent=!1,this.selectedEdgesTransparent=!1}}const jc=c.OBB3(),Fi=c.vec4(),br=c.vec4(),Gc=c.vec4(),zc=c.vec3([1,0,0]),Kc=c.vec3([0,1,0]),Wc=c.vec3([0,0,1]),Xc=c.vec3(3),Yc=c.vec3(3),P0=c.identityMat4();class B0 extends Et{constructor(e,i={}){super(e,i),this.originalSystemId=i.originalSystemId||this.id,this.renderFlags=new bp,this._state=new Ft({visible:!0,culled:!1,pickable:null,clippable:null,collidable:null,occluder:i.occluder!==!1,castsShadow:null,receivesShadow:null,xrayed:!1,highlighted:!1,selected:!1,edges:!1,stationary:!!i.stationary,background:!!i.background,billboard:this._checkBillboard(i.billboard),layer:null,colorize:null,pickID:this.scene._renderer.getPickID(this),drawHash:"",pickHash:"",offset:c.vec3(),origin:null,originHash:null}),this._drawRenderer=null,this._shadowRenderer=null,this._emphasisFillRenderer=null,this._emphasisEdgesRenderer=null,this._pickMeshRenderer=null,this._pickTriangleRenderer=null,this._occlusionRenderer=null,this._geometry=i.geometry?this._checkComponent2(["ReadableGeometry","VBOGeometry"],i.geometry):this.scene.geometry,this._material=i.material?this._checkComponent2(["PhongMaterial","MetallicMaterial","SpecularMaterial","LambertMaterial"],i.material):this.scene.material,this._xrayMaterial=i.xrayMaterial?this._checkComponent("EmphasisMaterial",i.xrayMaterial):this.scene.xrayMaterial,this._highlightMaterial=i.highlightMaterial?this._checkComponent("EmphasisMaterial",i.highlightMaterial):this.scene.highlightMaterial,this._selectedMaterial=i.selectedMaterial?this._checkComponent("EmphasisMaterial",i.selectedMaterial):this.scene.selectedMaterial,this._edgeMaterial=i.edgeMaterial?this._checkComponent("EdgeMaterial",i.edgeMaterial):this.scene.edgeMaterial,this._parentNode=null,this._aabb=null,this._aabbDirty=!0,this._numTriangles=this._geometry?this._geometry.numTriangles:0,this.scene._aabbDirty=!0,this._scale=c.vec3(),this._quaternion=c.identityQuaternion(),this._rotation=c.vec3(),this._position=c.vec3(),this._worldMatrix=c.identityMat4(),this._worldNormalMatrix=c.identityMat4(),this._localMatrixDirty=!0,this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0;const s=i.origin||i.rtcCenter;if(s&&(this._state.origin=c.vec3(s),this._state.originHash=s.join()),i.matrix?this.matrix=i.matrix:(this.scale=i.scale,this.position=i.position,i.quaternion||(this.rotation=i.rotation)),this._isObject=i.isObject,this._isObject&&this.scene._registerObject(this),this._isModel=i.isModel,this._isModel&&this.scene._registerModel(this),this.visible=i.visible,this.culled=i.culled,this.pickable=i.pickable,this.clippable=i.clippable,this.collidable=i.collidable,this.castsShadow=i.castsShadow,this.receivesShadow=i.receivesShadow,this.xrayed=i.xrayed,this.highlighted=i.highlighted,this.selected=i.selected,this.edges=i.edges,this.layer=i.layer,this.colorize=i.colorize,this.opacity=i.opacity,this.offset=i.offset,i.parentId){const t=this.scene.components[i.parentId];t?t.isNode?t.addChild(this):this.error("Parent is not a Node: '"+i.parentId+"'"):this.error("Parent not found: '"+i.parentId+"'"),this._parentNode=t}else i.parent&&(i.parent.isNode||this.error("Parent is not a Node"),i.parent.addChild(this),this._parentNode=i.parent);this.compile()}get type(){return"Mesh"}get isMesh(){return!0}get parent(){return this._parentNode}get geometry(){return this._geometry}get material(){return this._material}get position(){return this._position}set position(e){this._position.set(e||[0,0,0]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get rotation(){return this._rotation}set rotation(e){this._rotation.set(e||[0,0,0]),c.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get quaternion(){return this._quaternion}set quaternion(e){this._quaternion.set(e||[0,0,0,1]),c.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get scale(){return this._scale}set scale(e){this._scale.set(e||[1,1,1]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get matrix(){return this._localMatrixDirty&&(this.__localMatrix||(this.__localMatrix=c.identityMat4()),c.composeMat4(this._position,this._quaternion,this._scale,this.__localMatrix),this._localMatrixDirty=!1),this.__localMatrix}set matrix(e){this.__localMatrix||(this.__localMatrix=c.identityMat4()),this.__localMatrix.set(e||P0),c.decomposeMat4(this.__localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._setWorldMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get worldMatrix(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix}get worldNormalMatrix(){return this._worldNormalMatrixDirty&&this._buildWorldNormalMatrix(),this._worldNormalMatrix}get isEntity(){return!0}get isModel(){return this._isModel}get isObject(){return this._isObject}get aabb(){return this._aabbDirty&&this._updateAABB(),this._aabb}get origin(){return this._state.origin}set origin(e){e?(this._state.origin||(this._state.origin=c.vec3()),this._state.origin.set(e),this._state.originHash=e.join(),this._setAABBDirty(),this.scene._aabbDirty=!0):this._state.origin&&(this._state.origin=null,this._state.originHash=null,this._setAABBDirty(),this.scene._aabbDirty=!0)}get rtcCenter(){return this.origin}set rtcCenter(e){this.origin=e}get numTriangles(){return this._numTriangles}get visible(){return this._state.visible}set visible(e){e=e!==!1,this._state.visible=e,this._isObject&&this.scene._objectVisibilityUpdated(this,e),this.glRedraw()}get xrayed(){return this._state.xrayed}set xrayed(e){e=!!e,this._state.xrayed!==e&&(this._state.xrayed=e,this._isObject&&this.scene._objectXRayedUpdated(this,e),this.glRedraw())}get highlighted(){return this._state.highlighted}set highlighted(e){e=!!e,e!==this._state.highlighted&&(this._state.highlighted=e,this._isObject&&this.scene._objectHighlightedUpdated(this,e),this.glRedraw())}get selected(){return this._state.selected}set selected(e){e=!!e,e!==this._state.selected&&(this._state.selected=e,this._isObject&&this.scene._objectSelectedUpdated(this,e),this.glRedraw())}get edges(){return this._state.edges}set edges(e){e=!!e,e!==this._state.edges&&(this._state.edges=e,this.glRedraw())}get culled(){return this._state.culled}set culled(e){this._state.culled=!!e,this.glRedraw()}get clippable(){return this._state.clippable}set clippable(e){e=e!==!1,this._state.clippable!==e&&(this._state.clippable=e,this.glRedraw())}get collidable(){return this._state.collidable}set collidable(e){e=e!==!1,e!==this._state.collidable&&(this._state.collidable=e,this._setAABBDirty(),this.scene._aabbDirty=!0)}get pickable(){return this._state.pickable}set pickable(e){e=e!==!1,this._state.pickable!==e&&(this._state.pickable=e)}get castsShadow(){return this._state.castsShadow}set castsShadow(e){e=e!==!1,e!==this._state.castsShadow&&(this._state.castsShadow=e,this.glRedraw())}get receivesShadow(){return this._state.receivesShadow}set receivesShadow(e){e=e!==!1,e!==this._state.receivesShadow&&(this._state.receivesShadow=e,this._state.hash=e?"/mod/rs;":"/mod;",this.fire("dirty",this))}get saoEnabled(){return!1}get colorize(){return this._state.colorize}set colorize(e){let i=this._state.colorize;i||(i=this._state.colorize=new Float32Array(4),i[3]=1),e?(i[0]=e[0],i[1]=e[1],i[2]=e[2]):(i[0]=1,i[1]=1,i[2]=1);const s=!!e;this.scene._objectColorizeUpdated(this,s),this.glRedraw()}get opacity(){return this._state.colorize[3]}set opacity(e){let i=this._state.colorize;i||(i=this._state.colorize=new Float32Array(4),i[0]=1,i[1]=1,i[2]=1);const s=e!=null;i[3]=s?e:1,this.scene._objectOpacityUpdated(this,s),this.glRedraw()}get transparent(){return this._material.alphaMode===2||this._state.colorize[3]<1}get layer(){return this._state.layer}set layer(e){e=e||0,e=Math.round(e),e!==this._state.layer&&(this._state.layer=e,this._renderer.needStateSort())}get stationary(){return this._state.stationary}get billboard(){return this._state.billboard}get offset(){return this._state.offset}set offset(e){this._state.offset.set(e||[0,0,0]),this._setAABBDirty(),this.glRedraw()}get isDrawable(){return!0}get isStateSortable(){return!0}get xrayMaterial(){return this._xrayMaterial}get highlightMaterial(){return this._highlightMaterial}get selectedMaterial(){return this._selectedMaterial}get edgeMaterial(){return this._edgeMaterial}_checkBillboard(e){return e=e||"none",e!=="spherical"&&e!=="cylindrical"&&e!=="none"&&(this.error("Unsupported value for 'billboard': "+e+" - accepted values are 'spherical', 'cylindrical' and 'none' - defaulting to 'none'."),e="none"),e}compile(){const e=this._makeDrawHash();this._state.drawHash!==e&&(this._state.drawHash=e,this._putDrawRenderers(),this._drawRenderer=Ri.get(this),this._emphasisFillRenderer=bi.get(this),this._emphasisEdgesRenderer=di.get(this));const i=this._makePickHash();if(this._state.pickHash!==i&&(this._state.pickHash=i,this._putPickRenderers(),this._pickMeshRenderer=$i.get(this)),this._state.occluder){const s=this._makeOcclusionHash();this._state.occlusionHash!==s&&(this._state.occlusionHash=s,this._putOcclusionRenderer(),this._occlusionRenderer=Zi.get(this))}}_setLocalMatrixDirty(){this._localMatrixDirty=!0,this._setWorldMatrixDirty()}_setWorldMatrixDirty(){this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0}_buildWorldMatrix(){const e=this.matrix;if(this._parentNode)c.mulMat4(this._parentNode.worldMatrix,e,this._worldMatrix);else for(let i=0,s=e.length;i<s;i++)this._worldMatrix[i]=e[i];this._worldMatrixDirty=!1}_buildWorldNormalMatrix(){this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldNormalMatrix||(this._worldNormalMatrix=c.mat4()),c.transposeMat4(this._worldMatrix,this._worldNormalMatrix),c.inverseMat4(this._worldNormalMatrix),this._worldNormalMatrixDirty=!1}_setAABBDirty(){if(this.collidable)for(let e=this;e;e=e._parentNode)e._aabbDirty=!0}_updateAABB(){this.scene._aabbDirty=!0,this._aabb||(this._aabb=c.AABB3()),this._buildAABB(this.worldMatrix,this._aabb),this._aabbDirty=!1}_webglContextRestored(){this._drawRenderer&&this._drawRenderer.webglContextRestored(),this._shadowRenderer&&this._shadowRenderer.webglContextRestored(),this._emphasisFillRenderer&&this._emphasisFillRenderer.webglContextRestored(),this._emphasisEdgesRenderer&&this._emphasisEdgesRenderer.webglContextRestored(),this._pickMeshRenderer&&this._pickMeshRenderer.webglContextRestored(),this._pickTriangleRenderer&&this._pickMeshRenderer.webglContextRestored(),this._occlusionRenderer&&this._occlusionRenderer.webglContextRestored()}_makeDrawHash(){const e=this.scene,i=[e.canvas.canvas.id,(e.gammaInput?"gi;":";")+(e.gammaOutput?"go":""),e._lightsState.getHash(),e._sectionPlanesState.getHash()],s=this._state;return s.stationary&&i.push("/s"),s.billboard==="none"?i.push("/n"):s.billboard==="spherical"?i.push("/s"):s.billboard==="cylindrical"&&i.push("/c"),s.receivesShadow&&i.push("/rs"),i.push(";"),i.join("")}_makePickHash(){const e=this.scene,i=[e.canvas.canvas.id,e._sectionPlanesState.getHash()],s=this._state;return s.stationary&&i.push("/s"),s.billboard==="none"?i.push("/n"):s.billboard==="spherical"?i.push("/s"):s.billboard==="cylindrical"&&i.push("/c"),i.push(";"),i.join("")}_makeOcclusionHash(){const e=this.scene,i=[e.canvas.canvas.id,e._sectionPlanesState.getHash()],s=this._state;return s.stationary&&i.push("/s"),s.billboard==="none"?i.push("/n"):s.billboard==="spherical"?i.push("/s"):s.billboard==="cylindrical"&&i.push("/c"),i.push(";"),i.join("")}_buildAABB(e,i){c.transformOBB3(e,this._geometry.obb,jc),c.OBB3ToAABB3(jc,i);const s=this._state.offset;if(i[0]+=s[0],i[1]+=s[1],i[2]+=s[2],i[3]+=s[0],i[4]+=s[1],i[5]+=s[2],this._state.origin){const t=this._state.origin;i[0]+=t[0],i[1]+=t[1],i[2]+=t[2],i[3]+=t[0],i[4]+=t[1],i[5]+=t[2]}}rotate(e,i){return Fi[0]=e[0],Fi[1]=e[1],Fi[2]=e[2],Fi[3]=i*c.DEGTORAD,c.angleAxisToQuaternion(Fi,br),c.mulQuaternions(this.quaternion,br,Gc),this.quaternion=Gc,this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}rotateOnWorldAxis(e,i){return Fi[0]=e[0],Fi[1]=e[1],Fi[2]=e[2],Fi[3]=i*c.DEGTORAD,c.angleAxisToQuaternion(Fi,br),c.mulQuaternions(br,this.quaternion,br),this}rotateX(e){return this.rotate(zc,e)}rotateY(e){return this.rotate(Kc,e)}rotateZ(e){return this.rotate(Wc,e)}translate(e,i){return c.vec3ApplyQuaternion(this.quaternion,e,Xc),c.mulVec3Scalar(Xc,i,Yc),c.addVec3(this.position,Yc,this.position),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}translateX(e){return this.translate(zc,e)}translateY(e){return this.translate(Kc,e)}translateZ(e){return this.translate(Wc,e)}_putDrawRenderers(){this._drawRenderer&&(this._drawRenderer.put(),this._drawRenderer=null),this._shadowRenderer&&(this._shadowRenderer.put(),this._shadowRenderer=null),this._emphasisFillRenderer&&(this._emphasisFillRenderer.put(),this._emphasisFillRenderer=null),this._emphasisEdgesRenderer&&(this._emphasisEdgesRenderer.put(),this._emphasisEdgesRenderer=null)}_putPickRenderers(){this._pickMeshRenderer&&(this._pickMeshRenderer.put(),this._pickMeshRenderer=null),this._pickTriangleRenderer&&(this._pickTriangleRenderer.put(),this._pickTriangleRenderer=null)}_putOcclusionRenderer(){this._occlusionRenderer&&(this._occlusionRenderer.put(),this._occlusionRenderer=null)}stateSortCompare(e,i){return e._state.layer-i._state.layer||e._drawRenderer.id-i._drawRenderer.id||e._material._state.id-i._material._state.id||e._geometry._state.id-i._geometry._state.id}rebuildRenderFlags(){if(this.renderFlags.reset(),!this._getActiveSectionPlanes()){this.renderFlags.culled=!0;return}this.renderFlags.numLayers=1,this.renderFlags.numVisibleLayers=1,this.renderFlags.visibleLayers[0]=0,this._updateRenderFlags()}_updateRenderFlags(){const e=this.renderFlags,i=this._state;if(i.xrayed){const s=this._xrayMaterial._state;s.fill&&(s.fillAlpha<1?e.xrayedSilhouetteTransparent=!0:e.xrayedSilhouetteOpaque=!0),s.edges&&(s.edgeAlpha<1?e.xrayedEdgesTransparent=!0:e.xrayedEdgesOpaque=!0)}else if(this._material._state.alpha<1||i.colorize[3]<1?e.colorTransparent=!0:e.colorOpaque=!0,i.edges&&(this._edgeMaterial._state.alpha<1?e.edgesTransparent=!0:e.edgesOpaque=!0),i.selected){const t=this._selectedMaterial._state;t.fill&&(t.fillAlpha<1?e.selectedSilhouetteTransparent=!0:e.selectedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.selectedEdgesTransparent=!0:e.selectedEdgesOpaque=!0)}else if(i.highlighted){const t=this._highlightMaterial._state;t.fill&&(t.fillAlpha<1?e.highlightedSilhouetteTransparent=!0:e.highlightedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.highlightedEdgesTransparent=!0:e.highlightedEdgesOpaque=!0)}}_getActiveSectionPlanes(){if(this._state.clippable){const e=this.scene._sectionPlanesState.sectionPlanes,i=e.length;if(i>0)for(let s=0;s<i;s++){const t=e[s],o=this.renderFlags;if(!t.active)o.sectionPlanesActivePerLayer[s]=!1;else if(this._state.origin){const n=c.planeAABB3Intersect(t.dir,t.dist,this.aabb);if(n===-1)return!1;const A=n===0;o.sectionPlanesActivePerLayer[s]=A}else o.sectionPlanesActivePerLayer[s]=!0}}return!0}drawColorOpaque(e){(this._drawRenderer||(this._drawRenderer=Ri.get(this)))&&this._drawRenderer.drawMesh(e,this)}drawColorTransparent(e){(this._drawRenderer||(this._drawRenderer=Ri.get(this)))&&this._drawRenderer.drawMesh(e,this)}drawSilhouetteXRayed(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=bi.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,0)}drawSilhouetteHighlighted(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=bi.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,1)}drawSilhouetteSelected(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=bi.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,2)}drawEdgesColorOpaque(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=di.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,3)}drawEdgesColorTransparent(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=di.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,3)}drawEdgesXRayed(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=di.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,0)}drawEdgesHighlighted(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=di.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,1)}drawEdgesSelected(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=di.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,2)}drawOcclusion(e){(this._state.occluder&&this._occlusionRenderer||(this._occlusionRenderer=Zi.get(this)))&&this._occlusionRenderer.drawMesh(e,this)}drawShadow(e){(this._shadowRenderer||(this._shadowRenderer=hs.get(this)))&&this._shadowRenderer.drawMesh(e,this)}drawPickMesh(e){(this._pickMeshRenderer||(this._pickMeshRenderer=$i.get(this)))&&this._pickMeshRenderer.drawMesh(e,this)}canPickTriangle(){return this._geometry.isReadableGeometry}drawPickTriangles(e){(this._pickTriangleRenderer||(this._pickTriangleRenderer=Is.get(this)))&&this._pickTriangleRenderer.drawMesh(e,this)}pickTriangleSurface(e,i,s){y0(this,e,i,s)}drawPickVertices(e){}delegatePickedEntity(){return this}destroy(){super.destroy(),this._putDrawRenderers(),this._putPickRenderers(),this._putOcclusionRenderer(),this.scene._renderer.putPickID(this._state.pickID),this._isObject&&(this.scene._deregisterObject(this),this._visible&&this.scene._objectVisibilityUpdated(this,!1,!1),this._xrayed&&this.scene._objectXRayedUpdated(this,!1,!1),this._selected&&this.scene._objectSelectedUpdated(this,!1,!1),this._highlighted&&this.scene._objectHighlightedUpdated(this,!1,!1),this.scene._objectColorizeUpdated(this,!1),this.scene._objectOpacityUpdated(this,!1),this.offset.some(e=>e!==0)&&this.scene._objectOffsetUpdated(this,!1)),this._isModel&&this.scene._deregisterModel(this),this.glRedraw()}}const y0=function(){const r=c.vec3(),e=c.vec3(),i=c.vec3(),s=c.vec3(),t=c.vec3(),o=c.vec3(),n=c.vec4(),a=c.vec3(),A=c.vec3(),l=c.vec3(),h=c.vec3(),d=c.vec3(),f=c.vec3(),m=c.vec3(),_=c.vec3(),u=c.vec3(),P=c.vec4(),y=c.vec4(),x=c.vec4(),B=c.vec3(),v=c.vec3(),w=c.vec3(),C=c.vec3(),I=c.vec3(),E=c.vec3(),S=c.vec3(),R=c.vec3(),D=c.vec3(),K=c.vec3(),G=c.vec3();return function(z,le,ue,ae){var Pe=ae.primIndex;if(Pe!=null&&Pe>-1){const Fe=z.geometry._state,Qe=z.scene,Ve=Qe.camera,V=Qe.canvas;if(Fe.primitiveName==="triangles"){ae.primitive="triangle";const Z=Pe,L=Fe.indices,Q=Fe.positions;let O,W,X;if(L){var be=L[Z+0],xe=L[Z+1],Ie=L[Z+2];o[0]=be,o[1]=xe,o[2]=Ie,ae.indices=o,O=be*3,W=xe*3,X=Ie*3}else O=Z*3,W=O+3,X=W+3;if(i[0]=Q[O+0],i[1]=Q[O+1],i[2]=Q[O+2],s[0]=Q[W+0],s[1]=Q[W+1],s[2]=Q[W+2],t[0]=Q[X+0],t[1]=Q[X+1],t[2]=Q[X+2],Fe.compressGeometry){const ie=Fe.positionsDecodeMatrix;ie&&(st.decompressPosition(i,ie,i),st.decompressPosition(s,ie,s),st.decompressPosition(t,ie,t))}ae.canvasPos?c.canvasPosToLocalRay(V.canvas,z.origin?ft(le,z.origin):le,ue,z.worldMatrix,ae.canvasPos,r,e):ae.origin&&ae.direction&&c.worldRayToLocalRay(z.worldMatrix,ae.origin,ae.direction,r,e),c.normalizeVec3(e),c.rayPlaneIntersect(r,e,i,s,t,n),ae.localPos=n,ae.position=n,P[0]=n[0],P[1]=n[1],P[2]=n[2],P[3]=1,c.transformVec4(z.worldMatrix,P,y),a[0]=y[0],a[1]=y[1],a[2]=y[2],ae.canvasPos&&z.origin&&(a[0]+=z.origin[0],a[1]+=z.origin[1],a[2]+=z.origin[2]),ae.worldPos=a,c.transformVec4(Ve.matrix,y,x),A[0]=x[0],A[1]=x[1],A[2]=x[2],ae.viewPos=A,c.cartesianToBarycentric(n,i,s,t,l),ae.bary=l;const te=Fe.normals;if(te){if(Fe.compressGeometry){const oe=be*3,he=xe*3,ce=Ie*3;st.decompressNormal(te.subarray(oe,oe+2),h),st.decompressNormal(te.subarray(he,he+2),d),st.decompressNormal(te.subarray(ce,ce+2),f)}else h[0]=te[O],h[1]=te[O+1],h[2]=te[O+2],d[0]=te[W],d[1]=te[W+1],d[2]=te[W+2],f[0]=te[X],f[1]=te[X+1],f[2]=te[X+2];const ie=c.addVec3(c.addVec3(c.mulVec3Scalar(h,l[0],B),c.mulVec3Scalar(d,l[1],v),w),c.mulVec3Scalar(f,l[2],C),I);ae.worldNormal=c.normalizeVec3(c.transformVec3(z.worldNormalMatrix,ie,E))}const se=Fe.uv;if(se){if(m[0]=se[be*2],m[1]=se[be*2+1],_[0]=se[xe*2],_[1]=se[xe*2+1],u[0]=se[Ie*2],u[1]=se[Ie*2+1],Fe.compressGeometry){const ie=Fe.uvDecodeMatrix;ie&&(st.decompressUV(m,ie,m),st.decompressUV(_,ie,_),st.decompressUV(u,ie,u))}ae.uv=c.addVec3(c.addVec3(c.mulVec2Scalar(m,l[0],S),c.mulVec2Scalar(_,l[1],R),D),c.mulVec2Scalar(u,l[2],K),G)}}}}}();function x0(r={}){const e=r.lod||1,i=r.center?r.center[0]:0,s=r.center?r.center[1]:0,t=r.center?r.center[2]:0;let o=r.radius||1;o<0&&(console.error("negative radius not allowed - will invert"),o*=-1);let n=r.heightSegments||18;n<0&&(console.error("negative heightSegments not allowed - will invert"),n*=-1),n=Math.floor(e*n),n<18&&(n=18);let a=r.widthSegments||18;a<0&&(console.error("negative widthSegments not allowed - will invert"),a*=-1),a=Math.floor(e*a),a<18&&(a=18);const A=[],l=[],h=[],d=[];let f,m,_,u,P,y,x,B,v,w,C,I,E,S,R;for(f=0;f<=n;f++)for(_=f*Math.PI/n,u=Math.sin(_),P=Math.cos(_),m=0;m<=a;m++)y=m*2*Math.PI/a,x=Math.sin(y),B=Math.cos(y),v=B*u,w=P,C=x*u,I=1-m/a,E=f/n,l.push(v),l.push(w),l.push(C),h.push(I),h.push(E),A.push(i+o*v),A.push(s+o*w),A.push(t+o*C);for(f=0;f<n;f++)for(m=0;m<a;m++)S=f*(a+1)+m,R=S+a+1,d.push(S+1),d.push(R+1),d.push(R),d.push(S+1),d.push(R),d.push(S);return Le.apply(r,{positions:A,normals:l,uv:h,indices:d})}c.vec3();c.vec4(4);c.vec4();c.vec4();c.vec3([1,0,0]);c.vec3([0,1,0]);c.vec3([0,0,1]);c.vec3(3);c.vec3(3);c.identityMat4();function Kt(r,e,i=null){let s;const t=e;if(t===_p)return r.UNSIGNED_BYTE;if(t===E_)return r.UNSIGNED_SHORT_4_4_4_4;if(t===I_)return r.UNSIGNED_SHORT_5_5_5_1;if(t===P_)return r.BYTE;if(t===B_)return r.SHORT;if(t===y_)return r.UNSIGNED_SHORT;if(t===x_)return r.INT;if(t===w_)return r.UNSIGNED_INT;if(t===b_)return r.FLOAT;if(t===C_)return r.HALF_FLOAT;if(t===M_)return r.ALPHA;if(t===Fn)return r.RGBA;if(t===T_)return r.LUMINANCE;if(t===D_)return r.LUMINANCE_ALPHA;if(t===R_)return r.DEPTH_COMPONENT;if(t===L_)return r.DEPTH_STENCIL;if(t===U_)return r.RED;if(t===S_)return r.RGBA;if(t===O_)return r.RED_INTEGER;if(t===k_)return r.RG;if(t===N_)return r.RG_INTEGER;if(t===Q_)return r.RGBA_INTEGER;if(t===vn||t===Ia||t===Fa||t===Pn)if(i===Ct){const o=ai(r,"WEBGL_compressed_texture_s3tc_srgb");if(o!==null){if(t===vn)return o.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(t===Ia)return o.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(t===Fa)return o.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(t===Pn)return o.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else return null}else if(s=ai(r,"WEBGL_compressed_texture_s3tc"),s!==null){if(t===vn)return s.COMPRESSED_RGB_S3TC_DXT1_EXT;if(t===Ia)return s.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(t===Fa)return s.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(t===Pn)return s.COMPRESSED_RGBA_S3TC_DXT5_EXT}else return null;if(t===OA||t===Ic||t===kA||t===Fc){const o=ai(r,"WEBGL_compressed_texture_pvrtc");if(o!==null){if(t===OA)return o.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(t===Ic)return o.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(t===kA)return o.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(t===Fc)return o.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}else return null}if(t===vp){const o=ai(r,"WEBGL_compressed_texture_etc1");return o!==null?o.COMPRESSED_RGB_ETC1_WEBGL:null}if(t===NA||t===QA){const o=ai(r,"WEBGL_compressed_texture_etc");if(o!==null){if(t===NA)return i===Ct?o.COMPRESSED_SRGB8_ETC2:o.COMPRESSED_RGB8_ETC2;if(t===QA)return i===Ct?o.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:o.COMPRESSED_RGBA8_ETC2_EAC}else return null}if(t===HA||t===Mc||t===Sc||t===Tc||t===Dc||t===Rc||t===Lc||t===Uc||t===Oc||t===kc||t===Nc||t===Qc||t===Hc||t===Vc){const o=ai(r,"WEBGL_compressed_texture_astc");if(o!==null){if(t===HA)return i===Ct?o.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:o.COMPRESSED_RGBA_ASTC_4x4_KHR;if(t===Mc)return i===Ct?o.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:o.COMPRESSED_RGBA_ASTC_5x4_KHR;if(t===Sc)return i===Ct?o.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:o.COMPRESSED_RGBA_ASTC_5x5_KHR;if(t===Tc)return i===Ct?o.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:o.COMPRESSED_RGBA_ASTC_6x5_KHR;if(t===Dc)return i===Ct?o.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:o.COMPRESSED_RGBA_ASTC_6x6_KHR;if(t===Rc)return i===Ct?o.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:o.COMPRESSED_RGBA_ASTC_8x5_KHR;if(t===Lc)return i===Ct?o.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:o.COMPRESSED_RGBA_ASTC_8x6_KHR;if(t===Uc)return i===Ct?o.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:o.COMPRESSED_RGBA_ASTC_8x8_KHR;if(t===Oc)return i===Ct?o.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:o.COMPRESSED_RGBA_ASTC_10x5_KHR;if(t===kc)return i===Ct?o.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:o.COMPRESSED_RGBA_ASTC_10x6_KHR;if(t===Nc)return i===Ct?o.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:o.COMPRESSED_RGBA_ASTC_10x8_KHR;if(t===Qc)return i===Ct?o.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:o.COMPRESSED_RGBA_ASTC_10x10_KHR;if(t===Hc)return i===Ct?o.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:o.COMPRESSED_RGBA_ASTC_12x10_KHR;if(t===Vc)return i===Ct?o.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:o.COMPRESSED_RGBA_ASTC_12x12_KHR}else return null}if(t===VA){const o=ai(r,"EXT_texture_compression_bptc");if(o!==null){if(t===VA)return i===Ct?o.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:o.COMPRESSED_RGBA_BPTC_UNORM_EXT}else return null}return t===F_?r.UNSIGNED_INT_24_8:t===ui?r.REPEAT:t===_n?r.CLAMP_TO_EDGE:t===fp||t===gp?r.NEAREST_MIPMAP_LINEAR:t===mp?r.LINEAR_MIPMAP_NEAREST:t===v_?r.LINEAR_MIPMAP_LINEAR:t===Bl?r.NEAREST:t===ys?r.LINEAR:null}const Mi=new Uint8Array([0,0,0,1]);class Us{constructor({gl:e,target:i,format:s,type:t,wrapS:o,wrapT:n,wrapR:a,encoding:A,preloadColor:l,premultiplyAlpha:h,flipY:d}){this.gl=e,this.target=i||e.TEXTURE_2D,this.format=s||Fn,this.type=t||_p,this.internalFormat=null,this.premultiplyAlpha=!!h,this.flipY=!!d,this.unpackAlignment=4,this.wrapS=o||ui,this.wrapT=n||ui,this.wrapR=a||ui,this.encoding=A||Ct,this.texture=e.createTexture(),l&&this.setPreloadColor(l),this.allocated=!0}setPreloadColor(e){e?(Mi[0]=Math.floor(e[0]*255),Mi[1]=Math.floor(e[1]*255),Mi[2]=Math.floor(e[2]*255),Mi[3]=Math.floor((e[3]!==void 0?e[3]:1)*255)):(Mi[0]=0,Mi[1]=0,Mi[2]=0,Mi[3]=255);const i=this.gl;if(i.bindTexture(this.target,this.texture),this.target===i.TEXTURE_CUBE_MAP){const s=[i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y,i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z];for(let t=0,o=s.length;t<o;t++)i.texImage2D(s[t],0,i.RGBA,1,1,0,i.RGBA,i.UNSIGNED_BYTE,Mi)}else i.texImage2D(this.target,0,i.RGBA,1,1,0,i.RGBA,i.UNSIGNED_BYTE,Mi);i.bindTexture(this.target,null)}setTarget(e){this.target=e||this.gl.TEXTURE_2D}setImage(e,i={}){const s=this.gl;i.format!==void 0&&(this.format=i.format),i.internalFormat!==void 0&&(this.internalFormat=i.internalFormat),i.encoding!==void 0&&(this.encoding=i.encoding),i.type!==void 0&&(this.type=i.type),i.flipY!==void 0&&(this.flipY=i.flipY),i.premultiplyAlpha!==void 0&&(this.premultiplyAlpha=i.premultiplyAlpha),i.unpackAlignment!==void 0&&(this.unpackAlignment=i.unpackAlignment),i.minFilter!==void 0&&(this.minFilter=i.minFilter),i.magFilter!==void 0&&(this.magFilter=i.magFilter),i.wrapS!==void 0&&(this.wrapS=i.wrapS),i.wrapT!==void 0&&(this.wrapT=i.wrapT),i.wrapR!==void 0&&(this.wrapR=i.wrapR);let t=!1;s.bindTexture(this.target,this.texture);const o=s.getParameter(s.UNPACK_FLIP_Y_WEBGL);s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,this.flipY);const n=s.getParameter(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL);s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha);const a=s.getParameter(s.UNPACK_ALIGNMENT);s.pixelStorei(s.UNPACK_ALIGNMENT,this.unpackAlignment);const A=s.getParameter(s.UNPACK_COLORSPACE_CONVERSION_WEBGL);s.pixelStorei(s.UNPACK_COLORSPACE_CONVERSION_WEBGL,s.NONE);const l=Kt(s,this.minFilter);s.texParameteri(this.target,s.TEXTURE_MIN_FILTER,l),(l===s.NEAREST_MIPMAP_NEAREST||l===s.LINEAR_MIPMAP_NEAREST||l===s.NEAREST_MIPMAP_LINEAR||l===s.LINEAR_MIPMAP_LINEAR)&&(t=!0);const h=Kt(s,this.magFilter);h&&s.texParameteri(this.target,s.TEXTURE_MAG_FILTER,h);const d=Kt(s,this.wrapS);d&&s.texParameteri(this.target,s.TEXTURE_WRAP_S,d);const f=Kt(s,this.wrapT);f&&s.texParameteri(this.target,s.TEXTURE_WRAP_T,f);const m=Kt(s,this.format,this.encoding),_=Kt(s,this.type),u=$c(s,this.internalFormat,m,_,this.encoding,!1);if(this.target===s.TEXTURE_CUBE_MAP){if(Le.isArray(e)){const P=e,y=[s.TEXTURE_CUBE_MAP_POSITIVE_X,s.TEXTURE_CUBE_MAP_NEGATIVE_X,s.TEXTURE_CUBE_MAP_POSITIVE_Y,s.TEXTURE_CUBE_MAP_NEGATIVE_Y,s.TEXTURE_CUBE_MAP_POSITIVE_Z,s.TEXTURE_CUBE_MAP_NEGATIVE_Z];for(let x=0,B=y.length;x<B;x++)s.texImage2D(y[x],0,u,m,_,P[x])}}else s.texImage2D(s.TEXTURE_2D,0,u,m,_,e);t&&s.generateMipmap(this.target),s.bindTexture(this.target,null),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,o),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,n),s.pixelStorei(s.UNPACK_ALIGNMENT,a),s.pixelStorei(s.UNPACK_COLORSPACE_CONVERSION_WEBGL,A)}setCompressedData({mipmaps:e,props:i={}}){const s=this.gl,t=e.length;i.format!==void 0&&(this.format=i.format),i.internalFormat!==void 0&&(this.internalFormat=i.internalFormat),i.encoding!==void 0&&(this.encoding=i.encoding),i.type!==void 0&&(this.type=i.type),i.flipY!==void 0&&(this.flipY=i.flipY),i.premultiplyAlpha!==void 0&&(this.premultiplyAlpha=i.premultiplyAlpha),i.unpackAlignment!==void 0&&(this.unpackAlignment=i.unpackAlignment),i.minFilter!==void 0&&(this.minFilter=i.minFilter),i.magFilter!==void 0&&(this.magFilter=i.magFilter),i.wrapS!==void 0&&(this.wrapS=i.wrapS),i.wrapT!==void 0&&(this.wrapT=i.wrapT),i.wrapR!==void 0&&(this.wrapR=i.wrapR),s.activeTexture(s.TEXTURE0+0),s.bindTexture(this.target,this.texture);let o=e.length>1;s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,this.flipY),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),s.pixelStorei(s.UNPACK_ALIGNMENT,this.unpackAlignment),s.pixelStorei(s.UNPACK_COLORSPACE_CONVERSION_WEBGL,s.NONE);const n=Kt(s,this.wrapS);n&&s.texParameteri(this.target,s.TEXTURE_WRAP_S,n);const a=Kt(s,this.wrapT);if(a&&s.texParameteri(this.target,s.TEXTURE_WRAP_T,a),this.type===s.TEXTURE_3D||this.type===s.TEXTURE_2D_ARRAY){const d=Kt(s,this.wrapR);d&&s.texParameteri(this.target,s.TEXTURE_WRAP_R,d),s.texParameteri(this.type,s.TEXTURE_WRAP_R,d)}o?(s.texParameteri(this.target,s.TEXTURE_MIN_FILTER,Zc(s,this.minFilter)),s.texParameteri(this.target,s.TEXTURE_MAG_FILTER,Zc(s,this.magFilter))):(s.texParameteri(this.target,s.TEXTURE_MIN_FILTER,Kt(s,this.minFilter)),s.texParameteri(this.target,s.TEXTURE_MAG_FILTER,Kt(s,this.magFilter)));const A=Kt(s,this.format,this.encoding),l=Kt(s,this.type),h=$c(s,this.internalFormat,A,l,this.encoding,!1);s.texStorage2D(s.TEXTURE_2D,t,h,e[0].width,e[0].height);for(let d=0,f=e.length;d<f;d++){const m=e[d];this.format!==Fn?A!==null?s.compressedTexSubImage2D(s.TEXTURE_2D,d,0,0,m.width,m.height,A,m.data):console.warn("Attempt to load unsupported compressed texture format in .setCompressedData()"):s.texSubImage2D(s.TEXTURE_2D,d,0,0,m.width,m.height,A,l,m.data)}s.bindTexture(this.target,null)}setProps(e){const i=this.gl;i.bindTexture(this.target,this.texture),this._uploadProps(e),i.bindTexture(this.target,null)}_uploadProps(e){const i=this.gl;if(e.format!==void 0&&(this.format=e.format),e.internalFormat!==void 0&&(this.internalFormat=e.internalFormat),e.encoding!==void 0&&(this.encoding=e.encoding),e.type!==void 0&&(this.type=e.type),e.minFilter!==void 0){const s=Kt(i,e.minFilter);s&&(this.minFilter=e.minFilter,i.texParameteri(this.target,i.TEXTURE_MIN_FILTER,s),(s===i.NEAREST_MIPMAP_NEAREST||s===i.LINEAR_MIPMAP_NEAREST||s===i.NEAREST_MIPMAP_LINEAR||s===i.LINEAR_MIPMAP_LINEAR)&&i.generateMipmap(this.target))}if(e.magFilter!==void 0){const s=Kt(i,e.magFilter);s&&(this.magFilter=e.magFilter,i.texParameteri(this.target,i.TEXTURE_MAG_FILTER,s))}if(e.wrapS!==void 0){const s=Kt(i,e.wrapS);s&&(this.wrapS=e.wrapS,i.texParameteri(this.target,i.TEXTURE_WRAP_S,s))}if(e.wrapT!==void 0){const s=Kt(i,e.wrapT);s&&(this.wrapT=e.wrapT,i.texParameteri(this.target,i.TEXTURE_WRAP_T,s))}}bind(e){if(this.allocated){if(this.texture){const i=this.gl;return i.activeTexture(i["TEXTURE"+e]),i.bindTexture(this.target,this.texture),!0}return!1}}unbind(e){if(this.allocated&&this.texture){const i=this.gl;i.activeTexture(i["TEXTURE"+e]),i.bindTexture(this.target,null)}}destroy(){this.allocated&&this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null)}}function $c(r,e,i,s,t,o=!1){if(e!==null){if(r[e]!==void 0)return r[e];console.warn("Attempt to use non-existing WebGL internal format '"+e+"'")}let n=i;return i===r.RED&&(s===r.FLOAT&&(n=r.R32F),s===r.HALF_FLOAT&&(n=r.R16F),s===r.UNSIGNED_BYTE&&(n=r.R8)),i===r.RG&&(s===r.FLOAT&&(n=r.RG32F),s===r.HALF_FLOAT&&(n=r.RG16F),s===r.UNSIGNED_BYTE&&(n=r.RG8)),i===r.RGBA&&(s===r.FLOAT&&(n=r.RGBA32F),s===r.HALF_FLOAT&&(n=r.RGBA16F),s===r.UNSIGNED_BYTE&&(n=t===Ct&&o===!1?r.SRGB8_ALPHA8:r.RGBA8),s===r.UNSIGNED_SHORT_4_4_4_4&&(n=r.RGBA4),s===r.UNSIGNED_SHORT_5_5_5_1&&(n=r.RGB5_A1)),(n===r.R16F||n===r.R32F||n===r.RG16F||n===r.RG32F||n===r.RGBA16F||n===r.RGBA32F)&&ai(r,"EXT_color_buffer_float"),n}function Zc(r,e){return e===Bl||e===m_||e===__?r.NEAREST:r.LINEAR}const gs=vt.memory,qc=c.AABB3();class w0 extends dp{get type(){return"VBOGeometry"}get isVBOGeometry(){return!0}constructor(e,i={}){super(e,i),this._state=new Ft({compressGeometry:!0,primitive:null,primitiveName:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,positionsBuf:null,normalsBuf:null,colorsbuf:null,uvBuf:null,indicesBuf:null,hash:""}),this._numTriangles=0,this._edgeThreshold=i.edgeThreshold||10,this._aabb=null,this._obb=c.OBB3();const s=this._state,t=this.scene.canvas.gl;switch(i.primitive=i.primitive||"triangles",i.primitive){case"points":s.primitive=t.POINTS,s.primitiveName=i.primitive;break;case"lines":s.primitive=t.LINES,s.primitiveName=i.primitive;break;case"line-loop":s.primitive=t.LINE_LOOP,s.primitiveName=i.primitive;break;case"line-strip":s.primitive=t.LINE_STRIP,s.primitiveName=i.primitive;break;case"triangles":s.primitive=t.TRIANGLES,s.primitiveName=i.primitive;break;case"triangle-strip":s.primitive=t.TRIANGLE_STRIP,s.primitiveName=i.primitive;break;case"triangle-fan":s.primitive=t.TRIANGLE_FAN,s.primitiveName=i.primitive;break;default:this.error("Unsupported value for 'primitive': '"+i.primitive+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),s.primitive=t.TRIANGLES,s.primitiveName=i.primitive}if(!i.positions){this.error("Config expected: positions");return}if(!i.indices){this.error("Config expected: indices");return}var o;if(!i.positionsDecodeMatrix){const a=st.getPositionsBounds(i.positions),A=st.compressPositions(i.positions,a.min,a.max);o=A.quantized,s.positionsDecodeMatrix=A.decodeMatrix,s.positionsBuf=new Ee(t,t.ARRAY_BUFFER,o,o.length,3,t.STATIC_DRAW),gs.positions+=s.positionsBuf.numItems,c.positions3ToAABB3(i.positions,this._aabb),c.positions3ToAABB3(o,qc,s.positionsDecodeMatrix),c.AABB3ToOBB3(qc,this._obb)}if(i.colors){const n=i.colors.constructor===Float32Array?i.colors:new Float32Array(i.colors);s.colorsBuf=new Ee(t,t.ARRAY_BUFFER,n,n.length,4,t.STATIC_DRAW),gs.colors+=s.colorsBuf.numItems}if(i.uv){const n=st.getUVBounds(i.uv),a=st.compressUVs(i.uv,n.min,n.max),A=a.quantized;s.uvDecodeMatrix=a.decodeMatrix,s.uvBuf=new Ee(t,t.ARRAY_BUFFER,A,A.length,2,t.STATIC_DRAW),gs.uvs+=s.uvBuf.numItems}if(i.normals){const n=st.compressNormals(i.normals);let a=s.compressGeometry;s.normalsBuf=new Ee(t,t.ARRAY_BUFFER,n,n.length,3,t.STATIC_DRAW,a),gs.normals+=s.normalsBuf.numItems}{const n=i.indices.constructor===Uint32Array||i.indices.constructor===Uint16Array?i.indices:new Uint32Array(i.indices);s.indicesBuf=new Ee(t,t.ELEMENT_ARRAY_BUFFER,n,n.length,1,t.STATIC_DRAW),gs.indices+=s.indicesBuf.numItems;const a=ts(o,n,s.positionsDecodeMatrix,this._edgeThreshold);this._edgeIndicesBuf=new Ee(t,t.ELEMENT_ARRAY_BUFFER,a,a.length,1,t.STATIC_DRAW),this._state.primitiveName==="triangles"&&(this._numTriangles=i.indices.length/3)}this._buildHash(),gs.meshes++}_buildHash(){const e=this._state,i=["/g"];i.push("/"+e.primitive+";"),e.positionsBuf&&i.push("p"),e.colorsBuf&&i.push("c"),(e.normalsBuf||e.autoVertexNormals)&&i.push("n"),e.uvBuf&&i.push("u"),i.push("cp"),i.push(";"),e.hash=i.join("")}_getEdgeIndices(){return this._edgeIndicesBuf}get primitive(){return this._state.primitiveName}get aabb(){return this._aabb}get obb(){return this._obb}get numTriangles(){return this._numTriangles}_getState(){return this._state}destroy(){super.destroy();const e=this._state;e.indicesBuf&&e.indicesBuf.destroy(),e.positionsBuf&&e.positionsBuf.destroy(),e.normalsBuf&&e.normalsBuf.destroy(),e.uvBuf&&e.uvBuf.destroy(),e.colorsBuf&&e.colorsBuf.destroy(),this._edgeIndicesBuf&&this._edgeIndicesBuf.destroy(),e.destroy(),gs.meshes--}}var j={};j.load=function(r,e){var i=new XMLHttpRequest;i.open("GET",r,!0),i.responseType="arraybuffer",i.onload=function(s){e(s.target.response)},i.send()};j.save=function(r,e){var i="data:application/octet-stream;base64,"+btoa(j.parse._buffToStr(r));window.location.href=i};j.clone=function(r){return JSON.parse(JSON.stringify(r))};j.bin={};j.bin.f=new Float32Array(1);j.bin.fb=new Uint8Array(j.bin.f.buffer);j.bin.rf=function(r,e){for(var i=j.bin.f,s=j.bin.fb,t=0;t<4;t++)s[t]=r[e+t];return i[0]};j.bin.rsl=function(r,e){return r[e]|r[e+1]<<8};j.bin.ril=function(r,e){return r[e]|r[e+1]<<8|r[e+2]<<16|r[e+3]<<24};j.bin.rASCII0=function(r,e){for(var i="";r[e]!=0;)i+=String.fromCharCode(r[e++]);return i};j.bin.wf=function(r,e,i){var s=new Float32Array(r.buffer,e,1);s[0]=i};j.bin.wsl=function(r,e,i){r[e]=i,r[e+1]=i>>8};j.bin.wil=function(r,e,i){r[e]=i,r[e+1]=i>>8,r[e+2]=i>>16,r[e+3]>>24};j.parse={};j.parse._buffToStr=function(r){for(var e=new Uint8Array(r),i="",s=0;s<e.length;s++)i=i.concat(String.fromCharCode(e[s]));return i};j.parse._strToBuff=function(r){for(var e=new ArrayBuffer(r.length),i=new Uint8Array(e),s=0;s<r.length;s++)i[s]=r.charCodeAt(s);return e};j.parse._readLine=function(r,e){for(var i="";r[e]!=10;)i+=String.fromCharCode(r[e++]);return i};j.parse.fromJSON=function(r){var e=JSON.parse(j.parse._buffToStr(r));return e};j.parse.toJSON=function(r){var e=JSON.stringify(r);return j.parse._strToBuff(e)};j.parse.fromOBJ=function(r){var e={};e.groups={},e.c_verts=[],e.c_uvt=[],e.c_norms=[],e.i_verts=[],e.i_uvt=[],e.i_norms=[];for(var i={from:0,to:0},s=0,t=new Uint8Array(r);s<t.length;){var o=j.parse._readLine(t,s);s+=o.length+1,o=o.replace(/ +(?= )/g,""),o=o.replace(/(^\s+|\s+$)/g,"");var n=o.split(" ");if(n[0]=="g"&&(i.to=e.i_verts.length,e.groups[n[1]]==null&&(e.groups[n[1]]={from:e.i_verts.length,to:0}),i=e.groups[n[1]]),n[0]=="v"){var a=parseFloat(n[1]),A=parseFloat(n[2]),l=parseFloat(n[3]);e.c_verts.push(a,A,l)}if(n[0]=="vt"){var a=parseFloat(n[1]),A=1-parseFloat(n[2]);e.c_uvt.push(a,A)}if(n[0]=="vn"){var a=parseFloat(n[1]),A=parseFloat(n[2]),l=parseFloat(n[3]);e.c_norms.push(a,A,l)}if(n[0]=="f"){var h=n[1].split("/"),d=n[2].split("/"),f=n[3].split("/"),m=parseInt(h[0])-1,_=parseInt(d[0])-1,u=parseInt(f[0])-1,P=parseInt(h[1])-1,y=parseInt(d[1])-1,x=parseInt(f[1])-1,B=parseInt(h[2])-1,v=parseInt(d[2])-1,w=parseInt(f[2])-1,C=e.c_verts.length/3,I=e.c_uvt.length/2,E=e.c_norms.length/3;if(m<0&&(m=C+m+1),_<0&&(_=C+_+1),u<0&&(u=C+u+1),P<0&&(P=I+P+1),y<0&&(y=I+y+1),x<0&&(x=I+x+1),B<0&&(B=E+B+1),v<0&&(v=E+v+1),w<0&&(w=E+w+1),e.i_verts.push(m,_,u),e.i_uvt.push(P,y,x),e.i_norms.push(B,v,w),n.length==5){var S=n[4].split("/"),R=parseInt(S[0])-1,D=parseInt(S[1])-1,K=parseInt(S[2])-1;R<0&&(R=C+R+1),D<0&&(D=I+D+1),K<0&&(K=E+K+1),e.i_verts.push(m,u,R),e.i_uvt.push(P,x,D),e.i_norms.push(B,w,K)}}}return i.to=e.i_verts.length,e};j.parse.fromMD2=function(r){r=new Uint8Array(r);var e={},i={};i.ident=j.bin.ril(r,0),i.version=j.bin.ril(r,4),i.skinwidth=j.bin.ril(r,8),i.skinheight=j.bin.ril(r,12),i.framesize=j.bin.ril(r,16),i.num_skins=j.bin.ril(r,20),i.num_vertices=j.bin.ril(r,24),i.num_st=j.bin.ril(r,28),i.num_tris=j.bin.ril(r,32),i.num_glcmds=j.bin.ril(r,36),i.num_frames=j.bin.ril(r,40),i.offset_skins=j.bin.ril(r,44),i.offset_st=j.bin.ril(r,48),i.offset_tris=j.bin.ril(r,52),i.offset_frames=j.bin.ril(r,56),i.offset_glcmds=j.bin.ril(r,60),i.offset_end=j.bin.ril(r,64);var A=i.offset_st;e.c_uvt=[];for(var s=0;s<i.num_st;s++){var t=j.bin.rsl(r,A)/i.skinwidth,o=j.bin.rsl(r,A+2)/i.skinheight;e.c_uvt.push(t,o),A+=4}var A=i.offset_tris,n=[],a=[];e.i_verts=n,e.i_uvt=a;for(var s=0;s<i.num_tris;s++)n.push(j.bin.rsl(r,A),j.bin.rsl(r,A+2),j.bin.rsl(r,A+4)),a.push(j.bin.rsl(r,A+6),j.bin.rsl(r,A+8),j.bin.rsl(r,A+10)),A+=12;var A=i.offset_skins;e.skins=[];for(var s=0;s<i.num_skins;s++)e.skins.push(j.bin.rASCII0(r,A)),A+=64;var A=i.offset_frames;e.frames=[];for(var l=j.parse.fromMD2._normals,s=0;s<i.num_frames;s++){var h={},d=j.bin.rf(r,A),f=j.bin.rf(r,A+4),m=j.bin.rf(r,A+8);A+=12;var _=j.bin.rf(r,A),u=j.bin.rf(r,A+4),P=j.bin.rf(r,A+8);A+=12,h.name=j.bin.rASCII0(r,A),A+=16,h.verts=[],h.norms=[];for(var y=0;y<i.num_vertices;y++)h.verts.push(r[A]*d+_,r[A+1]*f+u,r[A+2]*m+P),h.norms.push(l[3*r[A+3]],l[3*r[A+3]+1],l[3*r[A+3]+2]),A+=4;e.frames.push(h)}return e};j.parse.fromMD2._normals=[-.525731,0,.850651,-.442863,.238856,.864188,-.295242,0,.955423,-.309017,.5,.809017,-.16246,.262866,.951056,0,0,1,0,.850651,.525731,-.147621,.716567,.681718,.147621,.716567,.681718,0,.525731,.850651,.309017,.5,.809017,.525731,0,.850651,.295242,0,.955423,.442863,.238856,.864188,.16246,.262866,.951056,-.681718,.147621,.716567,-.809017,.309017,.5,-.587785,.425325,.688191,-.850651,.525731,0,-.864188,.442863,.238856,-.716567,.681718,.147621,-.688191,.587785,.425325,-.5,.809017,.309017,-.238856,.864188,.442863,-.425325,.688191,.587785,-.716567,.681718,-.147621,-.5,.809017,-.309017,-.525731,.850651,0,0,.850651,-.525731,-.238856,.864188,-.442863,0,.955423,-.295242,-.262866,.951056,-.16246,0,1,0,0,.955423,.295242,-.262866,.951056,.16246,.238856,.864188,.442863,.262866,.951056,.16246,.5,.809017,.309017,.238856,.864188,-.442863,.262866,.951056,-.16246,.5,.809017,-.309017,.850651,.525731,0,.716567,.681718,.147621,.716567,.681718,-.147621,.525731,.850651,0,.425325,.688191,.587785,.864188,.442863,.238856,.688191,.587785,.425325,.809017,.309017,.5,.681718,.147621,.716567,.587785,.425325,.688191,.955423,.295242,0,1,0,0,.951056,.16246,.262866,.850651,-.525731,0,.955423,-.295242,0,.864188,-.442863,.238856,.951056,-.16246,.262866,.809017,-.309017,.5,.681718,-.147621,.716567,.850651,0,.525731,.864188,.442863,-.238856,.809017,.309017,-.5,.951056,.16246,-.262866,.525731,0,-.850651,.681718,.147621,-.716567,.681718,-.147621,-.716567,.850651,0,-.525731,.809017,-.309017,-.5,.864188,-.442863,-.238856,.951056,-.16246,-.262866,.147621,.716567,-.681718,.309017,.5,-.809017,.425325,.688191,-.587785,.442863,.238856,-.864188,.587785,.425325,-.688191,.688191,.587785,-.425325,-.147621,.716567,-.681718,-.309017,.5,-.809017,0,.525731,-.850651,-.525731,0,-.850651,-.442863,.238856,-.864188,-.295242,0,-.955423,-.16246,.262866,-.951056,0,0,-1,.295242,0,-.955423,.16246,.262866,-.951056,-.442863,-.238856,-.864188,-.309017,-.5,-.809017,-.16246,-.262866,-.951056,0,-.850651,-.525731,-.147621,-.716567,-.681718,.147621,-.716567,-.681718,0,-.525731,-.850651,.309017,-.5,-.809017,.442863,-.238856,-.864188,.16246,-.262866,-.951056,.238856,-.864188,-.442863,.5,-.809017,-.309017,.425325,-.688191,-.587785,.716567,-.681718,-.147621,.688191,-.587785,-.425325,.587785,-.425325,-.688191,0,-.955423,-.295242,0,-1,0,.262866,-.951056,-.16246,0,-.850651,.525731,0,-.955423,.295242,.238856,-.864188,.442863,.262866,-.951056,.16246,.5,-.809017,.309017,.716567,-.681718,.147621,.525731,-.850651,0,-.238856,-.864188,-.442863,-.5,-.809017,-.309017,-.262866,-.951056,-.16246,-.850651,-.525731,0,-.716567,-.681718,-.147621,-.716567,-.681718,.147621,-.525731,-.850651,0,-.5,-.809017,.309017,-.238856,-.864188,.442863,-.262866,-.951056,.16246,-.864188,-.442863,.238856,-.809017,-.309017,.5,-.688191,-.587785,.425325,-.681718,-.147621,.716567,-.442863,-.238856,.864188,-.587785,-.425325,.688191,-.309017,-.5,.809017,-.147621,-.716567,.681718,-.425325,-.688191,.587785,-.16246,-.262866,.951056,.442863,-.238856,.864188,.16246,-.262866,.951056,.309017,-.5,.809017,.147621,-.716567,.681718,0,-.525731,.850651,.425325,-.688191,.587785,.587785,-.425325,.688191,.688191,-.587785,.425325,-.955423,.295242,0,-.951056,.16246,.262866,-1,0,0,-.850651,0,.525731,-.955423,-.295242,0,-.951056,-.16246,.262866,-.864188,.442863,-.238856,-.951056,.16246,-.262866,-.809017,.309017,-.5,-.864188,-.442863,-.238856,-.951056,-.16246,-.262866,-.809017,-.309017,-.5,-.681718,.147621,-.716567,-.681718,-.147621,-.716567,-.850651,0,-.525731,-.688191,.587785,-.425325,-.587785,.425325,-.688191,-.425325,.688191,-.587785,-.425325,-.688191,-.587785,-.587785,-.425325,-.688191,-.688191,-.587785,-.425325];j.parse.fromCollada=function(r){var e=j.parse._buffToStr(r),i=new DOMParser().parseFromString(e,"text/xml");i=i.childNodes[0];var s={},t=i.getElementsByTagName("asset")[0],o=i.getElementsByTagName("library_geometries")[0],n=i.getElementsByTagName("library_images")[0],a=i.getElementsByTagName("library_materials")[0],A=i.getElementsByTagName("library_effects")[0];return t&&(s.asset=j.parse.fromCollada._asset(t)),o&&(s.geometries=j.parse.fromCollada._libGeometries(o)),n&&(s.images=j.parse.fromCollada._libImages(n)),a&&(s.materials=j.parse.fromCollada._libMaterials(a)),A&&(s.effects=j.parse.fromCollada._libEffects(A)),s};j.parse.fromCollada._asset=function(r){return{created:r.getElementsByTagName("created")[0].textContent,modified:r.getElementsByTagName("modified")[0].textContent,up_axis:r.getElementsByTagName("up_axis")[0].textContent}};j.parse.fromCollada._libGeometries=function(r){r=r.getElementsByTagName("geometry");for(var e=[],i=0;i<r.length;i++){var s=r[i],t=j.parse.fromCollada._getMesh(s.getElementsByTagName("mesh")[0]);e.push(t)}return e};j.parse.fromCollada._getMesh=function(r){for(var e={},i=r.getElementsByTagName("source"),s=e.sources={},t=0;t<i.length;t++){for(var o=i[t].getElementsByTagName("float_array")[0].textContent.split(" "),n=o.length-(o[o.length-1]==""?1:0),a=new Array(n),A=0;A<n;A++)a[A]=parseFloat(o[A]);s[i[t].getAttribute("id")]=a}e.triangles=[];var l=r.getElementsByTagName("triangles");if(l==null)return e;for(var t=0;t<l.length;t++){var h={},d=l[t];h.material=d.getAttribute("material");for(var f=d.getElementsByTagName("input"),m=[],A=0;A<f.length;A++){var _=f[A],a=[];m[parseInt(_.getAttribute("offset"))]=a;var u=_.getAttribute("semantic");h["s_"+u]=u=="VERTEX"?r.getElementsByTagName("vertices")[0].getElementsByTagName("input")[0].getAttribute("source").substring(1):_.getAttribute("source").substring(1),h["i_"+u]=a,s[h["s_"+u]]}for(var P=d.getElementsByTagName("p")[0].textContent.split(" "),y=3*Math.floor(P.length/3),A=0;A<y;A++)m[A%f.length].push(parseInt(P[A]));e.triangles.push(h)}return e};j.parse.fromCollada._libImages=function(r){r=r.getElementsByTagName("image");for(var e={},i=0;i<r.length;i++)e[r[i].getAttribute("id")]=r[i].getElementsByTagName("init_from")[0].textContent;return e};j.parse.fromCollada._libMaterials=function(r){r=r.getElementsByTagName("material");for(var e={},i=0;i<r.length;i++)e[r[i].getAttribute("name")]=r[i].getElementsByTagName("instance_effect")[0].getAttribute("url").substring(1);return e};j.parse.fromCollada._libEffects=function(r){r=r.getElementsByTagName("effect");for(var e={},i=0;i<r.length;i++){for(var s={},t=r[i].getElementsByTagName("newparam"),o=0;o<t.length;o++){var n=t[o].getElementsByTagName("surface")[0];n&&(s.surface=n.getElementsByTagName("init_from")[0].textContent)}e[r[i].getAttribute("id")]=s}return e};j.parse.from3DS=function(r){r=new Uint8Array(r);var e={};if(j.bin.rsl(r,0)!=19789)return null;for(var i=j.bin.ril(r,2),s=6;s<i;){var t=j.bin.rsl(r,s),o=j.bin.ril(r,s+2);t==15677&&(e.edit=j.parse.from3DS._edit3ds(r,s,o)),t==45056&&(e.keyf=j.parse.from3DS._keyf3ds(r,s,o)),s+=o}return e};j.parse.from3DS._edit3ds=function(r,e,i){for(var s={},t=e+6;t<e+i;){var o=j.bin.rsl(r,t),n=j.bin.ril(r,t+2);o==16384&&(s.objects==null&&(s.objects=[]),s.objects.push(j.parse.from3DS._edit_object(r,t,n))),t+=n}return s};j.parse.from3DS._keyf3ds=function(r,e,i){for(var s={},t=e+6;t<e+i;){var o=j.bin.rsl(r,t),n=j.bin.ril(r,t+2);o==45058&&(s.desc==null&&(s.desc=[]),s.desc.push(j.parse.from3DS._keyf_objdes(r,t,n))),t+=n}return s};j.parse.from3DS._keyf_objdes=function(r,e,i){for(var s={},t=e+6;t<e+i;){var o=j.bin.rsl(r,t),n=j.bin.ril(r,t+2);o==45072&&(s.hierarchy=j.parse.from3DS._keyf_objhierarch(r,t,n)),o==45073&&(s.dummy_name=j.bin.rASCII0(r,t+6)),t+=n}return s};j.parse.from3DS._keyf_objhierarch=function(r,e,i){var s={},t=e+6;return s.name=j.bin.rASCII0(r,t),t+=s.name.length+1,s.hierarchy=j.bin.rsl(r,t+4),s};j.parse.from3DS._edit_object=function(r,e,i){var s={},t=e+6;for(s.name=j.bin.rASCII0(r,t),t+=s.name.length+1;t<e+i;){var o=j.bin.rsl(r,t),n=j.bin.ril(r,t+2);o==16640&&(s.mesh=j.parse.from3DS._obj_trimesh(r,t,n)),t+=n}return s};j.parse.from3DS._obj_trimesh=function(r,e,i){for(var s={},t=e+6;t<e+i;){var o=j.bin.rsl(r,t),n=j.bin.ril(r,t+2);o==16656&&(s.vertices=j.parse.from3DS._tri_vertexl(r,t,n)),o==16672&&(s.indices=j.parse.from3DS._tri_facel1(r,t,n)),o==16704&&(s.uvt=j.parse.from3DS._tri_mappingcoors(r,t,n)),o==16736&&(s.local=j.parse.from3DS._tri_local(r,t,n)),t+=n}return s};j.parse.from3DS._tri_vertexl=function(r,e,i){var s=[],t=e+6,o=j.bin.rsl(r,t);t+=2;for(var n=0;n<o;n++)s.push(j.bin.rf(r,t)),s.push(j.bin.rf(r,t+4)),s.push(j.bin.rf(r,t+8)),t+=12;return s};j.parse.from3DS._tri_facel1=function(r,e,i){var s=[],t=e+6,o=j.bin.rsl(r,t);t+=2;for(var n=0;n<o;n++)s.push(j.bin.rsl(r,t)),s.push(j.bin.rsl(r,t+2)),s.push(j.bin.rsl(r,t+4)),t+=8;return s};j.parse.from3DS._tri_mappingcoors=function(r,e,i){var s=[],t=e+6,o=j.bin.rsl(r,t);t+=2;for(var n=0;n<o;n++)s.push(j.bin.rf(r,t)),s.push(1-j.bin.rf(r,t+4)),t+=8;return s};j.parse.from3DS._tri_local=function(r,e,i){var s={},t=e+6;return s.X=[j.bin.rf(r,t),j.bin.rf(r,t+4),j.bin.rf(r,t+8)],t+=12,s.Y=[j.bin.rf(r,t),j.bin.rf(r,t+4),j.bin.rf(r,t+8)],t+=12,s.Z=[j.bin.rf(r,t),j.bin.rf(r,t+4),j.bin.rf(r,t+8)],t+=12,s.C=[j.bin.rf(r,t),j.bin.rf(r,t+4),j.bin.rf(r,t+8)],t+=12,s};j.parse.fromBIV=function(r){r=new Uint8Array(r);var e={},i={};return i.id=j.bin.ril(r,0),i.verS=j.bin.ril(r,4),i.texS=j.bin.ril(r,8),i.indS=j.bin.ril(r,12),i.verO=j.bin.ril(r,16),i.verL=j.bin.ril(r,20),i.texO=j.bin.ril(r,24),i.texL=j.bin.ril(r,28),i.indO=j.bin.ril(r,32),i.indL=j.bin.ril(r,36),i.verO!=0&&(e.vertices=j.parse.fromBIV._readFloats(r,i.verO,i.verL)),i.texO!=0&&(e.uvt=j.parse.fromBIV._readFloats(r,i.texO,i.texL)),i.indO!=0&&(e.indices=j.parse.fromBIV._readInts(r,i.indO,i.indL,i.indS)),e};j.parse.toBIV=function(r){for(var e=0,i=0;i<r.indices.length;i++)e=Math.max(e,r.indices[i]);var s=32;e<=65535&&(s=16);var t=40;r.vertices&&(t+=r.vertices.length*4),r.uvt&&(t+=r.uvt.length*4),r.indices&&(t+=r.indices.length*s/8);var o=new Uint8Array(t);j.bin.wil(o,0,1769365870),j.bin.wil(o,4,32),j.bin.wil(o,8,32),j.bin.wil(o,12,s);var n=40;return r.vertices&&(j.bin.wil(o,16,n),j.bin.wil(o,20,4*r.vertices.length),j.parse.fromBIV._writeFloats(o,n,r.vertices),n+=4*r.vertices.length),r.uvt&&(j.bin.wil(o,24,n),j.bin.wil(o,28,4*r.uvt.length),j.parse.fromBIV._writeFloats(o,n,r.uvt),n+=4*r.uvt.length),r.indices&&(j.bin.wil(o,32,n),j.bin.wil(o,36,4*r.indices.length),j.parse.fromBIV._writeInts(o,n,r.indices,s)),o.buffer};j.parse.fromBIV._readFloats=function(r,e,i){for(var s=[],t=0;t<i/4;t++)s.push(j.bin.rf(r,e+4*t));return s};j.parse.fromBIV._writeFloats=function(r,e,i){for(var s=0;s<i.length;s++)j.bin.wf(r,e+4*s,i[s])};j.parse.fromBIV._readInts=function(r,e,i,s){for(var t=[],o=0;o<i/4;o++)s==16&&t.push(j.bin.rsl(r,e+2*o)),s==32&&t.push(j.bin.ril(r,e+4*o));return t};j.parse.fromBIV._writeInts=function(r,e,i,s){for(var t=0;t<i.length;t++)s==16&&j.bin.wsl(r,e+2*t,i[t]),s==32&&j.bin.wil(r,e+4*t,i[t])};j.gen={};j.gen.Plane=function(r,e,i,s){i||(i=1),s||(s=1);for(var t={verts:[],inds:[],uvt:[]},o=r+1,n=e+1,a=0;a<n;a++)for(var A=0;A<o;A++){var l=-1+A*(2/r),h=-1+a*(2/e);t.verts.push(l,h,0),t.uvt.push(i*A/r,s*a/e),a<e&&A<r&&t.inds.push(a*o+A,a*o+A+1,(a+1)*o+A,a*o+A+1,(a+1)*o+A,(a+1)*o+A+1)}return t};j.gen.Cube=function(){var r={verts:[-1,1,-1,1,1,-1,-1,-1,-1,1,-1,-1,-1,1,1,1,1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,-1,1,1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,-1,1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,-1,-1,1,1,-1,1],inds:[0,1,2,1,2,3,4,5,6,5,6,7,8,9,10,9,10,11,12,13,14,13,14,15,16,17,18,17,18,19,20,21,22,21,22,23],uvt:[.25,.25,.5,.25,.25,.5,.5,.5,1,.25,.75,.25,1,.5,.75,.5,0,.25,.25,.25,0,.5,.25,.5,.75,.25,.5,.25,.75,.5,.5,.5,.25,.25,.5,.25,.25,0,.5,0,.25,.5,.5,.5,.25,.75,.5,.75]};return r};j.gen.Sphere=function(r,e){for(var i={verts:[],inds:[],uvt:[]},s=r+1,t=e+1,o=0;o<t;o++)for(var n=0;n<s;n++){var a=-Math.PI/2+o*Math.PI/e,A=n*2*Math.PI/r,l=Math.cos(a)*Math.cos(A),h=Math.sin(a),d=Math.cos(a)*Math.sin(A);i.verts.push(l,h,d),i.uvt.push(n/r,o/e),o<e&&n<r&&i.inds.push(s*o+n,s*o+n+1,s*(o+1)+n,s*o+n+1,s*(o+1)+n,s*(o+1)+n+1)}return i};j.mat={};j.mat.scale=function(r,e,i){return[r,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1]};j.mat.translate=function(r,e,i){return[1,0,0,0,0,1,0,0,0,0,1,0,r,e,i,1]};j.mat.rotateDeg=function(r,e,i){var s=Math.PI/180;return j.mat.rotate(r*s,e*s,i*s)};j.mat.rotate=function(r,e,i){var s=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],t=r,o=e,n=i,a=Math.cos(t),A=Math.cos(o),l=Math.cos(n),h=Math.sin(t),d=Math.sin(o),f=Math.sin(n);return s[0]=A*l,s[1]=-A*f,s[2]=d,s[4]=a*f+h*d*l,s[5]=a*l-h*d*f,s[6]=-h*A,s[8]=h*f-a*d*l,s[9]=h*l+a*d*f,s[10]=a*A,s};j.edit={};j.edit.interpolate=function(r,e,i,s){for(var t=0;t<r.length;t++)i[t]=r[t]+s*(e[t]-r[t])};j.edit.transform=function(r,e){for(var i=0;i<r.length;i+=3){var s=r[i],t=r[i+1],o=r[i+2];r[i+0]=e[0]*s+e[4]*t+e[8]*o+e[12],r[i+1]=e[1]*s+e[5]*t+e[9]*o+e[13],r[i+2]=e[2]*s+e[6]*t+e[10]*o+e[14]}};j.edit.unwrap=function(r,e,i){for(var s=new Array(Math.floor(r.length/3)*i),t=0;t<r.length;t++)for(var o=0;o<i;o++)s[t*i+o]=e[r[t]*i+o];return s};j.edit.remap=function(r,e,i,s){for(var t=new Array(i.length),o=0;o<r.length;o++)for(var n=0;n<s;n++)t[e[o]*s+n]=i[r[o]*s+n];return t};j.utils={};j.utils.getAABB=function(r){var e,i,s,t,o,n;e=i=s=999999999,t=o=n=-e;for(var a=0;a<r.length;a+=3){var A=r[a+0],l=r[a+1],h=r[a+2];A<e&&(e=A),A>t&&(t=A),l<i&&(i=l),l>o&&(o=l),h<s&&(s=h),l>n&&(n=h)}return{min:{x:e,y:i,z:s},max:{x:t,y:o,z:n}}};const Ma=c.OBB3(),Ro=c.OBB3(),Jc=c.OBB3();class b0{constructor(e,i,s,t,o,n,a=null,A=0){this.model=e,this.object=null,this.parent=null,this.transform=o,this.textureSet=n,this._matrixDirty=!1,this._matrixUpdateScheduled=!1,this.id=i,this.obb=null,this._aabbLocal=null,this._aabbWorld=c.AABB3(),this._aabbWorldDirty=!1,this.layer=a,this.portionId=A,this._color=new Uint8Array([s[0],s[1],s[2],t]),this._colorize=new Uint8Array([s[0],s[1],s[2],t]),this._colorizing=!1,this._transparent=t<255,this.numTriangles=0,this.origin=null,this.entity=null,o&&o._addMesh(this)}_sceneModelDirty(){this._aabbWorldDirty=!0,this.layer.aabbDirty=!0}_transformDirty(){!this._matrixDirty&&!this._matrixUpdateScheduled&&(this.model._meshMatrixDirty(this),this._matrixDirty=!0,this._matrixUpdateScheduled=!0),this._aabbWorldDirty=!0,this.layer.aabbDirty=!0,this.entity&&this.entity._transformDirty()}_updateMatrix(){this.transform&&this._matrixDirty&&this.layer.setMatrix(this.portionId,this.transform.worldMatrix),this._matrixDirty=!1,this._matrixUpdateScheduled=!1}_finalize(e){this.layer.initFlags(this.portionId,e,this._transparent)}_finalize2(){this.layer.flushInitFlags&&this.layer.flushInitFlags()}_setVisible(e){this.layer.setVisible(this.portionId,e,this._transparent)}_setColor(e){this._color[0]=e[0],this._color[1]=e[1],this._color[2]=e[2],this._colorizing||this.layer.setColor(this.portionId,this._color,!1)}_setColorize(e){e?(this._colorize[0]=e[0],this._colorize[1]=e[1],this._colorize[2]=e[2],this.layer.setColor(this.portionId,this._colorize,!1),this._colorizing=!0):(this.layer.setColor(this.portionId,this._color,!1),this._colorizing=!1)}_setOpacity(e,i){const s=e<255,o=this._transparent!==s;this._color[3]=e,this._colorize[3]=e,this._transparent=s,this._colorizing?this.layer.setColor(this.portionId,this._colorize):this.layer.setColor(this.portionId,this._color),o&&this.layer.setTransparent(this.portionId,i,s)}_setOffset(e){this.layer.setOffset(this.portionId,e)}_setHighlighted(e){this.layer.setHighlighted(this.portionId,e,this._transparent)}_setXRayed(e){this.layer.setXRayed(this.portionId,e,this._transparent)}_setSelected(e){this.layer.setSelected(this.portionId,e,this._transparent)}_setEdges(e){this.layer.setEdges(this.portionId,e,this._transparent)}_setClippable(e){this.layer.setClippable(this.portionId,e,this._transparent)}_setCollidable(e){this.layer.setCollidable(this.portionId,e)}_setPickable(e){this.layer.setPickable(this.portionId,e,this._transparent)}_setCulled(e){this.layer.setCulled(this.portionId,e,this._transparent)}canPickTriangle(){return!1}drawPickTriangles(e,i){}pickTriangleSurface(e){}precisionRayPickSurface(e,i,s,t){return this.layer.precisionRayPickSurface?this.layer.precisionRayPickSurface(this.portionId,e,i,s,t):!1}canPickWorldPos(){return!0}drawPickDepths(e){this.model.drawPickDepths(e)}drawPickNormals(e){this.model.drawPickNormals(e)}delegatePickedEntity(){return this.parent}getEachVertex(e){this.layer.getEachVertex(this.portionId,e)}set aabb(e){this._aabbLocal=e}get aabb(){if(this._aabbWorldDirty){if(c.AABB3ToOBB3(this._aabbLocal,Ma),this.transform?(c.transformOBB3(this.transform.worldMatrix,Ma,Ro),c.transformOBB3(this.model.worldMatrix,Ro,Jc),c.OBB3ToAABB3(Jc,this._aabbWorld)):(c.transformOBB3(this.model.worldMatrix,Ma,Ro),c.OBB3ToAABB3(Ro,this._aabbWorld)),this.origin){const e=this.origin;this._aabbWorld[0]+=e[0],this._aabbWorld[1]+=e[1],this._aabbWorld[2]+=e[2],this._aabbWorld[3]+=e[0],this._aabbWorld[4]+=e[1],this._aabbWorld[5]+=e[2]}this._aabbWorldDirty=!1}return this._aabbWorld}_destroy(){this.model.scene._renderer.putPickID(this.pickId)}}class C0{constructor(){this._uint8Arrays={},this._float32Arrays={}}_clear(){this._uint8Arrays={},this._float32Arrays={}}getUInt8Array(e){let i=this._uint8Arrays[e];return i||(i=new Uint8Array(e),this._uint8Arrays[e]=i),i}getFloat32Array(e){let i=this._float32Arrays[e];return i||(i=new Float32Array(e),this._float32Arrays[e]=i),i}}const Cp=new C0;let Bn=0;function E0(){return Bn++,Cp}function I0(){Bn!==0&&(Bn--,Bn===0&&Cp._clear())}const U={NOT_RENDERED:0,COLOR_OPAQUE:1,COLOR_TRANSPARENT:2,SILHOUETTE_HIGHLIGHTED:3,SILHOUETTE_SELECTED:4,SILHOUETTE_XRAYED:5,EDGES_COLOR_OPAQUE:6,EDGES_COLOR_TRANSPARENT:7,EDGES_HIGHLIGHTED:8,EDGES_SELECTED:9,EDGES_XRAYED:10,PICK:11},F0=new Float32Array([1,1,1,1]),M0=new Float32Array([0,0,0,1]),Cr=c.vec4(),eh=c.vec3(),S0=c.vec3(),T0=c.mat4();class zt{constructor(e,i=!1,{instancing:s=!1,edges:t=!1}={}){this._scene=e,this._withSAO=i,this._instancing=s,this._edges=t,this._hash=this._getHash(),this._matricesUniformBlockBufferBindingPoint=0,this._matricesUniformBlockBuffer=this._scene.canvas.gl.createBuffer(),this._matricesUniformBlockBufferData=new Float32Array(4*4*6),this._vaoCache=new WeakMap,this._allocate()}_getHash(){return this._scene._sectionPlanesState.getHash()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){return[""]}_buildFragmentShader(){return[""]}_addMatricesUniformBlockLines(e,i=!1){return e.push("uniform Matrices {"),e.push("    mat4 worldMatrix;"),e.push("    mat4 viewMatrix;"),e.push("    mat4 projMatrix;"),e.push("    mat4 positionsDecodeMatrix;"),i&&(e.push("    mat4 worldNormalMatrix;"),e.push("    mat4 viewNormalMatrix;")),e.push("};"),e}_addRemapClipPosLines(e,i=1){return e.push("uniform vec2 drawingBufferSize;"),e.push("uniform vec2 pickClipPos;"),e.push("vec4 remapClipPos(vec4 clipPos) {"),e.push("    clipPos.xy /= clipPos.w;"),i===1?e.push("    clipPos.xy = (clipPos.xy - pickClipPos) * drawingBufferSize;"):e.push(`    clipPos.xy = (clipPos.xy - pickClipPos) * (drawingBufferSize / float(${i}));`),e.push("    clipPos.xy *= clipPos.w;"),e.push("    return clipPos;"),e.push("}"),e}getValid(){return this._hash===this._getHash()}setSectionPlanesStateUniforms(e){const i=this._scene,{gl:s}=i.canvas,{model:t,layerIndex:o}=e,n=i._sectionPlanesState.getNumAllocatedSectionPlanes(),a=i._sectionPlanesState.sectionPlanes.length;if(n>0){const A=i._sectionPlanesState.sectionPlanes,l=o*a,h=t.renderFlags;i.crossSections&&(s.uniform4fv(this._uSliceColor,i.crossSections.sliceColor),s.uniform1f(this._uSliceThickness,i.crossSections.sliceThickness));for(let d=0;d<n;d++){const f=this._uSectionPlanes[d];if(f)if(d<a){const m=h.sectionPlanesActivePerLayer[l+d];if(s.uniform1i(f.active,m?1:0),m){const _=A[d],u=e._state.origin;if(u){const P=Ut(_.dist,_.dir,u,eh);s.uniform3fv(f.pos,P)}else s.uniform3fv(f.pos,_.pos);s.uniform3fv(f.dir,_.dir)}}else s.uniform1i(f.active,0)}}}_allocate(){const e=this._scene,i=e.canvas.gl,s=e._lightsState;if(this._program=new It(i,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const t=this._program;this._uRenderPass=t.getLocation("renderPass"),this._uColor=t.getLocation("color"),this._uColor||(this._uColor=t.getLocation("silhouetteColor")),this._uUVDecodeMatrix=t.getLocation("uvDecodeMatrix"),this._uPickInvisible=t.getLocation("pickInvisible"),this._uGammaFactor=t.getLocation("gammaFactor"),i.uniformBlockBinding(t.handle,i.getUniformBlockIndex(t.handle,"Matrices"),this._matricesUniformBlockBufferBindingPoint),this._uShadowViewMatrix=t.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=t.getLocation("shadowProjMatrix"),e.logarithmicDepthBufferEnabled&&(this._uZFar=t.getLocation("zFar")),this._uLightAmbient=t.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const o=s.lights;let n;for(let a=0,A=o.length;a<A;a++)switch(n=o[a],n.type){case"dir":this._uLightColor[a]=t.getLocation("lightColor"+a),this._uLightPos[a]=null,this._uLightDir[a]=t.getLocation("lightDir"+a);break;case"point":this._uLightColor[a]=t.getLocation("lightColor"+a),this._uLightPos[a]=t.getLocation("lightPos"+a),this._uLightDir[a]=null,this._uLightAttenuation[a]=t.getLocation("lightAttenuation"+a);break;case"spot":this._uLightColor[a]=t.getLocation("lightColor"+a),this._uLightPos[a]=t.getLocation("lightPos"+a),this._uLightDir[a]=t.getLocation("lightDir"+a),this._uLightAttenuation[a]=t.getLocation("lightAttenuation"+a);break}s.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),s.lightMaps.length>0&&(this._uLightMap="lightMap"),this._uSectionPlanes=[];for(let a=0,A=e._sectionPlanesState.getNumAllocatedSectionPlanes();a<A;a++)this._uSectionPlanes.push({active:t.getLocation("sectionPlaneActive"+a),pos:t.getLocation("sectionPlanePos"+a),dir:t.getLocation("sectionPlaneDir"+a)});this._aPosition=t.getAttribute("position"),this._aOffset=t.getAttribute("offset"),this._aNormal=t.getAttribute("normal"),this._aUV=t.getAttribute("uv"),this._aColor=t.getAttribute("color"),this._aMetallicRoughness=t.getAttribute("metallicRoughness"),this._aFlags=t.getAttribute("flags"),this._aPickColor=t.getAttribute("pickColor"),this._uPickZNear=t.getLocation("pickZNear"),this._uPickZFar=t.getLocation("pickZFar"),this._uPickClipPos=t.getLocation("pickClipPos"),this._uDrawingBufferSize=t.getLocation("drawingBufferSize"),this._uColorMap="uColorMap",this._uMetallicRoughMap="uMetallicRoughMap",this._uEmissiveMap="uEmissiveMap",this._uNormalMap="uNormalMap",this._uAOMap="uAOMap",this._instancing&&(this._aModelMatrix=t.getAttribute("modelMatrix"),this._aModelMatrixCol0=t.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=t.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=t.getAttribute("modelMatrixCol2"),this._aModelNormalMatrixCol0=t.getAttribute("modelNormalMatrixCol0"),this._aModelNormalMatrixCol1=t.getAttribute("modelNormalMatrixCol1"),this._aModelNormalMatrixCol2=t.getAttribute("modelNormalMatrixCol2")),this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=t.getLocation("uSAOParams")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=t.getLocation("logDepthBufFC")),e.pointsMaterial._state.filterIntensity&&(this._uIntensityRange=t.getLocation("intensityRange")),this._uPointSize=t.getLocation("pointSize"),this._uNearPlaneHeight=t.getLocation("nearPlaneHeight"),e.crossSections&&(this._uSliceColor=t.getLocation("sliceColor"),this._uSliceThickness=t.getLocation("sliceThickness"))}_bindProgram(e){const i=this._scene,s=i.canvas.gl,t=this._program,o=i._lightsState,n=o.lights;t.bind(),e.textureUnit=0,this._uLightAmbient&&s.uniform4fv(this._uLightAmbient,o.getAmbientColorAndIntensity()),this._uGammaFactor&&s.uniform1f(this._uGammaFactor,i.gammaFactor);for(let a=0,A=n.length;a<A;a++){const l=n[a];this._uLightColor[a]&&s.uniform4f(this._uLightColor[a],l.color[0],l.color[1],l.color[2],l.intensity),this._uLightPos[a]&&(s.uniform3fv(this._uLightPos[a],l.pos),this._uLightAttenuation[a]&&s.uniform1f(this._uLightAttenuation[a],l.attenuation)),this._uLightDir[a]&&s.uniform3fv(this._uLightDir[a],l.dir)}}_makeVAO(e){const i=this._scene.canvas.gl,s=i.createVertexArray();return i.bindVertexArray(s),this._instancing&&(this._aModelMatrixCol0.bindArrayBuffer(e.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(e.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(e.modelMatrixCol2Buf),i.vertexAttribDivisor(this._aModelMatrixCol0.location,1),i.vertexAttribDivisor(this._aModelMatrixCol1.location,1),i.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aModelNormalMatrixCol0&&(this._aModelNormalMatrixCol0.bindArrayBuffer(e.modelNormalMatrixCol0Buf),i.vertexAttribDivisor(this._aModelNormalMatrixCol0.location,1)),this._aModelNormalMatrixCol1&&(this._aModelNormalMatrixCol1.bindArrayBuffer(e.modelNormalMatrixCol1Buf),i.vertexAttribDivisor(this._aModelNormalMatrixCol1.location,1)),this._aModelNormalMatrixCol2&&(this._aModelNormalMatrixCol2.bindArrayBuffer(e.modelNormalMatrixCol2Buf),i.vertexAttribDivisor(this._aModelNormalMatrixCol2.location,1))),this._aPosition.bindArrayBuffer(e.positionsBuf),this._aUV&&this._aUV.bindArrayBuffer(e.uvBuf),this._aNormal&&this._aNormal.bindArrayBuffer(e.normalsBuf),this._aMetallicRoughness&&(this._aMetallicRoughness.bindArrayBuffer(e.metallicRoughnessBuf),this._instancing&&i.vertexAttribDivisor(this._aMetallicRoughness.location,1)),this._aColor&&(this._aColor.bindArrayBuffer(e.colorsBuf),this._instancing&&e.colorsBuf&&i.vertexAttribDivisor(this._aColor.location,1)),this._aFlags&&(this._aFlags.bindArrayBuffer(e.flagsBuf),this._instancing&&i.vertexAttribDivisor(this._aFlags.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(e.offsetsBuf),this._instancing&&i.vertexAttribDivisor(this._aOffset.location,1)),this._aPickColor&&(this._aPickColor.bindArrayBuffer(e.pickColorsBuf),this._instancing&&i.vertexAttribDivisor(this._aPickColor.location,1)),this._instancing?this._edges?e.edgeIndicesBuf.bind():e.indicesBuf&&e.indicesBuf.bind():this._edges?e.edgeIndicesBuf.bind():e.indicesBuf&&e.indicesBuf.bind(),s}drawLayer(e,i,s,{colorUniform:t=!1,incrementDrawState:o=!1}={}){const n=_t.MAX_TEXTURE_IMAGE_UNITS,a=this._scene,A=a.canvas.gl,{_state:l,model:h}=i,{textureSet:d,origin:f,positionsDecodeMatrix:m}=l,_=a._lightsState,u=a.pointsMaterial,{camera:P}=h.scene,{viewNormalMatrix:y,project:x}=P,B=e.pickViewMatrix||P.viewMatrix,{position:v,rotationMatrix:w,rotationMatrixConjugate:C,worldNormalMatrix:I}=h;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),this._vaoCache.has(i)?A.bindVertexArray(this._vaoCache.get(i)):this._vaoCache.set(i,this._makeVAO(l));let E=0;const S=4*4;this._matricesUniformBlockBufferData.set(C,0);const R=f[0]!==0||f[1]!==0||f[2]!==0,D=v[0]!==0||v[1]!==0||v[2]!==0;if(R||D){const K=eh;if(R){const G=c.transformPoint3(w,f,S0);K[0]=G[0],K[1]=G[1],K[2]=G[2]}else K[0]=0,K[1]=0,K[2]=0;K[0]+=v[0],K[1]+=v[1],K[2]+=v[2],this._matricesUniformBlockBufferData.set(ft(B,K,T0),E+=S)}else this._matricesUniformBlockBufferData.set(B,E+=S);if(this._matricesUniformBlockBufferData.set(e.pickProjMatrix||x.matrix,E+=S),this._matricesUniformBlockBufferData.set(m,E+=S),this._matricesUniformBlockBufferData.set(I,E+=S),this._matricesUniformBlockBufferData.set(y,E+=S),A.bindBuffer(A.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),A.bufferData(A.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,A.DYNAMIC_DRAW),A.bindBufferBase(A.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer),A.uniform1i(this._uRenderPass,s),this.setSectionPlanesStateUniforms(i),a.logarithmicDepthBufferEnabled){if(this._uLogDepthBufFC){const K=2/(Math.log(e.pickZFar+1)/Math.LN2);A.uniform1f(this._uLogDepthBufFC,K)}this._uZFar&&A.uniform1f(this._uZFar,a.camera.project.far)}if(this._uPickInvisible&&A.uniform1i(this._uPickInvisible,e.pickInvisible),this._uPickZNear&&A.uniform1f(this._uPickZNear,e.pickZNear),this._uPickZFar&&A.uniform1f(this._uPickZFar,e.pickZFar),this._uPickClipPos&&A.uniform2fv(this._uPickClipPos,e.pickClipPos),this._uDrawingBufferSize&&A.uniform2f(this._uDrawingBufferSize,A.drawingBufferWidth,A.drawingBufferHeight),this._uUVDecodeMatrix&&A.uniformMatrix3fv(this._uUVDecodeMatrix,!1,l.uvDecodeMatrix),this._uIntensityRange&&u.filterIntensity&&A.uniform2f(this._uIntensityRange,u.minIntensity,u.maxIntensity),this._uPointSize&&A.uniform1f(this._uPointSize,u.pointSize),this._uNearPlaneHeight){const K=a.camera.projection==="ortho"?1:A.drawingBufferHeight/(2*Math.tan(.5*a.camera.perspective.fov*Math.PI/180));A.uniform1f(this._uNearPlaneHeight,K)}if(d){const{colorTexture:K,metallicRoughnessTexture:G,emissiveTexture:z,normalsTexture:le,occlusionTexture:ue}=d;this._uColorMap&&K&&(this._program.bindTexture(this._uColorMap,K.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%n),this._uMetallicRoughMap&&G&&(this._program.bindTexture(this._uMetallicRoughMap,G.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%n),this._uEmissiveMap&&z&&(this._program.bindTexture(this._uEmissiveMap,z.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%n),this._uNormalMap&&le&&(this._program.bindTexture(this._uNormalMap,le.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%n),this._uAOMap&&ue&&(this._program.bindTexture(this._uAOMap,ue.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%n)}if(_.reflectionMaps.length>0&&_.reflectionMaps[0].texture&&this._uReflectionMap&&(this._program.bindTexture(this._uReflectionMap,_.reflectionMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%n,e.bindTexture++),_.lightMaps.length>0&&_.lightMaps[0].texture&&this._uLightMap&&(this._program.bindTexture(this._uLightMap,_.lightMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%n,e.bindTexture++),this._withSAO){const K=a.sao;if(K.possible){const z=A.drawingBufferWidth,le=A.drawingBufferHeight;Cr[0]=z,Cr[1]=le,Cr[2]=K.blendCutoff,Cr[3]=K.blendFactor,A.uniform4fv(this._uSAOParams,Cr),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%n,e.bindTexture++}}if(t){const K=this._edges?"edgeColor":"fillColor",G=this._edges?"edgeAlpha":"fillAlpha";if(s===U[`${this._edges?"EDGES":"SILHOUETTE"}_XRAYED`]){const z=a.xrayMaterial._state,le=z[K],ue=z[G];A.uniform4f(this._uColor,le[0],le[1],le[2],ue)}else if(s===U[`${this._edges?"EDGES":"SILHOUETTE"}_HIGHLIGHTED`]){const z=a.highlightMaterial._state,le=z[K],ue=z[G];A.uniform4f(this._uColor,le[0],le[1],le[2],ue)}else if(s===U[`${this._edges?"EDGES":"SILHOUETTE"}_SELECTED`]){const z=a.selectedMaterial._state,le=z[K],ue=z[G];A.uniform4f(this._uColor,le[0],le[1],le[2],ue)}else A.uniform4fv(this._uColor,this._edges?M0:F0)}this._draw({state:l,frameCtx:e,incrementDrawState:o}),A.bindVertexArray(null)}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null,vt.memory.programs--}}class li extends zt{constructor(e,i,{edges:s=!1}={}){super(e,i,{instancing:!1,edges:s})}_draw(e){const{gl:i}=this._scene.canvas,{state:s,frameCtx:t,incrementDrawState:o}=e;if(this._edges)i.drawElements(i.LINES,s.edgeIndicesBuf.numItems,s.edgeIndicesBuf.itemType,0);else{const n=t.pickElementsCount||s.indicesBuf.numItems,a=t.pickElementsOffset?t.pickElementsOffset*s.indicesBuf.itemByteSize:0;i.drawElements(i.TRIANGLES,n,s.indicesBuf.itemType,a),o&&t.drawElements++}}}class th extends li{_getHash(){const e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,i,s){super.drawLayer(e,i,s,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState,s=e._lightsState,t=i.getNumAllocatedSectionPlanes()>0;let o;const n=[];n.push("#version 300 es"),n.push("// Triangles batching draw vertex shader"),n.push("uniform int renderPass;"),n.push("in vec3 position;"),n.push("in vec3 normal;"),n.push("in vec4 color;"),n.push("in float flags;"),e.entityOffsetsEnabled&&n.push("in vec3 offset;"),this._addMatricesUniformBlockLines(n,!0),e.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),n.push("out float vFragDepth;"),n.push("bool isPerspectiveMatrix(mat4 m) {"),n.push("    return (m[2][3] == - 1.0);"),n.push("}"),n.push("out float isPerspective;")),n.push("uniform vec4 lightAmbient;");for(let a=0,A=s.lights.length;a<A;a++)o=s.lights[a],o.type!=="ambient"&&(n.push("uniform vec4 lightColor"+a+";"),o.type==="dir"&&n.push("uniform vec3 lightDir"+a+";"),o.type==="point"&&n.push("uniform vec3 lightPos"+a+";"),o.type==="spot"&&(n.push("uniform vec3 lightPos"+a+";"),n.push("uniform vec3 lightDir"+a+";")));n.push("vec3 octDecode(vec2 oct) {"),n.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),n.push("    if (v.z < 0.0) {"),n.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),n.push("    }"),n.push("    return normalize(v);"),n.push("}"),t&&(n.push("out vec4 vWorldPosition;"),n.push("out float vFlags;")),n.push("out vec4 vColor;"),n.push("void main(void) {"),n.push("int colorFlag = int(flags) & 0xF;"),n.push("if (colorFlag != renderPass) {"),n.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),n.push("} else {"),n.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&n.push("worldPosition.xyz = worldPosition.xyz + offset;"),n.push("vec4 viewPosition  = viewMatrix * worldPosition; "),n.push("vec4 worldNormal =  worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),n.push("vec3 viewNormal = normalize((viewNormalMatrix * worldNormal).xyz);"),n.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),n.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),n.push("float lambertian = 1.0;");for(let a=0,A=s.lights.length;a<A;a++)if(o=s.lights[a],o.type!=="ambient"){if(o.type==="dir")o.space==="view"?n.push("viewLightDir = normalize(lightDir"+a+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+a+", 0.0)).xyz);");else if(o.type==="point")o.space==="view"?n.push("viewLightDir = -normalize(lightPos"+a+" - viewPosition.xyz);"):n.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+a+", 0.0)).xyz);");else if(o.type==="spot")o.space==="view"?n.push("viewLightDir = normalize(lightDir"+a+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+a+", 0.0)).xyz);");else continue;n.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),n.push("reflectedColor += lambertian * (lightColor"+a+".rgb * lightColor"+a+".a);")}return n.push("vec3 rgb = (vec3(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0));"),n.push("vColor =  vec4((lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedColor * rgb), float(color.a) / 255.0);"),n.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(n.push("vFragDepth = 1.0 + clipPos.w;"),n.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(n.push("vWorldPosition = worldPosition;"),n.push("vFlags = flags;")),n.push("gl_Position = clipPos;"),n.push("}"),n.push("}"),n}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Triangles batching draw fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),this._withSAO&&(t.push("uniform sampler2D uOcclusionTexture;"),t.push("uniform vec4      uSAOParams;"),t.push("const float       packUpscale = 256. / 255.;"),t.push("const float       unpackDownScale = 255. / 256.;"),t.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),t.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),t.push("float unpackRGBToFloat( const in vec4 v ) {"),t.push("    return dot( v, unPackFactors );"),t.push("}")),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";");t.push("uniform float sliceThickness;"),t.push("uniform vec4 sliceColor;")}if(t.push("in vec4 vColor;"),t.push("out vec4 outColor;"),t.push("void main(void) {"),t.push("  vec4 newColor;"),t.push("  newColor = vColor;"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("  if (dist > sliceThickness) { "),t.push("      discard;"),t.push("  }"),t.push("  if (dist > 0.0) { "),t.push("      newColor = sliceColor;"),t.push("  }"),t.push("}")}return e.logarithmicDepthBufferEnabled&&t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),this._withSAO?(t.push("   float viewportWidth     = uSAOParams[0];"),t.push("   float viewportHeight    = uSAOParams[1];"),t.push("   float blendCutoff       = uSAOParams[2];"),t.push("   float blendFactor       = uSAOParams[3];"),t.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),t.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),t.push("   outColor            = vec4(newColor.rgb * ambient, 1.0);")):t.push("   outColor            = newColor;"),t.push("}"),t}}class ih extends li{_getHash(){const e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=[];return t.push("#version 300 es"),t.push("// Triangles batching flat-shading draw vertex shader"),t.push("uniform int renderPass;"),t.push("in vec3 position;"),t.push("in vec4 color;"),t.push("in float flags;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),this._addMatricesUniformBlockLines(t),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("out float vFragDepth;"),t.push("bool isPerspectiveMatrix(mat4 m) {"),t.push("    return (m[2][3] == - 1.0);"),t.push("}"),t.push("out float isPerspective;")),s&&(t.push("out vec4 vWorldPosition;"),t.push("out float vFlags;")),t.push("out vec4 vViewPosition;"),t.push("out vec4 vColor;"),t.push("void main(void) {"),t.push("int colorFlag = int(flags) & 0xF;"),t.push("if (colorFlag != renderPass) {"),t.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("} else {"),t.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&t.push("worldPosition.xyz = worldPosition.xyz + offset;"),t.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t.push("vViewPosition = viewPosition;"),t.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),t.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(t.push("vFragDepth = 1.0 + clipPos.w;"),t.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s&&(t.push("vWorldPosition = worldPosition;"),t.push("vFlags = flags;")),t.push("gl_Position = clipPos;"),t.push("}"),t.push("}"),t}_buildFragmentShader(){const e=this._scene,i=e._lightsState,s=e._sectionPlanesState,t=s.getNumAllocatedSectionPlanes()>0,o=[];if(o.push("#version 300 es"),o.push("// Triangles batching flat-shading draw fragment shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&(o.push("in float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),this._withSAO&&(o.push("uniform sampler2D uOcclusionTexture;"),o.push("uniform vec4      uSAOParams;"),o.push("const float       packUpscale = 256. / 255.;"),o.push("const float       unpackDownScale = 255. / 256.;"),o.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),o.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),o.push("float unpackRGBToFloat( const in vec4 v ) {"),o.push("    return dot( v, unPackFactors );"),o.push("}")),t){o.push("in vec4 vWorldPosition;"),o.push("in float vFlags;");for(let n=0,a=s.getNumAllocatedSectionPlanes();n<a;n++)o.push("uniform bool sectionPlaneActive"+n+";"),o.push("uniform vec3 sectionPlanePos"+n+";"),o.push("uniform vec3 sectionPlaneDir"+n+";");o.push("uniform float sliceThickness;"),o.push("uniform vec4 sliceColor;")}this._addMatricesUniformBlockLines(o),o.push("uniform vec4 lightAmbient;");for(let n=0,a=i.lights.length;n<a;n++){const A=i.lights[n];A.type!=="ambient"&&(o.push("uniform vec4 lightColor"+n+";"),A.type==="dir"&&o.push("uniform vec3 lightDir"+n+";"),A.type==="point"&&o.push("uniform vec3 lightPos"+n+";"),A.type==="spot"&&(o.push("uniform vec3 lightPos"+n+";"),o.push("uniform vec3 lightDir"+n+";")))}if(o.push("in vec4 vViewPosition;"),o.push("in vec4 vColor;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),o.push("  vec4 newColor;"),o.push("  newColor = vColor;"),t){o.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;");for(let n=0,a=s.getNumAllocatedSectionPlanes();n<a;n++)o.push("if (sectionPlaneActive"+n+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > sliceThickness) { "),o.push("      discard;"),o.push("  }"),o.push("  if (dist > 0.0) { "),o.push("      newColor = sliceColor;"),o.push("  }"),o.push("}")}o.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),o.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),o.push("float lambertian = 1.0;"),o.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),o.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),o.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );");for(let n=0,a=i.lights.length;n<a;n++){const A=i.lights[n];if(A.type!=="ambient"){if(A.type==="dir")A.space==="view"?o.push("viewLightDir = normalize(lightDir"+n+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+n+", 0.0)).xyz);");else if(A.type==="point")A.space==="view"?o.push("viewLightDir = -normalize(lightPos"+n+" - viewPosition.xyz);"):o.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+n+", 0.0)).xyz);");else if(A.type==="spot")A.space==="view"?o.push("viewLightDir = normalize(lightDir"+n+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+n+", 0.0)).xyz);");else continue;o.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),o.push("reflectedColor += lambertian * (lightColor"+n+".rgb * lightColor"+n+".a);")}}return o.push("vec4 fragColor =  vec4((lightAmbient.rgb * lightAmbient.a * newColor.rgb) + (reflectedColor * newColor.rgb), newColor.a);"),this._withSAO?(o.push("   float viewportWidth     = uSAOParams[0];"),o.push("   float viewportHeight    = uSAOParams[1];"),o.push("   float blendCutoff       = uSAOParams[2];"),o.push("   float blendFactor       = uSAOParams[3];"),o.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),o.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),o.push("   outColor            = vec4(fragColor.rgb * ambient, 1.0);")):o.push("   outColor            = fragColor;"),e.logarithmicDepthBufferEnabled&&o.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("}"),o}}class sh extends li{drawLayer(e,i,s){super.drawLayer(e,i,s,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=[];return t.push("#version 300 es"),t.push("// Triangles batching silhouette vertex shader"),t.push("uniform int renderPass;"),t.push("in vec3 position;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),t.push("in float flags;"),t.push("in vec4 color;"),this._addMatricesUniformBlockLines(t),t.push("uniform vec4 silhouetteColor;"),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("out float vFragDepth;"),t.push("bool isPerspectiveMatrix(mat4 m) {"),t.push("    return (m[2][3] == - 1.0);"),t.push("}"),t.push("out float isPerspective;")),s&&(t.push("out vec4 vWorldPosition;"),t.push("out float vFlags;")),t.push("out vec4 vColor;"),t.push("void main(void) {"),t.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),t.push("if (silhouetteFlag != renderPass) {"),t.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("} else {"),t.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&t.push("      worldPosition.xyz = worldPosition.xyz + offset;"),t.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s&&(t.push("vWorldPosition = worldPosition;"),t.push("vFlags = flags;")),t.push("vColor = vec4(silhouetteColor.r, silhouetteColor.g, silhouetteColor.b, min(silhouetteColor.a, color.a ));"),t.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(t.push("vFragDepth = 1.0 + clipPos.w;"),t.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t.push("gl_Position = clipPos;"),t.push("}"),t.push("}"),t}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState;let s,t;const o=i.getNumAllocatedSectionPlanes()>0,n=[];if(n.push("#version 300 es"),n.push("// Triangles batching silhouette fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),o){for(n.push("in vec4 vWorldPosition;"),n.push("in float vFlags;"),s=0,t=i.getNumAllocatedSectionPlanes();s<t;s++)n.push("uniform bool sectionPlaneActive"+s+";"),n.push("uniform vec3 sectionPlanePos"+s+";"),n.push("uniform vec3 sectionPlaneDir"+s+";");n.push("uniform float sliceThickness;"),n.push("uniform vec4 sliceColor;")}if(n.push("in vec4 vColor;"),n.push("out vec4 outColor;"),n.push("void main(void) {"),n.push("  vec4 newColor;"),n.push("  newColor = vColor;"),o){n.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;");for(let a=0,A=i.getNumAllocatedSectionPlanes();a<A;a++)n.push("if (sectionPlaneActive"+a+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > sliceThickness) { "),n.push("      discard;"),n.push("  }"),n.push("  if (dist > 0.0) { "),n.push("      newColor = sliceColor;"),n.push("  }"),n.push("}")}return e.logarithmicDepthBufferEnabled&&n.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("outColor = newColor;"),n.push("}"),n}}class Ep extends li{constructor(e){super(e,!1,{instancing:!1,edges:!0})}}class D0 extends Ep{drawLayer(e,i,s){super.drawLayer(e,i,s,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=[];return t.push("#version 300 es"),t.push("// EdgesEmphasisRenderer vertex shader"),t.push("uniform int renderPass;"),t.push("uniform vec4 color;"),t.push("in vec3 position;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),t.push("in float flags;"),this._addMatricesUniformBlockLines(t),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("out float vFragDepth;"),t.push("bool isPerspectiveMatrix(mat4 m) {"),t.push("    return (m[2][3] == - 1.0);"),t.push("}"),t.push("out float isPerspective;")),s&&(t.push("out vec4 vWorldPosition;"),t.push("out float vFlags;")),t.push("out vec4 vColor;"),t.push("void main(void) {"),t.push("int edgeFlag = int(flags) >> 8 & 0xF;"),t.push("if (edgeFlag != renderPass) {"),t.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("} else {"),t.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&t.push("      worldPosition.xyz = worldPosition.xyz + offset;"),t.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),s&&(t.push("  vWorldPosition = worldPosition;"),t.push("  vFlags = flags;")),t.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(t.push("vFragDepth = 1.0 + clipPos.w;"),t.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t.push("gl_Position = clipPos;"),t.push("vColor = vec4(color.r, color.g, color.b, color.a);"),t.push("}"),t.push("}"),t}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// EdgesEmphasisRenderer fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("in vec4 vColor;"),t.push("out vec4 outColor;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("  if (dist > 0.0) { discard; }"),t.push("}")}return e.logarithmicDepthBufferEnabled&&t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("outColor = vColor;"),t.push("}"),t}}class R0 extends Ep{drawLayer(e,i,s){super.drawLayer(e,i,s,{colorUniform:!1})}_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=[];return t.push("#version 300 es"),t.push("// Batched geometry edges drawing vertex shader"),t.push("uniform int renderPass;"),t.push("in vec3 position;"),t.push("in vec4 color;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),t.push("in float flags;"),this._addMatricesUniformBlockLines(t),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("out float vFragDepth;"),t.push("bool isPerspectiveMatrix(mat4 m) {"),t.push("    return (m[2][3] == - 1.0);"),t.push("}"),t.push("out float isPerspective;")),s&&(t.push("out vec4 vWorldPosition;"),t.push("out float vFlags;")),t.push("out vec4 vColor;"),t.push("void main(void) {"),t.push("int edgeFlag = int(flags) >> 8 & 0xF;"),t.push("if (edgeFlag != renderPass) {"),t.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("} else {"),t.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&t.push("      worldPosition.xyz = worldPosition.xyz + offset;"),t.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),s&&(t.push("  vWorldPosition = worldPosition;"),t.push("  vFlags = flags;")),t.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(t.push("vFragDepth = 1.0 + clipPos.w;"),t.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t.push("gl_Position = clipPos;"),t.push("vColor = vec4(float(color.r*0.5) / 255.0, float(color.g*0.5) / 255.0, float(color.b*0.5) / 255.0, float(color.a) / 255.0);"),t.push("}"),t.push("}"),t}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Batched geometry edges drawing fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("in vec4 vColor;"),t.push("out vec4 outColor;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("  if (dist > 0.0) { discard; }"),t.push("}")}return e.logarithmicDepthBufferEnabled&&t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("outColor = vColor;"),t.push("}"),t}}class rh extends li{_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Batched geometry picking vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 pickColor;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),this._addRemapClipPosLines(s),s.push("out vec4 vPickColor;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("      vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),i&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = remapClipPos(clipPos);"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Batched geometry picking fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(var o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("in vec4 vPickColor;"),t.push("out vec4 outColor;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("      float dist = 0.0;");for(let n=0;n<i.getNumAllocatedSectionPlanes();n++)t.push("      if (sectionPlaneActive"+n+") {"),t.push("          dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),t.push("      }");t.push("      if (dist > 0.0) { discard; }"),t.push("  }")}return e.logarithmicDepthBufferEnabled&&t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("   outColor = vPickColor; "),t.push("}"),t}}class oh extends li{_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Triangles batching pick depth vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),this._addRemapClipPosLines(s),s.push("out vec4 vViewPosition;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags = flags;")),s.push("vViewPosition = viewPosition;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = remapClipPos(clipPos);"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Triangles batching pick depth fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),t.push("uniform float pickZNear;"),t.push("uniform float pickZFar;"),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(var o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("in vec4 vViewPosition;"),t.push("vec4 packDepth(const in float depth) {"),t.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),t.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),t.push("  vec4 res = fract(depth * bitShift);"),t.push("  res -= res.xxyz * bitMask;"),t.push("  return res;"),t.push("}"),t.push("out vec4 outColor;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("      float dist = 0.0;");for(let n=0;n<i.getNumAllocatedSectionPlanes();n++)t.push("      if (sectionPlaneActive"+n+") {"),t.push("          dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),t.push("      }");t.push("      if (dist > 0.0) { discard; }"),t.push("  }")}return e.logarithmicDepthBufferEnabled&&t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),t.push("    outColor = packDepth(zNormalizedDepth); "),t.push("}"),t}}class L0 extends li{_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Triangles batching pick normals vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec3 normal;"),s.push("in float flags;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),this._addRemapClipPosLines(s,3),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),s.push("vec3 octDecode(vec2 oct) {"),s.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),s.push("    if (v.z < 0.0) {"),s.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),s.push("    }"),s.push("    return normalize(v);"),s.push("}"),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec3 vWorldNormal;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("      vec3 worldNormal =  octDecode(normal.xy); "),s.push("      vWorldNormal = worldNormal;"),i&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = remapClipPos(clipPos);"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Triangles batching pick normals fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(var o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("in vec3 vWorldNormal;"),t.push("out highp ivec4 outNormal;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("      float dist = 0.0;");for(let n=0;n<i.getNumAllocatedSectionPlanes();n++)t.push("      if (sectionPlaneActive"+n+") {"),t.push("          dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),t.push("      }");t.push("      if (dist > 0.0) { discard; }"),t.push("  }")}return e.logarithmicDepthBufferEnabled&&t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push(`    outNormal = ivec4(vWorldNormal * float(${c.MAX_INT}), 1.0);`),t.push("}"),t}}class U0 extends li{_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Triangles batching occlusion vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 color;"),s.push("in float flags;"),this._addMatricesUniformBlockLines(s),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),s.push("gl_Position = clipPos;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const i=this._scene._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Triangles batching occlusion fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("out vec4 outColor;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("      float dist = 0.0;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("      if (sectionPlaneActive"+o+") {"),t.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("      }");t.push("      if (dist > 0.0) { discard; }"),t.push("  }")}return t.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),t.push("}"),t}}class O0 extends li{_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Triangles batching depth vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),this._addMatricesUniformBlockLines(s),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec2 vHighPrecisionZW;"),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("vHighPrecisionZW = gl_Position.zw;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Triangles batching depth fragment shader"),t.push("precision highp float;"),t.push("precision highp int;"),e.logarithmicDepthBufferEnabled&&(t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let n=0;n<i.getNumAllocatedSectionPlanes();n++)t.push("uniform bool sectionPlaneActive"+n+";"),t.push("uniform vec3 sectionPlanePos"+n+";"),t.push("uniform vec3 sectionPlaneDir"+n+";")}if(t.push("const float   packUpScale = 256. / 255.;"),t.push("const float   unpackDownscale = 255. / 256.;"),t.push("const vec3    packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),t.push("const vec4    unpackFactors = unpackDownscale / vec4( packFactors, 1. );"),t.push("const float   shiftRight8 = 1.0 / 256.;"),t.push("vec4 packDepthToRGBA( const in float v ) {"),t.push("    vec4 r = vec4( fract( v * packFactors ), v );"),t.push("    r.yzw -= r.xyz * shiftRight8;"),t.push("    return r * packUpScale;"),t.push("}"),t.push("in vec2 vHighPrecisionZW;"),t.push("out vec4 outColor;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("      float dist = 0.0;");for(var o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("      if (sectionPlaneActive"+o+") {"),t.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("      }");t.push("      if (dist > 0.0) { discard; }"),t.push("  }")}return e.logarithmicDepthBufferEnabled&&t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;"),t.push("    outColor = vec4(vec3(1.0 - fragCoordZ), 1.0); "),t.push("}"),t}}class k0 extends li{_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Batched geometry normals vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec3 normal;"),s.push("in vec4 color;"),s.push("in float flags;"),this._addMatricesUniformBlockLines(s,!0),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),s.push("vec3 octDecode(vec2 oct) {"),s.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),s.push("    if (v.z < 0.0) {"),s.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),s.push("    }"),s.push("    return normalize(v);"),s.push("}"),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec3 vViewNormal;"),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition   = viewMatrix * worldPosition; "),s.push("      vec4 worldNormal    = worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),s.push("      vec3 viewNormal     = normalize((viewNormalMatrix * worldNormal).xyz);"),i&&(s.push("      vWorldPosition  = worldPosition;"),s.push("      vFlags         = flags;")),s.push("      vViewNormal = viewNormal;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Batched geometry normals fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let n=0;n<i.getNumAllocatedSectionPlanes();n++)t.push("uniform bool sectionPlaneActive"+n+";"),t.push("uniform vec3 sectionPlanePos"+n+";"),t.push("uniform vec3 sectionPlaneDir"+n+";")}if(t.push("in vec3 vViewNormal;"),t.push("vec3 packNormalToRGB( const in vec3 normal ) {"),t.push("    return normalize( normal ) * 0.5 + 0.5;"),t.push("}"),t.push("out vec4 outColor;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("      float dist = 0.0;");for(var o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("      if (sectionPlaneActive"+o+") {"),t.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("      }");t.push("      if (dist > 0.0) { discard; }"),t.push("  }")}return e.logarithmicDepthBufferEnabled&&t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("    outColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),t.push("}"),t}}class N0 extends li{_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Batched geometry shadow vertex shader"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 color;"),s.push("in float flags;"),s.push("uniform mat4 shadowViewMatrix;"),s.push("uniform mat4 shadowProjMatrix;"),this._addMatricesUniformBlockLines(s),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vViewPosition;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),s.push("  int colorFlag = int(flags) & 0xF;"),s.push("  bool visible        = (colorFlag > 0);"),s.push("  bool transparent    = ((float(color.a) / 255.0) < 1.0);"),s.push("  if (!visible || transparent) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = shadowViewMatrix * worldPosition; "),i&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags = flags;")),s.push("      vViewPosition = viewPosition;"),s.push("      gl_Position = shadowProjMatrix * viewPosition;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const i=this._scene._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Batched geometry shadow fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let n=0;n<i.getNumAllocatedSectionPlanes();n++)t.push("uniform bool sectionPlaneActive"+n+";"),t.push("uniform vec3 sectionPlanePos"+n+";"),t.push("uniform vec3 sectionPlaneDir"+n+";")}if(t.push("in vec4 vViewPosition;"),t.push("vec4 encodeFloat( const in float v ) {"),t.push("  const vec4 bitShift = vec4(256 * 256 * 256, 256 * 256, 256, 1.0);"),t.push("  const vec4 bitMask = vec4(0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);"),t.push("  vec4 comp = fract(v * bitShift);"),t.push("  comp -= comp.xxyz * bitMask;"),t.push("  return comp;"),t.push("}"),t.push("out vec4 outColor;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("      float dist = 0.0;");for(var o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("      if (sectionPlaneActive"+o+") {"),t.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("      }");t.push("      if (dist > 0.0) { discard; }"),t.push("  }")}return t.push("    outColor = encodeFloat( gl_FragCoord.z); "),t.push("}"),t}}class nh extends li{_getHash(){const e=this._scene;return[e.gammaOutput,e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,i,s){super.drawLayer(e,i,s,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState,s=e._lightsState,t=i.getNumAllocatedSectionPlanes()>0,o=i.clippingCaps,n=[];return n.push("#version 300 es"),n.push("// Triangles batching quality draw vertex shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("precision highp usampler2D;"),n.push("precision highp isampler2D;"),n.push("precision highp sampler2D;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("precision mediump usampler2D;"),n.push("precision mediump isampler2D;"),n.push("precision mediump sampler2D;"),n.push("#endif"),n.push("uniform int renderPass;"),n.push("in vec3 position;"),n.push("in vec3 normal;"),n.push("in vec4 color;"),n.push("in vec2 uv;"),n.push("in vec2 metallicRoughness;"),n.push("in float flags;"),e.entityOffsetsEnabled&&n.push("in vec3 offset;"),this._addMatricesUniformBlockLines(n,!0),n.push("uniform mat3 uvDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),n.push("out float vFragDepth;"),n.push("bool isPerspectiveMatrix(mat4 m) {"),n.push("    return (m[2][3] == - 1.0);"),n.push("}"),n.push("out float isPerspective;")),n.push("vec3 octDecode(vec2 oct) {"),n.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),n.push("    if (v.z < 0.0) {"),n.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),n.push("    }"),n.push("    return normalize(v);"),n.push("}"),n.push("out vec4 vViewPosition;"),n.push("out vec3 vViewNormal;"),n.push("out vec4 vColor;"),n.push("out vec2 vUV;"),n.push("out vec2 vMetallicRoughness;"),s.lightMaps.length>0&&n.push("out vec3 vWorldNormal;"),t&&(n.push("out vec4 vWorldPosition;"),n.push("out float vFlags;"),o&&n.push("out vec4 vClipPosition;")),n.push("void main(void) {"),n.push("int colorFlag = int(flags) & 0xF;"),n.push("if (colorFlag != renderPass) {"),n.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),n.push("} else {"),n.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&n.push("worldPosition.xyz = worldPosition.xyz + offset;"),n.push("vec4 viewPosition  = viewMatrix * worldPosition; "),n.push("vec4 worldNormal =  worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),n.push("vec3 viewNormal = normalize((viewNormalMatrix * worldNormal).xyz);"),n.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(n.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),n.push("vFragDepth = 1.0 + clipPos.w;")),t&&(n.push("vWorldPosition = worldPosition;"),n.push("vFlags = flags;"),o&&n.push("vClipPosition = clipPos;")),n.push("vViewPosition = viewPosition;"),n.push("vViewNormal = viewNormal;"),n.push("vColor = color;"),n.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"),n.push("vMetallicRoughness = metallicRoughness;"),s.lightMaps.length>0&&n.push("vWorldNormal = worldNormal.xyz;"),n.push("gl_Position = clipPos;"),n.push("}"),n.push("}"),n}_buildFragmentShader(){const e=this._scene,i=e.gammaOutput,s=e._sectionPlanesState,t=e._lightsState,o=s.getNumAllocatedSectionPlanes()>0,n=s.clippingCaps,a=[];a.push("#version 300 es"),a.push("// Triangles batching quality draw fragment shader"),a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),e.logarithmicDepthBufferEnabled&&(a.push("in float isPerspective;"),a.push("uniform float logDepthBufFC;"),a.push("in float vFragDepth;")),a.push("uniform sampler2D uColorMap;"),a.push("uniform sampler2D uMetallicRoughMap;"),a.push("uniform sampler2D uEmissiveMap;"),a.push("uniform sampler2D uNormalMap;"),a.push("uniform sampler2D uAOMap;"),a.push("in vec4 vViewPosition;"),a.push("in vec3 vViewNormal;"),a.push("in vec4 vColor;"),a.push("in vec2 vUV;"),a.push("in vec2 vMetallicRoughness;"),t.lightMaps.length>0&&a.push("in vec3 vWorldNormal;"),this._addMatricesUniformBlockLines(a,!0),t.reflectionMaps.length>0&&a.push("uniform samplerCube reflectionMap;"),t.lightMaps.length>0&&a.push("uniform samplerCube lightMap;"),a.push("uniform vec4 lightAmbient;");for(let A=0,l=t.lights.length;A<l;A++){const h=t.lights[A];h.type!=="ambient"&&(a.push("uniform vec4 lightColor"+A+";"),h.type==="dir"&&a.push("uniform vec3 lightDir"+A+";"),h.type==="point"&&a.push("uniform vec3 lightPos"+A+";"),h.type==="spot"&&(a.push("uniform vec3 lightPos"+A+";"),a.push("uniform vec3 lightDir"+A+";")))}if(this._withSAO&&(a.push("uniform sampler2D uOcclusionTexture;"),a.push("uniform vec4      uSAOParams;"),a.push("const float       packUpscale = 256. / 255.;"),a.push("const float       unpackDownScale = 255. / 256.;"),a.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),a.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),a.push("float unpackRGBToFloat( const in vec4 v ) {"),a.push("    return dot( v, unPackFactors );"),a.push("}")),a.push("uniform float gammaFactor;"),a.push("vec4 linearToLinear( in vec4 value ) {"),a.push("  return value;"),a.push("}"),a.push("vec4 sRGBToLinear( in vec4 value ) {"),a.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),a.push("}"),a.push("vec4 gammaToLinear( in vec4 value) {"),a.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),a.push("}"),i&&(a.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),a.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),a.push("}")),o){a.push("in vec4 vWorldPosition;"),a.push("in float vFlags;"),n&&a.push("in vec4 vClipPosition;");for(let A=0,l=s.getNumAllocatedSectionPlanes();A<l;A++)a.push("uniform bool sectionPlaneActive"+A+";"),a.push("uniform vec3 sectionPlanePos"+A+";"),a.push("uniform vec3 sectionPlaneDir"+A+";")}if(a.push("#define PI 3.14159265359"),a.push("#define RECIPROCAL_PI 0.31830988618"),a.push("#define RECIPROCAL_PI2 0.15915494"),a.push("#define EPSILON 1e-6"),a.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),a.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),a.push("       vec3 texel = texture( uNormalMap, uv ).xyz;"),a.push("       if (texel.x == 0.0 && texel.y == 0.0 && texel.z == 0.0) {"),a.push("              return surf_norm;"),a.push("       }"),a.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),a.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),a.push("      vec2 st0 = dFdx( uv.st );"),a.push("      vec2 st1 = dFdy( uv.st );"),a.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),a.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),a.push("      vec3 N = normalize( surf_norm );"),a.push("      vec3 mapN = texel.xyz * 2.0 - 1.0;"),a.push("      mat3 tsn = mat3( S, T, N );"),a.push("      return normalize( tsn * mapN );"),a.push("}"),a.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),a.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),a.push("}"),a.push("struct IncidentLight {"),a.push("   vec3 color;"),a.push("   vec3 direction;"),a.push("};"),a.push("struct ReflectedLight {"),a.push("   vec3 diffuse;"),a.push("   vec3 specular;"),a.push("};"),a.push("struct Geometry {"),a.push("   vec3 position;"),a.push("   vec3 viewNormal;"),a.push("   vec3 worldNormal;"),a.push("   vec3 viewEyeDir;"),a.push("};"),a.push("struct Material {"),a.push("   vec3  diffuseColor;"),a.push("   float specularRoughness;"),a.push("   vec3  specularColor;"),a.push("   float shine;"),a.push("};"),a.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),a.push("   float r = ggxRoughness + 0.0001;"),a.push("   return (2.0 / (r * r) - 2.0);"),a.push("}"),a.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),a.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),a.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),a.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),a.push("}"),t.reflectionMaps.length>0&&(a.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),a.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),a.push("   vec3 envMapColor = sRGBToLinear(texture(reflectionMap, reflectVec, mipLevel)).rgb;"),a.push("  return envMapColor;"),a.push("}")),a.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),a.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),a.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),a.push("}"),a.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),a.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),a.push("   return 1.0 / ( gl * gv );"),a.push("}"),a.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),a.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),a.push("   return 0.5 / max( gv + gl, EPSILON );"),a.push("}"),a.push("float D_GGX(const in float alpha, const in float dotNH) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),a.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),a.push("}"),a.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),a.push("   float alpha = ( roughness * roughness );"),a.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),a.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),a.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),a.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),a.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),a.push("   vec3  F = F_Schlick( specularColor, dotLH );"),a.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),a.push("   float D = D_GGX( alpha, dotNH );"),a.push("   return F * (G * D);"),a.push("}"),a.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),a.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),a.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),a.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),a.push("   vec4 r = roughness * c0 + c1;"),a.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),a.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),a.push("   return specularColor * AB.x + AB.y;"),a.push("}"),(t.lightMaps.length>0||t.reflectionMaps.length>0)&&(a.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),t.lightMaps.length>0&&(a.push("   vec3 irradiance = sRGBToLinear(texture(lightMap, geometry.worldNormal)).rgb;"),a.push("   irradiance *= PI;"),a.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),a.push("   reflectedLight.diffuse +=  irradiance * diffuseBRDFContrib;")),t.reflectionMaps.length>0&&(a.push("   vec3 reflectVec             = reflect(geometry.viewEyeDir, geometry.viewNormal);"),a.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),a.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),a.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),a.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),a.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),a.push("}")),a.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),a.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),a.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),a.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),a.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),a.push("}"),a.push("out vec4 outColor;"),a.push("void main(void) {"),o){a.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;");for(let A=0,l=s.getNumAllocatedSectionPlanes();A<l;A++)a.push("if (sectionPlaneActive"+A+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+A+".xyz, vWorldPosition.xyz - sectionPlanePos"+A+".xyz), 0.0, 1000.0);"),a.push("}");n?(a.push("  if (dist > (0.002 * vClipPosition.w)) {"),a.push("      discard;"),a.push("  }"),a.push("  if (dist > 0.0) { "),a.push("      outColor=vec4(1.0, 0.0, 0.0, 1.0);"),e.logarithmicDepthBufferEnabled&&a.push("  gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("  return;"),a.push("}")):(a.push("  if (dist > 0.0) { "),a.push("      discard;"),a.push("  }")),a.push("}")}a.push("IncidentLight  light;"),a.push("Material       material;"),a.push("Geometry       geometry;"),a.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),a.push("vec3 rgb = (vec3(float(vColor.r) / 255.0, float(vColor.g) / 255.0, float(vColor.b) / 255.0));"),a.push("float opacity = float(vColor.a) / 255.0;"),a.push("vec3  baseColor = rgb;"),a.push("float specularF0 = 1.0;"),a.push("float metallic = float(vMetallicRoughness.r) / 255.0;"),a.push("float roughness = float(vMetallicRoughness.g) / 255.0;"),a.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),a.push("vec4 colorTexel = sRGBToLinear(texture(uColorMap, vUV));"),a.push("baseColor *= colorTexel.rgb;"),a.push("vec3 metalRoughTexel = texture(uMetallicRoughMap, vUV).rgb;"),a.push("metallic *= metalRoughTexel.b;"),a.push("roughness *= metalRoughTexel.g;"),a.push("vec3 viewNormal = perturbNormal2Arb(vViewPosition.xyz, normalize(vViewNormal), vUV );"),a.push("material.diffuseColor      = baseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),a.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),a.push("material.specularColor     = mix(vec3(dielectricSpecular), baseColor, metallic);"),a.push("geometry.position      = vViewPosition.xyz;"),a.push("geometry.viewNormal    = -normalize(viewNormal);"),a.push("geometry.viewEyeDir    = normalize(vViewPosition.xyz);"),t.lightMaps.length>0&&a.push("geometry.worldNormal   = normalize(vWorldNormal);"),(t.lightMaps.length>0||t.reflectionMaps.length>0)&&a.push("computePBRLightMapping(geometry, material, reflectedLight);");for(let A=0,l=t.lights.length;A<l;A++){const h=t.lights[A];if(h.type!=="ambient"){if(h.type==="dir")h.space==="view"?a.push("light.direction =  normalize(lightDir"+A+");"):a.push("light.direction =  normalize((viewMatrix * vec4(lightDir"+A+", 0.0)).xyz);");else if(h.type==="point")h.space==="view"?a.push("light.direction =  normalize(lightPos"+A+" - vViewPosition.xyz);"):a.push("light.direction =  normalize((viewMatrix * vec4(lightPos"+A+", 0.0)).xyz);");else if(h.type==="spot")h.space==="view"?a.push("light.direction =  normalize(lightDir"+A+");"):a.push("light.direction =  normalize((viewMatrix * vec4(lightDir"+A+", 0.0)).xyz);");else continue;a.push("light.color =  lightColor"+A+".rgb * lightColor"+A+".a;"),a.push("computePBRLighting(light, geometry, material, reflectedLight);")}}return a.push("vec3 emissiveColor = sRGBToLinear(texture(uEmissiveMap, vUV)).rgb;"),a.push("float aoFactor = texture(uAOMap, vUV).r;"),a.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * baseColor * opacity * rgb) + (reflectedLight.diffuse) + (reflectedLight.specular) + emissiveColor;"),a.push("vec4 fragColor;"),this._withSAO?(a.push("   float viewportWidth     = uSAOParams[0];"),a.push("   float viewportHeight    = uSAOParams[1];"),a.push("   float blendCutoff       = uSAOParams[2];"),a.push("   float blendFactor       = uSAOParams[3];"),a.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),a.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),a.push("   fragColor               = vec4(outgoingLight.rgb * ambient * aoFactor, opacity);")):a.push("   fragColor            = vec4(outgoingLight.rgb * aoFactor, opacity);"),i&&a.push("fragColor = linearToGamma(fragColor, gammaFactor);"),a.push("outColor = fragColor;"),e.logarithmicDepthBufferEnabled&&a.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("}"),a}}class Q0 extends li{_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Triangles batching pick flat normals vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),this._addRemapClipPosLines(s,3),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),s.push("out vec4 vWorldPosition;"),i&&s.push("out float vFlags;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("      vWorldPosition = worldPosition;"),i&&s.push("      vFlags = flags;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = remapClipPos(clipPos);"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Triangles batching pick flat normals fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),t.push("in vec4 vWorldPosition;"),s){t.push("in float vFlags;");for(var o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("out highp ivec4 outNormal;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("      float dist = 0.0;");for(let n=0;n<i.getNumAllocatedSectionPlanes();n++)t.push("      if (sectionPlaneActive"+n+") {"),t.push("          dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),t.push("      }");t.push("      if (dist > 0.0) { discard; }"),t.push("  }")}return e.logarithmicDepthBufferEnabled&&t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("  vec3 xTangent = dFdx( vWorldPosition.xyz );"),t.push("  vec3 yTangent = dFdy( vWorldPosition.xyz );"),t.push("  vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),t.push(`  outNormal = ivec4(worldNormal * float(${c.MAX_INT}), 1.0);`),t.push("}"),t}}class ah extends li{_getHash(){const e=this._scene;return[e.gammaOutput,e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,i,s){super.drawLayer(e,i,s,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=[];return t.push("#version 300 es"),t.push("// Triangles batching color texture vertex shader"),t.push("uniform int renderPass;"),t.push("in vec3 position;"),t.push("in vec4 color;"),t.push("in vec2 uv;"),t.push("in float flags;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),this._addMatricesUniformBlockLines(t),t.push("uniform mat3 uvDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("out float vFragDepth;"),t.push("bool isPerspectiveMatrix(mat4 m) {"),t.push("    return (m[2][3] == - 1.0);"),t.push("}"),t.push("out float isPerspective;")),s&&(t.push("out vec4 vWorldPosition;"),t.push("out float vFlags;")),t.push("out vec4 vViewPosition;"),t.push("out vec4 vColor;"),t.push("out vec2 vUV;"),t.push("void main(void) {"),t.push("int colorFlag = int(flags) & 0xF;"),t.push("if (colorFlag != renderPass) {"),t.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("} else {"),t.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&t.push("worldPosition.xyz = worldPosition.xyz + offset;"),t.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t.push("vViewPosition = viewPosition;"),t.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),t.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"),t.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(t.push("vFragDepth = 1.0 + clipPos.w;"),t.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s&&(t.push("vWorldPosition = worldPosition;"),t.push("vFlags = flags;")),t.push("gl_Position = clipPos;"),t.push("}"),t.push("}"),t}_buildFragmentShader(){const e=this._scene,i=e.gammaOutput,s=e._lightsState,t=e._sectionPlanesState,o=t.getNumAllocatedSectionPlanes()>0,n=[];if(n.push("#version 300 es"),n.push("// Triangles batching color texture fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),n.push("uniform sampler2D uColorMap;"),this._withSAO&&(n.push("uniform sampler2D uOcclusionTexture;"),n.push("uniform vec4      uSAOParams;"),n.push("const float       packUpscale = 256. / 255.;"),n.push("const float       unpackDownScale = 255. / 256.;"),n.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),n.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),n.push("float unpackRGBToFloat( const in vec4 v ) {"),n.push("    return dot( v, unPackFactors );"),n.push("}")),n.push("uniform float gammaFactor;"),n.push("vec4 linearToLinear( in vec4 value ) {"),n.push("  return value;"),n.push("}"),n.push("vec4 sRGBToLinear( in vec4 value ) {"),n.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),n.push("}"),n.push("vec4 gammaToLinear( in vec4 value) {"),n.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),n.push("}"),i&&(n.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),n.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),n.push("}")),o){n.push("in vec4 vWorldPosition;"),n.push("in float vFlags;");for(let a=0,A=t.getNumAllocatedSectionPlanes();a<A;a++)n.push("uniform bool sectionPlaneActive"+a+";"),n.push("uniform vec3 sectionPlanePos"+a+";"),n.push("uniform vec3 sectionPlaneDir"+a+";");n.push("uniform float sliceThickness;"),n.push("uniform vec4 sliceColor;")}this._addMatricesUniformBlockLines(n),n.push("uniform vec4 lightAmbient;");for(let a=0,A=s.lights.length;a<A;a++){const l=s.lights[a];l.type!=="ambient"&&(n.push("uniform vec4 lightColor"+a+";"),l.type==="dir"&&n.push("uniform vec3 lightDir"+a+";"),l.type==="point"&&n.push("uniform vec3 lightPos"+a+";"),l.type==="spot"&&(n.push("uniform vec3 lightPos"+a+";"),n.push("uniform vec3 lightDir"+a+";")))}if(n.push("in vec4 vViewPosition;"),n.push("in vec4 vColor;"),n.push("in vec2 vUV;"),n.push("out vec4 outColor;"),n.push("void main(void) {"),n.push("  vec4 newColor;"),n.push("  newColor = vColor;"),o){n.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;");for(let a=0,A=t.getNumAllocatedSectionPlanes();a<A;a++)n.push("if (sectionPlaneActive"+a+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > sliceThickness) { "),n.push("      discard;"),n.push("  }"),n.push("  if (dist > 0.0) { "),n.push("      newColor = sliceColor;"),n.push("  }"),n.push("}")}n.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),n.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),n.push("float lambertian = 1.0;"),n.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),n.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),n.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );");for(let a=0,A=s.lights.length;a<A;a++){const l=s.lights[a];if(l.type!=="ambient"){if(l.type==="dir")l.space==="view"?n.push("viewLightDir = normalize(lightDir"+a+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+a+", 0.0)).xyz);");else if(l.type==="point")l.space==="view"?n.push("viewLightDir = -normalize(lightPos"+a+" - viewPosition.xyz);"):n.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+a+", 0.0)).xyz);");else if(l.type==="spot")l.space==="view"?n.push("viewLightDir = normalize(lightDir"+a+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+a+", 0.0)).xyz);");else continue;n.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),n.push("reflectedColor += lambertian * (lightColor"+a+".rgb * lightColor"+a+".a);")}}return n.push("vec4 color =  vec4((lightAmbient.rgb * lightAmbient.a * newColor.rgb) + (reflectedColor * newColor.rgb), newColor.a);"),i?n.push("vec4 colorTexel = color * sRGBToLinear(texture(uColorMap, vUV));"):n.push("vec4 colorTexel = color * texture(uColorMap, vUV);"),n.push("float opacity = color.a;"),this._withSAO?(n.push("   float viewportWidth     = uSAOParams[0];"),n.push("   float viewportHeight    = uSAOParams[1];"),n.push("   float blendCutoff       = uSAOParams[2];"),n.push("   float blendFactor       = uSAOParams[3];"),n.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),n.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),n.push("   outColor                = vec4(colorTexel.rgb * ambient, opacity);")):n.push("   outColor                = vec4(colorTexel.rgb, opacity);"),i&&n.push("outColor = linearToGamma(outColor, gammaFactor);"),e.logarithmicDepthBufferEnabled&&n.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("}"),n}}const H0=c.vec3(),V0=c.vec3(),j0=c.vec3(),G0=c.vec3(),z0=c.mat4();class Ah extends zt{drawLayer(e,i,s){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const t=i.model,o=t.scene,n=o.camera,a=o.canvas.gl,A=i._state,l=i._state.origin,{position:h,rotationMatrix:d,rotationMatrixConjugate:f}=t,m=i.aabb,_=e.pickViewMatrix||n.viewMatrix;this._vaoCache.has(i)?a.bindVertexArray(this._vaoCache.get(i)):this._vaoCache.set(i,this._makeVAO(A));const u=H0;u[0]=c.safeInv(m[3]-m[0])*c.MAX_INT,u[1]=c.safeInv(m[4]-m[1])*c.MAX_INT,u[2]=c.safeInv(m[5]-m[2])*c.MAX_INT,e.snapPickCoordinateScale[0]=c.safeInv(u[0]),e.snapPickCoordinateScale[1]=c.safeInv(u[1]),e.snapPickCoordinateScale[2]=c.safeInv(u[2]);let P,y;if(l||h[0]!==0||h[1]!==0||h[2]!==0){const v=V0;if(l){const w=j0;c.transformPoint3(d,l,w),v[0]=w[0],v[1]=w[1],v[2]=w[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=h[0],v[1]+=h[1],v[2]+=h[2],P=ft(_,v,z0),y=G0,y[0]=n.eye[0]-v[0],y[1]=n.eye[1]-v[1],y[2]=n.eye[2]-v[2],e.snapPickOrigin[0]=v[0],e.snapPickOrigin[1]=v[1],e.snapPickOrigin[2]=v[2]}else P=_,y=n.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;a.uniform3fv(this._uCameraEyeRtc,y),a.uniform2fv(this.uVectorA,e.snapVectorA),a.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),a.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),a.uniform3fv(this._uCoordinateScaler,u),a.uniform1i(this._uRenderPass,s),a.uniform1i(this._uPickInvisible,e.pickInvisible);let x=0;const B=4*4;this._matricesUniformBlockBufferData.set(f,0),this._matricesUniformBlockBufferData.set(P,x+=B),this._matricesUniformBlockBufferData.set(n.projMatrix,x+=B),this._matricesUniformBlockBufferData.set(A.positionsDecodeMatrix,x+=B),a.bindBuffer(a.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),a.bufferData(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,a.DYNAMIC_DRAW),a.bindBufferBase(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const v=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,v)}this.setSectionPlanesStateUniforms(i),A.indicesBuf.bind(),a.drawElements(a.TRIANGLES,A.indicesBuf.numItems,A.indicesBuf.itemType,0),A.indicesBuf.unbind()}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// VBO SnapBatchingDepthBufInitRenderer vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),s.push("in vec4 pickColor;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),s.push("uniform vec3 uCameraEyeRtc;"),s.push("uniform vec2 snapVectorA;"),s.push("uniform vec2 snapInvVectorAB;"),s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("out float isPerspective;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("vec2 remapClipPos(vec2 clipPos) {"),s.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),s.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),s.push("    return vec2(x, y);"),s.push("}"),s.push("flat out vec4 vPickColor;"),s.push("out vec4 vWorldPosition;"),i&&s.push("out float vFlags;"),s.push("out highp vec3 relativeToOriginPosition;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      relativeToOriginPosition = worldPosition.xyz;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("      vWorldPosition = worldPosition;"),i&&s.push("      vFlags = flags;"),s.push("vPickColor = pickColor;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),s.push("float tmp = clipPos.w;"),s.push("clipPos.xyzw /= tmp;"),s.push("clipPos.xy = remapClipPos(clipPos.xy);"),s.push("clipPos.xyzw *= tmp;"),s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),s.push("gl_Position = clipPos;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const i=this._scene._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// VBO SnapBatchingDepthBufInitRenderer fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;"),t.push("uniform int layerNumber;"),t.push("uniform vec3 coordinateScaler;"),t.push("in vec4 vWorldPosition;"),t.push("flat in vec4 vPickColor;"),s){t.push("in float vFlags;");for(let n=0;n<i.getNumAllocatedSectionPlanes();n++)t.push("uniform bool sectionPlaneActive"+n+";"),t.push("uniform vec3 sectionPlanePos"+n+";"),t.push("uniform vec3 sectionPlaneDir"+n+";")}if(t.push("in highp vec3 relativeToOriginPosition;"),t.push("layout(location = 0) out highp ivec4 outCoords;"),t.push("layout(location = 1) out highp ivec4 outNormal;"),t.push("layout(location = 2) out lowp uvec4 outPickColor;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("      float dist = 0.0;");for(var o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("      if (sectionPlaneActive"+o+") {"),t.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("      }");t.push("      if (dist > 0.0) { discard; }"),t.push("  }")}return t.push("    float dx = dFdx(vFragDepth);"),t.push("    float dy = dFdy(vFragDepth);"),t.push("    float diff = sqrt(dx*dx+dy*dy);"),t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),t.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),t.push("vec3 xTangent = dFdx( vWorldPosition.xyz );"),t.push("vec3 yTangent = dFdy( vWorldPosition.xyz );"),t.push("vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),t.push(`outNormal = ivec4(worldNormal * float(${c.MAX_INT}), 1.0);`),t.push("outPickColor = uvec4(vPickColor);"),t.push("}"),t}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const K0=c.vec3(),W0=c.vec3(),X0=c.vec3(),Y0=c.vec3(),$0=c.mat4();class lh extends zt{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,i,s){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const t=i.model,o=t.scene,n=o.camera,a=o.canvas.gl,A=i._state,l=i._state.origin,{position:h,rotationMatrix:d,rotationMatrixConjugate:f}=t,m=i.aabb,_=e.pickViewMatrix||n.viewMatrix;this._vaoCache.has(i)?a.bindVertexArray(this._vaoCache.get(i)):this._vaoCache.set(i,this._makeVAO(A));const u=K0;u[0]=c.safeInv(m[3]-m[0])*c.MAX_INT,u[1]=c.safeInv(m[4]-m[1])*c.MAX_INT,u[2]=c.safeInv(m[5]-m[2])*c.MAX_INT,e.snapPickCoordinateScale[0]=c.safeInv(u[0]),e.snapPickCoordinateScale[1]=c.safeInv(u[1]),e.snapPickCoordinateScale[2]=c.safeInv(u[2]);let P,y;if(l||h[0]!==0||h[1]!==0||h[2]!==0){const v=W0;if(l){const w=X0;c.transformPoint3(d,l,w),v[0]=w[0],v[1]=w[1],v[2]=w[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=h[0],v[1]+=h[1],v[2]+=h[2],P=ft(_,v,$0),y=Y0,y[0]=n.eye[0]-v[0],y[1]=n.eye[1]-v[1],y[2]=n.eye[2]-v[2],e.snapPickOrigin[0]=v[0],e.snapPickOrigin[1]=v[1],e.snapPickOrigin[2]=v[2]}else P=_,y=n.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;a.uniform3fv(this._uCameraEyeRtc,y),a.uniform2fv(this.uVectorA,e.snapVectorA),a.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),a.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),a.uniform3fv(this._uCoordinateScaler,u),a.uniform1i(this._uRenderPass,s),a.uniform1i(this._uPickInvisible,e.pickInvisible);let x=0;const B=4*4;this._matricesUniformBlockBufferData.set(f,0),this._matricesUniformBlockBufferData.set(P,x+=B),this._matricesUniformBlockBufferData.set(n.projMatrix,x+=B),this._matricesUniformBlockBufferData.set(A.positionsDecodeMatrix,x+=B),a.bindBuffer(a.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),a.bufferData(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,a.DYNAMIC_DRAW),a.bindBufferBase(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const v=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,v)}this.setSectionPlanesStateUniforms(i),e.snapMode==="edge"?(A.edgeIndicesBuf.bind(),a.drawElements(a.LINES,A.edgeIndicesBuf.numItems,A.edgeIndicesBuf.itemType,0),A.edgeIndicesBuf.unbind()):a.drawArrays(a.POINTS,0,A.positionsBuf.numItems)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0;e.pointsMaterial._state;const s=[];return s.push("#version 300 es"),s.push("// SnapBatchingDepthRenderer vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),s.push("uniform vec3 uCameraEyeRtc;"),s.push("uniform vec2 snapVectorA;"),s.push("uniform vec2 snapInvVectorAB;"),s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;"),s.push("vec2 remapClipPos(vec2 clipPos) {"),s.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),s.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),s.push("    return vec2(x, y);"),s.push("}"),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out highp vec3 relativeToOriginPosition;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("relativeToOriginPosition = worldPosition.xyz;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),s.push("float tmp = clipPos.w;"),s.push("clipPos.xyzw /= tmp;"),s.push("clipPos.xy = remapClipPos(clipPos.xy);"),s.push("clipPos.xyzw *= tmp;"),s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),s.push("gl_Position = clipPos;"),s.push("gl_PointSize = 1.0;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const i=this._scene._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// SnapBatchingDepthRenderer fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;"),t.push("uniform int layerNumber;"),t.push("uniform vec3 coordinateScaler;"),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let n=0;n<i.getNumAllocatedSectionPlanes();n++)t.push("uniform bool sectionPlaneActive"+n+";"),t.push("uniform vec3 sectionPlanePos"+n+";"),t.push("uniform vec3 sectionPlaneDir"+n+";")}if(t.push("in highp vec3 relativeToOriginPosition;"),t.push("out highp ivec4 outCoords;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("      float dist = 0.0;");for(var o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("      if (sectionPlaneActive"+o+") {"),t.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("      }");t.push("      if (dist > 0.0) { discard; }"),t.push("  }")}return t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),t.push("}"),t}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class Z0{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._colorRendererWithSAO&&!this._colorRendererWithSAO.getValid()&&(this._colorRendererWithSAO.destroy(),this._colorRendererWithSAO=null),this._flatColorRenderer&&!this._flatColorRenderer.getValid()&&(this._flatColorRenderer.destroy(),this._flatColorRenderer=null),this._flatColorRendererWithSAO&&!this._flatColorRendererWithSAO.getValid()&&(this._flatColorRendererWithSAO.destroy(),this._flatColorRendererWithSAO=null),this._colorTextureRenderer&&!this._colorTextureRenderer.getValid()&&(this._colorTextureRenderer.destroy(),this._colorTextureRenderer=null),this._colorTextureRendererWithSAO&&!this._colorTextureRendererWithSAO.getValid()&&(this._colorTextureRendererWithSAO.destroy(),this._colorTextureRendererWithSAO=null),this._pbrRenderer&&!this._pbrRenderer.getValid()&&(this._pbrRenderer.destroy(),this._pbrRenderer=null),this._pbrRendererWithSAO&&!this._pbrRendererWithSAO.getValid()&&(this._pbrRendererWithSAO.destroy(),this._pbrRendererWithSAO=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._normalsRenderer&&!this._normalsRenderer.getValid()&&(this._normalsRenderer.destroy(),this._normalsRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._edgesRenderer&&!this._edgesRenderer.getValid()&&(this._edgesRenderer.destroy(),this._edgesRenderer=null),this._edgesColorRenderer&&!this._edgesColorRenderer.getValid()&&(this._edgesColorRenderer.destroy(),this._edgesColorRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&this._pickNormalsRenderer.getValid()===!1&&(this._pickNormalsRenderer.destroy(),this._pickNormalsRenderer=null),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.getValid()===!1&&(this._pickNormalsFlatRenderer.destroy(),this._pickNormalsFlatRenderer=null),this._occlusionRenderer&&this._occlusionRenderer.getValid()===!1&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}eagerCreateRenders(){this._silhouetteRenderer||(this._silhouetteRenderer=new sh(this._scene)),this._pickMeshRenderer||(this._pickMeshRenderer=new rh(this._scene)),this._pickDepthRenderer||(this._pickDepthRenderer=new oh(this._scene)),this._snapInitRenderer||(this._snapInitRenderer=new Ah(this._scene,!1)),this._snapRenderer||(this._snapRenderer=new lh(this._scene))}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new th(this._scene,!1)),this._colorRenderer}get colorRendererWithSAO(){return this._colorRendererWithSAO||(this._colorRendererWithSAO=new th(this._scene,!0)),this._colorRendererWithSAO}get flatColorRenderer(){return this._flatColorRenderer||(this._flatColorRenderer=new ih(this._scene,!1)),this._flatColorRenderer}get flatColorRendererWithSAO(){return this._flatColorRendererWithSAO||(this._flatColorRendererWithSAO=new ih(this._scene,!0)),this._flatColorRendererWithSAO}get colorTextureRenderer(){return this._colorTextureRenderer||(this._colorTextureRenderer=new ah(this._scene,!1)),this._colorTextureRenderer}get colorTextureRendererWithSAO(){return this._colorTextureRendererWithSAO||(this._colorTextureRendererWithSAO=new ah(this._scene,!0)),this._colorTextureRendererWithSAO}get pbrRenderer(){return this._pbrRenderer||(this._pbrRenderer=new nh(this._scene,!1)),this._pbrRenderer}get pbrRendererWithSAO(){return this._pbrRendererWithSAO||(this._pbrRendererWithSAO=new nh(this._scene,!0)),this._pbrRendererWithSAO}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new sh(this._scene)),this._silhouetteRenderer}get depthRenderer(){return this._depthRenderer||(this._depthRenderer=new O0(this._scene)),this._depthRenderer}get normalsRenderer(){return this._normalsRenderer||(this._normalsRenderer=new k0(this._scene)),this._normalsRenderer}get edgesRenderer(){return this._edgesRenderer||(this._edgesRenderer=new D0(this._scene)),this._edgesRenderer}get edgesColorRenderer(){return this._edgesColorRenderer||(this._edgesColorRenderer=new R0(this._scene)),this._edgesColorRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new rh(this._scene)),this._pickMeshRenderer}get pickNormalsRenderer(){return this._pickNormalsRenderer||(this._pickNormalsRenderer=new L0(this._scene)),this._pickNormalsRenderer}get pickNormalsFlatRenderer(){return this._pickNormalsFlatRenderer||(this._pickNormalsFlatRenderer=new Q0(this._scene)),this._pickNormalsFlatRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new oh(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new U0(this._scene)),this._occlusionRenderer}get shadowRenderer(){return this._shadowRenderer||(this._shadowRenderer=new N0(this._scene)),this._shadowRenderer}get snapRenderer(){return this._snapRenderer||(this._snapRenderer=new lh(this._scene)),this._snapRenderer}get snapInitRenderer(){return this._snapInitRenderer||(this._snapInitRenderer=new Ah(this._scene)),this._snapInitRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._colorRendererWithSAO&&this._colorRendererWithSAO.destroy(),this._flatColorRenderer&&this._flatColorRenderer.destroy(),this._flatColorRendererWithSAO&&this._flatColorRendererWithSAO.destroy(),this._colorTextureRenderer&&this._colorTextureRenderer.destroy(),this._colorTextureRendererWithSAO&&this._colorTextureRendererWithSAO.destroy(),this._pbrRenderer&&this._pbrRenderer.destroy(),this._pbrRendererWithSAO&&this._pbrRendererWithSAO.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._normalsRenderer&&this._normalsRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._edgesRenderer&&this._edgesRenderer.destroy(),this._edgesColorRenderer&&this._edgesColorRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._pickNormalsRenderer&&this._pickNormalsRenderer.destroy(),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}const Sa={};function q0(r){const e=r.id;let i=Sa[e];return i||(i=new Z0(r),Sa[e]=i,i._compile(),i.eagerCreateRenders(),r.on("compile",()=>{i._compile(),i.eagerCreateRenders()}),r.on("destroyed",()=>{delete Sa[e],i._destroy()})),i}let ch=65536,hh=5e6;class yl{constructor(){}set doublePrecisionEnabled(e){c.setDoublePrecisionEnabled(e)}get doublePrecisionEnabled(){return c.getDoublePrecisionEnabled()}set maxDataTextureHeight(e){e=Math.ceil(e/1024)*1024,e>4096?e=4096:e<1024&&(e=1024),ch=e}get maxDataTextureHeight(){return ch}set maxGeometryBatchSize(e){e<1e5?e=1e5:e>5e6&&(e=5e6),hh=e}get maxGeometryBatchSize(){return hh}}const uh=new yl;class J0{constructor(){this.maxVerts=uh.maxGeometryBatchSize,this.maxIndices=uh.maxGeometryBatchSize*3,this.positions=[],this.colors=[],this.uv=[],this.metallicRoughness=[],this.normals=[],this.pickColors=[],this.offsets=[],this.indices=[],this.edgeIndices=[]}}const ar=c.mat4(),Ar=c.mat4();function oo(r,e,i){const s=r.length,t=new Uint16Array(s),o=e[0],n=e[1],a=e[2],A=e[3]-o,l=e[4]-n,h=e[5]-a,d=65525,f=d/A,m=d/l,_=d/h,u=P=>P>=0?P:0;for(let P=0;P<s;P+=3)t[P+0]=Math.floor(u(r[P+0]-o)*f),t[P+1]=Math.floor(u(r[P+1]-n)*m),t[P+2]=Math.floor(u(r[P+2]-a)*_);return c.identityMat4(ar),c.translationMat4v(e,ar),c.identityMat4(Ar),c.scalingMat4v([A/d,l/d,h/d],Ar),c.mulMat4(ar,Ar,i),t}function Ta(r,e){const i=r[0],s=r[1],t=r[2],o=r[3]-i,n=r[4]-s,a=r[5]-t,A=65525;return c.identityMat4(ar),c.translationMat4v(r,ar),c.identityMat4(Ar),c.scalingMat4v([o/A,n/A,a/A],Ar),c.mulMat4(ar,Ar,e),e}function ev(r,e,i,s,t){function o(_,u){return _[0]*u[0]+_[1]*u[1]+_[2]*u[2]}let n,a,A,l,h,d,f=new Float32Array([0,0,0,0]),m=new Float32Array([0,0,0,0]);for(d=0;d<i;d+=3)f[0]=e[d],f[1]=e[d+1],f[2]=e[d+2],c.transformVec3(r,f,m),c.normalizeVec3(m,m),A=n=Lo(m,"floor","floor"),a=Uo(n),l=h=o(m,a),n=Lo(m,"ceil","floor"),a=Uo(n),l=o(m,a),l>h&&(A=n,h=l),n=Lo(m,"floor","ceil"),a=Uo(n),l=o(m,a),l>h&&(A=n,h=l),n=Lo(m,"ceil","ceil"),a=Uo(n),l=o(m,a),l>h&&(A=n,h=l),s[t+d+0]=A[0],s[t+d+1]=A[1],s[t+d+2]=0;return t+=i,t}function Lo(r,e,i){let s=r[0]/(Math.abs(r[0])+Math.abs(r[1])+Math.abs(r[2])),t=r[1]/(Math.abs(r[0])+Math.abs(r[1])+Math.abs(r[2]));if(r[2]<0){let o=s,n=t;o=(1-Math.abs(t))*(s>=0?1:-1),n=(1-Math.abs(s))*(t>=0?1:-1),s=o,t=n}return new Int8Array([Math[e](s*127.5+(s<0?-1:0)),Math[i](t*127.5+(t<0?-1:0))])}function Uo(r){let e=r[0],i=r[1];e/=e<0?127:128,i/=i<0?127:128;const s=1-Math.abs(e)-Math.abs(i);s<0&&(e=(1-Math.abs(i))*(e>=0?1:-1),i=(1-Math.abs(e))*(i>=0?1:-1));const t=Math.sqrt(e*e+i*i+s*s);return[e/t,i/t,s/t]}const tv=c.mat4(),iv=c.mat4(),sv=c.vec4([0,0,0,1]),rv=c.vec3(),ov=c.vec3(),nv=c.vec3(),av=c.vec3(),Av=c.vec3(),lv=c.vec3(),cv=c.vec3();class Da{constructor(e){console.info("Creating VBOBatchingTrianglesLayer"),this.model=e.model,this.sortId="TrianglesBatchingLayer"+(e.solid?"-solid":"-surface")+(e.autoNormals?"-autonormals":"-normals")+(e.textureSet&&e.textureSet.colorTexture?"-colorTexture":"")+(e.textureSet&&e.textureSet.metallicRoughnessTexture?"-metallicRoughnessTexture":""),this.layerIndex=e.layerIndex,this._renderers=q0(e.model.scene),this._buffer=new J0(e.maxGeometryBatchSize),this._scratchMemory=e.scratchMemory,this._state=new Ft({origin:c.vec3(),positionsBuf:null,offsetsBuf:null,normalsBuf:null,colorsBuf:null,uvBuf:null,metallicRoughnessBuf:null,flagsBuf:null,indicesBuf:null,edgeIndicesBuf:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,textureSet:e.textureSet,pbrSupported:!1}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=c.collapseAABB3(),this._portions=[],this._meshes=[],this._numVerts=0,this._aabb=c.collapseAABB3(),this.aabbDirty=!0,this._finalized=!1,e.positionsDecodeMatrix&&(this._state.positionsDecodeMatrix=c.mat4(e.positionsDecodeMatrix)),e.uvDecodeMatrix?(this._state.uvDecodeMatrix=c.mat3(e.uvDecodeMatrix),this._preCompressedUVsExpected=!0):this._preCompressedUVsExpected=!1,e.origin&&this._state.origin.set(e.origin),this.solid=!!e.solid}get aabb(){if(this.aabbDirty){c.collapseAABB3(this._aabb);for(let e=0,i=this._meshes.length;e<i;e++)c.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}canCreatePortion(e,i){if(this._finalized)throw"Already finalized";return this._buffer.positions.length+e<this._buffer.maxVerts*3&&this._buffer.indices.length+i<this._buffer.maxIndices}createPortion(e,i){if(this._finalized)throw"Already finalized";const s=i.positions,t=i.positionsCompressed,o=i.normals,n=i.normalsCompressed,a=i.uv,A=i.uvCompressed,l=i.colors,h=i.colorsCompressed,d=i.indices,f=i.edgeIndices,m=i.color,_=i.metallic,u=i.roughness,P=i.opacity,y=i.meshMatrix,x=i.pickColor,B=this.model.scene,v=this._buffer,w=v.positions.length/3;let C;if(c.expandAABB3(this._modelAABB,i.aabb),this._state.positionsDecodeMatrix){if(!t)throw"positionsCompressed expected";C=t.length/3;for(let D=0,K=t.length;D<K;D++)v.positions.push(t[D])}else{if(!s)throw"positions expected";C=s.length/3;for(let D=0,K=s.length;D<K;D++)v.positions.push(s[D])}if(n&&n.length>0)for(let D=0,K=n.length;D<K;D++)v.normals.push(n[D]);else if(o&&o.length>0){const D=tv;y?c.inverseMat4(c.transposeMat4(y,iv),D):c.identityMat4(D,D),ev(D,o,o.length,v.normals,v.normals.length)}if(l)for(let D=0,K=l.length;D<K;D+=3)v.colors.push(l[D]*255),v.colors.push(l[D+1]*255),v.colors.push(l[D+2]*255),v.colors.push(255);else if(h)for(let D=0,K=l.length;D<K;D+=3)v.colors.push(l[D]),v.colors.push(l[D+1]),v.colors.push(l[D+2]),v.colors.push(255);else if(m){const D=m[0],K=m[1],G=m[2],z=P;for(let le=0;le<C;le++)v.colors.push(D),v.colors.push(K),v.colors.push(G),v.colors.push(z)}const I=_??0,E=u??255;for(let D=0;D<C;D++)v.metallicRoughness.push(I),v.metallicRoughness.push(E);if(a&&a.length>0)for(let D=0,K=a.length;D<K;D++)v.uv.push(a[D]);else if(A&&A.length>0)for(let D=0,K=A.length;D<K;D++)v.uv.push(A[D]);for(let D=0,K=d.length;D<K;D++)v.indices.push(w+d[D]);if(f)for(let D=0,K=f.length;D<K;D++)v.edgeIndices.push(w+f[D]);{const D=v.pickColors.length,K=C*4;for(let G=D,z=D+K;G<z;G+=4)v.pickColors.push(x[0]),v.pickColors.push(x[1]),v.pickColors.push(x[2]),v.pickColors.push(x[3])}if(B.entityOffsetsEnabled)for(let D=0;D<C;D++)v.offsets.push(0),v.offsets.push(0),v.offsets.push(0);const S=this._portions.length,R={vertsBaseIndex:w,numVerts:C,indicesBaseIndex:v.indices.length-d.length,numIndices:d.length};return B.pickSurfacePrecisionEnabled&&(R.indices=d,B.entityOffsetsEnabled&&(R.offset=new Float32Array(3))),this._portions.push(R),this._numPortions++,this.model.numPortions++,this._numVerts+=R.numVerts,this._meshes.push(e),S}finalize(){if(this._finalized)return;const e=this._state,i=this.model.scene.canvas.gl,s=this._buffer;if(s.positions.length>0){const t=this._state.positionsDecodeMatrix?new Uint16Array(s.positions):oo(s.positions,this._modelAABB,this._state.positionsDecodeMatrix=c.mat4());if(e.positionsBuf=new Ee(i,i.ARRAY_BUFFER,t,t.length,3,i.STATIC_DRAW),this.model.scene.pickSurfacePrecisionEnabled)for(let o=0,n=this._portions.length;o<n;o++){const a=this._portions[o],A=a.vertsBaseIndex*3,l=A+a.numVerts*3;a.quantizedPositions=t.slice(A,l)}}if(s.normals.length>0){const t=new Int8Array(s.normals);let o=!0;e.normalsBuf=new Ee(i,i.ARRAY_BUFFER,t,s.normals.length,3,i.STATIC_DRAW,o)}if(s.colors.length>0){const t=new Uint8Array(s.colors);let o=!1;e.colorsBuf=new Ee(i,i.ARRAY_BUFFER,t,s.colors.length,4,i.DYNAMIC_DRAW,o)}if(s.uv.length>0)if(e.uvDecodeMatrix){let t=!1;e.uvBuf=new Ee(i,i.ARRAY_BUFFER,s.uv,s.uv.length,2,i.STATIC_DRAW,t)}else{const t=st.getUVBounds(s.uv),o=st.compressUVs(s.uv,t.min,t.max),n=o.quantized;let a=!1;e.uvDecodeMatrix=c.mat3(o.decodeMatrix),e.uvBuf=new Ee(i,i.ARRAY_BUFFER,n,n.length,2,i.STATIC_DRAW,a)}if(s.metallicRoughness.length>0){const t=new Uint8Array(s.metallicRoughness);let o=!1;e.metallicRoughnessBuf=new Ee(i,i.ARRAY_BUFFER,t,s.metallicRoughness.length,2,i.STATIC_DRAW,o)}if(s.positions.length>0){const t=s.positions.length/3,o=new Float32Array(t),n=!1;e.flagsBuf=new Ee(i,i.ARRAY_BUFFER,o,o.length,1,i.DYNAMIC_DRAW,n)}if(s.pickColors.length>0){const t=new Uint8Array(s.pickColors);let o=!1;e.pickColorsBuf=new Ee(i,i.ARRAY_BUFFER,t,s.pickColors.length,4,i.STATIC_DRAW,o)}if(this.model.scene.entityOffsetsEnabled&&s.offsets.length>0){const t=new Float32Array(s.offsets);e.offsetsBuf=new Ee(i,i.ARRAY_BUFFER,t,s.offsets.length,3,i.DYNAMIC_DRAW)}if(s.indices.length>0){const t=new Uint32Array(s.indices);e.indicesBuf=new Ee(i,i.ELEMENT_ARRAY_BUFFER,t,s.indices.length,1,i.STATIC_DRAW)}if(s.edgeIndices.length>0){const t=new Uint32Array(s.edgeIndices);e.edgeIndicesBuf=new Ee(i,i.ELEMENT_ARRAY_BUFFER,t,s.edgeIndices.length,1,i.STATIC_DRAW)}this._state.pbrSupported=!!e.metallicRoughnessBuf&&!!e.uvBuf&&!!e.normalsBuf&&!!e.textureSet&&!!e.textureSet.colorTexture&&!!e.textureSet.metallicRoughnessTexture,this._state.colorTextureSupported=!!e.uvBuf&&!!e.textureSet&&!!e.textureSet.colorTexture,this._buffer=null,this._finalized=!0}isEmpty(){return!this._state.indicesBuf}initFlags(e,i,s){i&k.VISIBLE&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),i&k.HIGHLIGHTED&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),i&k.XRAYED&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),i&k.SELECTED&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),i&k.CLIPPABLE&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),i&k.EDGES&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),i&k.PICKABLE&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),i&k.CULLED&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),s&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,i,s,!0)}flushInitFlags(){this._setDeferredFlags()}setVisible(e,i,s){if(!this._finalized)throw"Not finalized";i&k.VISIBLE?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,i,s)}setHighlighted(e,i,s){if(!this._finalized)throw"Not finalized";i&k.HIGHLIGHTED?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,i,s)}setXRayed(e,i,s){if(!this._finalized)throw"Not finalized";i&k.XRAYED?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,i,s)}setSelected(e,i,s){if(!this._finalized)throw"Not finalized";i&k.SELECTED?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,i,s)}setEdges(e,i,s){if(!this._finalized)throw"Not finalized";i&k.EDGES?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,i,s)}setClippable(e,i){if(!this._finalized)throw"Not finalized";i&k.CLIPPABLE?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,i)}setCulled(e,i,s){if(!this._finalized)throw"Not finalized";i&k.CULLED?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,i,s)}setCollidable(e,i){if(!this._finalized)throw"Not finalized"}setPickable(e,i,s){if(!this._finalized)throw"Not finalized";i&k.PICKABLE?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,i,s)}setColor(e,i){if(!this._finalized)throw"Not finalized";const s=e,t=this._portions[s],o=t.vertsBaseIndex,n=t.numVerts,a=o*4,A=n*4,l=this._scratchMemory.getUInt8Array(A),h=i[0],d=i[1],f=i[2],m=i[3];for(let _=0;_<A;_+=4)l[_+0]=h,l[_+1]=d,l[_+2]=f,l[_+3]=m;this._state.colorsBuf&&this._state.colorsBuf.setData(l,a,A)}setTransparent(e,i,s){s?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,i,s)}_setFlags(e,i,s,t=!1){if(!this._finalized)throw"Not finalized";const o=e,n=this._portions[o],a=n.vertsBaseIndex,A=n.numVerts,l=a,h=A,d=!!(i&k.VISIBLE),f=!!(i&k.XRAYED),m=!!(i&k.HIGHLIGHTED),_=!!(i&k.SELECTED),u=!!(i&k.EDGES),P=!!(i&k.PICKABLE),y=!!(i&k.CULLED);let x;!d||y||f||m&&!this.model.scene.highlightMaterial.glowThrough||_&&!this.model.scene.selectedMaterial.glowThrough?x=U.NOT_RENDERED:s?x=U.COLOR_TRANSPARENT:x=U.COLOR_OPAQUE;let B;!d||y?B=U.NOT_RENDERED:_?B=U.SILHOUETTE_SELECTED:m?B=U.SILHOUETTE_HIGHLIGHTED:f?B=U.SILHOUETTE_XRAYED:B=U.NOT_RENDERED;let v=0;!d||y?v=U.NOT_RENDERED:_?v=U.EDGES_SELECTED:m?v=U.EDGES_HIGHLIGHTED:f?v=U.EDGES_XRAYED:u?s?v=U.EDGES_COLOR_TRANSPARENT:v=U.EDGES_COLOR_OPAQUE:v=U.NOT_RENDERED;let w=d&&!y&&P?U.PICK:U.NOT_RENDERED;const C=i&k.CLIPPABLE?1:0;if(t){this._deferredFlagValues||(this._deferredFlagValues=new Float32Array(this._numVerts));for(let I=l,E=l+h;I<E;I++){let S=0;S|=x,S|=B<<4,S|=v<<8,S|=w<<12,S|=C<<16,this._deferredFlagValues[I]=S}}else if(this._state.flagsBuf){const I=this._scratchMemory.getFloat32Array(h);for(let E=0;E<h;E++){let S=0;S|=x,S|=B<<4,S|=v<<8,S|=w<<12,S|=C<<16,I[E]=S}this._state.flagsBuf.setData(I,l,h)}}_setDeferredFlags(){this._deferredFlagValues&&(this._state.flagsBuf.setData(this._deferredFlagValues),this._deferredFlagValues=null)}setOffset(e,i){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled){this.model.error("Entity#offset not enabled for this Viewer");return}const s=e,t=this._portions[s],o=t.vertsBaseIndex,n=t.numVerts,a=o*3,A=n*3,l=this._scratchMemory.getFloat32Array(A),h=i[0],d=i[1],f=i[2];for(let m=0;m<A;m+=3)l[m+0]=h,l[m+1]=d,l[m+2]=f;this._state.offsetsBuf&&this._state.offsetsBuf.setData(l,a,A),this.model.scene.pickSurfacePrecisionEnabled&&(t.offset[0]=i[0],t.offset[1]=i[1],t.offset[2]=i[2])}getEachVertex(e,i){if(!this.model.scene.pickSurfacePrecisionEnabled)return;const s=this._state,t=this._portions[e];if(!t){this.model.error("portion not found: "+e);return}const o=t.quantizedPositions,n=s.origin,a=t.offset,A=n[0]+a[0],l=n[1]+a[1],h=n[2]+a[2],d=sv;for(let f=0,m=o.length;f<m;f+=3)d[0]=o[f],d[1]=o[f+1],d[2]=o[f+2],d[3]=1,c.decompressPosition(d,s.positionsDecodeMatrix),c.transformPoint4(this.model.worldMatrix,d),d[0]+=A,d[1]+=l,d[2]+=h,i(d)}getElementsCountAndOffset(e){let i=null,s=null;const t=this._portions[e];return t&&(i=t.numIndices,s=t.indicesBaseIndex),{count:i,offset:s}}drawColorOpaque(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,i),i.withSAO&&this.model.saoEnabled?i.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._renderers.pbrRendererWithSAO&&this._renderers.pbrRendererWithSAO.drawLayer(i,this,U.COLOR_OPAQUE):i.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?this._renderers.colorTextureRendererWithSAO&&this._renderers.colorTextureRendererWithSAO.drawLayer(i,this,U.COLOR_OPAQUE):this._state.normalsBuf?this._renderers.colorRendererWithSAO&&this._renderers.colorRendererWithSAO.drawLayer(i,this,U.COLOR_OPAQUE):this._renderers.flatColorRendererWithSAO&&this._renderers.flatColorRendererWithSAO.drawLayer(i,this,U.COLOR_OPAQUE):i.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._renderers.pbrRenderer&&this._renderers.pbrRenderer.drawLayer(i,this,U.COLOR_OPAQUE):i.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?this._renderers.colorTextureRenderer&&this._renderers.colorTextureRenderer.drawLayer(i,this,U.COLOR_OPAQUE):this._state.normalsBuf?this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(i,this,U.COLOR_OPAQUE):this._renderers.flatColorRenderer&&this._renderers.flatColorRenderer.drawLayer(i,this,U.COLOR_OPAQUE))}_updateBackfaceCull(e,i){const s=this.model.backfaces||!this.solid||e.sectioned;if(i.backfaces!==s){const t=i.gl;s?t.disable(t.CULL_FACE):t.enable(t.CULL_FACE),i.backfaces=s}}drawColorTransparent(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===0||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,i),i.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._renderers.pbrRenderer&&this._renderers.pbrRenderer.drawLayer(i,this,U.COLOR_TRANSPARENT):i.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?this._renderers.colorTextureRenderer&&this._renderers.colorTextureRenderer.drawLayer(i,this,U.COLOR_TRANSPARENT):this._state.normalsBuf?this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(i,this,U.COLOR_TRANSPARENT):this._renderers.flatColorRenderer&&this._renderers.flatColorRenderer.drawLayer(i,this,U.COLOR_TRANSPARENT))}drawDepth(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,i),this._renderers.depthRenderer&&this._renderers.depthRenderer.drawLayer(i,this,U.COLOR_OPAQUE))}drawNormals(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,i),this._renderers.normalsRenderer&&this._renderers.normalsRenderer.drawLayer(i,this,U.COLOR_OPAQUE))}drawSilhouetteXRayed(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||(this._updateBackfaceCull(e,i),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(i,this,U.SILHOUETTE_XRAYED))}drawSilhouetteHighlighted(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||(this._updateBackfaceCull(e,i),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(i,this,U.SILHOUETTE_HIGHLIGHTED))}drawSilhouetteSelected(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||(this._updateBackfaceCull(e,i),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(i,this,U.SILHOUETTE_SELECTED))}drawEdgesColorOpaque(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numEdgesLayerPortions===0||this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(i,this,U.EDGES_COLOR_OPAQUE)}drawEdgesColorTransparent(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numEdgesLayerPortions===0||this._numTransparentLayerPortions===0||this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(i,this,U.EDGES_COLOR_TRANSPARENT)}drawEdgesHighlighted(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(i,this,U.EDGES_HIGHLIGHTED)}drawEdgesSelected(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(i,this,U.EDGES_SELECTED)}drawEdgesXRayed(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(i,this,U.EDGES_XRAYED)}drawOcclusion(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,i),this._renderers.occlusionRenderer&&this._renderers.occlusionRenderer.drawLayer(i,this,U.COLOR_OPAQUE))}drawShadow(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,i),this._renderers.shadowRenderer&&this._renderers.shadowRenderer.drawLayer(i,this,U.COLOR_OPAQUE))}drawPickMesh(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,i),this._renderers.pickMeshRenderer&&this._renderers.pickMeshRenderer.drawLayer(i,this,U.PICK))}drawPickDepths(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,i),this._renderers.pickDepthRenderer&&this._renderers.pickDepthRenderer.drawLayer(i,this,U.PICK))}drawPickNormals(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,i),this._renderers.pickNormalsFlatRenderer&&this._renderers.pickNormalsFlatRenderer.drawLayer(i,this,U.PICK))}drawSnapInit(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,i),this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(i,this,U.PICK))}drawSnap(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,i),this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(i,this,U.PICK))}precisionRayPickSurface(e,i,s,t,o){if(!this.model.scene.pickSurfacePrecisionEnabled)return!1;const n=this._state,a=this._portions[e];if(!a)return this.model.error("portion not found: "+e),!1;const A=a.quantizedPositions,l=a.indices,h=n.origin,d=a.offset,f=rv,m=ov;f.set(h?c.subVec3(i,h,nv):i),m.set(s),d&&c.subVec3(f,d),c.transformRay(this.model.worldNormalMatrix,f,m,f,m);const _=av,u=Av,P=lv;let y=!1,x=0;const B=cv;for(let v=0,w=l.length;v<w;v+=3){const C=l[v]*3,I=l[v+1]*3,E=l[v+2]*3;if(_[0]=A[C],_[1]=A[C+1],_[2]=A[C+2],u[0]=A[I],u[1]=A[I+1],u[2]=A[I+2],P[0]=A[E],P[1]=A[E+1],P[2]=A[E+2],c.decompressPosition(_,n.positionsDecodeMatrix),c.decompressPosition(u,n.positionsDecodeMatrix),c.decompressPosition(P,n.positionsDecodeMatrix),c.rayTriangleIntersect(f,m,_,u,P,B)){c.transformPoint3(this.model.worldMatrix,B,B),d&&c.addVec3(B,d),h&&c.addVec3(B,h);const S=Math.abs(c.lenVec3(c.subVec3(B,i,[])));(!y||S>x)&&(x=S,t.set(B),o&&c.triangleNormal(_,u,P,o),y=!0)}}return y&&o&&(c.transformVec3(this.model.worldNormalMatrix,o,o),c.normalizeVec3(o)),y}destroy(){const e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.normalsBuf&&(e.normalsBuf.destroy(),e.normalsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.metallicRoughnessBuf&&(e.metallicRoughnessBuf.destroy(),e.metallicRoughnessBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.indicesBuf&&(e.indicesBuf.destroy(),e.indicessBuf=null),e.edgeIndicesBuf&&(e.edgeIndicesBuf.destroy(),e.edgeIndicessBuf=null),e.destroy()}}class ci extends zt{constructor(e,i,{edges:s=!1}={}){super(e,i,{instancing:!0,edges:s})}_draw(e){const{gl:i}=this._scene.canvas,{state:s,frameCtx:t,incrementDrawState:o}=e;this._edges?i.drawElementsInstanced(i.LINES,s.edgeIndicesBuf.numItems,s.edgeIndicesBuf.itemType,0,s.numInstances):(i.drawElementsInstanced(i.TRIANGLES,s.indicesBuf.numItems,s.indicesBuf.itemType,0,s.numInstances),o&&t.drawElements++)}}class dh extends ci{_getHash(){const e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,i,s){super.drawLayer(e,i,s,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState,s=e._lightsState,t=i.getNumAllocatedSectionPlanes()>0;let o,n,a;const A=[];for(A.push("#version 300 es"),A.push("// Instancing geometry drawing vertex shader"),A.push("uniform int renderPass;"),A.push("in vec3 position;"),A.push("in vec2 normal;"),A.push("in vec4 color;"),A.push("in float flags;"),e.entityOffsetsEnabled&&A.push("in vec3 offset;"),A.push("in vec4 modelMatrixCol0;"),A.push("in vec4 modelMatrixCol1;"),A.push("in vec4 modelMatrixCol2;"),A.push("in vec4 modelNormalMatrixCol0;"),A.push("in vec4 modelNormalMatrixCol1;"),A.push("in vec4 modelNormalMatrixCol2;"),this._addMatricesUniformBlockLines(A,!0),e.logarithmicDepthBufferEnabled&&(A.push("uniform float logDepthBufFC;"),A.push("out float vFragDepth;"),A.push("bool isPerspectiveMatrix(mat4 m) {"),A.push("    return (m[2][3] == - 1.0);"),A.push("}"),A.push("out float isPerspective;")),A.push("uniform vec4 lightAmbient;"),o=0,n=s.lights.length;o<n;o++)a=s.lights[o],a.type!=="ambient"&&(A.push("uniform vec4 lightColor"+o+";"),a.type==="dir"&&A.push("uniform vec3 lightDir"+o+";"),a.type==="point"&&A.push("uniform vec3 lightPos"+o+";"),a.type==="spot"&&(A.push("uniform vec3 lightPos"+o+";"),A.push("uniform vec3 lightDir"+o+";")));for(A.push("vec3 octDecode(vec2 oct) {"),A.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),A.push("    if (v.z < 0.0) {"),A.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),A.push("    }"),A.push("    return normalize(v);"),A.push("}"),t&&(A.push("out vec4 vWorldPosition;"),A.push("out float vFlags;")),A.push("out vec4 vColor;"),A.push("void main(void) {"),A.push("int colorFlag = int(flags) & 0xF;"),A.push("if (colorFlag != renderPass) {"),A.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),A.push("} else {"),A.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),A.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&A.push("worldPosition.xyz = worldPosition.xyz + offset;"),A.push("vec4 viewPosition  = viewMatrix * worldPosition; "),A.push("vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),A.push("vec4 worldNormal = worldNormalMatrix * vec4(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2), 0.0);"),A.push("vec3 viewNormal = normalize(vec4(viewNormalMatrix * worldNormal).xyz);"),A.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),A.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),A.push("float lambertian = 1.0;"),o=0,n=s.lights.length;o<n;o++)if(a=s.lights[o],a.type!=="ambient"){if(a.type==="dir")a.space==="view"?A.push("viewLightDir = normalize(lightDir"+o+");"):A.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+o+", 0.0)).xyz);");else if(a.type==="point")a.space==="view"?A.push("viewLightDir = -normalize(lightPos"+o+" - viewPosition.xyz);"):A.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+o+", 0.0)).xyz);");else if(a.type==="spot")a.space==="view"?A.push("viewLightDir = normalize(lightDir"+o+");"):A.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+o+", 0.0)).xyz);");else continue;A.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),A.push("reflectedColor += lambertian * (lightColor"+o+".rgb * lightColor"+o+".a);")}return A.push("vec3 rgb = (vec3(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0));"),A.push("vColor =  vec4((lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedColor * rgb), float(color.a) / 255.0);"),A.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(A.push("vFragDepth = 1.0 + clipPos.w;"),A.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(A.push("vWorldPosition = worldPosition;"),A.push("vFlags = flags;")),A.push("gl_Position = clipPos;"),A.push("}"),A.push("}"),A}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Instancing geometry drawing fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),this._withSAO&&(t.push("uniform sampler2D uOcclusionTexture;"),t.push("uniform vec4      uSAOParams;"),t.push("const float       packUpscale = 256. / 255.;"),t.push("const float       unpackDownScale = 255. / 256.;"),t.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),t.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),t.push("float unpackRGBToFloat( const in vec4 v ) {"),t.push("    return dot( v, unPackFactors );"),t.push("}")),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";");t.push("uniform float sliceThickness;"),t.push("uniform vec4 sliceColor;")}if(t.push("in vec4 vColor;"),t.push("out vec4 outColor;"),t.push("void main(void) {"),t.push("  vec4 newColor;"),t.push("  newColor = vColor;"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("  if (dist > sliceThickness) { "),t.push("      discard;"),t.push("  }"),t.push("  if (dist > 0.0) { "),t.push("      newColor = sliceColor;"),t.push("  }"),t.push("}")}return e.logarithmicDepthBufferEnabled&&t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),this._withSAO?(t.push("   float viewportWidth     = uSAOParams[0];"),t.push("   float viewportHeight    = uSAOParams[1];"),t.push("   float blendCutoff       = uSAOParams[2];"),t.push("   float blendFactor       = uSAOParams[3];"),t.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),t.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),t.push("   outColor                = vec4(newColor.rgb * ambient, 1.0);")):t.push("    outColor           = newColor;"),t.push("}"),t}}class ph extends ci{_getHash(){const e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=[];return t.push("#version 300 es"),t.push("// Instancing geometry flat-shading drawing vertex shader"),t.push("uniform int renderPass;"),t.push("in vec3 position;"),t.push("in vec4 color;"),t.push("in float flags;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),t.push("in vec4 modelMatrixCol0;"),t.push("in vec4 modelMatrixCol1;"),t.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(t),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("out float vFragDepth;"),t.push("bool isPerspectiveMatrix(mat4 m) {"),t.push("    return (m[2][3] == - 1.0);"),t.push("}"),t.push("out float isPerspective;")),s&&(t.push("out vec4 vWorldPosition;"),t.push("out float vFlags;")),t.push("out vec4 vViewPosition;"),t.push("out vec4 vColor;"),t.push("void main(void) {"),t.push("int colorFlag = int(flags) & 0xF;"),t.push("if (colorFlag != renderPass) {"),t.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("} else {"),t.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),t.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&t.push("      worldPosition.xyz = worldPosition.xyz + offset;"),t.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t.push("vViewPosition = viewPosition;"),t.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),t.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(t.push("vFragDepth = 1.0 + clipPos.w;"),t.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s&&(t.push("vWorldPosition = worldPosition;"),t.push("vFlags = flags;")),t.push("gl_Position = clipPos;"),t.push("}"),t.push("}"),t}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=e._lightsState;let t,o;const n=i.getNumAllocatedSectionPlanes()>0,a=[];if(a.push("#version 300 es"),a.push("// Instancing geometry flat-shading drawing fragment shader"),a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),e.logarithmicDepthBufferEnabled&&(a.push("in float isPerspective;"),a.push("uniform float logDepthBufFC;"),a.push("in float vFragDepth;")),this._withSAO&&(a.push("uniform sampler2D uOcclusionTexture;"),a.push("uniform vec4      uSAOParams;"),a.push("const float       packUpscale = 256. / 255.;"),a.push("const float       unpackDownScale = 255. / 256.;"),a.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),a.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),a.push("float unpackRGBToFloat( const in vec4 v ) {"),a.push("    return dot( v, unPackFactors );"),a.push("}")),n){a.push("in vec4 vWorldPosition;"),a.push("in float vFlags;");for(let A=0,l=i.getNumAllocatedSectionPlanes();A<l;A++)a.push("uniform bool sectionPlaneActive"+A+";"),a.push("uniform vec3 sectionPlanePos"+A+";"),a.push("uniform vec3 sectionPlaneDir"+A+";");a.push("uniform float sliceThickness;"),a.push("uniform vec4 sliceColor;")}for(this._addMatricesUniformBlockLines(a),a.push("uniform vec4 lightAmbient;"),t=0,o=s.lights.length;t<o;t++){const A=s.lights[t];A.type!=="ambient"&&(a.push("uniform vec4 lightColor"+t+";"),A.type==="dir"&&a.push("uniform vec3 lightDir"+t+";"),A.type==="point"&&a.push("uniform vec3 lightPos"+t+";"),A.type==="spot"&&(a.push("uniform vec3 lightPos"+t+";"),a.push("uniform vec3 lightDir"+t+";")))}if(a.push("in vec4 vViewPosition;"),a.push("in vec4 vColor;"),a.push("out vec4 outColor;"),a.push("void main(void) {"),a.push("  vec4 newColor;"),a.push("  newColor = vColor;"),n){a.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;");for(let A=0,l=i.getNumAllocatedSectionPlanes();A<l;A++)a.push("if (sectionPlaneActive"+A+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+A+".xyz, vWorldPosition.xyz - sectionPlanePos"+A+".xyz), 0.0, 1000.0);"),a.push("}");a.push("  if (dist > sliceThickness) { "),a.push("      discard;"),a.push("  }"),a.push("  if (dist > 0.0) { "),a.push("      newColor = sliceColor;"),a.push("  }"),a.push("}")}for(a.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),a.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),a.push("float lambertian = 1.0;"),a.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),a.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),a.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );"),t=0,o=s.lights.length;t<o;t++){const A=s.lights[t];if(A.type!=="ambient"){if(A.type==="dir")A.space==="view"?a.push("viewLightDir = normalize(lightDir"+t+");"):a.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+t+", 0.0)).xyz);");else if(A.type==="point")A.space==="view"?a.push("viewLightDir = -normalize(lightPos"+t+" - viewPosition.xyz);"):a.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+t+", 0.0)).xyz);");else if(A.type==="spot")A.space==="view"?a.push("viewLightDir = normalize(lightDir"+t+");"):a.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+t+", 0.0)).xyz);");else continue;a.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),a.push("reflectedColor += lambertian * (lightColor"+t+".rgb * lightColor"+t+".a);")}}return a.push("vec4 fragColor = vec4((lightAmbient.rgb * lightAmbient.a * newColor.rgb) + (reflectedColor * newColor.rgb), newColor.a);"),this._withSAO?(a.push("   float viewportWidth     = uSAOParams[0];"),a.push("   float viewportHeight    = uSAOParams[1];"),a.push("   float blendCutoff       = uSAOParams[2];"),a.push("   float blendFactor       = uSAOParams[3];"),a.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),a.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),a.push("   outColor            = vec4(fragColor.rgb * ambient, 1.0);")):a.push("    outColor           = fragColor;"),e.logarithmicDepthBufferEnabled&&a.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("}"),a}}class fh extends ci{drawLayer(e,i,s){super.drawLayer(e,i,s,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=[];return t.push("#version 300 es"),t.push("// Instancing silhouette vertex shader"),t.push("uniform int renderPass;"),t.push("in vec3 position;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),t.push("in float flags;"),t.push("in vec4 color;"),t.push("in vec4 modelMatrixCol0;"),t.push("in vec4 modelMatrixCol1;"),t.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(t),t.push("uniform vec4 silhouetteColor;"),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("out float vFragDepth;"),t.push("bool isPerspectiveMatrix(mat4 m) {"),t.push("    return (m[2][3] == - 1.0);"),t.push("}"),t.push("out float isPerspective;")),s&&(t.push("out vec4 vWorldPosition;"),t.push("out float vFlags;")),t.push("out vec4 vColor;"),t.push("void main(void) {"),t.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),t.push("if (silhouetteFlag != renderPass) {"),t.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("} else {"),t.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),t.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&t.push("      worldPosition.xyz = worldPosition.xyz + offset;"),t.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s&&(t.push("vWorldPosition = worldPosition;"),t.push("vFlags = flags;")),t.push("vColor = vec4(silhouetteColor.r, silhouetteColor.g, silhouetteColor.b, min(silhouetteColor.a, float(color.a) / 255.0));"),t.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(t.push("vFragDepth = 1.0 + clipPos.w;"),t.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t.push("gl_Position = clipPos;"),t.push("}"),t.push("}"),t}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Instancing fill fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";");t.push("uniform float sliceThickness;"),t.push("uniform vec4 sliceColor;")}if(t.push("in vec4 vColor;"),t.push("out vec4 outColor;"),t.push("void main(void) {"),t.push("  vec4 newColor;"),t.push("  newColor = vColor;"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("  if (dist > sliceThickness) { "),t.push("      discard;"),t.push("  }"),t.push("  if (dist > 0.0) { "),t.push("      newColor = sliceColor;"),t.push("  }"),t.push("}")}return e.logarithmicDepthBufferEnabled&&t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("outColor = newColor;"),t.push("}"),t}}class Ip extends ci{constructor(e,i){super(e,i,{instancing:!0,edges:!0})}}class hv extends Ip{drawLayer(e,i,s){super.drawLayer(e,i,s,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=[];return t.push("#version 300 es"),t.push("// EdgesEmphasisRenderer vertex shader"),t.push("uniform int renderPass;"),t.push("uniform vec4 color;"),t.push("in vec3 position;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),t.push("in float flags;"),t.push("in vec4 modelMatrixCol0;"),t.push("in vec4 modelMatrixCol1;"),t.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(t),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("out float vFragDepth;"),t.push("bool isPerspectiveMatrix(mat4 m) {"),t.push("    return (m[2][3] == - 1.0);"),t.push("}"),t.push("out float isPerspective;")),s&&(t.push("out vec4 vWorldPosition;"),t.push("out float vFlags;")),t.push("out vec4 vColor;"),t.push("void main(void) {"),t.push("int edgeFlag = int(flags) >> 8 & 0xF;"),t.push("if (edgeFlag != renderPass) {"),t.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("} else {"),t.push("vec4 worldPosition = worldMatrix * positionsDecodeMatrix * vec4(position, 1.0); "),t.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&t.push("      worldPosition.xyz = worldPosition.xyz + offset;"),t.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s&&(t.push("vWorldPosition = worldPosition;"),t.push("vFlags = flags;")),t.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(t.push("vFragDepth = 1.0 + clipPos.w;"),t.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t.push("gl_Position = clipPos;"),t.push("vColor = vec4(color.r, color.g, color.b, color.a);"),t.push("}"),t.push("}"),t}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// EdgesEmphasisRenderer fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("in vec4 vColor;"),t.push("out vec4 outColor;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("  if (dist > 0.0) { discard; }"),t.push("}")}return e.logarithmicDepthBufferEnabled&&t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("outColor = vColor;"),t.push("}"),t}}class uv extends Ip{drawLayer(e,i,s){super.drawLayer(e,i,s,{colorUniform:!1})}_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=[];return t.push("#version 300 es"),t.push("// EdgesColorRenderer vertex shader"),t.push("uniform int renderPass;"),t.push("in vec3 position;"),t.push("in vec4 color;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),t.push("in float flags;"),t.push("in vec4 modelMatrixCol0;"),t.push("in vec4 modelMatrixCol1;"),t.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(t),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("out float vFragDepth;"),t.push("bool isPerspectiveMatrix(mat4 m) {"),t.push("    return (m[2][3] == - 1.0);"),t.push("}"),t.push("out float isPerspective;")),s&&(t.push("out vec4 vWorldPosition;"),t.push("out float vFlags;")),t.push("out vec4 vColor;"),t.push("void main(void) {"),t.push("int edgeFlag = int(flags) >> 8 & 0xF;"),t.push("if (edgeFlag != renderPass) {"),t.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("} else {"),t.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),t.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&t.push("      worldPosition.xyz = worldPosition.xyz + offset;"),t.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s&&(t.push("vWorldPosition = worldPosition;"),t.push("vFlags = flags;")),t.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(t.push("vFragDepth = 1.0 + clipPos.w;"),t.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t.push("gl_Position = clipPos;"),t.push("vColor = vec4(float(color.r*0.5) / 255.0, float(color.g*0.5) / 255.0, float(color.b*0.5) / 255.0, float(color.a) / 255.0);"),t.push("}"),t.push("}"),t}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// EdgesColorRenderer fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("in vec4 vColor;"),t.push("out vec4 outColor;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("  if (dist > 0.0) { discard; }"),t.push("}")}return e.logarithmicDepthBufferEnabled&&t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("outColor = vColor;"),t.push("}"),t}}class gh extends ci{_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=[];return t.push("#version 300 es"),t.push("// Instancing geometry picking vertex shader"),t.push("uniform int renderPass;"),t.push("in vec3 position;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),t.push("in float flags;"),t.push("in vec4 pickColor;"),t.push("in vec4 modelMatrixCol0;"),t.push("in vec4 modelMatrixCol1;"),t.push("in vec4 modelMatrixCol2;"),t.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(t),this._addRemapClipPosLines(t),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("out float vFragDepth;"),t.push("bool isPerspectiveMatrix(mat4 m) {"),t.push("    return (m[2][3] == - 1.0);"),t.push("}"),t.push("out float isPerspective;")),s&&(t.push("out vec4 vWorldPosition;"),t.push("out float vFlags;")),t.push("out vec4 vPickColor;"),t.push("void main(void) {"),t.push("int pickFlag = int(flags) >> 12 & 0xF;"),t.push("if (pickFlag != renderPass) {"),t.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("} else {"),t.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),t.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&t.push("      worldPosition.xyz = worldPosition.xyz + offset;"),t.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t.push("  vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),s&&(t.push("  vWorldPosition = worldPosition;"),t.push("  vFlags = flags;")),t.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(t.push("vFragDepth = 1.0 + clipPos.w;"),t.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t.push("gl_Position = remapClipPos(clipPos);"),t.push("}"),t.push("}"),t}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Batched geometry picking fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("in vec4 vPickColor;"),t.push("out vec4 outColor;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("if (dist > 0.0) { discard; }"),t.push("}")}return e.logarithmicDepthBufferEnabled&&t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("outColor = vPickColor; "),t.push("}"),t}}class mh extends ci{_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=[];return t.push("#version 300 es"),t.push("// Instancing geometry depth vertex shader"),t.push("uniform int renderPass;"),t.push("in vec3 position;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),t.push("in float flags;"),t.push("in vec4 modelMatrixCol0;"),t.push("in vec4 modelMatrixCol1;"),t.push("in vec4 modelMatrixCol2;"),t.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(t),this._addRemapClipPosLines(t),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("out float vFragDepth;"),t.push("bool isPerspectiveMatrix(mat4 m) {"),t.push("    return (m[2][3] == - 1.0);"),t.push("}"),t.push("out float isPerspective;")),s&&(t.push("out vec4 vWorldPosition;"),t.push("out float vFlags;")),t.push("out vec4 vViewPosition;"),t.push("void main(void) {"),t.push("int pickFlag = int(flags) >> 12 & 0xF;"),t.push("if (pickFlag != renderPass) {"),t.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("} else {"),t.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),t.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&t.push("      worldPosition.xyz = worldPosition.xyz + offset;"),t.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s&&(t.push("  vWorldPosition = worldPosition;"),t.push("  vFlags = flags;")),t.push("  vViewPosition = viewPosition;"),t.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(t.push("vFragDepth = 1.0 + clipPos.w;"),t.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t.push("gl_Position = remapClipPos(clipPos);"),t.push("}"),t.push("}"),t}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Batched geometry depth fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),t.push("uniform float pickZNear;"),t.push("uniform float pickZFar;"),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("in vec4 vViewPosition;"),t.push("vec4 packDepth(const in float depth) {"),t.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),t.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),t.push("  vec4 res = fract(depth * bitShift);"),t.push("  res -= res.xxyz * bitMask;"),t.push("  return res;"),t.push("}"),t.push("out vec4 outColor;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("if (dist > 0.0) { discard; }"),t.push("}")}return e.logarithmicDepthBufferEnabled&&t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),t.push("    outColor = packDepth(zNormalizedDepth); "),t.push("}"),t}}class dv extends ci{_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=[];return t.push("#version 300 es"),t.push("// Instancing geometry normals vertex shader"),t.push("uniform int renderPass;"),t.push("in vec3 position;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),t.push("in vec2 normal;"),t.push("in float flags;"),t.push("in vec4 modelMatrixCol0;"),t.push("in vec4 modelMatrixCol1;"),t.push("in vec4 modelMatrixCol2;"),t.push("in vec4 modelNormalMatrixCol0;"),t.push("in vec4 modelNormalMatrixCol1;"),t.push("in vec4 modelNormalMatrixCol2;"),t.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(t),this._addRemapClipPosLines(t,3),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("out float vFragDepth;"),t.push("bool isPerspectiveMatrix(mat4 m) {"),t.push("    return (m[2][3] == - 1.0);"),t.push("}"),t.push("out float isPerspective;")),t.push("vec3 octDecode(vec2 oct) {"),t.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),t.push("    if (v.z < 0.0) {"),t.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),t.push("    }"),t.push("    return normalize(v);"),t.push("}"),s&&(t.push("out vec4 vWorldPosition;"),t.push("out float vFlags;")),t.push("out vec3 vWorldNormal;"),t.push("void main(void) {"),t.push("int pickFlag = int(flags) >> 12 & 0xF;"),t.push("if (pickFlag != renderPass) {"),t.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("} else {"),t.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),t.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&t.push("      worldPosition.xyz = worldPosition.xyz + offset;"),t.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t.push("  vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),t.push("  vec3 worldNormal = vec3(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2));"),t.push("  vWorldNormal = worldNormal;"),s&&(t.push("  vWorldPosition = worldPosition;"),t.push("vFlags = flags;")),t.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(t.push("vFragDepth = 1.0 + clipPos.w;"),t.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t.push("gl_Position = remapClipPos(clipPos);"),t.push("}"),t.push("}"),t}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Batched geometry normals fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let n=0;n<i.getNumAllocatedSectionPlanes();n++)t.push("uniform bool sectionPlaneActive"+n+";"),t.push("uniform vec3 sectionPlanePos"+n+";"),t.push("uniform vec3 sectionPlaneDir"+n+";")}if(t.push("in vec3 vWorldNormal;"),t.push("out highp ivec4 outNormal;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(var o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("if (dist > 0.0) { discard; }"),t.push("}")}return e.logarithmicDepthBufferEnabled&&t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push(`    outNormal = ivec4(vWorldNormal * float(${c.MAX_INT}), 1.0);`),t.push("}"),t}}class pv extends ci{_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=[];return t.push("#version 300 es"),t.push("// TrianglesInstancingOcclusionRenderer vertex shader"),t.push("uniform int renderPass;"),t.push("in vec3 position;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),t.push("in vec4 color;"),t.push("in float flags;"),t.push("in vec4 modelMatrixCol0;"),t.push("in vec4 modelMatrixCol1;"),t.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(t),s&&(t.push("out vec4 vWorldPosition;"),t.push("out float vFlags;")),t.push("void main(void) {"),t.push("int colorFlag = int(flags) & 0xF;"),t.push("if (colorFlag != renderPass) {"),t.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("} else {"),t.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),t.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&t.push("      worldPosition.xyz = worldPosition.xyz + offset;"),t.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s&&(t.push("  vWorldPosition = worldPosition;"),t.push("vFlags = flags;")),t.push("vec4 clipPos = projMatrix * viewPosition;"),t.push("gl_Position = clipPos;"),t.push("}"),t.push("}"),t}_buildFragmentShader(){const i=this._scene._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// TrianglesInstancingOcclusionRenderer fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("out vec4 outColor;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("if (dist > 0.0) { discard; }"),t.push("}")}return t.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),t.push("}"),t}}class fv extends ci{_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=[];return t.push("#version 300 es"),t.push("// Instancing geometry depth drawing vertex shader"),t.push("uniform int renderPass;"),t.push("in vec3 position;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),t.push("in float flags;"),t.push("in vec4 modelMatrixCol0;"),t.push("in vec4 modelMatrixCol1;"),t.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(t),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("out float vFragDepth;"),t.push("bool isPerspectiveMatrix(mat4 m) {"),t.push("    return (m[2][3] == - 1.0);"),t.push("}"),t.push("out float isPerspective;")),s&&(t.push("out vec4 vWorldPosition;"),t.push("out float vFlags;")),t.push("out vec2 vHighPrecisionZW;"),t.push("void main(void) {"),t.push("int colorFlag = int(flags) & 0xF;"),t.push("if (colorFlag != renderPass) {"),t.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("} else {"),t.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),t.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&t.push("      worldPosition.xyz = worldPosition.xyz + offset;"),t.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s&&(t.push("vWorldPosition = worldPosition;"),t.push("vFlags = flags;")),t.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(t.push("vFragDepth = 1.0 + clipPos.w;"),t.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t.push("gl_Position = clipPos;"),t.push("vHighPrecisionZW = gl_Position.zw;"),t.push("}"),t.push("}"),t}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState;let s,t;const o=i.getNumAllocatedSectionPlanes()>0,n=[];if(n.push("#version 300 es"),n.push("// Instancing geometry depth drawing fragment shader"),n.push("precision highp float;"),n.push("precision highp int;"),e.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),o)for(n.push("in vec4 vWorldPosition;"),n.push("in float vFlags;"),s=0,t=i.getNumAllocatedSectionPlanes();s<t;s++)n.push("uniform bool sectionPlaneActive"+s+";"),n.push("uniform vec3 sectionPlanePos"+s+";"),n.push("uniform vec3 sectionPlaneDir"+s+";");if(n.push("in vec2 vHighPrecisionZW;"),n.push("out vec4 outColor;"),n.push("void main(void) {"),o){for(n.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;"),s=0,t=i.getNumAllocatedSectionPlanes();s<t;s++)n.push("if (sectionPlaneActive"+s+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),n.push("}");n.push("if (dist > 0.0) { discard; }"),n.push("}")}return e.logarithmicDepthBufferEnabled&&n.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;"),n.push("    outColor = vec4(vec3(1.0 - fragCoordZ), 1.0); "),n.push("}"),n}}class gv extends ci{_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=[];return t.push("#version 300 es"),t.push("// Instancing geometry normals drawing vertex shader"),t.push("uniform int renderPass;"),t.push("in vec3 position;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),t.push("in vec3 normal;"),t.push("in vec4 color;"),t.push("in float flags;"),t.push("in vec4 modelMatrixCol0;"),t.push("in vec4 modelMatrixCol1;"),t.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(t,!0),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("out float vFragDepth;"),t.push("bool isPerspectiveMatrix(mat4 m) {"),t.push("    return (m[2][3] == - 1.0);"),t.push("}"),t.push("out float isPerspective;")),t.push("vec3 octDecode(vec2 oct) {"),t.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),t.push("    if (v.z < 0.0) {"),t.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),t.push("    }"),t.push("    return normalize(v);"),t.push("}"),s&&(t.push("out vec4 vWorldPosition;"),t.push("out float vFlags;")),t.push("out vec3 vViewNormal;"),t.push("void main(void) {"),t.push("int colorFlag = int(flags) & 0xF;"),t.push("if (colorFlag != renderPass) {"),t.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("} else {"),t.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),t.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&t.push("      worldPosition.xyz = worldPosition.xyz + offset;"),t.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t.push("  vec4 worldNormal    = worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),t.push("  vec3 viewNormal     = normalize((viewNormalMatrix * worldNormal).xyz);"),s&&(t.push("vWorldPosition = worldPosition;"),t.push("vFlags = flags;")),t.push("  vViewNormal = viewNormal;"),t.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(t.push("vFragDepth = 1.0 + clipPos.w;"),t.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t.push("gl_Position = clipPos;"),t.push("}"),t.push("}"),t}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Instancing geometry depth drawing fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("in vec3 vViewNormal;"),t.push("vec3 packNormalToRGB( const in vec3 normal ) {"),t.push("    return normalize( normal ) * 0.5 + 0.5;"),t.push("}"),t.push("out vec4 outColor;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("if (dist > 0.0) { discard; }"),t.push("}")}return e.logarithmicDepthBufferEnabled&&t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("    outColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),t.push("}"),t}}class mv extends ci{_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=[];return t.push("#version 300 es"),t.push("// Instancing geometry shadow drawing vertex shader"),t.push("in vec3 position;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),t.push("in vec4 color;"),t.push("in float flags;"),t.push("in vec4 modelMatrixCol0;"),t.push("in vec4 modelMatrixCol1;"),t.push("in vec4 modelMatrixCol2;"),t.push("uniform mat4 shadowViewMatrix;"),t.push("uniform mat4 shadowProjMatrix;"),this._addMatricesUniformBlockLines(t),s&&(t.push("out vec4 vWorldPosition;"),t.push("out float vFlags;")),t.push("void main(void) {"),t.push("int colorFlag = int(flags) & 0xF;"),t.push("bool visible = (colorFlag > 0);"),t.push("bool transparent  = ((float(color.a) / 255.0) < 1.0);"),t.push("if (!visible || transparent) {"),t.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("} else {"),t.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),t.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&t.push("      worldPosition.xyz = worldPosition.xyz + offset;"),t.push("  vec4 viewPosition  = shadowViewMatrix * worldPosition; "),s&&(t.push("vWorldPosition = worldPosition;"),t.push("vFlags = flags;")),t.push("  gl_Position = shadowProjMatrix * viewPosition;"),t.push("}"),t.push("}"),t}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Instancing geometry depth drawing fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("in vec3 vViewNormal;"),t.push("vec3 packNormalToRGB( const in vec3 normal ) {"),t.push("    return normalize( normal ) * 0.5 + 0.5;"),t.push("}"),t.push("out vec4 outColor;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("if (dist > 0.0) { discard; }"),t.push("}")}return e.logarithmicDepthBufferEnabled&&t.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("    outColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),t.push("}"),t}}const Mn={};Mn[nr]="linearToLinear";Mn[Ct]="sRGBToLinear";class _h extends ci{_getHash(){const e=this._scene;return[e.gammaOutput,e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,i,s){super.drawLayer(e,i,s,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState,s=e._lightsState,t=i.getNumAllocatedSectionPlanes()>0,o=i.clippingCaps,n=[];return n.push("#version 300 es"),n.push("// Instancing geometry quality drawing vertex shader"),n.push("uniform int renderPass;"),n.push("in vec3 position;"),n.push("in vec3 normal;"),n.push("in vec4 color;"),n.push("in vec2 uv;"),n.push("in vec2 metallicRoughness;"),n.push("in float flags;"),e.entityOffsetsEnabled&&n.push("in vec3 offset;"),n.push("in vec4 modelMatrixCol0;"),n.push("in vec4 modelMatrixCol1;"),n.push("in vec4 modelMatrixCol2;"),n.push("in vec4 modelNormalMatrixCol0;"),n.push("in vec4 modelNormalMatrixCol1;"),n.push("in vec4 modelNormalMatrixCol2;"),this._addMatricesUniformBlockLines(n,!0),n.push("uniform mat3 uvDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),n.push("out float vFragDepth;"),n.push("bool isPerspectiveMatrix(mat4 m) {"),n.push("    return (m[2][3] == - 1.0);"),n.push("}"),n.push("out float isPerspective;")),n.push("vec3 octDecode(vec2 oct) {"),n.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),n.push("    if (v.z < 0.0) {"),n.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),n.push("    }"),n.push("    return normalize(v);"),n.push("}"),n.push("out vec4 vViewPosition;"),n.push("out vec3 vViewNormal;"),n.push("out vec4 vColor;"),n.push("out vec2 vUV;"),n.push("out vec2 vMetallicRoughness;"),s.lightMaps.length>0&&n.push("out vec3 vWorldNormal;"),t&&(n.push("out vec4 vWorldPosition;"),n.push("out float vFlags;"),o&&n.push("out vec4 vClipPosition;")),n.push("void main(void) {"),n.push("int colorFlag = int(flags) & 0xF;"),n.push("if (colorFlag != renderPass) {"),n.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),n.push("} else {"),n.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),n.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&n.push("      worldPosition.xyz = worldPosition.xyz + offset;"),n.push("vec4 viewPosition  = viewMatrix * worldPosition; "),n.push("vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),n.push("vec4 worldNormal = worldNormalMatrix * vec4(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2), 1.0);"),n.push("vec3 viewNormal = vec4(viewNormalMatrix * worldNormal).xyz;"),n.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(n.push("vFragDepth = 1.0 + clipPos.w;"),n.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(n.push("vWorldPosition = worldPosition;"),n.push("vFlags = flags;"),o&&n.push("vClipPosition = clipPos;")),n.push("vViewPosition = viewPosition;"),n.push("vViewNormal = viewNormal;"),n.push("vColor = color;"),n.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"),n.push("vMetallicRoughness = metallicRoughness;"),s.lightMaps.length>0&&n.push("vWorldNormal = worldNormal.xyz;"),n.push("gl_Position = clipPos;"),n.push("}"),n.push("}"),n}_buildFragmentShader(){const e=this._scene,i=e.gammaOutput,s=e._sectionPlanesState,t=e._lightsState,o=s.getNumAllocatedSectionPlanes()>0,n=s.clippingCaps,a=[];a.push("#version 300 es"),a.push("// Instancing geometry quality drawing fragment shader"),a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),e.logarithmicDepthBufferEnabled&&(a.push("in float isPerspective;"),a.push("uniform float logDepthBufFC;"),a.push("in float vFragDepth;")),a.push("uniform sampler2D uColorMap;"),a.push("uniform sampler2D uMetallicRoughMap;"),a.push("uniform sampler2D uEmissiveMap;"),a.push("uniform sampler2D uNormalMap;"),this._withSAO&&(a.push("uniform sampler2D uOcclusionTexture;"),a.push("uniform vec4      uSAOParams;"),a.push("const float       packUpscale = 256. / 255.;"),a.push("const float       unpackDownScale = 255. / 256.;"),a.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),a.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),a.push("float unpackRGBToFloat( const in vec4 v ) {"),a.push("    return dot( v, unPackFactors );"),a.push("}")),t.reflectionMaps.length>0&&a.push("uniform samplerCube reflectionMap;"),t.lightMaps.length>0&&a.push("uniform samplerCube lightMap;"),a.push("uniform vec4 lightAmbient;");for(let A=0,l=t.lights.length;A<l;A++){const h=t.lights[A];h.type!=="ambient"&&(a.push("uniform vec4 lightColor"+A+";"),h.type==="dir"&&a.push("uniform vec3 lightDir"+A+";"),h.type==="point"&&a.push("uniform vec3 lightPos"+A+";"),h.type==="spot"&&(a.push("uniform vec3 lightPos"+A+";"),a.push("uniform vec3 lightDir"+A+";")))}if(a.push("uniform float gammaFactor;"),a.push("vec4 linearToLinear( in vec4 value ) {"),a.push("  return value;"),a.push("}"),a.push("vec4 sRGBToLinear( in vec4 value ) {"),a.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),a.push("}"),a.push("vec4 gammaToLinear( in vec4 value) {"),a.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),a.push("}"),i&&(a.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),a.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),a.push("}")),o){a.push("in vec4 vWorldPosition;"),a.push("in float vFlags;"),n&&a.push("in vec4 vClipPosition;");for(let A=0,l=s.getNumAllocatedSectionPlanes();A<l;A++)a.push("uniform bool sectionPlaneActive"+A+";"),a.push("uniform vec3 sectionPlanePos"+A+";"),a.push("uniform vec3 sectionPlaneDir"+A+";")}if(a.push("in vec4 vViewPosition;"),a.push("in vec3 vViewNormal;"),a.push("in vec4 vColor;"),a.push("in vec2 vUV;"),a.push("in vec2 vMetallicRoughness;"),t.lightMaps.length>0&&a.push("in vec3 vWorldNormal;"),this._addMatricesUniformBlockLines(a,!0),a.push("#define PI 3.14159265359"),a.push("#define RECIPROCAL_PI 0.31830988618"),a.push("#define RECIPROCAL_PI2 0.15915494"),a.push("#define EPSILON 1e-6"),a.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),a.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),a.push("       vec3 texel = texture( uNormalMap, uv ).xyz;"),a.push("       if (texel.r == 0.0 && texel.g == 0.0 && texel.b == 0.0) {"),a.push("              return normalize(surf_norm );"),a.push("       }"),a.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),a.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),a.push("      vec2 st0 = dFdx( uv.st );"),a.push("      vec2 st1 = dFdy( uv.st );"),a.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),a.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),a.push("      vec3 N = normalize( surf_norm );"),a.push("      vec3 mapN = texel.xyz * 2.0 - 1.0;"),a.push("      mat3 tsn = mat3( S, T, N );"),a.push("      return normalize( tsn * mapN );"),a.push("}"),a.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),a.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),a.push("}"),a.push("struct IncidentLight {"),a.push("   vec3 color;"),a.push("   vec3 direction;"),a.push("};"),a.push("struct ReflectedLight {"),a.push("   vec3 diffuse;"),a.push("   vec3 specular;"),a.push("};"),a.push("struct Geometry {"),a.push("   vec3 position;"),a.push("   vec3 viewNormal;"),a.push("   vec3 worldNormal;"),a.push("   vec3 viewEyeDir;"),a.push("};"),a.push("struct Material {"),a.push("   vec3    diffuseColor;"),a.push("   float   specularRoughness;"),a.push("   vec3    specularColor;"),a.push("   float   shine;"),a.push("};"),a.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),a.push("   float r = ggxRoughness + 0.0001;"),a.push("   return (2.0 / (r * r) - 2.0);"),a.push("}"),a.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),a.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),a.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),a.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),a.push("}"),t.reflectionMaps.length>0&&(a.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),a.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),a.push("   vec3 envMapColor = "+Mn[t.reflectionMaps[0].encoding]+"(texture(reflectionMap, reflectVec, mipLevel)).rgb;"),a.push("  return envMapColor;"),a.push("}")),a.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),a.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),a.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),a.push("}"),a.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),a.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),a.push("   return 1.0 / ( gl * gv );"),a.push("}"),a.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),a.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),a.push("   return 0.5 / max( gv + gl, EPSILON );"),a.push("}"),a.push("float D_GGX(const in float alpha, const in float dotNH) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),a.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),a.push("}"),a.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),a.push("   float alpha = ( roughness * roughness );"),a.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),a.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),a.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),a.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),a.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),a.push("   vec3  F = F_Schlick( specularColor, dotLH );"),a.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),a.push("   float D = D_GGX( alpha, dotNH );"),a.push("   return F * (G * D);"),a.push("}"),a.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),a.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),a.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),a.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),a.push("   vec4 r = roughness * c0 + c1;"),a.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),a.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),a.push("   return specularColor * AB.x + AB.y;"),a.push("}"),(t.lightMaps.length>0||t.reflectionMaps.length>0)&&(a.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),t.lightMaps.length>0&&(a.push("   vec3 irradiance = "+Mn[t.lightMaps[0].encoding]+"(texture(lightMap, geometry.worldNormal)).rgb;"),a.push("   irradiance *= PI;"),a.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),a.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),t.reflectionMaps.length>0&&(a.push("   vec3 reflectVec             = reflect(geometry.viewEyeDir, geometry.viewNormal);"),a.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),a.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),a.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),a.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),a.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),a.push("}")),a.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),a.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),a.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),a.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),a.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),a.push("}"),a.push("out vec4 outColor;"),a.push("void main(void) {"),o){a.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;");for(let A=0,l=s.getNumAllocatedSectionPlanes();A<l;A++)a.push("if (sectionPlaneActive"+A+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+A+".xyz, vWorldPosition.xyz - sectionPlanePos"+A+".xyz), 0.0, 1000.0);"),a.push("}");n?(a.push("  if (dist > (0.002 * vClipPosition.w)) {"),a.push("      discard;"),a.push("  }"),a.push("  if (dist > 0.0) { "),a.push("      outColor=vec4(1.0, 0.0, 0.0, 1.0);"),e.logarithmicDepthBufferEnabled&&a.push("  gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("  return;"),a.push("}")):(a.push("  if (dist > 0.0) { "),a.push("      discard;"),a.push("  }")),a.push("}")}a.push("IncidentLight  light;"),a.push("Material       material;"),a.push("Geometry       geometry;"),a.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),a.push("vec3 rgb = (vec3(float(vColor.r) / 255.0, float(vColor.g) / 255.0, float(vColor.b) / 255.0));"),a.push("float opacity = float(vColor.a) / 255.0;"),a.push("vec3  baseColor = rgb;"),a.push("float specularF0 = 1.0;"),a.push("float metallic = float(vMetallicRoughness.r) / 255.0;"),a.push("float roughness = float(vMetallicRoughness.g) / 255.0;"),a.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),a.push("vec4 colorTexel = sRGBToLinear(texture(uColorMap, vUV));"),a.push("baseColor *= colorTexel.rgb;"),a.push("vec3 metalRoughTexel = texture(uMetallicRoughMap, vUV).rgb;"),a.push("metallic *= metalRoughTexel.b;"),a.push("roughness *= metalRoughTexel.g;"),a.push("vec3 viewNormal = perturbNormal2Arb( vViewPosition.xyz, normalize(vViewNormal), vUV );"),a.push("material.diffuseColor      = baseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),a.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),a.push("material.specularColor     = mix(vec3(dielectricSpecular), baseColor, metallic);"),a.push("geometry.position      = vViewPosition.xyz;"),a.push("geometry.viewNormal    = -normalize(viewNormal);"),a.push("geometry.viewEyeDir    = normalize(vViewPosition.xyz);"),t.lightMaps.length>0&&a.push("geometry.worldNormal   = normalize(vWorldNormal);"),(t.lightMaps.length>0||t.reflectionMaps.length>0)&&a.push("computePBRLightMapping(geometry, material, reflectedLight);");for(let A=0,l=t.lights.length;A<l;A++){const h=t.lights[A];if(h.type!=="ambient"){if(h.type==="dir")h.space==="view"?a.push("light.direction = normalize(lightDir"+A+");"):a.push("light.direction = normalize((viewMatrix * vec4(lightDir"+A+", 0.0)).xyz);");else if(h.type==="point")h.space==="view"?a.push("light.direction = normalize(lightPos"+A+" - vViewPosition.xyz);"):a.push("light.direction = normalize((viewMatrix * vec4(lightPos"+A+", 0.0)).xyz);");else if(h.type==="spot")h.space==="view"?a.push("light.direction = normalize(lightDir"+A+");"):a.push("light.direction = normalize((viewMatrix * vec4(lightDir"+A+", 0.0)).xyz);");else continue;a.push("light.color =  lightColor"+A+".rgb * lightColor"+A+".a;"),a.push("computePBRLighting(light, geometry, material, reflectedLight);")}}return a.push("vec3 emissiveColor = sRGBToLinear(texture(uEmissiveMap, vUV)).rgb;"),a.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * baseColor * opacity * rgb) + (reflectedLight.diffuse) + (reflectedLight.specular) + emissiveColor;"),a.push("vec4 fragColor;"),this._withSAO?(a.push("   float viewportWidth     = uSAOParams[0];"),a.push("   float viewportHeight    = uSAOParams[1];"),a.push("   float blendCutoff       = uSAOParams[2];"),a.push("   float blendFactor       = uSAOParams[3];"),a.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),a.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),a.push("   fragColor            = vec4(outgoingLight.rgb * ambient, opacity);")):a.push("   fragColor            = vec4(outgoingLight.rgb, opacity);"),i&&a.push("fragColor = linearToGamma(fragColor, gammaFactor);"),a.push("outColor = fragColor;"),e.logarithmicDepthBufferEnabled&&a.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("}"),a}}class _v extends ci{_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=[];return t.push("#version 300 es"),t.push("// Instancing geometry normals vertex shader"),t.push("uniform int renderPass;"),t.push("in vec3 position;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),t.push("in float flags;"),t.push("in vec4 modelMatrixCol0;"),t.push("in vec4 modelMatrixCol1;"),t.push("in vec4 modelMatrixCol2;"),t.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(t),this._addRemapClipPosLines(t,3),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("out float vFragDepth;"),t.push("bool isPerspectiveMatrix(mat4 m) {"),t.push("    return (m[2][3] == - 1.0);"),t.push("}"),t.push("out float isPerspective;")),s&&t.push("out float vFlags;"),t.push("out vec4 vWorldPosition;"),t.push("void main(void) {"),t.push("int pickFlag = int(flags) >> 12 & 0xF;"),t.push("if (pickFlag != renderPass) {"),t.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("} else {"),t.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),t.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&t.push("      worldPosition.xyz = worldPosition.xyz + offset;"),t.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t.push("  vWorldPosition = worldPosition;"),t.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(t.push("vFragDepth = 1.0 + clipPos.w;"),t.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s&&t.push("vFlags = flags;"),t.push("gl_Position = remapClipPos(clipPos);"),t.push("}"),t.push("}"),t}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Batched geometry normals fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),t.push("in vec4 vWorldPosition;"),s){t.push("in float vFlags;");for(let n=0;n<i.getNumAllocatedSectionPlanes();n++)t.push("uniform bool sectionPlaneActive"+n+";"),t.push("uniform vec3 sectionPlanePos"+n+";"),t.push("uniform vec3 sectionPlaneDir"+n+";")}if(t.push("out highp ivec4 outNormal;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(var o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("if (dist > 0.0) { discard; }"),t.push("}")}return e.logarithmicDepthBufferEnabled&&t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("  vec3 xTangent = dFdx( vWorldPosition.xyz );"),t.push("  vec3 yTangent = dFdy( vWorldPosition.xyz );"),t.push("  vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),t.push(`  outNormal = ivec4(worldNormal * float(${c.MAX_INT}), 1.0);`),t.push("}"),t}}class vh extends ci{_getHash(){const e=this._scene;return[e.gammaOutput,e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,i,s){super.drawLayer(e,i,s,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=[];return t.push("#version 300 es"),t.push("// Instancing geometry drawing vertex shader"),t.push("uniform int renderPass;"),t.push("in vec3 position;"),t.push("in vec4 color;"),t.push("in vec2 uv;"),t.push("in float flags;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),t.push("in vec4 modelMatrixCol0;"),t.push("in vec4 modelMatrixCol1;"),t.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(t),t.push("uniform mat3 uvDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("out float vFragDepth;"),t.push("bool isPerspectiveMatrix(mat4 m) {"),t.push("    return (m[2][3] == - 1.0);"),t.push("}"),t.push("out float isPerspective;")),s&&(t.push("out vec4 vWorldPosition;"),t.push("out float vFlags;")),t.push("out vec4 vViewPosition;"),t.push("out vec4 vColor;"),t.push("out vec2 vUV;"),t.push("void main(void) {"),t.push("int colorFlag = int(flags) & 0xF;"),t.push("if (colorFlag != renderPass) {"),t.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("} else {"),t.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),t.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&t.push("      worldPosition.xyz = worldPosition.xyz + offset;"),t.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t.push("vViewPosition = viewPosition;"),t.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),t.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"),t.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(t.push("vFragDepth = 1.0 + clipPos.w;"),t.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s&&(t.push("vWorldPosition = worldPosition;"),t.push("vFlags = flags;")),t.push("gl_Position = clipPos;"),t.push("}"),t.push("}"),t}_buildFragmentShader(){const e=this._scene,i=e.gammaOutput,s=e._sectionPlanesState,t=e._lightsState;let o,n;const a=s.getNumAllocatedSectionPlanes()>0,A=[];if(A.push("#version 300 es"),A.push("// Instancing geometry drawing fragment shader"),A.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),A.push("precision highp float;"),A.push("precision highp int;"),A.push("#else"),A.push("precision mediump float;"),A.push("precision mediump int;"),A.push("#endif"),e.logarithmicDepthBufferEnabled&&(A.push("in float isPerspective;"),A.push("uniform float logDepthBufFC;"),A.push("in float vFragDepth;")),A.push("uniform sampler2D uColorMap;"),this._withSAO&&(A.push("uniform sampler2D uOcclusionTexture;"),A.push("uniform vec4      uSAOParams;"),A.push("const float       packUpscale = 256. / 255.;"),A.push("const float       unpackDownScale = 255. / 256.;"),A.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),A.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),A.push("float unpackRGBToFloat( const in vec4 v ) {"),A.push("    return dot( v, unPackFactors );"),A.push("}")),A.push("uniform float gammaFactor;"),A.push("vec4 linearToLinear( in vec4 value ) {"),A.push("  return value;"),A.push("}"),A.push("vec4 sRGBToLinear( in vec4 value ) {"),A.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),A.push("}"),A.push("vec4 gammaToLinear( in vec4 value) {"),A.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),A.push("}"),i&&(A.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),A.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),A.push("}")),a){A.push("in vec4 vWorldPosition;"),A.push("in float vFlags;");for(let l=0,h=s.getNumAllocatedSectionPlanes();l<h;l++)A.push("uniform bool sectionPlaneActive"+l+";"),A.push("uniform vec3 sectionPlanePos"+l+";"),A.push("uniform vec3 sectionPlaneDir"+l+";");A.push("uniform float sliceThickness;"),A.push("uniform vec4 sliceColor;")}for(this._addMatricesUniformBlockLines(A),A.push("uniform vec4 lightAmbient;"),o=0,n=t.lights.length;o<n;o++){const l=t.lights[o];l.type!=="ambient"&&(A.push("uniform vec4 lightColor"+o+";"),l.type==="dir"&&A.push("uniform vec3 lightDir"+o+";"),l.type==="point"&&A.push("uniform vec3 lightPos"+o+";"),l.type==="spot"&&(A.push("uniform vec3 lightPos"+o+";"),A.push("uniform vec3 lightDir"+o+";")))}if(A.push("in vec4 vViewPosition;"),A.push("in vec4 vColor;"),A.push("in vec2 vUV;"),A.push("out vec4 outColor;"),A.push("void main(void) {"),A.push("  vec4 newColor;"),A.push("  newColor = vColor;"),a){A.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),A.push("  if (clippable) {"),A.push("  float dist = 0.0;");for(let l=0,h=s.getNumAllocatedSectionPlanes();l<h;l++)A.push("if (sectionPlaneActive"+l+") {"),A.push("   dist += clamp(dot(-sectionPlaneDir"+l+".xyz, vWorldPosition.xyz - sectionPlanePos"+l+".xyz), 0.0, 1000.0);"),A.push("}");A.push("  if (dist > sliceThickness) { "),A.push("      discard;"),A.push("  }"),A.push("  if (dist > 0.0) { "),A.push("      newColor = sliceColor;"),A.push("  }"),A.push("}")}for(A.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),A.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),A.push("float lambertian = 1.0;"),A.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),A.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),A.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );"),o=0,n=t.lights.length;o<n;o++){const l=t.lights[o];if(l.type!=="ambient"){if(l.type==="dir")l.space==="view"?A.push("viewLightDir = normalize(lightDir"+o+");"):A.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+o+", 0.0)).xyz);");else if(l.type==="point")l.space==="view"?A.push("viewLightDir = -normalize(lightPos"+o+" - viewPosition.xyz);"):A.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+o+", 0.0)).xyz);");else if(l.type==="spot")l.space==="view"?A.push("viewLightDir = normalize(lightDir"+o+");"):A.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+o+", 0.0)).xyz);");else continue;A.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),A.push("reflectedColor += lambertian * (lightColor"+o+".rgb * lightColor"+o+".a);")}}return A.push("vec4 color =  vec4((lightAmbient.rgb * lightAmbient.a * newColor.rgb) + (reflectedColor * newColor.rgb), newColor.a);"),i?A.push("vec4 colorTexel = color * sRGBToLinear(texture(uColorMap, vUV));"):A.push("vec4 colorTexel = color * texture(uColorMap, vUV);"),A.push("float opacity = color.a;"),this._withSAO?(A.push("   float viewportWidth     = uSAOParams[0];"),A.push("   float viewportHeight    = uSAOParams[1];"),A.push("   float blendCutoff       = uSAOParams[2];"),A.push("   float blendFactor       = uSAOParams[3];"),A.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),A.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),A.push("   outColor                = vec4(newColor.rgb * colorTexel.rgb * ambient, opacity);")):A.push("   outColor                = vec4(newColor.rgb * colorTexel.rgb, opacity);"),i&&A.push("outColor = linearToGamma(outColor, gammaFactor);"),e.logarithmicDepthBufferEnabled&&A.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),A.push("}"),A}}const vv=c.vec3(),Pv=c.vec3(),Bv=c.vec3(),yv=c.vec3(),xv=c.mat4();class Ph extends zt{constructor(e){super(e,!1,{instancing:!0})}drawLayer(e,i,s){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const t=i.model,o=t.scene,n=o.canvas.gl,a=o.camera,A=i._state,l=i._state.origin,{position:h,rotationMatrix:d,rotationMatrixConjugate:f}=t,m=i.aabb,_=e.pickViewMatrix||a.viewMatrix;this._vaoCache.has(i)?n.bindVertexArray(this._vaoCache.get(i)):this._vaoCache.set(i,this._makeVAO(A));const u=vv;u[0]=c.safeInv(m[3]-m[0])*c.MAX_INT,u[1]=c.safeInv(m[4]-m[1])*c.MAX_INT,u[2]=c.safeInv(m[5]-m[2])*c.MAX_INT,e.snapPickCoordinateScale[0]=c.safeInv(u[0]),e.snapPickCoordinateScale[1]=c.safeInv(u[1]),e.snapPickCoordinateScale[2]=c.safeInv(u[2]);let P,y;if(l||h[0]!==0||h[1]!==0||h[2]!==0){const v=Pv;if(l){const w=c.transformPoint3(d,l,Bv);v[0]=w[0],v[1]=w[1],v[2]=w[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=h[0],v[1]+=h[1],v[2]+=h[2],P=ft(_,v,xv),y=yv,y[0]=a.eye[0]-v[0],y[1]=a.eye[1]-v[1],y[2]=a.eye[2]-v[2],e.snapPickOrigin[0]=v[0],e.snapPickOrigin[1]=v[1],e.snapPickOrigin[2]=v[2]}else P=_,y=a.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;n.uniform3fv(this._uCameraEyeRtc,y),n.uniform2fv(this.uVectorA,e.snapVectorA),n.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),n.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),n.uniform3fv(this._uCoordinateScaler,u),n.uniform1i(this._uRenderPass,s),n.uniform1i(this._uPickInvisible,e.pickInvisible);let x=0;const B=4*4;this._matricesUniformBlockBufferData.set(f,0),this._matricesUniformBlockBufferData.set(P,x+=B),this._matricesUniformBlockBufferData.set(a.projMatrix,x+=B),this._matricesUniformBlockBufferData.set(A.positionsDecodeMatrix,x+=B),n.bindBuffer(n.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),n.bufferData(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,n.DYNAMIC_DRAW),n.bindBufferBase(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const v=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,v)}this.setSectionPlanesStateUniforms(i),this._aModelMatrixCol0.bindArrayBuffer(A.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(A.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(A.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aFlags&&(this._aFlags.bindArrayBuffer(A.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1)),A.indicesBuf.bind(),n.drawElementsInstanced(n.TRIANGLES,A.indicesBuf.numItems,A.indicesBuf.itemType,0,A.numInstances),A.indicesBuf.unbind(),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),this._aFlags&&n.vertexAttribDivisor(this._aFlags.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=[];return t.push("#version 300 es"),t.push("// SnapInstancingDepthBufInitRenderer vertex shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("precision highp usampler2D;"),t.push("precision highp isampler2D;"),t.push("precision highp sampler2D;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("precision mediump usampler2D;"),t.push("precision mediump isampler2D;"),t.push("precision mediump sampler2D;"),t.push("#endif"),t.push("uniform int renderPass;"),t.push("in vec4 pickColor;"),t.push("in vec3 position;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),t.push("in float flags;"),t.push("in vec4 modelMatrixCol0;"),t.push("in vec4 modelMatrixCol1;"),t.push("in vec4 modelMatrixCol2;"),t.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(t),t.push("uniform vec3 uCameraEyeRtc;"),t.push("uniform vec2 snapVectorA;"),t.push("uniform vec2 snapInvVectorAB;"),t.push("uniform float logDepthBufFC;"),t.push("out float vFragDepth;"),t.push("bool isPerspectiveMatrix(mat4 m) {"),t.push("    return (m[2][3] == - 1.0);"),t.push("}"),t.push("out float isPerspective;"),t.push("vec2 remapClipPos(vec2 clipPos) {"),t.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),t.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),t.push("    return vec2(x, y);"),t.push("}"),t.push("flat out vec4 vPickColor;"),t.push("out vec4 vWorldPosition;"),s&&t.push("out float vFlags;"),t.push("out highp vec3 relativeToOriginPosition;"),t.push("void main(void) {"),t.push("int pickFlag = int(flags) >> 12 & 0xF;"),t.push("if (pickFlag != renderPass) {"),t.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("} else {"),t.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),t.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&t.push("      worldPosition.xyz = worldPosition.xyz + offset;"),t.push("relativeToOriginPosition = worldPosition.xyz;"),t.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t.push("  vWorldPosition = worldPosition;"),s&&t.push("  vFlags = flags;"),t.push("vPickColor = pickColor;"),t.push("vec4 clipPos = projMatrix * viewPosition;"),t.push("float tmp = clipPos.w;"),t.push("clipPos.xyzw /= tmp;"),t.push("clipPos.xy = remapClipPos(clipPos.xy);"),t.push("clipPos.xyzw *= tmp;"),t.push("vFragDepth = 1.0 + clipPos.w;"),t.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),t.push("gl_Position = clipPos;"),t.push("}"),t.push("}"),t}_buildFragmentShader(){const i=this._scene._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Points instancing pick depth fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;"),t.push("uniform int layerNumber;"),t.push("uniform vec3 coordinateScaler;"),t.push("in vec4 vWorldPosition;"),t.push("flat in vec4 vPickColor;"),s){t.push("in float vFlags;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("in highp vec3 relativeToOriginPosition;"),t.push("layout(location = 0) out highp ivec4 outCoords;"),t.push("layout(location = 1) out highp ivec4 outNormal;"),t.push("layout(location = 2) out lowp uvec4 outPickColor;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("if (dist > 0.0) { discard; }"),t.push("}")}return t.push("    float dx = dFdx(vFragDepth);"),t.push("    float dy = dFdy(vFragDepth);"),t.push("    float diff = sqrt(dx*dx+dy*dy);"),t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),t.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),t.push("vec3 xTangent = dFdx( vWorldPosition.xyz );"),t.push("vec3 yTangent = dFdy( vWorldPosition.xyz );"),t.push("vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),t.push(`outNormal = ivec4(worldNormal * float(${c.MAX_INT}), 1.0);`),t.push("outPickColor = uvec4(vPickColor);"),t.push("}"),t}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const wv=c.vec3(),bv=c.vec3(),Cv=c.vec3(),Ev=c.vec3(),Iv=c.mat4();class Bh extends zt{constructor(e){super(e,!1,{instancing:!0})}drawLayer(e,i,s){if(!this._program&&(this._allocate(i),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const t=i.model,o=t.scene,n=o.camera,a=o.canvas.gl,A=i._state,l=i._state.origin,{position:h,rotationMatrix:d,rotationMatrixConjugate:f}=t,m=i.aabb,_=e.pickViewMatrix||n.viewMatrix;this._vaoCache.has(i)?a.bindVertexArray(this._vaoCache.get(i)):this._vaoCache.set(i,this._makeVAO(A));const u=wv;u[0]=c.safeInv(m[3]-m[0])*c.MAX_INT,u[1]=c.safeInv(m[4]-m[1])*c.MAX_INT,u[2]=c.safeInv(m[5]-m[2])*c.MAX_INT,e.snapPickCoordinateScale[0]=c.safeInv(u[0]),e.snapPickCoordinateScale[1]=c.safeInv(u[1]),e.snapPickCoordinateScale[2]=c.safeInv(u[2]);let P,y;if(l||h[0]!==0||h[1]!==0||h[2]!==0){const v=bv;if(l){const w=c.transformPoint3(d,l,Cv);v[0]=w[0],v[1]=w[1],v[2]=w[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=h[0],v[1]+=h[1],v[2]+=h[2],P=ft(_,v,Iv),y=Ev,y[0]=n.eye[0]-v[0],y[1]=n.eye[1]-v[1],y[2]=n.eye[2]-v[2],e.snapPickOrigin[0]=v[0],e.snapPickOrigin[1]=v[1],e.snapPickOrigin[2]=v[2]}else P=_,y=n.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;a.uniform3fv(this._uCameraEyeRtc,y),a.uniform2fv(this.uVectorA,e.snapVectorA),a.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),a.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),a.uniform3fv(this._uCoordinateScaler,u),a.uniform1i(this._uRenderPass,s),a.uniform1i(this._uPickInvisible,e.pickInvisible);let x=0;const B=4*4;this._matricesUniformBlockBufferData.set(f,0),this._matricesUniformBlockBufferData.set(P,x+=B),this._matricesUniformBlockBufferData.set(n.projMatrix,x+=B),this._matricesUniformBlockBufferData.set(A.positionsDecodeMatrix,x+=B),a.bindBuffer(a.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),a.bufferData(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,a.DYNAMIC_DRAW),a.bindBufferBase(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const v=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,v)}this.setSectionPlanesStateUniforms(i),this._aModelMatrixCol0.bindArrayBuffer(A.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(A.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(A.modelMatrixCol2Buf),a.vertexAttribDivisor(this._aModelMatrixCol0.location,1),a.vertexAttribDivisor(this._aModelMatrixCol1.location,1),a.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aFlags.bindArrayBuffer(A.flagsBuf),a.vertexAttribDivisor(this._aFlags.location,1),e.snapMode==="edge"?(A.edgeIndicesBuf.bind(),a.drawElementsInstanced(a.LINES,A.edgeIndicesBuf.numItems,A.edgeIndicesBuf.itemType,0,A.numInstances),A.edgeIndicesBuf.unbind()):a.drawArraysInstanced(a.POINTS,0,A.positionsBuf.numItems,A.numInstances),a.vertexAttribDivisor(this._aModelMatrixCol0.location,0),a.vertexAttribDivisor(this._aModelMatrixCol1.location,0),a.vertexAttribDivisor(this._aModelMatrixCol2.location,0),a.vertexAttribDivisor(this._aFlags.location,0),this._aOffset&&a.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=[];return t.push("#version 300 es"),t.push("// SnapInstancingDepthRenderer vertex shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("precision highp usampler2D;"),t.push("precision highp isampler2D;"),t.push("precision highp sampler2D;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("precision mediump usampler2D;"),t.push("precision mediump isampler2D;"),t.push("precision mediump sampler2D;"),t.push("#endif"),t.push("uniform int renderPass;"),t.push("in vec3 position;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),t.push("in float flags;"),t.push("in vec4 modelMatrixCol0;"),t.push("in vec4 modelMatrixCol1;"),t.push("in vec4 modelMatrixCol2;"),t.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(t),t.push("uniform vec3 uCameraEyeRtc;"),t.push("uniform vec2 snapVectorA;"),t.push("uniform vec2 snapInvVectorAB;"),t.push("uniform float logDepthBufFC;"),t.push("out float vFragDepth;"),t.push("bool isPerspectiveMatrix(mat4 m) {"),t.push("    return (m[2][3] == - 1.0);"),t.push("}"),t.push("out float isPerspective;"),t.push("vec2 remapClipPos(vec2 clipPos) {"),t.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),t.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),t.push("    return vec2(x, y);"),t.push("}"),s&&(t.push("out vec4 vWorldPosition;"),t.push("out float vFlags;")),t.push("out highp vec3 relativeToOriginPosition;"),t.push("void main(void) {"),t.push("int pickFlag = int(flags) >> 12 & 0xF;"),t.push("if (pickFlag != renderPass) {"),t.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("} else {"),t.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),t.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&t.push("      worldPosition.xyz = worldPosition.xyz + offset;"),t.push("relativeToOriginPosition = worldPosition.xyz;"),t.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s&&(t.push("  vWorldPosition = worldPosition;"),t.push("  vFlags = flags;")),t.push("vec4 clipPos = projMatrix * viewPosition;"),t.push("float tmp = clipPos.w;"),t.push("clipPos.xyzw /= tmp;"),t.push("clipPos.xy = remapClipPos(clipPos.xy);"),t.push("clipPos.xyzw *= tmp;"),t.push("vFragDepth = 1.0 + clipPos.w;"),t.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),t.push("gl_Position = clipPos;"),t.push("gl_PointSize = 1.0;"),t.push("}"),t.push("}"),t}_buildFragmentShader(){const i=this._scene._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// SnapInstancingDepthRenderer fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;"),t.push("uniform int layerNumber;"),t.push("uniform vec3 coordinateScaler;"),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("in highp vec3 relativeToOriginPosition;"),t.push("out highp ivec4 outCoords;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("if (dist > 0.0) { discard; }"),t.push("}")}return t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),t.push("}"),t}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class Fv{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._colorRendererWithSAO&&!this._colorRendererWithSAO.getValid()&&(this._colorRendererWithSAO.destroy(),this._colorRendererWithSAO=null),this._flatColorRenderer&&!this._flatColorRenderer.getValid()&&(this._flatColorRenderer.destroy(),this._flatColorRenderer=null),this._flatColorRendererWithSAO&&!this._flatColorRendererWithSAO.getValid()&&(this._flatColorRendererWithSAO.destroy(),this._flatColorRendererWithSAO=null),this._pbrRenderer&&!this._pbrRenderer.getValid()&&(this._pbrRenderer.destroy(),this._pbrRenderer=null),this._pbrRendererWithSAO&&!this._pbrRendererWithSAO.getValid()&&(this._pbrRendererWithSAO.destroy(),this._pbrRendererWithSAO=null),this._colorTextureRenderer&&!this._colorTextureRenderer.getValid()&&(this._colorTextureRenderer.destroy(),this._colorTextureRenderer=null),this._colorTextureRendererWithSAO&&!this._colorTextureRendererWithSAO.getValid()&&(this._colorTextureRendererWithSAO.destroy(),this._colorTextureRendererWithSAO=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._normalsRenderer&&!this._normalsRenderer.getValid()&&(this._normalsRenderer.destroy(),this._normalsRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._edgesRenderer&&!this._edgesRenderer.getValid()&&(this._edgesRenderer.destroy(),this._edgesRenderer=null),this._edgesColorRenderer&&!this._edgesColorRenderer.getValid()&&(this._edgesColorRenderer.destroy(),this._edgesColorRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&this._pickNormalsRenderer.getValid()===!1&&(this._pickNormalsRenderer.destroy(),this._pickNormalsRenderer=null),this._pickNormalsFlatRenderer&&!this._pickNormalsFlatRenderer.getValid()&&(this._pickNormalsFlatRenderer.destroy(),this._pickNormalsFlatRenderer=null),this._occlusionRenderer&&this._occlusionRenderer.getValid()===!1&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}eagerCreateRenders(){this._silhouetteRenderer||(this._silhouetteRenderer=new fh(this._scene)),this._pickMeshRenderer||(this._pickMeshRenderer=new gh(this._scene)),this._pickDepthRenderer||(this._pickDepthRenderer=new mh(this._scene)),this._snapInitRenderer||(this._snapInitRenderer=new Ph(this._scene,!1)),this._snapRenderer||(this._snapRenderer=new Bh(this._scene))}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new dh(this._scene,!1)),this._colorRenderer}get colorRendererWithSAO(){return this._colorRendererWithSAO||(this._colorRendererWithSAO=new dh(this._scene,!0)),this._colorRendererWithSAO}get flatColorRenderer(){return this._flatColorRenderer||(this._flatColorRenderer=new ph(this._scene,!1)),this._flatColorRenderer}get flatColorRendererWithSAO(){return this._flatColorRendererWithSAO||(this._flatColorRendererWithSAO=new ph(this._scene,!0)),this._flatColorRendererWithSAO}get pbrRenderer(){return this._pbrRenderer||(this._pbrRenderer=new _h(this._scene,!1)),this._pbrRenderer}get pbrRendererWithSAO(){return this._pbrRendererWithSAO||(this._pbrRendererWithSAO=new _h(this._scene,!0)),this._pbrRendererWithSAO}get colorTextureRenderer(){return this._colorTextureRenderer||(this._colorTextureRenderer=new vh(this._scene,!1)),this._colorTextureRenderer}get colorTextureRendererWithSAO(){return this._colorTextureRendererWithSAO||(this._colorTextureRendererWithSAO=new vh(this._scene,!0)),this._colorTextureRendererWithSAO}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new fh(this._scene)),this._silhouetteRenderer}get depthRenderer(){return this._depthRenderer||(this._depthRenderer=new fv(this._scene)),this._depthRenderer}get normalsRenderer(){return this._normalsRenderer||(this._normalsRenderer=new gv(this._scene)),this._normalsRenderer}get edgesRenderer(){return this._edgesRenderer||(this._edgesRenderer=new hv(this._scene)),this._edgesRenderer}get edgesColorRenderer(){return this._edgesColorRenderer||(this._edgesColorRenderer=new uv(this._scene)),this._edgesColorRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new gh(this._scene)),this._pickMeshRenderer}get pickNormalsRenderer(){return this._pickNormalsRenderer||(this._pickNormalsRenderer=new dv(this._scene)),this._pickNormalsRenderer}get pickNormalsFlatRenderer(){return this._pickNormalsFlatRenderer||(this._pickNormalsFlatRenderer=new _v(this._scene)),this._pickNormalsFlatRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new mh(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new pv(this._scene)),this._occlusionRenderer}get shadowRenderer(){return this._shadowRenderer||(this._shadowRenderer=new mv(this._scene)),this._shadowRenderer}get snapInitRenderer(){return this._snapInitRenderer||(this._snapInitRenderer=new Ph(this._scene,!1)),this._snapInitRenderer}get snapRenderer(){return this._snapRenderer||(this._snapRenderer=new Bh(this._scene)),this._snapRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._colorRendererWithSAO&&this._colorRendererWithSAO.destroy(),this._flatColorRenderer&&this._flatColorRenderer.destroy(),this._flatColorRendererWithSAO&&this._flatColorRendererWithSAO.destroy(),this._pbrRenderer&&this._pbrRenderer.destroy(),this._pbrRendererWithSAO&&this._pbrRendererWithSAO.destroy(),this._colorTextureRenderer&&this._colorTextureRenderer.destroy(),this._colorTextureRendererWithSAO&&this._colorTextureRendererWithSAO.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._normalsRenderer&&this._normalsRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._edgesRenderer&&this._edgesRenderer.destroy(),this._edgesColorRenderer&&this._edgesColorRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._pickNormalsRenderer&&this._pickNormalsRenderer.destroy(),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}const Ra={};function Mv(r){const e=r.id;let i=Ra[e];return i||(i=new Fv(r),Ra[e]=i,i._compile(),i.eagerCreateRenders(),r.on("compile",()=>{i._compile(),i.eagerCreateRenders()}),r.on("destroyed",()=>{delete Ra[e],i._destroy()})),i}const Er=new Uint8Array(4),yh=new Float32Array(1),Sv=c.vec4([0,0,0,1]),Oo=new Float32Array(3),Tv=c.vec3(),Dv=c.vec3(),Rv=c.vec3(),Lv=c.vec3(),Uv=c.vec3(),Ov=c.vec3(),kv=c.vec3(),ti=new Float32Array(4);class La{constructor(e){console.info("Creating VBOInstancingTrianglesLayer"),this.model=e.model,this.sortId="TrianglesInstancingLayer"+(e.solid?"-solid":"-surface")+(e.normals?"-normals":"-autoNormals"),this.layerIndex=e.layerIndex,this._renderers=Mv(e.model.scene),this._aabb=c.collapseAABB3(),this._state=new Ft({numInstances:0,obb:c.OBB3(),origin:c.vec3(),geometry:e.geometry,textureSet:e.textureSet,pbrSupported:!1,positionsDecodeMatrix:e.geometry.positionsDecodeMatrix,colorsBuf:null,metallicRoughnessBuf:null,flagsBuf:null,offsetsBuf:null,modelMatrixBuf:null,modelMatrixCol0Buf:null,modelMatrixCol1Buf:null,modelMatrixCol2Buf:null,modelNormalMatrixCol0Buf:null,modelNormalMatrixCol1Buf:null,modelNormalMatrixCol2Buf:null,pickColorsBuf:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this.numIndices=e.geometry.numIndices,this._colors=[],this._metallicRoughness=[],this._pickColors=[],this._offsets=[],this._modelMatrix=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._modelNormalMatrixCol0=[],this._modelNormalMatrixCol1=[],this._modelNormalMatrixCol2=[],this._portions=[],this._meshes=[],this._aabb=c.collapseAABB3(),this.aabbDirty=!0,e.origin&&this._state.origin.set(e.origin),this._finalized=!1,this.solid=!!e.solid,this.numIndices=e.geometry.numIndices}get aabb(){if(this.aabbDirty){c.collapseAABB3(this._aabb);for(let e=0,i=this._meshes.length;e<i;e++)c.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}createPortion(e,i){const s=i.color,t=i.metallic,o=i.roughness,n=i.opacity!==null&&i.opacity!==void 0?i.opacity:255,a=i.meshMatrix,A=i.pickColor;if(this._finalized)throw"Already finalized";const l=s[0],h=s[1],d=s[2];if(this._colors.push(l),this._colors.push(h),this._colors.push(d),this._colors.push(n),this._metallicRoughness.push(t??0),this._metallicRoughness.push(o??255),this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(a[0]),this._modelMatrixCol0.push(a[4]),this._modelMatrixCol0.push(a[8]),this._modelMatrixCol0.push(a[12]),this._modelMatrixCol1.push(a[1]),this._modelMatrixCol1.push(a[5]),this._modelMatrixCol1.push(a[9]),this._modelMatrixCol1.push(a[13]),this._modelMatrixCol2.push(a[2]),this._modelMatrixCol2.push(a[6]),this._modelMatrixCol2.push(a[10]),this._modelMatrixCol2.push(a[14]),this._state.geometry.normals){let _=c.transposeMat4(a,c.mat4()),u=c.inverseMat4(_);this._modelNormalMatrixCol0.push(u[0]),this._modelNormalMatrixCol0.push(u[4]),this._modelNormalMatrixCol0.push(u[8]),this._modelNormalMatrixCol0.push(u[12]),this._modelNormalMatrixCol1.push(u[1]),this._modelNormalMatrixCol1.push(u[5]),this._modelNormalMatrixCol1.push(u[9]),this._modelNormalMatrixCol1.push(u[13]),this._modelNormalMatrixCol2.push(u[2]),this._modelNormalMatrixCol2.push(u[6]),this._modelNormalMatrixCol2.push(u[10]),this._modelNormalMatrixCol2.push(u[14])}this._pickColors.push(A[0]),this._pickColors.push(A[1]),this._pickColors.push(A[2]),this._pickColors.push(A[3]),this._state.numInstances++;const f=this._portions.length,m={};return this.model.scene.pickSurfacePrecisionEnabled&&(m.matrix=a.slice(),m.inverseMatrix=null,m.normalMatrix=null),this._portions.push(m),this._numPortions++,this.model.numPortions++,this._meshes.push(e),f}finalize(){if(this._finalized)return;const e=this._state,i=e.geometry,s=e.textureSet,t=this.model.scene.canvas.gl,o=this._colors.length,n=o/4;if(o>0){let a=!1;e.colorsBuf=new Ee(t,t.ARRAY_BUFFER,new Uint8Array(this._colors),this._colors.length,4,t.DYNAMIC_DRAW,a),this._colors=[]}if(this._metallicRoughness.length>0){const a=new Uint8Array(this._metallicRoughness);let A=!1;e.metallicRoughnessBuf=new Ee(t,t.ARRAY_BUFFER,a,this._metallicRoughness.length,2,t.STATIC_DRAW,A)}if(n>0){let a=!1;e.flagsBuf=new Ee(t,t.ARRAY_BUFFER,new Float32Array(n),n,1,t.DYNAMIC_DRAW,a)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0&&(e.offsetsBuf=new Ee(t,t.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,t.DYNAMIC_DRAW,!1),this._offsets=[]),i.positionsCompressed&&i.positionsCompressed.length>0&&(e.positionsBuf=new Ee(t,t.ARRAY_BUFFER,i.positionsCompressed,i.positionsCompressed.length,3,t.STATIC_DRAW,!1),e.positionsDecodeMatrix=c.mat4(i.positionsDecodeMatrix)),i.colorsCompressed&&i.colorsCompressed.length>0){const a=new Uint8Array(i.colorsCompressed),A=!1;e.colorsBuf=new Ee(t,t.ARRAY_BUFFER,a,a.length,4,t.STATIC_DRAW,A)}if(i.uvCompressed&&i.uvCompressed.length>0){const a=i.uvCompressed;e.uvDecodeMatrix=i.uvDecodeMatrix,e.uvBuf=new Ee(t,t.ARRAY_BUFFER,a,a.length,2,t.STATIC_DRAW,!1)}i.indices&&i.indices.length>0&&(e.indicesBuf=new Ee(t,t.ELEMENT_ARRAY_BUFFER,new Uint32Array(i.indices),i.indices.length,1,t.STATIC_DRAW),e.numIndices=i.indices.length),(i.primitive==="triangles"||i.primitive==="solid"||i.primitive==="surface")&&(e.edgeIndicesBuf=new Ee(t,t.ELEMENT_ARRAY_BUFFER,new Uint32Array(i.edgeIndices),i.edgeIndices.length,1,t.STATIC_DRAW)),this._modelMatrixCol0.length>0&&(e.modelMatrixCol0Buf=new Ee(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,t.STATIC_DRAW,!1),e.modelMatrixCol1Buf=new Ee(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,t.STATIC_DRAW,!1),e.modelMatrixCol2Buf=new Ee(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,t.STATIC_DRAW,!1),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],e.normalsBuf&&(e.modelNormalMatrixCol0Buf=new Ee(t,t.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol0),this._modelNormalMatrixCol0.length,4,t.STATIC_DRAW,!1),e.modelNormalMatrixCol1Buf=new Ee(t,t.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol1),this._modelNormalMatrixCol1.length,4,t.STATIC_DRAW,!1),e.modelNormalMatrixCol2Buf=new Ee(t,t.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol2),this._modelNormalMatrixCol2.length,4,t.STATIC_DRAW,!1),this._modelNormalMatrixCol0=[],this._modelNormalMatrixCol1=[],this._modelNormalMatrixCol2=[])),this._pickColors.length>0&&(e.pickColorsBuf=new Ee(t,t.ARRAY_BUFFER,new Uint8Array(this._pickColors),this._pickColors.length,4,t.STATIC_DRAW,!1),this._pickColors=[]),e.pbrSupported=!!e.metallicRoughnessBuf&&!!e.uvBuf&&!!e.normalsBuf&&!!s&&!!s.colorTexture&&!!s.metallicRoughnessTexture,e.colorTextureSupported=!!e.uvBuf&&!!s&&!!s.colorTexture,this._state.geometry=null,this._finalized=!0}initFlags(e,i,s){i&k.VISIBLE&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),i&k.HIGHLIGHTED&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),i&k.XRAYED&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),i&k.SELECTED&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),i&k.CLIPPABLE&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),i&k.EDGES&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),i&k.PICKABLE&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),i&k.CULLED&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),s&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,i,s)}setVisible(e,i,s){if(!this._finalized)throw"Not finalized";i&k.VISIBLE?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,i,s)}setHighlighted(e,i,s){if(!this._finalized)throw"Not finalized";i&k.HIGHLIGHTED?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,i,s)}setXRayed(e,i,s){if(!this._finalized)throw"Not finalized";i&k.XRAYED?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,i,s)}setSelected(e,i,s){if(!this._finalized)throw"Not finalized";i&k.SELECTED?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,i,s)}setEdges(e,i,s){if(!this._finalized)throw"Not finalized";i&k.EDGES?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,i,s)}setClippable(e,i){if(!this._finalized)throw"Not finalized";i&k.CLIPPABLE?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,i)}setCollidable(e,i){if(!this._finalized)throw"Not finalized"}setPickable(e,i,s){if(!this._finalized)throw"Not finalized";i&k.PICKABLE?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,i,s)}setCulled(e,i,s){if(!this._finalized)throw"Not finalized";i&k.CULLED?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,i,s)}setColor(e,i){if(!this._finalized)throw"Not finalized";Er[0]=i[0],Er[1]=i[1],Er[2]=i[2],Er[3]=i[3],this._state.colorsBuf&&this._state.colorsBuf.setData(Er,e*4)}setTransparent(e,i,s){s?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,i,s)}_setFlags(e,i,s){if(!this._finalized)throw"Not finalized";const t=!!(i&k.VISIBLE),o=!!(i&k.XRAYED),n=!!(i&k.HIGHLIGHTED),a=!!(i&k.SELECTED),A=!!(i&k.EDGES),l=!!(i&k.PICKABLE),h=!!(i&k.CULLED);let d;!t||h||o||n&&!this.model.scene.highlightMaterial.glowThrough||a&&!this.model.scene.selectedMaterial.glowThrough?d=U.NOT_RENDERED:s?d=U.COLOR_TRANSPARENT:d=U.COLOR_OPAQUE;let f;!t||h?f=U.NOT_RENDERED:a?f=U.SILHOUETTE_SELECTED:n?f=U.SILHOUETTE_HIGHLIGHTED:o?f=U.SILHOUETTE_XRAYED:f=U.NOT_RENDERED;let m=0;!t||h?m=U.NOT_RENDERED:a?m=U.EDGES_SELECTED:n?m=U.EDGES_HIGHLIGHTED:o?m=U.EDGES_XRAYED:A?s?m=U.EDGES_COLOR_TRANSPARENT:m=U.EDGES_COLOR_OPAQUE:m=U.NOT_RENDERED;const _=t&&!h&&l?U.PICK:U.NOT_RENDERED,u=i&k.CLIPPABLE?1:0;let P=0;P|=d,P|=f<<4,P|=m<<8,P|=_<<12,P|=u<<16,yh[0]=P,this._state.flagsBuf&&this._state.flagsBuf.setData(yh,e)}setOffset(e,i){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled){this.model.error("Entity#offset not enabled for this Viewer");return}Oo[0]=i[0],Oo[1]=i[1],Oo[2]=i[2],this._state.offsetsBuf&&this._state.offsetsBuf.setData(Oo,e*3)}getEachVertex(e,i){if(!this.model.scene.pickSurfacePrecisionEnabled)return!1;const s=this._state,t=s.geometry,o=this._portions[e];if(!o){this.model.error("portion not found: "+e);return}const n=t.quantizedPositions,a=s.origin,A=o.offset,l=a[0]+A[0],h=a[1]+A[1],d=a[2]+A[2],f=Sv,m=o.matrix,_=this.model.sceneModelMatrix,u=s.positionsDecodeMatrix;for(let P=0,y=n.length;P<y;P+=3)f[0]=n[P],f[1]=n[P+1],f[2]=n[P+2],c.decompressPosition(f,u),c.transformPoint3(m,f),c.transformPoint3(_,f),f[0]+=l,f[1]+=h,f[2]+=d,i(f)}setMatrix(e,i){if(!this._finalized)throw"Not finalized";var s=e*4;ti[0]=i[0],ti[1]=i[4],ti[2]=i[8],ti[3]=i[12],this._state.modelMatrixCol0Buf.setData(ti,s),ti[0]=i[1],ti[1]=i[5],ti[2]=i[9],ti[3]=i[13],this._state.modelMatrixCol1Buf.setData(ti,s),ti[0]=i[2],ti[1]=i[6],ti[2]=i[10],ti[3]=i[14],this._state.modelMatrixCol2Buf.setData(ti,s)}drawColorOpaque(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,i),i.withSAO&&this.model.saoEnabled?i.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._renderers.pbrRendererWithSAO&&this._renderers.pbrRendererWithSAO.drawLayer(i,this,U.COLOR_OPAQUE):i.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?this._renderers.colorTextureRendererWithSAO&&this._renderers.colorTextureRendererWithSAO.drawLayer(i,this,U.COLOR_OPAQUE):this._state.normalsBuf?this._renderers.colorRendererWithSAO&&this._renderers.colorRendererWithSAO.drawLayer(i,this,U.COLOR_OPAQUE):this._renderers.flatColorRendererWithSAO&&this._renderers.flatColorRendererWithSAO.drawLayer(i,this,U.COLOR_OPAQUE):i.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._renderers.pbrRenderer&&this._renderers.pbrRenderer.drawLayer(i,this,U.COLOR_OPAQUE):i.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?this._renderers.colorTextureRenderer&&this._renderers.colorTextureRenderer.drawLayer(i,this,U.COLOR_OPAQUE):this._state.normalsBuf?this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(i,this,U.COLOR_OPAQUE):this._renderers.flatColorRenderer&&this._renderers.flatColorRenderer.drawLayer(i,this,U.COLOR_OPAQUE))}_updateBackfaceCull(e,i){const s=this.model.backfaces||!this.solid||e.sectioned;if(i.backfaces!==s){const t=i.gl;s?t.disable(t.CULL_FACE):t.enable(t.CULL_FACE),i.backfaces=s}}drawColorTransparent(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===0||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,i),i.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._renderers.pbrRenderer&&this._renderers.pbrRenderer.drawLayer(i,this,U.COLOR_TRANSPARENT):i.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?this._renderers.colorTextureRenderer&&this._renderers.colorTextureRenderer.drawLayer(i,this,U.COLOR_TRANSPARENT):this._state.normalsBuf?this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(i,this,U.COLOR_TRANSPARENT):this._renderers.flatColorRenderer&&this._renderers.flatColorRenderer.drawLayer(i,this,U.COLOR_TRANSPARENT))}drawDepth(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,i),this._renderers.depthRenderer&&this._renderers.depthRenderer.drawLayer(i,this,U.COLOR_OPAQUE))}drawNormals(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,i),this._renderers.normalsRenderer&&this._renderers.normalsRenderer.drawLayer(i,this,U.COLOR_OPAQUE))}drawSilhouetteXRayed(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||(this._updateBackfaceCull(e,i),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(i,this,U.SILHOUETTE_XRAYED))}drawSilhouetteHighlighted(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||(this._updateBackfaceCull(e,i),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(i,this,U.SILHOUETTE_HIGHLIGHTED))}drawSilhouetteSelected(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||(this._updateBackfaceCull(e,i),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(i,this,U.SILHOUETTE_SELECTED))}drawEdgesColorOpaque(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numEdgesLayerPortions===0||this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(i,this,U.EDGES_COLOR_OPAQUE)}drawEdgesColorTransparent(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numEdgesLayerPortions===0||this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(i,this,U.EDGES_COLOR_TRANSPARENT)}drawEdgesXRayed(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(i,this,U.EDGES_XRAYED)}drawEdgesHighlighted(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(i,this,U.EDGES_HIGHLIGHTED)}drawEdgesSelected(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(i,this,U.EDGES_SELECTED)}drawOcclusion(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,i),this._renderers.occlusionRenderer&&this._renderers.occlusionRenderer.drawLayer(i,this,U.COLOR_OPAQUE))}drawShadow(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,i),this._renderers.shadowRenderer&&this._renderers.shadowRenderer.drawLayer(i,this,U.COLOR_OPAQUE))}drawPickMesh(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,i),this._renderers.pickMeshRenderer&&this._renderers.pickMeshRenderer.drawLayer(i,this,U.PICK))}drawPickDepths(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,i),this._renderers.pickDepthRenderer&&this._renderers.pickDepthRenderer.drawLayer(i,this,U.PICK))}drawPickNormals(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,i),this._renderers.pickNormalsFlatRenderer&&this._renderers.pickNormalsFlatRenderer.drawLayer(i,this,U.PICK))}drawSnapInit(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,i),this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(i,this,U.PICK))}drawSnap(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,i),this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(i,this,U.PICK))}precisionRayPickSurface(e,i,s,t,o){if(!this.model.scene.pickSurfacePrecisionEnabled)return!1;const n=this._state.geometry,a=this._state,A=this._portions[e];if(!A)return this.model.error("portion not found: "+e),!1;A.inverseMatrix||(A.inverseMatrix=c.inverseMat4(A.matrix,c.mat4())),o&&!A.normalMatrix&&(A.normalMatrix=c.transposeMat4(A.inverseMatrix,c.mat4()));const l=n.quantizedPositions,h=n.indices,d=a.origin,f=A.offset,m=Tv,_=Dv;m.set(d?c.subVec3(i,d,Rv):i),_.set(s),f&&c.subVec3(m,f),c.transformRay(this.model.worldNormalMatrix,m,_,m,_),c.transformRay(A.inverseMatrix,m,_,m,_);const u=Lv,P=Uv,y=Ov;let x=!1,B=0;const v=kv;for(let w=0,C=h.length;w<C;w+=3){const I=h[w+0]*3,E=h[w+1]*3,S=h[w+2]*3;u[0]=l[I],u[1]=l[I+1],u[2]=l[I+2],P[0]=l[E],P[1]=l[E+1],P[2]=l[E+2],y[0]=l[S],y[1]=l[S+1],y[2]=l[S+2];const{positionsDecodeMatrix:R}=a.geometry;if(c.decompressPosition(u,R),c.decompressPosition(P,R),c.decompressPosition(y,R),c.rayTriangleIntersect(m,_,u,P,y,v)){c.transformPoint3(A.matrix,v,v),c.transformPoint3(this.model.worldMatrix,v,v),f&&c.addVec3(v,f),d&&c.addVec3(v,d);const D=Math.abs(c.lenVec3(c.subVec3(v,i,[])));(!x||D>B)&&(B=D,t.set(v),o&&c.triangleNormal(u,P,y,o),x=!0)}}return x&&o&&(c.transformVec3(A.normalMatrix,o,o),c.transformVec3(this.model.worldNormalMatrix,o,o),c.normalizeVec3(o)),x}destroy(){const e=this._state;e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.metallicRoughnessBuf&&(e.metallicRoughnessBuf.destroy(),e.metallicRoughnessBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.modelMatrixCol0Buf&&(e.modelMatrixCol0Buf.destroy(),e.modelMatrixCol0Buf=null),e.modelMatrixCol1Buf&&(e.modelMatrixCol1Buf.destroy(),e.modelMatrixCol1Buf=null),e.modelMatrixCol2Buf&&(e.modelMatrixCol2Buf.destroy(),e.modelMatrixCol2Buf=null),e.modelNormalMatrixCol0Buf&&(e.modelNormalMatrixCol0Buf.destroy(),e.modelNormalMatrixCol0Buf=null),e.modelNormalMatrixCol1Buf&&(e.modelNormalMatrixCol1Buf.destroy(),e.modelNormalMatrixCol1Buf=null),e.modelNormalMatrixCol2Buf&&(e.modelNormalMatrixCol2Buf.destroy(),e.modelNormalMatrixCol2Buf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.destroy(),this._state=null}}class Fp extends zt{_draw(e){const{gl:i}=this._scene.canvas,{state:s,frameCtx:t,incrementDrawState:o}=e;i.drawElements(i.LINES,s.indicesBuf.numItems,s.indicesBuf.itemType,0),o&&t.drawElements++}}class Nv extends Fp{drawLayer(e,i,s){super.drawLayer(e,i,s,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=[];return t.push("#version 300 es"),t.push("// Lines batching color vertex shader"),t.push("uniform int renderPass;"),t.push("in vec3 position;"),t.push("in vec4 color;"),t.push("in float flags;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),this._addMatricesUniformBlockLines(t),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("out float vFragDepth;")),s&&(t.push("out vec4 vWorldPosition;"),t.push("out float vFlags;")),t.push("out vec4 vColor;"),t.push("void main(void) {"),t.push("int colorFlag = int(flags) & 0xF;"),t.push("if (colorFlag != renderPass) {"),t.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("} else {"),t.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&t.push("worldPosition.xyz = worldPosition.xyz + offset;"),t.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),s&&(t.push("vWorldPosition = worldPosition;"),t.push("vFlags = flags;")),t.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&t.push("vFragDepth = 1.0 + clipPos.w;"),t.push("gl_Position = clipPos;"),t.push("}"),t.push("}"),t}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Lines batching color fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("in vec4 vColor;"),t.push("out vec4 outColor;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("  if (dist > 0.0) { discard; }"),t.push("}")}return t.push("   outColor            = vColor;"),e.logarithmicDepthBufferEnabled&&t.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("}"),t}}class Qv extends Fp{drawLayer(e,i,s){super.drawLayer(e,i,s,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=[];return t.push("#version 300 es"),t.push("// Lines batching silhouette vertex shader"),t.push("uniform int renderPass;"),t.push("in vec3 position;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),t.push("in float flags;"),this._addMatricesUniformBlockLines(t),t.push("uniform vec4 color;"),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("out float vFragDepth;")),s&&(t.push("out vec4 vWorldPosition;"),t.push("out float vFlags;")),t.push("void main(void) {"),t.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),t.push("if (silhouetteFlag != renderPass) {"),t.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("} else {"),t.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&t.push("      worldPosition.xyz = worldPosition.xyz + offset;"),t.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s&&(t.push("vWorldPosition = worldPosition;"),t.push("vFlags = flags;")),t.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&t.push("vFragDepth = 1.0 + clipPos.w;"),t.push("gl_Position = clipPos;"),t.push("}"),t.push("}"),t}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Lines batching silhouette fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("uniform vec4 color;"),t.push("out vec4 outColor;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("  if (dist > 0.0) { discard; }"),t.push("}")}return e.logarithmicDepthBufferEnabled&&t.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("outColor = color;"),t.push("}"),t}}const Hv=c.vec3(),Vv=c.vec3(),jv=c.vec3(),Gv=c.vec3(),zv=c.mat4();class Kv extends zt{drawLayer(e,i,s){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const t=i.model,o=t.scene,n=o.camera,a=o.canvas.gl,A=i._state,l=i._state.origin,{position:h,rotationMatrix:d,rotationMatrixConjugate:f}=t,m=i.aabb,_=e.pickViewMatrix||n.viewMatrix;this._vaoCache.has(i)?a.bindVertexArray(this._vaoCache.get(i)):this._vaoCache.set(i,this._makeVAO(A));const u=Hv;u[0]=c.safeInv(m[3]-m[0])*c.MAX_INT,u[1]=c.safeInv(m[4]-m[1])*c.MAX_INT,u[2]=c.safeInv(m[5]-m[2])*c.MAX_INT,e.snapPickCoordinateScale[0]=c.safeInv(u[0]),e.snapPickCoordinateScale[1]=c.safeInv(u[1]),e.snapPickCoordinateScale[2]=c.safeInv(u[2]);let P,y;if(l||h[0]!==0||h[1]!==0||h[2]!==0){const v=Vv;if(l){const w=jv;c.transformPoint3(d,l,w),v[0]=w[0],v[1]=w[1],v[2]=w[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=h[0],v[1]+=h[1],v[2]+=h[2],P=ft(_,v,zv),y=Gv,y[0]=n.eye[0]-v[0],y[1]=n.eye[1]-v[1],y[2]=n.eye[2]-v[2],e.snapPickOrigin[0]=v[0],e.snapPickOrigin[1]=v[1],e.snapPickOrigin[2]=v[2]}else P=_,y=n.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;a.uniform3fv(this._uCameraEyeRtc,y),a.uniform2fv(this.uVectorA,e.snapVectorA),a.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),a.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),a.uniform3fv(this._uCoordinateScaler,u),a.uniform1i(this._uRenderPass,s),a.uniform1i(this._uPickInvisible,e.pickInvisible);let x=0;const B=4*4;this._matricesUniformBlockBufferData.set(f,0),this._matricesUniformBlockBufferData.set(P,x+=B),this._matricesUniformBlockBufferData.set(n.projMatrix,x+=B),this._matricesUniformBlockBufferData.set(A.positionsDecodeMatrix,x+=B),a.bindBuffer(a.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),a.bufferData(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,a.DYNAMIC_DRAW),a.bindBufferBase(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const v=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,v)}this.setSectionPlanesStateUniforms(i),A.indicesBuf.bind(),a.drawElements(a.LINES,A.indicesBuf.numItems,A.indicesBuf.itemType,0),A.indicesBuf.unbind()}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// VBO SnapBatchingDepthBufInitRenderer vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),s.push("in vec4 pickColor;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),s.push("uniform vec3 uCameraEyeRtc;"),s.push("uniform vec2 snapVectorA;"),s.push("uniform vec2 snapInvVectorAB;"),s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("out float isPerspective;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("vec2 remapClipPos(vec2 clipPos) {"),s.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),s.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),s.push("    return vec2(x, y);"),s.push("}"),s.push("flat out vec4 vPickColor;"),s.push("out vec4 vWorldPosition;"),i&&s.push("out float vFlags;"),s.push("out highp vec3 relativeToOriginPosition;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      relativeToOriginPosition = worldPosition.xyz;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("      vWorldPosition = worldPosition;"),i&&s.push("      vFlags = flags;"),s.push("vPickColor = pickColor;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),s.push("float tmp = clipPos.w;"),s.push("clipPos.xyzw /= tmp;"),s.push("clipPos.xy = remapClipPos(clipPos.xy);"),s.push("clipPos.xyzw *= tmp;"),s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),s.push("gl_Position = clipPos;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const i=this._scene._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// VBO SnapBatchingDepthBufInitRenderer fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;"),t.push("uniform int layerNumber;"),t.push("uniform vec3 coordinateScaler;"),t.push("in vec4 vWorldPosition;"),t.push("flat in vec4 vPickColor;"),s){t.push("in float vFlags;");for(let n=0;n<i.getNumAllocatedSectionPlanes();n++)t.push("uniform bool sectionPlaneActive"+n+";"),t.push("uniform vec3 sectionPlanePos"+n+";"),t.push("uniform vec3 sectionPlaneDir"+n+";")}if(t.push("in highp vec3 relativeToOriginPosition;"),t.push("layout(location = 0) out highp ivec4 outCoords;"),t.push("layout(location = 1) out highp ivec4 outNormal;"),t.push("layout(location = 2) out lowp uvec4 outPickColor;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("      float dist = 0.0;");for(var o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("      if (sectionPlaneActive"+o+") {"),t.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("      }");t.push("      if (dist > 0.0) { discard; }"),t.push("  }")}return t.push("    float dx = dFdx(vFragDepth);"),t.push("    float dy = dFdy(vFragDepth);"),t.push("    float diff = sqrt(dx*dx+dy*dy);"),t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),t.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),t.push("vec3 xTangent = dFdx( vWorldPosition.xyz );"),t.push("vec3 yTangent = dFdy( vWorldPosition.xyz );"),t.push("vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),t.push(`outNormal = ivec4(worldNormal * float(${c.MAX_INT}), 1.0);`),t.push("outPickColor = uvec4(vPickColor);"),t.push("}"),t}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Wv=c.vec3(),Xv=c.vec3(),Yv=c.vec3(),$v=c.vec3(),Zv=c.mat4();class qv extends zt{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,i,s){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const t=i.model,o=t.scene,n=o.camera,a=o.canvas.gl,A=i._state,l=i._state.origin,{position:h,rotationMatrix:d,rotationMatrixConjugate:f}=t,m=i.aabb,_=e.pickViewMatrix||n.viewMatrix;this._vaoCache.has(i)?a.bindVertexArray(this._vaoCache.get(i)):this._vaoCache.set(i,this._makeVAO(A));const u=Wv;u[0]=c.safeInv(m[3]-m[0])*c.MAX_INT,u[1]=c.safeInv(m[4]-m[1])*c.MAX_INT,u[2]=c.safeInv(m[5]-m[2])*c.MAX_INT,e.snapPickCoordinateScale[0]=c.safeInv(u[0]),e.snapPickCoordinateScale[1]=c.safeInv(u[1]),e.snapPickCoordinateScale[2]=c.safeInv(u[2]);let P,y;if(l||h[0]!==0||h[1]!==0||h[2]!==0){const v=Xv;if(l){const w=Yv;c.transformPoint3(d,l,w),v[0]=w[0],v[1]=w[1],v[2]=w[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=h[0],v[1]+=h[1],v[2]+=h[2],P=ft(_,v,Zv),y=$v,y[0]=n.eye[0]-v[0],y[1]=n.eye[1]-v[1],y[2]=n.eye[2]-v[2],e.snapPickOrigin[0]=v[0],e.snapPickOrigin[1]=v[1],e.snapPickOrigin[2]=v[2]}else P=_,y=n.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;a.uniform3fv(this._uCameraEyeRtc,y),a.uniform2fv(this.uVectorA,e.snapVectorA),a.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),a.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),a.uniform3fv(this._uCoordinateScaler,u),a.uniform1i(this._uRenderPass,s),a.uniform1i(this._uPickInvisible,e.pickInvisible);let x=0;const B=4*4;this._matricesUniformBlockBufferData.set(f,0),this._matricesUniformBlockBufferData.set(P,x+=B),this._matricesUniformBlockBufferData.set(n.projMatrix,x+=B),this._matricesUniformBlockBufferData.set(A.positionsDecodeMatrix,x+=B),a.bindBuffer(a.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),a.bufferData(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,a.DYNAMIC_DRAW),a.bindBufferBase(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const v=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,v)}this.setSectionPlanesStateUniforms(i),e.snapMode==="edge"?(A.indicesBuf.bind(),a.drawElements(a.LINES,A.indicesBuf.numItems,A.indicesBuf.itemType,0),A.indicesBuf.unbind()):a.drawArrays(a.POINTS,0,A.positionsBuf.numItems)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0;e.pointsMaterial._state;const s=[];return s.push("#version 300 es"),s.push("// SnapBatchingDepthRenderer vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),s.push("uniform vec3 uCameraEyeRtc;"),s.push("uniform vec2 snapVectorA;"),s.push("uniform vec2 snapInvVectorAB;"),s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;"),s.push("vec2 remapClipPos(vec2 clipPos) {"),s.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),s.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),s.push("    return vec2(x, y);"),s.push("}"),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out highp vec3 relativeToOriginPosition;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("relativeToOriginPosition = worldPosition.xyz;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),s.push("float tmp = clipPos.w;"),s.push("clipPos.xyzw /= tmp;"),s.push("clipPos.xy = remapClipPos(clipPos.xy);"),s.push("clipPos.xyzw *= tmp;"),s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),s.push("gl_Position = clipPos;"),s.push("gl_PointSize = 1.0;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const i=this._scene._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// SnapBatchingDepthRenderer fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;"),t.push("uniform int layerNumber;"),t.push("uniform vec3 coordinateScaler;"),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let n=0;n<i.getNumAllocatedSectionPlanes();n++)t.push("uniform bool sectionPlaneActive"+n+";"),t.push("uniform vec3 sectionPlanePos"+n+";"),t.push("uniform vec3 sectionPlaneDir"+n+";")}if(t.push("in highp vec3 relativeToOriginPosition;"),t.push("out highp ivec4 outCoords;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("      float dist = 0.0;");for(var o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("      if (sectionPlaneActive"+o+") {"),t.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("      }");t.push("      if (dist > 0.0) { discard; }"),t.push("  }")}return t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),t.push("}"),t}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class Jv{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new Nv(this._scene,!1)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Qv(this._scene)),this._silhouetteRenderer}get snapInitRenderer(){return this._snapInitRenderer||(this._snapInitRenderer=new Kv(this._scene,!1)),this._snapInitRenderer}get snapRenderer(){return this._snapRenderer||(this._snapRenderer=new qv(this._scene)),this._snapRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}const Ua={};function eP(r){const e=r.id;let i=Ua[e];return i||(i=new Jv(r),Ua[e]=i,i._compile(),r.on("compile",()=>{i._compile()}),r.on("destroyed",()=>{delete Ua[e],i._destroy()})),i}class tP{constructor(e=5e6){e>5e6&&(e=5e6),this.maxVerts=e,this.maxIndices=e*3,this.positions=[],this.colors=[],this.offsets=[],this.indices=[]}}class iP{constructor(e){console.info("Creating VBOBatchingLinesLayer"),this.layerIndex=e.layerIndex,this._renderers=eP(e.model.scene),this.model=e.model,this._buffer=new tP(e.maxGeometryBatchSize),this._scratchMemory=e.scratchMemory,this._state=new Ft({positionsBuf:null,offsetsBuf:null,colorsBuf:null,flagsBuf:null,indicesBuf:null,positionsDecodeMatrix:c.mat4(),origin:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=c.collapseAABB3(),this._portions=[],this._meshes=[],this._numVerts=0,this._aabb=c.collapseAABB3(),this.aabbDirty=!0,this._finalized=!1,e.positionsDecodeMatrix?(this._state.positionsDecodeMatrix.set(e.positionsDecodeMatrix),this._preCompressedPositionsExpected=!0):this._preCompressedPositionsExpected=!1,e.origin&&(this._state.origin=c.vec3(e.origin))}get aabb(){if(this.aabbDirty){c.collapseAABB3(this._aabb);for(let e=0,i=this._meshes.length;e<i;e++)c.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}canCreatePortion(e,i){if(this._finalized)throw"Already finalized";return this._buffer.positions.length+e<this._buffer.maxVerts*3&&this._buffer.indices.length+i<this._buffer.maxIndices}createPortion(e,i){if(this._finalized)throw"Already finalized";const s=i.positions,t=i.positionsCompressed,o=i.indices,n=i.color,a=i.opacity,A=this._buffer,h=A.positions.length/3;let d;if(c.expandAABB3(this._modelAABB,i.aabb),this._preCompressedPositionsExpected){if(!t)throw"positionsCompressed expected";d=t.length/3;for(let m=0,_=t.length;m<_;m++)A.positions.push(t[m])}else{if(!s)throw"positions expected";d=s.length/3;for(let m=0,_=s.length;m<_;m++)A.positions.push(s[m])}if(n){const m=n[0],_=n[1],u=n[2],P=a;for(let y=0;y<d;y++)A.colors.push(m),A.colors.push(_),A.colors.push(u),A.colors.push(P)}if(o)for(let m=0,_=o.length;m<_;m++)A.indices.push(o[m]+h);if(this.model.scene.entityOffsetsEnabled)for(let m=0;m<d;m++)A.offsets.push(0),A.offsets.push(0),A.offsets.push(0);const f=this._portions.length/2;return this._portions.push(h),this._portions.push(d),this._numPortions++,this.model.numPortions++,this._numVerts+=d,this._meshes.push(e),f}finalize(){if(this._finalized)return;const e=this._state,i=this.model.scene.canvas.gl,s=this._buffer;if(s.positions.length>0)if(this._preCompressedPositionsExpected){const t=new Uint16Array(s.positions);e.positionsBuf=new Ee(i,i.ARRAY_BUFFER,t,s.positions.length,3,i.STATIC_DRAW)}else{const t=new Float32Array(s.positions),o=oo(t,this._modelAABB,e.positionsDecodeMatrix);e.positionsBuf=new Ee(i,i.ARRAY_BUFFER,o,s.positions.length,3,i.STATIC_DRAW)}if(s.colors.length>0){const t=new Uint8Array(s.colors);let o=!1;e.colorsBuf=new Ee(i,i.ARRAY_BUFFER,t,s.colors.length,4,i.DYNAMIC_DRAW,o)}if(s.colors.length>0){const t=s.colors.length/4,o=new Float32Array(t);let n=!1;e.flagsBuf=new Ee(i,i.ARRAY_BUFFER,o,o.length,1,i.DYNAMIC_DRAW,n)}if(this.model.scene.entityOffsetsEnabled&&s.offsets.length>0){const t=new Float32Array(s.offsets);e.offsetsBuf=new Ee(i,i.ARRAY_BUFFER,t,s.offsets.length,3,i.DYNAMIC_DRAW)}if(s.indices.length>0){const t=new Uint32Array(s.indices);e.indicesBuf=new Ee(i,i.ELEMENT_ARRAY_BUFFER,t,s.indices.length,1,i.STATIC_DRAW)}this._buffer=null,this._finalized=!0}initFlags(e,i,s){i&k.VISIBLE&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),i&k.HIGHLIGHTED&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),i&k.XRAYED&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),i&k.SELECTED&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),i&k.CLIPPABLE&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),i&k.EDGES&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),i&k.PICKABLE&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),i&k.CULLED&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),s&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,i,s,!0)}flushInitFlags(){this._setDeferredFlags()}setVisible(e,i,s){if(!this._finalized)throw"Not finalized";i&k.VISIBLE?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,i,s)}setHighlighted(e,i,s){if(!this._finalized)throw"Not finalized";i&k.HIGHLIGHTED?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,i,s)}setXRayed(e,i,s){if(!this._finalized)throw"Not finalized";i&k.XRAYED?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,i,s)}setSelected(e,i,s){if(!this._finalized)throw"Not finalized";i&k.SELECTED?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,i,s)}setEdges(e,i,s){if(!this._finalized)throw"Not finalized";i&k.EDGES?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,i,s)}setClippable(e,i){if(!this._finalized)throw"Not finalized";i&k.CLIPPABLE?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,i)}setCulled(e,i,s){if(!this._finalized)throw"Not finalized";i&k.CULLED?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,i,s)}setCollidable(e,i){if(!this._finalized)throw"Not finalized"}setPickable(e,i,s){if(!this._finalized)throw"Not finalized";i&k.PICKABLE?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,i,s)}setColor(e,i){if(!this._finalized)throw"Not finalized";const s=e*2,t=this._portions[s],o=this._portions[s+1],n=t*4,a=o*4,A=this._scratchMemory.getUInt8Array(a),l=i[0],h=i[1],d=i[2],f=i[3];for(let m=0;m<a;m+=4)A[m+0]=l,A[m+1]=h,A[m+2]=d,A[m+3]=f;this._state.colorsBuf.setData(A,n,a)}setTransparent(e,i,s){s?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,i,s)}_setFlags(e,i,s,t=!1){if(!this._finalized)throw"Not finalized";const o=e*2,n=this._portions[o],a=this._portions[o+1],A=n,l=a,h=!!(i&k.VISIBLE),d=!!(i&k.XRAYED),f=!!(i&k.HIGHLIGHTED),m=!!(i&k.SELECTED),_=!!(i&k.PICKABLE),u=!!(i&k.CULLED);let P;!h||u||d||f&&!this.model.scene.highlightMaterial.glowThrough||m&&!this.model.scene.selectedMaterial.glowThrough?P=U.NOT_RENDERED:s?P=U.COLOR_TRANSPARENT:P=U.COLOR_OPAQUE;let y;!h||u?y=U.NOT_RENDERED:m?y=U.SILHOUETTE_SELECTED:f?y=U.SILHOUETTE_HIGHLIGHTED:d?y=U.SILHOUETTE_XRAYED:y=U.NOT_RENDERED;let x=h&&!u&&_?U.PICK:U.NOT_RENDERED;const B=i&k.CLIPPABLE?1:0;if(t){this._deferredFlagValues||(this._deferredFlagValues=new Float32Array(this._numVerts));for(let v=A,w=A+l;v<w;v++){let C=0;C|=P,C|=y<<4,C|=x<<12,C|=B<<16,this._deferredFlagValues[v]=C}}else if(this._state.flagsBuf){const v=this._scratchMemory.getFloat32Array(l);for(let w=0;w<l;w++){let C=0;C|=P,C|=y<<4,C|=x<<12,C|=B<<16,v[w]=C}this._state.flagsBuf.setData(v,A,l)}}_setDeferredFlags(){this._deferredFlagValues&&(this._state.flagsBuf.setData(this._deferredFlagValues),this._deferredFlagValues=null)}setOffset(e,i){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled){this.model.error("Entity#offset not enabled for this Viewer");return}const s=e*2,t=this._portions[s],o=this._portions[s+1],n=t*3,a=o*3,A=this._scratchMemory.getFloat32Array(a),l=i[0],h=i[1],d=i[2];for(let f=0;f<a;f+=3)A[f+0]=l,A[f+1]=h,A[f+2]=d;this._state.offsetsBuf.setData(A,n,a)}drawColorOpaque(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(i,this,U.COLOR_OPAQUE)}drawColorTransparent(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===0||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(i,this,U.COLOR_TRANSPARENT)}drawDepth(e,i){}drawNormals(e,i){}drawSilhouetteXRayed(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(i,this,U.SILHOUETTE_XRAYED)}drawSilhouetteHighlighted(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(i,this,U.SILHOUETTE_HIGHLIGHTED)}drawSilhouetteSelected(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(i,this,U.SILHOUETTE_SELECTED)}drawEdgesColorOpaque(e,i){}drawEdgesColorTransparent(e,i){}drawEdgesHighlighted(e,i){}drawEdgesSelected(e,i){}drawEdgesXRayed(e,i){}drawPickMesh(e){}drawPickDepths(e){}drawPickNormals(e){}drawSnapInit(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(i,this,U.PICK)}drawSnap(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(i,this,U.PICK)}drawOcclusion(e){}drawShadow(e){}destroy(){const e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.indicesBuf&&(e.indicesBuf.destroy(),e.indicesBuf=null),e.destroy()}}class Mp extends zt{constructor(e,i){super(e,i,{instancing:!0})}_draw(e){const{gl:i}=this._scene.canvas,{state:s,frameCtx:t,incrementDrawState:o}=e;i.drawElementsInstanced(i.LINES,s.indicesBuf.numItems,s.indicesBuf.itemType,0,s.numInstances),o&&t.drawElements++}}class sP extends Mp{drawLayer(e,i,s){super.drawLayer(e,i,s,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=[];return t.push("#version 300 es"),t.push("// Lines instancing color vertex shader"),t.push("uniform int renderPass;"),t.push("in vec3 position;"),t.push("in vec4 color;"),t.push("in float flags;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),t.push("in vec4 modelMatrixCol0;"),t.push("in vec4 modelMatrixCol1;"),t.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(t),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("out float vFragDepth;")),t.push("uniform vec4 lightAmbient;"),s&&(t.push("out vec4 vWorldPosition;"),t.push("out float vFlags;")),t.push("out vec4 vColor;"),t.push("void main(void) {"),t.push("int colorFlag = int(flags) & 0xF;"),t.push("if (colorFlag != renderPass) {"),t.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("} else {"),t.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),t.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&t.push("      worldPosition.xyz = worldPosition.xyz + offset;"),t.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0,  float(color.a) / 255.0);"),s&&(t.push("vWorldPosition = worldPosition;"),t.push("vFlags = flags;")),t.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&t.push("vFragDepth = 1.0 + clipPos.w;"),t.push("gl_Position = clipPos;"),t.push("}"),t.push("}"),t}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState;let s,t;const o=i.getNumAllocatedSectionPlanes()>0,n=[];if(n.push("#version 300 es"),n.push("// Lines instancing color fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),o)for(n.push("in vec4 vWorldPosition;"),n.push("in float vFlags;"),s=0,t=i.getNumAllocatedSectionPlanes();s<t;s++)n.push("uniform bool sectionPlaneActive"+s+";"),n.push("uniform vec3 sectionPlanePos"+s+";"),n.push("uniform vec3 sectionPlaneDir"+s+";");if(n.push("in vec4 vColor;"),n.push("out vec4 outColor;"),n.push("void main(void) {"),o){for(n.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;"),s=0,t=i.getNumAllocatedSectionPlanes();s<t;s++)n.push("if (sectionPlaneActive"+s+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),n.push("}");n.push("if (dist > 0.0) { discard; }"),n.push("}")}return this._withSAO?(n.push("   float viewportWidth     = uSAOParams[0];"),n.push("   float viewportHeight    = uSAOParams[1];"),n.push("   float blendCutoff       = uSAOParams[2];"),n.push("   float blendFactor       = uSAOParams[3];"),n.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),n.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBAToDepth(texture(uOcclusionTexture, uv))) * blendFactor;"),n.push("   outColor            = vec4(vColor.rgb * ambient, vColor.a);")):n.push("    outColor           = vColor;"),e.logarithmicDepthBufferEnabled&&n.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("}"),n}}class rP extends Mp{drawLayer(e,i,s){super.drawLayer(e,i,s,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=[];return t.push("#version 300 es"),t.push("// Lines instancing silhouette vertex shader"),t.push("uniform int renderPass;"),t.push("in vec3 position;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),t.push("in float flags;"),t.push("in vec4 modelMatrixCol0;"),t.push("in vec4 modelMatrixCol1;"),t.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(t),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("out float vFragDepth;")),t.push("uniform vec4 color;"),s&&(t.push("out vec4 vWorldPosition;"),t.push("out float vFlags;")),t.push("void main(void) {"),t.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),t.push("if (silhouetteFlag != renderPass) {"),t.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("} else {"),t.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),t.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&t.push("      worldPosition.xyz = worldPosition.xyz + offset;"),t.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s&&(t.push("vWorldPosition = worldPosition;"),t.push("vFlags = flags;")),t.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&t.push("vFragDepth = 1.0 + clipPos.w;"),t.push("gl_Position = clipPos;"),t.push("}"),t.push("}"),t}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Lines instancing silhouette fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("uniform vec4 color;"),t.push("out vec4 outColor;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("if (dist > 0.0) { discard; }"),t.push("}")}return e.logarithmicDepthBufferEnabled&&t.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("outColor = color;"),t.push("}"),t}}const oP=c.vec3(),nP=c.vec3(),aP=c.vec3();c.vec3();const AP=c.mat4();class xh extends zt{constructor(e){super(e,!1,{instancing:!0})}drawLayer(e,i,s){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const t=i.model,o=t.scene,n=o.canvas.gl,a=o.camera,A=i._state,l=i._state.origin,{position:h,rotationMatrix:d,rotationMatrixConjugate:f}=t,m=i.aabb,_=e.pickViewMatrix||a.viewMatrix;this._vaoCache.has(i)?n.bindVertexArray(this._vaoCache.get(i)):this._vaoCache.set(i,this._makeVAO(A));const u=oP;u[0]=c.safeInv(m[3]-m[0])*c.MAX_INT,u[1]=c.safeInv(m[4]-m[1])*c.MAX_INT,u[2]=c.safeInv(m[5]-m[2])*c.MAX_INT,e.snapPickCoordinateScale[0]=c.safeInv(u[0]),e.snapPickCoordinateScale[1]=c.safeInv(u[1]),e.snapPickCoordinateScale[2]=c.safeInv(u[2]);let P;if(l||h[0]!==0||h[1]!==0||h[2]!==0){const B=nP;if(l){const v=c.transformPoint3(d,l,aP);B[0]=v[0],B[1]=v[1],B[2]=v[2]}else B[0]=0,B[1]=0,B[2]=0;B[0]+=h[0],B[1]+=h[1],B[2]+=h[2],P=ft(_,B,AP),e.snapPickOrigin[0]=B[0],e.snapPickOrigin[1]=B[1],e.snapPickOrigin[2]=B[2]}else P=_,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;n.uniform2fv(this.uVectorA,e.snapVectorA),n.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),n.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),n.uniform3fv(this._uCoordinateScaler,u),n.uniform1i(this._uRenderPass,s),n.uniform1i(this._uPickInvisible,e.pickInvisible);let y=0;const x=4*4;this._matricesUniformBlockBufferData.set(f,0),this._matricesUniformBlockBufferData.set(P,y+=x),this._matricesUniformBlockBufferData.set(a.projMatrix,y+=x),this._matricesUniformBlockBufferData.set(A.positionsDecodeMatrix,y+=x),n.bindBuffer(n.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),n.bufferData(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,n.DYNAMIC_DRAW),n.bindBufferBase(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const B=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,B)}this.setSectionPlanesStateUniforms(i),this._aModelMatrixCol0.bindArrayBuffer(A.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(A.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(A.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aFlags&&(this._aFlags.bindArrayBuffer(A.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1)),A.indicesBuf.bind(),n.drawElementsInstanced(n.LINES,A.indicesBuf.numItems,A.indicesBuf.itemType,0,A.numInstances),A.indicesBuf.unbind(),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),this._aFlags&&n.vertexAttribDivisor(this._aFlags.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=[];return t.push("#version 300 es"),t.push("// SnapInstancingDepthBufInitRenderer vertex shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("precision highp usampler2D;"),t.push("precision highp isampler2D;"),t.push("precision highp sampler2D;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("precision mediump usampler2D;"),t.push("precision mediump isampler2D;"),t.push("precision mediump sampler2D;"),t.push("#endif"),t.push("uniform int renderPass;"),t.push("in vec4 pickColor;"),t.push("in vec3 position;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),t.push("in float flags;"),t.push("in vec4 modelMatrixCol0;"),t.push("in vec4 modelMatrixCol1;"),t.push("in vec4 modelMatrixCol2;"),t.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(t),t.push("uniform vec2 snapVectorA;"),t.push("uniform vec2 snapInvVectorAB;"),t.push("uniform float logDepthBufFC;"),t.push("out float vFragDepth;"),t.push("bool isPerspectiveMatrix(mat4 m) {"),t.push("    return (m[2][3] == - 1.0);"),t.push("}"),t.push("out float isPerspective;"),t.push("vec2 remapClipPos(vec2 clipPos) {"),t.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),t.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),t.push("    return vec2(x, y);"),t.push("}"),t.push("flat out vec4 vPickColor;"),t.push("out vec4 vWorldPosition;"),s&&t.push("out float vFlags;"),t.push("out highp vec3 relativeToOriginPosition;"),t.push("void main(void) {"),t.push("int pickFlag = int(flags) >> 12 & 0xF;"),t.push("if (pickFlag != renderPass) {"),t.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("} else {"),t.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),t.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&t.push("      worldPosition.xyz = worldPosition.xyz + offset;"),t.push("relativeToOriginPosition = worldPosition.xyz;"),t.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t.push("  vWorldPosition = worldPosition;"),s&&t.push("  vFlags = flags;"),t.push("vPickColor = pickColor;"),t.push("vec4 clipPos = projMatrix * viewPosition;"),t.push("float tmp = clipPos.w;"),t.push("clipPos.xyzw /= tmp;"),t.push("clipPos.xy = remapClipPos(clipPos.xy);"),t.push("clipPos.xyzw *= tmp;"),t.push("vFragDepth = 1.0 + clipPos.w;"),t.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),t.push("gl_Position = clipPos;"),t.push("}"),t.push("}"),t}_buildFragmentShader(){const i=this._scene._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Points instancing pick depth fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;"),t.push("uniform int layerNumber;"),t.push("uniform vec3 coordinateScaler;"),t.push("in vec4 vWorldPosition;"),t.push("flat in vec4 vPickColor;"),s){t.push("in float vFlags;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("in highp vec3 relativeToOriginPosition;"),t.push("layout(location = 0) out highp ivec4 outCoords;"),t.push("layout(location = 2) out lowp uvec4 outPickColor;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("if (dist > 0.0) { discard; }"),t.push("}")}return t.push("    float dx = dFdx(vFragDepth);"),t.push("    float dy = dFdy(vFragDepth);"),t.push("    float diff = sqrt(dx*dx+dy*dy);"),t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),t.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),t.push("outPickColor = uvec4(vPickColor);"),t.push("}"),t}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const lP=c.vec3(),cP=c.vec3(),hP=c.vec3();c.vec3();const uP=c.mat4();class wh extends zt{constructor(e){super(e,!1,{instancing:!0})}drawLayer(e,i,s){if(!this._program&&(this._allocate(i),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const t=i.model,o=t.scene,n=o.camera,a=o.canvas.gl,A=i._state,l=i._state.origin,{position:h,rotationMatrix:d,rotationMatrixConjugate:f}=t,m=i.aabb,_=e.pickViewMatrix||n.viewMatrix;this._vaoCache.has(i)?a.bindVertexArray(this._vaoCache.get(i)):this._vaoCache.set(i,this._makeVAO(A));const u=lP;u[0]=c.safeInv(m[3]-m[0])*c.MAX_INT,u[1]=c.safeInv(m[4]-m[1])*c.MAX_INT,u[2]=c.safeInv(m[5]-m[2])*c.MAX_INT,e.snapPickCoordinateScale[0]=c.safeInv(u[0]),e.snapPickCoordinateScale[1]=c.safeInv(u[1]),e.snapPickCoordinateScale[2]=c.safeInv(u[2]);let P;if(l||h[0]!==0||h[1]!==0||h[2]!==0){const B=cP;if(l){const v=c.transformPoint3(d,l,hP);B[0]=v[0],B[1]=v[1],B[2]=v[2]}else B[0]=0,B[1]=0,B[2]=0;B[0]+=h[0],B[1]+=h[1],B[2]+=h[2],P=ft(_,B,uP),e.snapPickOrigin[0]=B[0],e.snapPickOrigin[1]=B[1],e.snapPickOrigin[2]=B[2]}else P=_,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;a.uniform2fv(this.uVectorA,e.snapVectorA),a.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),a.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),a.uniform3fv(this._uCoordinateScaler,u),a.uniform1i(this._uRenderPass,s),a.uniform1i(this._uPickInvisible,e.pickInvisible);let y=0;const x=4*4;this._matricesUniformBlockBufferData.set(f,0),this._matricesUniformBlockBufferData.set(P,y+=x),this._matricesUniformBlockBufferData.set(n.projMatrix,y+=x),this._matricesUniformBlockBufferData.set(A.positionsDecodeMatrix,y+=x),a.bindBuffer(a.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),a.bufferData(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,a.DYNAMIC_DRAW),a.bindBufferBase(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const B=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,B)}this.setSectionPlanesStateUniforms(i),this._aModelMatrixCol0.bindArrayBuffer(A.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(A.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(A.modelMatrixCol2Buf),a.vertexAttribDivisor(this._aModelMatrixCol0.location,1),a.vertexAttribDivisor(this._aModelMatrixCol1.location,1),a.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aFlags.bindArrayBuffer(A.flagsBuf),a.vertexAttribDivisor(this._aFlags.location,1),e.snapMode==="edge"?(A.indicesBuf.bind(),a.drawElementsInstanced(a.LINES,A.indicesBuf.numItems,A.indicesBuf.itemType,0,A.numInstances),A.indicesBuf.unbind()):a.drawArraysInstanced(a.POINTS,0,A.positionsBuf.numItems,A.numInstances),a.vertexAttribDivisor(this._aModelMatrixCol0.location,0),a.vertexAttribDivisor(this._aModelMatrixCol1.location,0),a.vertexAttribDivisor(this._aModelMatrixCol2.location,0),a.vertexAttribDivisor(this._aFlags.location,0),this._aOffset&&a.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=[];return t.push("#version 300 es"),t.push("// SnapInstancingDepthRenderer vertex shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("precision highp usampler2D;"),t.push("precision highp isampler2D;"),t.push("precision highp sampler2D;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("precision mediump usampler2D;"),t.push("precision mediump isampler2D;"),t.push("precision mediump sampler2D;"),t.push("#endif"),t.push("uniform int renderPass;"),t.push("in vec3 position;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),t.push("in float flags;"),t.push("in vec4 modelMatrixCol0;"),t.push("in vec4 modelMatrixCol1;"),t.push("in vec4 modelMatrixCol2;"),t.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(t),t.push("uniform vec2 snapVectorA;"),t.push("uniform vec2 snapInvVectorAB;"),t.push("uniform float logDepthBufFC;"),t.push("out float vFragDepth;"),t.push("bool isPerspectiveMatrix(mat4 m) {"),t.push("    return (m[2][3] == - 1.0);"),t.push("}"),t.push("out float isPerspective;"),t.push("vec2 remapClipPos(vec2 clipPos) {"),t.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),t.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),t.push("    return vec2(x, y);"),t.push("}"),s&&(t.push("out vec4 vWorldPosition;"),t.push("out float vFlags;")),t.push("out highp vec3 relativeToOriginPosition;"),t.push("void main(void) {"),t.push("int pickFlag = int(flags) >> 12 & 0xF;"),t.push("if (pickFlag != renderPass) {"),t.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("} else {"),t.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),t.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&t.push("      worldPosition.xyz = worldPosition.xyz + offset;"),t.push("relativeToOriginPosition = worldPosition.xyz;"),t.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s&&(t.push("  vWorldPosition = worldPosition;"),t.push("  vFlags = flags;")),t.push("vec4 clipPos = projMatrix * viewPosition;"),t.push("float tmp = clipPos.w;"),t.push("clipPos.xyzw /= tmp;"),t.push("clipPos.xy = remapClipPos(clipPos.xy);"),t.push("clipPos.xyzw *= tmp;"),t.push("vFragDepth = 1.0 + clipPos.w;"),t.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),t.push("gl_Position = clipPos;"),t.push("gl_PointSize = 1.0;"),t.push("}"),t.push("}"),t}_buildFragmentShader(){const i=this._scene._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// SnapInstancingDepthRenderer fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;"),t.push("uniform int layerNumber;"),t.push("uniform vec3 coordinateScaler;"),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("in highp vec3 relativeToOriginPosition;"),t.push("out highp ivec4 outCoords;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("if (dist > 0.0) { discard; }"),t.push("}")}return t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),t.push("}"),t}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class dP{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}eagerCreateRenders(){this._snapInitRenderer||(this._snapInitRenderer=new xh(this._scene,!1)),this._snapRenderer||(this._snapRenderer=new wh(this._scene))}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new sP(this._scene)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new rP(this._scene)),this._silhouetteRenderer}get snapInitRenderer(){return this._snapInitRenderer||(this._snapInitRenderer=new xh(this._scene,!1)),this._snapInitRenderer}get snapRenderer(){return this._snapRenderer||(this._snapRenderer=new wh(this._scene)),this._snapRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}const Oa={};function pP(r){const e=r.id;let i=Oa[e];return i||(i=new dP(r),Oa[e]=i,i._compile(),r.on("compile",()=>{i._compile()}),r.on("destroyed",()=>{delete Oa[e],i._destroy()})),i}const Ir=new Uint8Array(4),bh=new Float32Array(1),ko=new Float32Array(3),ii=new Float32Array(4);class fP{constructor(e){console.info("VBOInstancingLinesLayer"),this.model=e.model,this.material=e.material,this.sortId="LinesInstancingLayer",this.layerIndex=e.layerIndex,this._renderers=pP(e.model.scene),this._aabb=c.collapseAABB3(),this._state=new Ft({obb:c.OBB3(),numInstances:0,origin:null,geometry:e.geometry,positionsDecodeMatrix:e.geometry.positionsDecodeMatrix,positionsBuf:null,colorsBuf:null,flagsBuf:null,offsetsBuf:null,modelMatrixCol0Buf:null,modelMatrixCol1Buf:null,modelMatrixCol2Buf:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this.numIndices=e.geometry.numIndices,this._colors=[],this._offsets=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._portions=[],this._meshes=[],this._aabb=c.collapseAABB3(),this.aabbDirty=!0,e.origin&&(this._state.origin=c.vec3(e.origin)),this._finalized=!1}get aabb(){if(this.aabbDirty){c.collapseAABB3(this._aabb);for(let e=0,i=this._meshes.length;e<i;e++)c.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}createPortion(e,i){const s=i.color,t=i.opacity,o=i.meshMatrix;if(this._finalized)throw"Already finalized";const n=s[0],a=s[1],A=s[2];s[3],this._colors.push(n),this._colors.push(a),this._colors.push(A),this._colors.push(t),this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(o[0]),this._modelMatrixCol0.push(o[4]),this._modelMatrixCol0.push(o[8]),this._modelMatrixCol0.push(o[12]),this._modelMatrixCol1.push(o[1]),this._modelMatrixCol1.push(o[5]),this._modelMatrixCol1.push(o[9]),this._modelMatrixCol1.push(o[13]),this._modelMatrixCol2.push(o[2]),this._modelMatrixCol2.push(o[6]),this._modelMatrixCol2.push(o[10]),this._modelMatrixCol2.push(o[14]),this._state.numInstances++;const l=this._portions.length;return this._portions.push({}),this._numPortions++,this.model.numPortions++,this._meshes.push(e),l}finalize(){if(this._finalized)throw"Already finalized";const e=this.model.scene.canvas.gl,i=this._state,s=i.geometry,t=this._colors.length,o=t/4;if(t>0){let n=!1;this._state.colorsBuf=new Ee(e,e.ARRAY_BUFFER,new Uint8Array(this._colors),this._colors.length,4,e.DYNAMIC_DRAW,n),this._colors=[]}if(o>0){let n=!1;this._state.flagsBuf=new Ee(e,e.ARRAY_BUFFER,new Float32Array(o),o,1,e.DYNAMIC_DRAW,n)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0&&(this._state.offsetsBuf=new Ee(e,e.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,e.DYNAMIC_DRAW,!1),this._offsets=[]),s.colorsCompressed&&s.colorsCompressed.length>0){const n=new Uint8Array(s.colorsCompressed),a=!1;i.colorsBuf=new Ee(e,e.ARRAY_BUFFER,n,n.length,4,e.STATIC_DRAW,a)}s.positionsCompressed&&s.positionsCompressed.length>0&&(i.positionsBuf=new Ee(e,e.ARRAY_BUFFER,s.positionsCompressed,s.positionsCompressed.length,3,e.STATIC_DRAW,!1),i.positionsDecodeMatrix=c.mat4(s.positionsDecodeMatrix)),s.indices&&s.indices.length>0&&(i.indicesBuf=new Ee(e,e.ELEMENT_ARRAY_BUFFER,new Uint32Array(s.indices),s.indices.length,1,e.STATIC_DRAW),i.numIndices=s.indices.length),this._modelMatrixCol0.length>0&&(this._state.modelMatrixCol0Buf=new Ee(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,e.STATIC_DRAW,!1),this._state.modelMatrixCol1Buf=new Ee(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,e.STATIC_DRAW,!1),this._state.modelMatrixCol2Buf=new Ee(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,e.STATIC_DRAW,!1),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[]),this._state.geometry=null,this._finalized=!0}initFlags(e,i,s){i&k.VISIBLE&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),i&k.HIGHLIGHTED&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),i&k.XRAYED&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),i&k.SELECTED&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),i&k.CLIPPABLE&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),i&k.EDGES&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),i&k.PICKABLE&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),i&k.CULLED&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),s&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,i,s)}setVisible(e,i,s){if(!this._finalized)throw"Not finalized";i&k.VISIBLE?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,i,s)}setHighlighted(e,i,s){if(!this._finalized)throw"Not finalized";i&k.HIGHLIGHTED?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,i,s)}setXRayed(e,i,s){if(!this._finalized)throw"Not finalized";i&k.XRAYED?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,i,s)}setSelected(e,i,s){if(!this._finalized)throw"Not finalized";i&k.SELECTED?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,i,s)}setEdges(e,i,s){if(!this._finalized)throw"Not finalized";i&k.EDGES?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,i,s)}setClippable(e,i){if(!this._finalized)throw"Not finalized";i&k.CLIPPABLE?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,i)}setCollidable(e,i){if(!this._finalized)throw"Not finalized"}setPickable(e,i,s){if(!this._finalized)throw"Not finalized";i&k.PICKABLE?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,i,s)}setCulled(e,i,s){if(!this._finalized)throw"Not finalized";i&k.CULLED?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,i,s)}setColor(e,i){if(!this._finalized)throw"Not finalized";Ir[0]=i[0],Ir[1]=i[1],Ir[2]=i[2],Ir[3]=i[3],this._state.colorsBuf.setData(Ir,e*4,4)}setTransparent(e,i,s){s?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,i,s)}_setFlags(e,i,s){if(!this._finalized)throw"Not finalized";const t=!!(i&k.VISIBLE),o=!!(i&k.XRAYED),n=!!(i&k.HIGHLIGHTED),a=!!(i&k.SELECTED),A=!!(i&k.EDGES),l=!!(i&k.PICKABLE),h=!!(i&k.CULLED);let d;!t||h||o||n&&!this.model.scene.highlightMaterial.glowThrough||a&&!this.model.scene.selectedMaterial.glowThrough?d=U.NOT_RENDERED:s?d=U.COLOR_TRANSPARENT:d=U.COLOR_OPAQUE;let f;!t||h?f=U.NOT_RENDERED:a?f=U.SILHOUETTE_SELECTED:n?f=U.SILHOUETTE_HIGHLIGHTED:o?f=U.SILHOUETTE_XRAYED:f=U.NOT_RENDERED;let m=0;!t||h?m=U.NOT_RENDERED:a?m=U.EDGES_SELECTED:n?m=U.EDGES_HIGHLIGHTED:o?m=U.EDGES_XRAYED:A?s?m=U.EDGES_COLOR_TRANSPARENT:m=U.EDGES_COLOR_OPAQUE:m=U.NOT_RENDERED;let _=t&&!h&&l?U.PICK:U.NOT_RENDERED;const u=i&k.CLIPPABLE?255:0;let P=0;P|=d,P|=f<<4,P|=m<<8,P|=_<<12,P|=u<<16,bh[0]=P,this._state.flagsBuf.setData(bh,e)}setOffset(e,i){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled){this.model.error("Entity#offset not enabled for this Viewer");return}ko[0]=i[0],ko[1]=i[1],ko[2]=i[2],this._state.offsetsBuf.setData(ko,e*3,3)}setMatrix(e,i){if(!this._finalized)throw"Not finalized";const s=e*4;ii[0]=i[0],ii[1]=i[4],ii[2]=i[8],ii[3]=i[12],this._state.modelMatrixCol0Buf.setData(ii,s),ii[0]=i[1],ii[1]=i[5],ii[2]=i[9],ii[3]=i[13],this._state.modelMatrixCol1Buf.setData(ii,s),ii[0]=i[2],ii[1]=i[6],ii[2]=i[10],ii[3]=i[14],this._state.modelMatrixCol2Buf.setData(ii,s)}drawColorOpaque(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(i,this,U.COLOR_OPAQUE)}drawColorTransparent(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===0||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(i,this,U.COLOR_TRANSPARENT)}drawDepth(e,i){}drawNormals(e,i){}drawSilhouetteXRayed(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(i,this,U.SILHOUETTE_XRAYED)}drawSilhouetteHighlighted(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(i,this,U.SILHOUETTE_HIGHLIGHTED)}drawSilhouetteSelected(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(i,this,U.SILHOUETTE_SELECTED)}drawEdgesColorOpaque(e,i){}drawEdgesColorTransparent(e,i){}drawEdgesXRayed(e,i){}drawEdgesHighlighted(e,i){}drawEdgesSelected(e,i){}drawSnapInit(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(i,this,U.PICK)}drawSnap(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(i,this,U.PICK)}drawOcclusion(e,i){}drawShadow(e,i){}drawPickMesh(e,i){}drawPickDepths(e,i){}drawPickNormals(e,i){}destroy(){const e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.modelMatrixCol0Buf&&(e.modelMatrixCol0Buf.destroy(),e.modelMatrixCol0Buf=null),e.modelMatrixCol1Buf&&(e.modelMatrixCol1Buf.destroy(),e.modelMatrixCol1Buf=null),e.modelMatrixCol2Buf&&(e.modelMatrixCol2Buf.destroy(),e.modelMatrixCol2Buf=null),e.destroy()}}class ho extends zt{_draw(e){const{gl:i}=this._scene.canvas,{state:s,frameCtx:t,incrementDrawState:o}=e;i.drawArrays(i.POINTS,0,s.positionsBuf.numItems),o&&t.drawArrays++}}class gP extends ho{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,i,s){super.drawLayer(e,i,s,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=e.pointsMaterial,o=[];return o.push("#version 300 es"),o.push("// Points batching color vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),o.push("in vec4 color;"),o.push("in float flags;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),this._addMatricesUniformBlockLines(o),o.push("uniform float pointSize;"),t.perspectivePoints&&o.push("uniform float nearPlaneHeight;"),t.filterIntensity&&o.push("uniform vec2 intensityRange;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;")),s&&(o.push("out vec4 vWorldPosition;"),o.push("out float vFlags;")),o.push("out vec4 vColor;"),o.push("void main(void) {"),o.push("int colorFlag = int(flags) & 0xF;"),o.push("if (colorFlag != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),t.filterIntensity&&(o.push("float intensity = float(color.a) / 255.0;"),o.push("if (intensity < intensityRange[0] || intensity > intensityRange[1]) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {")),o.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&o.push("worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),o.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, 1.0);"),s&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags = flags;")),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("gl_Position = clipPos;"),t.perspectivePoints?(o.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),o.push("gl_PointSize = max(gl_PointSize, "+Math.floor(t.minPerspectivePointSize)+".0);"),o.push("gl_PointSize = min(gl_PointSize, "+Math.floor(t.maxPerspectivePointSize)+".0);")):o.push("gl_PointSize = pointSize;"),o.push("}"),t.filterIntensity&&o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Points batching color fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("in vec4 vColor;"),t.push("out vec4 outColor;"),t.push("void main(void) {"),e.pointsMaterial.roundPoints&&(t.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),t.push("  float r = dot(cxy, cxy);"),t.push("  if (r > 1.0) {"),t.push("       discard;"),t.push("  }")),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("  if (dist > 0.0) { discard; }"),t.push("}")}return t.push("   outColor = vColor;"),e.logarithmicDepthBufferEnabled&&t.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("}"),t}}class mP extends ho{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,i,s){super.drawLayer(e,i,s,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=e.pointsMaterial._state,o=[];return o.push("#version 300 es"),o.push("// Points batching silhouette vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),o.push("in float flags;"),this._addMatricesUniformBlockLines(o),o.push("uniform vec4 color;"),o.push("uniform float pointSize;"),t.perspectivePoints&&o.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;")),s&&(o.push("out vec4 vWorldPosition;"),o.push("out float vFlags;")),o.push("void main(void) {"),o.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),o.push("if (silhouetteFlag != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&o.push("      worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags = flags;")),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("gl_Position = clipPos;"),t.perspectivePoints?(o.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),o.push("gl_PointSize = max(gl_PointSize, "+Math.floor(t.minPerspectivePointSize)+".0);"),o.push("gl_PointSize = min(gl_PointSize, "+Math.floor(t.maxPerspectivePointSize)+".0);")):o.push("gl_PointSize = pointSize;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState;let s,t;const o=i.getNumAllocatedSectionPlanes()>0,n=[];if(n.push("#version 300 es"),n.push("// Points batching silhouette vertex shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),o)for(n.push("in vec4 vWorldPosition;"),n.push("in float vFlags;"),s=0,t=i.getNumAllocatedSectionPlanes();s<t;s++)n.push("uniform bool sectionPlaneActive"+s+";"),n.push("uniform vec3 sectionPlanePos"+s+";"),n.push("uniform vec3 sectionPlaneDir"+s+";");if(n.push("uniform vec4 color;"),n.push("out vec4 outColor;"),n.push("void main(void) {"),e.pointsMaterial.roundPoints&&(n.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),n.push("  float r = dot(cxy, cxy);"),n.push("  if (r > 1.0) {"),n.push("       discard;"),n.push("  }")),o){for(n.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;"),s=0,t=i.getNumAllocatedSectionPlanes();s<t;s++)n.push("if (sectionPlaneActive"+s+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > 0.0) { discard; }"),n.push("}")}return e.logarithmicDepthBufferEnabled&&n.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("outColor = color;"),n.push("}"),n}}class _P extends ho{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=e.pointsMaterial._state,t=[];return t.push("#version 300 es"),t.push("// Points batching pick mesh vertex shader"),t.push("uniform int renderPass;"),t.push("in vec3 position;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),t.push("in float flags;"),t.push("in vec4 pickColor;"),t.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(t),this._addRemapClipPosLines(t),t.push("uniform float pointSize;"),s.perspectivePoints&&t.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("out float vFragDepth;")),i&&(t.push("out vec4 vWorldPosition;"),t.push("out float vFlags;")),t.push("out vec4 vPickColor;"),t.push("void main(void) {"),t.push("int pickFlag = int(flags) >> 12 & 0xF;"),t.push("if (pickFlag != renderPass) {"),t.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("  } else {"),t.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&t.push("      worldPosition.xyz = worldPosition.xyz + offset;"),t.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t.push("      vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),i&&(t.push("      vWorldPosition = worldPosition;"),t.push("      vFlags = flags;")),t.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&t.push("vFragDepth = 1.0 + clipPos.w;"),t.push("gl_Position = remapClipPos(clipPos);"),s.perspectivePoints?(t.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),t.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),t.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):t.push("gl_PointSize = pointSize;"),t.push("gl_PointSize += 10.0;"),t.push("  }"),t.push("}"),t}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Points batching pick mesh vertex shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(var o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("in vec4 vPickColor;"),t.push("out vec4 outColor;"),t.push("void main(void) {"),e.pointsMaterial.roundPoints&&(t.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),t.push("  float r = dot(cxy, cxy);"),t.push("  if (r > 1.0) {"),t.push("       discard;"),t.push("  }")),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("      float dist = 0.0;");for(let n=0;n<i.getNumAllocatedSectionPlanes();n++)t.push("      if (sectionPlaneActive"+n+") {"),t.push("          dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),t.push("      }");t.push("      if (dist > 0.0) { discard; }"),t.push("  }")}return e.logarithmicDepthBufferEnabled&&t.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("   outColor = vPickColor; "),t.push("}"),t}}class vP extends ho{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=e.pointsMaterial._state,t=[];return t.push("#version 300 es"),t.push("// Points batched pick depth vertex shader"),t.push("uniform int renderPass;"),t.push("in vec3 position;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),t.push("in float flags;"),t.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(t),this._addRemapClipPosLines(t),t.push("uniform float pointSize;"),s.perspectivePoints&&t.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("out float vFragDepth;")),i&&(t.push("out vec4 vWorldPosition;"),t.push("out float vFlags;")),t.push("out vec4 vViewPosition;"),t.push("void main(void) {"),t.push("int pickFlag = int(flags) >> 12 & 0xF;"),t.push("if (pickFlag != renderPass) {"),t.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("  } else {"),t.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&t.push("      worldPosition.xyz = worldPosition.xyz + offset;"),t.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(t.push("      vWorldPosition = worldPosition;"),t.push("      vFlags = flags;")),t.push("vViewPosition = viewPosition;"),t.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&t.push("vFragDepth = 1.0 + clipPos.w;"),t.push("gl_Position = remapClipPos(clipPos);"),s.perspectivePoints?(t.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),t.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),t.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):t.push("gl_PointSize = pointSize;"),t.push("gl_PointSize += 10.0;"),t.push("  }"),t.push("}"),t}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Points batched pick depth fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),t.push("uniform float pickZNear;"),t.push("uniform float pickZFar;"),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let n=0;n<i.getNumAllocatedSectionPlanes();n++)t.push("uniform bool sectionPlaneActive"+n+";"),t.push("uniform vec3 sectionPlanePos"+n+";"),t.push("uniform vec3 sectionPlaneDir"+n+";")}if(t.push("in vec4 vViewPosition;"),t.push("vec4 packDepth(const in float depth) {"),t.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),t.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),t.push("  vec4 res = fract(depth * bitShift);"),t.push("  res -= res.xxyz * bitMask;"),t.push("  return res;"),t.push("}"),t.push("out vec4 outColor;"),t.push("void main(void) {"),e.pointsMaterial.roundPoints&&(t.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),t.push("  float r = dot(cxy, cxy);"),t.push("  if (r > 1.0) {"),t.push("       discard;"),t.push("  }")),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("      float dist = 0.0;");for(var o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("      if (sectionPlaneActive"+o+") {"),t.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("      }");t.push("      if (dist > 0.0) { discard; }"),t.push("  }")}return e.logarithmicDepthBufferEnabled&&t.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),t.push("    outColor = packDepth(zNormalizedDepth); "),t.push("}"),t}}class PP extends ho{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=e.pointsMaterial._state,t=[];return t.push("#version 300 es"),t.push("// Points batching occlusion vertex shader"),t.push("uniform int renderPass;"),t.push("in vec3 position;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),t.push("in float flags;"),this._addMatricesUniformBlockLines(t),t.push("uniform float pointSize;"),s.perspectivePoints&&t.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("out float vFragDepth;")),i&&(t.push("out vec4 vWorldPosition;"),t.push("out float vFlags;")),t.push("void main(void) {"),t.push("int colorFlag = int(flags) & 0xF;"),t.push("if (colorFlag != renderPass) {"),t.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("  } else {"),t.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&t.push("      worldPosition.xyz = worldPosition.xyz + offset;"),t.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(t.push("      vWorldPosition = worldPosition;"),t.push("      vFlags = flags;")),t.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&t.push("vFragDepth = 1.0 + clipPos.w;"),t.push("  gl_Position = clipPos;"),s.perspectivePoints?(t.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),t.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),t.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):t.push("gl_PointSize = pointSize;"),t.push("  }"),t.push("}"),t}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Points batching occlusion fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("out vec4 outColor;"),t.push("void main(void) {"),e.pointsMaterial.roundPoints&&(t.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),t.push("  float r = dot(cxy, cxy);"),t.push("  if (r > 1.0) {"),t.push("       discard;"),t.push("  }")),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("      float dist = 0.0;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("      if (sectionPlaneActive"+o+") {"),t.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("      }");t.push("      if (dist > 0.0) { discard; }"),t.push("  }")}return e.logarithmicDepthBufferEnabled&&t.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),t.push("}"),t}}const BP=c.vec3(),yP=c.vec3(),xP=c.vec3(),wP=c.vec3(),bP=c.mat4();class CP extends zt{drawLayer(e,i,s){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const t=i.model,o=t.scene,n=o.camera,a=o.canvas.gl,A=i._state,l=i._state.origin,{position:h,rotationMatrix:d,rotationMatrixConjugate:f}=t,m=i.aabb,_=e.pickViewMatrix||n.viewMatrix;this._vaoCache.has(i)?a.bindVertexArray(this._vaoCache.get(i)):this._vaoCache.set(i,this._makeVAO(A));const u=BP;u[0]=c.safeInv(m[3]-m[0])*c.MAX_INT,u[1]=c.safeInv(m[4]-m[1])*c.MAX_INT,u[2]=c.safeInv(m[5]-m[2])*c.MAX_INT,e.snapPickCoordinateScale[0]=c.safeInv(u[0]),e.snapPickCoordinateScale[1]=c.safeInv(u[1]),e.snapPickCoordinateScale[2]=c.safeInv(u[2]);let P,y;if(l||h[0]!==0||h[1]!==0||h[2]!==0){const v=yP;if(l){const w=xP;c.transformPoint3(d,l,w),v[0]=w[0],v[1]=w[1],v[2]=w[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=h[0],v[1]+=h[1],v[2]+=h[2],P=ft(_,v,bP),y=wP,y[0]=n.eye[0]-v[0],y[1]=n.eye[1]-v[1],y[2]=n.eye[2]-v[2],e.snapPickOrigin[0]=v[0],e.snapPickOrigin[1]=v[1],e.snapPickOrigin[2]=v[2]}else P=_,y=n.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;a.uniform3fv(this._uCameraEyeRtc,y),a.uniform2fv(this.uVectorA,e.snapVectorA),a.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),a.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),a.uniform3fv(this._uCoordinateScaler,u),a.uniform1i(this._uRenderPass,s),a.uniform1i(this._uPickInvisible,e.pickInvisible);let x=0;const B=4*4;this._matricesUniformBlockBufferData.set(f,0),this._matricesUniformBlockBufferData.set(P,x+=B),this._matricesUniformBlockBufferData.set(n.projMatrix,x+=B),this._matricesUniformBlockBufferData.set(A.positionsDecodeMatrix,x+=B),a.bindBuffer(a.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),a.bufferData(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,a.DYNAMIC_DRAW),a.bindBufferBase(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const v=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,v)}this.setSectionPlanesStateUniforms(i),a.drawArrays(a.POINTS,0,A.positionsBuf.numItems)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// VBOBatchingPointsSnapInitRenderer vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),s.push("in vec4 pickColor;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),s.push("uniform vec3 uCameraEyeRtc;"),s.push("uniform vec2 snapVectorA;"),s.push("uniform vec2 snapInvVectorAB;"),s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("out float isPerspective;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("vec2 remapClipPos(vec2 clipPos) {"),s.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),s.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),s.push("    return vec2(x, y);"),s.push("}"),s.push("flat out vec4 vPickColor;"),s.push("out vec4 vWorldPosition;"),i&&s.push("out float vFlags;"),s.push("out highp vec3 relativeToOriginPosition;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      relativeToOriginPosition = worldPosition.xyz;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("      vWorldPosition = worldPosition;"),i&&s.push("      vFlags = flags;"),s.push("vPickColor = pickColor;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),s.push("float tmp = clipPos.w;"),s.push("clipPos.xyzw /= tmp;"),s.push("clipPos.xy = remapClipPos(clipPos.xy);"),s.push("clipPos.xyzw *= tmp;"),s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),s.push("gl_Position = clipPos;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const i=this._scene._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// VBOBatchingPointsSnapInitRenderer fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;"),t.push("uniform int layerNumber;"),t.push("uniform vec3 coordinateScaler;"),t.push("in vec4 vWorldPosition;"),t.push("flat in vec4 vPickColor;"),s){t.push("in float vFlags;");for(let n=0;n<i.getNumAllocatedSectionPlanes();n++)t.push("uniform bool sectionPlaneActive"+n+";"),t.push("uniform vec3 sectionPlanePos"+n+";"),t.push("uniform vec3 sectionPlaneDir"+n+";")}if(t.push("in highp vec3 relativeToOriginPosition;"),t.push("layout(location = 0) out highp ivec4 outCoords;"),t.push("layout(location = 1) out highp ivec4 outNormal;"),t.push("layout(location = 2) out lowp uvec4 outPickColor;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("      float dist = 0.0;");for(var o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("      if (sectionPlaneActive"+o+") {"),t.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("      }");t.push("      if (dist > 0.0) { discard; }"),t.push("  }")}return t.push("    float dx = dFdx(vFragDepth);"),t.push("    float dy = dFdy(vFragDepth);"),t.push("    float diff = sqrt(dx*dx+dy*dy);"),t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),t.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),t.push("outNormal = ivec4(1.0, 1.0, 1.0, 1.0);"),t.push("outPickColor = uvec4(vPickColor);"),t.push("}"),t}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const EP=c.vec3(),IP=c.vec3(),FP=c.vec3(),MP=c.vec3(),SP=c.mat4();class TP extends zt{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,i,s){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const t=i.model,o=t.scene,n=o.camera,a=o.canvas.gl,A=i._state,l=i._state.origin,{position:h,rotationMatrix:d,rotationMatrixConjugate:f}=t,m=i.aabb,_=e.pickViewMatrix||n.viewMatrix;this._vaoCache.has(i)?a.bindVertexArray(this._vaoCache.get(i)):this._vaoCache.set(i,this._makeVAO(A));const u=EP;u[0]=c.safeInv(m[3]-m[0])*c.MAX_INT,u[1]=c.safeInv(m[4]-m[1])*c.MAX_INT,u[2]=c.safeInv(m[5]-m[2])*c.MAX_INT,e.snapPickCoordinateScale[0]=c.safeInv(u[0]),e.snapPickCoordinateScale[1]=c.safeInv(u[1]),e.snapPickCoordinateScale[2]=c.safeInv(u[2]);let P,y;if(l||h[0]!==0||h[1]!==0||h[2]!==0){const v=IP;if(l){const w=FP;c.transformPoint3(d,l,w),v[0]=w[0],v[1]=w[1],v[2]=w[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=h[0],v[1]+=h[1],v[2]+=h[2],P=ft(_,v,SP),y=MP,y[0]=n.eye[0]-v[0],y[1]=n.eye[1]-v[1],y[2]=n.eye[2]-v[2],e.snapPickOrigin[0]=v[0],e.snapPickOrigin[1]=v[1],e.snapPickOrigin[2]=v[2]}else P=_,y=n.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;a.uniform3fv(this._uCameraEyeRtc,y),a.uniform2fv(this.uVectorA,e.snapVectorA),a.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),a.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),a.uniform3fv(this._uCoordinateScaler,u),a.uniform1i(this._uRenderPass,s),a.uniform1i(this._uPickInvisible,e.pickInvisible);let x=0;const B=4*4;this._matricesUniformBlockBufferData.set(f,0),this._matricesUniformBlockBufferData.set(P,x+=B),this._matricesUniformBlockBufferData.set(n.projMatrix,x+=B),this._matricesUniformBlockBufferData.set(A.positionsDecodeMatrix,x+=B),a.bindBuffer(a.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),a.bufferData(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,a.DYNAMIC_DRAW),a.bindBufferBase(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const v=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,v)}this.setSectionPlanesStateUniforms(i),a.drawArrays(a.POINTS,0,A.positionsBuf.numItems)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0;e.pointsMaterial._state;const s=[];return s.push("#version 300 es"),s.push("// VBOBatchingPointsSnapRenderer vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),s.push("uniform vec3 uCameraEyeRtc;"),s.push("uniform vec2 snapVectorA;"),s.push("uniform vec2 snapInvVectorAB;"),s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;"),s.push("vec2 remapClipPos(vec2 clipPos) {"),s.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),s.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),s.push("    return vec2(x, y);"),s.push("}"),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out highp vec3 relativeToOriginPosition;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("relativeToOriginPosition = worldPosition.xyz;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),s.push("float tmp = clipPos.w;"),s.push("clipPos.xyzw /= tmp;"),s.push("clipPos.xy = remapClipPos(clipPos.xy);"),s.push("clipPos.xyzw *= tmp;"),s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),s.push("gl_Position = clipPos;"),s.push("gl_PointSize = 1.0;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const i=this._scene._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// VBOBatchingPointsSnapRenderer fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;"),t.push("uniform int layerNumber;"),t.push("uniform vec3 coordinateScaler;"),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let n=0;n<i.getNumAllocatedSectionPlanes();n++)t.push("uniform bool sectionPlaneActive"+n+";"),t.push("uniform vec3 sectionPlanePos"+n+";"),t.push("uniform vec3 sectionPlaneDir"+n+";")}if(t.push("in highp vec3 relativeToOriginPosition;"),t.push("out highp ivec4 outCoords;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("      float dist = 0.0;");for(var o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("      if (sectionPlaneActive"+o+") {"),t.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("      }");t.push("      if (dist > 0.0) { discard; }"),t.push("  }")}return t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),t.push("}"),t}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class DP{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._occlusionRenderer&&this._occlusionRenderer.getValid()===!1&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new gP(this._scene)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new mP(this._scene)),this._silhouetteRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new _P(this._scene)),this._pickMeshRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new vP(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new PP(this._scene)),this._occlusionRenderer}get snapInitRenderer(){return this._snapInitRenderer||(this._snapInitRenderer=new CP(this._scene,!1)),this._snapInitRenderer}get snapRenderer(){return this._snapRenderer||(this._snapRenderer=new TP(this._scene)),this._snapRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}const ka={};function RP(r){const e=r.id;let i=ka[e];return i||(i=new DP(r),ka[e]=i,i._compile(),r.on("compile",()=>{i._compile()}),r.on("destroyed",()=>{delete ka[e],i._destroy()})),i}class LP{constructor(e=5e6){e>5e6&&(e=5e6),this.maxVerts=e,this.maxIndices=e*3,this.positions=[],this.colors=[],this.intensities=[],this.pickColors=[],this.offsets=[]}}class UP{constructor(e){console.info("Creating VBOBatchingPointsLayer"),this.model=e.model,this.sortId="PointsBatchingLayer",this.layerIndex=e.layerIndex,this._renderers=RP(e.model.scene),this._buffer=new LP(e.maxGeometryBatchSize),this._scratchMemory=e.scratchMemory,this._state=new Ft({positionsBuf:null,offsetsBuf:null,colorsBuf:null,flagsBuf:null,positionsDecodeMatrix:c.mat4(),origin:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=c.collapseAABB3(),this._portions=[],this._meshes=[],this._aabb=c.collapseAABB3(),this.aabbDirty=!0,this._finalized=!1,e.positionsDecodeMatrix?(this._state.positionsDecodeMatrix.set(e.positionsDecodeMatrix),this._preCompressedPositionsExpected=!0):this._preCompressedPositionsExpected=!1,e.origin&&(this._state.origin=c.vec3(e.origin))}get aabb(){if(this.aabbDirty){c.collapseAABB3(this._aabb);for(let e=0,i=this._meshes.length;e<i;e++)c.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}canCreatePortion(e){if(this._finalized)throw"Already finalized";return this._buffer.positions.length+e<this._buffer.maxVerts*3}createPortion(e,i){if(this._finalized)throw"Already finalized";const s=i.positions,t=i.positionsCompressed,o=i.color,n=i.colorsCompressed,a=i.colors,A=i.pickColor,l=this._buffer,d=l.positions.length/3;let f;if(c.expandAABB3(this._modelAABB,i.aabb),this._preCompressedPositionsExpected){if(!t)throw"positionsCompressed expected";for(let _=0,u=t.length;_<u;_++)l.positions.push(t[_]);f=t.length/3}else{if(!s)throw"positions expected";f=s.length/3,s.length,l.positions.length;for(let _=0,u=s.length;_<u;_++)l.positions.push(s[_])}if(n)for(let _=0,u=n.length;_<u;_++)l.colors.push(n[_]);else if(a)for(let _=0,u=a.length;_<u;_++)l.colors.push(a[_]*255);else if(o){const _=o[0],u=o[1],P=o[2],y=1;for(let x=0;x<f;x++)l.colors.push(_),l.colors.push(u),l.colors.push(P),l.colors.push(y)}{const _=l.pickColors.length,u=f*4;for(let P=_,y=_+u;P<y;P+=4)l.pickColors.push(A[0]),l.pickColors.push(A[1]),l.pickColors.push(A[2]),l.pickColors.push(A[3])}if(this.model.scene.entityOffsetsEnabled)for(let _=0;_<f;_++)l.offsets.push(0),l.offsets.push(0),l.offsets.push(0);const m=this._portions.length/2;return this._portions.push(d),this._portions.push(f),this._numPortions++,this.model.numPortions++,this._meshes.push(e),m}finalize(){if(this._finalized)return;const e=this._state,i=this.model.scene.canvas.gl,s=this._buffer;if(s.positions.length>0)if(this._preCompressedPositionsExpected){const t=new Uint16Array(s.positions);e.positionsBuf=new Ee(i,i.ARRAY_BUFFER,t,s.positions.length,3,i.STATIC_DRAW)}else{const t=new Float32Array(s.positions),o=oo(t,this._modelAABB,e.positionsDecodeMatrix);e.positionsBuf=new Ee(i,i.ARRAY_BUFFER,o,s.positions.length,3,i.STATIC_DRAW)}if(s.colors.length>0){const t=new Uint8Array(s.colors);let o=!1;e.colorsBuf=new Ee(i,i.ARRAY_BUFFER,t,s.colors.length,4,i.STATIC_DRAW,o)}if(s.positions.length>0){const t=s.positions.length/3,o=new Float32Array(t);let n=!1;e.flagsBuf=new Ee(i,i.ARRAY_BUFFER,o,o.length,1,i.DYNAMIC_DRAW,n)}if(s.pickColors.length>0){const t=new Uint8Array(s.pickColors);let o=!1;e.pickColorsBuf=new Ee(i,i.ARRAY_BUFFER,t,s.pickColors.length,4,i.STATIC_DRAW,o)}if(this.model.scene.entityOffsetsEnabled&&s.offsets.length>0){const t=new Float32Array(s.offsets);e.offsetsBuf=new Ee(i,i.ARRAY_BUFFER,t,s.offsets.length,3,i.DYNAMIC_DRAW)}this._buffer=null,this._finalized=!0}initFlags(e,i,s){i&k.VISIBLE&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),i&k.HIGHLIGHTED&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),i&k.XRAYED&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),i&k.SELECTED&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),i&k.CLIPPABLE&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),i&k.PICKABLE&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),i&k.CULLED&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),s&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,i,s)}setVisible(e,i,s){if(!this._finalized)throw"Not finalized";i&k.VISIBLE?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,i,s)}setHighlighted(e,i,s){if(!this._finalized)throw"Not finalized";i&k.HIGHLIGHTED?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,i,s)}setXRayed(e,i,s){if(!this._finalized)throw"Not finalized";i&k.XRAYED?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,i,s)}setSelected(e,i,s){if(!this._finalized)throw"Not finalized";i&k.SELECTED?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,i,s)}setEdges(e,i,s){if(!this._finalized)throw"Not finalized"}setClippable(e,i){if(!this._finalized)throw"Not finalized";i&k.CLIPPABLE?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,i)}setCulled(e,i,s){if(!this._finalized)throw"Not finalized";i&k.CULLED?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,i,s)}setCollidable(e,i){if(!this._finalized)throw"Not finalized"}setPickable(e,i,s){if(!this._finalized)throw"Not finalized";i&k.PICKABLE?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,i,s)}setColor(e,i){if(!this._finalized)throw"Not finalized";const s=e*2,t=this._portions[s],o=this._portions[s+1],n=t*4,a=o*4,A=this._scratchMemory.getUInt8Array(a),l=i[0],h=i[1],d=i[2];for(let f=0;f<a;f+=4)A[f+0]=l,A[f+1]=h,A[f+2]=d;this._state.colorsBuf.setData(A,n,a)}setTransparent(e,i,s){s?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,i,s)}_setFlags(e,i,s){if(!this._finalized)throw"Not finalized";const t=e*2,o=this._portions[t],n=this._portions[t+1],a=o,A=n,l=this._scratchMemory.getFloat32Array(A),h=!!(i&k.VISIBLE),d=!!(i&k.XRAYED),f=!!(i&k.HIGHLIGHTED),m=!!(i&k.SELECTED),_=!!(i&k.PICKABLE),u=!!(i&k.CULLED);let P;!h||u||d||f&&!this.model.scene.highlightMaterial.glowThrough||m&&!this.model.scene.selectedMaterial.glowThrough?P=U.NOT_RENDERED:s?P=U.COLOR_TRANSPARENT:P=U.COLOR_OPAQUE;let y;!h||u?y=U.NOT_RENDERED:m?y=U.SILHOUETTE_SELECTED:f?y=U.SILHOUETTE_HIGHLIGHTED:d?y=U.SILHOUETTE_XRAYED:y=U.NOT_RENDERED;let x=h&&!u&&_?U.PICK:U.NOT_RENDERED;const B=i&k.CLIPPABLE?1:0;for(let v=0;v<A;v++){let w=0;w|=P,w|=y<<4,w|=x<<12,w|=B<<16,l[v]=w}this._state.flagsBuf.setData(l,a)}setOffset(e,i){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled){this.model.error("Entity#offset not enabled for this Viewer");return}const s=e*2,t=this._portions[s],o=this._portions[s+1],n=t*3,a=o*3,A=this._scratchMemory.getFloat32Array(a),l=i[0],h=i[1],d=i[2];for(let f=0;f<a;f+=3)A[f+0]=l,A[f+1]=h,A[f+2]=d;this._state.offsetsBuf.setData(A,n,a)}drawColorOpaque(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(i,this,U.COLOR_OPAQUE)}drawColorTransparent(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===0||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(i,this,U.COLOR_TRANSPARENT)}drawDepth(e,i){}drawNormals(e,i){}drawSilhouetteXRayed(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(i,this,U.SILHOUETTE_XRAYED)}drawSilhouetteHighlighted(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(i,this,U.SILHOUETTE_HIGHLIGHTED)}drawSilhouetteSelected(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(i,this,U.SILHOUETTE_SELECTED)}drawEdgesColorOpaque(e,i){}drawEdgesColorTransparent(e,i){}drawEdgesHighlighted(e,i){}drawEdgesSelected(e,i){}drawEdgesXRayed(e,i){}drawPickMesh(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.pickMeshRenderer&&this._renderers.pickMeshRenderer.drawLayer(i,this,U.PICK)}drawPickDepths(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.pickDepthRenderer&&this._renderers.pickDepthRenderer.drawLayer(i,this,U.PICK)}drawPickNormals(e,i){}drawSnapInit(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(i,this,U.PICK)}drawSnap(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(i,this,U.PICK)}drawOcclusion(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.occlusionRenderer&&this._renderers.occlusionRenderer.drawLayer(i,this,U.COLOR_OPAQUE)}drawShadow(e,i){}destroy(){const e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.destroy()}}class Fs extends zt{constructor(e,i){super(e,i,{instancing:!0})}_draw(e){const{gl:i}=this._scene.canvas,{state:s,frameCtx:t,incrementDrawState:o}=e;i.drawArraysInstanced(i.POINTS,0,s.positionsBuf.numItems,s.numInstances),o&&t.drawArrays++}}class OP extends Fs{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,i,s){super.drawLayer(e,i,s,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=e.pointsMaterial._state,o=[];return o.push("#version 300 es"),o.push("// Points instancing color vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),o.push("in vec4 color;"),o.push("in float flags;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),o.push("in vec4 modelMatrixCol0;"),o.push("in vec4 modelMatrixCol1;"),o.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(o),o.push("uniform float pointSize;"),t.perspectivePoints&&o.push("uniform float nearPlaneHeight;"),t.filterIntensity&&o.push("uniform vec2 intensityRange;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;")),s&&(o.push("out vec4 vWorldPosition;"),o.push("out float vFlags;")),o.push("out vec4 vColor;"),o.push("void main(void) {"),o.push("int colorFlag = int(flags) & 0xF;"),o.push("if (colorFlag != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),t.filterIntensity&&(o.push("float intensity = float(color.a) / 255.0;"),o.push("if (intensity < intensityRange[0] || intensity > intensityRange[1]) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {")),o.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),o.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&o.push("      worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),o.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, 1.0);"),s&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags = flags;")),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("gl_Position = clipPos;"),t.perspectivePoints?(o.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),o.push("gl_PointSize = max(gl_PointSize, "+Math.floor(t.minPerspectivePointSize)+".0);"),o.push("gl_PointSize = min(gl_PointSize, "+Math.floor(t.maxPerspectivePointSize)+".0);")):o.push("gl_PointSize = pointSize;"),o.push("}"),t.filterIntensity&&o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Points instancing color fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("in vec4 vColor;"),t.push("out vec4 outColor;"),t.push("void main(void) {"),e.pointsMaterial.roundPoints&&(t.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),t.push("  float r = dot(cxy, cxy);"),t.push("  if (r > 1.0) {"),t.push("       discard;"),t.push("  }")),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("if (dist > 0.0) { discard; }"),t.push("}")}return t.push("   outColor = vColor;"),e.logarithmicDepthBufferEnabled&&t.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("}"),t}}class kP extends Fs{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,i,s){super.drawLayer(e,i,s,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=e.pointsMaterial._state,o=[];return o.push("#version 300 es"),o.push("// Points instancing silhouette vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),o.push("in float flags;"),o.push("in vec4 color;"),o.push("in vec4 modelMatrixCol0;"),o.push("in vec4 modelMatrixCol1;"),o.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(o),o.push("uniform float pointSize;"),t.perspectivePoints&&o.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;")),o.push("uniform vec4 silhouetteColor;"),s&&(o.push("out vec4 vWorldPosition;"),o.push("out float vFlags;")),o.push("out vec4 vColor;"),o.push("void main(void) {"),o.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),o.push("if (silhouetteFlag != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),o.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&o.push("      worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags = flags;")),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("vColor = vec4(float(silhouetteColor.r) / 255.0, float(silhouetteColor.g) / 255.0, float(silhouetteColor.b) / 255.0, float(color.a) / 255.0);"),o.push("gl_Position = clipPos;"),t.perspectivePoints?(o.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),o.push("gl_PointSize = max(gl_PointSize, "+Math.floor(t.minPerspectivePointSize)+".0);"),o.push("gl_PointSize = min(gl_PointSize, "+Math.floor(t.maxPerspectivePointSize)+".0);")):o.push("gl_PointSize = pointSize;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Points instancing silhouette fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("in vec4 vColor;"),t.push("out vec4 outColor;"),t.push("void main(void) {"),e.pointsMaterial.roundPoints&&(t.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),t.push("  float r = dot(cxy, cxy);"),t.push("  if (r > 1.0) {"),t.push("       discard;"),t.push("  }")),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("if (dist > 0.0) { discard; }"),t.push("}")}return e.logarithmicDepthBufferEnabled&&t.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("outColor = vColor;"),t.push("}"),t}}class NP extends Fs{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=e.pointsMaterial._state,o=[];return o.push("#version 300 es"),o.push("// Points instancing pick mesh vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),o.push("in float flags;"),o.push("in vec4 pickColor;"),o.push("in vec4 modelMatrixCol0;"),o.push("in vec4 modelMatrixCol1;"),o.push("in vec4 modelMatrixCol2;"),o.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(o),this._addRemapClipPosLines(o),o.push("uniform float pointSize;"),t.perspectivePoints&&o.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;")),s&&(o.push("out vec4 vWorldPosition;"),o.push("out float vFlags;")),o.push("out vec4 vPickColor;"),o.push("void main(void) {"),o.push("int pickFlag = int(flags) >> 12 & 0xF;"),o.push("if (pickFlag != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),o.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&o.push("      worldPosition.xyz = worldPosition.xyz + offset;"),o.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),o.push("  vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),s&&(o.push("  vWorldPosition = worldPosition;"),o.push("  vFlags = flags;")),o.push("vec4 clipPos = projMatrix * viewPosition;"),o.push("gl_Position = remapClipPos(clipPos);"),e.logarithmicDepthBufferEnabled&&o.push("vFragDepth = 1.0 + clipPos.w;"),t.perspectivePoints?(o.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),o.push("gl_PointSize = max(gl_PointSize, "+Math.floor(t.minPerspectivePointSize)+".0);"),o.push("gl_PointSize = min(gl_PointSize, "+Math.floor(t.maxPerspectivePointSize)+".0);")):o.push("gl_PointSize = pointSize;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Points instancing pick mesh fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("in vec4 vPickColor;"),t.push("out vec4 outColor;"),t.push("void main(void) {"),e.pointsMaterial.roundPoints&&(t.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),t.push("  float r = dot(cxy, cxy);"),t.push("  if (r > 1.0) {"),t.push("       discard;"),t.push("  }")),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("if (dist > 0.0) { discard; }"),t.push("}")}return e.logarithmicDepthBufferEnabled&&t.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("outColor = vPickColor; "),t.push("}"),t}}class QP extends Fs{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=e.pointsMaterial._state,o=[];return o.push("#version 300 es"),o.push("// Points instancing pick depth vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),o.push("in float flags;"),o.push("in vec4 modelMatrixCol0;"),o.push("in vec4 modelMatrixCol1;"),o.push("in vec4 modelMatrixCol2;"),o.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(o),this._addRemapClipPosLines(o),o.push("uniform float pointSize;"),t.perspectivePoints&&o.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;")),s&&(o.push("out vec4 vWorldPosition;"),o.push("out float vFlags;")),o.push("out vec4 vViewPosition;"),o.push("void main(void) {"),o.push("int pickFlag = int(flags) >> 12 & 0xF;"),o.push("if (pickFlag != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),o.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&o.push("      worldPosition.xyz = worldPosition.xyz + offset;"),o.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s&&(o.push("  vWorldPosition = worldPosition;"),o.push("  vFlags = flags;")),o.push("  vViewPosition = viewPosition;"),o.push("vec4 clipPos = projMatrix * viewPosition;"),o.push("gl_Position = remapClipPos(clipPos);"),e.logarithmicDepthBufferEnabled&&o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("gl_Position = remapClipPos(clipPos);"),t.perspectivePoints?(o.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),o.push("gl_PointSize = max(gl_PointSize, "+Math.floor(t.minPerspectivePointSize)+".0);"),o.push("gl_PointSize = min(gl_PointSize, "+Math.floor(t.maxPerspectivePointSize)+".0);")):o.push("gl_PointSize = pointSize;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Points instancing pick depth fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),t.push("uniform float pickZNear;"),t.push("uniform float pickZFar;"),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("in vec4 vViewPosition;"),t.push("vec4 packDepth(const in float depth) {"),t.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),t.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),t.push("  vec4 res = fract(depth * bitShift);"),t.push("  res -= res.xxyz * bitMask;"),t.push("  return res;"),t.push("}"),t.push("out vec4 outColor;"),t.push("void main(void) {"),e.pointsMaterial.roundPoints&&(t.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),t.push("  float r = dot(cxy, cxy);"),t.push("  if (r > 1.0) {"),t.push("       discard;"),t.push("  }")),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("if (dist > 0.0) { discard; }"),t.push("}")}return e.logarithmicDepthBufferEnabled&&t.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),t.push("    outColor = packDepth(zNormalizedDepth); "),t.push("}"),t}}class HP extends Fs{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=e.pointsMaterial._state,o=[];return o.push("#version 300 es"),o.push("// Points instancing occlusion vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),o.push("in vec4 color;"),o.push("in float flags;"),o.push("in vec4 modelMatrixCol0;"),o.push("in vec4 modelMatrixCol1;"),o.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(o),o.push("uniform float pointSize;"),t.perspectivePoints&&o.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;")),s&&(o.push("out vec4 vWorldPosition;"),o.push("out float vFlags;")),o.push("void main(void) {"),o.push("int colorFlag = int(flags) & 0xF;"),o.push("if (colorFlag != renderPass) {"),o.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),o.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&o.push("      worldPosition.xyz = worldPosition.xyz + offset;"),o.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s&&(o.push("  vWorldPosition = worldPosition;"),o.push("vFlags = flags;")),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("gl_Position = clipPos;"),t.perspectivePoints?(o.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),o.push("gl_PointSize = max(gl_PointSize, "+Math.floor(t.minPerspectivePointSize)+".0);"),o.push("gl_PointSize = min(gl_PointSize, "+Math.floor(t.maxPerspectivePointSize)+".0);")):o.push("gl_PointSize = pointSize;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Points instancing occlusion vertex shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("out vec4 outColor;"),t.push("void main(void) {"),e.pointsMaterial.roundPoints&&(t.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),t.push("  float r = dot(cxy, cxy);"),t.push("  if (r > 1.0) {"),t.push("       discard;"),t.push("  }")),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("if (dist > 0.0) { discard; }"),t.push("}")}return t.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),e.logarithmicDepthBufferEnabled&&t.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("}"),t}}class VP extends Fs{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=e.pointsMaterial._state,o=[];return o.push("#version 300 es"),o.push("// Points instancing depth vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),o.push("in float flags;"),o.push("in vec4 modelMatrixCol0;"),o.push("in vec4 modelMatrixCol1;"),o.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(o),o.push("uniform float pointSize;"),t.perspectivePoints&&o.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;")),s&&(o.push("out vec4 vWorldPosition;"),o.push("out float vFlags;")),o.push("void main(void) {"),o.push("int colorFlag = int(flags) & 0xF;"),o.push("if (colorFlag != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),o.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&o.push("      worldPosition.xyz = worldPosition.xyz + offset;"),o.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags = flags;")),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("gl_Position = clipPos;"),t.perspectivePoints?(o.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),o.push("gl_PointSize = max(gl_PointSize, "+Math.floor(t.minPerspectivePointSize)+".0);"),o.push("gl_PointSize = min(gl_PointSize, "+Math.floor(t.maxPerspectivePointSize)+".0);")):o.push("gl_PointSize = pointSize;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState;let s,t;const o=i.getNumAllocatedSectionPlanes()>0,n=[];if(n.push("#version 300 es"),n.push("// Points instancing depth vertex shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),o)for(n.push("in vec4 vWorldPosition;"),n.push("in float vFlags;"),s=0,t=i.getNumAllocatedSectionPlanes();s<t;s++)n.push("uniform bool sectionPlaneActive"+s+";"),n.push("uniform vec3 sectionPlanePos"+s+";"),n.push("uniform vec3 sectionPlaneDir"+s+";");if(n.push("const float   packUpScale = 256. / 255.;"),n.push("const float   unpackDownscale = 255. / 256.;"),n.push("const vec3    packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),n.push("const vec4    unpackFactors = unpackDownscale / vec4( packFactors, 1. );"),n.push("const float   shiftRight8 = 1.0 / 256.;"),n.push("vec4 packDepthToRGBA( const in float v ) {"),n.push("    vec4 r = vec4( fract( v * packFactors ), v );"),n.push("    r.yzw -= r.xyz * shiftRight8;"),n.push("    return r * packUpScale;"),n.push("}"),n.push("out vec4 outColor;"),n.push("void main(void) {"),e.pointsMaterial.roundPoints&&(n.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),n.push("  float r = dot(cxy, cxy);"),n.push("  if (r > 1.0) {"),n.push("       discard;"),n.push("  }")),o){for(n.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;"),s=0,t=i.getNumAllocatedSectionPlanes();s<t;s++)n.push("if (sectionPlaneActive"+s+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),n.push("}");n.push("if (dist > 0.0) { discard; }"),n.push("}")}return n.push("    outColor = packDepthToRGBA( gl_FragCoord.z); "),e.logarithmicDepthBufferEnabled&&n.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("}"),n}}class jP extends Fs{_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=[];return t.push("#version 300 es"),t.push("// Instancing geometry shadow drawing vertex shader"),t.push("in vec3 position;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),t.push("in vec4 color;"),t.push("in float flags;"),t.push("in vec4 modelMatrixCol0;"),t.push("in vec4 modelMatrixCol1;"),t.push("in vec4 modelMatrixCol2;"),t.push("uniform mat4 shadowViewMatrix;"),t.push("uniform mat4 shadowProjMatrix;"),this._addMatricesUniformBlockLines(t),t.push("uniform float pointSize;"),s&&(t.push("out vec4 vWorldPosition;"),t.push("out float vFlags;")),t.push("void main(void) {"),t.push("int colorFlag     = int(flags) & 0xF;"),t.push("bool visible      = (colorFlag > 0);"),t.push("bool transparent  = ((float(color.a) / 255.0) < 1.0);"),t.push("if (!visible || transparent) {"),t.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("} else {"),t.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),t.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&t.push("      worldPosition.xyz = worldPosition.xyz + offset;"),t.push("  vec4 viewPosition  = shadowViewMatrix * worldPosition; "),s&&(t.push("vWorldPosition = worldPosition;"),t.push("vFlags = flags;")),t.push("  gl_Position = shadowProjMatrix * viewPosition;"),t.push("}"),t.push("gl_PointSize = pointSize;"),t.push("}"),t}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Instancing geometry depth drawing fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("in vec3 vViewNormal;"),t.push("vec3 packNormalToRGB( const in vec3 normal ) {"),t.push("    return normalize( normal ) * 0.5 + 0.5;"),t.push("}"),t.push("out vec4 outColor;"),t.push("void main(void) {"),t.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),t.push("  float r = dot(cxy, cxy);"),t.push("  if (r > 1.0) {"),t.push("       discard;"),t.push("  }"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("if (dist > 0.0) { discard; }"),t.push("}")}return e.logarithmicDepthBufferEnabled&&t.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("    outColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),t.push("}"),t}}const GP=c.vec3(),zP=c.vec3(),KP=c.vec3();c.vec3();const WP=c.mat4();class XP extends zt{constructor(e){super(e,!1,{instancing:!0})}drawLayer(e,i,s){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const t=i.model,o=t.scene,n=o.canvas.gl,a=o.camera,A=i._state,l=i._state.origin,{position:h,rotationMatrix:d,rotationMatrixConjugate:f}=t,m=i.aabb,_=e.pickViewMatrix||a.viewMatrix;this._vaoCache.has(i)?n.bindVertexArray(this._vaoCache.get(i)):this._vaoCache.set(i,this._makeVAO(A));const u=GP;u[0]=c.safeInv(m[3]-m[0])*c.MAX_INT,u[1]=c.safeInv(m[4]-m[1])*c.MAX_INT,u[2]=c.safeInv(m[5]-m[2])*c.MAX_INT,e.snapPickCoordinateScale[0]=c.safeInv(u[0]),e.snapPickCoordinateScale[1]=c.safeInv(u[1]),e.snapPickCoordinateScale[2]=c.safeInv(u[2]);let P;if(l||h[0]!==0||h[1]!==0||h[2]!==0){const B=zP;if(l){const v=c.transformPoint3(d,l,KP);B[0]=v[0],B[1]=v[1],B[2]=v[2]}else B[0]=0,B[1]=0,B[2]=0;B[0]+=h[0],B[1]+=h[1],B[2]+=h[2],P=ft(_,B,WP),e.snapPickOrigin[0]=B[0],e.snapPickOrigin[1]=B[1],e.snapPickOrigin[2]=B[2]}else P=_,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;n.uniform2fv(this.uVectorA,e.snapVectorA),n.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),n.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),n.uniform3fv(this._uCoordinateScaler,u),n.uniform1i(this._uRenderPass,s),n.uniform1i(this._uPickInvisible,e.pickInvisible);let y=0;const x=4*4;this._matricesUniformBlockBufferData.set(f,0),this._matricesUniformBlockBufferData.set(P,y+=x),this._matricesUniformBlockBufferData.set(a.projMatrix,y+=x),this._matricesUniformBlockBufferData.set(A.positionsDecodeMatrix,y+=x),n.bindBuffer(n.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),n.bufferData(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,n.DYNAMIC_DRAW),n.bindBufferBase(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const B=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,B)}this.setSectionPlanesStateUniforms(i),this._aModelMatrixCol0.bindArrayBuffer(A.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(A.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(A.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aFlags&&(this._aFlags.bindArrayBuffer(A.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1)),n.drawArraysInstanced(n.POINTS,0,A.positionsBuf.numItems,A.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),this._aFlags&&n.vertexAttribDivisor(this._aFlags.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=[];return t.push("#version 300 es"),t.push("// SnapInstancingDepthBufInitRenderer vertex shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("precision highp usampler2D;"),t.push("precision highp isampler2D;"),t.push("precision highp sampler2D;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("precision mediump usampler2D;"),t.push("precision mediump isampler2D;"),t.push("precision mediump sampler2D;"),t.push("#endif"),t.push("uniform int renderPass;"),t.push("in vec4 pickColor;"),t.push("in vec3 position;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),t.push("in float flags;"),t.push("in vec4 modelMatrixCol0;"),t.push("in vec4 modelMatrixCol1;"),t.push("in vec4 modelMatrixCol2;"),t.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(t),t.push("uniform vec2 snapVectorA;"),t.push("uniform vec2 snapInvVectorAB;"),t.push("uniform float logDepthBufFC;"),t.push("out float vFragDepth;"),t.push("bool isPerspectiveMatrix(mat4 m) {"),t.push("    return (m[2][3] == - 1.0);"),t.push("}"),t.push("out float isPerspective;"),t.push("vec2 remapClipPos(vec2 clipPos) {"),t.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),t.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),t.push("    return vec2(x, y);"),t.push("}"),t.push("flat out vec4 vPickColor;"),t.push("out vec4 vWorldPosition;"),s&&t.push("out float vFlags;"),t.push("out highp vec3 relativeToOriginPosition;"),t.push("void main(void) {"),t.push("int pickFlag = int(flags) >> 12 & 0xF;"),t.push("if (pickFlag != renderPass) {"),t.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("} else {"),t.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),t.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&t.push("      worldPosition.xyz = worldPosition.xyz + offset;"),t.push("relativeToOriginPosition = worldPosition.xyz;"),t.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t.push("  vWorldPosition = worldPosition;"),s&&t.push("  vFlags = flags;"),t.push("vPickColor = pickColor;"),t.push("vec4 clipPos = projMatrix * viewPosition;"),t.push("float tmp = clipPos.w;"),t.push("clipPos.xyzw /= tmp;"),t.push("clipPos.xy = remapClipPos(clipPos.xy);"),t.push("clipPos.xyzw *= tmp;"),t.push("vFragDepth = 1.0 + clipPos.w;"),t.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),t.push("gl_Position = clipPos;"),t.push("}"),t.push("}"),t}_buildFragmentShader(){const i=this._scene._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// Points instancing pick depth fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;"),t.push("uniform int layerNumber;"),t.push("uniform vec3 coordinateScaler;"),t.push("in vec4 vWorldPosition;"),t.push("flat in vec4 vPickColor;"),s){t.push("in float vFlags;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("in highp vec3 relativeToOriginPosition;"),t.push("layout(location = 0) out highp ivec4 outCoords;"),t.push("layout(location = 1) out highp ivec4 outNormal;"),t.push("layout(location = 2) out lowp uvec4 outPickColor;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("if (dist > 0.0) { discard; }"),t.push("}")}return t.push("    float dx = dFdx(vFragDepth);"),t.push("    float dy = dFdy(vFragDepth);"),t.push("    float diff = sqrt(dx*dx+dy*dy);"),t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),t.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),t.push("outNormal = ivec4(1.0, 1.0, 1.0, 1.0);"),t.push("outPickColor = uvec4(vPickColor);"),t.push("}"),t}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const YP=c.vec3(),$P=c.vec3(),ZP=c.vec3();c.vec3();const qP=c.mat4();class JP extends zt{constructor(e){super(e,!1,{instancing:!0})}drawLayer(e,i,s){if(!this._program&&(this._allocate(i),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const t=i.model,o=t.scene,n=o.camera,a=o.canvas.gl,A=i._state,l=i._state.origin,{position:h,rotationMatrix:d,rotationMatrixConjugate:f}=t,m=i.aabb,_=e.pickViewMatrix||n.viewMatrix;this._vaoCache.has(i)?a.bindVertexArray(this._vaoCache.get(i)):this._vaoCache.set(i,this._makeVAO(A));const u=YP;u[0]=c.safeInv(m[3]-m[0])*c.MAX_INT,u[1]=c.safeInv(m[4]-m[1])*c.MAX_INT,u[2]=c.safeInv(m[5]-m[2])*c.MAX_INT,e.snapPickCoordinateScale[0]=c.safeInv(u[0]),e.snapPickCoordinateScale[1]=c.safeInv(u[1]),e.snapPickCoordinateScale[2]=c.safeInv(u[2]);let P;if(l||h[0]!==0||h[1]!==0||h[2]!==0){const B=$P;if(l){const v=c.transformPoint3(d,l,ZP);B[0]=v[0],B[1]=v[1],B[2]=v[2]}else B[0]=0,B[1]=0,B[2]=0;B[0]+=h[0],B[1]+=h[1],B[2]+=h[2],P=ft(_,B,qP),e.snapPickOrigin[0]=B[0],e.snapPickOrigin[1]=B[1],e.snapPickOrigin[2]=B[2]}else P=_,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;a.uniform2fv(this.uVectorA,e.snapVectorA),a.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),a.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),a.uniform3fv(this._uCoordinateScaler,u),a.uniform1i(this._uRenderPass,s),a.uniform1i(this._uPickInvisible,e.pickInvisible);let y=0;const x=4*4;this._matricesUniformBlockBufferData.set(f,0),this._matricesUniformBlockBufferData.set(P,y+=x),this._matricesUniformBlockBufferData.set(n.projMatrix,y+=x),this._matricesUniformBlockBufferData.set(A.positionsDecodeMatrix,y+=x),a.bindBuffer(a.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),a.bufferData(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,a.DYNAMIC_DRAW),a.bindBufferBase(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const B=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,B)}this.setSectionPlanesStateUniforms(i),this._aModelMatrixCol0.bindArrayBuffer(A.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(A.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(A.modelMatrixCol2Buf),a.vertexAttribDivisor(this._aModelMatrixCol0.location,1),a.vertexAttribDivisor(this._aModelMatrixCol1.location,1),a.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aFlags.bindArrayBuffer(A.flagsBuf),a.vertexAttribDivisor(this._aFlags.location,1),a.drawArraysInstanced(a.POINTS,0,A.positionsBuf.numItems,A.numInstances),a.vertexAttribDivisor(this._aModelMatrixCol0.location,0),a.vertexAttribDivisor(this._aModelMatrixCol1.location,0),a.vertexAttribDivisor(this._aModelMatrixCol2.location,0),a.vertexAttribDivisor(this._aFlags.location,0),this._aOffset&&a.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,s=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,t=[];return t.push("#version 300 es"),t.push("// SnapInstancingDepthRenderer vertex shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("precision highp usampler2D;"),t.push("precision highp isampler2D;"),t.push("precision highp sampler2D;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("precision mediump usampler2D;"),t.push("precision mediump isampler2D;"),t.push("precision mediump sampler2D;"),t.push("#endif"),t.push("uniform int renderPass;"),t.push("in vec3 position;"),e.entityOffsetsEnabled&&t.push("in vec3 offset;"),t.push("in float flags;"),t.push("in vec4 modelMatrixCol0;"),t.push("in vec4 modelMatrixCol1;"),t.push("in vec4 modelMatrixCol2;"),t.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(t),t.push("uniform vec2 snapVectorA;"),t.push("uniform vec2 snapInvVectorAB;"),t.push("uniform float logDepthBufFC;"),t.push("out float vFragDepth;"),t.push("bool isPerspectiveMatrix(mat4 m) {"),t.push("    return (m[2][3] == - 1.0);"),t.push("}"),t.push("out float isPerspective;"),t.push("vec2 remapClipPos(vec2 clipPos) {"),t.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),t.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),t.push("    return vec2(x, y);"),t.push("}"),s&&(t.push("out vec4 vWorldPosition;"),t.push("out float vFlags;")),t.push("out highp vec3 relativeToOriginPosition;"),t.push("void main(void) {"),t.push("int pickFlag = int(flags) >> 12 & 0xF;"),t.push("if (pickFlag != renderPass) {"),t.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),t.push("} else {"),t.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),t.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&t.push("      worldPosition.xyz = worldPosition.xyz + offset;"),t.push("relativeToOriginPosition = worldPosition.xyz;"),t.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s&&(t.push("  vWorldPosition = worldPosition;"),t.push("  vFlags = flags;")),t.push("vec4 clipPos = projMatrix * viewPosition;"),t.push("float tmp = clipPos.w;"),t.push("clipPos.xyzw /= tmp;"),t.push("clipPos.xy = remapClipPos(clipPos.xy);"),t.push("clipPos.xyzw *= tmp;"),t.push("vFragDepth = 1.0 + clipPos.w;"),t.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),t.push("gl_Position = clipPos;"),t.push("gl_PointSize = 1.0;"),t.push("}"),t.push("}"),t}_buildFragmentShader(){const i=this._scene._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// SnapInstancingDepthRenderer fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;"),t.push("uniform int layerNumber;"),t.push("uniform vec3 coordinateScaler;"),s){t.push("in vec4 vWorldPosition;"),t.push("in float vFlags;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("in highp vec3 relativeToOriginPosition;"),t.push("out highp ivec4 outCoords;"),t.push("void main(void) {"),s){t.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("if (dist > 0.0) { discard; }"),t.push("}")}return t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),t.push("}"),t}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class eB{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._occlusionRenderer&&this._occlusionRenderer.getValid()===!1&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new OP(this._scene,!1)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new kP(this._scene)),this._silhouetteRenderer}get depthRenderer(){return this._depthRenderer||(this._depthRenderer=new VP(this._scene)),this._depthRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new NP(this._scene)),this._pickMeshRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new QP(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new HP(this._scene)),this._occlusionRenderer}get shadowRenderer(){return this._shadowRenderer||(this._shadowRenderer=new jP(this._scene)),this._shadowRenderer}get snapInitRenderer(){return this._snapInitRenderer||(this._snapInitRenderer=new XP(this._scene,!1)),this._snapInitRenderer}get snapRenderer(){return this._snapRenderer||(this._snapRenderer=new JP(this._scene)),this._snapRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}const Na={};function tB(r){const e=r.id;let i=Na[e];return i||(i=new eB(r),Na[e]=i,i._compile(),r.on("compile",()=>{i._compile()}),r.on("destroyed",()=>{delete Na[e],i._destroy()})),i}const No=new Uint8Array(4),Ch=new Float32Array(1),Qo=new Float32Array(3),si=new Float32Array(4);class iB{constructor(e){console.info("VBOInstancingPointsLayer"),this.model=e.model,this.material=e.material,this.sortId="PointsInstancingLayer",this.layerIndex=e.layerIndex,this._renderers=tB(e.model.scene),this._aabb=c.collapseAABB3(),this._state=new Ft({obb:c.OBB3(),numInstances:0,origin:e.origin?c.vec3(e.origin):null,geometry:e.geometry,positionsDecodeMatrix:e.geometry.positionsDecodeMatrix,colorsBuf:null,flagsBuf:null,offsetsBuf:null,modelMatrixCol0Buf:null,modelMatrixCol1Buf:null,modelMatrixCol2Buf:null,pickColorsBuf:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this.numIndices=e.geometry.numIndices,this._pickColors=[],this._offsets=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._portions=[],this._meshes=[],this._aabb=c.collapseAABB3(),this.aabbDirty=!0,this._finalized=!1}get aabb(){if(this.aabbDirty){c.collapseAABB3(this._aabb);for(let e=0,i=this._meshes.length;e<i;e++)c.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}createPortion(e,i){const s=i.meshMatrix,t=i.pickColor;if(this._finalized)throw"Already finalized";this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(s[0]),this._modelMatrixCol0.push(s[4]),this._modelMatrixCol0.push(s[8]),this._modelMatrixCol0.push(s[12]),this._modelMatrixCol1.push(s[1]),this._modelMatrixCol1.push(s[5]),this._modelMatrixCol1.push(s[9]),this._modelMatrixCol1.push(s[13]),this._modelMatrixCol2.push(s[2]),this._modelMatrixCol2.push(s[6]),this._modelMatrixCol2.push(s[10]),this._modelMatrixCol2.push(s[14]),this._pickColors.push(t[0]),this._pickColors.push(t[1]),this._pickColors.push(t[2]),this._pickColors.push(t[3]),this._state.numInstances++;const o=this._portions.length;return this._portions.push({}),this._numPortions++,this.model.numPortions++,this._meshes.push(e),o}finalize(){if(this._finalized)throw"Already finalized";const e=this.model.scene.canvas.gl,i=this._pickColors.length/4,s=this._state,t=s.geometry;if(i>0){let o=!1;s.flagsBuf=new Ee(e,e.ARRAY_BUFFER,new Float32Array(i),i,1,e.DYNAMIC_DRAW,o)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0&&(s.offsetsBuf=new Ee(e,e.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,e.DYNAMIC_DRAW,!1),this._offsets=[]),t.positionsCompressed&&t.positionsCompressed.length>0&&(s.positionsBuf=new Ee(e,e.ARRAY_BUFFER,t.positionsCompressed,t.positionsCompressed.length,3,e.STATIC_DRAW,!1),s.positionsDecodeMatrix=c.mat4(t.positionsDecodeMatrix)),t.colorsCompressed&&t.colorsCompressed.length>0){const o=new Uint8Array(t.colorsCompressed),n=!1;s.colorsBuf=new Ee(e,e.ARRAY_BUFFER,o,o.length,4,e.STATIC_DRAW,n)}this._modelMatrixCol0.length>0&&(s.modelMatrixCol0Buf=new Ee(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,e.STATIC_DRAW,!1),s.modelMatrixCol1Buf=new Ee(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,e.STATIC_DRAW,!1),s.modelMatrixCol2Buf=new Ee(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,e.STATIC_DRAW,!1),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[]),this._pickColors.length>0&&(s.pickColorsBuf=new Ee(e,e.ARRAY_BUFFER,new Uint8Array(this._pickColors),this._pickColors.length,4,e.STATIC_DRAW,!1),this._pickColors=[]),s.geometry=null,this._finalized=!0}initFlags(e,i,s){i&k.VISIBLE&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),i&k.HIGHLIGHTED&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),i&k.XRAYED&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),i&k.SELECTED&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),i&k.CLIPPABLE&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),i&k.EDGES&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),i&k.PICKABLE&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),i&k.CULLED&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),s&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,i,s)}setVisible(e,i,s){if(!this._finalized)throw"Not finalized";i&k.VISIBLE?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,i,s)}setHighlighted(e,i,s){if(!this._finalized)throw"Not finalized";i&k.HIGHLIGHTED?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,i,s)}setXRayed(e,i,s){if(!this._finalized)throw"Not finalized";i&k.XRAYED?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,i,s)}setSelected(e,i,s){if(!this._finalized)throw"Not finalized";i&k.SELECTED?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,i,s)}setEdges(e,i,s){if(!this._finalized)throw"Not finalized";i&k.EDGES?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,i,s)}setClippable(e,i){if(!this._finalized)throw"Not finalized";i&k.CLIPPABLE?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,i)}setCollidable(e,i){if(!this._finalized)throw"Not finalized"}setPickable(e,i,s){if(!this._finalized)throw"Not finalized";i&k.PICKABLE?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,i,s)}setCulled(e,i,s){if(!this._finalized)throw"Not finalized";i&k.CULLED?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,i,s)}setColor(e,i){if(!this._finalized)throw"Not finalized";No[0]=i[0],No[1]=i[1],No[2]=i[2],this._state.colorsBuf.setData(No,e*3)}setTransparent(e,i,s){s?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,i,s)}_setFlags(e,i,s){if(!this._finalized)throw"Not finalized";const t=!!(i&k.VISIBLE),o=!!(i&k.XRAYED),n=!!(i&k.HIGHLIGHTED),a=!!(i&k.SELECTED),A=!!(i&k.EDGES),l=!!(i&k.PICKABLE),h=!!(i&k.CULLED);let d;!t||h||o||n&&!this.model.scene.highlightMaterial.glowThrough||a&&!this.model.scene.selectedMaterial.glowThrough?d=U.NOT_RENDERED:s?d=U.COLOR_TRANSPARENT:d=U.COLOR_OPAQUE;let f;!t||h?f=U.NOT_RENDERED:a?f=U.SILHOUETTE_SELECTED:n?f=U.SILHOUETTE_HIGHLIGHTED:o?f=U.SILHOUETTE_XRAYED:f=U.NOT_RENDERED;let m=0;!t||h?m=U.NOT_RENDERED:a?m=U.EDGES_SELECTED:n?m=U.EDGES_HIGHLIGHTED:o?m=U.EDGES_XRAYED:A?s?m=U.EDGES_COLOR_TRANSPARENT:m=U.EDGES_COLOR_OPAQUE:m=U.NOT_RENDERED;let _=t&&!h&&l?U.PICK:U.NOT_RENDERED;const u=i&k.CLIPPABLE?255:0;let P=0;P|=d,P|=f<<4,P|=m<<8,P|=_<<12,P|=u<<16,Ch[0]=P,this._state.flagsBuf.setData(Ch,e)}setOffset(e,i){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled){this.model.error("Entity#offset not enabled for this Viewer");return}Qo[0]=i[0],Qo[1]=i[1],Qo[2]=i[2],this._state.offsetsBuf.setData(Qo,e*3)}setMatrix(e,i){if(!this._finalized)throw"Not finalized";const s=e*4;si[0]=i[0],si[1]=i[4],si[2]=i[8],si[3]=i[12],this._state.modelMatrixCol0Buf.setData(si,s),si[0]=i[1],si[1]=i[5],si[2]=i[9],si[3]=i[13],this._state.modelMatrixCol1Buf.setData(si,s),si[0]=i[2],si[1]=i[6],si[2]=i[10],si[3]=i[14],this._state.modelMatrixCol2Buf.setData(si,s)}drawColorOpaque(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(i,this,U.COLOR_OPAQUE)}drawColorTransparent(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===0||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(i,this,U.COLOR_TRANSPARENT)}drawDepth(e,i){}drawNormals(e,i){}drawSilhouetteXRayed(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(i,this,U.SILHOUETTE_XRAYED)}drawSilhouetteHighlighted(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(i,this,U.SILHOUETTE_HIGHLIGHTED)}drawSilhouetteSelected(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(i,this,U.SILHOUETTE_SELECTED)}drawEdgesColorOpaque(e,i){}drawEdgesColorTransparent(e,i){}drawEdgesHighlighted(e,i){}drawEdgesSelected(e,i){}drawEdgesXRayed(e,i){}drawOcclusion(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.occlusionRenderer&&this._renderers.occlusionRenderer.drawLayer(i,this,U.COLOR_OPAQUE)}drawShadow(e,i){}drawPickMesh(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.pickMeshRenderer&&this._renderers.pickMeshRenderer.drawLayer(i,this,U.PICK)}drawPickDepths(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.pickDepthRenderer&&this._renderers.pickDepthRenderer.drawLayer(i,this,U.PICK)}drawPickNormals(e,i){}drawSnapInit(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(i,this,U.PICK)}drawSnap(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(i,this,U.PICK)}destroy(){const e=this._state;e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.modelMatrixCol0Buf&&(e.modelMatrixCol0Buf.destroy(),e.modelMatrixCol0Buf=null),e.modelMatrixCol1Buf&&(e.modelMatrixCol1Buf.destroy(),e.modelMatrixCol1Buf=null),e.modelMatrixCol2Buf&&(e.modelMatrixCol2Buf.destroy(),e.modelMatrixCol2Buf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.destroy()}}const Eh=c.vec3(),sB=c.vec3(),rB=c.mat4();class oB{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,i,s){const t=this._scene,o=t.camera,n=i.model,a=t.canvas.gl,A=i._state,l=A.textureState,h=i._state.origin,{position:d,rotationMatrix:f,rotationMatrixConjugate:m}=n,_=o.viewMatrix;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,A)),l.bindCommonTextures(this._program,this.uPerObjectDecodeMatrix,this._uPerVertexPosition,this.uPerObjectColorAndFlags,this._uPerObjectMatrix);let u;const P=h[0]!==0||h[1]!==0||h[2]!==0,y=d[0]!==0||d[1]!==0||d[2]!==0;if(P||y){const v=Eh;if(P){const w=c.transformPoint3(f,h,sB);v[0]=w[0],v[1]=w[1],v[2]=w[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=d[0],v[1]+=d[1],v[2]+=d[2],u=ft(_,v,rB)}else u=_;if(a.uniformMatrix4fv(this._uSceneModelMatrix,!1,m),a.uniformMatrix4fv(this._uViewMatrix,!1,u),a.uniformMatrix4fv(this._uProjMatrix,!1,o.projMatrix),a.uniform1i(this._uRenderPass,s),t.logarithmicDepthBufferEnabled){const v=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,v)}const x=t._sectionPlanesState.getNumAllocatedSectionPlanes(),B=t._sectionPlanesState.sectionPlanes.length;if(x>0){const v=t._sectionPlanesState.sectionPlanes,w=i.layerIndex*B,C=n.renderFlags;for(let I=0;I<x;I++){const E=this._uSectionPlanes[I];if(E)if(I<B){const S=C.sectionPlanesActivePerLayer[w+I];if(a.uniform1i(E.active,S?1:0),S){const R=v[I];if(h){const D=Ut(R.dist,R.dir,h,Eh);a.uniform3fv(E.pos,D)}else a.uniform3fv(E.pos,R.pos);a.uniform3fv(E.dir,R.dir)}}else a.uniform1i(E.active,0)}}A.numIndices8Bits>0&&(l.bindLineIndicesTextures(this._program,this._uPerLineObject,this._uPerLineIndices,8),a.drawArrays(a.LINES,0,A.numIndices8Bits)),A.numIndices16Bits>0&&(l.bindLineIndicesTextures(this._program,this._uPerLineObject,this._uPerLineIndices,16),a.drawArrays(a.LINES,0,A.numIndices16Bits)),A.numIndices32Bits>0&&(l.bindLineIndicesTextures(this._program,this._uPerLineObject,this._uPerLineIndices,32),a.drawArrays(a.LINES,0,A.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,i=e.canvas.gl;if(this._program=new It(i,this._buildShader()),this._program.errors){this.errors=this._program.errors,console.error(this.errors);return}const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uSceneModelMatrix=s.getLocation("sceneModelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<o;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),this.uPerObjectDecodeMatrix="uPerObjectDecodeMatrix",this.uPerObjectColorAndFlags="uPerObjectColorAndFlags",this._uPerVertexPosition="uPerVertexPosition",this._uPerLineIndices="uPerLineIndices",this._uPerLineObject="uPerLineObject",this._uPerObjectMatrix="uPerObjectMatrix",this._uCameraEyeRtc=s.getLocation("uCameraEyeRtc")}_bindProgram(e){const i=this._scene,s=i.canvas.gl,t=this._program,o=i.camera.project;if(t.bind(),i.logarithmicDepthBufferEnabled){const n=2/(Math.log(o.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,n)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// LinesDataTextureColorRenderer"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),e.entityOffsetsEnabled,s.push("uniform mat4 sceneModelMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform highp sampler2D uPerObjectDecodeMatrix;"),s.push("uniform highp sampler2D uPerObjectMatrix;"),s.push("uniform lowp usampler2D uPerObjectColorAndFlags;"),s.push("uniform mediump usampler2D uPerVertexPosition;"),s.push("uniform highp usampler2D uPerLineIndices;"),s.push("uniform mediump usampler2D uPerLineObject;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("flat out uint vFlags2;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("  int lineIndex = gl_VertexID / 2;"),s.push("  int h_packed_object_id_index = (lineIndex >> 3) & 4095;"),s.push("  int v_packed_object_id_index = (lineIndex >> 3) >> 12;"),s.push("  int objectIndex = int(texelFetch(uPerLineObject, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),s.push("  ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),s.push("  uvec4 flags = texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),s.push("  uvec4 flags2 = texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),s.push("  if (int(flags.x) != renderPass) {"),s.push("      gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),s.push("      return;"),s.push("  } else {"),s.push("      ivec4 packedVertexBase = ivec4(texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),s.push("      ivec4 packedLineIndexBaseOffset = ivec4(texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0));"),s.push("      int lineIndexBaseOffset = (packedLineIndexBaseOffset.r << 24) + (packedLineIndexBaseOffset.g << 16) + (packedLineIndexBaseOffset.b << 8) + packedLineIndexBaseOffset.a;"),s.push("      int h_index = (lineIndex - lineIndexBaseOffset) & 4095;"),s.push("      int v_index = (lineIndex - lineIndexBaseOffset) >> 12;"),s.push("      ivec3 vertexIndices = ivec3(texelFetch(uPerLineIndices, ivec2(h_index, v_index), 0));"),s.push("      ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),s.push("      int indexPositionH = uniqueVertexIndexes[gl_VertexID % 2] & 4095;"),s.push("      int indexPositionV = uniqueVertexIndexes[gl_VertexID % 2] >> 12;"),s.push("      mat4 objectInstanceMatrix = mat4 (texelFetch (uPerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uPerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uPerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uPerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),s.push("      mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uPerObjectDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uPerObjectDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uPerObjectDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uPerObjectDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),s.push("      uvec4 flags = texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),s.push("      uvec4 flags2 = texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),s.push("      vec3 position = vec3(texelFetch(uPerVertexPosition, ivec2(indexPositionH, indexPositionV), 0));"),s.push("      uvec4 color = texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),s.push("      if (color.a == 0u) {"),s.push("          gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),s.push("          return;"),s.push("      };"),s.push("      vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags2 = flags2.r;")),s.push("      vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("      vFragDepth = 1.0 + clipPos.w;"),s.push("      isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("      gl_Position = clipPos;"),s.push("      vec4 rgb = vec4(color.rgba);"),s.push("      vColor = vec4(float(rgb.r*0.5) / 255.0, float(rgb.g*0.5) / 255.0, float(rgb.b*0.5) / 255.0, float(rgb.a) / 255.0);"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// LinesDataTextureColorRenderer fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),s){t.push("in vec4 vWorldPosition;"),t.push("flat in uint vFlags2;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("in vec4 vColor;"),t.push("out vec4 outColor;"),t.push("void main(void) {"),s){t.push("  bool clippable = vFlags2 > 0u;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("  if (dist > 0.0) { "),t.push("      discard;"),t.push("  }"),t.push("}")}return e.logarithmicDepthBufferEnabled&&t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),t.push("   outColor            = vColor;"),t.push("}"),t}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class nB{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null)}eagerCreateRenders(){}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new oB(this._scene,!1)),this._colorRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy()}}const Qa={};function aB(r){const e=r.id;let i=Qa[e];return i||(i=new nB(r),Qa[e]=i,i._compile(),i.eagerCreateRenders(),r.on("compile",()=>{i._compile(),i.eagerCreateRenders()}),r.on("destroyed",()=>{delete Qa[e],i._destroy()})),i}class AB{constructor(){this.positionsCompressed=[],this.lenPositionsCompressed=0,this.indices8Bits=[],this.lenIndices8Bits=0,this.indices16Bits=[],this.lenIndices16Bits=0,this.indices32Bits=[],this.lenIndices32Bits=0,this.perObjectColors=[],this.perObjectPickColors=[],this.perObjectSolid=[],this.perObjectOffsets=[],this.perObjectPositionsDecodeMatrices=[],this.perObjectInstancePositioningMatrices=[],this.perObjectVertexBases=[],this.perObjectIndexBaseOffsets=[],this.perLineNumberPortionId8Bits=[],this.perLineNumberPortionId16Bits=[],this.perLineNumberPortionId32Bits=[]}}class lB{constructor(){this.texturePerObjectColorsAndFlags=null,this.texturePerObjectOffsets=null,this.texturePerObjectInstanceMatrices=null,this.texturePerObjectPositionsDecodeMatrix=null,this.texturePerVertexIdCoordinates=null,this.texturePerLineIdPortionIds8Bits=null,this.texturePerLineIdPortionIds16Bits=null,this.texturePerLineIdPortionIds32Bits=null,this.texturePerLineIdIndices8Bits=null,this.texturePerLineIdIndices16Bits=null,this.texturePerLineIdIndices32Bits=null,this.textureModelMatrices=null}finalize(){this.indicesPerBitnessTextures={8:this.texturePerLineIdIndices8Bits,16:this.texturePerLineIdIndices16Bits,32:this.texturePerLineIdIndices32Bits},this.indicesPortionIdsPerBitnessTextures={8:this.texturePerLineIdPortionIds8Bits,16:this.texturePerLineIdPortionIds16Bits,32:this.texturePerLineIdPortionIds32Bits}}bindCommonTextures(e,i,s,t,o){this.texturePerObjectPositionsDecodeMatrix.bindTexture(e,i,1),this.texturePerVertexIdCoordinates.bindTexture(e,s,2),this.texturePerObjectColorsAndFlags.bindTexture(e,t,3),this.texturePerObjectInstanceMatrices.bindTexture(e,o,4)}bindLineIndicesTextures(e,i,s,t){this.indicesPortionIdsPerBitnessTextures[t].bindTexture(e,i,5),this.indicesPerBitnessTextures[t].bindTexture(e,s,6)}}class Lt{constructor(e,i,s,t,o=null){this._gl=e,this._texture=i,this._textureWidth=s,this._textureHeight=t,this._textureData=o}bindTexture(e,i,s){return e.bindTexture(i,this,s)}bind(e){return this._gl.activeTexture(this._gl["TEXTURE"+e]),this._gl.bindTexture(this._gl.TEXTURE_2D,this._texture),!0}unbind(e){}}const ct={sizeDataColorsAndFlags:0,sizeDataPositionDecodeMatrices:0,sizeDataTextureOffsets:0,sizeDataTexturePositions:0,sizeDataTextureIndices:0,sizeDataTexturePortionIds:0,numberOfGeometries:0,numberOfPortions:0,numberOfLayers:0,numberOfTextures:0,totalLines:0,totalLines8Bits:0,totalLines16Bits:0,totalLines32Bits:0,cannotCreatePortion:{because10BitsObjectId:0,becauseTextureSize:0},overheadSizeAlignementIndices:0,overheadSizeAlignementEdgeIndices:0};window.printDataTextureRamStats=function(){console.log(JSON.stringify(ct,null,4));let r=0;Object.keys(ct).forEach(i=>{i.startsWith("size")&&(r+=ct[i])}),console.log(`Total size ${r} bytes (${(r/1e3/1e3).toFixed(2)} MB)`),console.log(`Avg bytes / triangle: ${(r/ct.totalLines).toFixed(2)}`);let e={};Object.keys(ct).forEach(i=>{i.startsWith("size")&&(e[i]=`${(ct[i]/r*100).toFixed(2)} % of total`)}),console.log(JSON.stringify({percentualRamUsage:e},null,4))};class cB{disableBindedTextureFiltering(e){e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)}generateTextureForColorsAndFlags(e,i,s,t,o){const n=i.length;this.numPortions=n;const a=512*8,A=Math.ceil(n/(a/8));if(A===0)throw"texture height===0";const l=new Uint8Array(4*a*A);ct.sizeDataColorsAndFlags+=l.byteLength,ct.numberOfTextures++;for(let d=0;d<n;d++)l.set(i[d],d*32+0),l.set(s[d],d*32+4),l.set([0,0,0,0],d*32+8),l.set([0,0,0,0],d*32+12),l.set([t[d]>>24&255,t[d]>>16&255,t[d]>>8&255,t[d]&255],d*32+16),l.set([o[d]>>24&255,o[d]>>16&255,o[d]>>8&255,o[d]&255],d*32+20);const h=e.createTexture();return e.bindTexture(e.TEXTURE_2D,h),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA8UI,a,A),e.texSubImage2D(e.TEXTURE_2D,0,0,0,a,A,e.RGBA_INTEGER,e.UNSIGNED_BYTE,l,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Lt(e,h,a,A,l)}generateTextureForObjectOffsets(e,i){const t=Math.ceil(i/512);if(t===0)throw"texture height===0";const o=new Float32Array(3*512*t).fill(0);ct.sizeDataTextureOffsets+=o.byteLength,ct.numberOfTextures++;const n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RGB32F,512,t),e.texSubImage2D(e.TEXTURE_2D,0,0,0,512,t,e.RGB,e.FLOAT,o,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Lt(e,n,512,t,o)}generateTextureForInstancingMatrices(e,i){const s=i.length;if(s===0)throw"num instance matrices===0";const t=512*4,o=Math.ceil(s/(t/4)),n=new Float32Array(4*t*o);ct.numberOfTextures++;for(let A=0;A<i.length;A++)n.set(i[A],A*16);const a=e.createTexture();return e.bindTexture(e.TEXTURE_2D,a),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA32F,t,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,t,o,e.RGBA,e.FLOAT,n,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Lt(e,a,t,o,n)}generateTextureForPositionsDecodeMatrices(e,i){const s=i.length;if(s===0)throw"num decode+entity matrices===0";const t=512*4,o=Math.ceil(s/(t/4)),n=new Float32Array(4*t*o);ct.sizeDataPositionDecodeMatrices+=n.byteLength,ct.numberOfTextures++;for(let A=0;A<i.length;A++)n.set(i[A],A*16);const a=e.createTexture();return e.bindTexture(e.TEXTURE_2D,a),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA32F,t,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,t,o,e.RGBA,e.FLOAT,n,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Lt(e,a,t,o)}generateTextureFor8BitIndices(e,i,s){if(s===0)return{texture:null,textureHeight:0};const t=4096,o=Math.ceil(s/3/t);if(o===0)throw"texture height===0";const n=t*o*3,a=new Uint8Array(n);ct.sizeDataTextureIndices+=a.byteLength,ct.numberOfTextures++;for(let l=0,h=0,d=i.length;l<d;l++){const f=i[l];a.set(f,h),h+=f.length}const A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.RGB8UI,t,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,t,o,e.RGB_INTEGER,e.UNSIGNED_BYTE,a,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Lt(e,A,t,o)}generateTextureFor16BitIndices(e,i,s){if(s===0)return{texture:null,textureHeight:0};const t=4096,o=Math.ceil(s/3/t);if(o===0)throw"texture height===0";const n=t*o*3,a=new Uint16Array(n);ct.sizeDataTextureIndices+=a.byteLength,ct.numberOfTextures++;for(let l=0,h=0,d=i.length;l<d;l++){const f=i[l];a.set(f,h),h+=f.length}const A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.RGB16UI,t,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,t,o,e.RGB_INTEGER,e.UNSIGNED_SHORT,a,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Lt(e,A,t,o)}generateTextureFor32BitIndices(e,i,s){if(s===0)return{texture:null,textureHeight:0};const t=4096,o=Math.ceil(s/3/t);if(o===0)throw"texture height===0";const n=t*o*3,a=new Uint32Array(n);ct.sizeDataTextureIndices+=a.byteLength,ct.numberOfTextures++;for(let l=0,h=0,d=i.length;l<d;l++){const f=i[l];a.set(f,h),h+=f.length}const A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.RGB32UI,t,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,t,o,e.RGB_INTEGER,e.UNSIGNED_INT,a,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Lt(e,A,t,o)}generateTextureForPositions(e,i,s){const t=s/3,o=4096,n=Math.ceil(t/o);if(n===0)throw"texture height===0";const a=o*n*3,A=new Uint16Array(a);ct.sizeDataTexturePositions+=A.byteLength,ct.numberOfTextures++;for(let h=0,d=0,f=i.length;h<f;h++){const m=i[h];A.set(m,d),d+=m.length}const l=e.createTexture();return e.bindTexture(e.TEXTURE_2D,l),e.texStorage2D(e.TEXTURE_2D,1,e.RGB16UI,o,n),e.texSubImage2D(e.TEXTURE_2D,0,0,0,o,n,e.RGB_INTEGER,e.UNSIGNED_SHORT,A,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Lt(e,l,o,n)}generateTextureForPackedPortionIds(e,i){if(i.length===0)return{texture:null,textureHeight:0};const s=i.length,t=4096,o=Math.ceil(s/t);if(o===0)throw"texture height===0";const n=t*o,a=new Uint16Array(n);a.set(i,0),ct.sizeDataTexturePortionIds+=a.byteLength,ct.numberOfTextures++;const A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.R16UI,t,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,t,o,e.RED_INTEGER,e.UNSIGNED_SHORT,a,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Lt(e,A,t,o)}}const hB=new yl,Ih=65536,Ho=hB.maxDataTextureHeight,Ha=8,Fr=10,Va=new Float32Array(16),Wt=new Uint8Array(4),Mr=new Float32Array(3);let uB=0;const dB=c.identityMat4();class pB{constructor(e,i){console.info("Creating DTXLinesLayer"),ct.numberOfLayers++,this._layerNumber=uB++,this.sortId=`TriDTX-${this._layerNumber}`,this.layerIndex=i.layerIndex,this._renderers=aB(e.scene),this.model=e,this._buffer=new AB,this._dataTextureState=new lB,this._dataTextureGenerator=new cB,this._state=new Ft({origin:c.vec3(i.origin),textureState:this._dataTextureState,numIndices8Bits:0,numIndices16Bits:0,numIndices32Bits:0,numVertices:0}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._subPortions=[],this._portionToSubPortionsMap=[],this._bucketGeometries={},this._meshes=[],this._aabb=c.collapseAABB3(),this.aabbDirty=!0,this._numUpdatesInFrame=0,this._finalized=!1}get aabb(){if(this.aabbDirty){c.collapseAABB3(this._aabb);for(let e=0,i=this._meshes.length;e<i;e++)c.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}canCreatePortion(e){if(this._finalized)throw"Already finalized";const i=e.buckets.length;this._numPortions+i>Ih&&ct.cannotCreatePortion.because10BitsObjectId++;let s=this._numPortions+i<=Ih;const t=0,o=e.geometryId!==void 0&&e.geometryId!==null?`${e.geometryId}#${t}`:`${e.id}#${t}`;if(!this._bucketGeometries[o]){const a=Math.max(this._state.numIndices8Bits,this._state.numIndices16Bits,this._state.numIndices32Bits);let A=0,l=0;e.buckets.forEach(h=>{A+=h.positionsCompressed.length/3,l+=h.indices.length/2}),(this._state.numVertices+A>Ho*4096||a+l>Ho*4096)&&ct.cannotCreatePortion.becauseTextureSize++,s&&(s=this._state.numVertices+A<=Ho*4096&&a+l<=Ho*4096)}return s}createPortion(e,i){if(this._finalized)throw"Already finalized";const s=[];i.buckets.forEach((o,n)=>{const a=i.geometryId!==void 0&&i.geometryId!==null?`${i.geometryId}#${n}`:`${i.id}#${n}`;let A=this._bucketGeometries[a];A||(A=this._createBucketGeometry(i,o),this._bucketGeometries[a]=A);const l=this._createSubPortion(i,A,o);s.push(l)});const t=this._portionToSubPortionsMap.length;return this._portionToSubPortionsMap.push(s),this.model.numPortions++,this._meshes.push(e),t}_createBucketGeometry(e,i){if(i.indices){const d=Math.ceil(i.indices.length/2/Ha)*Ha*2;ct.overheadSizeAlignementIndices+=2*(d-i.indices.length);const f=new Uint32Array(d);f.fill(0),f.set(i.indices),i.indices=f}const s=i.positionsCompressed,t=i.indices,o=this._buffer;o.positionsCompressed.push(s);const n=o.lenPositionsCompressed/3,a=s.length/3;o.lenPositionsCompressed+=s.length;let A,l=0;if(t){l=t.length/2;let d;a<=256?(d=o.indices8Bits,A=o.lenIndices8Bits/2,o.lenIndices8Bits+=t.length):a<=65536?(d=o.indices16Bits,A=o.lenIndices16Bits/2,o.lenIndices16Bits+=t.length):(d=o.indices32Bits,A=o.lenIndices32Bits/2,o.lenIndices32Bits+=t.length),d.push(t)}return this._state.numVertices+=a,ct.numberOfGeometries++,{vertexBase:n,numVertices:a,numLines:l,indicesBase:A}}_createSubPortion(e,i){const s=e.color,t=e.colors,o=e.opacity,n=e.meshMatrix,a=e.pickColor,A=this._buffer,l=this._state;A.perObjectPositionsDecodeMatrices.push(e.positionsDecodeMatrix),A.perObjectInstancePositioningMatrices.push(n||dB),A.perObjectSolid.push(!!e.solid),t?A.perObjectColors.push([t[0]*255,t[1]*255,t[2]*255,255]):s&&A.perObjectColors.push([s[0],s[1],s[2],o]),A.perObjectPickColors.push(a),A.perObjectVertexBases.push(i.vertexBase);{let d;i.numVertices<=256?d=l.numIndices8Bits:i.numVertices<=65536?d=l.numIndices16Bits:d=l.numIndices32Bits,A.perObjectIndexBaseOffsets.push(d/2-i.indicesBase)}const h=this._subPortions.length;if(i.numLines>0){let d=i.numLines*2,f;i.numVertices<=256?(f=A.perLineNumberPortionId8Bits,l.numIndices8Bits+=d,ct.totalLines8Bits+=i.numLines):i.numVertices<=65536?(f=A.perLineNumberPortionId16Bits,l.numIndices16Bits+=d,ct.totalLines16Bits+=i.numLines):(f=A.perLineNumberPortionId32Bits,l.numIndices32Bits+=d,ct.totalLines32Bits+=i.numLines),ct.totalLines+=i.numLines;for(let m=0;m<i.numLines;m+=Ha)f.push(h)}return this._subPortions.push({numVertices:i.numLines}),this._numPortions++,ct.numberOfPortions++,h}finalize(){if(this._finalized)return;const e=this._state,i=this._dataTextureState,s=this.model.scene.canvas.gl,t=this._buffer;e.gl=s,i.texturePerObjectColorsAndFlags=this._dataTextureGenerator.generateTextureForColorsAndFlags(s,t.perObjectColors,t.perObjectPickColors,t.perObjectVertexBases,t.perObjectIndexBaseOffsets,t.perObjectSolid),i.texturePerObjectInstanceMatrices=this._dataTextureGenerator.generateTextureForInstancingMatrices(s,t.perObjectInstancePositioningMatrices),i.texturePerObjectPositionsDecodeMatrix=this._dataTextureGenerator.generateTextureForPositionsDecodeMatrices(s,t.perObjectPositionsDecodeMatrices),i.texturePerVertexIdCoordinates=this._dataTextureGenerator.generateTextureForPositions(s,t.positionsCompressed,t.lenPositionsCompressed),i.texturePerLineIdPortionIds8Bits=this._dataTextureGenerator.generateTextureForPackedPortionIds(s,t.perLineNumberPortionId8Bits),i.texturePerLineIdPortionIds16Bits=this._dataTextureGenerator.generateTextureForPackedPortionIds(s,t.perLineNumberPortionId16Bits),i.texturePerLineIdPortionIds32Bits=this._dataTextureGenerator.generateTextureForPackedPortionIds(s,t.perLineNumberPortionId32Bits),t.lenIndices8Bits>0&&(i.texturePerLineIdIndices8Bits=this._dataTextureGenerator.generateTextureFor8BitIndices(s,t.indices8Bits,t.lenIndices8Bits)),t.lenIndices16Bits>0&&(i.texturePerLineIdIndices16Bits=this._dataTextureGenerator.generateTextureFor16BitIndices(s,t.indices16Bits,t.lenIndices16Bits)),t.lenIndices32Bits>0&&(i.texturePerLineIdIndices32Bits=this._dataTextureGenerator.generateTextureFor32BitIndices(s,t.indices32Bits,t.lenIndices32Bits)),i.finalize(),this._buffer=null,this._bucketGeometries={},this._finalized=!0,this._deferredSetFlagsDirty=!1,this._onSceneRendering=this.model.scene.on("rendering",()=>{this._deferredSetFlagsDirty&&this._uploadDeferredFlags(),this._numUpdatesInFrame=0})}initFlags(e,i,s){i&k.VISIBLE&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),i&k.HIGHLIGHTED&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),i&k.XRAYED&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),i&k.SELECTED&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),i&k.CLIPPABLE&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),i&k.PICKABLE&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),i&k.CULLED&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),s&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++);const t=!0;this._setFlags(e,i,s,t),this._setFlags2(e,i,t)}flushInitFlags(){this._setDeferredFlags(),this._setDeferredFlags2()}setVisible(e,i,s){if(!this._finalized)throw"Not finalized";i&k.VISIBLE?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,i,s)}setHighlighted(e,i,s){if(!this._finalized)throw"Not finalized";i&k.HIGHLIGHTED?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,i,s)}setXRayed(e,i,s){if(!this._finalized)throw"Not finalized";i&k.XRAYED?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,i,s)}setSelected(e,i,s){if(!this._finalized)throw"Not finalized";i&k.SELECTED?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,i,s)}setEdges(e,i,s){}setClippable(e,i){if(!this._finalized)throw"Not finalized";i&k.CLIPPABLE?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(e,i)}_beginDeferredFlags(){this._deferredSetFlagsActive=!0}_uploadDeferredFlags(){if(this._deferredSetFlagsActive=!1,!this._deferredSetFlagsDirty)return;this._deferredSetFlagsDirty=!1;const e=this.model.scene.canvas.gl,i=this._dataTextureState;e.bindTexture(e.TEXTURE_2D,i.texturePerObjectColorsAndFlags._texture),e.texSubImage2D(e.TEXTURE_2D,0,0,0,i.texturePerObjectColorsAndFlags._textureWidth,i.texturePerObjectColorsAndFlags._textureHeight,e.RGBA_INTEGER,e.UNSIGNED_BYTE,i.texturePerObjectColorsAndFlags._textureData)}setCulled(e,i,s){if(!this._finalized)throw"Not finalized";i&k.CULLED?(this._numCulledLayerPortions+=this._portionToSubPortionsMap[e].length,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions-=this._portionToSubPortionsMap[e].length,this.model.numCulledLayerPortions--),this._setFlags(e,i,s)}setCollidable(e,i){if(!this._finalized)throw"Not finalized"}setPickable(e,i,s){if(!this._finalized)throw"Not finalized";i&k.PICKABLE?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,i,s)}setColor(e,i){const s=this._portionToSubPortionsMap[e];for(let t=0,o=s.length;t<o;t++)this._subPortionSetColor(s[t],i)}_subPortionSetColor(e,i){if(!this._finalized)throw"Not finalized";const s=this._dataTextureState,t=this.model.scene.canvas.gl;if(Wt[0]=i[0],Wt[1]=i[1],Wt[2]=i[2],Wt[3]=i[3],s.texturePerObjectColorsAndFlags._textureData.set(Wt,e*32),this._deferredSetFlagsActive){this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=Fr&&this._beginDeferredFlags(),t.bindTexture(t.TEXTURE_2D,s.texturePerObjectColorsAndFlags._texture),t.texSubImage2D(t.TEXTURE_2D,0,e%512*8,Math.floor(e/512),1,1,t.RGBA_INTEGER,t.UNSIGNED_BYTE,Wt)}setTransparent(e,i,s){s?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,i,s)}_setFlags(e,i,s,t=!1){const o=this._portionToSubPortionsMap[e];for(let n=0,a=o.length;n<a;n++)this._subPortionSetFlags(o[n],i,s,t)}_subPortionSetFlags(e,i,s,t=!1){if(!this._finalized)throw"Not finalized";const o=!!(i&k.VISIBLE),n=!!(i&k.XRAYED),a=!!(i&k.HIGHLIGHTED),A=!!(i&k.SELECTED),l=!!(i&k.PICKABLE),h=!!(i&k.CULLED);let d;!o||h||n?d=U.NOT_RENDERED:s?d=U.COLOR_TRANSPARENT:d=U.COLOR_OPAQUE;let f;!o||h?f=U.NOT_RENDERED:A?f=U.SILHOUETTE_SELECTED:a?f=U.SILHOUETTE_HIGHLIGHTED:n?f=U.SILHOUETTE_XRAYED:f=U.NOT_RENDERED;let m=o&&!h&&l?U.PICK:U.NOT_RENDERED;const _=this._dataTextureState,u=this.model.scene.canvas.gl;if(Wt[0]=d,Wt[1]=f,Wt[3]=m,_.texturePerObjectColorsAndFlags._textureData.set(Wt,e*32+8),this._deferredSetFlagsActive||t){this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=Fr&&this._beginDeferredFlags(),u.bindTexture(u.TEXTURE_2D,_.texturePerObjectColorsAndFlags._texture),u.texSubImage2D(u.TEXTURE_2D,0,e%512*8+2,Math.floor(e/512),1,1,u.RGBA_INTEGER,u.UNSIGNED_BYTE,Wt)}_setDeferredFlags(){}_setFlags2(e,i,s=!1){const t=this._portionToSubPortionsMap[e];for(let o=0,n=t.length;o<n;o++)this._subPortionSetFlags2(t[o],i,s)}_subPortionSetFlags2(e,i,s=!1){if(!this._finalized)throw"Not finalized";const t=i&k.CLIPPABLE?255:0,o=this._dataTextureState,n=this.model.scene.canvas.gl;if(Wt[0]=t,Wt[1]=0,Wt[2]=1,Wt[3]=2,o.texturePerObjectColorsAndFlags._textureData.set(Wt,e*32+12),this._deferredSetFlagsActive||s){this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=Fr&&this._beginDeferredFlags(),n.bindTexture(n.TEXTURE_2D,o.texturePerObjectColorsAndFlags._texture),n.texSubImage2D(n.TEXTURE_2D,0,e%512*8+3,Math.floor(e/512),1,1,n.RGBA_INTEGER,n.UNSIGNED_BYTE,Wt)}_setDeferredFlags2(){}setOffset(e,i){const s=this._portionToSubPortionsMap[e];for(let t=0,o=s.length;t<o;t++)this._subPortionSetOffset(s[t],i)}_subPortionSetOffset(e,i){if(!this._finalized)throw"Not finalized";const s=this._dataTextureState,t=this.model.scene.canvas.gl;if(Mr[0]=i[0],Mr[1]=i[1],Mr[2]=i[2],s.texturePerObjectOffsets._textureData.set(Mr,e*3),this._deferredSetFlagsActive){this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=Fr&&this._beginDeferredFlags(),t.bindTexture(t.TEXTURE_2D,s.texturePerObjectOffsets._texture),t.texSubImage2D(t.TEXTURE_2D,0,0,e,1,1,t.RGB,t.FLOAT,Mr)}setMatrix(e,i){const s=this._portionToSubPortionsMap[e];for(let t=0,o=s.length;t<o;t++)this._subPortionSetMatrix(s[t],i)}_subPortionSetMatrix(e,i){if(!this._finalized)throw"Not finalized";const s=this._dataTextureState,t=this.model.scene.canvas.gl;if(Va.set(i),s.texturePerObjectInstanceMatrices._textureData.set(Va,e*16),this._deferredSetFlagsActive){this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=Fr&&this._beginDeferredFlags(),t.bindTexture(t.TEXTURE_2D,s.texturePerObjectInstanceMatrices._texture),t.texSubImage2D(t.TEXTURE_2D,0,e%512*4,Math.floor(e/512),4,1,t.RGBA,t.FLOAT,Va)}drawColorOpaque(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(i,this,U.COLOR_OPAQUE)}drawColorTransparent(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===0||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(i,this,U.COLOR_TRANSPARENT)}drawDepth(e,i){}drawNormals(e,i){}drawSilhouetteXRayed(e,i){}drawSilhouetteHighlighted(e,i){}drawSilhouetteSelected(e,i){}drawEdgesColorOpaque(e,i){}drawEdgesColorTransparent(e,i){}drawEdgesHighlighted(e,i){}drawEdgesSelected(e,i){}drawEdgesXRayed(e,i){}drawOcclusion(e,i){}drawShadow(e,i){}setPickMatrices(e,i){}drawPickMesh(e,i){}drawPickDepths(e,i){}drawSnapInit(e,i){}drawSnap(e,i){}drawPickNormals(e,i){}destroy(){if(this._destroyed)return;const e=this._state;this.model.scene.off(this._onSceneRendering),e.destroy(),this._destroyed=!0}}const Fh=c.vec3(),fB=c.vec3(),gB=c.vec3();c.vec3();const Sr=c.vec4(),mB=c.mat4();class Mh{constructor(e,i){this._scene=e,this._withSAO=i,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){const e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,i,s){const t=this._scene,o=t.camera,n=i.model,a=t.canvas.gl,A=i._state,l=A.textureState,h=i._state.origin,{position:d,rotationMatrix:f,rotationMatrixConjugate:m}=n;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,A)),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let _,u;const P=h[0]!==0||h[1]!==0||h[2]!==0,y=d[0]!==0||d[1]!==0||d[2]!==0;if(P||y){const v=Fh;if(P){const w=c.transformPoint3(f,h,fB);v[0]=w[0],v[1]=w[1],v[2]=w[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=d[0],v[1]+=d[1],v[2]+=d[2],_=ft(o.viewMatrix,v,mB),u=gB,u[0]=o.eye[0]-v[0],u[1]=o.eye[1]-v[1],u[2]=o.eye[2]-v[2]}else _=o.viewMatrix,u=o.eye;if(a.uniformMatrix4fv(this._uSceneModelMatrix,!1,m),a.uniformMatrix4fv(this._uViewMatrix,!1,_),a.uniformMatrix4fv(this._uProjMatrix,!1,o.projMatrix),a.uniform3fv(this._uCameraEyeRtc,u),a.uniform1i(this._uRenderPass,s),t.logarithmicDepthBufferEnabled){const v=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,v)}const x=t._sectionPlanesState.getNumAllocatedSectionPlanes(),B=t._sectionPlanesState.sectionPlanes.length;if(x>0){const v=t._sectionPlanesState.sectionPlanes,w=i.layerIndex*B,C=n.renderFlags;for(let I=0;I<x;I++){const E=this._uSectionPlanes[I];if(E)if(I<B){const S=C.sectionPlanesActivePerLayer[w+I];if(a.uniform1i(E.active,S?1:0),S){const R=v[I];if(h){const D=Ut(R.dist,R.dir,h,Fh);a.uniform3fv(E.pos,D)}else a.uniform3fv(E.pos,R.pos);a.uniform3fv(E.dir,R.dir)}}else a.uniform1i(E.active,0)}}A.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),a.drawArrays(a.TRIANGLES,0,A.numIndices8Bits)),A.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),a.drawArrays(a.TRIANGLES,0,A.numIndices16Bits)),A.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),a.drawArrays(a.TRIANGLES,0,A.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,i=e.canvas.gl,s=e._lightsState;if(this._program=new It(i,this._buildShader()),this._program.errors){this.errors=this._program.errors,console.error(this.errors);return}const t=this._program;this._uRenderPass=t.getLocation("renderPass"),this._uLightAmbient=t.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const o=s.lights;let n;for(let a=0,A=o.length;a<A;a++)switch(n=o[a],n.type){case"dir":this._uLightColor[a]=t.getLocation("lightColor"+a),this._uLightPos[a]=null,this._uLightDir[a]=t.getLocation("lightDir"+a);break;case"point":this._uLightColor[a]=t.getLocation("lightColor"+a),this._uLightPos[a]=t.getLocation("lightPos"+a),this._uLightDir[a]=null,this._uLightAttenuation[a]=t.getLocation("lightAttenuation"+a);break;case"spot":this._uLightColor[a]=t.getLocation("lightColor"+a),this._uLightPos[a]=t.getLocation("lightPos"+a),this._uLightDir[a]=t.getLocation("lightDir"+a),this._uLightAttenuation[a]=t.getLocation("lightAttenuation"+a);break}this._uSceneModelMatrix=t.getLocation("sceneModelMatrix"),this._uViewMatrix=t.getLocation("viewMatrix"),this._uProjMatrix=t.getLocation("projMatrix"),this._uSectionPlanes=[];for(let a=0,A=e._sectionPlanesState.getNumAllocatedSectionPlanes();a<A;a++)this._uSectionPlanes.push({active:t.getLocation("sectionPlaneActive"+a),pos:t.getLocation("sectionPlanePos"+a),dir:t.getLocation("sectionPlaneDir"+a)});this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=t.getLocation("uSAOParams")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=t.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=t.getLocation("uCameraEyeRtc")}_bindProgram(e){const i=this._scene,s=i.canvas.gl,t=this._program,o=i._lightsState.lights,n=i.camera.project;t.bind(),this._uLightAmbient&&s.uniform4fv(this._uLightAmbient,i._lightsState.getAmbientColorAndIntensity());for(let a=0,A=o.length;a<A;a++){const l=o[a];this._uLightColor[a]&&s.uniform4f(this._uLightColor[a],l.color[0],l.color[1],l.color[2],l.intensity),this._uLightPos[a]&&(s.uniform3fv(this._uLightPos[a],l.pos),this._uLightAttenuation[a]&&s.uniform1f(this._uLightAttenuation[a],l.attenuation)),this._uLightDir[a]&&s.uniform3fv(this._uLightDir[a],l.dir)}if(this._withSAO){const a=i.sao;if(a.possible){const l=s.drawingBufferWidth,h=s.drawingBufferHeight;Sr[0]=l,Sr[1]=h,Sr[2]=a.blendCutoff,Sr[3]=a.blendFactor,s.uniform4fv(this._uSAOParams,Sr),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,10)}}if(i.logarithmicDepthBufferEnabled){const a=2/(Math.log(n.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,a)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState,s=e._lightsState,t=i.getNumAllocatedSectionPlanes()>0;let o;const n=[];n.push("#version 300 es"),n.push("// TrianglesDataTextureColorRenderer vertex shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("precision highp usampler2D;"),n.push("precision highp isampler2D;"),n.push("precision highp sampler2D;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("precision mediump usampler2D;"),n.push("precision mediump isampler2D;"),n.push("precision mediump sampler2D;"),n.push("#endif"),n.push("uniform int renderPass;"),n.push("uniform mat4 sceneModelMatrix;"),n.push("uniform mat4 viewMatrix;"),n.push("uniform mat4 projMatrix;"),n.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),n.push("uniform highp sampler2D uTexturePerObjectMatrix;"),n.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),n.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),n.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),n.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),n.push("uniform vec3 uCameraEyeRtc;"),n.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),n.push("out float vFragDepth;"),n.push("out float isPerspective;")),n.push("bool isPerspectiveMatrix(mat4 m) {"),n.push("    return (m[2][3] == - 1.0);"),n.push("}"),n.push("uniform vec4 lightAmbient;");for(let a=0,A=s.lights.length;a<A;a++)o=s.lights[a],o.type!=="ambient"&&(n.push("uniform vec4 lightColor"+a+";"),o.type==="dir"&&n.push("uniform vec3 lightDir"+a+";"),o.type==="point"&&n.push("uniform vec3 lightPos"+a+";"),o.type==="spot"&&(n.push("uniform vec3 lightPos"+a+";"),n.push("uniform vec3 lightDir"+a+";")));t&&(n.push("out vec4 vWorldPosition;"),n.push("flat out uint vFlags2;")),n.push("out vec4 vColor;"),n.push("void main(void) {"),n.push("int polygonIndex = gl_VertexID / 3;"),n.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),n.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),n.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),n.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),n.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),n.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),n.push("if (int(flags.x) != renderPass) {"),n.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),n.push("   return;"),n.push("} else {"),n.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),n.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),n.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),n.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),n.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),n.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),n.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),n.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),n.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),n.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),n.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),n.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),n.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),n.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),n.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),n.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),n.push("if (color.a == 0u) {"),n.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),n.push("   return;"),n.push("};"),n.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),n.push("vec3 position;"),n.push("position = positions[gl_VertexID % 3];"),n.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),n.push("if (solid != 1u) {"),n.push("if (isPerspectiveMatrix(projMatrix)) {"),n.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),n.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),n.push("position = positions[2 - (gl_VertexID % 3)];"),n.push("viewNormal = -viewNormal;"),n.push("}"),n.push("} else {"),n.push("if (viewNormal.z < 0.0) {"),n.push("position = positions[2 - (gl_VertexID % 3)];"),n.push("viewNormal = -viewNormal;"),n.push("}"),n.push("}"),n.push("}"),n.push("vec4 worldPosition = sceneModelMatrix * ((objectDecodeAndInstanceMatrix * vec4(position, 1.0))); "),n.push("vec4 viewPosition = viewMatrix * worldPosition; "),n.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),n.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),n.push("float lambertian = 1.0;");for(let a=0,A=s.lights.length;a<A;a++)if(o=s.lights[a],o.type!=="ambient"){if(o.type==="dir")o.space==="view"?n.push("viewLightDir = normalize(lightDir"+a+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+a+", 0.0)).xyz);");else if(o.type==="point")o.space==="view"?n.push("viewLightDir = -normalize(lightPos"+a+" - viewPosition.xyz);"):n.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+a+", 0.0)).xyz);");else if(o.type==="spot")o.space==="view"?n.push("viewLightDir = normalize(lightDir"+a+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+a+", 0.0)).xyz);");else continue;n.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),n.push("reflectedColor += lambertian * (lightColor"+a+".rgb * lightColor"+a+".a);")}return n.push("vec3 rgb = vec3(color.rgb) / 255.0;"),n.push("vColor =  vec4((lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedColor * rgb), float(color.a) / 255.0);"),n.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(n.push("vFragDepth = 1.0 + clipPos.w;"),n.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(n.push("vWorldPosition = worldPosition;"),n.push("vFlags2 = flags2.r;")),n.push("gl_Position = clipPos;"),n.push("}"),n.push("}"),n}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// TrianglesDataTextureColorRenderer fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),e.logarithmicDepthBufferEnabled&&(t.push("in float isPerspective;"),t.push("uniform float logDepthBufFC;"),t.push("in float vFragDepth;")),this._withSAO&&(t.push("uniform sampler2D uOcclusionTexture;"),t.push("uniform vec4      uSAOParams;"),t.push("const float       packUpscale = 256. / 255.;"),t.push("const float       unpackDownScale = 255. / 256.;"),t.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),t.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),t.push("float unpackRGBToFloat( const in vec4 v ) {"),t.push("    return dot( v, unPackFactors );"),t.push("}")),s){t.push("in vec4 vWorldPosition;"),t.push("flat in uint vFlags2;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("in vec4 vColor;"),t.push("out vec4 outColor;"),t.push("void main(void) {"),s){t.push("  bool clippable = vFlags2 > 0u;"),t.push("  if (clippable) {"),t.push("  float dist = 0.0;");for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)t.push("if (sectionPlaneActive"+o+") {"),t.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("}");t.push("  if (dist > 0.0) { "),t.push("      discard;"),t.push("  }"),t.push("}")}return e.logarithmicDepthBufferEnabled&&t.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),this._withSAO?(t.push("   float viewportWidth     = uSAOParams[0];"),t.push("   float viewportHeight    = uSAOParams[1];"),t.push("   float blendCutoff       = uSAOParams[2];"),t.push("   float blendFactor       = uSAOParams[3];"),t.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),t.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),t.push("   outColor            = vec4(vColor.rgb * ambient, 1.0);")):t.push("   outColor            = vColor;"),t.push("}"),t}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const _B=new Float32Array([1,1,1]),Sh=c.vec3(),vB=c.vec3(),PB=c.vec3();c.vec3();const BB=c.mat4();class Th{constructor(e,i){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,i,s){const t=this._scene,o=t.camera,n=i.model,a=t.canvas.gl,A=i._state,l=A.textureState,h=i._state.origin,{position:d,rotationMatrix:f,rotationMatrixConjugate:m}=n,_=o.viewMatrix;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,A)),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let u,P;if(h||d[0]!==0||d[1]!==0||d[2]!==0){const B=Sh;if(h){const v=vB;c.transformPoint3(f,h,v),B[0]=v[0],B[1]=v[1],B[2]=v[2]}else B[0]=0,B[1]=0,B[2]=0;B[0]+=d[0],B[1]+=d[1],B[2]+=d[2],u=ft(_,B,BB),P=PB,P[0]=o.eye[0]-B[0],P[1]=o.eye[1]-B[1],P[2]=o.eye[2]-B[2]}else u=_,P=o.eye;if(a.uniform3fv(this._uCameraEyeRtc,P),a.uniform1i(this._uRenderPass,s),a.uniformMatrix4fv(this._uWorldMatrix,!1,m),a.uniformMatrix4fv(this._uViewMatrix,!1,u),a.uniformMatrix4fv(this._uProjMatrix,!1,o.projMatrix),s===U.SILHOUETTE_XRAYED){const B=t.xrayMaterial._state,v=B.fillColor,w=B.fillAlpha;a.uniform4f(this._uColor,v[0],v[1],v[2],w)}else if(s===U.SILHOUETTE_HIGHLIGHTED){const B=t.highlightMaterial._state,v=B.fillColor,w=B.fillAlpha;a.uniform4f(this._uColor,v[0],v[1],v[2],w)}else if(s===U.SILHOUETTE_SELECTED){const B=t.selectedMaterial._state,v=B.fillColor,w=B.fillAlpha;a.uniform4f(this._uColor,v[0],v[1],v[2],w)}else a.uniform4fv(this._uColor,_B);if(t.logarithmicDepthBufferEnabled){const B=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,B)}const y=t._sectionPlanesState.getNumAllocatedSectionPlanes(),x=t._sectionPlanesState.sectionPlanes.length;if(y>0){const B=t._sectionPlanesState.sectionPlanes,v=i.layerIndex*x,w=n.renderFlags;for(let C=0;C<y;C++){const I=this._uSectionPlanes[C];if(I)if(C<x){const E=w.sectionPlanesActivePerLayer[v+C];if(a.uniform1i(I.active,E?1:0),E){const S=B[C];if(h){const R=Ut(S.dist,S.dir,h,Sh);a.uniform3fv(I.pos,R)}else a.uniform3fv(I.pos,S.pos);a.uniform3fv(I.dir,S.dir)}}else a.uniform1i(I.active,0)}}A.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),a.drawArrays(a.TRIANGLES,0,A.numIndices8Bits)),A.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),a.drawArrays(a.TRIANGLES,0,A.numIndices16Bits)),A.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),a.drawArrays(a.TRIANGLES,0,A.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,i=e.canvas.gl;if(this._program=new It(i,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uColor=s.getLocation("color"),this._uWorldMatrix=s.getLocation("sceneModelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<o;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=s.getLocation("uCameraEyeRtc")}_bindProgram(e){const i=this._scene,s=i.canvas.gl,t=i.camera.project;if(this._program.bind(),i.logarithmicDepthBufferEnabled){const o=2/(Math.log(t.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,o)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Triangles dataTexture silhouette vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("uniform mat4 sceneModelMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),s.push("uniform highp sampler2D uTexturePerObjectMatrix;"),s.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),s.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),s.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),s.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),s.push("uniform vec3 uCameraEyeRtc;"),s.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("out float isPerspective;")),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),i&&(s.push("out vec4 vWorldPosition;"),s.push("flat out uint vFlags2;")),s.push("void main(void) {"),s.push("int polygonIndex = gl_VertexID / 3;"),s.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),s.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),s.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),s.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),s.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),s.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),s.push("if (int(flags.y) != renderPass) {"),s.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),s.push("   return;"),s.push("} else {"),s.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),s.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),s.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),s.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),s.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),s.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),s.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),s.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),s.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),s.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),s.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),s.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),s.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),s.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),s.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),s.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),s.push("vec3 position;"),s.push("position = positions[gl_VertexID % 3];"),s.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),s.push("if (solid != 1u) {"),s.push("if (isPerspectiveMatrix(projMatrix)) {"),s.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),s.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),s.push("position = positions[2 - (gl_VertexID % 3)];"),s.push("viewNormal = -viewNormal;"),s.push("}"),s.push("} else {"),s.push("if (viewNormal.z < 0.0) {"),s.push("position = positions[2 - (gl_VertexID % 3)];"),s.push("viewNormal = -viewNormal;"),s.push("}"),s.push("}"),s.push("}"),s.push("vec4 worldPosition = sceneModelMatrix *  (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),s.push("vec4 viewPosition = viewMatrix * worldPosition; "),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2.r;")),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles dataTexture draw fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("flat in uint vFlags2;");for(let t=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<o;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("uniform vec4 color;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = vFlags2 > 0u;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<o;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { "),s.push("      discard;"),s.push("  }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    outColor = color;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const yB=new Float32Array([0,0,0,1]),Dh=c.vec3(),xB=c.vec3();c.vec3();const wB=c.mat4();class bB{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,i,s){const t=i.model,o=t.scene,n=o.camera,a=o.canvas.gl,A=i._state,l=A.textureState,h=i._state.origin,{position:d,rotationMatrix:f,rotationMatrixConjugate:m}=t,_=n.viewMatrix;if(!this._program&&(this._allocate(i),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let u;const P=h[0]!==0||h[1]!==0||h[2]!==0,y=d[0]!==0||d[1]!==0||d[2]!==0;if(P||y){const v=Dh;if(P){const w=c.transformPoint3(f,h,xB);v[0]=w[0],v[1]=w[1],v[2]=w[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=d[0],v[1]+=d[1],v[2]+=d[2],u=ft(_,v,wB)}else u=_;if(a.uniform1i(this._uRenderPass,s),a.uniformMatrix4fv(this._uSceneModelMatrix,!1,m),a.uniformMatrix4fv(this._uViewMatrix,!1,u),a.uniformMatrix4fv(this._uProjMatrix,!1,n.projMatrix),s===U.EDGES_XRAYED){const v=o.xrayMaterial._state,w=v.edgeColor,C=v.edgeAlpha;a.uniform4f(this._uColor,w[0],w[1],w[2],C)}else if(s===U.EDGES_HIGHLIGHTED){const v=o.highlightMaterial._state,w=v.edgeColor,C=v.edgeAlpha;a.uniform4f(this._uColor,w[0],w[1],w[2],C)}else if(s===U.EDGES_SELECTED){const v=o.selectedMaterial._state,w=v.edgeColor,C=v.edgeAlpha;a.uniform4f(this._uColor,w[0],w[1],w[2],C)}else a.uniform4fv(this._uColor,yB);const x=o._sectionPlanesState.getNumAllocatedSectionPlanes(),B=o._sectionPlanesState.sectionPlanes.length;if(x>0){const v=o._sectionPlanesState.sectionPlanes,w=i.layerIndex*B,C=t.renderFlags;for(let I=0;I<x;I++){const E=this._uSectionPlanes[I];if(E)if(I<B){const S=C.sectionPlanesActivePerLayer[w+I];if(a.uniform1i(E.active,S?1:0),S){const R=v[I];if(h){const D=Ut(R.dist,R.dir,h,Dh);a.uniform3fv(E.pos,D)}else a.uniform3fv(E.pos,R.pos);a.uniform3fv(E.dir,R.dir)}}else a.uniform1i(E.active,0)}}A.numEdgeIndices8Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,8),a.drawArrays(a.LINES,0,A.numEdgeIndices8Bits)),A.numEdgeIndices16Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,16),a.drawArrays(a.LINES,0,A.numEdgeIndices16Bits)),A.numEdgeIndices32Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,32),a.drawArrays(a.LINES,0,A.numEdgeIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,i=e.canvas.gl;if(this._program=new It(i,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uColor=s.getLocation("color"),this._uSceneModelMatrix=s.getLocation("sceneModelMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<o;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdEdgeIndices="uTexturePerPolygonIdEdgeIndices",this._uTexturePerEdgeIdPortionIds="uTexturePerEdgeIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix"}_bindProgram(){const e=this._scene,i=e.canvas.gl,s=this._program,t=e.camera.project;if(s.bind(),e.logarithmicDepthBufferEnabled){const o=2/(Math.log(t.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,o)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// DTXTrianglesEdgesRenderer vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),s.push("uniform mat4 sceneModelMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),s.push("uniform highp sampler2D uTexturePerObjectMatrix;"),s.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),s.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),s.push("uniform highp usampler2D uTexturePerPolygonIdEdgeIndices;"),s.push("uniform mediump usampler2D uTexturePerEdgeIdPortionIds;"),s.push("uniform vec4 color;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("flat out uint vFlags2;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("int edgeIndex = gl_VertexID / 2;"),s.push("int h_packed_object_id_index = (edgeIndex >> 3) & 4095;"),s.push("int v_packed_object_id_index = (edgeIndex >> 3) >> 12;"),s.push("int objectIndex = int(texelFetch(uTexturePerEdgeIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),s.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),s.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),s.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),s.push("if (int(flags.z) != renderPass) {"),s.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),s.push("   return;"),s.push("} else {"),s.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),s.push("ivec4 packedEdgeIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0));"),s.push("int edgeIndexBaseOffset = (packedEdgeIndexBaseOffset.r << 24) + (packedEdgeIndexBaseOffset.g << 16) + (packedEdgeIndexBaseOffset.b << 8) + packedEdgeIndexBaseOffset.a;"),s.push("int h_index = (edgeIndex - edgeIndexBaseOffset) & 4095;"),s.push("int v_index = (edgeIndex - edgeIndexBaseOffset) >> 12;"),s.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdEdgeIndices, ivec2(h_index, v_index), 0));"),s.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),s.push("int indexPositionH = uniqueVertexIndexes[gl_VertexID % 2] & 4095;"),s.push("int indexPositionV = uniqueVertexIndexes[gl_VertexID % 2] >> 12;"),s.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),s.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),s.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),s.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),s.push("vec3 position = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH, indexPositionV), 0));"),s.push("mat4 matrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),s.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("  vWorldPosition = worldPosition;"),s.push("  vFlags2 = flags2.r;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("vColor = vec4(color.r, color.g, color.b, color.a);"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// DTXTrianglesEdgesRenderer fragment shader"),e.logarithmicDepthBufferEnabled&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("flat in uint vFlags2;");for(let t=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<o;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = vFlags2 > 0u;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<o;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outColor            = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Rh=c.vec3(),CB=c.vec3(),EB=c.mat4();class IB{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,i,s){const t=i.model,o=t.scene,n=o.camera,a=o.canvas.gl,A=i._state,l=A.textureState,h=i._state.origin,{position:d,rotationMatrix:f,rotationMatrixConjugate:m}=t,_=n.viewMatrix;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let u;const P=h[0]!==0||h[1]!==0||h[2]!==0,y=d[0]!==0||d[1]!==0||d[2]!==0;if(P||y){const v=Rh;if(P){const w=c.transformPoint3(f,h,CB);v[0]=w[0],v[1]=w[1],v[2]=w[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=d[0],v[1]+=d[1],v[2]+=d[2],u=ft(_,v,EB)}else u=_;a.uniform1i(this._uRenderPass,s),a.uniformMatrix4fv(this._uSceneModelMatrix,!1,m),a.uniformMatrix4fv(this._uViewMatrix,!1,u),a.uniformMatrix4fv(this._uProjMatrix,!1,n.projMatrix);const x=o._sectionPlanesState.getNumAllocatedSectionPlanes(),B=o._sectionPlanesState.sectionPlanes.length;if(x>0){const v=o._sectionPlanesState.sectionPlanes,w=i.layerIndex*B,C=t.renderFlags;for(let I=0;I<x;I++){const E=this._uSectionPlanes[I];if(E)if(I<B){const S=C.sectionPlanesActivePerLayer[w+I];if(a.uniform1i(E.active,S?1:0),S){const R=v[I];if(h){const D=Ut(R.dist,R.dir,h,Rh);a.uniform3fv(E.pos,D)}else a.uniform3fv(E.pos,R.pos);a.uniform3fv(E.dir,R.dir)}}else a.uniform1i(E.active,0)}}A.numEdgeIndices8Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,8),a.drawArrays(a.LINES,0,A.numEdgeIndices8Bits)),A.numEdgeIndices16Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,16),a.drawArrays(a.LINES,0,A.numEdgeIndices16Bits)),A.numEdgeIndices32Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,32),a.drawArrays(a.LINES,0,A.numEdgeIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,i=e.canvas.gl;if(this._program=new It(i,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uSceneModelMatrix=s.getLocation("sceneModelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<o;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdEdgeIndices="uTexturePerPolygonIdEdgeIndices",this._uTexturePerEdgeIdPortionIds="uTexturePerEdgeIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix"}_bindProgram(){const e=this._scene,i=e.canvas.gl,s=this._program,t=e.camera.project;if(s.bind(),e.logarithmicDepthBufferEnabled){const o=2/(Math.log(t.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,o)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// TrianglesDataTextureEdgesColorRenderer"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),e.entityOffsetsEnabled,s.push("uniform mat4 sceneModelMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),s.push("uniform highp sampler2D uTexturePerObjectMatrix;"),s.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),s.push("uniform highp sampler2D uObjectPerObjectOffsets;"),s.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),s.push("uniform highp usampler2D uTexturePerPolygonIdEdgeIndices;"),s.push("uniform mediump usampler2D uTexturePerEdgeIdPortionIds;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("flat out uint vFlags2;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("int edgeIndex = gl_VertexID / 2;"),s.push("int h_packed_object_id_index = (edgeIndex >> 3) & 4095;"),s.push("int v_packed_object_id_index = (edgeIndex >> 3) >> 12;"),s.push("int objectIndex = int(texelFetch(uTexturePerEdgeIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),s.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),s.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),s.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),s.push("if (int(flags.z) != renderPass) {"),s.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),s.push("   return;"),s.push("} else {"),s.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),s.push("ivec4 packedEdgeIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0));"),s.push("int edgeIndexBaseOffset = (packedEdgeIndexBaseOffset.r << 24) + (packedEdgeIndexBaseOffset.g << 16) + (packedEdgeIndexBaseOffset.b << 8) + packedEdgeIndexBaseOffset.a;"),s.push("int h_index = (edgeIndex - edgeIndexBaseOffset) & 4095;"),s.push("int v_index = (edgeIndex - edgeIndexBaseOffset) >> 12;"),s.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdEdgeIndices, ivec2(h_index, v_index), 0));"),s.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),s.push("int indexPositionH = uniqueVertexIndexes[gl_VertexID % 2] & 4095;"),s.push("int indexPositionV = uniqueVertexIndexes[gl_VertexID % 2] >> 12;"),s.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),s.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),s.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),s.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),s.push("vec3 position = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH, indexPositionV), 0));"),s.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),s.push("if (color.a == 0u) {"),s.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),s.push("   return;"),s.push("};"),s.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("  vWorldPosition = worldPosition;"),s.push("  vFlags2 = flags2.r;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("vec4 rgb = vec4(color.rgba);"),s.push("vColor = vec4(float(rgb.r*0.5) / 255.0, float(rgb.g*0.5) / 255.0, float(rgb.b*0.5) / 255.0, float(rgb.a) / 255.0);"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// TrianglesDataTextureEdgesColorRenderer"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("flat in uint vFlags2;");for(let t=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<o;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = vFlags2 > 0u;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<o;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outColor            = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Lh=c.vec3(),FB=c.vec3(),MB=c.vec3(),SB=c.mat4();class Uh{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,i,s){if(!this._program&&(this._allocate(i),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e));const t=i.model,o=t.scene,n=o.camera,a=o.canvas.gl,A=i._state,l=A.textureState,h=i._state.origin,{position:d,rotationMatrix:f,rotationMatrixConjugate:m}=t;l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let _,u;const P=h[0]!==0||h[1]!==0||h[2]!==0,y=d[0]!==0||d[1]!==0||d[2]!==0;if(P||y){const v=Lh;if(P){const w=c.transformPoint3(f,h,FB);v[0]=w[0],v[1]=w[1],v[2]=w[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=d[0],v[1]+=d[1],v[2]+=d[2],_=ft(n.viewMatrix,v,SB),u=MB,u[0]=n.eye[0]-v[0],u[1]=n.eye[1]-v[1],u[2]=n.eye[2]-v[2]}else _=n.viewMatrix,u=n.eye;if(a.uniform2fv(this._uPickClipPos,e.pickClipPos),a.uniform2f(this._uDrawingBufferSize,a.drawingBufferWidth,a.drawingBufferHeight),a.uniformMatrix4fv(this._uSceneModelMatrix,!1,m),a.uniformMatrix4fv(this._uViewMatrix,!1,_),a.uniformMatrix4fv(this._uProjMatrix,!1,n.projMatrix),a.uniform3fv(this._uCameraEyeRtc,u),a.uniform1i(this._uRenderPass,s),o.logarithmicDepthBufferEnabled){const v=2/(Math.log(n.project.far+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,v)}const x=o._sectionPlanesState.getNumAllocatedSectionPlanes(),B=o._sectionPlanesState.sectionPlanes.length;if(x>0){const v=o._sectionPlanesState.sectionPlanes,w=i.layerIndex*B,C=t.renderFlags;for(let I=0;I<x;I++){const E=this._uSectionPlanes[I];if(E)if(I<B){const S=C.sectionPlanesActivePerLayer[w+I];if(a.uniform1i(E.active,S?1:0),S){const R=v[I];if(h){const D=Ut(R.dist,R.dir,h,Lh);a.uniform3fv(E.pos,D)}else a.uniform3fv(E.pos,R.pos);a.uniform3fv(E.dir,R.dir)}}else a.uniform1i(E.active,0)}}A.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),a.drawArrays(a.TRIANGLES,0,A.numIndices8Bits)),A.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),a.drawArrays(a.TRIANGLES,0,A.numIndices16Bits)),A.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),a.drawArrays(a.TRIANGLES,0,A.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,i=e.canvas.gl;if(this._program=new It(i,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPickInvisible=s.getLocation("pickInvisible"),this._uPickClipPos=s.getLocation("pickClipPos"),this._uDrawingBufferSize=s.getLocation("drawingBufferSize"),this._uSceneModelMatrix=s.getLocation("sceneModelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<o;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=s.getLocation("uCameraEyeRtc")}_bindProgram(e){const s=this._scene.canvas.gl;this._program.bind(),s.uniform1i(this._uPickInvisible,e.pickInvisible)}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Batched geometry picking vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("uniform mat4 sceneModelMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform bool pickInvisible;"),s.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),s.push("uniform highp sampler2D uTexturePerObjectMatrix;"),s.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),s.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),s.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),s.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),s.push("uniform vec3 uCameraEyeRtc;"),s.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("out float isPerspective;")),s.push("uniform vec2 pickClipPos;"),s.push("uniform vec2 drawingBufferSize;"),s.push("vec4 remapClipPos(vec4 clipPos) {"),s.push("    clipPos.xy /= clipPos.w;"),s.push("    clipPos.xy = (clipPos.xy - pickClipPos) * drawingBufferSize;"),s.push("    clipPos.xy *= clipPos.w;"),s.push("    return clipPos;"),s.push("}"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),i&&(s.push("smooth out vec4 vWorldPosition;"),s.push("flat out uvec4 vFlags2;")),s.push("out vec4 vPickColor;"),s.push("void main(void) {"),s.push("int polygonIndex = gl_VertexID / 3;"),s.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),s.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),s.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),s.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),s.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),s.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),s.push("if (int(flags.w) != renderPass) {"),s.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),s.push("   return;"),s.push("} else {"),s.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),s.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),s.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),s.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),s.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),s.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),s.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),s.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),s.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),s.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),s.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),s.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),s.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),s.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),s.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),s.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),s.push("vPickColor = vec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+1, objectIndexCoords.y), 0)) / 255.0;"),s.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),s.push("vec3 position;"),s.push("position = positions[gl_VertexID % 3];"),s.push("if (solid != 1u) {"),s.push("if (isPerspectiveMatrix(projMatrix)) {"),s.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),s.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),s.push("position = positions[2 - (gl_VertexID % 3)];"),s.push("}"),s.push("} else {"),s.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),s.push("if (viewNormal.z < 0.0) {"),s.push("position = positions[2 - (gl_VertexID % 3)];"),s.push("}"),s.push("}"),s.push("}"),s.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),s.push("vec4 viewPosition = viewMatrix * worldPosition; "),i&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = remapClipPos(clipPos);"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry picking fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("flat in uvec4 vFlags2;");for(var t=0;t<e._sectionPlanesState.getNumAllocatedSectionPlanes();t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("in vec4 vPickColor;"),s.push("out vec4 outPickColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var t=0;t<e._sectionPlanesState.getNumAllocatedSectionPlanes();t++)s.push("      if (sectionPlaneActive"+t+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outPickColor = vPickColor; "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Oh=c.vec3(),TB=c.vec3(),DB=c.vec3();c.vec3();const RB=c.mat4();class kh{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,i,s){const t=i.model,o=t.scene,n=o.camera,a=o.canvas.gl,A=i._state,l=A.textureState,h=i._state.origin,{position:d,rotationMatrix:f,rotationMatrixConjugate:m}=t,_=e.pickViewMatrix||n.viewMatrix;this._program||this._allocate(),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let u,P;if(h||d[0]!==0||d[1]!==0||d[2]!==0){const B=Oh;if(h){const v=TB;c.transformPoint3(f,h,v),B[0]=v[0],B[1]=v[1],B[2]=v[2]}else B[0]=0,B[1]=0,B[2]=0;B[0]+=d[0],B[1]+=d[1],B[2]+=d[2],u=ft(_,B,RB),P=DB,P[0]=n.eye[0]-B[0],P[1]=n.eye[1]-B[1],P[2]=n.eye[2]-B[2],e.snapPickOrigin[0]=B[0],e.snapPickOrigin[1]=B[1],e.snapPickOrigin[2]=B[2]}else u=_,P=n.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;if(a.uniform3fv(this._uCameraEyeRtc,P),a.uniform1i(this._uRenderPass,s),a.uniform1i(this._uPickInvisible,e.pickInvisible),a.uniform2fv(this._uPickClipPos,e.pickClipPos),a.uniform2f(this._uDrawingBufferSize,a.drawingBufferWidth,a.drawingBufferHeight),a.uniform1f(this._uPickZNear,e.pickZNear),a.uniform1f(this._uPickZFar,e.pickZFar),a.uniformMatrix4fv(this._uSceneModelMatrix,!1,m),a.uniformMatrix4fv(this._uViewMatrix,!1,u),a.uniformMatrix4fv(this._uProjMatrix,!1,n.projMatrix),o.logarithmicDepthBufferEnabled){const B=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,B)}const y=o._sectionPlanesState.getNumAllocatedSectionPlanes(),x=o._sectionPlanesState.sectionPlanes.length;if(y>0){const B=o._sectionPlanesState.sectionPlanes,v=i.layerIndex*x,w=t.renderFlags;for(let C=0;C<y;C++){const I=this._uSectionPlanes[C];if(I)if(C<x){const E=w.sectionPlanesActivePerLayer[v+C];if(a.uniform1i(I.active,E?1:0),E){const S=B[C];if(h){const R=Ut(S.dist,S.dir,h,Oh);a.uniform3fv(I.pos,R)}else a.uniform3fv(I.pos,S.pos);a.uniform3fv(I.dir,S.dir)}}else a.uniform1i(I.active,0)}}A.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),a.drawArrays(a.TRIANGLES,0,A.numIndices8Bits)),A.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),a.drawArrays(a.TRIANGLES,0,A.numIndices16Bits)),A.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),a.drawArrays(a.TRIANGLES,0,A.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,i=e.canvas.gl;if(this._program=new It(i,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPickInvisible=s.getLocation("pickInvisible"),this._uPickClipPos=s.getLocation("pickClipPos"),this._uDrawingBufferSize=s.getLocation("drawingBufferSize"),this._uSceneModelMatrix=s.getLocation("sceneModelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<o;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._uPickZNear=s.getLocation("pickZNear"),this._uPickZFar=s.getLocation("pickZFar"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=s.getLocation("uCameraEyeRtc")}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Triangles dataTexture pick depth vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("uniform mat4 sceneModelMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform bool pickInvisible;"),s.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),s.push("uniform highp sampler2D uTexturePerObjectMatrix;"),s.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),s.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),s.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),s.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),s.push("uniform vec3 uCameraEyeRtc;"),s.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("out float isPerspective;")),s.push("uniform vec2 pickClipPos;"),s.push("uniform vec2 drawingBufferSize;"),s.push("vec4 remapClipPos(vec4 clipPos) {"),s.push("    clipPos.xy /= clipPos.w;"),s.push("    clipPos.xy = (clipPos.xy - pickClipPos) * drawingBufferSize;"),s.push("    clipPos.xy *= clipPos.w;"),s.push("    return clipPos;"),s.push("}"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),i&&(s.push("out vec4 vWorldPosition;"),s.push("flat out uint vFlags2;")),s.push("out vec4 vViewPosition;"),s.push("void main(void) {"),s.push("int polygonIndex = gl_VertexID / 3;"),s.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),s.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),s.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),s.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),s.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),s.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),s.push("if (int(flags.w) != renderPass) {"),s.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),s.push("   return;"),s.push("} else {"),s.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),s.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),s.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),s.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),s.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),s.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),s.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),s.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),s.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),s.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),s.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),s.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),s.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),s.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),s.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),s.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),s.push("if (color.a == 0u) {"),s.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),s.push("   return;"),s.push("};"),s.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),s.push("vec3 position;"),s.push("position = positions[gl_VertexID % 3];"),s.push("if (solid != 1u) {"),s.push("if (isPerspectiveMatrix(projMatrix)) {"),s.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),s.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),s.push("position = positions[2 - (gl_VertexID % 3)];"),s.push("}"),s.push("} else {"),s.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),s.push("if (viewNormal.z < 0.0) {"),s.push("position = positions[2 - (gl_VertexID % 3)];"),s.push("}"),s.push("}"),s.push("}"),s.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),s.push("vec4 viewPosition = viewMatrix * worldPosition; "),i&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags2 = flags2.r;")),s.push("vViewPosition = viewPosition;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = remapClipPos(clipPos);"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles dataTexture pick depth fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("uniform float pickZNear;"),s.push("uniform float pickZFar;"),i){s.push("in vec4 vWorldPosition;"),s.push("flat in uint vFlags2;");for(var t=0;t<e._sectionPlanesState.getNumAllocatedSectionPlanes();t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("in vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("out vec4 outPackedDepth;"),s.push("void main(void) {"),i){s.push("  bool clippable = vFlags2 > 0u;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var t=0;t<e._sectionPlanesState.getNumAllocatedSectionPlanes();t++)s.push("      if (sectionPlaneActive"+t+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),s.push("    outPackedDepth = packDepth(zNormalizedDepth); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Nh=c.vec3(),LB=c.vec3(),UB=c.vec3(),OB=c.vec3();c.vec3();const kB=c.mat4();class ja{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,i,s){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const t=i.model,o=t.scene,n=o.camera,a=o.canvas.gl,A=i._state,l=A.textureState,h=i._state.origin,{position:d,rotationMatrix:f,rotationMatrixConjugate:m}=t,_=i.aabb,u=e.pickViewMatrix||n.viewMatrix,P=Nh;P[0]=c.safeInv(_[3]-_[0])*c.MAX_INT,P[1]=c.safeInv(_[4]-_[1])*c.MAX_INT,P[2]=c.safeInv(_[5]-_[2])*c.MAX_INT,e.snapPickCoordinateScale[0]=c.safeInv(P[0]),e.snapPickCoordinateScale[1]=c.safeInv(P[1]),e.snapPickCoordinateScale[2]=c.safeInv(P[2]),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let y,x;const B=h[0]!==0||h[1]!==0||h[2]!==0,v=d[0]!==0||d[1]!==0||d[2]!==0;if(B||v){const E=LB;if(B){const S=c.transformPoint3(f,h,UB);E[0]=S[0],E[1]=S[1],E[2]=S[2]}else E[0]=0,E[1]=0,E[2]=0;E[0]+=d[0],E[1]+=d[1],E[2]+=d[2],y=ft(u,E,kB),x=OB,x[0]=n.eye[0]-E[0],x[1]=n.eye[1]-E[1],x[2]=n.eye[2]-E[2],e.snapPickOrigin[0]=E[0],e.snapPickOrigin[1]=E[1],e.snapPickOrigin[2]=E[2]}else y=u,x=n.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;a.uniform3fv(this._uCameraEyeRtc,x),a.uniform2fv(this.uVectorA,e.snapVectorA),a.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),a.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),a.uniform3fv(this._uCoordinateScaler,P),a.uniform1i(this._uRenderPass,s),a.uniform1i(this._uPickInvisible,e.pickInvisible),a.uniformMatrix4fv(this._uSceneModelMatrix,!1,m),a.uniformMatrix4fv(this._uViewMatrix,!1,y),a.uniformMatrix4fv(this._uProjMatrix,!1,n.projMatrix);{const E=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,E)}const w=o._sectionPlanesState.getNumAllocatedSectionPlanes(),C=o._sectionPlanesState.sectionPlanes.length;if(w>0){const E=o._sectionPlanesState.sectionPlanes,S=i.layerIndex*C,R=t.renderFlags;for(let D=0;D<w;D++){const K=this._uSectionPlanes[D];if(K)if(D<C){const G=R.sectionPlanesActivePerLayer[S+D];if(a.uniform1i(K.active,G?1:0),G){const z=E[D];if(h){const le=Ut(z.dist,z.dir,h,Nh);a.uniform3fv(K.pos,le)}else a.uniform3fv(K.pos,z.pos);a.uniform3fv(K.dir,z.dir)}}else a.uniform1i(K.active,0)}}const I=e.snapMode==="edge"?a.LINES:a.POINTS;A.numEdgeIndices8Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,8),a.drawArrays(I,0,A.numEdgeIndices8Bits)),A.numEdgeIndices16Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,16),a.drawArrays(I,0,A.numEdgeIndices16Bits)),A.numEdgeIndices32Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,32),a.drawArrays(I,0,A.numEdgeIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,i=e.canvas.gl;if(this._program=new It(i,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPickInvisible=s.getLocation("pickInvisible"),this._uSceneModelMatrix=s.getLocation("sceneModelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<o;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._uLogDepthBufFC=s.getLocation("logDepthBufFC"),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdEdgeIndices="uTexturePerPolygonIdEdgeIndices",this._uTexturePerEdgeIdPortionIds="uTexturePerEdgeIdPortionIds",this._uTextureModelMatrices="uTextureModelMatrices",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=s.getLocation("uCameraEyeRtc"),this.uVectorA=s.getLocation("uSnapVectorA"),this.uInverseVectorAB=s.getLocation("uSnapInvVectorAB"),this._uLayerNumber=s.getLocation("uLayerNumber"),this._uCoordinateScaler=s.getLocation("uCoordinateScaler")}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Batched geometry edges drawing vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("uniform mat4 sceneModelMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),s.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),s.push("uniform highp sampler2D uTexturePerObjectMatrix;"),s.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),s.push("uniform highp usampler2D uTexturePerPolygonIdEdgeIndices;"),s.push("uniform mediump usampler2D uTexturePerEdgeIdPortionIds;"),s.push("uniform vec3 uCameraEyeRtc;"),s.push("uniform vec2 uSnapVectorA;"),s.push("uniform vec2 uSnapInvVectorAB;"),s.push("vec3 positions[3];"),s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;"),s.push("vec2 remapClipPos(vec2 clipPos) {"),s.push("    float x = (clipPos.x - uSnapVectorA.x) * uSnapInvVectorAB.x;"),s.push("    float y = (clipPos.y - uSnapVectorA.y) * uSnapInvVectorAB.y;"),s.push("    return vec2(x, y);"),s.push("}"),i&&(s.push("out vec4 vWorldPosition;"),s.push("flat out uint vFlags2;")),s.push("out vec4 vViewPosition;"),s.push("out highp vec3 relativeToOriginPosition;"),s.push("void main(void) {"),s.push("int edgeIndex = gl_VertexID / 2;"),s.push("int h_packed_object_id_index = (edgeIndex >> 3) & 4095;"),s.push("int v_packed_object_id_index = (edgeIndex >> 3) >> 12;"),s.push("int objectIndex = int(texelFetch(uTexturePerEdgeIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),s.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),s.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),s.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),s.push("{"),s.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),s.push("ivec4 packedEdgeIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0));"),s.push("int edgeIndexBaseOffset = (packedEdgeIndexBaseOffset.r << 24) + (packedEdgeIndexBaseOffset.g << 16) + (packedEdgeIndexBaseOffset.b << 8) + packedEdgeIndexBaseOffset.a;"),s.push("int h_index = (edgeIndex - edgeIndexBaseOffset) & 4095;"),s.push("int v_index = (edgeIndex - edgeIndexBaseOffset) >> 12;"),s.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdEdgeIndices, ivec2(h_index, v_index), 0));"),s.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),s.push("int indexPositionH = uniqueVertexIndexes[gl_VertexID % 2] & 4095;"),s.push("int indexPositionV = uniqueVertexIndexes[gl_VertexID % 2] >> 12;"),s.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),s.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),s.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),s.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),s.push("vec3 position = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH, indexPositionV), 0));"),s.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),s.push("relativeToOriginPosition = worldPosition.xyz;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("  vWorldPosition = worldPosition;"),s.push("  vFlags2 = flags2.r;")),s.push("vViewPosition = viewPosition;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),s.push("float tmp = clipPos.w;"),s.push("clipPos.xyzw /= tmp;"),s.push("clipPos.xy = remapClipPos(clipPos.xy);"),s.push("clipPos.xyzw *= tmp;"),s.push("vViewPosition = clipPos;"),s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),s.push("gl_Position = clipPos;"),s.push("gl_PointSize = 1.0;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles dataTexture pick depth fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;"),s.push("uniform int uLayerNumber;"),s.push("uniform vec3 uCoordinateScaler;"),i){s.push("in vec4 vWorldPosition;"),s.push("flat in uint vFlags2;");for(let o=0,n=e._sectionPlanesState.getNumAllocatedSectionPlanes();o<n;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in highp vec3 relativeToOriginPosition;"),s.push("out highp ivec4 outCoords;"),s.push("void main(void) {"),i){s.push("  bool clippable = vFlags2 > 0u;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var t=0;t<e._sectionPlanesState.getNumAllocatedSectionPlanes();t++)s.push("      if (sectionPlaneActive"+t+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outCoords = ivec4(relativeToOriginPosition.xyz * uCoordinateScaler.xyz, uLayerNumber);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Qh=c.vec3(),NB=c.vec3(),QB=c.vec3(),HB=c.vec3();c.vec3();const VB=c.mat4();class Hh{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,i,s){this._program||this._allocate(),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const t=i.model,o=t.scene,n=o.camera,a=o.canvas.gl,A=i._state,l=A.textureState,h=i._state.origin,{position:d,rotationMatrix:f,rotationMatrixConjugate:m}=t,_=i.aabb,u=e.pickViewMatrix||n.viewMatrix,P=Qh;P[0]=c.safeInv(_[3]-_[0])*c.MAX_INT,P[1]=c.safeInv(_[4]-_[1])*c.MAX_INT,P[2]=c.safeInv(_[5]-_[2])*c.MAX_INT,e.snapPickCoordinateScale[0]=c.safeInv(P[0]),e.snapPickCoordinateScale[1]=c.safeInv(P[1]),e.snapPickCoordinateScale[2]=c.safeInv(P[2]),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let y,x;const B=h[0]!==0||h[1]!==0||h[2]!==0,v=d[0]!==0||d[1]!==0||d[2]!==0;if(B||v){const I=NB;if(B){const E=QB;c.transformPoint3(f,h,E),I[0]=E[0],I[1]=E[1],I[2]=E[2]}else I[0]=0,I[1]=0,I[2]=0;I[0]+=d[0],I[1]+=d[1],I[2]+=d[2],y=ft(u,I,VB),x=HB,x[0]=n.eye[0]-I[0],x[1]=n.eye[1]-I[1],x[2]=n.eye[2]-I[2],e.snapPickOrigin[0]=I[0],e.snapPickOrigin[1]=I[1],e.snapPickOrigin[2]=I[2]}else y=u,x=n.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;a.uniform3fv(this._uCameraEyeRtc,x),a.uniform2fv(this._uVectorA,e.snapVectorA),a.uniform2fv(this._uInverseVectorAB,e.snapInvVectorAB),a.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),a.uniform3fv(this._uCoordinateScaler,P),a.uniform1i(this._uRenderPass,s),a.uniform1i(this._uPickInvisible,e.pickInvisible),a.uniformMatrix4fv(this._uSceneWorldModelMatrix,!1,m),a.uniformMatrix4fv(this._uViewMatrix,!1,y),a.uniformMatrix4fv(this._uProjMatrix,!1,n.projMatrix);{const I=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,I)}const w=o._sectionPlanesState.getNumAllocatedSectionPlanes(),C=o._sectionPlanesState.sectionPlanes.length;if(w>0){const I=o._sectionPlanesState.sectionPlanes,E=i.layerIndex*C,S=t.renderFlags;for(let R=0;R<w;R++){const D=this._uSectionPlanes[R];if(D)if(R<C){const K=S.sectionPlanesActivePerLayer[E+R];if(a.uniform1i(D.active,K?1:0),K){const G=I[R];if(h){const z=Ut(G.dist,G.dir,h,Qh);a.uniform3fv(D.pos,z)}else a.uniform3fv(D.pos,G.pos);a.uniform3fv(D.dir,G.dir)}}else a.uniform1i(D.active,0)}}A.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),a.drawArrays(a.TRIANGLES,0,A.numIndices8Bits)),A.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),a.drawArrays(a.TRIANGLES,0,A.numIndices16Bits)),A.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),a.drawArrays(a.TRIANGLES,0,A.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,i=e.canvas.gl;if(this._program=new It(i,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPickInvisible=s.getLocation("pickInvisible"),this._uSceneWorldModelMatrix=s.getLocation("sceneModelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<o;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._uLogDepthBufFC=s.getLocation("logDepthBufFC"),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=s.getLocation("uCameraEyeRtc"),this._uVectorA=s.getLocation("uVectorAB"),this._uInverseVectorAB=s.getLocation("uInverseVectorAB"),this._uLayerNumber=s.getLocation("uLayerNumber"),this._uCoordinateScaler=s.getLocation("uCoordinateScaler")}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// DTXTrianglesSnapInitRenderer vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("uniform mat4 sceneModelMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),s.push("uniform highp sampler2D uTexturePerObjectMatrix;"),s.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),s.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),s.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),s.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),s.push("uniform vec3 uCameraEyeRtc;"),s.push("uniform vec2 uVectorAB;"),s.push("uniform vec2 uInverseVectorAB;"),s.push("vec3 positions[3];"),s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("out float isPerspective;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("vec2 remapClipPos(vec2 clipPos) {"),s.push("    float x = (clipPos.x - uVectorAB.x) * uInverseVectorAB.x;"),s.push("    float y = (clipPos.y - uVectorAB.y) * uInverseVectorAB.y;"),s.push("    return vec2(x, y);"),s.push("}"),s.push("flat out vec4 vPickColor;"),s.push("out vec4 vWorldPosition;"),i&&s.push("flat out uint vFlags2;"),s.push("out highp vec3 relativeToOriginPosition;"),s.push("void main(void) {"),s.push("int polygonIndex = gl_VertexID / 3;"),s.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),s.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),s.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),s.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),s.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),s.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),s.push("{"),s.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),s.push("if (color.a == 0u) {"),s.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),s.push("   return;"),s.push("};"),s.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),s.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),s.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),s.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),s.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),s.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),s.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),s.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),s.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),s.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),s.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),s.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),s.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),s.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),s.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),s.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),s.push("vec3 position;"),s.push("position = positions[gl_VertexID % 3];"),s.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),s.push("if (solid != 1u) {"),s.push("  if (isPerspectiveMatrix(projMatrix)) {"),s.push("      vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),s.push("      if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),s.push("          position = positions[2 - (gl_VertexID % 3)];"),s.push("          viewNormal = -viewNormal;"),s.push("      }"),s.push("  } else {"),s.push("      if (viewNormal.z < 0.0) {"),s.push("          position = positions[2 - (gl_VertexID % 3)];"),s.push("          viewNormal = -viewNormal;"),s.push("      }"),s.push("  }"),s.push("}"),s.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),s.push("relativeToOriginPosition = worldPosition.xyz;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vWorldPosition = worldPosition;"),i&&s.push("vFlags2 = flags2.r;"),s.push("vPickColor = vec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+1, objectIndexCoords.y), 0));"),s.push("vec4 clipPos = projMatrix * viewPosition;"),s.push("float tmp = clipPos.w;"),s.push("clipPos.xyzw /= tmp;"),s.push("clipPos.xy = remapClipPos(clipPos.xy);"),s.push("clipPos.xyzw *= tmp;"),s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),s.push("gl_Position = clipPos;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// DTXTrianglesSnapInitRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;"),s.push("uniform int uLayerNumber;"),s.push("uniform vec3 uCoordinateScaler;"),s.push("in vec4 vWorldPosition;"),s.push("flat in vec4 vPickColor;"),i){s.push("flat in uint vFlags2;");for(let o=0,n=e._sectionPlanesState.getNumAllocatedSectionPlanes();o<n;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in highp vec3 relativeToOriginPosition;"),s.push("layout(location = 0) out highp ivec4 outCoords;"),s.push("layout(location = 1) out highp ivec4 outNormal;"),s.push("layout(location = 2) out lowp uvec4 outPickColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = vFlags2 > 0u;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var t=0;t<e._sectionPlanesState.getNumAllocatedSectionPlanes();t++)s.push("      if (sectionPlaneActive"+t+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return s.push("    float dx = dFdx(vFragDepth);"),s.push("    float dy = dFdy(vFragDepth);"),s.push("    float diff = sqrt(dx*dx+dy*dy);"),s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),s.push("outCoords = ivec4(relativeToOriginPosition.xyz * uCoordinateScaler.xyz, - uLayerNumber);"),s.push("vec3 xTangent = dFdx( vWorldPosition.xyz );"),s.push("vec3 yTangent = dFdy( vWorldPosition.xyz );"),s.push("vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),s.push(`outNormal = ivec4(worldNormal * float(${c.MAX_INT}), 1.0);`),s.push("outPickColor = uvec4(vPickColor);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Vh=c.vec3(),jB=c.vec3(),GB=c.vec3();c.vec3();const zB=c.mat4();class KB{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,i,s){const t=i.model,o=t.scene,n=o.camera,a=o.canvas.gl,A=i._state,l=A.textureState,h=i._state.origin,{position:d,rotationMatrix:f,rotationMatrixConjugate:m}=t,_=e.pickViewMatrix||n.viewMatrix;if(!this._program&&(this._allocate(i),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let u,P;if(h||d[0]!==0||d[1]!==0||d[2]!==0){const B=Vh;if(h){const v=jB;c.transformPoint3(f,h,v),B[0]=v[0],B[1]=v[1],B[2]=v[2]}else B[0]=0,B[1]=0,B[2]=0;B[0]+=d[0],B[1]+=d[1],B[2]+=d[2],u=ft(_,B,zB),P=GB,P[0]=n.eye[0]-B[0],P[1]=n.eye[1]-B[1],P[2]=n.eye[2]-B[2]}else u=_,P=n.eye;a.uniform3fv(this._uCameraEyeRtc,P),a.uniform1i(this._uRenderPass,s),a.uniformMatrix4fv(this._uWorldMatrix,!1,m),a.uniformMatrix4fv(this._uViewMatrix,!1,u),a.uniformMatrix4fv(this._uProjMatrix,!1,n.projMatrix);const y=o._sectionPlanesState.getNumAllocatedSectionPlanes(),x=o._sectionPlanesState.sectionPlanes.length;if(y>0){const B=o._sectionPlanesState.sectionPlanes,v=i.layerIndex*x,w=t.renderFlags;for(let C=0;C<y;C++){const I=this._uSectionPlanes[C];if(I)if(C<x){const E=w.sectionPlanesActivePerLayer[v+C];if(a.uniform1i(I.active,E?1:0),E){const S=B[C];if(h){const R=Ut(S.dist,S.dir,h,Vh);a.uniform3fv(I.pos,R)}else a.uniform3fv(I.pos,S.pos);a.uniform3fv(I.dir,S.dir)}}else a.uniform1i(I.active,0)}}A.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),a.drawArrays(a.TRIANGLES,0,A.numIndices8Bits)),A.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),a.drawArrays(a.TRIANGLES,0,A.numIndices16Bits)),A.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),a.drawArrays(a.TRIANGLES,0,A.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,i=e.canvas.gl;if(this._program=new It(i,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPickInvisible=s.getLocation("pickInvisible"),this._uWorldMatrix=s.getLocation("sceneModelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<o;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._uPickZNear=s.getLocation("pickZNear"),this._uPickZFar=s.getLocation("pickZFar"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=s.getLocation("uCameraEyeRtc")}_bindProgram(){const e=this._scene;e.canvas.gl,e.camera.project,this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// TrianglesDataTextureOcclusionRenderer vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("uniform mat4 sceneModelMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),s.push("uniform highp sampler2D uTexturePerObjectMatrix;"),s.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),s.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),s.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),s.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),s.push("uniform vec3 uCameraEyeRtc;"),s.push("vec3 positions[3];"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),i&&(s.push("out vec4 vWorldPosition;"),s.push("flat out uint vFlags2;")),s.push("void main(void) {"),s.push("int polygonIndex = gl_VertexID / 3;"),s.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),s.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),s.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),s.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),s.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),s.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),s.push("if (int(flags.x) != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),s.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),s.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),s.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),s.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),s.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),s.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),s.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),s.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),s.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),s.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),s.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),s.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),s.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),s.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),s.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),s.push("if (color.a == 0u) {"),s.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),s.push("   return;"),s.push("};"),s.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),s.push("vec3 position;"),s.push("position = positions[gl_VertexID % 3];"),s.push("if (solid != 1u) {"),s.push("  if (isPerspectiveMatrix(projMatrix)) {"),s.push("      vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),s.push("      if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),s.push("          position = positions[2 - (gl_VertexID % 3)];"),s.push("      }"),s.push("  } else {"),s.push("      vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),s.push("      if (viewNormal.z < 0.0) {"),s.push("          position = positions[2 - (gl_VertexID % 3)];"),s.push("      }"),s.push("  }"),s.push("}"),s.push("vec4 worldPosition = sceneModelMatrix *  (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),s.push("vec4 viewPosition = viewMatrix * worldPosition; "),s.push("vec4 clipPos = projMatrix * viewPosition;"),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2.r;")),s.push("gl_Position = clipPos;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const i=this._scene._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,t=[];if(t.push("#version 300 es"),t.push("// TrianglesDataTextureColorRenderer fragment shader"),t.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),t.push("precision highp float;"),t.push("precision highp int;"),t.push("#else"),t.push("precision mediump float;"),t.push("precision mediump int;"),t.push("#endif"),s){t.push("in vec4 vWorldPosition;"),t.push("flat in uint vFlags2;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("uniform bool sectionPlaneActive"+o+";"),t.push("uniform vec3 sectionPlanePos"+o+";"),t.push("uniform vec3 sectionPlaneDir"+o+";")}if(t.push("out vec4 outColor;"),t.push("void main(void) {"),s){t.push("  bool clippable = (float(vFlags2) > 0.0);"),t.push("  if (clippable) {"),t.push("      float dist = 0.0;");for(let o=0;o<i.getNumAllocatedSectionPlanes();o++)t.push("      if (sectionPlaneActive"+o+") {"),t.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),t.push("      }");t.push("      if (dist > 0.0) { discard; }"),t.push("  }")}return t.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),t.push("}"),t}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const jh=c.vec3(),WB=c.vec3(),XB=c.vec3();c.vec3();const YB=c.mat4();class $B{constructor(e){this._scene=e,this._allocate(),this._hash=this._getHash()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,i,s){const t=this._scene,o=t.camera,n=i.model,a=t.canvas.gl,A=i._state,l=A.textureState,h=i._state.origin,{position:d,rotationMatrix:f,rotationMatrixConjugate:m}=n;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,A)),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let _,u;const P=h[0]!==0||h[1]!==0||h[2]!==0,y=d[0]!==0||d[1]!==0||d[2]!==0;if(P||y){const v=jh;if(P){const w=c.transformPoint3(f,h,WB);v[0]=w[0],v[1]=w[1],v[2]=w[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=d[0],v[1]+=d[1],v[2]+=d[2],_=ft(o.viewMatrix,v,YB),u=XB,u[0]=o.eye[0]-v[0],u[1]=o.eye[1]-v[1],u[2]=o.eye[2]-v[2]}else _=o.viewMatrix,u=o.eye;if(a.uniformMatrix4fv(this._uSceneModelMatrix,!1,m),a.uniformMatrix4fv(this._uViewMatrix,!1,_),a.uniformMatrix4fv(this._uProjMatrix,!1,o.projMatrix),a.uniform3fv(this._uCameraEyeRtc,u),a.uniform1i(this._uRenderPass,s),t.logarithmicDepthBufferEnabled){const v=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,v)}const x=t._sectionPlanesState.getNumAllocatedSectionPlanes(),B=t._sectionPlanesState.sectionPlanes.length;if(x>0){const v=t._sectionPlanesState.sectionPlanes,w=i.layerIndex*B,C=n.renderFlags;for(let I=0;I<x;I++){const E=this._uSectionPlanes[I];if(E)if(I<B){const S=C.sectionPlanesActivePerLayer[w+I];if(a.uniform1i(E.active,S?1:0),S){const R=v[I];if(h){const D=Ut(R.dist,R.dir,h,jh);a.uniform3fv(E.pos,D)}else a.uniform3fv(E.pos,R.pos);a.uniform3fv(E.dir,R.dir)}}else a.uniform1i(E.active,0)}}A.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),a.drawArrays(a.TRIANGLES,0,A.numIndices8Bits)),A.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),a.drawArrays(a.TRIANGLES,0,A.numIndices16Bits)),A.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),a.drawArrays(a.TRIANGLES,0,A.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,i=e.canvas.gl;if(this._program=new It(i,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("objectDecodeAndInstanceMatrix"),this._uSceneModelMatrix=s.getLocation("sceneModelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<o;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=s.getLocation("uCameraEyeRtc")}_bindProgram(e){const i=this._scene,s=i.canvas.gl,t=this._program,o=i.camera.project;if(t.bind(),s.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),i.logarithmicDepthBufferEnabled){const n=2/(Math.log(o.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,n)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Triangles dataTexture draw vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("uniform mat4 sceneModelMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),s.push("uniform highp sampler2D uTexturePerObjectMatrix;"),s.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),s.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),s.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),s.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),s.push("uniform vec3 uCameraEyeRtc;"),s.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("out float isPerspective;")),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out highp vec2 vHighPrecisionZW;"),i&&(s.push("out vec4 vWorldPosition;"),s.push("flat out uint vFlags2;")),s.push("void main(void) {"),s.push("int polygonIndex = gl_VertexID / 3;"),s.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),s.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),s.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),s.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),s.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),s.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),s.push("if (int(flags.x) != renderPass) {"),s.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),s.push("   return;"),s.push("} else {"),s.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),s.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),s.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),s.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),s.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),s.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),s.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),s.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),s.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),s.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),s.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),s.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),s.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),s.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),s.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),s.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),s.push("if (color.a == 0u) {"),s.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),s.push("   return;"),s.push("};"),s.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),s.push("vec3 position;"),s.push("position = positions[gl_VertexID % 3];"),s.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),s.push("if (solid != 1u) {"),s.push("if (isPerspectiveMatrix(projMatrix)) {"),s.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),s.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),s.push("position = positions[2 - (gl_VertexID % 3)];"),s.push("viewNormal = -viewNormal;"),s.push("}"),s.push("} else {"),s.push("if (viewNormal.z < 0.0) {"),s.push("position = positions[2 - (gl_VertexID % 3)];"),s.push("viewNormal = -viewNormal;"),s.push("}"),s.push("}"),s.push("}"),s.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),s.push("vec4 viewPosition = viewMatrix * worldPosition; "),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2.r;")),s.push("gl_Position = clipPos;"),s.push("vHighPrecisionZW = gl_Position.zw;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles dataTexture draw fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in highp vec2 vHighPrecisionZW;"),s.push("out vec4 outColor;"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("flat in uint vFlags2;");for(let t=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<o;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("void main(void) {"),i){s.push("  bool clippable = vFlags2 > 0u;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<o;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { "),s.push("      discard;"),s.push("  }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;"),s.push("    outColor = vec4(vec3(1.0 - fragCoordZ), 1.0); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Gh=c.vec3(),ZB=c.vec3(),qB=c.vec3();c.vec3();const JB=c.mat4();class ey{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,i,s){const t=i.model,o=t.scene,n=o.camera,a=o.canvas.gl,A=i._state,l=i._state.origin,{position:h,rotationMatrix:d,rotationMatrixConjugate:f}=t,m=n.viewMatrix;if(!this._program&&(this._allocate(i),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(i));let _,u;const P=l[0]!==0||l[1]!==0||l[2]!==0,y=h[0]!==0||h[1]!==0||h[2]!==0;if(P||y){const v=Gh;if(P){const w=ZB;c.transformPoint3(d,l,w),v[0]=w[0],v[1]=w[1],v[2]=w[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=h[0],v[1]+=h[1],v[2]+=h[2],_=ft(m,v,JB),u=qB,u[0]=n.eye[0]-v[0],u[1]=n.eye[1]-v[1],u[2]=n.eye[2]-v[2]}else _=m,u=n.eye;a.uniform1i(this._uRenderPass,s),a.uniformMatrix4fv(this._uWorldMatrix,!1,f),a.uniformMatrix4fv(this._uViewMatrix,!1,_),a.uniformMatrix4fv(this._uProjMatrix,!1,n.projMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,n.viewNormalMatrix),a.uniformMatrix4fv(this._uWorldNormalMatrix,!1,t.worldNormalMatrix);const x=o._sectionPlanesState.getNumAllocatedSectionPlanes(),B=o._sectionPlanesState.sectionPlanes.length;if(x>0){const v=o._sectionPlanesState.sectionPlanes,w=i.layerIndex*B,C=t.renderFlags;for(let I=0;I<x;I++){const E=this._uSectionPlanes[I];if(E)if(I<B){const S=C.sectionPlanesActivePerLayer[w+I];if(a.uniform1i(E.active,S?1:0),S){const R=v[I];if(l){const D=Ut(R.dist,R.dir,l,Gh);a.uniform3fv(E.pos,D)}else a.uniform3fv(E.pos,R.pos);a.uniform3fv(E.dir,R.dir)}}else a.uniform1i(E.active,0)}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,i._state.objectDecodeAndInstanceMatrix),this._aPosition.bindArrayBuffer(A.positionsBuf),this._aOffset.bindArrayBuffer(A.offsetsBuf),this._aNormal.bindArrayBuffer(A.normalsBuf),this._aColor.bindArrayBuffer(A.colorsBuf),this._aFlags.bindArrayBuffer(A.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(A.flags2Buf),A.indicesBuf.bind(),a.drawElements(a.TRIANGLES,A.indicesBuf.numItems,A.indicesBuf.itemType,0)}_allocate(){const e=this._scene,i=e.canvas.gl;if(this._program=new It(i,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("objectDecodeAndInstanceMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uWorldNormalMatrix=s.getLocation("worldNormalMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uViewNormalMatrix=s.getLocation("viewNormalMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<o;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aNormal=s.getAttribute("normal"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2&&(this._aFlags2=s.getAttribute("flags2")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){const e=this._scene,i=e.canvas.gl,s=e.camera.project;if(this._program.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),e.logarithmicDepthBufferEnabled){const t=2/(Math.log(s.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("// Batched geometry normals vertex shader"),e.logarithmicDepthBufferEnabled&&_t.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("uniform int renderPass;"),s.push("attribute vec3 position;"),e.entityOffsetsEnabled&&s.push("attribute vec3 offset;"),s.push("attribute vec3 normal;"),s.push("attribute vec4 color;"),s.push("attribute vec4 flags;"),s.push("attribute vec4 flags2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 worldNormalMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 viewNormalMatrix;"),s.push("uniform mat4 objectDecodeAndInstanceMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),_t.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("varying float isPerspective;")),s.push("vec3 octDecode(vec2 oct) {"),s.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),s.push("    if (v.z < 0.0) {"),s.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),s.push("    }"),s.push("    return normalize(v);"),s.push("}"),i&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("out vec3 vViewNormal;"),s.push("void main(void) {"),s.push("if (int(flags.x) != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition   = viewMatrix * worldPosition; "),s.push("      vec4 worldNormal    = worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),s.push("      vec3 viewNormal     = normalize((viewNormalMatrix * worldNormal).xyz);"),i&&(s.push("      vWorldPosition  = worldPosition;"),s.push("      vFlags2         = flags2;")),s.push("      vViewNormal = viewNormal;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(_t.SUPPORTED_EXTENSIONS.EXT_frag_depth?s.push("vFragDepth = 1.0 + clipPos.w;"):(s.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),s.push("clipPos.z *= clipPos.w;")),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry normals fragment shader"),e.logarithmicDepthBufferEnabled&&_t.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&_t.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let o=0;o<e._sectionPlanesState.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec3 vViewNormal;"),s.push("vec3 packNormalToRGB( const in vec3 normal ) {"),s.push("    return normalize( normal ) * 0.5 + 0.5;"),s.push("}"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var t=0;t<e._sectionPlanesState.getNumAllocatedSectionPlanes();t++)s.push("      if (sectionPlaneActive"+t+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&_t.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    gl_FragColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const zh=c.vec3(),ty=c.vec3(),iy=c.vec3();c.vec3();c.vec4();const sy=c.mat4();class Ga{constructor(e,i){this._scene=e,this._withSAO=i,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){const e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,i,s){const t=this._scene,o=t.camera,n=i.model,a=t.canvas.gl,A=i._state,l=A.textureState,h=i._state.origin,{position:d,rotationMatrix:f,rotationMatrixConjugate:m}=n;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,A)),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let _,u;const P=h[0]!==0||h[1]!==0||h[2]!==0,y=d[0]!==0||d[1]!==0||d[2]!==0;if(P||y){const v=zh;if(P){const w=c.transformPoint3(f,h,ty);v[0]=w[0],v[1]=w[1],v[2]=w[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=d[0],v[1]+=d[1],v[2]+=d[2],_=ft(o.viewMatrix,v,sy),u=iy,u[0]=o.eye[0]-v[0],u[1]=o.eye[1]-v[1],u[2]=o.eye[2]-v[2]}else _=o.viewMatrix,u=o.eye;if(a.uniform2fv(this._uPickClipPos,e.pickClipPos),a.uniform2f(this._uDrawingBufferSize,a.drawingBufferWidth,a.drawingBufferHeight),a.uniformMatrix4fv(this._uSceneModelMatrix,!1,m),a.uniformMatrix4fv(this._uViewMatrix,!1,_),a.uniformMatrix4fv(this._uProjMatrix,!1,o.projMatrix),a.uniform3fv(this._uCameraEyeRtc,u),a.uniform1i(this._uRenderPass,s),t.logarithmicDepthBufferEnabled){const v=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,v)}const x=t._sectionPlanesState.getNumAllocatedSectionPlanes(),B=t._sectionPlanesState.sectionPlanes.length;if(x>0){const v=t._sectionPlanesState.sectionPlanes,w=i.layerIndex*B,C=n.renderFlags;for(let I=0;I<x;I++){const E=this._uSectionPlanes[I];if(E)if(I<B){const S=C.sectionPlanesActivePerLayer[w+I];if(a.uniform1i(E.active,S?1:0),S){const R=v[I];if(h){const D=Ut(R.dist,R.dir,h,zh);a.uniform3fv(E.pos,D)}else a.uniform3fv(E.pos,R.pos);a.uniform3fv(E.dir,R.dir)}}else a.uniform1i(E.active,0)}}A.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),a.drawArrays(a.TRIANGLES,0,A.numIndices8Bits)),A.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),a.drawArrays(a.TRIANGLES,0,A.numIndices16Bits)),A.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),a.drawArrays(a.TRIANGLES,0,A.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,i=e.canvas.gl;if(this._program=new It(i,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPickInvisible=s.getLocation("pickInvisible"),this._uPickClipPos=s.getLocation("pickClipPos"),this._uDrawingBufferSize=s.getLocation("drawingBufferSize"),this._uSceneModelMatrix=s.getLocation("sceneModelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<o;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=s.getLocation("uCameraEyeRtc")}_bindProgram(e){const i=this._scene,s=i.canvas.gl,t=this._program,o=i.camera.project;if(t.bind(),i.logarithmicDepthBufferEnabled){const n=2/(Math.log(o.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,n)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// trianglesDatatextureNormalsRenderer vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("uniform mat4 sceneModelMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),s.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),s.push("uniform highp sampler2D uTexturePerObjectMatrix;"),s.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),s.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),s.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),s.push("uniform vec3 uCameraEyeRtc;"),s.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("out float isPerspective;")),s.push("uniform vec2 pickClipPos;"),s.push("uniform vec2 drawingBufferSize;"),s.push("vec4 remapClipPos(vec4 clipPos) {"),s.push("    clipPos.xy /= clipPos.w;"),s.push("    clipPos.xy = (clipPos.xy - pickClipPos) * drawingBufferSize;"),s.push("    clipPos.xy *= clipPos.w;"),s.push("    return clipPos;"),s.push("}"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out vec4 vWorldPosition;"),i&&s.push("flat out uint vFlags2;"),s.push("void main(void) {"),s.push("int polygonIndex = gl_VertexID / 3;"),s.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),s.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),s.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),s.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),s.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),s.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),s.push("if (int(flags.w) != renderPass) {"),s.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),s.push("   return;"),s.push("} else {"),s.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),s.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),s.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),s.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),s.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),s.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),s.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),s.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),s.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),s.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),s.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),s.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),s.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),s.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),s.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),s.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),s.push("if (color.a == 0u) {"),s.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),s.push("   return;"),s.push("};"),s.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),s.push("vec3 position;"),s.push("position = positions[gl_VertexID % 3];"),s.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),s.push("if (solid != 1u) {"),s.push("if (isPerspectiveMatrix(projMatrix)) {"),s.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),s.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),s.push("position = positions[2 - (gl_VertexID % 3)];"),s.push("viewNormal = -viewNormal;"),s.push("}"),s.push("} else {"),s.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),s.push("if (viewNormal.z < 0.0) {"),s.push("position = positions[2 - (gl_VertexID % 3)];"),s.push("}"),s.push("}"),s.push("}"),s.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),s.push("vec4 viewPosition = viewMatrix * worldPosition; "),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("vWorldPosition = worldPosition;"),i&&s.push("vFlags2 = flags2.r;"),s.push("gl_Position = remapClipPos(clipPos);"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// TrianglesDataTexturePickNormalsRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("in vec4 vWorldPosition;"),i){s.push("flat in uint vFlags2;");for(let t=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<o;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("out highp ivec4 outNormal;"),s.push("void main(void) {"),i){s.push("  bool clippable = vFlags2 > 0u;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<o;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { "),s.push("      discard;"),s.push("  }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("  vec3 xTangent = dFdx( vWorldPosition.xyz );"),s.push("  vec3 yTangent = dFdy( vWorldPosition.xyz );"),s.push("  vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),s.push(`  outNormal = ivec4(worldNormal * float(${c.MAX_INT}), 1.0);`),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class ry{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._colorRendererWithSAO&&!this._colorRendererWithSAO.getValid()&&(this._colorRendererWithSAO.destroy(),this._colorRendererWithSAO=null),this._flatColorRenderer&&!this._flatColorRenderer.getValid()&&(this._flatColorRenderer.destroy(),this._flatColorRenderer=null),this._flatColorRendererWithSAO&&!this._flatColorRendererWithSAO.getValid()&&(this._flatColorRendererWithSAO.destroy(),this._flatColorRendererWithSAO=null),this._colorQualityRendererWithSAO&&!this._colorQualityRendererWithSAO.getValid()&&(this._colorQualityRendererWithSAO.destroy(),this._colorQualityRendererWithSAO=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._normalsRenderer&&!this._normalsRenderer.getValid()&&(this._normalsRenderer.destroy(),this._normalsRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._edgesRenderer&&!this._edgesRenderer.getValid()&&(this._edgesRenderer.destroy(),this._edgesRenderer=null),this._edgesColorRenderer&&!this._edgesColorRenderer.getValid()&&(this._edgesColorRenderer.destroy(),this._edgesColorRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._pickNormalsRenderer&&this._pickNormalsRenderer.getValid()===!1&&(this._pickNormalsRenderer.destroy(),this._pickNormalsRenderer=null),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.getValid()===!1&&(this._pickNormalsFlatRenderer.destroy(),this._pickNormalsFlatRenderer=null),this._occlusionRenderer&&this._occlusionRenderer.getValid()===!1&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null)}eagerCreateRenders(){this._silhouetteRenderer||(this._silhouetteRenderer=new Th(this._scene)),this._pickMeshRenderer||(this._pickMeshRenderer=new Uh(this._scene)),this._pickDepthRenderer||(this._pickDepthRenderer=new kh(this._scene)),this._pickNormalsRenderer||(this._pickNormalsRenderer=new Ga(this._scene)),this._snapRenderer||(this._snapRenderer=new ja(this._scene)),this._snapInitRenderer||(this._snapInitRenderer=new Hh(this._scene)),this._snapRenderer||(this._snapRenderer=new ja(this._scene))}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new Mh(this._scene,!1)),this._colorRenderer}get colorRendererWithSAO(){return this._colorRendererWithSAO||(this._colorRendererWithSAO=new Mh(this._scene,!0)),this._colorRendererWithSAO}get colorQualityRendererWithSAO(){return this._colorQualityRendererWithSAO}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Th(this._scene)),this._silhouetteRenderer}get depthRenderer(){return this._depthRenderer||(this._depthRenderer=new $B(this._scene)),this._depthRenderer}get normalsRenderer(){return this._normalsRenderer||(this._normalsRenderer=new ey(this._scene)),this._normalsRenderer}get edgesRenderer(){return this._edgesRenderer||(this._edgesRenderer=new bB(this._scene)),this._edgesRenderer}get edgesColorRenderer(){return this._edgesColorRenderer||(this._edgesColorRenderer=new IB(this._scene)),this._edgesColorRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new Uh(this._scene)),this._pickMeshRenderer}get pickNormalsRenderer(){return this._pickNormalsRenderer||(this._pickNormalsRenderer=new Ga(this._scene)),this._pickNormalsRenderer}get pickNormalsFlatRenderer(){return this._pickNormalsFlatRenderer||(this._pickNormalsFlatRenderer=new Ga(this._scene)),this._pickNormalsFlatRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new kh(this._scene)),this._pickDepthRenderer}get snapRenderer(){return this._snapRenderer||(this._snapRenderer=new ja(this._scene)),this._snapRenderer}get snapInitRenderer(){return this._snapInitRenderer||(this._snapInitRenderer=new Hh(this._scene)),this._snapInitRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new KB(this._scene)),this._occlusionRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._colorRendererWithSAO&&this._colorRendererWithSAO.destroy(),this._flatColorRenderer&&this._flatColorRenderer.destroy(),this._flatColorRendererWithSAO&&this._flatColorRendererWithSAO.destroy(),this._colorQualityRendererWithSAO&&this._colorQualityRendererWithSAO.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._normalsRenderer&&this._normalsRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._edgesRenderer&&this._edgesRenderer.destroy(),this._edgesColorRenderer&&this._edgesColorRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._pickNormalsRenderer&&this._pickNormalsRenderer.destroy(),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy()}}const za={};function oy(r){const e=r.id;let i=za[e];return i||(i=new ry(r),za[e]=i,i._compile(),i.eagerCreateRenders(),r.on("compile",()=>{i._compile(),i.eagerCreateRenders()}),r.on("destroyed",()=>{delete za[e],i._destroy()})),i}class ny{constructor(){this.positionsCompressed=[],this.lenPositionsCompressed=0,this.metallicRoughness=[],this.indices8Bits=[],this.lenIndices8Bits=0,this.indices16Bits=[],this.lenIndices16Bits=0,this.indices32Bits=[],this.lenIndices32Bits=0,this.edgeIndices8Bits=[],this.lenEdgeIndices8Bits=0,this.edgeIndices16Bits=[],this.lenEdgeIndices16Bits=0,this.edgeIndices32Bits=[],this.lenEdgeIndices32Bits=0,this.perObjectColors=[],this.perObjectPickColors=[],this.perObjectSolid=[],this.perObjectOffsets=[],this.perObjectPositionsDecodeMatrices=[],this.perObjectInstancePositioningMatrices=[],this.perObjectVertexBases=[],this.perObjectIndexBaseOffsets=[],this.perObjectEdgeIndexBaseOffsets=[],this.perTriangleNumberPortionId8Bits=[],this.perTriangleNumberPortionId16Bits=[],this.perTriangleNumberPortionId32Bits=[],this.perEdgeNumberPortionId8Bits=[],this.perEdgeNumberPortionId16Bits=[],this.perEdgeNumberPortionId32Bits=[]}}class ay{constructor(){this.texturePerObjectColorsAndFlags=null,this.texturePerObjectOffsets=null,this.texturePerObjectInstanceMatrices=null,this.texturePerObjectPositionsDecodeMatrix=null,this.texturePerVertexIdCoordinates=null,this.texturePerPolygonIdPortionIds8Bits=null,this.texturePerPolygonIdPortionIds16Bits=null,this.texturePerPolygonIdPortionIds32Bits=null,this.texturePerEdgeIdPortionIds8Bits=null,this.texturePerEdgeIdPortionIds16Bits=null,this.texturePerEdgeIdPortionIds32Bits=null,this.texturePerPolygonIdIndices8Bits=null,this.texturePerPolygonIdIndices16Bits=null,this.texturePerPolygonIdIndices32Bits=null,this.texturePerPolygonIdEdgeIndices8Bits=null,this.texturePerPolygonIdEdgeIndices16Bits=null,this.texturePerPolygonIdEdgeIndices32Bits=null,this.textureModelMatrices=null}finalize(){this.indicesPerBitnessTextures={8:this.texturePerPolygonIdIndices8Bits,16:this.texturePerPolygonIdIndices16Bits,32:this.texturePerPolygonIdIndices32Bits},this.indicesPortionIdsPerBitnessTextures={8:this.texturePerPolygonIdPortionIds8Bits,16:this.texturePerPolygonIdPortionIds16Bits,32:this.texturePerPolygonIdPortionIds32Bits},this.edgeIndicesPerBitnessTextures={8:this.texturePerPolygonIdEdgeIndices8Bits,16:this.texturePerPolygonIdEdgeIndices16Bits,32:this.texturePerPolygonIdEdgeIndices32Bits},this.edgeIndicesPortionIdsPerBitnessTextures={8:this.texturePerEdgeIdPortionIds8Bits,16:this.texturePerEdgeIdPortionIds16Bits,32:this.texturePerEdgeIdPortionIds32Bits}}bindCommonTextures(e,i,s,t,o){this.texturePerObjectPositionsDecodeMatrix.bindTexture(e,i,1),this.texturePerVertexIdCoordinates.bindTexture(e,s,2),this.texturePerObjectColorsAndFlags.bindTexture(e,t,3),this.texturePerObjectInstanceMatrices.bindTexture(e,o,4)}bindTriangleIndicesTextures(e,i,s,t){this.indicesPortionIdsPerBitnessTextures[t].bindTexture(e,i,5),this.indicesPerBitnessTextures[t].bindTexture(e,s,6)}bindEdgeIndicesTextures(e,i,s,t){this.edgeIndicesPortionIdsPerBitnessTextures[t].bindTexture(e,i,5),this.edgeIndicesPerBitnessTextures[t].bindTexture(e,s,6)}}const et={sizeDataColorsAndFlags:0,sizeDataPositionDecodeMatrices:0,sizeDataTextureOffsets:0,sizeDataTexturePositions:0,sizeDataTextureIndices:0,sizeDataTextureEdgeIndices:0,sizeDataTexturePortionIds:0,numberOfGeometries:0,numberOfPortions:0,numberOfLayers:0,numberOfTextures:0,totalPolygons:0,totalPolygons8Bits:0,totalPolygons16Bits:0,totalPolygons32Bits:0,totalEdges:0,totalEdges8Bits:0,totalEdges16Bits:0,totalEdges32Bits:0,cannotCreatePortion:{because10BitsObjectId:0,becauseTextureSize:0},overheadSizeAlignementIndices:0,overheadSizeAlignementEdgeIndices:0};window.printDataTextureRamStats=function(){console.log(JSON.stringify(et,null,4));let r=0;Object.keys(et).forEach(i=>{i.startsWith("size")&&(r+=et[i])}),console.log(`Total size ${r} bytes (${(r/1e3/1e3).toFixed(2)} MB)`),console.log(`Avg bytes / triangle: ${(r/et.totalPolygons).toFixed(2)}`);let e={};Object.keys(et).forEach(i=>{i.startsWith("size")&&(e[i]=`${(et[i]/r*100).toFixed(2)} % of total`)}),console.log(JSON.stringify({percentualRamUsage:e},null,4))};class Ay{constructor(){}disableBindedTextureFiltering(e){e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)}createTextureForColorsAndFlags(e,i,s,t,o,n,a){const A=i.length;this.numPortions=A;const l=512*8,h=Math.ceil(A/(l/8));if(h===0)throw"texture height===0";const d=new Uint8Array(4*l*h);et.sizeDataColorsAndFlags+=d.byteLength,et.numberOfTextures++;for(let m=0;m<A;m++)d.set(i[m],m*32+0),d.set(s[m],m*32+4),d.set([0,0,0,0],m*32+8),d.set([0,0,0,0],m*32+12),d.set([t[m]>>24&255,t[m]>>16&255,t[m]>>8&255,t[m]&255],m*32+16),d.set([o[m]>>24&255,o[m]>>16&255,o[m]>>8&255,o[m]&255],m*32+20),d.set([n[m]>>24&255,n[m]>>16&255,n[m]>>8&255,n[m]&255],m*32+24),d.set([a[m]?1:0,0,0,0],m*32+28);const f=e.createTexture();return e.bindTexture(e.TEXTURE_2D,f),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA8UI,l,h),e.texSubImage2D(e.TEXTURE_2D,0,0,0,l,h,e.RGBA_INTEGER,e.UNSIGNED_BYTE,d,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Lt(e,f,l,h,d)}createTextureForObjectOffsets(e,i){const t=Math.ceil(i/512);if(t===0)throw"texture height===0";const o=new Float32Array(3*512*t).fill(0);et.sizeDataTextureOffsets+=o.byteLength,et.numberOfTextures++;const n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RGB32F,512,t),e.texSubImage2D(e.TEXTURE_2D,0,0,0,512,t,e.RGB,e.FLOAT,o,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Lt(e,n,512,t,o)}createTextureForInstancingMatrices(e,i){const s=i.length;if(s===0)throw"num instance matrices===0";const t=512*4,o=Math.ceil(s/(t/4)),n=new Float32Array(4*t*o);et.numberOfTextures++;for(let A=0;A<i.length;A++)n.set(i[A],A*16);const a=e.createTexture();return e.bindTexture(e.TEXTURE_2D,a),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA32F,t,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,t,o,e.RGBA,e.FLOAT,n,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Lt(e,a,t,o,n)}createTextureForPositionsDecodeMatrices(e,i){const s=i.length;if(s===0)throw"num decode+entity matrices===0";const t=512*4,o=Math.ceil(s/(t/4)),n=new Float32Array(4*t*o);et.sizeDataPositionDecodeMatrices+=n.byteLength,et.numberOfTextures++;for(let A=0;A<i.length;A++)n.set(i[A],A*16);const a=e.createTexture();return e.bindTexture(e.TEXTURE_2D,a),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA32F,t,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,t,o,e.RGBA,e.FLOAT,n,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Lt(e,a,t,o)}createTextureFor8BitIndices(e,i,s){if(s===0)return{texture:null,textureHeight:0};const t=4096,o=Math.ceil(s/3/t);if(o===0)throw"texture height===0";const n=t*o*3,a=new Uint8Array(n);et.sizeDataTextureIndices+=a.byteLength,et.numberOfTextures++;for(let l=0,h=0,d=i.length;l<d;l++){const f=i[l];a.set(f,h),h+=f.length}const A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.RGB8UI,t,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,t,o,e.RGB_INTEGER,e.UNSIGNED_BYTE,a,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Lt(e,A,t,o)}createTextureFor16BitIndices(e,i,s){if(s===0)return{texture:null,textureHeight:0};const t=4096,o=Math.ceil(s/3/t);if(o===0)throw"texture height===0";const n=t*o*3,a=new Uint16Array(n);et.sizeDataTextureIndices+=a.byteLength,et.numberOfTextures++;for(let l=0,h=0,d=i.length;l<d;l++){const f=i[l];a.set(f,h),h+=f.length}const A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.RGB16UI,t,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,t,o,e.RGB_INTEGER,e.UNSIGNED_SHORT,a,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Lt(e,A,t,o)}createTextureFor32BitIndices(e,i,s){if(s===0)return{texture:null,textureHeight:0};const t=4096,o=Math.ceil(s/3/t);if(o===0)throw"texture height===0";const n=t*o*3,a=new Uint32Array(n);et.sizeDataTextureIndices+=a.byteLength,et.numberOfTextures++;for(let l=0,h=0,d=i.length;l<d;l++){const f=i[l];a.set(f,h),h+=f.length}const A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.RGB32UI,t,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,t,o,e.RGB_INTEGER,e.UNSIGNED_INT,a,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Lt(e,A,t,o)}createTextureFor8BitsEdgeIndices(e,i,s){if(s===0)return{texture:null,textureHeight:0};const t=4096,o=Math.ceil(s/2/t);if(o===0)throw"texture height===0";const n=t*o*2,a=new Uint8Array(n);et.sizeDataTextureEdgeIndices+=a.byteLength,et.numberOfTextures++;for(let l=0,h=0,d=i.length;l<d;l++){const f=i[l];a.set(f,h),h+=f.length}const A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.RG8UI,t,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,t,o,e.RG_INTEGER,e.UNSIGNED_BYTE,a,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Lt(e,A,t,o)}createTextureFor16BitsEdgeIndices(e,i,s){if(s===0)return{texture:null,textureHeight:0};const t=4096,o=Math.ceil(s/2/t);if(o===0)throw"texture height===0";const n=t*o*2,a=new Uint16Array(n);et.sizeDataTextureEdgeIndices+=a.byteLength,et.numberOfTextures++;for(let l=0,h=0,d=i.length;l<d;l++){const f=i[l];a.set(f,h),h+=f.length}const A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.RG16UI,t,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,t,o,e.RG_INTEGER,e.UNSIGNED_SHORT,a,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Lt(e,A,t,o)}createTextureFor32BitsEdgeIndices(e,i,s){if(s===0)return{texture:null,textureHeight:0};const t=4096,o=Math.ceil(s/2/t);if(o===0)throw"texture height===0";const n=t*o*2,a=new Uint32Array(n);et.sizeDataTextureEdgeIndices+=a.byteLength,et.numberOfTextures++;for(let l=0,h=0,d=i.length;l<d;l++){const f=i[l];a.set(f,h),h+=f.length}const A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.RG32UI,t,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,t,o,e.RG_INTEGER,e.UNSIGNED_INT,a,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Lt(e,A,t,o)}createTextureForPositions(e,i,s){const t=s/3,o=4096,n=Math.ceil(t/o);if(n===0)throw"texture height===0";const a=o*n*3,A=new Uint16Array(a);et.sizeDataTexturePositions+=A.byteLength,et.numberOfTextures++;for(let h=0,d=0,f=i.length;h<f;h++){const m=i[h];A.set(m,d),d+=m.length}const l=e.createTexture();return e.bindTexture(e.TEXTURE_2D,l),e.texStorage2D(e.TEXTURE_2D,1,e.RGB16UI,o,n),e.texSubImage2D(e.TEXTURE_2D,0,0,0,o,n,e.RGB_INTEGER,e.UNSIGNED_SHORT,A,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Lt(e,l,o,n)}createTextureForPackedPortionIds(e,i){if(i.length===0)return{texture:null,textureHeight:0};const s=i.length,t=4096,o=Math.ceil(s/t);if(o===0)throw"texture height===0";const n=t*o,a=new Uint16Array(n);a.set(i,0),et.sizeDataTexturePortionIds+=a.byteLength,et.numberOfTextures++;const A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.R16UI,t,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,t,o,e.RED_INTEGER,e.UNSIGNED_SHORT,a,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Lt(e,A,t,o)}}const ly=new yl,Kh=65536,Vo=ly.maxDataTextureHeight,Os=8,Tr=10,Ka=new Float32Array(16),Ht=new Uint8Array(4),Dr=new Float32Array(3);let cy=0;const hy=c.identityMat4();class uy{constructor(e,i){console.info("Creating DTXTrianglesLayer"),et.numberOfLayers++,this._layerNumber=cy++,this.sortId=`TriDTX-${this._layerNumber}`,this.layerIndex=i.layerIndex,this._renderers=oy(e.scene),this.model=e,this._buffer=new ny,this._dtxState=new ay,this._dtxTextureFactory=new Ay,this._state=new Ft({origin:c.vec3(i.origin),metallicRoughnessBuf:null,textureState:this._dtxState,numIndices8Bits:0,numIndices16Bits:0,numIndices32Bits:0,numEdgeIndices8Bits:0,numEdgeIndices16Bits:0,numEdgeIndices32Bits:0,numVertices:0}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._subPortions=[],this._portionToSubPortionsMap=[],this._bucketGeometries={},this._meshes=[],this._aabb=c.collapseAABB3(),this.aabbDirty=!0,this._numUpdatesInFrame=0,this._finalized=!1}get aabb(){if(this.aabbDirty){c.collapseAABB3(this._aabb);for(let e=0,i=this._meshes.length;e<i;e++)c.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}canCreatePortion(e){if(this._finalized)throw"Already finalized";const i=e.buckets.length;this._numPortions+i>Kh&&et.cannotCreatePortion.because10BitsObjectId++;let s=this._numPortions+i<=Kh;const t=0,o=e.geometryId!==void 0&&e.geometryId!==null?`${e.geometryId}#${t}`:`${e.id}#${t}`;if(!this._bucketGeometries[o]){const a=Math.max(this._state.numIndices8Bits,this._state.numIndices16Bits,this._state.numIndices32Bits);let A=0,l=0;e.buckets.forEach(h=>{A+=h.positionsCompressed.length/3,l+=h.indices.length/3}),(this._state.numVertices+A>Vo*4096||a+l>Vo*4096)&&et.cannotCreatePortion.becauseTextureSize++,s&&(s=this._state.numVertices+A<=Vo*4096&&a+l<=Vo*4096)}return s}createPortion(e,i){if(this._finalized)throw"Already finalized";const s=[];i.buckets.forEach((o,n)=>{const a=i.geometryId!==void 0&&i.geometryId!==null?`${i.geometryId}#${n}`:`${i.id}#${n}`;let A=this._bucketGeometries[a];A||(A=this._createBucketGeometry(i,o),this._bucketGeometries[a]=A);const l=this._createSubPortion(i,A,o);s.push(l)});const t=this._portionToSubPortionsMap.length;return this._portionToSubPortionsMap.push(s),this.model.numPortions++,this._meshes.push(e),t}_createBucketGeometry(e,i){if(i.indices){const _=Math.ceil(i.indices.length/3/Os)*Os*3;et.overheadSizeAlignementIndices+=2*(_-i.indices.length);const u=new Uint32Array(_);u.fill(0),u.set(i.indices),i.indices=u}if(i.edgeIndices){const _=Math.ceil(i.edgeIndices.length/2/Os)*Os*2;et.overheadSizeAlignementEdgeIndices+=2*(_-i.edgeIndices.length);const u=new Uint32Array(_);u.fill(0),u.set(i.edgeIndices),i.edgeIndices=u}const s=i.positionsCompressed,t=i.indices,o=i.edgeIndices,n=this._buffer;n.positionsCompressed.push(s);const a=n.lenPositionsCompressed/3,A=s.length/3;n.lenPositionsCompressed+=s.length;let l,h=0;if(t){h=t.length/3;let _;A<=256?(_=n.indices8Bits,l=n.lenIndices8Bits/3,n.lenIndices8Bits+=t.length):A<=65536?(_=n.indices16Bits,l=n.lenIndices16Bits/3,n.lenIndices16Bits+=t.length):(_=n.indices32Bits,l=n.lenIndices32Bits/3,n.lenIndices32Bits+=t.length),_.push(t)}let d,f=0;if(o){f=o.length/2;let _;A<=256?(_=n.edgeIndices8Bits,d=n.lenEdgeIndices8Bits/2,n.lenEdgeIndices8Bits+=o.length):A<=65536?(_=n.edgeIndices16Bits,d=n.lenEdgeIndices16Bits/2,n.lenEdgeIndices16Bits+=o.length):(_=n.edgeIndices32Bits,d=n.lenEdgeIndices32Bits/2,n.lenEdgeIndices32Bits+=o.length),_.push(o)}return this._state.numVertices+=A,et.numberOfGeometries++,{vertexBase:a,numVertices:A,numTriangles:h,numEdges:f,indicesBase:l,edgeIndicesBase:d}}_createSubPortion(e,i,s,t){const o=e.color;e.metallic,e.roughness;const n=e.colors,a=e.opacity,A=e.meshMatrix,l=e.pickColor,h=this._buffer,d=this._state;h.perObjectPositionsDecodeMatrices.push(e.positionsDecodeMatrix),h.perObjectInstancePositioningMatrices.push(A||hy),h.perObjectSolid.push(!!e.solid),n?h.perObjectColors.push([n[0]*255,n[1]*255,n[2]*255,255]):o&&h.perObjectColors.push([o[0],o[1],o[2],a]),h.perObjectPickColors.push(l),h.perObjectVertexBases.push(i.vertexBase);{let m;i.numVertices<=256?m=d.numIndices8Bits:i.numVertices<=65536?m=d.numIndices16Bits:m=d.numIndices32Bits,h.perObjectIndexBaseOffsets.push(m/3-i.indicesBase)}{let m;i.numVertices<=256?m=d.numEdgeIndices8Bits:i.numVertices<=65536?m=d.numEdgeIndices16Bits:m=d.numEdgeIndices32Bits,h.perObjectEdgeIndexBaseOffsets.push(m/2-i.edgeIndicesBase)}const f=this._subPortions.length;if(i.numTriangles>0){let m=i.numTriangles*3,_;i.numVertices<=256?(_=h.perTriangleNumberPortionId8Bits,d.numIndices8Bits+=m,et.totalPolygons8Bits+=i.numTriangles):i.numVertices<=65536?(_=h.perTriangleNumberPortionId16Bits,d.numIndices16Bits+=m,et.totalPolygons16Bits+=i.numTriangles):(_=h.perTriangleNumberPortionId32Bits,d.numIndices32Bits+=m,et.totalPolygons32Bits+=i.numTriangles),et.totalPolygons+=i.numTriangles;for(let u=0;u<i.numTriangles;u+=Os)_.push(f)}if(i.numEdges>0){let m=i.numEdges*2,_;i.numVertices<=256?(_=h.perEdgeNumberPortionId8Bits,d.numEdgeIndices8Bits+=m,et.totalEdges8Bits+=i.numEdges):i.numVertices<=65536?(_=h.perEdgeNumberPortionId16Bits,d.numEdgeIndices16Bits+=m,et.totalEdges16Bits+=i.numEdges):(_=h.perEdgeNumberPortionId32Bits,d.numEdgeIndices32Bits+=m,et.totalEdges32Bits+=i.numEdges),et.totalEdges+=i.numEdges;for(let u=0;u<i.numEdges;u+=Os)_.push(f)}return this._subPortions.push({numVertices:i.numTriangles}),this._numPortions++,et.numberOfPortions++,f}finalize(){if(this._finalized)return;const e=this._state,i=this._dtxState,s=this.model.scene.canvas.gl,t=this._buffer;e.gl=s,i.texturePerObjectColorsAndFlags=this._dtxTextureFactory.createTextureForColorsAndFlags(s,t.perObjectColors,t.perObjectPickColors,t.perObjectVertexBases,t.perObjectIndexBaseOffsets,t.perObjectEdgeIndexBaseOffsets,t.perObjectSolid),i.texturePerObjectInstanceMatrices=this._dtxTextureFactory.createTextureForInstancingMatrices(s,t.perObjectInstancePositioningMatrices),i.texturePerObjectPositionsDecodeMatrix=this._dtxTextureFactory.createTextureForPositionsDecodeMatrices(s,t.perObjectPositionsDecodeMatrices),i.texturePerVertexIdCoordinates=this._dtxTextureFactory.createTextureForPositions(s,t.positionsCompressed,t.lenPositionsCompressed),i.texturePerPolygonIdPortionIds8Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(s,t.perTriangleNumberPortionId8Bits),i.texturePerPolygonIdPortionIds16Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(s,t.perTriangleNumberPortionId16Bits),i.texturePerPolygonIdPortionIds32Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(s,t.perTriangleNumberPortionId32Bits),t.perEdgeNumberPortionId8Bits.length>0&&(i.texturePerEdgeIdPortionIds8Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(s,t.perEdgeNumberPortionId8Bits)),t.perEdgeNumberPortionId16Bits.length>0&&(i.texturePerEdgeIdPortionIds16Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(s,t.perEdgeNumberPortionId16Bits)),t.perEdgeNumberPortionId32Bits.length>0&&(i.texturePerEdgeIdPortionIds32Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(s,t.perEdgeNumberPortionId32Bits)),t.lenIndices8Bits>0&&(i.texturePerPolygonIdIndices8Bits=this._dtxTextureFactory.createTextureFor8BitIndices(s,t.indices8Bits,t.lenIndices8Bits)),t.lenIndices16Bits>0&&(i.texturePerPolygonIdIndices16Bits=this._dtxTextureFactory.createTextureFor16BitIndices(s,t.indices16Bits,t.lenIndices16Bits)),t.lenIndices32Bits>0&&(i.texturePerPolygonIdIndices32Bits=this._dtxTextureFactory.createTextureFor32BitIndices(s,t.indices32Bits,t.lenIndices32Bits)),t.lenEdgeIndices8Bits>0&&(i.texturePerPolygonIdEdgeIndices8Bits=this._dtxTextureFactory.createTextureFor8BitsEdgeIndices(s,t.edgeIndices8Bits,t.lenEdgeIndices8Bits)),t.lenEdgeIndices16Bits>0&&(i.texturePerPolygonIdEdgeIndices16Bits=this._dtxTextureFactory.createTextureFor16BitsEdgeIndices(s,t.edgeIndices16Bits,t.lenEdgeIndices16Bits)),t.lenEdgeIndices32Bits>0&&(i.texturePerPolygonIdEdgeIndices32Bits=this._dtxTextureFactory.createTextureFor32BitsEdgeIndices(s,t.edgeIndices32Bits,t.lenEdgeIndices32Bits)),i.finalize(),this._buffer=null,this._bucketGeometries={},this._finalized=!0,this._deferredSetFlagsDirty=!1,this._onSceneRendering=this.model.scene.on("rendering",()=>{this._deferredSetFlagsDirty&&this._uploadDeferredFlags(),this._numUpdatesInFrame=0})}isEmpty(){return this._numPortions===0}initFlags(e,i,s){i&k.VISIBLE&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),i&k.HIGHLIGHTED&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),i&k.XRAYED&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),i&k.SELECTED&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),i&k.CLIPPABLE&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),i&k.EDGES&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),i&k.PICKABLE&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),i&k.CULLED&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),s&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++);const t=!0;this._setFlags(e,i,s,t),this._setFlags2(e,i,t)}flushInitFlags(){this._setDeferredFlags(),this._setDeferredFlags2()}setVisible(e,i,s){if(!this._finalized)throw"Not finalized";i&k.VISIBLE?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,i,s)}setHighlighted(e,i,s){if(!this._finalized)throw"Not finalized";i&k.HIGHLIGHTED?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,i,s)}setXRayed(e,i,s){if(!this._finalized)throw"Not finalized";i&k.XRAYED?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,i,s)}setSelected(e,i,s){if(!this._finalized)throw"Not finalized";i&k.SELECTED?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,i,s)}setEdges(e,i,s){if(!this._finalized)throw"Not finalized";i&k.EDGES?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,i,s)}setClippable(e,i){if(!this._finalized)throw"Not finalized";i&k.CLIPPABLE?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(e,i)}_beginDeferredFlags(){this._deferredSetFlagsActive=!0}_uploadDeferredFlags(){if(this._deferredSetFlagsActive=!1,!this._deferredSetFlagsDirty)return;this._deferredSetFlagsDirty=!1;const e=this.model.scene.canvas.gl,i=this._dtxState;e.bindTexture(e.TEXTURE_2D,i.texturePerObjectColorsAndFlags._texture),e.texSubImage2D(e.TEXTURE_2D,0,0,0,i.texturePerObjectColorsAndFlags._textureWidth,i.texturePerObjectColorsAndFlags._textureHeight,e.RGBA_INTEGER,e.UNSIGNED_BYTE,i.texturePerObjectColorsAndFlags._textureData)}setCulled(e,i,s){if(!this._finalized)throw"Not finalized";i&k.CULLED?(this._numCulledLayerPortions+=this._portionToSubPortionsMap[e].length,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions-=this._portionToSubPortionsMap[e].length,this.model.numCulledLayerPortions--),this._setFlags(e,i,s)}setCollidable(e,i){if(!this._finalized)throw"Not finalized"}setPickable(e,i,s){if(!this._finalized)throw"Not finalized";i&k.PICKABLE?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,i,s)}setColor(e,i){const s=this._portionToSubPortionsMap[e];for(let t=0,o=s.length;t<o;t++)this._subPortionSetColor(s[t],i)}_subPortionSetColor(e,i){if(!this._finalized)throw"Not finalized";const s=this._dtxState,t=this.model.scene.canvas.gl;if(Ht[0]=i[0],Ht[1]=i[1],Ht[2]=i[2],Ht[3]=i[3],s.texturePerObjectColorsAndFlags._textureData.set(Ht,e*32),this._deferredSetFlagsActive){console.info("_subPortionSetColor defer"),this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=Tr&&this._beginDeferredFlags(),console.info("_subPortionSetColor write through"),t.bindTexture(t.TEXTURE_2D,s.texturePerObjectColorsAndFlags._texture),t.texSubImage2D(t.TEXTURE_2D,0,e%512*8,Math.floor(e/512),1,1,t.RGBA_INTEGER,t.UNSIGNED_BYTE,Ht)}setTransparent(e,i,s){s?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,i,s)}_setFlags(e,i,s,t=!1){const o=this._portionToSubPortionsMap[e];for(let n=0,a=o.length;n<a;n++)this._subPortionSetFlags(o[n],i,s,t)}_subPortionSetFlags(e,i,s,t=!1){if(!this._finalized)throw"Not finalized";const o=!!(i&k.VISIBLE),n=!!(i&k.XRAYED),a=!!(i&k.HIGHLIGHTED),A=!!(i&k.SELECTED),l=!!(i&k.EDGES),h=!!(i&k.PICKABLE),d=!!(i&k.CULLED);let f;!o||d||n||a&&!this.model.scene.highlightMaterial.glowThrough||A&&!this.model.scene.selectedMaterial.glowThrough?f=U.NOT_RENDERED:s?f=U.COLOR_TRANSPARENT:f=U.COLOR_OPAQUE;let m;!o||d?m=U.NOT_RENDERED:A?m=U.SILHOUETTE_SELECTED:a?m=U.SILHOUETTE_HIGHLIGHTED:n?m=U.SILHOUETTE_XRAYED:m=U.NOT_RENDERED;let _=0;!o||d?_=U.NOT_RENDERED:A?_=U.EDGES_SELECTED:a?_=U.EDGES_HIGHLIGHTED:n?_=U.EDGES_XRAYED:l?s?_=U.EDGES_COLOR_TRANSPARENT:_=U.EDGES_COLOR_OPAQUE:_=U.NOT_RENDERED;let u=o&&!d&&h?U.PICK:U.NOT_RENDERED;const P=this._dtxState,y=this.model.scene.canvas.gl;if(Ht[0]=f,Ht[1]=m,Ht[2]=_,Ht[3]=u,P.texturePerObjectColorsAndFlags._textureData.set(Ht,e*32+8),this._deferredSetFlagsActive||t){this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=Tr&&this._beginDeferredFlags(),y.bindTexture(y.TEXTURE_2D,P.texturePerObjectColorsAndFlags._texture),y.texSubImage2D(y.TEXTURE_2D,0,e%512*8+2,Math.floor(e/512),1,1,y.RGBA_INTEGER,y.UNSIGNED_BYTE,Ht)}_setDeferredFlags(){}_setFlags2(e,i,s=!1){const t=this._portionToSubPortionsMap[e];for(let o=0,n=t.length;o<n;o++)this._subPortionSetFlags2(t[o],i,s)}_subPortionSetFlags2(e,i,s=!1){if(!this._finalized)throw"Not finalized";const t=i&k.CLIPPABLE?255:0,o=this._dtxState,n=this.model.scene.canvas.gl;if(Ht[0]=t,Ht[1]=0,Ht[2]=1,Ht[3]=2,o.texturePerObjectColorsAndFlags._textureData.set(Ht,e*32+12),this._deferredSetFlagsActive||s){this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=Tr&&this._beginDeferredFlags(),n.bindTexture(n.TEXTURE_2D,o.texturePerObjectColorsAndFlags._texture),n.texSubImage2D(n.TEXTURE_2D,0,e%512*8+3,Math.floor(e/512),1,1,n.RGBA_INTEGER,n.UNSIGNED_BYTE,Ht)}_setDeferredFlags2(){}setOffset(e,i){const s=this._portionToSubPortionsMap[e];for(let t=0,o=s.length;t<o;t++)this._subPortionSetOffset(s[t],i)}_subPortionSetOffset(e,i){if(!this._finalized)throw"Not finalized";const s=this._dtxState,t=this.model.scene.canvas.gl;if(Dr[0]=i[0],Dr[1]=i[1],Dr[2]=i[2],s.texturePerObjectOffsets._textureData.set(Dr,e*3),this._deferredSetFlagsActive){this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=Tr&&this._beginDeferredFlags(),t.bindTexture(t.TEXTURE_2D,s.texturePerObjectOffsets._texture),t.texSubImage2D(t.TEXTURE_2D,0,0,e,1,1,t.RGB,t.FLOAT,Dr)}setMatrix(e,i){const s=this._portionToSubPortionsMap[e];for(let t=0,o=s.length;t<o;t++)this._subPortionSetMatrix(s[t],i)}_subPortionSetMatrix(e,i){if(!this._finalized)throw"Not finalized";const s=this._dtxState,t=this.model.scene.canvas.gl;if(Ka.set(i),s.texturePerObjectInstanceMatrices._textureData.set(Ka,e*16),this._deferredSetFlagsActive){this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=Tr&&this._beginDeferredFlags(),t.bindTexture(t.TEXTURE_2D,s.texturePerObjectInstanceMatrices._texture),t.texSubImage2D(t.TEXTURE_2D,0,e%512*4,Math.floor(e/512),4,1,t.RGBA,t.FLOAT,Ka)}drawColorOpaque(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,i),i.withSAO&&this.model.saoEnabled?this._renderers.colorRendererWithSAO&&this._renderers.colorRendererWithSAO.drawLayer(i,this,U.COLOR_OPAQUE):this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(i,this,U.COLOR_OPAQUE))}_updateBackfaceCull(e,i){const s=this.model.backfaces||e.sectioned;if(i.backfaces!==s){const t=i.gl;s?t.disable(t.CULL_FACE):t.enable(t.CULL_FACE),i.backfaces=s}}drawColorTransparent(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===0||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,i),this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(i,this,U.COLOR_TRANSPARENT))}drawDepth(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,i),this._renderers.depthRenderer&&this._renderers.depthRenderer.drawLayer(i,this,U.COLOR_OPAQUE))}drawNormals(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,i),this._renderers.normalsRenderer&&this._renderers.normalsRenderer.drawLayer(i,this,U.COLOR_OPAQUE))}drawSilhouetteXRayed(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||(this._updateBackfaceCull(e,i),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(i,this,U.SILHOUETTE_XRAYED))}drawSilhouetteHighlighted(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||(this._updateBackfaceCull(e,i),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(i,this,U.SILHOUETTE_HIGHLIGHTED))}drawSilhouetteSelected(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||(this._updateBackfaceCull(e,i),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(i,this,U.SILHOUETTE_SELECTED))}drawEdgesColorOpaque(e,i){if(this.model.scene.logarithmicDepthBufferEnabled){this.model.scene._loggedWarning||(console.log("Edge enhancement for SceneModel data texture layers currently disabled with logarithmic depth buffer"),this.model.scene._loggedWarning=!0);return}this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numEdgesLayerPortions===0||this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(i,this,U.EDGES_COLOR_OPAQUE)}drawEdgesColorTransparent(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numEdgesLayerPortions===0||this._numTransparentLayerPortions===0||this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(i,this,U.EDGES_COLOR_TRANSPARENT)}drawEdgesHighlighted(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(i,this,U.EDGES_HIGHLIGHTED)}drawEdgesSelected(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(i,this,U.EDGES_SELECTED)}drawEdgesXRayed(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(i,this,U.EDGES_XRAYED)}drawOcclusion(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,i),this._renderers.occlusionRenderer&&this._renderers.occlusionRenderer.drawLayer(i,this,U.COLOR_OPAQUE))}drawShadow(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,i),this._renderers.shadowRenderer&&this._renderers.shadowRenderer.drawLayer(i,this,U.COLOR_OPAQUE))}setPickMatrices(e,i){}drawPickMesh(e,i){this._numVisibleLayerPortions!==0&&(this._updateBackfaceCull(e,i),this._renderers.pickMeshRenderer&&this._renderers.pickMeshRenderer.drawLayer(i,this,U.PICK))}drawPickDepths(e,i){this._numVisibleLayerPortions!==0&&(this._updateBackfaceCull(e,i),this._renderers.pickDepthRenderer&&this._renderers.pickDepthRenderer.drawLayer(i,this,U.PICK))}drawSnapInit(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,i),this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(i,this,U.PICK))}drawSnap(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,i),this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(i,this,U.PICK))}drawPickNormals(e,i){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,i),this._renderers.pickNormalsRenderer&&this._renderers.pickNormalsRenderer.drawLayer(i,this,U.PICK))}destroy(){if(this._destroyed)return;const e=this._state;e.metallicRoughnessBuf&&(e.metallicRoughnessBuf.destroy(),e.metallicRoughnessBuf=null),this.model.scene.off(this._onSceneRendering),e.destroy(),this._destroyed=!0}}class Wh{constructor(e){this.id=e.id,this.colorTexture=e.colorTexture,this.metallicRoughnessTexture=e.metallicRoughnessTexture,this.normalsTexture=e.normalsTexture,this.emissiveTexture=e.emissiveTexture,this.occlusionTexture=e.occlusionTexture}destroy(){}}class ks{constructor(e){this.id=e.id,this.texture=e.texture}destroy(){this.texture&&(this.texture.destroy(),this.texture=null)}}const Xh={enabled:!1,files:{},add:function(r,e){this.enabled!==!1&&(this.files[r]=e)},get:function(r){if(this.enabled!==!1)return this.files[r]},remove:function(r){delete this.files[r]},clear:function(){this.files={}}};class dy{constructor(e,i,s){this.isLoading=!1,this.itemsLoaded=0,this.itemsTotal=0,this.urlModifier=void 0,this.handlers=[],this.onStart=void 0,this.onLoad=e,this.onProgress=i,this.onError=s}itemStart(e){this.itemsTotal++,this.isLoading===!1&&this.onStart!==void 0&&this.onStart(e,this.itemsLoaded,this.itemsTotal),this.isLoading=!0}itemEnd(e){this.itemsLoaded++,this.onProgress!==void 0&&this.onProgress(e,this.itemsLoaded,this.itemsTotal),this.itemsLoaded===this.itemsTotal&&(this.isLoading=!1,this.onLoad!==void 0&&this.onLoad())}itemError(e){this.onError!==void 0&&this.onError(e)}resolveURL(e){return this.urlModifier?this.urlModifier(e):e}setURLModifier(e){return this.urlModifier=e,this}addHandler(e,i){return this.handlers.push(e,i),this}removeHandler(e){const i=this.handlers.indexOf(e);return i!==-1&&this.handlers.splice(i,2),this}getHandler(e){for(let i=0,s=this.handlers.length;i<s;i+=2){const t=this.handlers[i],o=this.handlers[i+1];if(t.global&&(t.lastIndex=0),t.test(e))return o}return null}}const py=new dy;class fy{constructor(e){this.manager=e!==void 0?e:py,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(e,i){const s=this;return new Promise(function(t,o){s.load(e,t,i,o)})}parse(){}setCrossOrigin(e){return this.crossOrigin=e,this}setWithCredentials(e){return this.withCredentials=e,this}setPath(e){return this.path=e,this}setResourcePath(e){return this.resourcePath=e,this}setRequestHeader(e){return this.requestHeader=e,this}}const Vi={};class Yh extends fy{constructor(e){super(e)}load(e,i,s,t){e===void 0&&(e=""),this.path!==void 0&&(e=this.path+e),e=this.manager.resolveURL(e);const o=Xh.get(e);if(o!==void 0)return this.manager.itemStart(e),xt.scheduleTask(()=>{i&&i(o),this.manager.itemEnd(e)},0),o;if(Vi[e]!==void 0){Vi[e].push({onLoad:i,onProgress:s,onError:t});return}Vi[e]=[],Vi[e].push({onLoad:i,onProgress:s,onError:t});const n=new Request(e,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin"}),a=this.mimeType,A=this.responseType;fetch(n).then(l=>{if(l.status===200||l.status===0){if(l.status===0&&console.warn("FileLoader: HTTP Status 0 received."),typeof ReadableStream>"u"||l.body.getReader===void 0)return l;const h=Vi[e],d=l.body.getReader(),f=l.headers.get("Content-Length"),m=f?parseInt(f):0,_=m!==0;let u=0;const P=new ReadableStream({start(y){x();function x(){d.read().then(({done:B,value:v})=>{if(B)y.close();else{u+=v.byteLength;const w=new ProgressEvent("progress",{lengthComputable:_,loaded:u,total:m});for(let C=0,I=h.length;C<I;C++){const E=h[C];E.onProgress&&E.onProgress(w)}y.enqueue(v),x()}})}}});return new Response(P)}else throw Error(`fetch for "${l.url}" responded with ${l.status}: ${l.statusText}`)}).then(l=>{switch(A){case"arraybuffer":return l.arrayBuffer();case"blob":return l.blob();case"document":return l.text().then(h=>new DOMParser().parseFromString(h,a));case"json":return l.json();default:if(a===void 0)return l.text();{const d=/charset="?([^;"\s]*)"?/i.exec(a),f=d&&d[1]?d[1].toLowerCase():void 0,m=new TextDecoder(f);return l.arrayBuffer().then(_=>m.decode(_))}}}).then(l=>{Xh.add(e,l);const h=Vi[e];delete Vi[e];for(let d=0,f=h.length;d<f;d++){const m=h[d];m.onLoad&&m.onLoad(l)}}).catch(l=>{const h=Vi[e];if(h===void 0)throw this.manager.itemError(e),l;delete Vi[e];for(let d=0,f=h.length;d<f;d++){const m=h[d];m.onError&&m.onError(l)}this.manager.itemError(e)}).finally(()=>{this.manager.itemEnd(e)}),this.manager.itemStart(e)}setResponseType(e){return this.responseType=e,this}setMimeType(e){return this.mimeType=e,this}}class gy{constructor(e=4){this.pool=e,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0}_initWorker(e){if(!this.workers[e]){const i=this.workerCreator();i.addEventListener("message",this._onMessage.bind(this,e)),this.workers[e]=i}}_getIdleWorker(){for(let e=0;e<this.pool;e++)if(!(this.workerStatus&1<<e))return e;return-1}_onMessage(e,i){const s=this.workersResolve[e];if(s&&s(i),this.queue.length){const{resolve:t,msg:o,transfer:n}=this.queue.shift();this.workersResolve[e]=t,this.workers[e].postMessage(o,n)}else this.workerStatus^=1<<e}setWorkerCreator(e){this.workerCreator=e}setWorkerLimit(e){this.pool=e}postMessage(e,i){return new Promise(s=>{const t=this._getIdleWorker();t!==-1?(this._initWorker(t),this.workerStatus|=1<<t,this.workersResolve[t]=s,this.workers[t].postMessage(e,i)):this.queue.push({resolve:s,msg:e,transfer:i})})}destroy(){this.workers.forEach(e=>e.terminate()),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}}const my=2,_y=1;let Wa=0;class Di{constructor({viewer:e,transcoderPath:i,workerLimit:s}){this._transcoderPath=i||"https://cdn.jsdelivr.net/npm/@xeokit/xeokit-sdk/dist/basis/",this._transcoderBinary=null,this._transcoderPending=null,this._workerPool=new gy,this._workerSourceURL="",s&&this._workerPool.setWorkerLimit(s);const t=e.capabilities;this._workerConfig={astcSupported:t.astcSupported,etc1Supported:t.etc1Supported,etc2Supported:t.etc2Supported,dxtSupported:t.dxtSupported,bptcSupported:t.bptcSupported,pvrtcSupported:t.pvrtcSupported},this._supportedFileTypes=["xkt2"]}_init(){if(!this._transcoderPending){const e=new Yh;e.setPath(this._transcoderPath),e.setWithCredentials(this.withCredentials);const i=e.loadAsync("basis_transcoder.js"),s=new Yh;s.setPath(this._transcoderPath),s.setResponseType("arraybuffer"),s.setWithCredentials(this.withCredentials);const t=s.loadAsync("basis_transcoder.wasm");this._transcoderPending=Promise.all([i,t]).then(([o,n])=>{const a=Di.BasisWorker.toString(),A=["/* constants */","let _EngineFormat = "+JSON.stringify(Di.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(Di.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(Di.BasisFormat),"/* basis_transcoder.js */",o,"/* worker */",a.substring(a.indexOf("{")+1,a.lastIndexOf("}"))].join(`
`);this._workerSourceURL=URL.createObjectURL(new Blob([A])),this._transcoderBinary=n,this._workerPool.setWorkerCreator(()=>{const l=new Worker(this._workerSourceURL),h=this._transcoderBinary.slice(0);return l.postMessage({type:"init",config:this._workerConfig,transcoderBinary:h},[h]),l})}),Wa>0&&console.warn("KTX2TextureTranscoder: Multiple active KTX2TextureTranscoder may cause performance issues. Use a single KTX2TextureTranscoder instance, or call .dispose() on old instances."),Wa++}return this._transcoderPending}transcode(e,i,s={}){return new Promise((t,o)=>{const n=s;this._init().then(()=>this._workerPool.postMessage({type:"transcode",buffers:e,taskConfig:n},e)).then(a=>{const A=a.data,{mipmaps:l,width:h,height:d,format:f,type:m,error:_,dfdTransferFn:u,dfdFlags:P}=A;if(m==="error")return o(_);i.setCompressedData({mipmaps:l,props:{format:f,minFilter:l.length===1?ys:Zr,magFilter:l.length===1?ys:Zr,encoding:u===my?Ct:nr,premultiplyAlpha:!!(P&_y)}}),t()})})}destroy(){URL.revokeObjectURL(this._workerSourceURL),this._workerPool.destroy(),Wa--}}Di.BasisFormat={ETC1S:0,UASTC_4x4:1};Di.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16};Di.EngineFormat={RGBAFormat:Fn,RGBA_ASTC_4x4_Format:HA,RGBA_BPTC_Format:VA,RGBA_ETC2_EAC_Format:QA,RGBA_PVRTC_4BPPV1_Format:kA,RGBA_S3TC_DXT5_Format:Pn,RGB_ETC1_Format:vp,RGB_ETC2_Format:NA,RGB_PVRTC_4BPPV1_Format:OA,RGB_S3TC_DXT1_Format:vn};Di.BasisWorker=function(){let r,e,i;const s=_EngineFormat,t=_TranscoderFormat,o=_BasisFormat;self.addEventListener("message",function(m){const _=m.data;switch(_.type){case"init":r=_.config,n(_.transcoderBinary);break;case"transcode":e.then(()=>{try{const{width:u,height:P,hasAlpha:y,mipmaps:x,format:B,dfdTransferFn:v,dfdFlags:w}=a(_.buffers[0]),C=[];for(let I=0;I<x.length;++I)C.push(x[I].data.buffer);self.postMessage({type:"transcode",id:_.id,width:u,height:P,hasAlpha:y,mipmaps:x,format:B,dfdTransferFn:v,dfdFlags:w},C)}catch(u){console.error(`[KTX2TextureTranscoder.BasisWorker]: ${u}`),self.postMessage({type:"error",id:_.id,error:u.message})}});break}});function n(m){e=new Promise(_=>{i={wasmBinary:m,onRuntimeInitialized:_},BASIS(i)}).then(()=>{i.initializeBasis(),i.KTX2File===void 0&&console.warn("KTX2TextureTranscoder: Please update Basis Universal transcoder.")})}function a(m){const _=new i.KTX2File(new Uint8Array(m));function u(){_.close(),_.delete()}if(!_.isValid())throw u(),new Error("KTX2TextureTranscoder: Invalid or unsupported .ktx2 file");const P=_.isUASTC()?o.UASTC_4x4:o.ETC1S,y=_.getWidth(),x=_.getHeight(),B=_.getLevels(),v=_.getHasAlpha(),w=_.getDFDTransferFunc(),C=_.getDFDFlags(),{transcoderFormat:I,engineFormat:E}=d(P,y,x,v);if(!y||!x||!B)throw u(),new Error("KTX2TextureTranscoder: Invalid texture");if(!_.startTranscoding())throw u(),new Error("KTX2TextureTranscoder: .startTranscoding failed");const S=[];for(let R=0;R<B;R++){const D=_.getImageLevelInfo(R,0,0),K=D.origWidth,G=D.origHeight,z=new Uint8Array(_.getImageTranscodedSizeInBytes(R,0,0,I));if(!_.transcodeImage(z,R,0,0,I,0,-1,-1))throw u(),new Error("KTX2TextureTranscoder: .transcodeImage failed.");S.push({data:z,width:K,height:G})}return u(),{width:y,height:x,hasAlpha:v,mipmaps:S,format:E,dfdTransferFn:w,dfdFlags:C}}const A=[{if:"astcSupported",basisFormat:[o.UASTC_4x4],transcoderFormat:[t.ASTC_4x4,t.ASTC_4x4],engineFormat:[s.RGBA_ASTC_4x4_Format,s.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[t.BC7_M5,t.BC7_M5],engineFormat:[s.RGBA_BPTC_Format,s.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[t.BC1,t.BC3],engineFormat:[s.RGB_S3TC_DXT1_Format,s.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[t.ETC1,t.ETC2],engineFormat:[s.RGB_ETC2_Format,s.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[t.ETC1],engineFormat:[s.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[t.PVRTC1_4_RGB,t.PVRTC1_4_RGBA],engineFormat:[s.RGB_PVRTC_4BPPV1_Format,s.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],l=A.sort(function(m,_){return m.priorityETC1S-_.priorityETC1S}),h=A.sort(function(m,_){return m.priorityUASTC-_.priorityUASTC});function d(m,_,u,P){let y,x;const B=m===o.ETC1S?l:h;for(let v=0;v<B.length;v++){const w=B[v];if(r[w.if]&&w.basisFormat.includes(m)&&!(P&&w.transcoderFormat.length<2)&&!(w.needsPowerOfTwo&&!(f(_)&&f(u))))return y=w.transcoderFormat[P?1:0],x=w.engineFormat[P?1:0],{transcoderFormat:y,engineFormat:x}}return console.warn("KTX2TextureTranscoder: No suitable compressed texture format found. Decoding to RGBA32."),y=t.RGBA32,x=s.RGBAFormat,{transcoderFormat:y,engineFormat:x}}function f(m){return m<=2?!0:(m&m-1)===0&&m!==0}};const Xa={};function vy(r){const e=r.scene.id;let i=Xa[e];return i||(i=new Di({viewer:r}),Xa[e]=i,r.scene.on("destroyed",()=>{delete Xa[e],i.destroy()})),i}/**
 * @author https://github.com/tmarti, with support from https://tribia.com/
 * @license MIT
 *
 * This file takes a geometry given by { positionsCompressed, indices }, and returns
 * equivalent { positionsCompressed, indices } arrays but which only contain unique
 * positionsCompressed.
 *
 * The time is O(N logN) with the number of positionsCompressed due to a pre-sorting
 * step, but is much more GC-friendly and actually faster than the classic O(N)
 * approach based in keeping a hash-based LUT to identify unique positionsCompressed.
 */let Sn=null;function Ya(r,e){let i;for(let s=0;s<3;s++)if((i=Sn[r*3+s]-Sn[e*3+s])!==0)return i;return 0}let ir=null;function Py(r){if(!(ir!==null&&ir.length>=r)){ir=new Uint32Array(r);for(let e=0;e<r;e++)ir[e]=e}}function By(r){const e=r.positionsCompressed,i=r.indices,s=r.edgeIndices;Py(e.length/3);const t=ir.slice(0,e.length/3),o=ir.slice(0,e.length/3);Sn=e,t.sort(Ya);let n=0;o[t[0]]=0;for(let d=1,f=t.length;d<f;d++)Ya(t[d],t[d-1])!==0&&n++,o[t[d]]=n;const a=n+1,A=new Uint16Array(a*3);n=0,A[n*3+0]=e[t[0]*3+0],A[n*3+1]=e[t[0]*3+1],A[n*3+2]=e[t[0]*3+2];for(let d=1,f=t.length;d<f;d++)Ya(t[d],t[d-1])!==0&&(n++,A[n*3+0]=e[t[d]*3+0],A[n*3+1]=e[t[d]*3+1],A[n*3+2]=e[t[d]*3+2]),o[t[d]]=n;Sn=null;const l=new Uint32Array(i.length);for(let d=0,f=i.length;d<f;d++)l[d]=o[i[d]];const h=new Uint32Array(s.length);for(let d=0,f=s.length;d<f;d++)h[d]=o[s[d]];return[A,l,h]}/**
 * @author https://github.com/tmarti, with support from https://tribia.com/
 * @license MIT
 **/const $h=8;let ss=null;function yy(r,e){const i=r*3,s=e*3;let t,o,n,a,A,l;const h=Math.min(t=ss[i],o=ss[i+1],n=ss[i+2]),d=Math.min(a=ss[s],A=ss[s+1],l=ss[s+2]);if(h!==d)return h-d;const f=Math.max(t,o,n),m=Math.max(a,A,l);return f!==m?f-m:0}function xy(r,e){const i=new Int32Array(r.length/3);for(let t=0,o=i.length;t<o;t++)i[t]=t;ss=new Int32Array(r.length);for(let t=0,o=r.length;t<o;t++)ss[t]=r[t]>>e;i.sort(yy);const s=new Int32Array(r.length);for(let t=0,o=i.length;t<o;t++)s[t*3+0]=r[i[t]*3+0],s[t*3+1]=r[i[t]*3+1],s[t*3+2]=r[i[t]*3+2];return s}let Vr=null;function wy(r,e){let i=Vr[r*2]-Vr[e*2];return i!==0?i:Vr[r*2+1]-Vr[e*2+1]}function by(r){if((r||[]).length===0)return[];let e=new Int32Array(r.length/2);for(let s=0,t=e.length;s<t;s++)e[s]=s;for(let s=0,t=r.length;s<t;s+=2)if(r[s]>r[s+1]){let o=r[s];r[s]=r[s+1],r[s+1]=o}Vr=new Int32Array(r),e.sort(wy);const i=new Int32Array(r.length);for(let s=0,t=e.length;s<t;s++)i[s*2+0]=r[e[s]*2+0],i[s*2+1]=r[e[s]*2+1];return i}function Cy(r,e,i=!1){const s=r.positionsCompressed||[],t=xy(r.indices||[],e),o=by(r.edgeIndices||[]);function n(x,B){if(x>B){let I=x;x=B,B=I}function v(I,E){return I!==x?x-I:E!==B?B-E:0}let w=0,C=(o.length>>1)-1;for(;w<=C;){const I=C+w>>1,E=v(o[I*2],o[I*2+1]);if(E>0)w=I+1;else if(E<0)C=I-1;else return I}return-w-1}const a=new Int32Array(o.length/2);a.fill(0);const A=s.length/3;if(A>(1<<e)*$h)return[r];const l=new Int32Array(A);l.fill(-1);const h=[];function d(){l.fill(-1);const x={positionsCompressed:[],indices:[],edgeIndices:[],maxNumPositions:(1<<e)-e,numPositions:0,bucketNumber:h.length};return h.push(x),x}let f=d();for(let x=0,B=t.length;x<B;x+=3){let v=0;const w=t[x],C=t[x+1],I=t[x+2];if(l[w]===-1&&v++,l[C]===-1&&v++,l[I]===-1&&v++,v+f.numPositions>f.maxNumPositions&&(f=d()),f.bucketNumber>$h)return[r];l[w]===-1&&(l[w]=f.numPositions++,f.positionsCompressed.push(s[w*3]),f.positionsCompressed.push(s[w*3+1]),f.positionsCompressed.push(s[w*3+2])),l[C]===-1&&(l[C]=f.numPositions++,f.positionsCompressed.push(s[C*3]),f.positionsCompressed.push(s[C*3+1]),f.positionsCompressed.push(s[C*3+2])),l[I]===-1&&(l[I]=f.numPositions++,f.positionsCompressed.push(s[I*3]),f.positionsCompressed.push(s[I*3+1]),f.positionsCompressed.push(s[I*3+2])),f.indices.push(l[w]),f.indices.push(l[C]),f.indices.push(l[I]);let E;(E=n(w,C))>=0&&a[E]===0&&(a[E]=1,f.edgeIndices.push(l[o[E*2]]),f.edgeIndices.push(l[o[E*2+1]])),(E=n(w,I))>=0&&a[E]===0&&(a[E]=1,f.edgeIndices.push(l[o[E*2]]),f.edgeIndices.push(l[o[E*2+1]])),(E=n(C,I))>=0&&a[E]===0&&(a[E]=1,f.edgeIndices.push(l[o[E*2]]),f.edgeIndices.push(l[o[E*2+1]]))}const m=e/8*2,_=e/8,u=s.length*2+(t.length+o.length)*m;let P=0,y=-s.length/3;return h.forEach(x=>{P+=x.positionsCompressed.length*2+(x.indices.length+x.edgeIndices.length)*_,y+=x.positionsCompressed.length/3}),P>u?[r]:(i&&Ey(h,r),h)}function Ey(r,e){const i={};let s=0;r.forEach(t=>{const o=t.indices,n=t.edgeIndices,a=t.positionsCompressed;for(let A=0,l=o.length;A<l;A+=3){const h=a[o[A]*3]+"_"+a[o[A]*3+1]+"_"+a[o[A]*3+2]+"/"+a[o[A+1]*3]+"_"+a[o[A+1]*3+1]+"_"+a[o[A+1]*3+2]+"/"+a[o[A+2]*3]+"_"+a[o[A+2]*3+1]+"_"+a[o[A+2]*3+2];i[h]=!0}s+=t.edgeIndices.length/2;for(let A=0,l=n.length;A<l;A+=2)a[n[A]*3]+""+a[n[A]*3+1]+a[n[A]*3+2]+a[n[A+1]*3]+a[n[A+1]*3+1]+a[n[A+1]*3+2]});{const t=e.indices;e.edgeIndices;const o=e.positionsCompressed;for(let n=0,a=t.length;n<a;n+=3){const A=o[t[n]*3]+"_"+o[t[n]*3+1]+"_"+o[t[n]*3+2]+"/"+o[t[n+1]*3]+"_"+o[t[n+1]*3+1]+"_"+o[t[n+1]*3+2]+"/"+o[t[n+2]*3]+"_"+o[t[n+2]*3+1]+"_"+o[t[n+2]*3+2];if(!(A in i))throw console.log("Not found "+A),"Ohhhh!"}}}const Si=c.vec4(4),Rr=c.vec4(),Zh=c.vec4(),Iy=c.vec3([1,0,0]),Fy=c.vec3([0,1,0]),My=c.vec3([0,0,1]);c.vec3(3);c.vec3(3);const Sy=c.identityMat4();class Ty{constructor(e){this._model=e.model,this.id=e.id,this._parentTransform=e.parent,this._childTransforms=[],this._meshes=[],this._scale=new Float32Array([1,1,1]),this._quaternion=c.identityQuaternion(new Float32Array(4)),this._rotation=new Float32Array(3),this._position=new Float32Array(3),this._localMatrix=c.identityMat4(new Float32Array(16)),this._worldMatrix=c.identityMat4(new Float32Array(16)),this._localMatrixDirty=!0,this._worldMatrixDirty=!0,e.matrix?this.matrix=e.matrix:(this.scale=e.scale,this.position=e.position,e.quaternion||(this.rotation=e.rotation)),e.parent&&e.parent._addChildTransform(this)}_addChildTransform(e){this._childTransforms.push(e),e._parentTransform=this,e._transformDirty(),e._setSubtreeAABBsDirty(this)}_addMesh(e){this._meshes.push(e),e.transform=this}get parentTransform(){return this._parentTransform}get meshes(){return this._meshes}set position(e){this._position.set(e||[0,0,0]),this._setLocalMatrixDirty(),this._model.glRedraw()}get position(){return this._position}set rotation(e){this._rotation.set(e||[0,0,0]),c.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._model.glRedraw()}get rotation(){return this._rotation}set quaternion(e){this._quaternion.set(e||[0,0,0,1]),c.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._model.glRedraw()}get quaternion(){return this._quaternion}set scale(e){this._scale.set(e||[1,1,1]),this._setLocalMatrixDirty(),this._model.glRedraw()}get scale(){return this._scale}set matrix(e){this._localMatrix||(this._localMatrix=c.identityMat4()),this._localMatrix.set(e||Sy),c.decomposeMat4(this._localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._transformDirty(),this._model.glRedraw()}get matrix(){return this._localMatrixDirty&&(this._localMatrix||(this._localMatrix=c.identityMat4()),c.composeMat4(this._position,this._quaternion,this._scale,this._localMatrix),this._localMatrixDirty=!1),this._localMatrix}get worldMatrix(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix}rotate(e,i){return Si[0]=e[0],Si[1]=e[1],Si[2]=e[2],Si[3]=i*c.DEGTORAD,c.angleAxisToQuaternion(Si,Rr),c.mulQuaternions(this.quaternion,Rr,Zh),this.quaternion=Zh,this._setLocalMatrixDirty(),this._model.glRedraw(),this}rotateOnWorldAxis(e,i){return Si[0]=e[0],Si[1]=e[1],Si[2]=e[2],Si[3]=i*c.DEGTORAD,c.angleAxisToQuaternion(Si,Rr),c.mulQuaternions(Rr,this.quaternion,Rr),this}rotateX(e){return this.rotate(Iy,e)}rotateY(e){return this.rotate(Fy,e)}rotateZ(e){return this.rotate(My,e)}translate(e){return this._position[0]+=e[0],this._position[1]+=e[1],this._position[2]+=e[2],this._setLocalMatrixDirty(),this._model.glRedraw(),this}translateX(e){return this._position[0]+=e,this._setLocalMatrixDirty(),this._model.glRedraw(),this}translateY(e){return this._position[1]+=e,this._setLocalMatrixDirty(),this._model.glRedraw(),this}translateZ(e){return this._position[2]+=e,this._setLocalMatrixDirty(),this._model.glRedraw(),this}_setLocalMatrixDirty(){this._localMatrixDirty=!0,this._transformDirty()}_transformDirty(){this._worldMatrixDirty=!0;for(let e=0,i=this._childTransforms.length;e<i;e++){const s=this._childTransforms[e];if(s._transformDirty(),s._meshes&&s._meshes.length>0){const t=s._meshes;for(let o=0,n=t.length;o<n;o++)t[o]._transformDirty()}}if(this._meshes&&this._meshes.length>0){const e=this._meshes;for(let i=0,s=e.length;i<s;i++)e[i]._transformDirty()}}_buildWorldMatrix(){const e=this.matrix;if(this._parentTransform)c.mulMat4(this._parentTransform.worldMatrix,e,this._worldMatrix);else for(let i=0,s=e.length;i<s;i++)this._worldMatrix[i]=e[i];this._worldMatrixDirty=!1}_setSubtreeAABBsDirty(e){if(e._aabbDirty=!0,e._childTransforms)for(let i=0,s=e._childTransforms.length;i<s;i++)this._setSubtreeAABBsDirty(e._childTransforms[i])}}const qh=c.vec3(),ji=c.OBB3(),jo=c.vec4(),Jh=c.vec3([1,1,1]),eu=c.vec3([0,0,0]);c.vec3([0,0,0]);const tu=c.identityQuaternion(),Dy=c.identityMat4(),$a="defaultColorTexture",Za="defaultMetalRoughTexture",qa="defaultNormalsTexture",Ja="defaultEmissiveTexture",eA="defaultOcclusionTexture",iu="defaultTextureSet",tA=new Uint8Array([255,255,255]),Lr=0,Ur=1,Ns=2;class Ry extends Et{constructor(e,i={}){super(e,i),this._dtxEnabled=this.scene.dtxEnabled&&i.dtxEnabled!==!1,this._enableVertexWelding=!1,this._enableIndexBucketing=!1,this._vboBatchingLayerScratchMemory=E0(),this._textureTranscoder=i.textureTranscoder||vy(this.scene.viewer),this._maxGeometryBatchSize=i.maxGeometryBatchSize,this._aabb=c.collapseAABB3(),this._aabbDirty=!0,this._quantizationRanges={},this._vboInstancingLayers={},this._vboBatchingLayers={},this._dtxLayers={},this._meshList=[],this.layerList=[],this._entityList=[],this._geometries={},this._dtxBuckets={},this._textures={},this._textureSets={},this._transforms={},this._meshes={},this._unusedMeshes={},this._entities={},this.renderFlags=new bp,this.numGeometries=0,this.numPortions=0,this.numVisibleLayerPortions=0,this.numTransparentLayerPortions=0,this.numXRayedLayerPortions=0,this.numHighlightedLayerPortions=0,this.numSelectedLayerPortions=0,this.numEdgesLayerPortions=0,this.numPickableLayerPortions=0,this.numClippableLayerPortions=0,this.numCulledLayerPortions=0,this.numEntities=0,this._numTriangles=0,this._numLines=0,this._numPoints=0,this._edgeThreshold=i.edgeThreshold||10,this._origin=c.vec3(i.origin||[0,0,0]),this._position=c.vec3(i.position||[0,0,0]),this._rotation=c.vec3(i.rotation||[0,0,0]),this._quaternion=c.vec4(i.quaternion||[0,0,0,1]),this._conjugateQuaternion=c.vec4(i.quaternion||[0,0,0,1]),i.rotation&&c.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._scale=c.vec3(i.scale||[1,1,1]),this._worldRotationMatrix=c.mat4(),this._worldRotationMatrixConjugate=c.mat4(),this._matrix=c.mat4(),this._matrixDirty=!0,this._rebuildMatrices(),this._worldNormalMatrix=c.mat4(),c.inverseMat4(this._matrix,this._worldNormalMatrix),c.transposeMat4(this._worldNormalMatrix),(i.matrix||i.position||i.rotation||i.scale||i.quaternion)&&(this._viewMatrix=c.mat4(),this._viewNormalMatrix=c.mat4(),this._viewMatrixDirty=!0,this._matrixNonIdentity=!0),this._opacity=1,this._colorize=[1,1,1],this._saoEnabled=i.saoEnabled!==!1,this._pbrEnabled=i.pbrEnabled!==!1,this._colorTextureEnabled=i.colorTextureEnabled!==!1,this._isModel=i.isModel,this._isModel&&this.scene._registerModel(this),this._onCameraViewMatrix=this.scene.camera.on("matrix",()=>{this._viewMatrixDirty=!0}),this._meshesWithDirtyMatrices=[],this._numMeshesWithDirtyMatrices=0,this._onTick=this.scene.on("tick",()=>{for(;this._numMeshesWithDirtyMatrices>0;)this._meshesWithDirtyMatrices[--this._numMeshesWithDirtyMatrices]._updateMatrix()}),this._createDefaultTextureSet(),this.visible=i.visible,this.culled=i.culled,this.pickable=i.pickable,this.clippable=i.clippable,this.collidable=i.collidable,this.castsShadow=i.castsShadow,this.receivesShadow=i.receivesShadow,this.xrayed=i.xrayed,this.highlighted=i.highlighted,this.selected=i.selected,this.edges=i.edges,this.colorize=i.colorize,this.opacity=i.opacity,this.backfaces=i.backfaces}_meshMatrixDirty(e){this._meshesWithDirtyMatrices[this._numMeshesWithDirtyMatrices++]=e}_createDefaultTextureSet(){const e=new ks({id:$a,texture:new Us({gl:this.scene.canvas.gl,preloadColor:[1,1,1,1]})}),i=new ks({id:Za,texture:new Us({gl:this.scene.canvas.gl,preloadColor:[0,1,1,1]})}),s=new ks({id:qa,texture:new Us({gl:this.scene.canvas.gl,preloadColor:[0,0,0,0]})}),t=new ks({id:Ja,texture:new Us({gl:this.scene.canvas.gl,preloadColor:[0,0,0,1]})}),o=new ks({id:eA,texture:new Us({gl:this.scene.canvas.gl,preloadColor:[1,1,1,1]})});this._textures[$a]=e,this._textures[Za]=i,this._textures[qa]=s,this._textures[Ja]=t,this._textures[eA]=o,this._textureSets[iu]=new Wh({id:iu,model:this,colorTexture:e,metallicRoughnessTexture:i,normalsTexture:s,emissiveTexture:t,occlusionTexture:o})}get isPerformanceModel(){return!0}get transforms(){return this._transforms}get textures(){return this._textures}get textureSets(){return this._textureSets}get meshes(){return this._meshes}get objects(){return this._entities}get origin(){return this._origin}set position(e){this._position.set(e||[0,0,0]),this._setWorldMatrixDirty(),this._sceneModelDirty(),this.glRedraw()}get position(){return this._position}set rotation(e){this._rotation.set(e||[0,0,0]),c.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setWorldMatrixDirty(),this._sceneModelDirty(),this.glRedraw()}get rotation(){return this._rotation}set quaternion(e){this._quaternion.set(e||[0,0,0,1]),c.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setWorldMatrixDirty(),this._sceneModelDirty(),this.glRedraw()}get quaternion(){return this._quaternion}set scale(e){}get scale(){return this._scale}set matrix(e){this._matrix.set(e||Dy),c.quaternionToRotationMat4(this._quaternion,this._worldRotationMatrix),c.conjugateQuaternion(this._quaternion,this._conjugateQuaternion),c.quaternionToRotationMat4(this._quaternion,this._worldRotationMatrixConjugate),this._matrix.set(this._worldRotationMatrix),c.translateMat4v(this._position,this._matrix),this._matrixDirty=!1,this._setWorldMatrixDirty(),this._sceneModelDirty(),this.glRedraw()}get matrix(){return this._matrixDirty&&this._rebuildMatrices(),this._matrix}get rotationMatrix(){return this._matrixDirty&&this._rebuildMatrices(),this._worldRotationMatrix}_rebuildMatrices(){this._matrixDirty&&(c.quaternionToRotationMat4(this._quaternion,this._worldRotationMatrix),c.conjugateQuaternion(this._quaternion,this._conjugateQuaternion),c.quaternionToRotationMat4(this._quaternion,this._worldRotationMatrixConjugate),this._matrix.set(this._worldRotationMatrix),c.translateMat4v(this._position,this._matrix),this._matrixDirty=!1)}get rotationMatrixConjugate(){return this._matrixDirty&&this._rebuildMatrices(),this._worldRotationMatrixConjugate}_setWorldMatrixDirty(){this._matrixDirty=!0,this._aabbDirty=!0}_transformDirty(){this._matrixDirty=!0,this._aabbDirty=!0,this.scene._aabbDirty=!0}_sceneModelDirty(){this.scene._aabbDirty=!0,this._aabbDirty=!0,this.scene._aabbDirty=!0,this._matrixDirty=!0;for(let e=0,i=this._entityList.length;e<i;e++)this._entityList[e]._sceneModelDirty()}get worldMatrix(){return this.matrix}get worldNormalMatrix(){return this._worldNormalMatrix}get viewMatrix(){return this._viewMatrix?(this._matrixDirty&&(this._rebuildMatrices(),this._viewMatrixDirty=!0),this._viewMatrixDirty&&(c.mulMat4(this.scene.camera.viewMatrix,this._matrix,this._viewMatrix),c.inverseMat4(this._viewMatrix,this._viewNormalMatrix),c.transposeMat4(this._viewNormalMatrix),this._viewMatrixDirty=!1),this._viewMatrix):this.scene.camera.viewMatrix}get viewNormalMatrix(){return this._viewNormalMatrix?(this._matrixDirty&&(this._rebuildMatrices(),this._viewMatrixDirty=!0),this._viewMatrixDirty&&(c.mulMat4(this.scene.camera.viewMatrix,this._matrix,this._viewMatrix),c.inverseMat4(this._viewMatrix,this._viewNormalMatrix),c.transposeMat4(this._viewNormalMatrix),this._viewMatrixDirty=!1),c.inverseMat4(this._viewMatrix,this._viewNormalMatrix),c.transposeMat4(this._viewNormalMatrix),this._viewNormalMatrix):this.scene.camera.viewNormalMatrix}get backfaces(){return this._backfaces}set backfaces(e){e=!!e,this._backfaces=e,this.glRedraw()}get entityList(){return this._entityList}get isEntity(){return!0}get isModel(){return this._isModel}get isObject(){return!1}get aabb(){if(this._aabbDirty){c.collapseAABB3(this._aabb);for(let e=0,i=this._entityList.length;e<i;e++)c.expandAABB3(this._aabb,this._entityList[e].aabb);this._aabbDirty=!1}return this._aabb}get numTriangles(){return this._numTriangles}get numLines(){return this._numLines}get numPoints(){return this._numPoints}get visible(){return this.numVisibleLayerPortions>0}set visible(e){e=e!==!1,this._visible=e;for(let i=0,s=this._entityList.length;i<s;i++)this._entityList[i].visible=e;this.glRedraw()}get xrayed(){return this.numXRayedLayerPortions>0}set xrayed(e){e=!!e,this._xrayed=e;for(let i=0,s=this._entityList.length;i<s;i++)this._entityList[i].xrayed=e;this.glRedraw()}get highlighted(){return this.numHighlightedLayerPortions>0}set highlighted(e){e=!!e,this._highlighted=e;for(let i=0,s=this._entityList.length;i<s;i++)this._entityList[i].highlighted=e;this.glRedraw()}get selected(){return this.numSelectedLayerPortions>0}set selected(e){e=!!e,this._selected=e;for(let i=0,s=this._entityList.length;i<s;i++)this._entityList[i].selected=e;this.glRedraw()}get edges(){return this.numEdgesLayerPortions>0}set edges(e){e=!!e,this._edges=e;for(let i=0,s=this._entityList.length;i<s;i++)this._entityList[i].edges=e;this.glRedraw()}get culled(){return this._culled}set culled(e){e=!!e,this._culled=e;for(let i=0,s=this._entityList.length;i<s;i++)this._entityList[i].culled=e;this.glRedraw()}get clippable(){return this._clippable}set clippable(e){e=e!==!1,this._clippable=e;for(let i=0,s=this._entityList.length;i<s;i++)this._entityList[i].clippable=e;this.glRedraw()}get collidable(){return this._collidable}set collidable(e){e=e!==!1,this._collidable=e;for(let i=0,s=this._entityList.length;i<s;i++)this._entityList[i].collidable=e}get pickable(){return this.numPickableLayerPortions>0}set pickable(e){e=e!==!1,this._pickable=e;for(let i=0,s=this._entityList.length;i<s;i++)this._entityList[i].pickable=e}get colorize(){return this._colorize}set colorize(e){this._colorize=e;for(let i=0,s=this._entityList.length;i<s;i++)this._entityList[i].colorize=e}get opacity(){return this._opacity}set opacity(e){this._opacity=e;for(let i=0,s=this._entityList.length;i<s;i++)this._entityList[i].opacity=e}get castsShadow(){return this._castsShadow}set castsShadow(e){e=e!==!1,e!==this._castsShadow&&(this._castsShadow=e,this.glRedraw())}get receivesShadow(){return this._receivesShadow}set receivesShadow(e){e=e!==!1,e!==this._receivesShadow&&(this._receivesShadow=e,this.glRedraw())}get saoEnabled(){return this._saoEnabled}get pbrEnabled(){return this._pbrEnabled}get colorTextureEnabled(){return this._colorTextureEnabled}get isDrawable(){return!0}get isStateSortable(){return!1}get xrayMaterial(){return this.scene.xrayMaterial}get highlightMaterial(){return this.scene.highlightMaterial}get selectedMaterial(){return this.scene.selectedMaterial}get edgeMaterial(){return this.scene.edgeMaterial}getPickViewMatrix(e){return this._viewMatrix?this._viewMatrix:e}createQuantizationRange(e){if(e.id===void 0||e.id===null){this.error("[createQuantizationRange] Config missing: id");return}if(e.aabb){this.error("[createQuantizationRange] Config missing: aabb");return}if(this._quantizationRanges[e.id]){this.error("[createQuantizationRange] QuantizationRange already created: "+e.id);return}this._quantizationRanges[e.id]={id:e.id,aabb:e.aabb,matrix:Ta(e.aabb,c.mat4())}}createGeometry(e){if(e.id===void 0||e.id===null){this.error("[createGeometry] Config missing: id");return}if(this._geometries[e.id]){this.error("[createGeometry] Geometry already created: "+e.id);return}if((e.primitive===void 0||e.primitive===null)&&(e.primitive="triangles"),e.primitive!=="points"&&e.primitive!=="lines"&&e.primitive!=="triangles"&&e.primitive!=="solid"&&e.primitive!=="surface"){this.error(`[createGeometry] Unsupported value for 'primitive': '${e.primitive}' - supported values are 'points', 'lines', 'triangles', 'solid' and 'surface'. Defaulting to 'triangles'.`);return}if(!e.positions&&!e.positionsCompressed&&!e.buckets)return this.error("[createGeometry] Param expected: `positions`,  `positionsCompressed' or 'buckets"),null;if(e.positionsCompressed&&!e.positionsDecodeMatrix&&!e.positionsDecodeBoundary)return this.error("[createGeometry] Param expected: `positionsDecodeMatrix` or 'positionsDecodeBoundary' (required for `positionsCompressed')"),null;if(e.positionsDecodeMatrix&&e.positionsDecodeBoundary)return this.error("[createGeometry] Only one of these params expected: `positionsDecodeMatrix` or 'positionsDecodeBoundary' (required for `positionsCompressed')"),null;if(e.uvCompressed&&!e.uvDecodeMatrix)return this.error("[createGeometry] Param expected: `uvDecodeMatrix` (required for `uvCompressed')"),null;if(!e.buckets&&!e.indices&&(e.primitive==="triangles"||e.primitive==="solid"||e.primitive==="surface")){const i=(e.positions||e.positionsCompressed).length/3;e.indices=this._createDefaultIndices(i)}if(!e.buckets&&!e.indices&&e.primitive!=="points")return this.error(`[createGeometry] Param expected: indices (required for '${e.primitive}' primitive type)`),null;if(e.positionsDecodeBoundary&&(e.positionsDecodeMatrix=Ta(e.positionsDecodeBoundary,c.mat4())),e.positions){const i=c.collapseAABB3();e.positionsDecodeMatrix=c.mat4(),c.expandAABB3Points3(i,e.positions),e.positionsCompressed=oo(e.positions,i,e.positionsDecodeMatrix),e.aabb=i}else if(e.positionsCompressed){const i=c.collapseAABB3();e.positionsDecodeMatrix=new Float64Array(e.positionsDecodeMatrix),e.positionsCompressed=new Uint16Array(e.positionsCompressed),c.expandAABB3Points3(i,e.positionsCompressed),st.decompressAABB(i,e.positionsDecodeMatrix),e.aabb=i}else if(e.buckets){const i=c.collapseAABB3();this._dtxBuckets[e.id]=e.buckets;for(let s=0,t=e.buckets.length;s<t;s++){const o=e.buckets[s];o.positions?c.expandAABB3Points3(i,o.positions):o.positionsCompressed&&c.expandAABB3Points3(i,o.positionsCompressed)}e.positionsDecodeMatrix&&st.decompressAABB(i,e.positionsDecodeMatrix),e.aabb=i}if(e.colorsCompressed&&e.colorsCompressed.length>0)e.colorsCompressed=new Uint8Array(e.colorsCompressed);else if(e.colors&&e.colors.length>0){const i=e.colors,s=new Uint8Array(i.length);for(let t=0,o=i.length;t<o;t++)s[t]=i[t]*255;e.colorsCompressed=s}if(!e.buckets&&!e.edgeIndices&&(e.primitive==="triangles"||e.primitive==="solid"||e.primitive==="surface")&&(e.positions?e.edgeIndices=ts(e.positions,e.indices,null,5):e.edgeIndices=ts(e.positionsCompressed,e.indices,e.positionsDecodeMatrix,2)),e.uv){const i=st.getUVBounds(e.uv),s=st.compressUVs(e.uv,i.min,i.max);e.uvCompressed=s.quantized,e.uvDecodeMatrix=s.decodeMatrix}else e.uvCompressed&&(e.uvCompressed=new Uint16Array(e.uvCompressed),e.uvDecodeMatrix=new Float64Array(e.uvDecodeMatrix));e.normals&&(e.normals=null),this._geometries[e.id]=e,this._numTriangles+=e.indices?Math.round(e.indices.length/3):0,this.numGeometries++}createTexture(e){const i=e.id;if(i==null){this.error("[createTexture] Config missing: id");return}if(this._textures[i]){this.error("[createTexture] Texture already created: "+i);return}if(!e.src&&!e.image&&!e.buffers)return this.error("[createTexture] Param expected: `src`, `image' or 'buffers'"),null;let s=e.minFilter||Zr;s!==ys&&s!==mp&&s!==Zr&&s!==gp&&s!==fp&&(this.error(`[createTexture] Unsupported value for 'minFilter' - 
            supported values are LinearFilter, LinearMipMapNearestFilter, NearestMipMapNearestFilter, 
            NearestMipMapLinearFilter and LinearMipmapLinearFilter. Defaulting to LinearMipmapLinearFilter.`),s=Zr);let t=e.magFilter||ys;t!==ys&&t!==Bl&&(this.error("[createTexture] Unsupported value for 'magFilter' - supported values are LinearFilter and NearestFilter. Defaulting to LinearFilter."),t=ys);let o=e.wrapS||ui;o!==_n&&o!==Ea&&o!==ui&&(this.error("[createTexture] Unsupported value for 'wrapS' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),o=ui);let n=e.wrapT||ui;n!==_n&&n!==Ea&&n!==ui&&(this.error("[createTexture] Unsupported value for 'wrapT' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),n=ui);let a=e.wrapR||ui;a!==_n&&a!==Ea&&a!==ui&&(this.error("[createTexture] Unsupported value for 'wrapR' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),a=ui);let A=e.encoding||nr;A!==nr&&A!==Ct&&(this.error("[createTexture] Unsupported value for 'encoding' - supported values are LinearEncoding and sRGBEncoding. Defaulting to LinearEncoding."),A=nr);const l=new Us({gl:this.scene.canvas.gl,minFilter:s,magFilter:t,wrapS:o,wrapT:n,wrapR:a,encoding:A});if(e.preloadColor&&l.setPreloadColor(e.preloadColor),e.image){const h=e.image;h.crossOrigin="Anonymous",l.setImage(h,{minFilter:s,magFilter:t,wrapS:o,wrapT:n,wrapR:a,flipY:e.flipY,encoding:A})}else if(e.src){const h=e.src.split(".").pop();switch(h){case"jpeg":case"jpg":case"png":case"gif":const d=new Image;d.onload=()=>{l.setImage(d,{minFilter:s,magFilter:t,wrapS:o,wrapT:n,wrapR:a,flipY:e.flipY,encoding:A}),this.glRedraw()},d.src=e.src;break;default:this._textureTranscoder?Le.loadArraybuffer(e.src,f=>{if(!f.byteLength){this.error("[createTexture] Can't create texture from 'src': file data is zero length");return}this._textureTranscoder.transcode([f],l).then(()=>{this.glRedraw()})},function(f){this.error(`[createTexture] Can't create texture from 'src': ${f}`)}):this.error(`[createTexture] Can't create texture from 'src' - SceneModel needs to be configured with a TextureTranscoder for this file type ('${h}')`);break}}else e.buffers&&(this._textureTranscoder?this._textureTranscoder.transcode(e.buffers,l).then(()=>{this.glRedraw()}):this.error("[createTexture] Can't create texture from 'buffers' - SceneModel needs to be configured with a TextureTranscoder for this option"));this._textures[i]=new ks({id:i,texture:l})}createTextureSet(e){const i=e.id;if(i==null){this.error("[createTextureSet] Config missing: id");return}if(this._textureSets[i]){this.error(`[createTextureSet] Texture set already created: ${i}`);return}let s;if(e.colorTextureId!==void 0&&e.colorTextureId!==null){if(s=this._textures[e.colorTextureId],!s){this.error(`[createTextureSet] Texture not found: ${e.colorTextureId} - ensure that you create it first with createTexture()`);return}}else s=this._textures[$a];let t;if(e.metallicRoughnessTextureId!==void 0&&e.metallicRoughnessTextureId!==null){if(t=this._textures[e.metallicRoughnessTextureId],!t){this.error(`[createTextureSet] Texture not found: ${e.metallicRoughnessTextureId} - ensure that you create it first with createTexture()`);return}}else t=this._textures[Za];let o;if(e.normalsTextureId!==void 0&&e.normalsTextureId!==null){if(o=this._textures[e.normalsTextureId],!o){this.error(`[createTextureSet] Texture not found: ${e.normalsTextureId} - ensure that you create it first with createTexture()`);return}}else o=this._textures[qa];let n;if(e.emissiveTextureId!==void 0&&e.emissiveTextureId!==null){if(n=this._textures[e.emissiveTextureId],!n){this.error(`[createTextureSet] Texture not found: ${e.emissiveTextureId} - ensure that you create it first with createTexture()`);return}}else n=this._textures[Ja];let a;if(e.occlusionTextureId!==void 0&&e.occlusionTextureId!==null){if(a=this._textures[e.occlusionTextureId],!a){this.error(`[createTextureSet] Texture not found: ${e.occlusionTextureId} - ensure that you create it first with createTexture()`);return}}else a=this._textures[eA];const A=new Wh({id:i,model:this,colorTexture:s,metallicRoughnessTexture:t,normalsTexture:o,emissiveTexture:n,occlusionTexture:a});return this._textureSets[i]=A,A}createTransform(e){if(e.id===void 0||e.id===null){this.error("[createTransform] SceneModel.createTransform() config missing: id");return}if(this._transforms[e.id]){this.error(`[createTransform] SceneModel already has a transform with this ID: ${e.id}`);return}let i;if(e.parentTransformId&&(i=this._transforms[e.parentTransformId],!i)){this.error("[createTransform] SceneModel.createTransform() config missing: id");return}const s=new Ty({id:e.id,model:this,parent:i,matrix:e.matrix,position:e.position,scale:e.scale,rotation:e.rotation,quaternion:e.quaternion});return this._transforms[s.id]=s,s}createMesh(e){if(e.id===void 0||e.id===null)return this.error("[createMesh] SceneModel.createMesh() config missing: id"),!1;if(this._meshes[e.id])return this.error(`[createMesh] SceneModel already has a mesh with this ID: ${e.id}`),!1;if(!(e.geometryId!==void 0)){if((e.primitive===void 0||e.primitive===null)&&(e.primitive="triangles"),e.primitive!=="points"&&e.primitive!=="lines"&&e.primitive!=="triangles"&&e.primitive!=="solid"&&e.primitive!=="surface")return this.error(`Unsupported value for 'primitive': '${primitive}'  ('geometryId' is absent) - supported values are 'points', 'lines', 'triangles', 'solid' and 'surface'.`),!1;if(!e.positions&&!e.positionsCompressed&&!e.buckets)return this.error("Param expected: 'positions',  'positionsCompressed' or `buckets`  ('geometryId' is absent)"),!1;if(e.positions&&(e.positionsDecodeMatrix||e.positionsDecodeBoundary))return this.error("Illegal params: 'positions' not expected with 'positionsDecodeMatrix'/'positionsDecodeBoundary' ('geometryId' is absent)"),!1;if(e.positionsCompressed&&!e.positionsDecodeMatrix&&!e.positionsDecodeBoundary)return this.error("Param expected: 'positionsCompressed' should be accompanied by 'positionsDecodeMatrix'/'positionsDecodeBoundary' ('geometryId' is absent)"),!1;if(e.uvCompressed&&!e.uvDecodeMatrix)return this.error("Param expected: 'uvCompressed' should be accompanied by `uvDecodeMatrix` ('geometryId' is absent)"),!1;if(!e.buckets&&!e.indices&&(e.primitive==="triangles"||e.primitive==="solid"||e.primitive==="surface")){const o=(e.positions||e.positionsCompressed).length/3;e.indices=this._createDefaultIndices(o)}if(!e.buckets&&!e.indices&&e.primitive!=="points")return e.indices=this._createDefaultIndices(numIndices),this.error(`Param expected: indices (required for '${e.primitive}' primitive type)`),!1;if((e.matrix||e.position||e.rotation||e.scale)&&(e.positionsCompressed||e.positionsDecodeBoundary))return this.error("Unexpected params: 'matrix', 'rotation', 'scale', 'position' not allowed with 'positionsCompressed'"),!1;const t=!!this._dtxEnabled&&(e.primitive==="triangles"||e.primitive==="solid"||e.primitive==="surface")&&!e.textureSetId;if(e.origin=e.origin?c.addVec3(this._origin,e.origin,c.vec3()):this._origin,e.matrix)e.meshMatrix=e.matrix;else if(e.scale||e.rotation||e.position||e.quaternion){const o=e.scale||Jh,n=e.position||eu;e.rotation?(c.eulerToQuaternion(e.rotation,"XYZ",jo),e.meshMatrix=c.composeMat4(n,jo,o,c.mat4())):e.meshMatrix=c.composeMat4(n,e.quaternion||tu,o,c.mat4())}if(e.positionsDecodeBoundary&&(e.positionsDecodeMatrix=Ta(e.positionsDecodeBoundary,c.mat4())),t){if(e.type=Ns,e.color=e.color?new Uint8Array([Math.floor(e.color[0]*255),Math.floor(e.color[1]*255),Math.floor(e.color[2]*255)]):tA,e.opacity=e.opacity!==void 0&&e.opacity!==null?Math.floor(e.opacity*255):255,e.positions){const o=c.vec3(),n=[];LA(e.positions,n,o)&&(e.positions=n,e.origin=c.addVec3(e.origin,o,o))}if(e.positions){const o=c.collapseAABB3();e.positionsDecodeMatrix=c.mat4(),c.expandAABB3Points3(o,e.positions),e.positionsCompressed=oo(e.positions,o,e.positionsDecodeMatrix),e.aabb=o}else if(e.positionsCompressed){const o=c.collapseAABB3();c.expandAABB3Points3(o,e.positionsCompressed),st.decompressAABB(o,e.positionsDecodeMatrix),e.aabb=o}if(e.buckets){const o=c.collapseAABB3();for(let n=0,a=e.buckets.length;n<a;n++){const A=e.buckets[n];A.positions?c.expandAABB3Points3(o,A.positions):A.positionsCompressed&&c.expandAABB3Points3(o,A.positionsCompressed)}e.positionsDecodeMatrix&&st.decompressAABB(o,e.positionsDecodeMatrix),e.aabb=o}e.meshMatrix&&(c.AABB3ToOBB3(e.aabb,ji),c.transformOBB3(e.meshMatrix,ji),c.OBB3ToAABB3(ji,e.aabb)),!e.buckets&&!e.edgeIndices&&(e.primitive==="triangles"||e.primitive==="solid"||e.primitive==="surface")&&(e.positions?e.edgeIndices=ts(e.positions,e.indices,null,2):e.edgeIndices=ts(e.positionsCompressed,e.indices,e.positionsDecodeMatrix,2)),e.buckets||(e.buckets=su(e,this._enableVertexWelding&&this._enableIndexBucketing))}else{if(e.type=Ur,e.color=e.color?new Uint8Array([Math.floor(e.color[0]*255),Math.floor(e.color[1]*255),Math.floor(e.color[2]*255)]):[255,255,255],e.opacity=e.opacity!==void 0&&e.opacity!==null?Math.floor(e.opacity*255):255,e.metallic=e.metallic!==void 0&&e.metallic!==null?Math.floor(e.metallic*255):0,e.roughness=e.roughness!==void 0&&e.roughness!==null?Math.floor(e.roughness*255):255,e.positions){const o=[];LA(e.positions,o,qh)&&(e.positions=o,e.origin=c.addVec3(e.origin,qh,c.vec3()))}if(e.positions){const o=c.collapseAABB3();e.meshMatrix&&(c.transformPositions3(e.meshMatrix,e.positions,e.positions),e.meshMatrix=null),c.expandAABB3Points3(o,e.positions),e.aabb=o}else{const o=c.collapseAABB3();c.expandAABB3Points3(o,e.positionsCompressed),st.decompressAABB(o,e.positionsDecodeMatrix),e.aabb=o}if(e.meshMatrix&&(c.AABB3ToOBB3(e.aabb,ji),c.transformOBB3(e.meshMatrix,ji),c.OBB3ToAABB3(ji,e.aabb)),!e.buckets&&!e.edgeIndices&&(e.primitive==="triangles"||e.primitive==="solid"||e.primitive==="surface")&&(e.positions?e.edgeIndices=ts(e.positions,e.indices,null,2):e.edgeIndices=ts(e.positionsCompressed,e.indices,e.positionsDecodeMatrix,2)),e.textureSetId&&(e.textureSet=this._textureSets[e.textureSetId],!e.textureSet))return this.error(`[createMesh] Texture set not found: ${e.textureSetId} - ensure that you create it first with createTextureSet()`),!1}}else{if(e.positions||e.positionsCompressed||e.indices||e.edgeIndices||e.normals||e.normalsCompressed||e.uv||e.uvCompressed||e.positionsDecodeMatrix)return this.error("Mesh geometry parameters not expected when instancing a geometry (not expected: positions, positionsCompressed, indices, edgeIndices, normals, normalsCompressed, uv, uvCompressed, positionsDecodeMatrix)"),!1;if(e.geometry=this._geometries[e.geometryId],!e.geometry)return this.error(`[createMesh] Geometry not found: ${e.geometryId} - ensure that you create it first with createGeometry()`),!1;if(e.origin=e.origin?c.addVec3(this._origin,e.origin,c.vec3()):this._origin,e.positionsDecodeMatrix=e.geometry.positionsDecodeMatrix,e.transformId){if(e.transform=this._transforms[e.transformId],!e.transform)return this.error(`[createMesh] Transform not found: ${e.transformId} - ensure that you create it first with createTransform()`),!1;e.aabb=e.geometry.aabb}else{if(e.matrix)e.meshMatrix=e.matrix;else if(e.scale||e.rotation||e.position||e.quaternion){const o=e.scale||Jh,n=e.position||eu;e.rotation?(c.eulerToQuaternion(e.rotation,"XYZ",jo),e.meshMatrix=c.composeMat4(n,jo,o,c.mat4())):e.meshMatrix=c.composeMat4(n,e.quaternion||tu,o,c.mat4())}c.AABB3ToOBB3(e.geometry.aabb,ji),c.transformOBB3(e.meshMatrix,ji),e.aabb=c.OBB3ToAABB3(ji,c.AABB3())}if(!!this._dtxEnabled&&(e.geometry.primitive==="triangles"||e.geometry.primitive==="solid"||e.geometry.primitive==="surface")&&!e.textureSetId){e.type=Ns,e.color=e.color?new Uint8Array([Math.floor(e.color[0]*255),Math.floor(e.color[1]*255),Math.floor(e.color[2]*255)]):tA,e.opacity=e.opacity!==void 0&&e.opacity!==null?Math.floor(e.opacity*255):255;let o=this._dtxBuckets[e.geometryId];o||(o=su(e.geometry,this._enableVertexWelding,this._enableIndexBucketing),this._dtxBuckets[e.geometryId]=o),e.buckets=o}else e.type=Lr,e.color=e.color?new Uint8Array([Math.floor(e.color[0]*255),Math.floor(e.color[1]*255),Math.floor(e.color[2]*255)]):tA,e.opacity=e.opacity!==void 0&&e.opacity!==null?Math.floor(e.opacity*255):255,e.metallic=e.metallic!==void 0&&e.metallic!==null?Math.floor(e.metallic*255):0,e.roughness=e.roughness!==void 0&&e.roughness!==null?Math.floor(e.roughness*255):255,e.textureSetId&&(e.textureSet=this._textureSets[e.textureSetId])}return e.numPrimitives=this._getNumPrimitives(e),this._createMesh(e)}_createMesh(e){const i=new b0(this,e.id,e.color,e.opacity,e.transform,e.textureSet);i.pickId=this.scene._renderer.getPickID(i);const s=i.pickId,t=s>>24&255,o=s>>16&255,n=s>>8&255,a=s&255;switch(e.pickColor=new Uint8Array([a,n,o,t]),e.solid=e.primitive==="solid",i.origin=c.vec3(e.origin),e.type){case Ns:i.layer=this._getDTXLayer(e),i.aabb=e.aabb;break;case Ur:i.layer=this._getVBOBatchingLayer(e),i.aabb=e.aabb;break;case Lr:i.layer=this._getVBOInstancingLayer(e),i.aabb=e.aabb;break}return e.transform&&(e.meshMatrix=e.transform.worldMatrix),i.portionId=i.layer.createPortion(i,e),this._meshes[e.id]=i,this._unusedMeshes[e.id]=i,this._meshList.push(i),i}_getNumPrimitives(e){let i=0;switch(e.geometry?e.geometry.primitive:e.primitive){case"triangles":case"solid":case"surface":switch(e.type){case Ns:for(let t=0,o=e.buckets.length;t<o;t++)i+=e.buckets[t].indices.length;break;case Ur:i+=e.indices.length;break;case Lr:i+=e.geometry.indices.length;break}return Math.round(i/3);case"points":switch(e.type){case Ns:for(let o=0,n=e.buckets.length;o<n;o++)i+=e.buckets[o].positionsCompressed.length;break;case Ur:i+=e.positions?e.positions.length:e.positionsCompressed.length;break;case Lr:const t=e.geometry;i+=t.positions?t.positions.length:t.positionsCompressed.length;break}return Math.round(i);case"lines":case"line-strip":switch(e.type){case Ns:for(let t=0,o=e.buckets.length;t<o;t++)i+=e.buckets[t].indices.length;break;case Ur:i+=e.indices.length;break;case Lr:i+=e.geometry.indices.length;break}return Math.round(i/2)}return 0}_getDTXLayer(e){const i=e.origin,s=e.geometry?e.geometry.primitive:e.primitive,t=`.${s}.${Math.round(i[0])}.${Math.round(i[1])}.${Math.round(i[2])}`;let o=this._dtxLayers[t];if(o)if(!o.canCreatePortion(e))o.finalize(),delete this._dtxLayers[t],o=null;else return o;switch(s){case"triangles":case"solid":case"surface":o=new uy(this,{layerIndex:0,origin:i});break;case"lines":o=new pB(this,{layerIndex:0,origin:i});break;default:return}return this._dtxLayers[t]=o,this.layerList.push(o),o}_getVBOBatchingLayer(e){const i=this,s=e.origin,t=e.positionsDecodeMatrix||e.positionsDecodeBoundary?this._createHashStringFromMatrix(e.positionsDecodeMatrix||e.positionsDecodeBoundary):"-",o=e.textureSetId||"-",n=`${Math.round(s[0])}.${Math.round(s[1])}.${Math.round(s[2])}.${e.primitive}.${t}.${o}`;let a=this._vboBatchingLayers[n];if(a)return a;let A=e.textureSet;for(;!a;){switch(e.primitive){case"triangles":a=new Da({model:i,textureSet:A,layerIndex:0,scratchMemory:this._vboBatchingLayerScratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,uvDecodeMatrix:e.uvDecodeMatrix,origin:s,maxGeometryBatchSize:this._maxGeometryBatchSize,solid:e.primitive==="solid",autoNormals:!0});break;case"solid":a=new Da({model:i,textureSet:A,layerIndex:0,scratchMemory:this._vboBatchingLayerScratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,uvDecodeMatrix:e.uvDecodeMatrix,origin:s,maxGeometryBatchSize:this._maxGeometryBatchSize,solid:e.primitive==="solid",autoNormals:!0});break;case"surface":a=new Da({model:i,textureSet:A,layerIndex:0,scratchMemory:this._vboBatchingLayerScratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,uvDecodeMatrix:e.uvDecodeMatrix,origin:s,maxGeometryBatchSize:this._maxGeometryBatchSize,solid:e.primitive==="solid",autoNormals:!0});break;case"lines":a=new iP({model:i,layerIndex:0,scratchMemory:this._vboBatchingLayerScratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,uvDecodeMatrix:e.uvDecodeMatrix,origin:s,maxGeometryBatchSize:this._maxGeometryBatchSize});break;case"points":a=new UP({model:i,layerIndex:0,scratchMemory:this._vboBatchingLayerScratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,uvDecodeMatrix:e.uvDecodeMatrix,origin:s,maxGeometryBatchSize:this._maxGeometryBatchSize});break}const l=e.positionsCompressed?e.positionsCompressed.length:e.positions.length;(e.primitive==="points"?a.canCreatePortion(l):a.canCreatePortion(l,e.indices.length))||(a.finalize(),delete this._vboBatchingLayers[n],a=null)}return this._vboBatchingLayers[n]=a,this.layerList.push(a),a}_createHashStringFromMatrix(e){const i=e.join("");let s=0;for(let o=0;o<i.length;o++){const n=i.charCodeAt(o);s=(s<<5)-s+n,s|=0}return(s>>>0).toString(16)}_getVBOInstancingLayer(e){const i=this,s=e.origin,t=e.textureSetId||"-",o=e.geometryId,n=`${Math.round(s[0])}.${Math.round(s[1])}.${Math.round(s[2])}.${t}.${o}`;let a=this._vboInstancingLayers[n];if(a)return a;let A=e.textureSet;const l=e.geometry;for(;!a;)switch(l.primitive){case"triangles":a=new La({model:i,textureSet:A,geometry:l,origin:s,layerIndex:0,solid:!1});break;case"solid":a=new La({model:i,textureSet:A,geometry:l,origin:s,layerIndex:0,solid:!0});break;case"surface":a=new La({model:i,textureSet:A,geometry:l,origin:s,layerIndex:0,solid:!1});break;case"lines":a=new fP({model:i,textureSet:A,geometry:l,origin:s,layerIndex:0});break;case"points":a=new iB({model:i,textureSet:A,geometry:l,origin:s,layerIndex:0});break}return this._vboInstancingLayers[n]=a,this.layerList.push(a),a}createEntity(e){if(e.id===void 0?e.id=c.createUUID():this.scene.components[e.id]&&(this.error(`Scene already has a Component with this ID: ${e.id} - will assign random ID`),e.id=c.createUUID()),e.meshIds===void 0){this.error("Config missing: meshIds");return}let i=0;this._visible&&e.visible!==!1&&(i=i|k.VISIBLE),this._pickable&&e.pickable!==!1&&(i=i|k.PICKABLE),this._culled&&e.culled!==!1&&(i=i|k.CULLED),this._clippable&&e.clippable!==!1&&(i=i|k.CLIPPABLE),this._collidable&&e.collidable!==!1&&(i=i|k.COLLIDABLE),this._edges&&e.edges!==!1&&(i=i|k.EDGES),this._xrayed&&e.xrayed!==!1&&(i=i|k.XRAYED),this._highlighted&&e.highlighted!==!1&&(i=i|k.HIGHLIGHTED),this._selected&&e.selected!==!1&&(i=i|k.SELECTED),e.flags=i,this._createEntity(e)}_createEntity(e){let i=[];for(let o=0,n=e.meshIds.length;o<n;o++){const a=e.meshIds[o];let A=this._meshes[a];if(!A){this.error(`Mesh with this ID not found: "${a}" - ignoring this mesh`);continue}if(A.parent){this.error(`Mesh with ID "${a}" already belongs to object with ID "${A.parent.id}" - ignoring this mesh`);continue}i.push(A),delete this._unusedMeshes[a]}const s=!0,t=new pm(this,e.isObject,e.id,i,e.flags,s);this._entityList.push(t),this._entities[e.id]=t,this.numEntities++}finalize(){if(!this.destroyed){this._createDummyEntityForUnusedMeshes();for(let e=0,i=this.layerList.length;e<i;e++)this.layerList[e].finalize();this._geometries={},this._dtxBuckets={},this._textures={},this._textureSets={},this._dtxLayers={},this._vboInstancingLayers={},this._vboBatchingLayers={};for(let e=0,i=this._entityList.length;e<i;e++)this._entityList[e]._finalize();for(let e=0,i=this._entityList.length;e<i;e++)this._entityList[e]._finalize2();this.layerList.sort((e,i)=>e.sortId<i.sortId?-1:e.sortId>i.sortId?1:0);for(let e=0,i=this.layerList.length;e<i;e++){const s=this.layerList[e];s.layerIndex=e}this.glRedraw(),this.scene._aabbDirty=!0,this._viewMatrixDirty=!0,this._matrixDirty=!0,this._aabbDirty=!0,this._setWorldMatrixDirty(),this._sceneModelDirty(),this.position=this._position}}stateSortCompare(e,i){}rebuildRenderFlags(){if(this.renderFlags.reset(),this._updateRenderFlagsVisibleLayers(),this.renderFlags.numLayers>0&&this.renderFlags.numVisibleLayers===0){this.renderFlags.culled=!0;return}this._updateRenderFlags()}_updateRenderFlagsVisibleLayers(){const e=this.renderFlags;e.numLayers=this.layerList.length,e.numVisibleLayers=0;for(let i=0,s=this.layerList.length;i<s;i++){const t=this.layerList[i];this._getActiveSectionPlanesForLayer(t)&&(e.visibleLayers[e.numVisibleLayers++]=i)}}_createDummyEntityForUnusedMeshes(){const e=Object.keys(this._unusedMeshes);if(e.length>0){const i=`${this.id}-dummyEntityForUnusedMeshes`;this.warn(`Creating dummy SceneModelEntity "${i}" for unused SceneMeshes: [${e.join(",")}]`),this.createEntity({id:i,meshIds:e,isObject:!0})}this._unusedMeshes={}}_getActiveSectionPlanesForLayer(e){const i=this.renderFlags,s=this.scene._sectionPlanesState.sectionPlanes,t=s.length,o=e.layerIndex*t;if(t>0)for(let n=0;n<t;n++)s[n].active?(i.sectionPlanesActivePerLayer[o+n]=!0,i.sectioned=!0):i.sectionPlanesActivePerLayer[o+n]=!1;return!0}_updateRenderFlags(){if(this.numVisibleLayerPortions===0||this.numCulledLayerPortions===this.numPortions)return;const e=this.renderFlags;if(e.colorOpaque=this.numTransparentLayerPortions<this.numPortions,this.numTransparentLayerPortions>0&&(e.colorTransparent=!0),this.numXRayedLayerPortions>0){const i=this.scene.xrayMaterial._state;i.fill&&(i.fillAlpha<1?e.xrayedSilhouetteTransparent=!0:e.xrayedSilhouetteOpaque=!0),i.edges&&(i.edgeAlpha<1?e.xrayedEdgesTransparent=!0:e.xrayedEdgesOpaque=!0)}if(this.numEdgesLayerPortions>0&&this.scene.edgeMaterial._state.edges&&(e.edgesOpaque=this.numTransparentLayerPortions<this.numPortions,this.numTransparentLayerPortions>0&&(e.edgesTransparent=!0)),this.numSelectedLayerPortions>0){const i=this.scene.selectedMaterial._state;i.fill&&(i.fillAlpha<1?e.selectedSilhouetteTransparent=!0:e.selectedSilhouetteOpaque=!0),i.edges&&(i.edgeAlpha<1?e.selectedEdgesTransparent=!0:e.selectedEdgesOpaque=!0)}if(this.numHighlightedLayerPortions>0){const i=this.scene.highlightMaterial._state;i.fill&&(i.fillAlpha<1?e.highlightedSilhouetteTransparent=!0:e.highlightedSilhouetteOpaque=!0),i.edges&&(i.edgeAlpha<1?e.highlightedEdgesTransparent=!0:e.highlightedEdgesOpaque=!0)}}drawColorOpaque(e){const i=this.renderFlags;for(let s=0,t=i.visibleLayers.length;s<t;s++){const o=i.visibleLayers[s];this.layerList[o].drawColorOpaque(i,e)}}drawColorTransparent(e){const i=this.renderFlags;for(let s=0,t=i.visibleLayers.length;s<t;s++){const o=i.visibleLayers[s];this.layerList[o].drawColorTransparent(i,e)}}drawDepth(e){const i=this.renderFlags;for(let s=0,t=i.visibleLayers.length;s<t;s++){const o=i.visibleLayers[s];this.layerList[o].drawDepth(i,e)}}drawNormals(e){const i=this.renderFlags;for(let s=0,t=i.visibleLayers.length;s<t;s++){const o=i.visibleLayers[s];this.layerList[o].drawNormals(i,e)}}drawSilhouetteXRayed(e){const i=this.renderFlags;for(let s=0,t=i.visibleLayers.length;s<t;s++){const o=i.visibleLayers[s];this.layerList[o].drawSilhouetteXRayed(i,e)}}drawSilhouetteHighlighted(e){const i=this.renderFlags;for(let s=0,t=i.visibleLayers.length;s<t;s++){const o=i.visibleLayers[s];this.layerList[o].drawSilhouetteHighlighted(i,e)}}drawSilhouetteSelected(e){const i=this.renderFlags;for(let s=0,t=i.visibleLayers.length;s<t;s++){const o=i.visibleLayers[s];this.layerList[o].drawSilhouetteSelected(i,e)}}drawEdgesColorOpaque(e){const i=this.renderFlags;for(let s=0,t=i.visibleLayers.length;s<t;s++){const o=i.visibleLayers[s];this.layerList[o].drawEdgesColorOpaque(i,e)}}drawEdgesColorTransparent(e){const i=this.renderFlags;for(let s=0,t=i.visibleLayers.length;s<t;s++){const o=i.visibleLayers[s];this.layerList[o].drawEdgesColorTransparent(i,e)}}drawEdgesXRayed(e){const i=this.renderFlags;for(let s=0,t=i.visibleLayers.length;s<t;s++){const o=i.visibleLayers[s];this.layerList[o].drawEdgesXRayed(i,e)}}drawEdgesHighlighted(e){const i=this.renderFlags;for(let s=0,t=i.visibleLayers.length;s<t;s++){const o=i.visibleLayers[s];this.layerList[o].drawEdgesHighlighted(i,e)}}drawEdgesSelected(e){const i=this.renderFlags;for(let s=0,t=i.visibleLayers.length;s<t;s++){const o=i.visibleLayers[s];this.layerList[o].drawEdgesSelected(i,e)}}drawOcclusion(e){if(this.numVisibleLayerPortions===0)return;const i=this.renderFlags;for(let s=0,t=i.visibleLayers.length;s<t;s++){const o=i.visibleLayers[s];this.layerList[o].drawOcclusion(i,e)}}drawShadow(e){if(this.numVisibleLayerPortions===0)return;const i=this.renderFlags;for(let s=0,t=i.visibleLayers.length;s<t;s++){const o=i.visibleLayers[s];this.layerList[o].drawShadow(i,e)}}setPickMatrices(e,i){if(this._numVisibleLayerPortions===0)return;const s=this.renderFlags;for(let t=0,o=s.visibleLayers.length;t<o;t++){const n=s.visibleLayers[t],a=this.layerList[n];a.setPickMatrices&&a.setPickMatrices(e,i)}}drawPickMesh(e){if(this.numVisibleLayerPortions===0)return;const i=this.renderFlags;for(let s=0,t=i.visibleLayers.length;s<t;s++){const o=i.visibleLayers[s];this.layerList[o].drawPickMesh(i,e)}}drawPickDepths(e){if(this.numVisibleLayerPortions===0)return;const i=this.renderFlags;for(let s=0,t=i.visibleLayers.length;s<t;s++){const o=i.visibleLayers[s];this.layerList[o].drawPickDepths(i,e)}}drawPickNormals(e){if(this.numVisibleLayerPortions===0)return;const i=this.renderFlags;for(let s=0,t=i.visibleLayers.length;s<t;s++){const o=i.visibleLayers[s];this.layerList[o].drawPickNormals(i,e)}}drawSnapInit(e){if(this.numVisibleLayerPortions===0)return;const i=this.renderFlags;for(let s=0,t=i.visibleLayers.length;s<t;s++){const o=i.visibleLayers[s],n=this.layerList[o];n.drawSnapInit&&(e.snapPickOrigin=[0,0,0],e.snapPickCoordinateScale=[1,1,1],e.snapPickLayerNumber++,n.drawSnapInit(i,e),e.snapPickLayerParams[e.snapPickLayerNumber]={origin:e.snapPickOrigin.slice(),coordinateScale:e.snapPickCoordinateScale.slice()})}}drawSnap(e){if(this.numVisibleLayerPortions===0)return;const i=this.renderFlags;for(let s=0,t=i.visibleLayers.length;s<t;s++){const o=i.visibleLayers[s],n=this.layerList[o];n.drawSnap&&(e.snapPickOrigin=[0,0,0],e.snapPickCoordinateScale=[1,1,1],e.snapPickLayerNumber++,n.drawSnap(i,e),e.snapPickLayerParams[e.snapPickLayerNumber]={origin:e.snapPickOrigin.slice(),coordinateScale:e.snapPickCoordinateScale.slice()})}}destroy(){for(let e in this._vboBatchingLayers)this._vboBatchingLayers.hasOwnProperty(e)&&this._vboBatchingLayers[e].destroy();this._vboBatchingLayers={};for(let e in this._vboInstancingLayers)this._vboInstancingLayers.hasOwnProperty(e)&&this._vboInstancingLayers[e].destroy();this._vboInstancingLayers={},this.scene.camera.off(this._onCameraViewMatrix),this.scene.off(this._onTick);for(let e=0,i=this.layerList.length;e<i;e++)this.layerList[e].destroy();this.layerList=[];for(let e=0,i=this._entityList.length;e<i;e++)this._entityList[e]._destroy();this._geometries={},this._dtxBuckets={},this._textures={},this._textureSets={},this._meshes={},this._entities={},this.scene._aabbDirty=!0,this._isModel&&this.scene._deregisterModel(this),I0(),super.destroy()}}function su(r,e,i){let s,t,o;e||i?[s,t,o]=By({positionsCompressed:r.positionsCompressed,indices:r.indices,edgeIndices:r.edgeIndices}):(s=r.positionsCompressed,t=r.indices,o=r.edgeIndices);let n;if(i){let a=s.length/3;n=Cy({positionsCompressed:s,indices:t,edgeIndices:o},a>65536?16:8)}else n=[{positionsCompressed:s,indices:t,edgeIndices:o}];return n}c.vec3();c.vec3();c.vec3();c.vec3();c.vec3();class Ly{constructor(e={}){this._eventSubIDMap=null,this._eventSubEvents=null,this._eventSubs=null,this._events=null,this._locale="en",this._messages={},this._locales=[],this._locale="en",this.messages=e.messages,this.locale=e.locale}set messages(e){this._messages=e||{},this._locales=Object.keys(this._messages),this.fire("updated",this)}loadMessages(e={}){for(let i in e)this._messages[i]=e[i];this.messages=this._messages}clearMessages(){this.messages={}}get locales(){return this._locales}set locale(e){e=e||"de",this._locale!==e&&(this._locale=e,this.fire("updated",e))}get locale(){return this._locale}translate(e,i){const s=this._messages[this._locale];if(!s)return null;const t=ru(e,s);return t?i?iA(t,i):t:null}translatePlurals(e,i,s){const t=this._messages[this._locale];if(!t)return null;let o=ru(e,t);return i=parseInt(""+i,10),i===0?o=o.zero:o=i>1?o.other:o.one,o?(o=iA(o,[i]),s&&(o=iA(o,s)),o):null}fire(e,i,s){this._events||(this._events={}),this._eventSubs||(this._eventSubs={}),s!==!0&&(this._events[e]=i||!0);const t=this._eventSubs[e];if(t)for(const o in t)t.hasOwnProperty(o)&&t[o].callback(i)}on(e,i){this._events||(this._events={}),this._eventSubIDMap||(this._eventSubIDMap=new Ci),this._eventSubEvents||(this._eventSubEvents={}),this._eventSubs||(this._eventSubs={});let s=this._eventSubs[e];s||(s={},this._eventSubs[e]=s);const t=this._eventSubIDMap.addItem();s[t]={callback:i},this._eventSubEvents[t]=e;const o=this._events[e];return o!==void 0&&i(o),t}off(e){if(e==null||!this._eventSubEvents)return;const i=this._eventSubEvents[e];if(i){delete this._eventSubEvents[e];const s=this._eventSubs[i];s&&delete s[e],this._eventSubIDMap.removeItem(e)}}}function ru(r,e){if(e[r])return e[r];const i=r.split(".");let s=e;for(let t=0,o=i.length;s&&t<o;t++){const n=i[t];s=s[n]}return s}function iA(r,e=[]){return r.replace(/\{\{|\}\}|\{(\d+)\}/g,function(i,s){return i==="{{"?"{":i==="}}"?"}":e[s]})}c.vec3();const sA=c.vec3(),rA=c.vec3(),oA=c.vec3(),ou=c.vec3(),ms=c.vec3();class bs extends Et{get type(){return"CameraFlightAnimation"}constructor(e,i={}){super(e,i),this._look1=c.vec3(),this._eye1=c.vec3(),this._up1=c.vec3(),this._look2=c.vec3(),this._eye2=c.vec3(),this._up2=c.vec3(),this._orthoScale1=1,this._orthoScale2=1,this._flying=!1,this._flyEyeLookUp=!1,this._flyingEye=!1,this._flyingLook=!1,this._callback=null,this._callbackScope=null,this._time1=null,this._time2=null,this.easing=i.easing!==!1,this.duration=i.duration,this.fit=i.fit,this.fitFOV=i.fitFOV,this.trail=i.trail}flyTo(e,i,s){e=e||this.scene,this._flying&&this.stop(),this._flying=!1,this._flyingEye=!1,this._flyingLook=!1,this._flyingEyeLookUp=!1,this._callback=i,this._callbackScope=s;const t=this.scene.camera,o=!!e.projection&&e.projection!==t.projection;this._eye1[0]=t.eye[0],this._eye1[1]=t.eye[1],this._eye1[2]=t.eye[2],this._look1[0]=t.look[0],this._look1[1]=t.look[1],this._look1[2]=t.look[2],this._up1[0]=t.up[0],this._up1[1]=t.up[1],this._up1[2]=t.up[2],this._orthoScale1=t.ortho.scale,this._orthoScale2=e.orthoScale||this._orthoScale1;let n,a,A,l,h;if(e.aabb)n=e.aabb;else if(e.length===6)n=e;else if(e.eye&&e.look||e.up)a=e.eye,A=e.look,l=e.up;else if(e.eye)a=e.eye;else if(e.look)A=e.look;else{let f=e;if((Le.isNumeric(f)||Le.isString(f))&&(h=f,f=this.scene.components[h],!f)){this.error("Component not found: "+Le.inQuotes(h)),i&&(s?i.call(s):i());return}o||(n=f.aabb||this.scene.aabb)}const d=e.poi;if(n){if(n[3]<n[0]||n[4]<n[1]||n[5]<n[2]||n[3]===n[0]&&n[4]===n[1]&&n[5]===n[2])return;n=n.slice();const f=c.getAABB3Center(n);this._look2=d||f;const m=c.subVec3(this._eye1,this._look1,sA),_=c.normalizeVec3(m),u=d?c.getAABB3DiagPoint(n,d):c.getAABB3Diag(n),P=e.fitFOV||this._fitFOV,y=Math.abs(u/Math.tan(P*c.DEGTORAD));this._orthoScale2=u*1.1,this._eye2[0]=this._look2[0]+_[0]*y,this._eye2[1]=this._look2[1]+_[1]*y,this._eye2[2]=this._look2[2]+_[2]*y,this._up2[0]=this._up1[0],this._up2[1]=this._up1[1],this._up2[2]=this._up1[2],this._flyingEyeLookUp=!0}else(a||A||l)&&(this._flyingEyeLookUp=!!a&&!!A&&!!l,this._flyingEye=!!a&&!A,this._flyingLook=!!A&&!a,a&&(this._eye2[0]=a[0],this._eye2[1]=a[1],this._eye2[2]=a[2]),A&&(this._look2[0]=A[0],this._look2[1]=A[1],this._look2[2]=A[2]),l&&(this._up2[0]=l[0],this._up2[1]=l[1],this._up2[2]=l[2]));o?(e.projection==="ortho"&&t.projection!=="ortho"&&(this._projection2="ortho",this._projMatrix1=t.projMatrix.slice(),this._projMatrix2=t.ortho.matrix.slice(),t.projection="customProjection"),e.projection==="perspective"&&t.projection!=="perspective"&&(this._projection2="perspective",this._projMatrix1=t.projMatrix.slice(),this._projMatrix2=t.perspective.matrix.slice(),t.projection="customProjection")):this._projection2=null,this.fire("started",e,!0),this._time1=Date.now(),this._time2=this._time1+(e.duration?e.duration*1e3:this._duration),this._flying=!0,xt.scheduleTask(this._update,this)}jumpTo(e){this._jumpTo(e)}_jumpTo(e){this._flying&&this.stop();const i=this.scene.camera;var s,t,o,n,a;if(e.aabb)s=e.aabb;else if(e.length===6)s=e;else if(e.eye||e.look||e.up)o=e.eye,n=e.look,a=e.up;else{let h=e;if((Le.isNumeric(h)||Le.isString(h))&&(t=h,h=this.scene.components[t],!h)){this.error("Component not found: "+Le.inQuotes(t));return}s=h.aabb||this.scene.aabb}const A=e.poi;if(s){if(s[3]<=s[0]||s[4]<=s[1]||s[5]<=s[2])return;var l=A?c.getAABB3DiagPoint(s,A):c.getAABB3Diag(s);n=A||c.getAABB3Center(s,n),this._trail?c.subVec3(i.look,n,ms):c.subVec3(i.eye,i.look,ms),c.normalizeVec3(ms);let h;(e.fit!==void 0?e.fit:this._fit)?h=Math.abs(l/Math.tan((e.fitFOV||this._fitFOV)*c.DEGTORAD)):h=c.lenVec3(c.subVec3(i.eye,i.look,sA)),c.mulVec3Scalar(ms,h),i.eye=c.addVec3(n,ms,sA),i.look=n,this.scene.camera.ortho.scale=l*1.1}else(o||n||a)&&(o&&(i.eye=o),n&&(i.look=n),a&&(i.up=a));e.projection&&(i.projection=e.projection)}_update(){if(!this._flying)return;let i=(Date.now()-this._time1)/(this._time2-this._time1);const s=i>=1;i>1&&(i=1);const t=this.easing?bs._ease(i,0,1,1):i,o=this.scene.camera;if(this._flyingEye||this._flyingLook?this._flyingEye?(c.subVec3(o.eye,o.look,ms),o.eye=c.lerpVec3(t,0,1,this._eye1,this._eye2,oA),o.look=c.subVec3(oA,ms,rA)):this._flyingLook&&(o.look=c.lerpVec3(t,0,1,this._look1,this._look2,rA),o.up=c.lerpVec3(t,0,1,this._up1,this._up2,ou)):this._flyingEyeLookUp&&(o.eye=c.lerpVec3(t,0,1,this._eye1,this._eye2,oA),o.look=c.lerpVec3(t,0,1,this._look1,this._look2,rA),o.up=c.lerpVec3(t,0,1,this._up1,this._up2,ou)),this._projection2){const n=this._projection2==="ortho"?bs._easeOutExpo(i,0,1,1):bs._easeInCubic(i,0,1,1);o.customProjection.matrix=c.lerpMat4(n,0,1,this._projMatrix1,this._projMatrix2)}else o.ortho.scale=this._orthoScale1+i*(this._orthoScale2-this._orthoScale1);if(s){o.ortho.scale=this._orthoScale2,this.stop();return}xt.scheduleTask(this._update,this)}static _ease(e,i,s,t){return e/=t,-s*e*(e-2)+i}static _easeInCubic(e,i,s,t){return e/=t,s*e*e*e+i}static _easeOutExpo(e,i,s,t){return s*(-Math.pow(2,-10*e/t)+1)+i}stop(){if(!this._flying)return;this._flying=!1,this._time1=null,this._time2=null,this._projection2&&(this.scene.camera.projection=this._projection2);const e=this._callback;e&&(this._callback=null,this._callbackScope?e.call(this._callbackScope):e()),this.fire("stopped",!0,!0)}cancel(){this._flying&&(this._flying=!1,this._time1=null,this._time2=null,this._callback&&(this._callback=null),this.fire("canceled",!0,!0))}set duration(e){this._duration=e?e*1e3:500,this.stop()}get duration(){return this._duration/1e3}set fit(e){this._fit=e!==!1}get fit(){return this._fit}set fitFOV(e){this._fitFOV=e||45}get fitFOV(){return this._fitFOV}set trail(e){this._trail=!!e}get trail(){return this._trail}destroy(){this.stop(),super.destroy()}}class Xt extends Et{get type(){return"CameraPathAnimation"}constructor(e,i={}){super(e,i),this._cameraFlightAnimation=new bs(this),this._t=0,this.state=Xt.SCRUBBING,this._playingFromT=0,this._playingToT=0,this._playingRate=i.playingRate||1,this._playingDir=1,this._lastTime=null,this.cameraPath=i.cameraPath,this._tick=this.scene.on("tick",this._updateT,this)}_updateT(){const e=this._cameraPath;if(!e)return;let i,s;const t=performance.now(),o=this._lastTime?(t-this._lastTime)*.001:0;if(this._lastTime=t,o!==0)switch(this.state){case Xt.SCRUBBING:return;case Xt.PLAYING:if(this._t+=this._playingRate*o,i=this._cameraPath.frames.length,i===0||this._playingDir<0&&this._t<=0||this._playingDir>0&&this._t>=this._cameraPath.frames[i-1].t){this.state=Xt.SCRUBBING,this._t=this._cameraPath.frames[i-1].t,this.fire("stopped");return}e.loadFrame(this._t);break;case Xt.PLAYING_TO:s=this._t+this._playingRate*o*this._playingDir,(this._playingDir<0&&s<=this._playingToT||this._playingDir>0&&s>=this._playingToT)&&(s=this._playingToT,this.state=Xt.SCRUBBING,this.fire("stopped")),this._t=s,e.loadFrame(this._t);break}}_ease(e,i,s,t){return e/=t,-s*e*(e-2)+i}set cameraPath(e){this._cameraPath=e}get cameraPath(){return this._cameraPath}set rate(e){this._playingRate=e}get rate(){return this._playingRate}play(){this._cameraPath&&(this._lastTime=null,this.state=Xt.PLAYING)}playToT(e){this._cameraPath&&(this._playingFromT=this._t,this._playingToT=e,this._playingDir=this._playingToT-this._playingFromT<0?-1:1,this._lastTime=null,this.state=Xt.PLAYING_TO)}playToFrame(e){const i=this._cameraPath;if(!i)return;const s=i.frames[e];if(!s){this.error("playToFrame - frame index out of range: "+e);return}this.playToT(s.t)}flyToFrame(e,i){const s=this._cameraPath;if(!s)return;const t=s.frames[e];if(!t){this.error("flyToFrame - frame index out of range: "+e);return}this.state=Xt.SCRUBBING,this._cameraFlightAnimation.flyTo(t,i)}scrubToT(e){const i=this._cameraPath;!i||!this.scene.camera||(this._t=e,i.loadFrame(this._t),this.state=Xt.SCRUBBING)}scrubToFrame(e){const i=this._cameraPath;if(!i||!this.scene.camera)return;if(!i.frames[e]){this.error("playToFrame - frame index out of range: "+e);return}i.loadFrame(this._t),this.state=Xt.SCRUBBING}stop(){this.state=Xt.SCRUBBING,this.fire("stopped")}destroy(){super.destroy(),this.scene.off(this._tick)}}Xt.STOPPED=0;Xt.SCRUBBING=1;Xt.PLAYING=2;Xt.PLAYING_TO=3;c.vec3();c.vec3();c.vec3();c.vec3([0,-1,0]);c.vec4([0,0,0,1]);c.vec3();c.vec3();const Uy=c.vec4(),Oy=c.vec4(),nA=c.vec3(),nu=c.vec3(),ky=c.vec3(),au=c.vec4(),Ny=c.vec4(),Au=c.vec4();class Qy{constructor(e){this._scene=e}dollyToCanvasPos(e,i,s){let t=!1;const o=this._scene.camera;if(e){const n=c.subVec3(e,o.eye,nA);t=c.lenVec3(n)<s}if(o.projection==="perspective"){o.ortho.scale=o.ortho.scale-s;const n=this._unproject(i,au),a=c.subVec3(n,o.eye,Au),A=c.mulVec3Scalar(c.normalizeVec3(a),-s,[]);if(o.eye=[o.eye[0]-A[0],o.eye[1]-A[1],o.eye[2]-A[2]],o.look=[o.look[0]-A[0],o.look[1]-A[1],o.look[2]-A[2]],e){const l=c.subVec3(e,o.eye,nA),h=c.lenVec3(l),d=c.mulVec3Scalar(c.normalizeVec3(c.subVec3(o.look,o.eye,nu)),h);o.look=[o.eye[0]+d[0],o.eye[1]+d[1],o.eye[2]+d[2]]}}else if(o.projection==="ortho"){const n=this._unproject(i,au);o.ortho.scale=o.ortho.scale-s,o.ortho._update();const a=this._unproject(i,Ny),A=c.subVec3(a,n,Au),l=c.mulVec3Scalar(c.normalizeVec3(c.subVec3(o.look,o.eye,nA)),-s,nu),h=c.addVec3(A,l,ky);o.eye=[o.eye[0]-h[0],o.eye[1]-h[1],o.eye[2]-h[2]],o.look=[o.look[0]-h[0],o.look[1]-h[1],o.look[2]-h[2]]}return t}_unproject(e,i){const s=this._scene.camera,t=s.project.transposedMatrix,o=t.subarray(8,12),n=t.subarray(12),a=[0,0,-1,1],A=c.dotVec4(a,o)/c.dotVec4(a,n);return s.project.unproject(e,A,Uy,Oy,i),i}destroy(){}}const lu=c.vec3(),cu=c.vec3(),Hy=c.vec3(),Vy=c.vec4(),jy=c.vec4(),Gy=c.vec4();class zy{constructor(e,i){this._scene=e,this._configs=i,this._pivotWorldPos=c.vec3(),this._cameraOffset=c.vec3(),this._azimuth=0,this._polar=0,this._radius=0,this._pivotPosSet=!1,this._pivoting=!1,this._shown=!1,this._pivotSphereEnabled=!1,this._pivotSphere=null,this._pivotSphereSize=1,this._pivotSphereGeometry=null,this._pivotSphereMaterial=null,this._rtcCenter=c.vec3(),this._rtcPos=c.vec3(),this._pivotViewPos=c.vec4(),this._pivotProjPos=c.vec4(),this._pivotCanvasPos=c.vec2(),this._cameraDirty=!0,this._onViewMatrix=this._scene.camera.on("viewMatrix",()=>{this._cameraDirty=!0}),this._onProjMatrix=this._scene.camera.on("projMatrix",()=>{this._cameraDirty=!0}),this._onTick=this._scene.on("tick",()=>{this.updatePivotElement(),this.updatePivotSphere()})}createPivotSphere(){const e=this.getPivotPos(),i=c.vec3();c.decomposeMat4(c.inverseMat4(this._scene.viewer.camera.viewMatrix,c.mat4()),i,c.vec4(),c.vec3());const s=c.distVec3(i,e);let t=Math.tan(Math.PI/500)*s*this._pivotSphereSize;this._scene.camera.projection=="ortho"&&(t/=this._scene.camera.ortho.scale/2),hc(e,this._rtcCenter,this._rtcPos),this._pivotSphereGeometry=new w0(this._scene,x0({radius:t})),this._pivotSphere=new B0(this._scene,{geometry:this._pivotSphereGeometry,material:this._pivotSphereMaterial,pickable:!1,position:this._rtcPos,rtcCenter:this._rtcCenter})}destroyPivotSphere(){this._pivotSphere&&(this._pivotSphere.destroy(),this._pivotSphere=null),this._pivotSphereGeometry&&(this._pivotSphereGeometry.destroy(),this._pivotSphereGeometry=null)}updatePivotElement(){const e=this._scene.camera,i=this._scene.canvas;if(this._pivoting&&this._cameraDirty){c.transformPoint3(e.viewMatrix,this.getPivotPos(),this._pivotViewPos),this._pivotViewPos[3]=1,c.transformPoint4(e.projMatrix,this._pivotViewPos,this._pivotProjPos);const s=i.boundary,t=s[2],o=s[3];this._pivotCanvasPos[0]=Math.floor((1+this._pivotProjPos[0]/this._pivotProjPos[3])*t/2),this._pivotCanvasPos[1]=Math.floor((1-this._pivotProjPos[1]/this._pivotProjPos[3])*o/2);let n=i._lastBoundingClientRect;if(!n||i._canvasSizeChanged){const a=i.canvas;n=i._lastBoundingClientRect=a.getBoundingClientRect()}this._pivotElement&&(this._pivotElement.style.left=Math.floor(n.left+this._pivotCanvasPos[0])-this._pivotElement.clientWidth/2+window.scrollX+"px",this._pivotElement.style.top=Math.floor(n.top+this._pivotCanvasPos[1])-this._pivotElement.clientHeight/2+window.scrollY+"px"),this._cameraDirty=!1}}updatePivotSphere(){this._pivoting&&this._pivotSphere&&(hc(this.getPivotPos(),this._rtcCenter,this._rtcPos),c.compareVec3(this._rtcPos,this._pivotSphere.position)||(this.destroyPivotSphere(),this.createPivotSphere()))}setPivotElement(e){this._pivotElement=e}enablePivotSphere(e={}){this.destroyPivotSphere(),this._pivotSphereEnabled=!0,e.size&&(this._pivotSphereSize=e.size);const i=e.color||[1,0,0];this._pivotSphereMaterial=new pp(this._scene,{emissive:i,ambient:i,specular:[0,0,0],diffuse:[0,0,0]})}disablePivotSphere(){this.destroyPivotSphere(),this._pivotSphereEnabled=!1}startPivot(){if(this._cameraLookingDownwards())return this._pivoting=!1,!1;const e=this._scene.camera;let i=c.lookAtMat4v(e.eye,e.look,e.worldUp);c.transformPoint3(i,this.getPivotPos(),this._cameraOffset);const s=this.getPivotPos();this._cameraOffset[2]+=c.distVec3(e.eye,s),i=c.inverseMat4(i);const t=c.transformVec3(i,this._cameraOffset),o=c.vec3();if(c.subVec3(e.eye,s,o),c.addVec3(o,t),e.zUp){const n=o[1];o[1]=o[2],o[2]=n}this._radius=c.lenVec3(o),this._polar=Math.acos(o[1]/this._radius),this._azimuth=Math.atan2(o[0],o[2]),this._pivoting=!0}_cameraLookingDownwards(){const e=this._scene.camera,i=c.normalizeVec3(c.subVec3(e.look,e.eye,lu)),s=c.cross3Vec3(i,e.worldUp,cu);return c.sqLenVec3(s)<=1e-4}getPivoting(){return this._pivoting}setPivotPos(e){this._pivotWorldPos.set(e),this._pivotPosSet=!0}setCanvasPivotPos(e){const i=this._scene.camera,s=Math.abs(c.distVec3(this._scene.center,i.eye)),t=i.project.transposedMatrix,o=t.subarray(8,12),n=t.subarray(12),a=[0,0,-1,1],A=c.dotVec4(a,o)/c.dotVec4(a,n),l=Vy;i.project.unproject(e,A,jy,Gy,l);const h=c.normalizeVec3(c.subVec3(l,i.eye,lu)),d=c.addVec3(i.eye,c.mulVec3Scalar(h,s,cu),Hy);this.setPivotPos(d)}getPivotPos(){return this._pivotPosSet?this._pivotWorldPos:this._scene.camera.look}continuePivot(e,i){if(!this._pivoting||e===0&&i===0)return;const s=this._scene.camera;var t=-e;const o=-i;s.worldUp[2]===1&&(t=-t),this._azimuth+=-t*.01,this._polar+=o*.01,this._polar=c.clamp(this._polar,.001,Math.PI-.001);const n=[this._radius*Math.sin(this._polar)*Math.sin(this._azimuth),this._radius*Math.cos(this._polar),this._radius*Math.sin(this._polar)*Math.cos(this._azimuth)];if(s.worldUp[2]===1){const f=n[1];n[1]=n[2],n[2]=f}const a=c.lenVec3(c.subVec3(s.look,s.eye,c.vec3())),A=this.getPivotPos();c.addVec3(n,A);let l=c.lookAtMat4v(n,A,s.worldUp);l=c.inverseMat4(l);const h=c.transformVec3(l,this._cameraOffset);l[12]-=h[0],l[13]-=h[1],l[14]-=h[2];const d=[l[8],l[9],l[10]];s.eye=[l[12],l[13],l[14]],c.subVec3(s.eye,c.mulVec3Scalar(d,a),s.look),s.up=[l[4],l[5],l[6]],this.showPivot()}showPivot(){this._shown||(this._pivotElement&&(this.updatePivotElement(),this._pivotElement.style.visibility="visible"),this._pivotSphereEnabled&&(this.destroyPivotSphere(),this.createPivotSphere()),this._shown=!0)}hidePivot(){this._shown&&(this._pivotElement&&(this._pivotElement.style.visibility="hidden"),this._pivotSphereEnabled&&this.destroyPivotSphere(),this._shown=!1)}endPivot(){this._pivoting=!1}destroy(){this.destroyPivotSphere(),this._scene.camera.off(this._onViewMatrix),this._scene.camera.off(this._onProjMatrix),this._scene.off(this._onTick)}}class Ky{constructor(e,i){this._scene=e.scene,this._cameraControl=e,this._scene.canvas.canvas.oncontextmenu=function(s){s.preventDefault()},this._configs=i,this.schedulePickEntity=!1,this.schedulePickSurface=!1,this.scheduleSnapOrPick=!1,this.pickCursorPos=c.vec2(),this.picked=!1,this.pickedSurface=!1,this.pickResult=null,this._lastPickedEntityId=null,this._lastHash=null,this._needFireEvents=0}update(){if(!this._configs.pointerEnabled||!this.schedulePickEntity&&!this.schedulePickSurface)return;const e=`${~~this.pickCursorPos[0]}-${~~this.pickCursorPos[1]}-${this.scheduleSnapOrPick}-${this.schedulePickSurface}-${this.schedulePickEntity}`;if(this._lastHash===e)return;this.picked=!1,this.pickedSurface=!1,this.snappedOrPicked=!1,this.hoveredSnappedOrSurfaceOff=!1;const i=this._cameraControl.hasSubs("hoverSurface");if(this.scheduleSnapOrPick){const s=this._scene.pick({canvasPos:this.pickCursorPos,snapRadius:this._configs.snapRadius,snapToVertex:this._configs.snapToVertex,snapToEdge:this._configs.snapToEdge});s&&(s.snappedToEdge||s.snappedToVertex)?(this.snapPickResult=s,this.snappedOrPicked=!0,this._needFireEvents++):(this.schedulePickSurface=!0,this.snapPickResult=null)}if(this.schedulePickSurface&&this.pickResult&&this.pickResult.worldPos){const s=this.pickResult.canvasPos;if(s[0]===this.pickCursorPos[0]&&s[1]===this.pickCursorPos[1]){this.picked=!0,this.pickedSurface=!0,this._needFireEvents+=i?1:0,this.schedulePickEntity=!1,this.schedulePickSurface=!1,this.scheduleSnapOrPick?this.snappedOrPicked=!0:this.hoveredSnappedOrSurfaceOff=!0,this.scheduleSnapOrPick=!1;return}}if(this.schedulePickEntity&&this.pickResult&&(this.pickResult.canvasPos||this.pickResult.snappedCanvasPos)){const s=this.pickResult.canvasPos||this.pickResult.snappedCanvasPos;if(s[0]===this.pickCursorPos[0]&&s[1]===this.pickCursorPos[1]){this.picked=!0,this.pickedSurface=!1,this.schedulePickEntity=!1,this.schedulePickSurface=!1;return}}this.schedulePickSurface||this.scheduleSnapOrPick&&!this.snapPickResult?(this.pickResult=this._scene.pick({pickSurface:!0,pickSurfaceNormal:!1,canvasPos:this.pickCursorPos}),this.pickResult?(this.picked=!0,this.scheduleSnapOrPick?this.snappedOrPicked=!0:this.pickedSurface=!0,this._needFireEvents++):this.scheduleSnapOrPick&&(this.hoveredSnappedOrSurfaceOff=!0,this._needFireEvents++)):(this.pickResult=this._scene.pick({canvasPos:this.pickCursorPos}),this.pickResult&&(this.picked=!0,this.pickedSurface=!1,this._needFireEvents++)),this.scheduleSnapOrPick=!1,this.schedulePickEntity=!1,this.schedulePickSurface=!1}fireEvents(){if(this._needFireEvents!==0){if(this.hoveredSnappedOrSurfaceOff&&this._cameraControl.fire("hoverSnapOrSurfaceOff",{canvasPos:this.pickCursorPos,pointerPos:this.pickCursorPos},!0),this.snappedOrPicked)if(this.snapPickResult){const e=new UA;e.entity=this.snapPickResult.entity,e.snappedToVertex=this.snapPickResult.snappedToVertex,e.snappedToEdge=this.snapPickResult.snappedToEdge,e.worldPos=this.snapPickResult.worldPos,e.canvasPos=this.pickCursorPos,e.snappedCanvasPos=this.snapPickResult.snappedCanvasPos,this._cameraControl.fire("hoverSnapOrSurface",e,!0),this.snapPickResult=null}else this._cameraControl.fire("hoverSnapOrSurface",this.pickResult,!0);if(this.picked&&this.pickResult&&(this.pickResult.entity||this.pickResult.worldPos)){if(this.pickResult.entity){const e=this.pickResult.entity.id;this._lastPickedEntityId!==e&&(this._lastPickedEntityId!==void 0&&this._cameraControl.fire("hoverOut",{entity:this._scene.objects[this._lastPickedEntityId]},!0),this._cameraControl.fire("hoverEnter",this.pickResult,!0),this._lastPickedEntityId=e)}this._cameraControl.fire("hover",this.pickResult,!0),this.pickResult.worldPos&&(this.pickedSurface=!0,this._cameraControl.fire("hoverSurface",this.pickResult,!0))}else this._lastPickedEntityId!==void 0&&(this._cameraControl.fire("hoverOut",{entity:this._scene.objects[this._lastPickedEntityId]},!0),this._lastPickedEntityId=void 0),this._cameraControl.fire("hoverOff",{canvasPos:this.pickCursorPos},!0);this.pickResult=null,this._needFireEvents=0}}}const Go=c.vec2(),Wy=function(r,e){if(!r)r=window.event,e[0]=r.x,e[1]=r.y;else{let i=r.target,s=0,t=0,o=0,n=0;for(;i.offsetParent;)s+=i.offsetLeft,t+=i.offsetTop,o+=i.scrollLeft,n+=i.scrollTop,i=i.offsetParent;e[0]=r.pageX+o-s,e[1]=r.pageY+n-t}return e};class Xy{constructor(e,i,s,t,o){this._scene=e;const n=i.pickController;let a=0,A=0,l=0,h=0,d,f,m,_=!1;const u=c.vec3();let P=!0;const y=this._scene.canvas.canvas,x=[];document.addEventListener("keydown",this._documentKeyDownHandler=S=>{if(!(s.active&&s.pointerEnabled)||!e.input.keyboardEnabled)return;const R=S.keyCode;x[R]=!0}),document.addEventListener("keyup",this._documentKeyUpHandler=S=>{if(!(s.active&&s.pointerEnabled)||!e.input.keyboardEnabled)return;const R=S.keyCode;x[R]=!1});function B(S=!0){y.style.cursor="move",v(),S&&w()}function v(){a=t.pointerCanvasPos[0],A=t.pointerCanvasPos[1],l=t.pointerCanvasPos[0],h=t.pointerCanvasPos[1]}function w(){n.pickCursorPos=t.pointerCanvasPos,n.schedulePickSurface=!0,n.update(),n.picked&&n.pickedSurface&&n.pickResult&&n.pickResult.worldPos?(_=!0,u.set(n.pickResult.worldPos)):_=!1}y.addEventListener("mousedown",this._mouseDownHandler=S=>{if(s.active&&s.pointerEnabled)switch(S.which){case 1:x[e.input.KEY_SHIFT]||s.planView?(d=!0,B()):(d=!0,B(!1));break;case 2:f=!0,B();break;case 3:m=!0,s.panRightClick&&B();break}}),document.addEventListener("mousemove",this._documentMouseMoveHandler=S=>{if(!(s.active&&s.pointerEnabled)||!d&&!f&&!m)return;const R=e.canvas.boundary,D=R[2],K=R[3],G=t.pointerCanvasPos[0],z=t.pointerCanvasPos[1],le=x[e.input.KEY_SHIFT]||s.planView||!s.panRightClick&&f||s.panRightClick&&m,ue=document.pointerLockElement?S.movementX:G-a,ae=document.pointerLockElement?S.movementY:z-A;if(le){const Pe=e.camera;if(Pe.projection==="perspective"){const xe=Math.abs(_?c.lenVec3(c.subVec3(u,e.camera.eye,[])):e.camera.eyeLookDist)*Math.tan(Pe.perspective.fov/2*Math.PI/180);o.panDeltaX+=1.5*ue*xe/K,o.panDeltaY+=1.5*ae*xe/K}else o.panDeltaX+=.5*Pe.ortho.scale*(ue/K),o.panDeltaY+=.5*Pe.ortho.scale*(ae/K)}else d&&!f&&!m&&(s.planView||(s.firstPerson?(o.rotateDeltaY-=ue/D*s.dragRotationRate/2,o.rotateDeltaX+=ae/K*(s.dragRotationRate/4)):(o.rotateDeltaY-=ue/D*(s.dragRotationRate*1.5),o.rotateDeltaX+=ae/K*(s.dragRotationRate*1.5))));a=G,A=z}),y.addEventListener("mousemove",this._canvasMouseMoveHandler=S=>{s.active&&s.pointerEnabled&&t.mouseover&&(P=!0)}),document.addEventListener("mouseup",this._documentMouseUpHandler=S=>{if(s.active&&s.pointerEnabled)switch(S.which){case 1:d=!1,f=!1,m=!1;break;case 2:d=!1,f=!1,m=!1;break;case 3:d=!1,f=!1,m=!1;break}}),y.addEventListener("mouseup",this._mouseUpHandler=S=>{if(s.active&&s.pointerEnabled){switch(S.which){case 3:Wy(S,Go);const R=Go[0],D=Go[1];Math.abs(R-l)<3&&Math.abs(D-h)<3&&i.cameraControl.fire("rightClick",{pagePos:[Math.round(S.pageX),Math.round(S.pageY)],canvasPos:Go,event:S},!0);break}y.style.removeProperty("cursor")}}),y.addEventListener("mouseenter",this._mouseEnterHandler=()=>{s.active&&s.pointerEnabled});const C=1/20,I=1/60;let E=null;y.addEventListener("wheel",this._mouseWheelHandler=S=>{if(!(s.active&&s.pointerEnabled))return;const R=performance.now()/1e3;var D=E!==null?R-E:0;E=R,D>C&&(D=C),D<I&&(D=I);const K=Math.max(-1,Math.min(1,-S.deltaY*40));if(K===0)return;const G=K/Math.abs(K);o.dollyDelta+=-G*D*s.mouseWheelDollyRate,P&&(t.followPointerDirty=!0,P=!1)},{passive:!0})}reset(){}destroy(){const e=this._scene.canvas.canvas;document.removeEventListener("keydown",this._documentKeyDownHandler),document.removeEventListener("keyup",this._documentKeyUpHandler),e.removeEventListener("mousedown",this._mouseDownHandler),document.removeEventListener("mousemove",this._documentMouseMoveHandler),e.removeEventListener("mousemove",this._canvasMouseMoveHandler),document.removeEventListener("mouseup",this._documentMouseUpHandler),e.removeEventListener("mouseup",this._mouseUpHandler),e.removeEventListener("mouseenter",this._mouseEnterHandler),e.removeEventListener("wheel",this._mouseWheelHandler)}}const ni=c.vec3(),Qs=c.vec3(),hu=c.vec3(),Yy=c.vec3(),Hs=c.vec3(),Tt={eye:c.vec3(),look:c.vec3(),up:c.vec3()};class $y{constructor(e,i,s,t){this._scene=e;const o=i.cameraControl,n=e.camera;this._onSceneKeyDown=e.input.on("keydown",()=>{if(!(s.active&&s.pointerEnabled)||!e.input.keyboardEnabled||!t.mouseover)return;const a=o._isKeyDownForAction(o.AXIS_VIEW_RIGHT),A=o._isKeyDownForAction(o.AXIS_VIEW_BACK),l=o._isKeyDownForAction(o.AXIS_VIEW_LEFT),h=o._isKeyDownForAction(o.AXIS_VIEW_FRONT),d=o._isKeyDownForAction(o.AXIS_VIEW_TOP),f=o._isKeyDownForAction(o.AXIS_VIEW_BOTTOM);if(!a&&!A&&!l&&!h&&!d&&!f)return;const m=e.aabb,_=c.getAABB3Diag(m);c.getAABB3Center(m,ni);const u=Math.abs(_/Math.tan(i.cameraFlight.fitFOV*c.DEGTORAD)),P=_*1.1;Tt.orthoScale=P,a?(Tt.eye.set(c.addVec3(ni,c.mulVec3Scalar(n.worldRight,u,Qs),Hs)),Tt.look.set(ni),Tt.up.set(n.worldUp)):A?(Tt.eye.set(c.addVec3(ni,c.mulVec3Scalar(n.worldForward,u,Qs),Hs)),Tt.look.set(ni),Tt.up.set(n.worldUp)):l?(Tt.eye.set(c.addVec3(ni,c.mulVec3Scalar(n.worldRight,-u,Qs),Hs)),Tt.look.set(ni),Tt.up.set(n.worldUp)):h?(Tt.eye.set(c.addVec3(ni,c.mulVec3Scalar(n.worldForward,-u,Qs),Hs)),Tt.look.set(ni),Tt.up.set(n.worldUp)):d?(Tt.eye.set(c.addVec3(ni,c.mulVec3Scalar(n.worldUp,u,Qs),Hs)),Tt.look.set(ni),Tt.up.set(c.normalizeVec3(c.mulVec3Scalar(n.worldForward,1,hu),Yy))):f&&(Tt.eye.set(c.addVec3(ni,c.mulVec3Scalar(n.worldUp,-u,Qs),Hs)),Tt.look.set(ni),Tt.up.set(c.normalizeVec3(c.mulVec3Scalar(n.worldForward,-1,hu)))),!s.firstPerson&&s.followPointer&&i.pivotController.setPivotPos(ni),i.cameraFlight.duration>0?i.cameraFlight.flyTo(Tt,()=>{i.pivotController.getPivoting()&&s.followPointer&&i.pivotController.showPivot()}):(i.cameraFlight.jumpTo(Tt),i.pivotController.getPivoting()&&s.followPointer&&i.pivotController.showPivot())})}reset(){}destroy(){this._scene.input.off(this._onSceneKeyDown)}}class Zy{constructor(e,i,s,t,o){this._scene=e;const n=i.pickController,a=i.pivotController,A=i.cameraControl;this._clicks=0,this._timeout=null,this._lastPickedEntityId=null;let l=!1,h=!1;const d=this._scene.canvas.canvas,f=_=>{let u;_&&_.worldPos&&(u=_.worldPos);const P=_&&_.entity?_.entity.aabb:e.aabb;if(u){const y=e.camera;c.subVec3(y.eye,y.look,[]),i.cameraFlight.flyTo({aabb:P})}else i.cameraFlight.flyTo({aabb:P})},m=e.tickify(this._canvasMouseMoveHandler=_=>{if(!(s.active&&s.pointerEnabled)||l||h)return;const u=A.hasSubs("hover"),P=A.hasSubs("hoverEnter"),y=A.hasSubs("hoverOut"),x=A.hasSubs("hoverOff"),B=A.hasSubs("hoverSurface"),v=A.hasSubs("hoverSnapOrSurface");if(u||P||y||x||B||v)if(n.pickCursorPos=t.pointerCanvasPos,n.schedulePickEntity=!0,n.schedulePickSurface=B,n.scheduleSnapOrPick=v,n.update(),n.pickResult){if(n.pickResult.entity){const w=n.pickResult.entity.id;this._lastPickedEntityId!==w&&(this._lastPickedEntityId!==void 0&&A.fire("hoverOut",{entity:e.objects[this._lastPickedEntityId]},!0),A.fire("hoverEnter",n.pickResult,!0),this._lastPickedEntityId=w)}A.fire("hover",n.pickResult,!0),(n.pickResult.worldPos||n.pickResult.snappedWorldPos)&&A.fire("hoverSurface",n.pickResult,!0)}else this._lastPickedEntityId!==void 0&&(A.fire("hoverOut",{entity:e.objects[this._lastPickedEntityId]},!0),this._lastPickedEntityId=void 0),A.fire("hoverOff",{canvasPos:n.pickCursorPos},!0)});d.addEventListener("mousemove",m),d.addEventListener("mousedown",this._canvasMouseDownHandler=_=>{if(_.which===1&&(l=!0),_.which===3&&(h=!0),_.which===1&&s.active&&s.pointerEnabled&&(t.mouseDownClientX=_.clientX,t.mouseDownClientY=_.clientY,t.mouseDownCursorX=t.pointerCanvasPos[0],t.mouseDownCursorY=t.pointerCanvasPos[1],!s.firstPerson&&s.followPointer&&(n.pickCursorPos=t.pointerCanvasPos,n.schedulePickSurface=!0,n.update(),_.which===1))){const P=n.pickResult;P&&P.worldPos?(a.setPivotPos(P.worldPos),a.startPivot()):(s.smartPivot?a.setCanvasPivotPos(t.pointerCanvasPos):a.setPivotPos(e.camera.look),a.startPivot())}}),document.addEventListener("mouseup",this._documentMouseUpHandler=_=>{_.which===1&&(l=!1),_.which===3&&(h=!1),a.getPivoting()&&a.endPivot()}),d.addEventListener("mouseup",this._canvasMouseUpHandler=_=>{if(!(s.active&&s.pointerEnabled)||!(_.which===1)||(a.hidePivot(),Math.abs(_.clientX-t.mouseDownClientX)>3||Math.abs(_.clientY-t.mouseDownClientY)>3))return;const P=A.hasSubs("picked"),y=A.hasSubs("pickedNothing"),x=A.hasSubs("pickedSurface"),B=A.hasSubs("doublePicked"),v=A.hasSubs("doublePickedSurface"),w=A.hasSubs("doublePickedNothing");if(!s.doublePickFlyTo&&!B&&!v&&!w){(P||y||x)&&(n.pickCursorPos=t.pointerCanvasPos,n.schedulePickEntity=!0,n.schedulePickSurface=x,n.update(),n.pickResult?(A.fire("picked",n.pickResult,!0),n.pickedSurface&&A.fire("pickedSurface",n.pickResult,!0)):A.fire("pickedNothing",{canvasPos:t.pointerCanvasPos},!0)),this._clicks=0;return}if(this._clicks++,this._clicks===1){n.pickCursorPos=t.pointerCanvasPos,n.schedulePickEntity=s.doublePickFlyTo,n.schedulePickSurface=x,n.update();const C=n.pickResult,I=n.pickedSurface;this._timeout=setTimeout(()=>{C?(A.fire("picked",C,!0),I&&(A.fire("pickedSurface",C,!0),!s.firstPerson&&s.followPointer&&(i.pivotController.setPivotPos(C.worldPos),i.pivotController.startPivot()&&i.pivotController.showPivot()))):A.fire("pickedNothing",{canvasPos:t.pointerCanvasPos},!0),this._clicks=0},s.doubleClickTimeFrame)}else{if(this._timeout!==null&&(window.clearTimeout(this._timeout),this._timeout=null),n.pickCursorPos=t.pointerCanvasPos,n.schedulePickEntity=s.doublePickFlyTo||B||v,n.schedulePickSurface=n.schedulePickEntity&&v,n.update(),n.pickResult){if(A.fire("doublePicked",n.pickResult,!0),n.pickedSurface&&A.fire("doublePickedSurface",n.pickResult,!0),s.doublePickFlyTo&&(f(n.pickResult),!s.firstPerson&&s.followPointer)){const C=n.pickResult.entity.aabb,I=c.getAABB3Center(C);i.pivotController.setPivotPos(I),i.pivotController.startPivot()&&i.pivotController.showPivot()}}else if(A.fire("doublePickedNothing",{canvasPos:t.pointerCanvasPos},!0),s.doublePickFlyTo&&(f(),!s.firstPerson&&s.followPointer)){const C=e.aabb,I=c.getAABB3Center(C);i.pivotController.setPivotPos(I),i.pivotController.startPivot()&&i.pivotController.showPivot()}this._clicks=0}},!1)}reset(){this._clicks=0,this._lastPickedEntityId=null,this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null)}destroy(){const e=this._scene.canvas.canvas;e.removeEventListener("mousemove",this._canvasMouseMoveHandler),e.removeEventListener("mousedown",this._canvasMouseDownHandler),document.removeEventListener("mouseup",this._documentMouseUpHandler),e.removeEventListener("mouseup",this._canvasMouseUpHandler),this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null)}}class qy{constructor(e,i,s,t,o){this._scene=e;const n=e.input,a=[],A=e.canvas.canvas;let l=!0;this._onSceneMouseMove=n.on("mousemove",()=>{l=!0}),this._onSceneKeyDown=n.on("keydown",h=>{!(s.active&&s.pointerEnabled)||!e.input.keyboardEnabled||t.mouseover&&(a[h]=!0,h===n.KEY_SHIFT&&(A.style.cursor="move"))}),this._onSceneKeyUp=n.on("keyup",h=>{!(s.active&&s.pointerEnabled)||!e.input.keyboardEnabled||(a[h]=!1,h===n.KEY_SHIFT&&(A.style.cursor=null),i.pivotController.getPivoting()&&i.pivotController.endPivot())}),this._onTick=e.on("tick",h=>{if(!(s.active&&s.pointerEnabled)||!e.input.keyboardEnabled||!t.mouseover)return;const d=i.cameraControl,f=h.deltaTime/1e3;if(!s.planView){const v=d._isKeyDownForAction(d.ROTATE_Y_POS,a),w=d._isKeyDownForAction(d.ROTATE_Y_NEG,a),C=d._isKeyDownForAction(d.ROTATE_X_POS,a),I=d._isKeyDownForAction(d.ROTATE_X_NEG,a),E=f*s.keyboardRotationRate;(v||w||C||I)&&(!s.firstPerson&&s.followPointer&&i.pivotController.startPivot(),v?o.rotateDeltaY+=E:w&&(o.rotateDeltaY-=E),C?o.rotateDeltaX+=E:I&&(o.rotateDeltaX-=E),!s.firstPerson&&s.followPointer&&i.pivotController.startPivot())}if(!a[n.KEY_CTRL]&&!a[n.KEY_ALT]){const v=d._isKeyDownForAction(d.DOLLY_BACKWARDS,a),w=d._isKeyDownForAction(d.DOLLY_FORWARDS,a);if(v||w){const C=f*s.keyboardDollyRate;!s.firstPerson&&s.followPointer&&i.pivotController.startPivot(),w?o.dollyDelta-=C:v&&(o.dollyDelta+=C),l&&(t.followPointerDirty=!0,l=!1)}}const m=d._isKeyDownForAction(d.PAN_FORWARDS,a),_=d._isKeyDownForAction(d.PAN_BACKWARDS,a),u=d._isKeyDownForAction(d.PAN_LEFT,a),P=d._isKeyDownForAction(d.PAN_RIGHT,a),y=d._isKeyDownForAction(d.PAN_UP,a),x=d._isKeyDownForAction(d.PAN_DOWN,a),B=(a[n.KEY_ALT]?.3:1)*f*s.keyboardPanRate;(m||_||u||P||y||x)&&(!s.firstPerson&&s.followPointer&&i.pivotController.startPivot(),x?o.panDeltaY+=B:y&&(o.panDeltaY+=-B),P?o.panDeltaX+=-B:u&&(o.panDeltaX+=B),_?o.panDeltaZ+=B:m&&(o.panDeltaZ+=-B))})}reset(){}destroy(){this._scene.off(this._onTick),this._scene.input.off(this._onSceneMouseMove),this._scene.input.off(this._onSceneKeyDown),this._scene.input.off(this._onSceneKeyUp)}}const uu=1,Vs=.001,Jy=c.vec3();class ex{constructor(e,i,s,t,o){this._scene=e;const n=e.camera,a=i.pickController,A=i.pivotController,l=i.panController;let h=uu,d=1,f=null;this._onTick=e.on("tick",()=>{if(!(s.active&&s.pointerEnabled))return;let m="default";Math.abs(o.dollyDelta)<Vs&&(o.dollyDelta=0),Math.abs(o.rotateDeltaX)<Vs&&(o.rotateDeltaX=0),Math.abs(o.rotateDeltaY)<Vs&&(o.rotateDeltaY=0),(o.rotateDeltaX!==0||o.rotateDeltaY!==0)&&(o.dollyDelta=0),s.followPointer?--h<=0&&(h=uu,o.dollyDelta!==0&&(o.rotateDeltaY===0&&o.rotateDeltaX===0&&s.followPointer&&t.followPointerDirty&&(a.pickCursorPos=t.pointerCanvasPos,a.schedulePickSurface=!0,a.update(),a.pickResult&&a.pickResult.worldPos?f=a.pickResult.worldPos:(d=1,f=null),t.followPointerDirty=!1),f&&(d=Math.abs(c.lenVec3(c.subVec3(f,e.camera.eye,Jy)))/s.dollyProximityThreshold),d<s.dollyMinSpeed&&(d=s.dollyMinSpeed))):(d=1,f=null);const _=o.dollyDelta*d;if((o.rotateDeltaY!==0||o.rotateDeltaX!==0)&&(!s.firstPerson&&s.followPointer&&A.getPivoting()?(A.continuePivot(o.rotateDeltaY,o.rotateDeltaX),A.showPivot()):(o.rotateDeltaX!==0&&(s.firstPerson?n.pitch(-o.rotateDeltaX):n.orbitPitch(o.rotateDeltaX)),o.rotateDeltaY!==0&&(s.firstPerson?n.yaw(o.rotateDeltaY):n.orbitYaw(o.rotateDeltaY))),o.rotateDeltaX*=s.rotationInertia,o.rotateDeltaY*=s.rotationInertia,m="grabbing"),Math.abs(o.panDeltaX)<Vs&&(o.panDeltaX=0),Math.abs(o.panDeltaY)<Vs&&(o.panDeltaY=0),Math.abs(o.panDeltaZ)<Vs&&(o.panDeltaZ=0),o.panDeltaX!==0||o.panDeltaY!==0||o.panDeltaZ!==0){const u=c.vec3();u[0]=o.panDeltaX,u[1]=o.panDeltaY,u[2]=o.panDeltaZ;let P,y;if(s.constrainVertical){n.xUp?(P=n.eye[0],y=n.look[0]):n.yUp?(P=n.eye[1],y=n.look[1]):n.zUp&&(P=n.eye[2],y=n.look[2]),n.pan(u);const x=n.eye,B=n.look;n.xUp?(x[0]=P,B[0]=y):n.yUp?(x[1]=P,B[1]=y):n.zUp&&(x[2]=P,B[2]=y),n.eye=x,n.look=B}else n.pan(u);m="grabbing"}if(o.panDeltaX*=s.panInertia,o.panDeltaY*=s.panInertia,o.panDeltaZ*=s.panInertia,_!==0){if(_<0?m="zoom-in":m="zoom-out",s.firstPerson){let u,P;if(s.constrainVertical&&(n.xUp?(u=n.eye[0],P=n.look[0]):n.yUp?(u=n.eye[1],P=n.look[1]):n.zUp&&(u=n.eye[2],P=n.look[2])),s.followPointer?l.dollyToCanvasPos(f,t.pointerCanvasPos,-_)&&(t.followPointerDirty=!0):(n.pan([0,0,_]),n.ortho.scale=n.ortho.scale-_),s.constrainVertical){const y=n.eye,x=n.look;n.xUp?(y[0]=u,x[0]=P):n.yUp?(y[1]=u,x[1]=P):n.zUp&&(y[2]=u,x[2]=P),n.eye=y,n.look=x}}else s.planView,s.followPointer?l.dollyToCanvasPos(f,t.pointerCanvasPos,-_)&&(t.followPointerDirty=!0):(n.ortho.scale=n.ortho.scale+_,n.zoom(_));o.dollyDelta*=s.dollyInertia}a.fireEvents(),document.body.style.cursor=m})}destroy(){this._scene.off(this._onTick)}}class tx{constructor(e,i,s,t,o){this._scene=e;const n=this._scene.canvas.canvas;n.addEventListener("mouseenter",this._mouseEnterHandler=()=>{t.mouseover=!0}),n.addEventListener("mouseleave",this._mouseLeaveHandler=()=>{t.mouseover=!1,n.style.cursor=null}),document.addEventListener("mousemove",this._mouseMoveHandler=a=>{du(a,n,t.pointerCanvasPos)}),n.addEventListener("mousedown",this._mouseDownHandler=a=>{s.active&&s.pointerEnabled&&(du(a,n,t.pointerCanvasPos),t.mouseover=!0)}),n.addEventListener("mouseup",this._mouseUpHandler=a=>{s.active&&s.pointerEnabled})}reset(){}destroy(){const e=this._scene.canvas.canvas;document.removeEventListener("mousemove",this._mouseMoveHandler),e.removeEventListener("mouseenter",this._mouseEnterHandler),e.removeEventListener("mouseleave",this._mouseLeaveHandler),e.removeEventListener("mousedown",this._mouseDownHandler),e.removeEventListener("mouseup",this._mouseUpHandler)}}function du(r,e,i){if(!r)r=window.event,i[0]=r.x,i[1]=r.y;else{const{left:s,top:t}=e.getBoundingClientRect();i[0]=r.clientX-s,i[1]=r.clientY-t}return i}const js=function(r,e){if(!r)r=window.event,e[0]=r.x,e[1]=r.y;else{let i=r.target,s=0,t=0;for(;i.offsetParent;)s+=i.offsetLeft,t+=i.offsetTop,i=i.offsetParent;e[0]=r.pageX-s,e[1]=r.pageY-t}return e};class ix{constructor(e,i,s,t,o){this._scene=e;const n=i.pickController,a=i.pivotController,A=c.vec2(),l=c.vec2(),h=c.vec2(),d=c.vec2(),f=[],m=this._scene.canvas.canvas;let _=0,u=!1;this._onTick=e.on("tick",()=>{u=!1}),m.addEventListener("touchstart",this._canvasTouchStartHandler=P=>{if(!(s.active&&s.pointerEnabled))return;P.preventDefault();const y=P.touches,x=P.changedTouches;for(t.touchStartTime=Date.now(),y.length===1&&x.length===1&&(js(y[0],A),s.followPointer&&(n.pickCursorPos=A,n.schedulePickSurface=!0,n.update(),s.planView||(n.picked&&n.pickedSurface&&n.pickResult&&n.pickResult.worldPos?(a.setPivotPos(n.pickResult.worldPos),!s.firstPerson&&a.startPivot()&&a.showPivot()):(s.smartPivot?a.setCanvasPivotPos(t.pointerCanvasPos):a.setPivotPos(e.camera.look),!s.firstPerson&&a.startPivot()&&a.showPivot()))));f.length<y.length;)f.push(c.vec2());for(let B=0,v=y.length;B<v;++B)js(y[B],f[B]);_=y.length}),m.addEventListener("touchend",this._canvasTouchEndHandler=()=>{a.getPivoting()&&a.endPivot()}),m.addEventListener("touchmove",this._canvasTouchMoveHandler=P=>{if(!(s.active&&s.pointerEnabled)||(P.stopPropagation(),P.preventDefault(),u))return;u=!0;const y=e.canvas.boundary,x=y[2],B=y[3],v=P.touches;if(P.touches.length===_){if(_===1){js(v[0],l),c.subVec2(l,f[0],d);const w=d[0],C=d[1];if(t.longTouchTimeout!==null&&(Math.abs(w)>s.longTapRadius||Math.abs(C)>s.longTapRadius)&&(clearTimeout(t.longTouchTimeout),t.longTouchTimeout=null),s.planView){const I=e.camera;if(I.projection==="perspective"){const S=Math.abs(e.camera.eyeLookDist)*Math.tan(I.perspective.fov/2*Math.PI/180);o.panDeltaX+=w*S/B*s.touchPanRate,o.panDeltaY+=C*S/B*s.touchPanRate}else o.panDeltaX+=.5*I.ortho.scale*(w/B)*s.touchPanRate,o.panDeltaY+=.5*I.ortho.scale*(C/B)*s.touchPanRate}else o.rotateDeltaY-=w/x*(s.dragRotationRate*1),o.rotateDeltaX+=C/B*(s.dragRotationRate*1.5)}else if(_===2){const w=v[0],C=v[1];js(w,l),js(C,h);const I=c.geometricMeanVec2(f[0],f[1]),E=c.geometricMeanVec2(l,h),S=c.vec2();c.subVec2(I,E,S);const R=S[0],D=S[1],K=e.camera,G=c.distVec2([w.pageX,w.pageY],[C.pageX,C.pageY]),le=(c.distVec2(f[0],f[1])-G)*s.touchDollyRate;if(o.dollyDelta=le,Math.abs(le)<1)if(K.projection==="perspective"){const ue=n.pickResult?n.pickResult.worldPos:e.center,Pe=Math.abs(c.lenVec3(c.subVec3(ue,e.camera.eye,[])))*Math.tan(K.perspective.fov/2*Math.PI/180);o.panDeltaX-=R*Pe/B*s.touchPanRate,o.panDeltaY-=D*Pe/B*s.touchPanRate}else o.panDeltaX-=.5*K.ortho.scale*(R/B)*s.touchPanRate,o.panDeltaY-=.5*K.ortho.scale*(D/B)*s.touchPanRate;t.pointerCanvasPos=E}for(let w=0;w<_;++w)js(v[w],f[w])}})}reset(){}destroy(){const e=this._scene.canvas.canvas;e.removeEventListener("touchstart",this._canvasTouchStartHandler),e.removeEventListener("touchend",this._canvasTouchEndHandler),e.removeEventListener("touchmove",this._canvasTouchMoveHandler),this._scene.off(this._onTick)}}const sx=150,rx=325,ox=4,zo=function(r,e){if(!r)r=window.event,e[0]=r.x,e[1]=r.y;else{let i=r.target,s=0,t=0;for(;i.offsetParent;)s+=i.offsetLeft,t+=i.offsetTop,i=i.offsetParent;e[0]=r.pageX-s,e[1]=r.pageY-t}return e};class nx{constructor(e,i,s,t,o){this._scene=e;const n=i.pickController,a=i.cameraControl;let A;const l=[],h=new Float32Array(2);let d=-1,f=-1;const m=this._scene.canvas.canvas,_=u=>{let P;u&&u.worldPos&&(P=u.worldPos);const y=u?u.entity.aabb:e.aabb;if(P){const x=e.camera;c.subVec3(x.eye,x.look,[]),i.cameraFlight.flyTo({aabb:y})}else i.cameraFlight.flyTo({aabb:y})};m.addEventListener("touchstart",this._canvasTouchStartHandler=u=>{if(!(s.active&&s.pointerEnabled))return;t.longTouchTimeout!==null&&(clearTimeout(t.longTouchTimeout),t.longTouchTimeout=null);const P=u.touches,y=u.changedTouches;if(A=Date.now(),P.length===1&&y.length===1){d=A,zo(P[0],h);const x=h[0],B=h[1],v=P[0].pageX,w=P[0].pageY;t.longTouchTimeout=setTimeout(()=>{i.cameraControl.fire("rightClick",{pagePos:[Math.round(v),Math.round(w)],canvasPos:[Math.round(x),Math.round(B)],event:u},!0),t.longTouchTimeout=null},s.longTapTimeout)}else d=-1;for(;l.length<P.length;)l.push(new Float32Array(2));for(let x=0,B=P.length;x<B;++x)zo(P[x],l[x]);l.length=P.length},{passive:!0}),m.addEventListener("touchend",this._canvasTouchEndHandler=u=>{if(!(s.active&&s.pointerEnabled))return;const P=Date.now(),y=u.touches,x=u.changedTouches,B=a.hasSubs("pickedSurface");t.longTouchTimeout!==null&&(clearTimeout(t.longTouchTimeout),t.longTouchTimeout=null),y.length===0&&x.length===1&&d>-1&&P-d<sx&&(f>-1&&d-f<rx?(zo(x[0],n.pickCursorPos),n.schedulePickEntity=!0,n.schedulePickSurface=B,n.update(),n.pickResult?(n.pickResult.touchInput=!0,a.fire("doublePicked",n.pickResult),n.pickedSurface&&a.fire("doublePickedSurface",n.pickResult),s.doublePickFlyTo&&_(n.pickResult)):(a.fire("doublePickedNothing"),s.doublePickFlyTo&&_()),f=-1):c.distVec2(l[0],h)<ox&&(zo(x[0],n.pickCursorPos),n.schedulePickEntity=!0,n.schedulePickSurface=B,n.update(),n.pickResult?(n.pickResult.touchInput=!0,a.fire("picked",n.pickResult),n.pickedSurface&&a.fire("pickedSurface",n.pickResult)):a.fire("pickedNothing"),f=P),d=-1),l.length=y.length;for(let v=0,w=y.length;v<w;++v)l[v][0]=y[v].pageX,l[v][1]=y[v].pageY},{passive:!0})}reset(){}destroy(){const e=this._scene.canvas.canvas;e.removeEventListener("touchstart",this._canvasTouchStartHandler),e.removeEventListener("touchend",this._canvasTouchEndHandler)}}const pu=30,ax=!0,Ax=!0;class lx extends Et{constructor(e,i={}){super(e,i),this.PAN_LEFT=0,this.PAN_RIGHT=1,this.PAN_UP=2,this.PAN_DOWN=3,this.PAN_FORWARDS=4,this.PAN_BACKWARDS=5,this.ROTATE_X_POS=6,this.ROTATE_X_NEG=7,this.ROTATE_Y_POS=8,this.ROTATE_Y_NEG=9,this.DOLLY_FORWARDS=10,this.DOLLY_BACKWARDS=11,this.AXIS_VIEW_RIGHT=12,this.AXIS_VIEW_BACK=13,this.AXIS_VIEW_LEFT=14,this.AXIS_VIEW_FRONT=15,this.AXIS_VIEW_TOP=16,this.AXIS_VIEW_BOTTOM=17,this._keyMap={},this.scene.canvas.canvas.oncontextmenu=t=>{t.preventDefault()},this._configs={longTapTimeout:600,longTapRadius:5,active:!0,keyboardLayout:"qwerty",navMode:"orbit",planView:!1,firstPerson:!1,followPointer:!0,doublePickFlyTo:!0,panRightClick:!0,showPivot:!1,pointerEnabled:!0,constrainVertical:!1,smartPivot:!1,doubleClickTimeFrame:250,snapToVertex:ax,snapToEdge:Ax,snapRadius:pu,dragRotationRate:360,keyboardRotationRate:90,rotationInertia:0,keyboardPanRate:1,touchPanRate:1,panInertia:.5,keyboardDollyRate:10,mouseWheelDollyRate:100,touchDollyRate:.2,dollyInertia:0,dollyProximityThreshold:30,dollyMinSpeed:.04},this._states={pointerCanvasPos:c.vec2(),mouseover:!1,followPointerDirty:!0,mouseDownClientX:0,mouseDownClientY:0,mouseDownCursorX:0,mouseDownCursorY:0,touchStartTime:null,activeTouches:[],tapStartPos:c.vec2(),tapStartTime:-1,lastTapTime:-1,longTouchTimeout:null},this._updates={rotateDeltaX:0,rotateDeltaY:0,panDeltaX:0,panDeltaY:0,panDeltaZ:0,dollyDelta:0};const s=this.scene;this._controllers={cameraControl:this,pickController:new Ky(this,this._configs),pivotController:new zy(s,this._configs),panController:new Qy(s),cameraFlight:new bs(this,{duration:.5})},this._handlers=[new tx(this.scene,this._controllers,this._configs,this._states,this._updates),new ix(this.scene,this._controllers,this._configs,this._states,this._updates),new Xy(this.scene,this._controllers,this._configs,this._states,this._updates),new $y(this.scene,this._controllers,this._configs,this._states,this._updates),new Zy(this.scene,this._controllers,this._configs,this._states,this._updates),new nx(this.scene,this._controllers,this._configs,this._states,this._updates),new qy(this.scene,this._controllers,this._configs,this._states,this._updates)],this._cameraUpdater=new ex(this.scene,this._controllers,this._configs,this._states,this._updates),this.navMode=i.navMode,i.planView&&(this.planView=i.planView),this.constrainVertical=i.constrainVertical,i.keyboardLayout?this.keyboardLayout=i.keyboardLayout:this.keyMap=i.keyMap,this.doublePickFlyTo=i.doublePickFlyTo,this.panRightClick=i.panRightClick,this.active=i.active,this.followPointer=i.followPointer,this.rotationInertia=i.rotationInertia,this.keyboardPanRate=i.keyboardPanRate,this.touchPanRate=i.touchPanRate,this.keyboardRotationRate=i.keyboardRotationRate,this.dragRotationRate=i.dragRotationRate,this.touchDollyRate=i.touchDollyRate,this.dollyInertia=i.dollyInertia,this.dollyProximityThreshold=i.dollyProximityThreshold,this.dollyMinSpeed=i.dollyMinSpeed,this.panInertia=i.panInertia,this.pointerEnabled=!0,this.keyboardDollyRate=i.keyboardDollyRate,this.mouseWheelDollyRate=i.mouseWheelDollyRate}set keyMap(e){if(e=e||"qwerty",Le.isString(e)){const i=this.scene.input,s={};switch(e){default:this.error("Unsupported value for 'keyMap': "+e+" defaulting to 'qwerty'");case"qwerty":s[this.PAN_LEFT]=[i.KEY_A],s[this.PAN_RIGHT]=[i.KEY_D],s[this.PAN_UP]=[i.KEY_Z],s[this.PAN_DOWN]=[i.KEY_X],s[this.PAN_BACKWARDS]=[],s[this.PAN_FORWARDS]=[],s[this.DOLLY_FORWARDS]=[i.KEY_W,i.KEY_ADD],s[this.DOLLY_BACKWARDS]=[i.KEY_S,i.KEY_SUBTRACT],s[this.ROTATE_X_POS]=[i.KEY_DOWN_ARROW],s[this.ROTATE_X_NEG]=[i.KEY_UP_ARROW],s[this.ROTATE_Y_POS]=[i.KEY_Q,i.KEY_LEFT_ARROW],s[this.ROTATE_Y_NEG]=[i.KEY_E,i.KEY_RIGHT_ARROW],s[this.AXIS_VIEW_RIGHT]=[i.KEY_NUM_1],s[this.AXIS_VIEW_BACK]=[i.KEY_NUM_2],s[this.AXIS_VIEW_LEFT]=[i.KEY_NUM_3],s[this.AXIS_VIEW_FRONT]=[i.KEY_NUM_4],s[this.AXIS_VIEW_TOP]=[i.KEY_NUM_5],s[this.AXIS_VIEW_BOTTOM]=[i.KEY_NUM_6];break;case"azerty":s[this.PAN_LEFT]=[i.KEY_Q],s[this.PAN_RIGHT]=[i.KEY_D],s[this.PAN_UP]=[i.KEY_W],s[this.PAN_DOWN]=[i.KEY_X],s[this.PAN_BACKWARDS]=[],s[this.PAN_FORWARDS]=[],s[this.DOLLY_FORWARDS]=[i.KEY_Z,i.KEY_ADD],s[this.DOLLY_BACKWARDS]=[i.KEY_S,i.KEY_SUBTRACT],s[this.ROTATE_X_POS]=[i.KEY_DOWN_ARROW],s[this.ROTATE_X_NEG]=[i.KEY_UP_ARROW],s[this.ROTATE_Y_POS]=[i.KEY_A,i.KEY_LEFT_ARROW],s[this.ROTATE_Y_NEG]=[i.KEY_E,i.KEY_RIGHT_ARROW],s[this.AXIS_VIEW_RIGHT]=[i.KEY_NUM_1],s[this.AXIS_VIEW_BACK]=[i.KEY_NUM_2],s[this.AXIS_VIEW_LEFT]=[i.KEY_NUM_3],s[this.AXIS_VIEW_FRONT]=[i.KEY_NUM_4],s[this.AXIS_VIEW_TOP]=[i.KEY_NUM_5],s[this.AXIS_VIEW_BOTTOM]=[i.KEY_NUM_6];break}this._keyMap=s}else{const i=e;this._keyMap=i}}get keyMap(){return this._keyMap}_isKeyDownForAction(e,i){const s=this._keyMap[e];if(!s)return!1;i||(i=this.scene.input.keyDown);for(let t=0,o=s.length;t<o;t++){const n=s[t];if(i[n])return!0}return!1}set pivotElement(e){this._controllers.pivotController.setPivotElement(e)}set active(e){e=e!==!1,this._configs.active=e,this._handlers[1]._active=e,this._handlers[5]._active=e}get active(){return this._configs.active}set snapToVertex(e){this._configs.snapToVertex=!!e}get snapToVertex(){return this._configs.snapToVertex}set snapToEdge(e){this._configs.snapToEdge=!!e}get snapToEdge(){return this._configs.snapToEdge}set snapRadius(e){e=e||pu,this._configs.snapRadius=e}get snapRadius(){return this._configs.snapRadius}set navMode(e){e=e||"orbit",e!=="firstPerson"&&e!=="orbit"&&e!=="planView"&&(this.error("Unsupported value for navMode: "+e+" - supported values are 'orbit', 'firstPerson' and 'planView' - defaulting to 'orbit'"),e="orbit"),this._configs.firstPerson=e==="firstPerson",this._configs.planView=e==="planView",(this._configs.firstPerson||this._configs.planView)&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot()),this._configs.navMode=e}get navMode(){return this._configs.navMode}set pointerEnabled(e){this._reset(),this._configs.pointerEnabled=!!e}_reset(){for(let e=0,i=this._handlers.length;e<i;e++){const s=this._handlers[e];s.reset&&s.reset()}this._updates.panDeltaX=0,this._updates.panDeltaY=0,this._updates.rotateDeltaX=0,this._updates.rotateDeltaY=0,this._updates.dolyDelta=0}get pointerEnabled(){return this._configs.pointerEnabled}set followPointer(e){this._configs.followPointer=e!==!1}get followPointer(){return this._configs.followPointer}set pivotPos(e){this._controllers.pivotController.setPivotPos(e)}get pivotPos(){return this._controllers.pivotController.getPivotPos()}set dollyToPointer(e){this.warn("dollyToPointer property is deprecated - replaced with followPointer"),this.followPointer=e}get dollyToPointer(){return this.warn("dollyToPointer property is deprecated - replaced with followPointer"),this.followPointer}set panToPointer(e){this.warn("panToPointer property is deprecated - replaced with followPointer")}get panToPointer(){return this.warn("panToPointer property is deprecated - replaced with followPointer"),!1}set planView(e){this._configs.planView=!!e,this._configs.firstPerson=!1,this._configs.planView&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot()),this.warn("planView property is deprecated - replaced with navMode")}get planView(){return this.warn("planView property is deprecated - replaced with navMode"),this._configs.planView}set firstPerson(e){this.warn("firstPerson property is deprecated - replaced with navMode"),this._configs.firstPerson=!!e,this._configs.planView=!1,this._configs.firstPerson&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot())}get firstPerson(){return this.warn("firstPerson property is deprecated - replaced with navMode"),this._configs.firstPerson}set constrainVertical(e){this._configs.constrainVertical=!!e}get constrainVertical(){return this._configs.constrainVertical}set doublePickFlyTo(e){this._configs.doublePickFlyTo=e!==!1}get doublePickFlyTo(){return this._configs.doublePickFlyTo}set panRightClick(e){this._configs.panRightClick=e!==!1}get panRightClick(){return this._configs.panRightClick}set rotationInertia(e){this._configs.rotationInertia=e??0}get rotationInertia(){return this._configs.rotationInertia}set keyboardPanRate(e){this._configs.keyboardPanRate=e??5}set touchPanRate(e){this._configs.touchPanRate=e??1}get touchPanRate(){return this._configs.touchPanRate}get keyboardPanRate(){return this._configs.keyboardPanRate}set keyboardRotationRate(e){this._configs.keyboardRotationRate=e??90}get keyboardRotationRate(){return this._configs.keyboardRotationRate}set dragRotationRate(e){this._configs.dragRotationRate=e??360}get dragRotationRate(){return this._configs.dragRotationRate}set keyboardDollyRate(e){this._configs.keyboardDollyRate=e??15}get keyboardDollyRate(){return this._configs.keyboardDollyRate}set touchDollyRate(e){this._configs.touchDollyRate=e??.2}get touchDollyRate(){return this._configs.touchDollyRate}set mouseWheelDollyRate(e){this._configs.mouseWheelDollyRate=e??100}get mouseWheelDollyRate(){return this._configs.mouseWheelDollyRate}set dollyInertia(e){this._configs.dollyInertia=e??0}get dollyInertia(){return this._configs.dollyInertia}set dollyProximityThreshold(e){this._configs.dollyProximityThreshold=e??35}get dollyProximityThreshold(){return this._configs.dollyProximityThreshold}set dollyMinSpeed(e){this._configs.dollyMinSpeed=e??.04}get dollyMinSpeed(){return this._configs.dollyMinSpeed}set panInertia(e){this._configs.panInertia=e??.5}get panInertia(){return this._configs.panInertia}set keyboardLayout(e){e=e||"qwerty",e!=="qwerty"&&e!=="azerty"&&(this.error("Unsupported value for keyboardLayout - defaulting to 'qwerty'"),e="qwerty"),this._configs.keyboardLayout=e,this.keyMap=this._configs.keyboardLayout}get keyboardLayout(){return this._configs.keyboardLayout}enablePivotSphere(e={}){this._controllers.pivotController.enablePivotSphere(e)}disablePivotSphere(){this._controllers.pivotController.disablePivotSphere()}set smartPivot(e){this._configs.smartPivot=e!==!1}get smartPivot(){return this._configs.smartPivot}set doubleClickTimeFrame(e){this._configs.doubleClickTimeFrame=e??250}get doubleClickTimeFrame(){return this._configs.doubleClickTimeFrame}destroy(){this._destroyHandlers(),this._destroyControllers(),this._cameraUpdater.destroy(),super.destroy()}_destroyHandlers(){for(let e=0,i=this._handlers.length;e<i;e++){const s=this._handlers[e];s.destroy&&s.destroy()}}_destroyControllers(){for(let e=0,i=this._controllers.length;e<i;e++){const s=this._controllers[e];s.destroy&&s.destroy()}}}class cx{constructor(e,i,s,t,o){this.name=e,this.type=s,this.value=i,this.valueType=t,this.description=o}}class hx{constructor(e){if(this.id=e.id,this.originalSystemId=e.originalSystemId,this.metaModels=[],this.name=e.name,this.type=e.type,this.properties=[],e.properties){const i=e.properties;for(let s=0,t=i.length;s<t;s++){const o=i[s];this.properties.push(new cx(o.name,o.value,o.type,o.valueType,o.description))}}}}class ux{constructor(e){this.metaModels=[],this.id=e.id,this.parentId=e.parentId,this.parent=null,this.originalSystemId=e.originalSystemId,this.name=e.name,this.type=e.type,this.propertySetIds=e.propertySetIds,this.propertySets=[],this.attributes=e.attributes||{},e.external!==void 0&&e.external!==null&&(this.external=e.external)}get metaModel(){return this.metaModels.length==1?this.metaModels[0]:null}getObjectIDsInSubtree(){const e=[];function i(s){if(!s)return;e.push(s.id);const t=s.children;if(t)for(var o=0,n=t.length;o<n;o++)i(t[o])}return i(this),e}withMetaObjectsInSubtree(e){function i(s){if(!s)return;e(s);const t=s.children;if(t)for(var o=0,n=t.length;o<n;o++)i(t[o])}i(this)}getObjectIDsInSubtreeByType(e){const i={};for(var s=0,t=e.length;s<t;s++)i[e[s]]=e[s];const o=[];function n(a){if(!a)return;i[a.type]&&o.push(a.id);const A=a.children;if(A)for(var l=0,h=A.length;l<h;l++)n(A[l])}return n(this),o}getJSON(){var e={id:this.id,type:this.type,name:this.name};return this.parent&&(e.parent=this.parent.id),e}}class dx{constructor(e){this.id=e.id,this.projectId=e.projectId,this.revisionId=e.revisionId,this.author=e.author,this.createdAt=e.createdAt,this.creatingApplication=e.creatingApplication,this.schema=e.schema,this.metaScene=e.metaScene,this.propertySets=[],this.rootMetaObjects=[],this.metaObjects=[],this.graph=e.graph||{},this.metaScene.metaModels[this.id]=this,this.finalized=!1}get rootMetaObject(){return this.rootMetaObjects.length==1?this.rootMetaObjects[0]:null}loadData(e,i={}){if(this.finalized)throw"MetaScene already finalized - can't add more data";this._globalizeIDs(e,i);const s=this.metaScene,t=e.properties;if(e.propertySets)for(let o=0,n=e.propertySets.length;o<n;o++){const a=e.propertySets[o];a.properties||(a.properties=[]);let A=s.propertySets[a.id];A||(t&&this._decompressProperties(t,a.properties),A=new hx({id:a.id,originalSystemId:a.originalSystemId||a.id,type:a.type,name:a.name,properties:a.properties}),s.propertySets[A.id]=A),A.metaModels.push(this),this.propertySets.push(A)}if(e.metaObjects)for(let o=0,n=e.metaObjects.length;o<n;o++){const a=e.metaObjects[o],A=a.id;let l=s.metaObjects[A];if(!l){const h=a.type,d=a.originalSystemId,f=a.propertySets||a.propertySetIds;l=new ux({id:A,originalSystemId:d,parentId:a.parent,type:h,name:a.name,attributes:a.attributes,propertySetIds:f,external:a.external}),this.metaScene.metaObjects[A]=l,l.metaModels=[]}this.metaObjects.push(l),a.parent||(this.rootMetaObjects.push(l),s.rootMetaObjects[A]=l)}}_decompressProperties(e,i){for(let s=0,t=i.length;s<t;s++){const o=i[s];if(Number.isInteger(o)){const n=e[o];n&&(i[s]=n)}}}finalize(){if(this.finalized)throw"MetaScene already finalized - can't re-finalize";const e=this.metaScene;for(let i in e.metaObjects){const s=e.metaObjects[i];if(s.children&&(s.children=[]),s.propertySets&&(s.propertySets=[]),s.propertySetIds)for(let t=0,o=s.propertySetIds.length;t<o;t++){const n=s.propertySetIds[t],a=e.propertySets[n];s.propertySets.push(a)}}for(let i in e.metaObjects){const s=e.metaObjects[i];if(s.parentId){const t=e.metaObjects[s.parentId];t&&(s.parent=t,(t.children||(t.children=[])).push(s))}}for(let i in e.metaObjects){const s=e.metaObjects[i];s.metaModels=[]}for(let i in e.metaModels){const s=e.metaModels[i];for(let t=0,o=s.metaObjects.length;t<o;t++)s.metaObjects[t].metaModels.push(s)}e.metaObjectsByType={};for(let i in e.metaObjects){const s=e.metaObjects[i],t=s.type;(e.metaObjectsByType[t]||(e.metaObjectsByType[t]={}))[i]=s}this.finalized=!0,this.metaScene.fire("metaModelCreated",this.id)}getJSON(){const e={id:this.id,projectId:this.projectId,author:this.author,createdAt:this.createdAt,schema:this.schema,creatingApplication:this.creatingApplication,metaObjects:[],propertySets:[]};for(let i=0,s=this.metaObjects.length;i<s;i++){const t=this.metaObjects[i],o={id:t.id,originalSystemId:t.originalSystemId,extId:t.extId,type:t.type,name:t.name};t.parent&&(o.parent=t.parent.id),t.attributes&&(o.attributes=t.attributes),t.propertySetIds&&(o.propertySetIds=t.propertySetIds),e.metaObjects.push(o)}for(let i=0,s=this.propertySets.length;i<s;i++){const t=this.propertySets[i],o={id:t.id,originalSystemId:t.originalSystemId,extId:t.extId,type:t.type,name:t.name,propertyies:[]};for(let n=0,a=t.properties.length;n<a;n++){const A=t.properties[n],l={id:A.id,description:A.description,type:A.type,name:A.name,value:A.value,valueType:A.valueType};o.properties.push(l)}e.propertySets.push(o)}return e}_globalizeIDs(e,i){const s=!!i.globalizeObjectIds;if(e.metaObjects)for(let t=0,o=e.metaObjects.length;t<o;t++){const n=e.metaObjects[t];if(n.originalSystemId=n.id,n.parent&&(n.originalParentSystemId=n.parent),s&&(n.id=c.globalizeObjectId(this.id,n.id),n.parent&&(n.parent=c.globalizeObjectId(this.id,n.parent))),s){const a=n.propertySetIds;if(a){const A=[];for(let l=0,h=a.length;l<h;l++)A.push(c.globalizeObjectId(this.id,a[l]));n.propertySetIds=A,n.originalSystemPropertySetIds=a}}else n.originalSystemPropertySetIds=n.propertySetIds}if(e.propertySets)for(let t=0,o=e.propertySets.length;t<o;t++){const n=e.propertySets[t];n.originalSystemId=n.id,s&&(n.id=c.globalizeObjectId(this.id,n.id))}}}class px{constructor(e,i){this.viewer=e,this.scene=i,this.metaModels={},this.propertySets={},this.metaObjects={},this.metaObjectsByType={},this.rootMetaObjects={},this._eventSubs={}}on(e,i){let s=this._eventSubs[e];s||(s=[],this._eventSubs[e]=s),s.push(i)}fire(e,i){const s=this._eventSubs[e];if(s)for(let t=0,o=s.length;t<o;t++)s[t](i)}off(e){}createMetaModel(e,i,s={}){const t=new dx({metaScene:this,id:e,projectId:i.projectId||"none",revisionId:i.revisionId||"none",author:i.author||"none",createdAt:i.createdAt||"none",creatingApplication:i.creatingApplication||"none",schema:i.schema||"none",propertySets:[]});return t.loadData(i),t.finalize(),t}destroyMetaModel(e){const i=this.metaModels[e];if(i){if(i.propertySets)for(let s=0,t=i.propertySets.length;s<t;s++){const o=i.propertySets[s];if(o.metaModels.length===1&&o.metaModels[0].id===e)delete this.propertySets[o.id];else{const n=[];for(let a=0,A=o.metaModels.length;a<A;a++)o.metaModels[a].id!==e&&n.push(o.metaModels[a]);o.metaModels=n}}if(i.metaObjects)for(let s=0,t=i.metaObjects.length;s<t;s++){const o=i.metaObjects[s];o.type;const n=o.id;o.metaModels.length===1&&o.metaModels[0].id===e&&(delete this.metaObjects[n],o.parent||delete this.rootMetaObjects[n])}for(let s in this.metaObjects){const t=this.metaObjects[s];if(t.children&&(t.children=[]),t.propertySets&&(t.propertySets=[]),t.propertySetIds)for(let o=0,n=t.propertySetIds.length;o<n;o++){const a=t.propertySetIds[o],A=this.propertySets[a];t.propertySets.push(A)}}this.metaObjectsByType={};for(let s in this.metaObjects){const t=this.metaObjects[s],o=t.type;t.children&&(t.children=null),(this.metaObjectsByType[o]||(this.metaObjectsByType[o]={}))[s]=t}for(let s in this.metaObjects){const t=this.metaObjects[s];if(t.parentId){const o=this.metaObjects[t.parentId];o&&(t.parent=o,(o.children||(o.children=[])).push(t))}}delete this.metaModels[e];for(let s in this.metaObjects){const t=this.metaObjects[s];t.metaModels=[]}for(let s in this.metaModels){const t=this.metaModels[s];for(let o=0,n=t.metaObjects.length;o<n;o++)t.metaObjects[o].metaModels.push(t)}this.fire("metaModelDestroyed",e)}}getObjectIDsByType(e){const i=this.metaObjectsByType[e];return i?Object.keys(i):[]}getObjectIDsInSubtree(e,i,s){const t=[],o=this.metaObjects[e],n=i&&i.length>0?fu(i):null,a=s&&s.length>0?fu(s):null,A=l=>{if(!l)return;var h=!0;(a&&a[l.type]||n&&!n[l.type])&&(h=!1),h&&t.push(l.id);const d=l.children;if(d)for(var f=0,m=d.length;f<m;f++)A(d[f])};return A(o),t}withMetaObjectsInSubtree(e,i){const s=this.metaObjects[e];s&&s.withMetaObjectsInSubtree(i)}}function fu(r){const e={};for(var i=0,s=r.length;i<s;i++)e[r[i]]=!0;return e}/*!
 * html2canvas 1.4.1 <https://html2canvas.hertzen.com>
 * Copyright (c) 2022 Niklas von Hertzen <https://hertzen.com>
 * Released under MIT License
 *//*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var $A=function(r,e){return $A=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,s){i.__proto__=s}||function(i,s){for(var t in s)Object.prototype.hasOwnProperty.call(s,t)&&(i[t]=s[t])},$A(r,e)};function Ei(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");$A(r,e);function i(){this.constructor=r}r.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}var ZA=function(){return ZA=Object.assign||function(e){for(var i,s=1,t=arguments.length;s<t;s++){i=arguments[s];for(var o in i)Object.prototype.hasOwnProperty.call(i,o)&&(e[o]=i[o])}return e},ZA.apply(this,arguments)};function oi(r,e,i,s){function t(o){return o instanceof i?o:new i(function(n){n(o)})}return new(i||(i=Promise))(function(o,n){function a(h){try{l(s.next(h))}catch(d){n(d)}}function A(h){try{l(s.throw(h))}catch(d){n(d)}}function l(h){h.done?o(h.value):t(h.value).then(a,A)}l((s=s.apply(r,[])).next())})}function qt(r,e){var i={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},s,t,o,n;return n={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(n[Symbol.iterator]=function(){return this}),n;function a(l){return function(h){return A([l,h])}}function A(l){if(s)throw new TypeError("Generator is already executing.");for(;i;)try{if(s=1,t&&(o=l[0]&2?t.return:l[0]?t.throw||((o=t.return)&&o.call(t),0):t.next)&&!(o=o.call(t,l[1])).done)return o;switch(t=0,o&&(l=[l[0]&2,o.value]),l[0]){case 0:case 1:o=l;break;case 4:return i.label++,{value:l[1],done:!1};case 5:i.label++,t=l[1],l=[0];continue;case 7:l=i.ops.pop(),i.trys.pop();continue;default:if(o=i.trys,!(o=o.length>0&&o[o.length-1])&&(l[0]===6||l[0]===2)){i=0;continue}if(l[0]===3&&(!o||l[1]>o[0]&&l[1]<o[3])){i.label=l[1];break}if(l[0]===6&&i.label<o[1]){i.label=o[1],o=l;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(l);break}o[2]&&i.ops.pop(),i.trys.pop();continue}l=e.call(r,i)}catch(h){l=[6,h],t=0}finally{s=o=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}function Ko(r,e,i){if(arguments.length===2)for(var s=0,t=e.length,o;s<t;s++)(o||!(s in e))&&(o||(o=Array.prototype.slice.call(e,0,s)),o[s]=e[s]);return r.concat(o||e)}var qi=function(){function r(e,i,s,t){this.left=e,this.top=i,this.width=s,this.height=t}return r.prototype.add=function(e,i,s,t){return new r(this.left+e,this.top+i,this.width+s,this.height+t)},r.fromClientRect=function(e,i){return new r(i.left+e.windowBounds.left,i.top+e.windowBounds.top,i.width,i.height)},r.fromDOMRectList=function(e,i){var s=Array.from(i).find(function(t){return t.width!==0});return s?new r(s.left+e.windowBounds.left,s.top+e.windowBounds.top,s.width,s.height):r.EMPTY},r.EMPTY=new r(0,0,0,0),r}(),Wn=function(r,e){return qi.fromClientRect(r,e.getBoundingClientRect())},fx=function(r){var e=r.body,i=r.documentElement;if(!e||!i)throw new Error("Unable to get document size");var s=Math.max(Math.max(e.scrollWidth,i.scrollWidth),Math.max(e.offsetWidth,i.offsetWidth),Math.max(e.clientWidth,i.clientWidth)),t=Math.max(Math.max(e.scrollHeight,i.scrollHeight),Math.max(e.offsetHeight,i.offsetHeight),Math.max(e.clientHeight,i.clientHeight));return new qi(0,0,s,t)},Xn=function(r){for(var e=[],i=0,s=r.length;i<s;){var t=r.charCodeAt(i++);if(t>=55296&&t<=56319&&i<s){var o=r.charCodeAt(i++);(o&64512)===56320?e.push(((t&1023)<<10)+(o&1023)+65536):(e.push(t),i--)}else e.push(t)}return e},Rt=function(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];if(String.fromCodePoint)return String.fromCodePoint.apply(String,r);var i=r.length;if(!i)return"";for(var s=[],t=-1,o="";++t<i;){var n=r[t];n<=65535?s.push(n):(n-=65536,s.push((n>>10)+55296,n%1024+56320)),(t+1===i||s.length>16384)&&(o+=String.fromCharCode.apply(String,s),s.length=0)}return o},gu="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",gx=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var Wo=0;Wo<gu.length;Wo++)gx[gu.charCodeAt(Wo)]=Wo;var mu="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",jr=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var Xo=0;Xo<mu.length;Xo++)jr[mu.charCodeAt(Xo)]=Xo;var mx=function(r){var e=r.length*.75,i=r.length,s,t=0,o,n,a,A;r[r.length-1]==="="&&(e--,r[r.length-2]==="="&&e--);var l=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u"&&typeof Uint8Array.prototype.slice<"u"?new ArrayBuffer(e):new Array(e),h=Array.isArray(l)?l:new Uint8Array(l);for(s=0;s<i;s+=4)o=jr[r.charCodeAt(s)],n=jr[r.charCodeAt(s+1)],a=jr[r.charCodeAt(s+2)],A=jr[r.charCodeAt(s+3)],h[t++]=o<<2|n>>4,h[t++]=(n&15)<<4|a>>2,h[t++]=(a&3)<<6|A&63;return l},_x=function(r){for(var e=r.length,i=[],s=0;s<e;s+=2)i.push(r[s+1]<<8|r[s]);return i},vx=function(r){for(var e=r.length,i=[],s=0;s<e;s+=4)i.push(r[s+3]<<24|r[s+2]<<16|r[s+1]<<8|r[s]);return i},Cs=5,xl=11,aA=2,Px=xl-Cs,Sp=65536>>Cs,Bx=1<<Cs,AA=Bx-1,yx=1024>>Cs,xx=Sp+yx,wx=xx,bx=32,Cx=wx+bx,Ex=65536>>xl,Ix=1<<Px,Fx=Ix-1,_u=function(r,e,i){return r.slice?r.slice(e,i):new Uint16Array(Array.prototype.slice.call(r,e,i))},Mx=function(r,e,i){return r.slice?r.slice(e,i):new Uint32Array(Array.prototype.slice.call(r,e,i))},Sx=function(r,e){var i=mx(r),s=Array.isArray(i)?vx(i):new Uint32Array(i),t=Array.isArray(i)?_x(i):new Uint16Array(i),o=24,n=_u(t,o/2,s[4]/2),a=s[5]===2?_u(t,(o+s[4])/2):Mx(s,Math.ceil((o+s[4])/4));return new Tx(s[0],s[1],s[2],s[3],n,a)},Tx=function(){function r(e,i,s,t,o,n){this.initialValue=e,this.errorValue=i,this.highStart=s,this.highValueIndex=t,this.index=o,this.data=n}return r.prototype.get=function(e){var i;if(e>=0){if(e<55296||e>56319&&e<=65535)return i=this.index[e>>Cs],i=(i<<aA)+(e&AA),this.data[i];if(e<=65535)return i=this.index[Sp+(e-55296>>Cs)],i=(i<<aA)+(e&AA),this.data[i];if(e<this.highStart)return i=Cx-Ex+(e>>xl),i=this.index[i],i+=e>>Cs&Fx,i=this.index[i],i=(i<<aA)+(e&AA),this.data[i];if(e<=1114111)return this.data[this.highValueIndex]}return this.errorValue},r}(),vu="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Dx=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var Yo=0;Yo<vu.length;Yo++)Dx[vu.charCodeAt(Yo)]=Yo;var Rx="KwAAAAAAAAAACA4AUD0AADAgAAACAAAAAAAIABAAGABAAEgAUABYAGAAaABgAGgAYgBqAF8AZwBgAGgAcQB5AHUAfQCFAI0AlQCdAKIAqgCyALoAYABoAGAAaABgAGgAwgDKAGAAaADGAM4A0wDbAOEA6QDxAPkAAQEJAQ8BFwF1AH0AHAEkASwBNAE6AUIBQQFJAVEBWQFhAWgBcAF4ATAAgAGGAY4BlQGXAZ8BpwGvAbUBvQHFAc0B0wHbAeMB6wHxAfkBAQIJAvEBEQIZAiECKQIxAjgCQAJGAk4CVgJeAmQCbAJ0AnwCgQKJApECmQKgAqgCsAK4ArwCxAIwAMwC0wLbAjAA4wLrAvMC+AIAAwcDDwMwABcDHQMlAy0DNQN1AD0DQQNJA0kDSQNRA1EDVwNZA1kDdQB1AGEDdQBpA20DdQN1AHsDdQCBA4kDkQN1AHUAmQOhA3UAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AKYDrgN1AHUAtgO+A8YDzgPWAxcD3gPjA+sD8wN1AHUA+wMDBAkEdQANBBUEHQQlBCoEFwMyBDgEYABABBcDSARQBFgEYARoBDAAcAQzAXgEgASIBJAEdQCXBHUAnwSnBK4EtgS6BMIEyAR1AHUAdQB1AHUAdQCVANAEYABgAGAAYABgAGAAYABgANgEYADcBOQEYADsBPQE/AQEBQwFFAUcBSQFLAU0BWQEPAVEBUsFUwVbBWAAYgVgAGoFcgV6BYIFigWRBWAAmQWfBaYFYABgAGAAYABgAKoFYACxBbAFuQW6BcEFwQXHBcEFwQXPBdMF2wXjBeoF8gX6BQIGCgYSBhoGIgYqBjIGOgZgAD4GRgZMBmAAUwZaBmAAYABgAGAAYABgAGAAYABgAGAAYABgAGIGYABpBnAGYABgAGAAYABgAGAAYABgAGAAYAB4Bn8GhQZgAGAAYAB1AHcDFQSLBmAAYABgAJMGdQA9A3UAmwajBqsGqwaVALMGuwbDBjAAywbSBtIG1QbSBtIG0gbSBtIG0gbdBuMG6wbzBvsGAwcLBxMHAwcbByMHJwcsBywHMQcsB9IGOAdAB0gHTgfSBkgHVgfSBtIG0gbSBtIG0gbSBtIG0gbSBiwHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAdgAGAALAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAdbB2MHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsB2kH0gZwB64EdQB1AHUAdQB1AHUAdQB1AHUHfQdgAIUHjQd1AHUAlQedB2AAYAClB6sHYACzB7YHvgfGB3UAzgfWBzMB3gfmB1EB7gf1B/0HlQENAQUIDQh1ABUIHQglCBcDLQg1CD0IRQhNCEEDUwh1AHUAdQBbCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIcAh3CHoIMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIgggwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAALAcsBywHLAcsBywHLAcsBywHLAcsB4oILAcsB44I0gaWCJ4Ipgh1AHUAqgiyCHUAdQB1AHUAdQB1AHUAdQB1AHUAtwh8AXUAvwh1AMUIyQjRCNkI4AjoCHUAdQB1AO4I9gj+CAYJDgkTCS0HGwkjCYIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiAAIAAAAFAAYABgAGIAXwBgAHEAdQBFAJUAogCyAKAAYABgAEIA4ABGANMA4QDxAMEBDwE1AFwBLAE6AQEBUQF4QkhCmEKoQrhCgAHIQsAB0MLAAcABwAHAAeDC6ABoAHDCwMMAAcABwAHAAdDDGMMAAcAB6MM4wwjDWMNow3jDaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAEjDqABWw6bDqABpg6gAaABoAHcDvwOPA+gAaABfA/8DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DpcPAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcAB9cPKwkyCToJMAB1AHUAdQBCCUoJTQl1AFUJXAljCWcJawkwADAAMAAwAHMJdQB2CX4JdQCECYoJjgmWCXUAngkwAGAAYABxAHUApgn3A64JtAl1ALkJdQDACTAAMAAwADAAdQB1AHUAdQB1AHUAdQB1AHUAowYNBMUIMAAwADAAMADICcsJ0wnZCRUE4QkwAOkJ8An4CTAAMAB1AAAKvwh1AAgKDwoXCh8KdQAwACcKLgp1ADYKqAmICT4KRgowADAAdQB1AE4KMAB1AFYKdQBeCnUAZQowADAAMAAwADAAMAAwADAAMAAVBHUAbQowADAAdQC5CXUKMAAwAHwBxAijBogEMgF9CoQKiASMCpQKmgqIBKIKqgquCogEDQG2Cr4KxgrLCjAAMADTCtsKCgHjCusK8Qr5CgELMAAwADAAMAB1AIsECQsRC3UANAEZCzAAMAAwADAAMAB1ACELKQswAHUANAExCzkLdQBBC0kLMABRC1kLMAAwADAAMAAwADAAdQBhCzAAMAAwAGAAYABpC3ELdwt/CzAAMACHC4sLkwubC58Lpwt1AK4Ltgt1APsDMAAwADAAMAAwADAAMAAwAL4LwwvLC9IL1wvdCzAAMADlC+kL8Qv5C/8LSQswADAAMAAwADAAMAAwADAAMAAHDDAAMAAwADAAMAAODBYMHgx1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1ACYMMAAwADAAdQB1AHUALgx1AHUAdQB1AHUAdQA2DDAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AD4MdQBGDHUAdQB1AHUAdQB1AEkMdQB1AHUAdQB1AFAMMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQBYDHUAdQB1AF8MMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUA+wMVBGcMMAAwAHwBbwx1AHcMfwyHDI8MMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAYABgAJcMMAAwADAAdQB1AJ8MlQClDDAAMACtDCwHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsB7UMLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AA0EMAC9DDAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAsBywHLAcsBywHLAcsBywHLQcwAMEMyAwsBywHLAcsBywHLAcsBywHLAcsBywHzAwwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAHUAdQB1ANQM2QzhDDAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMABgAGAAYABgAGAAYABgAOkMYADxDGAA+AwADQYNYABhCWAAYAAODTAAMAAwADAAFg1gAGAAHg37AzAAMAAwADAAYABgACYNYAAsDTQNPA1gAEMNPg1LDWAAYABgAGAAYABgAGAAYABgAGAAUg1aDYsGVglhDV0NcQBnDW0NdQ15DWAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAlQCBDZUAiA2PDZcNMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAnw2nDTAAMAAwADAAMAAwAHUArw23DTAAMAAwADAAMAAwADAAMAAwADAAMAB1AL8NMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAB1AHUAdQB1AHUAdQDHDTAAYABgAM8NMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAA1w11ANwNMAAwAD0B5A0wADAAMAAwADAAMADsDfQN/A0EDgwOFA4wABsOMAAwADAAMAAwADAAMAAwANIG0gbSBtIG0gbSBtIG0gYjDigOwQUuDsEFMw7SBjoO0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGQg5KDlIOVg7SBtIGXg5lDm0OdQ7SBtIGfQ6EDooOjQ6UDtIGmg6hDtIG0gaoDqwO0ga0DrwO0gZgAGAAYADEDmAAYAAkBtIGzA5gANIOYADaDokO0gbSBt8O5w7SBu8O0gb1DvwO0gZgAGAAxA7SBtIG0gbSBtIGYABgAGAAYAAED2AAsAUMD9IG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGFA8sBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAccD9IGLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHJA8sBywHLAcsBywHLAccDywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywPLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAc0D9IG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAccD9IG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGFA8sBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHPA/SBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gYUD0QPlQCVAJUAMAAwADAAMACVAJUAlQCVAJUAlQCVAEwPMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAA//8EAAQABAAEAAQABAAEAAQABAANAAMAAQABAAIABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQACgATABcAHgAbABoAHgAXABYAEgAeABsAGAAPABgAHABLAEsASwBLAEsASwBLAEsASwBLABgAGAAeAB4AHgATAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQABYAGwASAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAWAA0AEQAeAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAFAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAJABYAGgAbABsAGwAeAB0AHQAeAE8AFwAeAA0AHgAeABoAGwBPAE8ADgBQAB0AHQAdAE8ATwAXAE8ATwBPABYAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAFAAUABQAFAAUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAB4AHgAeAFAATwBAAE8ATwBPAEAATwBQAFAATwBQAB4AHgAeAB4AHgAeAB0AHQAdAB0AHgAdAB4ADgBQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgBQAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAJAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAkACQAJAAkACQAJAAkABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgAeAFAAHgAeAB4AKwArAFAAUABQAFAAGABQACsAKwArACsAHgAeAFAAHgBQAFAAUAArAFAAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAAQABAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAUAAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAYAA0AKwArAB4AHgAbACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQADQAEAB4ABAAEAB4ABAAEABMABAArACsAKwArACsAKwArACsAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAKwArACsAKwBWAFYAVgBWAB4AHgArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AGgAaABoAGAAYAB4AHgAEAAQABAAEAAQABAAEAAQABAAEAAQAEwAEACsAEwATAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABLAEsASwBLAEsASwBLAEsASwBLABoAGQAZAB4AUABQAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQABMAUAAEAAQABAAEAAQABAAEAB4AHgAEAAQABAAEAAQABABQAFAABAAEAB4ABAAEAAQABABQAFAASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUAAeAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAFAABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQAUABQAB4AHgAYABMAUAArACsABAAbABsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAFAABAAEAAQABAAEAFAABAAEAAQAUAAEAAQABAAEAAQAKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAArACsAHgArAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAB4ABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAUAAEAAQABAAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAABAAEAA0ADQBLAEsASwBLAEsASwBLAEsASwBLAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAArAFAAUABQAFAAUABQAFAAUAArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUAArACsAKwBQAFAAUABQACsAKwAEAFAABAAEAAQABAAEAAQABAArACsABAAEACsAKwAEAAQABABQACsAKwArACsAKwArACsAKwAEACsAKwArACsAUABQACsAUABQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAFAAUAAaABoAUABQAFAAUABQAEwAHgAbAFAAHgAEACsAKwAEAAQABAArAFAAUABQAFAAUABQACsAKwArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQACsAUABQACsAKwAEACsABAAEAAQABAAEACsAKwArACsABAAEACsAKwAEAAQABAArACsAKwAEACsAKwArACsAKwArACsAUABQAFAAUAArAFAAKwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLAAQABABQAFAAUAAEAB4AKwArACsAKwArACsAKwArACsAKwAEAAQABAArAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQAFAAUABQACsAKwAEAFAABAAEAAQABAAEAAQABAAEACsABAAEAAQAKwAEAAQABAArACsAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAB4AGwArACsAKwArACsAKwArAFAABAAEAAQABAAEAAQAKwAEAAQABAArAFAAUABQAFAAUABQAFAAUAArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAArACsABAAEACsAKwAEAAQABAArACsAKwArACsAKwArAAQABAAEACsAKwArACsAUABQACsAUABQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAB4AUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArAAQAUAArAFAAUABQAFAAUABQACsAKwArAFAAUABQACsAUABQAFAAUAArACsAKwBQAFAAKwBQACsAUABQACsAKwArAFAAUAArACsAKwBQAFAAUAArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArAAQABAAEAAQABAArACsAKwAEAAQABAArAAQABAAEAAQAKwArAFAAKwArACsAKwArACsABAArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAHgAeAB4AHgAeAB4AGwAeACsAKwArACsAKwAEAAQABAAEAAQAUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAUAAEAAQABAAEAAQABAAEACsABAAEAAQAKwAEAAQABAAEACsAKwArACsAKwArACsABAAEACsAUABQAFAAKwArACsAKwArAFAAUAAEAAQAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAKwAOAFAAUABQAFAAUABQAFAAHgBQAAQABAAEAA4AUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAKwArAAQAUAAEAAQABAAEAAQABAAEACsABAAEAAQAKwAEAAQABAAEACsAKwArACsAKwArACsABAAEACsAKwArACsAKwArACsAUAArAFAAUAAEAAQAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwBQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAFAABAAEAAQABAAEAAQABAArAAQABAAEACsABAAEAAQABABQAB4AKwArACsAKwBQAFAAUAAEAFAAUABQAFAAUABQAFAAUABQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAFAAUABQAFAAUABQAFAAUABQABoAUABQAFAAUABQAFAAKwAEAAQABAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQACsAUAArACsAUABQAFAAUABQAFAAUAArACsAKwAEACsAKwArACsABAAEAAQABAAEAAQAKwAEACsABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArAAQABAAeACsAKwArACsAKwArACsAKwArACsAKwArAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAAqAFwAXAAqACoAKgAqACoAKgAqACsAKwArACsAGwBcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAeAEsASwBLAEsASwBLAEsASwBLAEsADQANACsAKwArACsAKwBcAFwAKwBcACsAXABcAFwAXABcACsAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACsAXAArAFwAXABcAFwAXABcAFwAXABcAFwAKgBcAFwAKgAqACoAKgAqACoAKgAqACoAXAArACsAXABcAFwAXABcACsAXAArACoAKgAqACoAKgAqACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwBcAFwAXABcAFAADgAOAA4ADgAeAA4ADgAJAA4ADgANAAkAEwATABMAEwATAAkAHgATAB4AHgAeAAQABAAeAB4AHgAeAB4AHgBLAEsASwBLAEsASwBLAEsASwBLAFAAUABQAFAAUABQAFAAUABQAFAADQAEAB4ABAAeAAQAFgARABYAEQAEAAQAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQADQAEAAQABAAEAAQADQAEAAQAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArAA0ADQAeAB4AHgAeAB4AHgAEAB4AHgAeAB4AHgAeACsAHgAeAA4ADgANAA4AHgAeAB4AHgAeAAkACQArACsAKwArACsAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgBcAEsASwBLAEsASwBLAEsASwBLAEsADQANAB4AHgAeAB4AXABcAFwAXABcAFwAKgAqACoAKgBcAFwAXABcACoAKgAqAFwAKgAqACoAXABcACoAKgAqACoAKgAqACoAXABcAFwAKgAqACoAKgBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAqACoAKgAqAFwAKgBLAEsASwBLAEsASwBLAEsASwBLACoAKgAqACoAKgAqAFAAUABQAFAAUABQACsAUAArACsAKwArACsAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgBQAFAAUABQAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUAArACsAUABQAFAAUABQAFAAUAArAFAAKwBQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAKwBQACsAUABQAFAAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsABAAEAAQAHgANAB4AHgAeAB4AHgAeAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUAArACsADQBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAANAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAWABEAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAA0ADQANAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAANAA0AKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUAArAAQABAArACsAKwArACsAKwArACsAKwArACsAKwBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqAA0ADQAVAFwADQAeAA0AGwBcACoAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwAeAB4AEwATAA0ADQAOAB4AEwATAB4ABAAEAAQACQArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUAAEAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAHgArACsAKwATABMASwBLAEsASwBLAEsASwBLAEsASwBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAArACsAXABcAFwAXABcACsAKwArACsAKwArACsAKwArACsAKwBcAFwAXABcAFwAXABcAFwAXABcAFwAXAArACsAKwArAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAXAArACsAKwAqACoAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAArACsAHgAeAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAqACoAKwAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKwArAAQASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArACoAKgAqACoAKgAqACoAXAAqACoAKgAqACoAKgArACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsABAAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABABQAFAAUABQAFAAUABQACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwANAA0AHgANAA0ADQANAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAAQABAAEAAQAHgAeAB4AHgAeAB4AHgAeAB4AKwArACsABAAEAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwAeAB4AHgAeAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArAA0ADQANAA0ADQBLAEsASwBLAEsASwBLAEsASwBLACsAKwArAFAAUABQAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAA0ADQBQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUAAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArAAQABAAEAB4ABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAAQAUABQAFAAUABQAFAABABQAFAABAAEAAQAUAArACsAKwArACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsABAAEAAQABAAEAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAKwBQACsAUAArAFAAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAB4AHgAeAB4AHgAeAB4AHgBQAB4AHgAeAFAAUABQACsAHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQACsAKwAeAB4AHgAeAB4AHgArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArAFAAUABQACsAHgAeAB4AHgAeAB4AHgAOAB4AKwANAA0ADQANAA0ADQANAAkADQANAA0ACAAEAAsABAAEAA0ACQANAA0ADAAdAB0AHgAXABcAFgAXABcAFwAWABcAHQAdAB4AHgAUABQAFAANAAEAAQAEAAQABAAEAAQACQAaABoAGgAaABoAGgAaABoAHgAXABcAHQAVABUAHgAeAB4AHgAeAB4AGAAWABEAFQAVABUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ADQAeAA0ADQANAA0AHgANAA0ADQAHAB4AHgAeAB4AKwAEAAQABAAEAAQABAAEAAQABAAEAFAAUAArACsATwBQAFAAUABQAFAAHgAeAB4AFgARAE8AUABPAE8ATwBPAFAAUABQAFAAUAAeAB4AHgAWABEAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArABsAGwAbABsAGwAbABsAGgAbABsAGwAbABsAGwAbABsAGwAbABsAGwAbABsAGgAbABsAGwAbABoAGwAbABoAGwAbABsAGwAbABsAGwAbABsAGwAbABsAGwAbABsAGwAbAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAHgAeAFAAGgAeAB0AHgBQAB4AGgAeAB4AHgAeAB4AHgAeAB4AHgBPAB4AUAAbAB4AHgBQAFAAUABQAFAAHgAeAB4AHQAdAB4AUAAeAFAAHgBQAB4AUABPAFAAUAAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAHgBQAFAAUABQAE8ATwBQAFAAUABQAFAATwBQAFAATwBQAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAFAAUABQAFAATwBPAE8ATwBPAE8ATwBPAE8ATwBQAFAAUABQAFAAUABQAFAAUAAeAB4AUABQAFAAUABPAB4AHgArACsAKwArAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB4AHQAdAB4AHgAeAB0AHQAeAB4AHQAeAB4AHgAdAB4AHQAbABsAHgAdAB4AHgAeAB4AHQAeAB4AHQAdAB0AHQAeAB4AHQAeAB0AHgAdAB0AHQAdAB0AHQAeAB0AHgAeAB4AHgAeAB0AHQAdAB0AHgAeAB4AHgAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB4AHgAeAB0AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHgAeAB0AHQAdAB0AHgAeAB0AHQAeAB4AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHQAeAB4AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAeAB4AHgAdAB4AHgAeAB4AHgAeAB4AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABYAEQAWABEAHgAeAB4AHgAeAB4AHQAeAB4AHgAeAB4AHgAeACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAWABEAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAFAAHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeAB4AHgAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAeAB4AHQAdAB0AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHQAeAB0AHQAdAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB0AHQAeAB4AHQAdAB4AHgAeAB4AHQAdAB4AHgAeAB4AHQAdAB0AHgAeAB0AHgAeAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlAB4AHQAdAB4AHgAdAB4AHgAeAB4AHQAdAB4AHgAeAB4AJQAlAB0AHQAlAB4AJQAlACUAIAAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAeAB4AHgAeAB0AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHgAdAB0AHQAeAB0AJQAdAB0AHgAdAB0AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAdAB0AHQAdACUAHgAlACUAJQAdACUAJQAdAB0AHQAlACUAHQAdACUAHQAdACUAJQAlAB4AHQAeAB4AHgAeAB0AHQAlAB0AHQAdAB0AHQAdACUAJQAlACUAJQAdACUAJQAgACUAHQAdACUAJQAlACUAJQAlACUAJQAeAB4AHgAlACUAIAAgACAAIAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AFwAXABcAFwAXABcAHgATABMAJQAeAB4AHgAWABEAFgARABYAEQAWABEAFgARABYAEQAWABEATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABYAEQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAWABEAFgARABYAEQAWABEAFgARAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFgARABYAEQAWABEAFgARABYAEQAWABEAFgARABYAEQAWABEAFgARABYAEQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAWABEAFgARAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFgARAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAEAAQABAAeAB4AKwArACsAKwArABMADQANAA0AUAATAA0AUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAUAANACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAA0ADQANAA0ADQANAA0ADQAeAA0AFgANAB4AHgAXABcAHgAeABcAFwAWABEAFgARABYAEQAWABEADQANAA0ADQATAFAADQANAB4ADQANAB4AHgAeAB4AHgAMAAwADQANAA0AHgANAA0AFgANAA0ADQANAA0ADQANAA0AHgANAB4ADQANAB4AHgAeACsAKwArACsAKwArACsAKwArACsAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAKwArACsAKwArACsAKwArACsAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArAA0AEQARACUAJQBHAFcAVwAWABEAFgARABYAEQAWABEAFgARACUAJQAWABEAFgARABYAEQAWABEAFQAWABEAEQAlAFcAVwBXAFcAVwBXAFcAVwBXAAQABAAEAAQABAAEACUAVwBXAFcAVwA2ACUAJQBXAFcAVwBHAEcAJQAlACUAKwBRAFcAUQBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFEAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBRAFcAUQBXAFEAVwBXAFcAVwBXAFcAUQBXAFcAVwBXAFcAVwBRAFEAKwArAAQABAAVABUARwBHAFcAFQBRAFcAUQBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBRAFcAVwBXAFcAVwBXAFEAUQBXAFcAVwBXABUAUQBHAEcAVwArACsAKwArACsAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwAlACUAVwBXAFcAVwAlACUAJQAlACUAJQAlACUAJQAlACsAKwArACsAKwArACsAKwArACsAKwArAFEAUQBRAFEAUQBRAFEAUQBRAFEAUQBRAFEAUQBRAFEAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQBPAE8ATwBPAE8ATwBPAE8AJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQAlAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAEcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAADQATAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABLAEsASwBLAEsASwBLAEsASwBLAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAABAAEAAQABAAeAAQABAAEAAQABAAEAAQABAAEAAQAHgBQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AUABQAAQABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAeAA0ADQANAA0ADQArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAB4AHgAeAB4AHgAeAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAHgAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAeAB4AUABQAFAAUABQAFAAUABQAFAAUABQAAQAUABQAFAABABQAFAAUABQAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAeAB4AHgAeAAQAKwArACsAUABQAFAAUABQAFAAHgAeABoAHgArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAADgAOABMAEwArACsAKwArACsAKwArACsABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwANAA0ASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAFAAUAAeAB4AHgBQAA4AUABQAAQAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAA0ADQBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArACsAKwArACsAKwArAB4AWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYACsAKwArAAQAHgAeAB4AHgAeAB4ADQANAA0AHgAeAB4AHgArAFAASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArAB4AHgBcAFwAXABcAFwAKgBcAFwAXABcAFwAXABcAFwAXABcAEsASwBLAEsASwBLAEsASwBLAEsAXABcAFwAXABcACsAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArAFAAUABQAAQAUABQAFAAUABQAFAAUABQAAQABAArACsASwBLAEsASwBLAEsASwBLAEsASwArACsAHgANAA0ADQBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKgAqACoAXAAqACoAKgBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAAqAFwAKgAqACoAXABcACoAKgBcAFwAXABcAFwAKgAqAFwAKgBcACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFwAXABcACoAKgBQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAA0ADQBQAFAAUAAEAAQAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUAArACsAUABQAFAAUABQAFAAKwArAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQADQAEAAQAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAVABVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBUAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVACsAKwArACsAKwArACsAKwArACsAKwArAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAKwArACsAKwBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAKwArACsAKwAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAKwArACsAKwArAFYABABWAFYAVgBWAFYAVgBWAFYAVgBWAB4AVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgArAFYAVgBWAFYAVgArAFYAKwBWAFYAKwBWAFYAKwBWAFYAVgBWAFYAVgBWAFYAVgBWAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAEQAWAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUAAaAB4AKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAGAARABEAGAAYABMAEwAWABEAFAArACsAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACUAJQAlACUAJQAWABEAFgARABYAEQAWABEAFgARABYAEQAlACUAFgARACUAJQAlACUAJQAlACUAEQAlABEAKwAVABUAEwATACUAFgARABYAEQAWABEAJQAlACUAJQAlACUAJQAlACsAJQAbABoAJQArACsAKwArAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAcAKwATACUAJQAbABoAJQAlABYAEQAlACUAEQAlABEAJQBXAFcAVwBXAFcAVwBXAFcAVwBXABUAFQAlACUAJQATACUAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXABYAJQARACUAJQAlAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwAWACUAEQAlABYAEQARABYAEQARABUAVwBRAFEAUQBRAFEAUQBRAFEAUQBRAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAEcARwArACsAVwBXAFcAVwBXAFcAKwArAFcAVwBXAFcAVwBXACsAKwBXAFcAVwBXAFcAVwArACsAVwBXAFcAKwArACsAGgAbACUAJQAlABsAGwArAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwAEAAQABAAQAB0AKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsADQANAA0AKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAB4AHgAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAAQAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAA0AUABQAFAAUAArACsAKwArAFAAUABQAFAAUABQAFAAUAANAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwAeACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAKwArAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUAArACsAKwBQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwANAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAB4AUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAUABQAFAAUABQAAQABAAEACsABAAEACsAKwArACsAKwAEAAQABAAEAFAAUABQAFAAKwBQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAQABAAEACsAKwArACsABABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAA0ADQANAA0ADQANAA0ADQAeACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAFAAUABQAFAAUABQAFAAUAAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAArACsAKwArAFAAUABQAFAAUAANAA0ADQANAA0ADQAUACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsADQANAA0ADQANAA0ADQBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAAQABAAEAAQAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUAArAAQABAANACsAKwBQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAB4AHgAeAB4AHgArACsAKwArACsAKwAEAAQABAAEAAQABAAEAA0ADQAeAB4AHgAeAB4AKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgANAA0ADQANACsAKwArACsAKwArACsAKwArACsAKwAeACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsASwBLAEsASwBLAEsASwBLAEsASwANAA0ADQANAFAABAAEAFAAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAeAA4AUAArACsAKwArACsAKwArACsAKwAEAFAAUABQAFAADQANAB4ADQAEAAQABAAEAB4ABAAEAEsASwBLAEsASwBLAEsASwBLAEsAUAAOAFAADQANAA0AKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAANAA0AHgANAA0AHgAEACsAUABQAFAAUABQAFAAUAArAFAAKwBQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAA0AKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsABAAEAAQABAArAFAAUABQAFAAUABQAFAAUAArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQAFAAUABQACsABAAEAFAABAAEAAQABAAEAAQABAArACsABAAEACsAKwAEAAQABAArACsAUAArACsAKwArACsAKwAEACsAKwArACsAKwBQAFAAUABQAFAABAAEACsAKwAEAAQABAAEAAQABAAEACsAKwArAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwArACsABAAEAAQABAAEAAQABABQAFAAUABQAA0ADQANAA0AHgBLAEsASwBLAEsASwBLAEsASwBLAA0ADQArAB4ABABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAAQABAAEAFAAUAAeAFAAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAArACsABAAEAAQABAAEAAQABAAEAAQADgANAA0AEwATAB4AHgAeAA0ADQANAA0ADQANAA0ADQANAA0ADQANAA0ADQANAFAAUABQAFAABAAEACsAKwAEAA0ADQAeAFAAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAFAAKwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKwArACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwBcAFwADQANAA0AKgBQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAKwArAFAAKwArAFAAUABQAFAAUABQAFAAUAArAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQAKwAEAAQAKwArAAQABAAEAAQAUAAEAFAABAAEAA0ADQANACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAArACsABAAEAAQABAAEAAQABABQAA4AUAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAFAABAAEAAQABAAOAB4ADQANAA0ADQAOAB4ABAArACsAKwArACsAKwArACsAUAAEAAQABAAEAAQABAAEAAQABAAEAAQAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAA0ADQANAFAADgAOAA4ADQANACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEACsABAAEAAQABAAEAAQABAAEAFAADQANAA0ADQANACsAKwArACsAKwArACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwAOABMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAArACsAKwAEACsABAAEACsABAAEAAQABAAEAAQABABQAAQAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAKwBQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQAKwAEAAQAKwAEAAQABAAEAAQAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAaABoAGgAaAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsADQANAA0ADQANACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAASABIAEgAQwBDAEMAUABQAFAAUABDAFAAUABQAEgAQwBIAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAASABDAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwAJAAkACQAJAAkACQAJABYAEQArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABIAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwANAA0AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAQABAAEAAQABAANACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAA0ADQANAB4AHgAeAB4AHgAeAFAAUABQAFAADQAeACsAKwArACsAKwArACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAANAA0AHgAeACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwAEAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArACsAKwAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAARwBHABUARwAJACsAKwArACsAKwArACsAKwArACsAKwAEAAQAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACsAKwArACsAKwArACsAKwBXAFcAVwBXAFcAVwBXAFcAVwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUQBRAFEAKwArACsAKwArACsAKwArACsAKwArACsAKwBRAFEAUQBRACsAKwArACsAKwArACsAKwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUAArACsAHgAEAAQADQAEAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArAB4AHgAeAB4AHgAeAB4AKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAAQABAAEAAQABAAeAB4AHgAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAB4AHgAEAAQABAAEAAQABAAEAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQAHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwBQAFAAKwArAFAAKwArAFAAUAArACsAUABQAFAAUAArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAUAArAFAAUABQAFAAUABQAFAAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwBQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAHgAeAFAAUABQAFAAUAArAFAAKwArACsAUABQAFAAUABQAFAAUAArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeACsAKwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgAeAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgAeAB4AHgAeAB4ABAAeAB4AHgAeAB4AHgAeAB4AHgAeAAQAHgAeAA0ADQANAA0AHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAAQABAAEAAQAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAEAAQAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArAAQABAAEAAQABAAEAAQAKwAEAAQAKwAEAAQABAAEAAQAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwAEAAQABAAEAAQABAAEAFAAUABQAFAAUABQAFAAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwBQAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArABsAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArAB4AHgAeAB4ABAAEAAQABAAEAAQABABQACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArABYAFgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAGgBQAFAAUAAaAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAKwBQACsAKwBQACsAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAKwBQACsAUAArACsAKwArACsAKwBQACsAKwArACsAUAArAFAAKwBQACsAUABQAFAAKwBQAFAAKwBQACsAKwBQACsAUAArAFAAKwBQACsAUAArAFAAUAArAFAAKwArAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQAFAAUAArAFAAUABQAFAAKwBQACsAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAUABQAFAAKwBQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8AJQAlACUAHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB4AHgAeACUAJQAlAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAJQAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlAB4AHgAlACUAJQAlACUAHgAlACUAJQAlACUAIAAgACAAJQAlACAAJQAlACAAIAAgACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACEAIQAhACEAIQAlACUAIAAgACUAJQAgACAAIAAgACAAIAAgACAAIAAgACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAJQAlACUAIAAlACUAJQAlACAAIAAgACUAIAAgACAAJQAlACUAJQAlACUAJQAgACUAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAlAB4AJQAeACUAJQAlACUAJQAgACUAJQAlACUAHgAlAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAJQAlACUAJQAgACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACAAIAAgACUAJQAlACAAIAAgACAAIAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABcAFwAXABUAFQAVAB4AHgAeAB4AJQAlACUAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAgACUAJQAlACUAJQAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAgACUAJQAgACUAJQAlACUAJQAlACUAJQAgACAAIAAgACAAIAAgACAAJQAlACUAJQAlACUAIAAlACUAJQAlACUAJQAlACUAJQAgACAAIAAgACAAIAAgACAAIAAgACUAJQAgACAAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAgACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAlACAAIAAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAgACAAIAAlACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAJQAlAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAKwArAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwAlACUAJQAlACUAJQAlACUAJQAlACUAVwBXACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAKwAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAA==",Pu=50,Lx=1,Tp=2,Dp=3,Ux=4,Ox=5,Bu=7,Rp=8,yu=9,ns=10,qA=11,xu=12,JA=13,kx=14,Gr=15,el=16,$o=17,Or=18,Nx=19,wu=20,tl=21,kr=22,lA=23,Gs=24,hi=25,zr=26,Kr=27,zs=28,Qx=29,vs=30,Hx=31,Zo=32,qo=33,il=34,sl=35,rl=36,no=37,ol=38,yn=39,xn=40,cA=41,Lp=42,Vx=43,jx=[9001,65288],Up="!",nt="",Jo="",nl=Sx(Rx),Gi=[vs,rl],al=[Lx,Tp,Dp,Ox],Op=[ns,Rp],bu=[Kr,zr],Gx=al.concat(Op),Cu=[ol,yn,xn,il,sl],zx=[Gr,JA],Kx=function(r,e){e===void 0&&(e="strict");var i=[],s=[],t=[];return r.forEach(function(o,n){var a=nl.get(o);if(a>Pu?(t.push(!0),a-=Pu):t.push(!1),["normal","auto","loose"].indexOf(e)!==-1&&[8208,8211,12316,12448].indexOf(o)!==-1)return s.push(n),i.push(el);if(a===Ux||a===qA){if(n===0)return s.push(n),i.push(vs);var A=i[n-1];return Gx.indexOf(A)===-1?(s.push(s[n-1]),i.push(A)):(s.push(n),i.push(vs))}if(s.push(n),a===Hx)return i.push(e==="strict"?tl:no);if(a===Lp||a===Qx)return i.push(vs);if(a===Vx)return o>=131072&&o<=196605||o>=196608&&o<=262141?i.push(no):i.push(vs);i.push(a)}),[s,i,t]},hA=function(r,e,i,s){var t=s[i];if(Array.isArray(r)?r.indexOf(t)!==-1:r===t)for(var o=i;o<=s.length;){o++;var n=s[o];if(n===e)return!0;if(n!==ns)break}if(t===ns)for(var o=i;o>0;){o--;var a=s[o];if(Array.isArray(r)?r.indexOf(a)!==-1:r===a)for(var A=i;A<=s.length;){A++;var n=s[A];if(n===e)return!0;if(n!==ns)break}if(a!==ns)break}return!1},Eu=function(r,e){for(var i=r;i>=0;){var s=e[i];if(s===ns)i--;else return s}return 0},Wx=function(r,e,i,s,t){if(i[s]===0)return nt;var o=s-1;if(Array.isArray(t)&&t[o]===!0)return nt;var n=o-1,a=o+1,A=e[o],l=n>=0?e[n]:0,h=e[a];if(A===Tp&&h===Dp)return nt;if(al.indexOf(A)!==-1)return Up;if(al.indexOf(h)!==-1||Op.indexOf(h)!==-1)return nt;if(Eu(o,e)===Rp)return Jo;if(nl.get(r[o])===qA||(A===Zo||A===qo)&&nl.get(r[a])===qA||A===Bu||h===Bu||A===yu||[ns,JA,Gr].indexOf(A)===-1&&h===yu||[$o,Or,Nx,Gs,zs].indexOf(h)!==-1||Eu(o,e)===kr||hA(lA,kr,o,e)||hA([$o,Or],tl,o,e)||hA(xu,xu,o,e))return nt;if(A===ns)return Jo;if(A===lA||h===lA)return nt;if(h===el||A===el)return Jo;if([JA,Gr,tl].indexOf(h)!==-1||A===kx||l===rl&&zx.indexOf(A)!==-1||A===zs&&h===rl||h===wu||Gi.indexOf(h)!==-1&&A===hi||Gi.indexOf(A)!==-1&&h===hi||A===Kr&&[no,Zo,qo].indexOf(h)!==-1||[no,Zo,qo].indexOf(A)!==-1&&h===zr||Gi.indexOf(A)!==-1&&bu.indexOf(h)!==-1||bu.indexOf(A)!==-1&&Gi.indexOf(h)!==-1||[Kr,zr].indexOf(A)!==-1&&(h===hi||[kr,Gr].indexOf(h)!==-1&&e[a+1]===hi)||[kr,Gr].indexOf(A)!==-1&&h===hi||A===hi&&[hi,zs,Gs].indexOf(h)!==-1)return nt;if([hi,zs,Gs,$o,Or].indexOf(h)!==-1)for(var d=o;d>=0;){var f=e[d];if(f===hi)return nt;if([zs,Gs].indexOf(f)!==-1)d--;else break}if([Kr,zr].indexOf(h)!==-1)for(var d=[$o,Or].indexOf(A)!==-1?n:o;d>=0;){var f=e[d];if(f===hi)return nt;if([zs,Gs].indexOf(f)!==-1)d--;else break}if(ol===A&&[ol,yn,il,sl].indexOf(h)!==-1||[yn,il].indexOf(A)!==-1&&[yn,xn].indexOf(h)!==-1||[xn,sl].indexOf(A)!==-1&&h===xn||Cu.indexOf(A)!==-1&&[wu,zr].indexOf(h)!==-1||Cu.indexOf(h)!==-1&&A===Kr||Gi.indexOf(A)!==-1&&Gi.indexOf(h)!==-1||A===Gs&&Gi.indexOf(h)!==-1||Gi.concat(hi).indexOf(A)!==-1&&h===kr&&jx.indexOf(r[a])===-1||Gi.concat(hi).indexOf(h)!==-1&&A===Or)return nt;if(A===cA&&h===cA){for(var m=i[o],_=1;m>0&&(m--,e[m]===cA);)_++;if(_%2!==0)return nt}return A===Zo&&h===qo?nt:Jo},Xx=function(r,e){e||(e={lineBreak:"normal",wordBreak:"normal"});var i=Kx(r,e.lineBreak),s=i[0],t=i[1],o=i[2];(e.wordBreak==="break-all"||e.wordBreak==="break-word")&&(t=t.map(function(a){return[hi,vs,Lp].indexOf(a)!==-1?no:a}));var n=e.wordBreak==="keep-all"?o.map(function(a,A){return a&&r[A]>=19968&&r[A]<=40959}):void 0;return[s,t,n]},Yx=function(){function r(e,i,s,t){this.codePoints=e,this.required=i===Up,this.start=s,this.end=t}return r.prototype.slice=function(){return Rt.apply(void 0,this.codePoints.slice(this.start,this.end))},r}(),$x=function(r,e){var i=Xn(r),s=Xx(i,e),t=s[0],o=s[1],n=s[2],a=i.length,A=0,l=0;return{next:function(){if(l>=a)return{done:!0,value:null};for(var h=nt;l<a&&(h=Wx(i,o,t,++l,n))===nt;);if(h!==nt||l===a){var d=new Yx(i,h,A,l);return A=l,{value:d,done:!1}}return{done:!0,value:null}}}},Zx=1,qx=2,uo=4,Iu=8,Tn=10,Fu=47,qr=92,Jx=9,ew=32,en=34,Nr=61,tw=35,iw=36,sw=37,tn=39,sn=40,Qr=41,rw=95,Ai=45,ow=33,nw=60,aw=62,Aw=64,lw=91,cw=93,hw=61,uw=123,rn=63,dw=125,Mu=124,pw=126,fw=128,Su=65533,uA=42,xs=43,gw=44,mw=58,_w=59,ao=46,vw=0,Pw=8,Bw=11,yw=14,xw=31,ww=127,Ti=-1,kp=48,Np=97,Qp=101,bw=102,Cw=117,Ew=122,Hp=65,Vp=69,jp=70,Iw=85,Fw=90,Jt=function(r){return r>=kp&&r<=57},Mw=function(r){return r>=55296&&r<=57343},Ks=function(r){return Jt(r)||r>=Hp&&r<=jp||r>=Np&&r<=bw},Sw=function(r){return r>=Np&&r<=Ew},Tw=function(r){return r>=Hp&&r<=Fw},Dw=function(r){return Sw(r)||Tw(r)},Rw=function(r){return r>=fw},on=function(r){return r===Tn||r===Jx||r===ew},Dn=function(r){return Dw(r)||Rw(r)||r===rw},Tu=function(r){return Dn(r)||Jt(r)||r===Ai},Lw=function(r){return r>=vw&&r<=Pw||r===Bw||r>=yw&&r<=xw||r===ww},rs=function(r,e){return r!==qr?!1:e!==Tn},nn=function(r,e,i){return r===Ai?Dn(e)||rs(e,i):Dn(r)?!0:!!(r===qr&&rs(r,e))},dA=function(r,e,i){return r===xs||r===Ai?Jt(e)?!0:e===ao&&Jt(i):Jt(r===ao?e:r)},Uw=function(r){var e=0,i=1;(r[e]===xs||r[e]===Ai)&&(r[e]===Ai&&(i=-1),e++);for(var s=[];Jt(r[e]);)s.push(r[e++]);var t=s.length?parseInt(Rt.apply(void 0,s),10):0;r[e]===ao&&e++;for(var o=[];Jt(r[e]);)o.push(r[e++]);var n=o.length,a=n?parseInt(Rt.apply(void 0,o),10):0;(r[e]===Vp||r[e]===Qp)&&e++;var A=1;(r[e]===xs||r[e]===Ai)&&(r[e]===Ai&&(A=-1),e++);for(var l=[];Jt(r[e]);)l.push(r[e++]);var h=l.length?parseInt(Rt.apply(void 0,l),10):0;return i*(t+a*Math.pow(10,-n))*Math.pow(10,A*h)},Ow={type:2},kw={type:3},Nw={type:4},Qw={type:13},Hw={type:8},Vw={type:21},jw={type:9},Gw={type:10},zw={type:11},Kw={type:12},Ww={type:14},an={type:23},Xw={type:1},Yw={type:25},$w={type:24},Zw={type:26},qw={type:27},Jw={type:28},eb={type:29},tb={type:31},Al={type:32},Gp=function(){function r(){this._value=[]}return r.prototype.write=function(e){this._value=this._value.concat(Xn(e))},r.prototype.read=function(){for(var e=[],i=this.consumeToken();i!==Al;)e.push(i),i=this.consumeToken();return e},r.prototype.consumeToken=function(){var e=this.consumeCodePoint();switch(e){case en:return this.consumeStringToken(en);case tw:var i=this.peekCodePoint(0),s=this.peekCodePoint(1),t=this.peekCodePoint(2);if(Tu(i)||rs(s,t)){var o=nn(i,s,t)?qx:Zx,n=this.consumeName();return{type:5,value:n,flags:o}}break;case iw:if(this.peekCodePoint(0)===Nr)return this.consumeCodePoint(),Qw;break;case tn:return this.consumeStringToken(tn);case sn:return Ow;case Qr:return kw;case uA:if(this.peekCodePoint(0)===Nr)return this.consumeCodePoint(),Ww;break;case xs:if(dA(e,this.peekCodePoint(0),this.peekCodePoint(1)))return this.reconsumeCodePoint(e),this.consumeNumericToken();break;case gw:return Nw;case Ai:var a=e,A=this.peekCodePoint(0),l=this.peekCodePoint(1);if(dA(a,A,l))return this.reconsumeCodePoint(e),this.consumeNumericToken();if(nn(a,A,l))return this.reconsumeCodePoint(e),this.consumeIdentLikeToken();if(A===Ai&&l===aw)return this.consumeCodePoint(),this.consumeCodePoint(),$w;break;case ao:if(dA(e,this.peekCodePoint(0),this.peekCodePoint(1)))return this.reconsumeCodePoint(e),this.consumeNumericToken();break;case Fu:if(this.peekCodePoint(0)===uA)for(this.consumeCodePoint();;){var h=this.consumeCodePoint();if(h===uA&&(h=this.consumeCodePoint(),h===Fu))return this.consumeToken();if(h===Ti)return this.consumeToken()}break;case mw:return Zw;case _w:return qw;case nw:if(this.peekCodePoint(0)===ow&&this.peekCodePoint(1)===Ai&&this.peekCodePoint(2)===Ai)return this.consumeCodePoint(),this.consumeCodePoint(),Yw;break;case Aw:var d=this.peekCodePoint(0),f=this.peekCodePoint(1),m=this.peekCodePoint(2);if(nn(d,f,m)){var n=this.consumeName();return{type:7,value:n}}break;case lw:return Jw;case qr:if(rs(e,this.peekCodePoint(0)))return this.reconsumeCodePoint(e),this.consumeIdentLikeToken();break;case cw:return eb;case hw:if(this.peekCodePoint(0)===Nr)return this.consumeCodePoint(),Hw;break;case uw:return zw;case dw:return Kw;case Cw:case Iw:var _=this.peekCodePoint(0),u=this.peekCodePoint(1);return _===xs&&(Ks(u)||u===rn)&&(this.consumeCodePoint(),this.consumeUnicodeRangeToken()),this.reconsumeCodePoint(e),this.consumeIdentLikeToken();case Mu:if(this.peekCodePoint(0)===Nr)return this.consumeCodePoint(),jw;if(this.peekCodePoint(0)===Mu)return this.consumeCodePoint(),Vw;break;case pw:if(this.peekCodePoint(0)===Nr)return this.consumeCodePoint(),Gw;break;case Ti:return Al}return on(e)?(this.consumeWhiteSpace(),tb):Jt(e)?(this.reconsumeCodePoint(e),this.consumeNumericToken()):Dn(e)?(this.reconsumeCodePoint(e),this.consumeIdentLikeToken()):{type:6,value:Rt(e)}},r.prototype.consumeCodePoint=function(){var e=this._value.shift();return typeof e>"u"?-1:e},r.prototype.reconsumeCodePoint=function(e){this._value.unshift(e)},r.prototype.peekCodePoint=function(e){return e>=this._value.length?-1:this._value[e]},r.prototype.consumeUnicodeRangeToken=function(){for(var e=[],i=this.consumeCodePoint();Ks(i)&&e.length<6;)e.push(i),i=this.consumeCodePoint();for(var s=!1;i===rn&&e.length<6;)e.push(i),i=this.consumeCodePoint(),s=!0;if(s){var t=parseInt(Rt.apply(void 0,e.map(function(A){return A===rn?kp:A})),16),o=parseInt(Rt.apply(void 0,e.map(function(A){return A===rn?jp:A})),16);return{type:30,start:t,end:o}}var n=parseInt(Rt.apply(void 0,e),16);if(this.peekCodePoint(0)===Ai&&Ks(this.peekCodePoint(1))){this.consumeCodePoint(),i=this.consumeCodePoint();for(var a=[];Ks(i)&&a.length<6;)a.push(i),i=this.consumeCodePoint();var o=parseInt(Rt.apply(void 0,a),16);return{type:30,start:n,end:o}}else return{type:30,start:n,end:n}},r.prototype.consumeIdentLikeToken=function(){var e=this.consumeName();return e.toLowerCase()==="url"&&this.peekCodePoint(0)===sn?(this.consumeCodePoint(),this.consumeUrlToken()):this.peekCodePoint(0)===sn?(this.consumeCodePoint(),{type:19,value:e}):{type:20,value:e}},r.prototype.consumeUrlToken=function(){var e=[];if(this.consumeWhiteSpace(),this.peekCodePoint(0)===Ti)return{type:22,value:""};var i=this.peekCodePoint(0);if(i===tn||i===en){var s=this.consumeStringToken(this.consumeCodePoint());return s.type===0&&(this.consumeWhiteSpace(),this.peekCodePoint(0)===Ti||this.peekCodePoint(0)===Qr)?(this.consumeCodePoint(),{type:22,value:s.value}):(this.consumeBadUrlRemnants(),an)}for(;;){var t=this.consumeCodePoint();if(t===Ti||t===Qr)return{type:22,value:Rt.apply(void 0,e)};if(on(t))return this.consumeWhiteSpace(),this.peekCodePoint(0)===Ti||this.peekCodePoint(0)===Qr?(this.consumeCodePoint(),{type:22,value:Rt.apply(void 0,e)}):(this.consumeBadUrlRemnants(),an);if(t===en||t===tn||t===sn||Lw(t))return this.consumeBadUrlRemnants(),an;if(t===qr)if(rs(t,this.peekCodePoint(0)))e.push(this.consumeEscapedCodePoint());else return this.consumeBadUrlRemnants(),an;else e.push(t)}},r.prototype.consumeWhiteSpace=function(){for(;on(this.peekCodePoint(0));)this.consumeCodePoint()},r.prototype.consumeBadUrlRemnants=function(){for(;;){var e=this.consumeCodePoint();if(e===Qr||e===Ti)return;rs(e,this.peekCodePoint(0))&&this.consumeEscapedCodePoint()}},r.prototype.consumeStringSlice=function(e){for(var i=5e4,s="";e>0;){var t=Math.min(i,e);s+=Rt.apply(void 0,this._value.splice(0,t)),e-=t}return this._value.shift(),s},r.prototype.consumeStringToken=function(e){var i="",s=0;do{var t=this._value[s];if(t===Ti||t===void 0||t===e)return i+=this.consumeStringSlice(s),{type:0,value:i};if(t===Tn)return this._value.splice(0,s),Xw;if(t===qr){var o=this._value[s+1];o!==Ti&&o!==void 0&&(o===Tn?(i+=this.consumeStringSlice(s),s=-1,this._value.shift()):rs(t,o)&&(i+=this.consumeStringSlice(s),i+=Rt(this.consumeEscapedCodePoint()),s=-1))}s++}while(!0)},r.prototype.consumeNumber=function(){var e=[],i=uo,s=this.peekCodePoint(0);for((s===xs||s===Ai)&&e.push(this.consumeCodePoint());Jt(this.peekCodePoint(0));)e.push(this.consumeCodePoint());s=this.peekCodePoint(0);var t=this.peekCodePoint(1);if(s===ao&&Jt(t))for(e.push(this.consumeCodePoint(),this.consumeCodePoint()),i=Iu;Jt(this.peekCodePoint(0));)e.push(this.consumeCodePoint());s=this.peekCodePoint(0),t=this.peekCodePoint(1);var o=this.peekCodePoint(2);if((s===Vp||s===Qp)&&((t===xs||t===Ai)&&Jt(o)||Jt(t)))for(e.push(this.consumeCodePoint(),this.consumeCodePoint()),i=Iu;Jt(this.peekCodePoint(0));)e.push(this.consumeCodePoint());return[Uw(e),i]},r.prototype.consumeNumericToken=function(){var e=this.consumeNumber(),i=e[0],s=e[1],t=this.peekCodePoint(0),o=this.peekCodePoint(1),n=this.peekCodePoint(2);if(nn(t,o,n)){var a=this.consumeName();return{type:15,number:i,flags:s,unit:a}}return t===sw?(this.consumeCodePoint(),{type:16,number:i,flags:s}):{type:17,number:i,flags:s}},r.prototype.consumeEscapedCodePoint=function(){var e=this.consumeCodePoint();if(Ks(e)){for(var i=Rt(e);Ks(this.peekCodePoint(0))&&i.length<6;)i+=Rt(this.consumeCodePoint());on(this.peekCodePoint(0))&&this.consumeCodePoint();var s=parseInt(i,16);return s===0||Mw(s)||s>1114111?Su:s}return e===Ti?Su:e},r.prototype.consumeName=function(){for(var e="";;){var i=this.consumeCodePoint();if(Tu(i))e+=Rt(i);else if(rs(i,this.peekCodePoint(0)))e+=Rt(this.consumeEscapedCodePoint());else return this.reconsumeCodePoint(i),e}},r}(),zp=function(){function r(e){this._tokens=e}return r.create=function(e){var i=new Gp;return i.write(e),new r(i.read())},r.parseValue=function(e){return r.create(e).parseComponentValue()},r.parseValues=function(e){return r.create(e).parseComponentValues()},r.prototype.parseComponentValue=function(){for(var e=this.consumeToken();e.type===31;)e=this.consumeToken();if(e.type===32)throw new SyntaxError("Error parsing CSS component value, unexpected EOF");this.reconsumeToken(e);var i=this.consumeComponentValue();do e=this.consumeToken();while(e.type===31);if(e.type===32)return i;throw new SyntaxError("Error parsing CSS component value, multiple values found when expecting only one")},r.prototype.parseComponentValues=function(){for(var e=[];;){var i=this.consumeComponentValue();if(i.type===32)return e;e.push(i),e.push()}},r.prototype.consumeComponentValue=function(){var e=this.consumeToken();switch(e.type){case 11:case 28:case 2:return this.consumeSimpleBlock(e.type);case 19:return this.consumeFunction(e)}return e},r.prototype.consumeSimpleBlock=function(e){for(var i={type:e,values:[]},s=this.consumeToken();;){if(s.type===32||sb(s,e))return i;this.reconsumeToken(s),i.values.push(this.consumeComponentValue()),s=this.consumeToken()}},r.prototype.consumeFunction=function(e){for(var i={name:e.value,values:[],type:18};;){var s=this.consumeToken();if(s.type===32||s.type===3)return i;this.reconsumeToken(s),i.values.push(this.consumeComponentValue())}},r.prototype.consumeToken=function(){var e=this._tokens.shift();return typeof e>"u"?Al:e},r.prototype.reconsumeToken=function(e){this._tokens.unshift(e)},r}(),po=function(r){return r.type===15},pr=function(r){return r.type===17},Pt=function(r){return r.type===20},ib=function(r){return r.type===0},ll=function(r,e){return Pt(r)&&r.value===e},Kp=function(r){return r.type!==31},ur=function(r){return r.type!==31&&r.type!==4},Li=function(r){var e=[],i=[];return r.forEach(function(s){if(s.type===4){if(i.length===0)throw new Error("Error parsing function args, zero tokens for arg");e.push(i),i=[];return}s.type!==31&&i.push(s)}),i.length&&e.push(i),e},sb=function(r,e){return e===11&&r.type===12||e===28&&r.type===29?!0:e===2&&r.type===3},us=function(r){return r.type===17||r.type===15},kt=function(r){return r.type===16||us(r)},Wp=function(r){return r.length>1?[r[0],r[1]]:[r[0]]},$t={type:17,number:0,flags:uo},wl={type:16,number:50,flags:uo},as={type:16,number:100,flags:uo},Wr=function(r,e,i){var s=r[0],t=r[1];return[yt(s,e),yt(typeof t<"u"?t:s,i)]},yt=function(r,e){if(r.type===16)return r.number/100*e;if(po(r))switch(r.unit){case"rem":case"em":return 16*r.number;case"px":default:return r.number}return r.number},Xp="deg",Yp="grad",$p="rad",Zp="turn",Yn={name:"angle",parse:function(r,e){if(e.type===15)switch(e.unit){case Xp:return Math.PI*e.number/180;case Yp:return Math.PI/200*e.number;case $p:return e.number;case Zp:return Math.PI*2*e.number}throw new Error("Unsupported angle type")}},qp=function(r){return r.type===15&&(r.unit===Xp||r.unit===Yp||r.unit===$p||r.unit===Zp)},Jp=function(r){var e=r.filter(Pt).map(function(i){return i.value}).join(" ");switch(e){case"to bottom right":case"to right bottom":case"left top":case"top left":return[$t,$t];case"to top":case"bottom":return Bi(0);case"to bottom left":case"to left bottom":case"right top":case"top right":return[$t,as];case"to right":case"left":return Bi(90);case"to top left":case"to left top":case"right bottom":case"bottom right":return[as,as];case"to bottom":case"top":return Bi(180);case"to top right":case"to right top":case"left bottom":case"bottom left":return[as,$t];case"to left":case"right":return Bi(270)}return 0},Bi=function(r){return Math.PI*r/180},ls={name:"color",parse:function(r,e){if(e.type===18){var i=rb[e.name];if(typeof i>"u")throw new Error('Attempting to parse an unsupported color function "'+e.name+'"');return i(r,e.values)}if(e.type===5){if(e.value.length===3){var s=e.value.substring(0,1),t=e.value.substring(1,2),o=e.value.substring(2,3);return As(parseInt(s+s,16),parseInt(t+t,16),parseInt(o+o,16),1)}if(e.value.length===4){var s=e.value.substring(0,1),t=e.value.substring(1,2),o=e.value.substring(2,3),n=e.value.substring(3,4);return As(parseInt(s+s,16),parseInt(t+t,16),parseInt(o+o,16),parseInt(n+n,16)/255)}if(e.value.length===6){var s=e.value.substring(0,2),t=e.value.substring(2,4),o=e.value.substring(4,6);return As(parseInt(s,16),parseInt(t,16),parseInt(o,16),1)}if(e.value.length===8){var s=e.value.substring(0,2),t=e.value.substring(2,4),o=e.value.substring(4,6),n=e.value.substring(6,8);return As(parseInt(s,16),parseInt(t,16),parseInt(o,16),parseInt(n,16)/255)}}if(e.type===20){var a=Yi[e.value.toUpperCase()];if(typeof a<"u")return a}return Yi.TRANSPARENT}},cs=function(r){return(255&r)===0},Vt=function(r){var e=255&r,i=255&r>>8,s=255&r>>16,t=255&r>>24;return e<255?"rgba("+t+","+s+","+i+","+e/255+")":"rgb("+t+","+s+","+i+")"},As=function(r,e,i,s){return(r<<24|e<<16|i<<8|Math.round(s*255)<<0)>>>0},Du=function(r,e){if(r.type===17)return r.number;if(r.type===16){var i=e===3?1:255;return e===3?r.number/100*i:Math.round(r.number/100*i)}return 0},Ru=function(r,e){var i=e.filter(ur);if(i.length===3){var s=i.map(Du),t=s[0],o=s[1],n=s[2];return As(t,o,n,1)}if(i.length===4){var a=i.map(Du),t=a[0],o=a[1],n=a[2],A=a[3];return As(t,o,n,A)}return 0};function pA(r,e,i){return i<0&&(i+=1),i>=1&&(i-=1),i<1/6?(e-r)*i*6+r:i<1/2?e:i<2/3?(e-r)*6*(2/3-i)+r:r}var Lu=function(r,e){var i=e.filter(ur),s=i[0],t=i[1],o=i[2],n=i[3],a=(s.type===17?Bi(s.number):Yn.parse(r,s))/(Math.PI*2),A=kt(t)?t.number/100:0,l=kt(o)?o.number/100:0,h=typeof n<"u"&&kt(n)?yt(n,1):1;if(A===0)return As(l*255,l*255,l*255,1);var d=l<=.5?l*(A+1):l+A-l*A,f=l*2-d,m=pA(f,d,a+1/3),_=pA(f,d,a),u=pA(f,d,a-1/3);return As(m*255,_*255,u*255,h)},rb={hsl:Lu,hsla:Lu,rgb:Ru,rgba:Ru},Jr=function(r,e){return ls.parse(r,zp.create(e).parseComponentValue())},Yi={ALICEBLUE:4042850303,ANTIQUEWHITE:4209760255,AQUA:16777215,AQUAMARINE:2147472639,AZURE:4043309055,BEIGE:4126530815,BISQUE:4293182719,BLACK:255,BLANCHEDALMOND:4293643775,BLUE:65535,BLUEVIOLET:2318131967,BROWN:2771004159,BURLYWOOD:3736635391,CADETBLUE:1604231423,CHARTREUSE:2147418367,CHOCOLATE:3530104575,CORAL:4286533887,CORNFLOWERBLUE:1687547391,CORNSILK:4294499583,CRIMSON:3692313855,CYAN:16777215,DARKBLUE:35839,DARKCYAN:9145343,DARKGOLDENROD:3095837695,DARKGRAY:2846468607,DARKGREEN:6553855,DARKGREY:2846468607,DARKKHAKI:3182914559,DARKMAGENTA:2332068863,DARKOLIVEGREEN:1433087999,DARKORANGE:4287365375,DARKORCHID:2570243327,DARKRED:2332033279,DARKSALMON:3918953215,DARKSEAGREEN:2411499519,DARKSLATEBLUE:1211993087,DARKSLATEGRAY:793726975,DARKSLATEGREY:793726975,DARKTURQUOISE:13554175,DARKVIOLET:2483082239,DEEPPINK:4279538687,DEEPSKYBLUE:12582911,DIMGRAY:1768516095,DIMGREY:1768516095,DODGERBLUE:512819199,FIREBRICK:2988581631,FLORALWHITE:4294635775,FORESTGREEN:579543807,FUCHSIA:4278255615,GAINSBORO:3705462015,GHOSTWHITE:4177068031,GOLD:4292280575,GOLDENROD:3668254975,GRAY:2155905279,GREEN:8388863,GREENYELLOW:2919182335,GREY:2155905279,HONEYDEW:4043305215,HOTPINK:4285117695,INDIANRED:3445382399,INDIGO:1258324735,IVORY:4294963455,KHAKI:4041641215,LAVENDER:3873897215,LAVENDERBLUSH:4293981695,LAWNGREEN:2096890111,LEMONCHIFFON:4294626815,LIGHTBLUE:2916673279,LIGHTCORAL:4034953471,LIGHTCYAN:3774873599,LIGHTGOLDENRODYELLOW:4210742015,LIGHTGRAY:3553874943,LIGHTGREEN:2431553791,LIGHTGREY:3553874943,LIGHTPINK:4290167295,LIGHTSALMON:4288707327,LIGHTSEAGREEN:548580095,LIGHTSKYBLUE:2278488831,LIGHTSLATEGRAY:2005441023,LIGHTSLATEGREY:2005441023,LIGHTSTEELBLUE:2965692159,LIGHTYELLOW:4294959359,LIME:16711935,LIMEGREEN:852308735,LINEN:4210091775,MAGENTA:4278255615,MAROON:2147483903,MEDIUMAQUAMARINE:1724754687,MEDIUMBLUE:52735,MEDIUMORCHID:3126187007,MEDIUMPURPLE:2473647103,MEDIUMSEAGREEN:1018393087,MEDIUMSLATEBLUE:2070474495,MEDIUMSPRINGGREEN:16423679,MEDIUMTURQUOISE:1221709055,MEDIUMVIOLETRED:3340076543,MIDNIGHTBLUE:421097727,MINTCREAM:4127193855,MISTYROSE:4293190143,MOCCASIN:4293178879,NAVAJOWHITE:4292783615,NAVY:33023,OLDLACE:4260751103,OLIVE:2155872511,OLIVEDRAB:1804477439,ORANGE:4289003775,ORANGERED:4282712319,ORCHID:3664828159,PALEGOLDENROD:4008225535,PALEGREEN:2566625535,PALETURQUOISE:2951671551,PALEVIOLETRED:3681588223,PAPAYAWHIP:4293907967,PEACHPUFF:4292524543,PERU:3448061951,PINK:4290825215,PLUM:3718307327,POWDERBLUE:2967529215,PURPLE:2147516671,REBECCAPURPLE:1714657791,RED:4278190335,ROSYBROWN:3163525119,ROYALBLUE:1097458175,SADDLEBROWN:2336560127,SALMON:4202722047,SANDYBROWN:4104413439,SEAGREEN:780883967,SEASHELL:4294307583,SIENNA:2689740287,SILVER:3233857791,SKYBLUE:2278484991,SLATEBLUE:1784335871,SLATEGRAY:1887473919,SLATEGREY:1887473919,SNOW:4294638335,SPRINGGREEN:16744447,STEELBLUE:1182971135,TAN:3535047935,TEAL:8421631,THISTLE:3636451583,TOMATO:4284696575,TRANSPARENT:0,TURQUOISE:1088475391,VIOLET:4001558271,WHEAT:4125012991,WHITE:4294967295,WHITESMOKE:4126537215,YELLOW:4294902015,YELLOWGREEN:2597139199},ob={name:"background-clip",initialValue:"border-box",prefix:!1,type:1,parse:function(r,e){return e.map(function(i){if(Pt(i))switch(i.value){case"padding-box":return 1;case"content-box":return 2}return 0})}},nb={name:"background-color",initialValue:"transparent",prefix:!1,type:3,format:"color"},$n=function(r,e){var i=ls.parse(r,e[0]),s=e[1];return s&&kt(s)?{color:i,stop:s}:{color:i,stop:null}},Uu=function(r,e){var i=r[0],s=r[r.length-1];i.stop===null&&(i.stop=$t),s.stop===null&&(s.stop=as);for(var t=[],o=0,n=0;n<r.length;n++){var a=r[n].stop;if(a!==null){var A=yt(a,e);A>o?t.push(A):t.push(o),o=A}else t.push(null)}for(var l=null,n=0;n<t.length;n++){var h=t[n];if(h===null)l===null&&(l=n);else if(l!==null){for(var d=n-l,f=t[l-1],m=(h-f)/(d+1),_=1;_<=d;_++)t[l+_-1]=m*_;l=null}}return r.map(function(u,P){var y=u.color;return{color:y,stop:Math.max(Math.min(1,t[P]/e),0)}})},ab=function(r,e,i){var s=e/2,t=i/2,o=yt(r[0],e)-s,n=t-yt(r[1],i);return(Math.atan2(n,o)+Math.PI*2)%(Math.PI*2)},Ab=function(r,e,i){var s=typeof r=="number"?r:ab(r,e,i),t=Math.abs(e*Math.sin(s))+Math.abs(i*Math.cos(s)),o=e/2,n=i/2,a=t/2,A=Math.sin(s-Math.PI/2)*a,l=Math.cos(s-Math.PI/2)*a;return[t,o-l,o+l,n-A,n+A]},wi=function(r,e){return Math.sqrt(r*r+e*e)},Ou=function(r,e,i,s,t){var o=[[0,0],[0,e],[r,0],[r,e]];return o.reduce(function(n,a){var A=a[0],l=a[1],h=wi(i-A,s-l);return(t?h<n.optimumDistance:h>n.optimumDistance)?{optimumCorner:a,optimumDistance:h}:n},{optimumDistance:t?1/0:-1/0,optimumCorner:null}).optimumCorner},lb=function(r,e,i,s,t){var o=0,n=0;switch(r.size){case 0:r.shape===0?o=n=Math.min(Math.abs(e),Math.abs(e-s),Math.abs(i),Math.abs(i-t)):r.shape===1&&(o=Math.min(Math.abs(e),Math.abs(e-s)),n=Math.min(Math.abs(i),Math.abs(i-t)));break;case 2:if(r.shape===0)o=n=Math.min(wi(e,i),wi(e,i-t),wi(e-s,i),wi(e-s,i-t));else if(r.shape===1){var a=Math.min(Math.abs(i),Math.abs(i-t))/Math.min(Math.abs(e),Math.abs(e-s)),A=Ou(s,t,e,i,!0),l=A[0],h=A[1];o=wi(l-e,(h-i)/a),n=a*o}break;case 1:r.shape===0?o=n=Math.max(Math.abs(e),Math.abs(e-s),Math.abs(i),Math.abs(i-t)):r.shape===1&&(o=Math.max(Math.abs(e),Math.abs(e-s)),n=Math.max(Math.abs(i),Math.abs(i-t)));break;case 3:if(r.shape===0)o=n=Math.max(wi(e,i),wi(e,i-t),wi(e-s,i),wi(e-s,i-t));else if(r.shape===1){var a=Math.max(Math.abs(i),Math.abs(i-t))/Math.max(Math.abs(e),Math.abs(e-s)),d=Ou(s,t,e,i,!1),l=d[0],h=d[1];o=wi(l-e,(h-i)/a),n=a*o}break}return Array.isArray(r.size)&&(o=yt(r.size[0],s),n=r.size.length===2?yt(r.size[1],t):o),[o,n]},cb=function(r,e){var i=Bi(180),s=[];return Li(e).forEach(function(t,o){if(o===0){var n=t[0];if(n.type===20&&n.value==="to"){i=Jp(t);return}else if(qp(n)){i=Yn.parse(r,n);return}}var a=$n(r,t);s.push(a)}),{angle:i,stops:s,type:1}},An=function(r,e){var i=Bi(180),s=[];return Li(e).forEach(function(t,o){if(o===0){var n=t[0];if(n.type===20&&["top","left","right","bottom"].indexOf(n.value)!==-1){i=Jp(t);return}else if(qp(n)){i=(Yn.parse(r,n)+Bi(270))%Bi(360);return}}var a=$n(r,t);s.push(a)}),{angle:i,stops:s,type:1}},hb=function(r,e){var i=Bi(180),s=[],t=1,o=0,n=3,a=[];return Li(e).forEach(function(A,l){var h=A[0];if(l===0){if(Pt(h)&&h.value==="linear"){t=1;return}else if(Pt(h)&&h.value==="radial"){t=2;return}}if(h.type===18){if(h.name==="from"){var d=ls.parse(r,h.values[0]);s.push({stop:$t,color:d})}else if(h.name==="to"){var d=ls.parse(r,h.values[0]);s.push({stop:as,color:d})}else if(h.name==="color-stop"){var f=h.values.filter(ur);if(f.length===2){var d=ls.parse(r,f[1]),m=f[0];pr(m)&&s.push({stop:{type:16,number:m.number*100,flags:m.flags},color:d})}}}}),t===1?{angle:(i+Bi(180))%Bi(360),stops:s,type:t}:{size:n,shape:o,stops:s,position:a,type:t}},ef="closest-side",tf="farthest-side",sf="closest-corner",rf="farthest-corner",of="circle",nf="ellipse",af="cover",Af="contain",ub=function(r,e){var i=0,s=3,t=[],o=[];return Li(e).forEach(function(n,a){var A=!0;if(a===0){var l=!1;A=n.reduce(function(d,f){if(l)if(Pt(f))switch(f.value){case"center":return o.push(wl),d;case"top":case"left":return o.push($t),d;case"right":case"bottom":return o.push(as),d}else(kt(f)||us(f))&&o.push(f);else if(Pt(f))switch(f.value){case of:return i=0,!1;case nf:return i=1,!1;case"at":return l=!0,!1;case ef:return s=0,!1;case af:case tf:return s=1,!1;case Af:case sf:return s=2,!1;case rf:return s=3,!1}else if(us(f)||kt(f))return Array.isArray(s)||(s=[]),s.push(f),!1;return d},A)}if(A){var h=$n(r,n);t.push(h)}}),{size:s,shape:i,stops:t,position:o,type:2}},ln=function(r,e){var i=0,s=3,t=[],o=[];return Li(e).forEach(function(n,a){var A=!0;if(a===0?A=n.reduce(function(h,d){if(Pt(d))switch(d.value){case"center":return o.push(wl),!1;case"top":case"left":return o.push($t),!1;case"right":case"bottom":return o.push(as),!1}else if(kt(d)||us(d))return o.push(d),!1;return h},A):a===1&&(A=n.reduce(function(h,d){if(Pt(d))switch(d.value){case of:return i=0,!1;case nf:return i=1,!1;case Af:case ef:return s=0,!1;case tf:return s=1,!1;case sf:return s=2,!1;case af:case rf:return s=3,!1}else if(us(d)||kt(d))return Array.isArray(s)||(s=[]),s.push(d),!1;return h},A)),A){var l=$n(r,n);t.push(l)}}),{size:s,shape:i,stops:t,position:o,type:2}},db=function(r){return r.type===1},pb=function(r){return r.type===2},bl={name:"image",parse:function(r,e){if(e.type===22){var i={url:e.value,type:0};return r.cache.addImage(e.value),i}if(e.type===18){var s=lf[e.name];if(typeof s>"u")throw new Error('Attempting to parse an unsupported image function "'+e.name+'"');return s(r,e.values)}throw new Error("Unsupported image type "+e.type)}};function fb(r){return!(r.type===20&&r.value==="none")&&(r.type!==18||!!lf[r.name])}var lf={"linear-gradient":cb,"-moz-linear-gradient":An,"-ms-linear-gradient":An,"-o-linear-gradient":An,"-webkit-linear-gradient":An,"radial-gradient":ub,"-moz-radial-gradient":ln,"-ms-radial-gradient":ln,"-o-radial-gradient":ln,"-webkit-radial-gradient":ln,"-webkit-gradient":hb},gb={name:"background-image",initialValue:"none",type:1,prefix:!1,parse:function(r,e){if(e.length===0)return[];var i=e[0];return i.type===20&&i.value==="none"?[]:e.filter(function(s){return ur(s)&&fb(s)}).map(function(s){return bl.parse(r,s)})}},mb={name:"background-origin",initialValue:"border-box",prefix:!1,type:1,parse:function(r,e){return e.map(function(i){if(Pt(i))switch(i.value){case"padding-box":return 1;case"content-box":return 2}return 0})}},_b={name:"background-position",initialValue:"0% 0%",type:1,prefix:!1,parse:function(r,e){return Li(e).map(function(i){return i.filter(kt)}).map(Wp)}},vb={name:"background-repeat",initialValue:"repeat",prefix:!1,type:1,parse:function(r,e){return Li(e).map(function(i){return i.filter(Pt).map(function(s){return s.value}).join(" ")}).map(Pb)}},Pb=function(r){switch(r){case"no-repeat":return 1;case"repeat-x":case"repeat no-repeat":return 2;case"repeat-y":case"no-repeat repeat":return 3;case"repeat":default:return 0}},lr;(function(r){r.AUTO="auto",r.CONTAIN="contain",r.COVER="cover"})(lr||(lr={}));var Bb={name:"background-size",initialValue:"0",prefix:!1,type:1,parse:function(r,e){return Li(e).map(function(i){return i.filter(yb)})}},yb=function(r){return Pt(r)||kt(r)},Zn=function(r){return{name:"border-"+r+"-color",initialValue:"transparent",prefix:!1,type:3,format:"color"}},xb=Zn("top"),wb=Zn("right"),bb=Zn("bottom"),Cb=Zn("left"),qn=function(r){return{name:"border-radius-"+r,initialValue:"0 0",prefix:!1,type:1,parse:function(e,i){return Wp(i.filter(kt))}}},Eb=qn("top-left"),Ib=qn("top-right"),Fb=qn("bottom-right"),Mb=qn("bottom-left"),Jn=function(r){return{name:"border-"+r+"-style",initialValue:"solid",prefix:!1,type:2,parse:function(e,i){switch(i){case"none":return 0;case"dashed":return 2;case"dotted":return 3;case"double":return 4}return 1}}},Sb=Jn("top"),Tb=Jn("right"),Db=Jn("bottom"),Rb=Jn("left"),ea=function(r){return{name:"border-"+r+"-width",initialValue:"0",type:0,prefix:!1,parse:function(e,i){return po(i)?i.number:0}}},Lb=ea("top"),Ub=ea("right"),Ob=ea("bottom"),kb=ea("left"),Nb={name:"color",initialValue:"transparent",prefix:!1,type:3,format:"color"},Qb={name:"direction",initialValue:"ltr",prefix:!1,type:2,parse:function(r,e){switch(e){case"rtl":return 1;case"ltr":default:return 0}}},Hb={name:"display",initialValue:"inline-block",prefix:!1,type:1,parse:function(r,e){return e.filter(Pt).reduce(function(i,s){return i|Vb(s.value)},0)}},Vb=function(r){switch(r){case"block":case"-webkit-box":return 2;case"inline":return 4;case"run-in":return 8;case"flow":return 16;case"flow-root":return 32;case"table":return 64;case"flex":case"-webkit-flex":return 128;case"grid":case"-ms-grid":return 256;case"ruby":return 512;case"subgrid":return 1024;case"list-item":return 2048;case"table-row-group":return 4096;case"table-header-group":return 8192;case"table-footer-group":return 16384;case"table-row":return 32768;case"table-cell":return 65536;case"table-column-group":return 131072;case"table-column":return 262144;case"table-caption":return 524288;case"ruby-base":return 1048576;case"ruby-text":return 2097152;case"ruby-base-container":return 4194304;case"ruby-text-container":return 8388608;case"contents":return 16777216;case"inline-block":return 33554432;case"inline-list-item":return 67108864;case"inline-table":return 134217728;case"inline-flex":return 268435456;case"inline-grid":return 536870912}return 0},jb={name:"float",initialValue:"none",prefix:!1,type:2,parse:function(r,e){switch(e){case"left":return 1;case"right":return 2;case"inline-start":return 3;case"inline-end":return 4}return 0}},Gb={name:"letter-spacing",initialValue:"0",prefix:!1,type:0,parse:function(r,e){return e.type===20&&e.value==="normal"?0:e.type===17||e.type===15?e.number:0}},Rn;(function(r){r.NORMAL="normal",r.STRICT="strict"})(Rn||(Rn={}));var zb={name:"line-break",initialValue:"normal",prefix:!1,type:2,parse:function(r,e){switch(e){case"strict":return Rn.STRICT;case"normal":default:return Rn.NORMAL}}},Kb={name:"line-height",initialValue:"normal",prefix:!1,type:4},ku=function(r,e){return Pt(r)&&r.value==="normal"?1.2*e:r.type===17?e*r.number:kt(r)?yt(r,e):e},Wb={name:"list-style-image",initialValue:"none",type:0,prefix:!1,parse:function(r,e){return e.type===20&&e.value==="none"?null:bl.parse(r,e)}},Xb={name:"list-style-position",initialValue:"outside",prefix:!1,type:2,parse:function(r,e){switch(e){case"inside":return 0;case"outside":default:return 1}}},cl={name:"list-style-type",initialValue:"none",prefix:!1,type:2,parse:function(r,e){switch(e){case"disc":return 0;case"circle":return 1;case"square":return 2;case"decimal":return 3;case"cjk-decimal":return 4;case"decimal-leading-zero":return 5;case"lower-roman":return 6;case"upper-roman":return 7;case"lower-greek":return 8;case"lower-alpha":return 9;case"upper-alpha":return 10;case"arabic-indic":return 11;case"armenian":return 12;case"bengali":return 13;case"cambodian":return 14;case"cjk-earthly-branch":return 15;case"cjk-heavenly-stem":return 16;case"cjk-ideographic":return 17;case"devanagari":return 18;case"ethiopic-numeric":return 19;case"georgian":return 20;case"gujarati":return 21;case"gurmukhi":return 22;case"hebrew":return 22;case"hiragana":return 23;case"hiragana-iroha":return 24;case"japanese-formal":return 25;case"japanese-informal":return 26;case"kannada":return 27;case"katakana":return 28;case"katakana-iroha":return 29;case"khmer":return 30;case"korean-hangul-formal":return 31;case"korean-hanja-formal":return 32;case"korean-hanja-informal":return 33;case"lao":return 34;case"lower-armenian":return 35;case"malayalam":return 36;case"mongolian":return 37;case"myanmar":return 38;case"oriya":return 39;case"persian":return 40;case"simp-chinese-formal":return 41;case"simp-chinese-informal":return 42;case"tamil":return 43;case"telugu":return 44;case"thai":return 45;case"tibetan":return 46;case"trad-chinese-formal":return 47;case"trad-chinese-informal":return 48;case"upper-armenian":return 49;case"disclosure-open":return 50;case"disclosure-closed":return 51;case"none":default:return-1}}},ta=function(r){return{name:"margin-"+r,initialValue:"0",prefix:!1,type:4}},Yb=ta("top"),$b=ta("right"),Zb=ta("bottom"),qb=ta("left"),Jb={name:"overflow",initialValue:"visible",prefix:!1,type:1,parse:function(r,e){return e.filter(Pt).map(function(i){switch(i.value){case"hidden":return 1;case"scroll":return 2;case"clip":return 3;case"auto":return 4;case"visible":default:return 0}})}},eC={name:"overflow-wrap",initialValue:"normal",prefix:!1,type:2,parse:function(r,e){switch(e){case"break-word":return"break-word";case"normal":default:return"normal"}}},ia=function(r){return{name:"padding-"+r,initialValue:"0",prefix:!1,type:3,format:"length-percentage"}},tC=ia("top"),iC=ia("right"),sC=ia("bottom"),rC=ia("left"),oC={name:"text-align",initialValue:"left",prefix:!1,type:2,parse:function(r,e){switch(e){case"right":return 2;case"center":case"justify":return 1;case"left":default:return 0}}},nC={name:"position",initialValue:"static",prefix:!1,type:2,parse:function(r,e){switch(e){case"relative":return 1;case"absolute":return 2;case"fixed":return 3;case"sticky":return 4}return 0}},aC={name:"text-shadow",initialValue:"none",type:1,prefix:!1,parse:function(r,e){return e.length===1&&ll(e[0],"none")?[]:Li(e).map(function(i){for(var s={color:Yi.TRANSPARENT,offsetX:$t,offsetY:$t,blur:$t},t=0,o=0;o<i.length;o++){var n=i[o];us(n)?(t===0?s.offsetX=n:t===1?s.offsetY=n:s.blur=n,t++):s.color=ls.parse(r,n)}return s})}},AC={name:"text-transform",initialValue:"none",prefix:!1,type:2,parse:function(r,e){switch(e){case"uppercase":return 2;case"lowercase":return 1;case"capitalize":return 3}return 0}},lC={name:"transform",initialValue:"none",prefix:!0,type:0,parse:function(r,e){if(e.type===20&&e.value==="none")return null;if(e.type===18){var i=uC[e.name];if(typeof i>"u")throw new Error('Attempting to parse an unsupported transform function "'+e.name+'"');return i(e.values)}return null}},cC=function(r){var e=r.filter(function(i){return i.type===17}).map(function(i){return i.number});return e.length===6?e:null},hC=function(r){var e=r.filter(function(A){return A.type===17}).map(function(A){return A.number}),i=e[0],s=e[1];e[2],e[3];var t=e[4],o=e[5];e[6],e[7],e[8],e[9],e[10],e[11];var n=e[12],a=e[13];return e[14],e[15],e.length===16?[i,s,t,o,n,a]:null},uC={matrix:cC,matrix3d:hC},Nu={type:16,number:50,flags:uo},dC=[Nu,Nu],pC={name:"transform-origin",initialValue:"50% 50%",prefix:!0,type:1,parse:function(r,e){var i=e.filter(kt);return i.length!==2?dC:[i[0],i[1]]}},fC={name:"visible",initialValue:"none",prefix:!1,type:2,parse:function(r,e){switch(e){case"hidden":return 1;case"collapse":return 2;case"visible":default:return 0}}},eo;(function(r){r.NORMAL="normal",r.BREAK_ALL="break-all",r.KEEP_ALL="keep-all"})(eo||(eo={}));var gC={name:"word-break",initialValue:"normal",prefix:!1,type:2,parse:function(r,e){switch(e){case"break-all":return eo.BREAK_ALL;case"keep-all":return eo.KEEP_ALL;case"normal":default:return eo.NORMAL}}},mC={name:"z-index",initialValue:"auto",prefix:!1,type:0,parse:function(r,e){if(e.type===20)return{auto:!0,order:0};if(pr(e))return{auto:!1,order:e.number};throw new Error("Invalid z-index number parsed")}},cf={name:"time",parse:function(r,e){if(e.type===15)switch(e.unit.toLowerCase()){case"s":return 1e3*e.number;case"ms":return e.number}throw new Error("Unsupported time type")}},_C={name:"opacity",initialValue:"1",type:0,prefix:!1,parse:function(r,e){return pr(e)?e.number:1}},vC={name:"text-decoration-color",initialValue:"transparent",prefix:!1,type:3,format:"color"},PC={name:"text-decoration-line",initialValue:"none",prefix:!1,type:1,parse:function(r,e){return e.filter(Pt).map(function(i){switch(i.value){case"underline":return 1;case"overline":return 2;case"line-through":return 3;case"none":return 4}return 0}).filter(function(i){return i!==0})}},BC={name:"font-family",initialValue:"",prefix:!1,type:1,parse:function(r,e){var i=[],s=[];return e.forEach(function(t){switch(t.type){case 20:case 0:i.push(t.value);break;case 17:i.push(t.number.toString());break;case 4:s.push(i.join(" ")),i.length=0;break}}),i.length&&s.push(i.join(" ")),s.map(function(t){return t.indexOf(" ")===-1?t:"'"+t+"'"})}},yC={name:"font-size",initialValue:"0",prefix:!1,type:3,format:"length"},xC={name:"font-weight",initialValue:"normal",type:0,prefix:!1,parse:function(r,e){if(pr(e))return e.number;if(Pt(e))switch(e.value){case"bold":return 700;case"normal":default:return 400}return 400}},wC={name:"font-variant",initialValue:"none",type:1,prefix:!1,parse:function(r,e){return e.filter(Pt).map(function(i){return i.value})}},bC={name:"font-style",initialValue:"normal",prefix:!1,type:2,parse:function(r,e){switch(e){case"oblique":return"oblique";case"italic":return"italic";case"normal":default:return"normal"}}},Qt=function(r,e){return(r&e)!==0},CC={name:"content",initialValue:"none",type:1,prefix:!1,parse:function(r,e){if(e.length===0)return[];var i=e[0];return i.type===20&&i.value==="none"?[]:e}},EC={name:"counter-increment",initialValue:"none",prefix:!0,type:1,parse:function(r,e){if(e.length===0)return null;var i=e[0];if(i.type===20&&i.value==="none")return null;for(var s=[],t=e.filter(Kp),o=0;o<t.length;o++){var n=t[o],a=t[o+1];if(n.type===20){var A=a&&pr(a)?a.number:1;s.push({counter:n.value,increment:A})}}return s}},IC={name:"counter-reset",initialValue:"none",prefix:!0,type:1,parse:function(r,e){if(e.length===0)return[];for(var i=[],s=e.filter(Kp),t=0;t<s.length;t++){var o=s[t],n=s[t+1];if(Pt(o)&&o.value!=="none"){var a=n&&pr(n)?n.number:0;i.push({counter:o.value,reset:a})}}return i}},FC={name:"duration",initialValue:"0s",prefix:!1,type:1,parse:function(r,e){return e.filter(po).map(function(i){return cf.parse(r,i)})}},MC={name:"quotes",initialValue:"none",prefix:!0,type:1,parse:function(r,e){if(e.length===0)return null;var i=e[0];if(i.type===20&&i.value==="none")return null;var s=[],t=e.filter(ib);if(t.length%2!==0)return null;for(var o=0;o<t.length;o+=2){var n=t[o].value,a=t[o+1].value;s.push({open:n,close:a})}return s}},Qu=function(r,e,i){if(!r)return"";var s=r[Math.min(e,r.length-1)];return s?i?s.open:s.close:""},SC={name:"box-shadow",initialValue:"none",type:1,prefix:!1,parse:function(r,e){return e.length===1&&ll(e[0],"none")?[]:Li(e).map(function(i){for(var s={color:255,offsetX:$t,offsetY:$t,blur:$t,spread:$t,inset:!1},t=0,o=0;o<i.length;o++){var n=i[o];ll(n,"inset")?s.inset=!0:us(n)?(t===0?s.offsetX=n:t===1?s.offsetY=n:t===2?s.blur=n:s.spread=n,t++):s.color=ls.parse(r,n)}return s})}},TC={name:"paint-order",initialValue:"normal",prefix:!1,type:1,parse:function(r,e){var i=[0,1,2],s=[];return e.filter(Pt).forEach(function(t){switch(t.value){case"stroke":s.push(1);break;case"fill":s.push(0);break;case"markers":s.push(2);break}}),i.forEach(function(t){s.indexOf(t)===-1&&s.push(t)}),s}},DC={name:"-webkit-text-stroke-color",initialValue:"currentcolor",prefix:!1,type:3,format:"color"},RC={name:"-webkit-text-stroke-width",initialValue:"0",type:0,prefix:!1,parse:function(r,e){return po(e)?e.number:0}},LC=function(){function r(e,i){var s,t;this.animationDuration=Oe(e,FC,i.animationDuration),this.backgroundClip=Oe(e,ob,i.backgroundClip),this.backgroundColor=Oe(e,nb,i.backgroundColor),this.backgroundImage=Oe(e,gb,i.backgroundImage),this.backgroundOrigin=Oe(e,mb,i.backgroundOrigin),this.backgroundPosition=Oe(e,_b,i.backgroundPosition),this.backgroundRepeat=Oe(e,vb,i.backgroundRepeat),this.backgroundSize=Oe(e,Bb,i.backgroundSize),this.borderTopColor=Oe(e,xb,i.borderTopColor),this.borderRightColor=Oe(e,wb,i.borderRightColor),this.borderBottomColor=Oe(e,bb,i.borderBottomColor),this.borderLeftColor=Oe(e,Cb,i.borderLeftColor),this.borderTopLeftRadius=Oe(e,Eb,i.borderTopLeftRadius),this.borderTopRightRadius=Oe(e,Ib,i.borderTopRightRadius),this.borderBottomRightRadius=Oe(e,Fb,i.borderBottomRightRadius),this.borderBottomLeftRadius=Oe(e,Mb,i.borderBottomLeftRadius),this.borderTopStyle=Oe(e,Sb,i.borderTopStyle),this.borderRightStyle=Oe(e,Tb,i.borderRightStyle),this.borderBottomStyle=Oe(e,Db,i.borderBottomStyle),this.borderLeftStyle=Oe(e,Rb,i.borderLeftStyle),this.borderTopWidth=Oe(e,Lb,i.borderTopWidth),this.borderRightWidth=Oe(e,Ub,i.borderRightWidth),this.borderBottomWidth=Oe(e,Ob,i.borderBottomWidth),this.borderLeftWidth=Oe(e,kb,i.borderLeftWidth),this.boxShadow=Oe(e,SC,i.boxShadow),this.color=Oe(e,Nb,i.color),this.direction=Oe(e,Qb,i.direction),this.display=Oe(e,Hb,i.display),this.float=Oe(e,jb,i.cssFloat),this.fontFamily=Oe(e,BC,i.fontFamily),this.fontSize=Oe(e,yC,i.fontSize),this.fontStyle=Oe(e,bC,i.fontStyle),this.fontVariant=Oe(e,wC,i.fontVariant),this.fontWeight=Oe(e,xC,i.fontWeight),this.letterSpacing=Oe(e,Gb,i.letterSpacing),this.lineBreak=Oe(e,zb,i.lineBreak),this.lineHeight=Oe(e,Kb,i.lineHeight),this.listStyleImage=Oe(e,Wb,i.listStyleImage),this.listStylePosition=Oe(e,Xb,i.listStylePosition),this.listStyleType=Oe(e,cl,i.listStyleType),this.marginTop=Oe(e,Yb,i.marginTop),this.marginRight=Oe(e,$b,i.marginRight),this.marginBottom=Oe(e,Zb,i.marginBottom),this.marginLeft=Oe(e,qb,i.marginLeft),this.opacity=Oe(e,_C,i.opacity);var o=Oe(e,Jb,i.overflow);this.overflowX=o[0],this.overflowY=o[o.length>1?1:0],this.overflowWrap=Oe(e,eC,i.overflowWrap),this.paddingTop=Oe(e,tC,i.paddingTop),this.paddingRight=Oe(e,iC,i.paddingRight),this.paddingBottom=Oe(e,sC,i.paddingBottom),this.paddingLeft=Oe(e,rC,i.paddingLeft),this.paintOrder=Oe(e,TC,i.paintOrder),this.position=Oe(e,nC,i.position),this.textAlign=Oe(e,oC,i.textAlign),this.textDecorationColor=Oe(e,vC,(s=i.textDecorationColor)!==null&&s!==void 0?s:i.color),this.textDecorationLine=Oe(e,PC,(t=i.textDecorationLine)!==null&&t!==void 0?t:i.textDecoration),this.textShadow=Oe(e,aC,i.textShadow),this.textTransform=Oe(e,AC,i.textTransform),this.transform=Oe(e,lC,i.transform),this.transformOrigin=Oe(e,pC,i.transformOrigin),this.visibility=Oe(e,fC,i.visibility),this.webkitTextStrokeColor=Oe(e,DC,i.webkitTextStrokeColor),this.webkitTextStrokeWidth=Oe(e,RC,i.webkitTextStrokeWidth),this.wordBreak=Oe(e,gC,i.wordBreak),this.zIndex=Oe(e,mC,i.zIndex)}return r.prototype.isVisible=function(){return this.display>0&&this.opacity>0&&this.visibility===0},r.prototype.isTransparent=function(){return cs(this.backgroundColor)},r.prototype.isTransformed=function(){return this.transform!==null},r.prototype.isPositioned=function(){return this.position!==0},r.prototype.isPositionedWithZIndex=function(){return this.isPositioned()&&!this.zIndex.auto},r.prototype.isFloating=function(){return this.float!==0},r.prototype.isInlineLevel=function(){return Qt(this.display,4)||Qt(this.display,33554432)||Qt(this.display,268435456)||Qt(this.display,536870912)||Qt(this.display,67108864)||Qt(this.display,134217728)},r}(),UC=function(){function r(e,i){this.content=Oe(e,CC,i.content),this.quotes=Oe(e,MC,i.quotes)}return r}(),Hu=function(){function r(e,i){this.counterIncrement=Oe(e,EC,i.counterIncrement),this.counterReset=Oe(e,IC,i.counterReset)}return r}(),Oe=function(r,e,i){var s=new Gp,t=i!==null&&typeof i<"u"?i.toString():e.initialValue;s.write(t);var o=new zp(s.read());switch(e.type){case 2:var n=o.parseComponentValue();return e.parse(r,Pt(n)?n.value:e.initialValue);case 0:return e.parse(r,o.parseComponentValue());case 1:return e.parse(r,o.parseComponentValues());case 4:return o.parseComponentValue();case 3:switch(e.format){case"angle":return Yn.parse(r,o.parseComponentValue());case"color":return ls.parse(r,o.parseComponentValue());case"image":return bl.parse(r,o.parseComponentValue());case"length":var a=o.parseComponentValue();return us(a)?a:$t;case"length-percentage":var A=o.parseComponentValue();return kt(A)?A:$t;case"time":return cf.parse(r,o.parseComponentValue())}break}},OC="data-html2canvas-debug",kC=function(r){var e=r.getAttribute(OC);switch(e){case"all":return 1;case"clone":return 2;case"parse":return 3;case"render":return 4;default:return 0}},hl=function(r,e){var i=kC(r);return i===1||e===i},Ui=function(){function r(e,i){if(this.context=e,this.textNodes=[],this.elements=[],this.flags=0,hl(i,3))debugger;this.styles=new LC(e,window.getComputedStyle(i,null)),pl(i)&&(this.styles.animationDuration.some(function(s){return s>0})&&(i.style.animationDuration="0s"),this.styles.transform!==null&&(i.style.transform="none")),this.bounds=Wn(this.context,i),hl(i,4)&&(this.flags|=16)}return r}(),NC="AAAAAAAAAAAAEA4AGBkAAFAaAAACAAAAAAAIABAAGAAwADgACAAQAAgAEAAIABAACAAQAAgAEAAIABAACAAQAAgAEAAIABAAQABIAEQATAAIABAACAAQAAgAEAAIABAAVABcAAgAEAAIABAACAAQAGAAaABwAHgAgACIAI4AlgAIABAAmwCjAKgAsAC2AL4AvQDFAMoA0gBPAVYBWgEIAAgACACMANoAYgFkAWwBdAF8AX0BhQGNAZUBlgGeAaMBlQGWAasBswF8AbsBwwF0AcsBYwHTAQgA2wG/AOMBdAF8AekB8QF0AfkB+wHiAHQBfAEIAAMC5gQIAAsCEgIIAAgAFgIeAggAIgIpAggAMQI5AkACygEIAAgASAJQAlgCYAIIAAgACAAKBQoFCgUTBRMFGQUrBSsFCAAIAAgACAAIAAgACAAIAAgACABdAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABoAmgCrwGvAQgAbgJ2AggAHgEIAAgACADnAXsCCAAIAAgAgwIIAAgACAAIAAgACACKAggAkQKZAggAPADJAAgAoQKkAqwCsgK6AsICCADJAggA0AIIAAgACAAIANYC3gIIAAgACAAIAAgACABAAOYCCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAkASoB+QIEAAgACAA8AEMCCABCBQgACABJBVAFCAAIAAgACAAIAAgACAAIAAgACABTBVoFCAAIAFoFCABfBWUFCAAIAAgACAAIAAgAbQUIAAgACAAIAAgACABzBXsFfQWFBYoFigWKBZEFigWKBYoFmAWfBaYFrgWxBbkFCAAIAAgACAAIAAgACAAIAAgACAAIAMEFCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAMgFCADQBQgACAAIAAgACAAIAAgACAAIAAgACAAIAO4CCAAIAAgAiQAIAAgACABAAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAD0AggACAD8AggACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIANYFCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAMDvwAIAAgAJAIIAAgACAAIAAgACAAIAAgACwMTAwgACAB9BOsEGwMjAwgAKwMyAwsFYgE3A/MEPwMIAEUDTQNRAwgAWQOsAGEDCAAIAAgACAAIAAgACABpAzQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFIQUoBSwFCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABtAwgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABMAEwACAAIAAgACAAIABgACAAIAAgACAC/AAgACAAyAQgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACACAAIAAwAAgACAAIAAgACAAIAAgACAAIAAAARABIAAgACAAIABQASAAIAAgAIABwAEAAjgCIABsAqAC2AL0AigDQAtwC+IJIQqVAZUBWQqVAZUBlQGVAZUBlQGrC5UBlQGVAZUBlQGVAZUBlQGVAXsKlQGVAbAK6wsrDGUMpQzlDJUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAfAKAAuZA64AtwCJALoC6ADwAAgAuACgA/oEpgO6AqsD+AAIAAgAswMIAAgACAAIAIkAuwP5AfsBwwPLAwgACAAIAAgACADRA9kDCAAIAOED6QMIAAgACAAIAAgACADuA/YDCAAIAP4DyQAIAAgABgQIAAgAXQAOBAgACAAIAAgACAAIABMECAAIAAgACAAIAAgACAD8AAQBCAAIAAgAGgQiBCoECAExBAgAEAEIAAgACAAIAAgACAAIAAgACAAIAAgACAA4BAgACABABEYECAAIAAgATAQYAQgAVAQIAAgACAAIAAgACAAIAAgACAAIAFoECAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAOQEIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAB+BAcACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAEABhgSMBAgACAAIAAgAlAQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAwAEAAQABAADAAMAAwADAAQABAAEAAQABAAEAAQABHATAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAdQMIAAgACAAIAAgACAAIAMkACAAIAAgAfQMIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACACFA4kDCAAIAAgACAAIAOcBCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAIcDCAAIAAgACAAIAAgACAAIAAgACAAIAJEDCAAIAAgACADFAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABgBAgAZgQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAbAQCBXIECAAIAHkECAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABAAJwEQACjBKoEsgQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAC6BMIECAAIAAgACAAIAAgACABmBAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAxwQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAGYECAAIAAgAzgQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAigWKBYoFigWKBYoFigWKBd0FXwUIAOIF6gXxBYoF3gT5BQAGCAaKBYoFigWKBYoFigWKBYoFigWKBYoFigXWBIoFigWKBYoFigWKBYoFigWKBYsFEAaKBYoFigWKBYoFigWKBRQGCACKBYoFigWKBQgACAAIANEECAAIABgGigUgBggAJgYIAC4GMwaKBYoF0wQ3Bj4GigWKBYoFigWKBYoFigWKBYoFigWKBYoFigUIAAgACAAIAAgACAAIAAgAigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWLBf///////wQABAAEAAQABAAEAAQABAAEAAQAAwAEAAQAAgAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAQADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAUAAAAFAAUAAAAFAAUAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQABAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUAAQAAAAUABQAFAAUABQAFAAAAAAAFAAUAAAAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAFAAUAAQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABwAFAAUABQAFAAAABwAHAAcAAAAHAAcABwAFAAEAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAcABwAFAAUAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAAAAQABAAAAAAAAAAAAAAAFAAUABQAFAAAABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAcABwAHAAcAAAAHAAcAAAAAAAUABQAHAAUAAQAHAAEABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABwABAAUABQAFAAUAAAAAAAAAAAAAAAEAAQABAAEAAQABAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABwAFAAUAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUAAQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABQANAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAEAAQABAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQABAAEAAQABAAEAAQABAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAABQAHAAUABQAFAAAAAAAAAAcABQAFAAUABQAFAAQABAAEAAQABAAEAAQABAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUAAAAFAAUABQAFAAUAAAAFAAUABQAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAAAAAAAAAAAAUABQAFAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAUAAAAHAAcABwAFAAUABQAFAAUABQAFAAUABwAHAAcABwAFAAcABwAAAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAUABwAHAAUABQAFAAUAAAAAAAcABwAAAAAABwAHAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAABQAFAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAABwAHAAcABQAFAAAAAAAAAAAABQAFAAAAAAAFAAUABQAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAFAAUABQAFAAUAAAAFAAUABwAAAAcABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAFAAUABwAFAAUABQAFAAAAAAAHAAcAAAAAAAcABwAFAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAcABwAAAAAAAAAHAAcABwAAAAcABwAHAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAABQAHAAcABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAHAAcABwAAAAUABQAFAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAcABQAHAAcABQAHAAcAAAAFAAcABwAAAAcABwAFAAUAAAAAAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAUABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAFAAcABwAFAAUABQAAAAUAAAAHAAcABwAHAAcABwAHAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAHAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAABwAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAUAAAAFAAAAAAAAAAAABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABwAFAAUABQAFAAUAAAAFAAUAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABwAFAAUABQAFAAUABQAAAAUABQAHAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABQAFAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAcABQAFAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAHAAUABQAFAAUABQAFAAUABwAHAAcABwAHAAcABwAHAAUABwAHAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABwAHAAcABwAFAAUABwAHAAcAAAAAAAAAAAAHAAcABQAHAAcABwAHAAcABwAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAcABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAHAAUABQAFAAUABQAFAAUAAAAFAAAABQAAAAAABQAFAAUABQAFAAUABQAFAAcABwAHAAcABwAHAAUABQAFAAUABQAFAAUABQAFAAUAAAAAAAUABQAFAAUABQAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABwAFAAcABwAHAAcABwAFAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAUABQAFAAUABwAHAAUABQAHAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAcABQAFAAcABwAHAAUABwAFAAUABQAHAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABwAHAAcABwAHAAUABQAFAAUABQAFAAUABQAHAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAcABQAFAAUABQAFAAUABQAAAAAAAAAAAAUAAAAAAAAAAAAAAAAABQAAAAAABwAFAAUAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUAAAAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAABQAAAAAAAAAFAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAUABQAHAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAHAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAHAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAcABwAFAAUABQAFAAcABwAFAAUABwAHAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAcABwAFAAUABwAHAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAFAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAFAAUABQAAAAAABQAFAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAFAAcABwAAAAAAAAAAAAAABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAFAAcABwAFAAcABwAAAAcABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAFAAUABQAAAAUABQAAAAAAAAAAAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABwAFAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABQAFAAUABQAFAAUABQAFAAUABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAHAAcABQAHAAUABQAAAAAAAAAAAAAAAAAFAAAABwAHAAcABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAHAAcABwAAAAAABwAHAAAAAAAHAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAAAAAAFAAUABQAFAAUABQAFAAAAAAAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAUABQAFAAUABwAHAAUABQAFAAcABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAcABQAFAAUABQAFAAUABwAFAAcABwAFAAcABQAFAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAcABQAFAAUABQAAAAAABwAHAAcABwAFAAUABwAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAHAAUABQAFAAUABQAFAAUABQAHAAcABQAHAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAFAAcABwAFAAUABQAFAAUABQAHAAUAAAAAAAAAAAAAAAAAAAAAAAcABwAFAAUABQAFAAcABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAUABQAFAAUABQAHAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAAAAAAFAAUABwAHAAcABwAFAAAAAAAAAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABwAHAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAFAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAcABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAAAHAAUABQAFAAUABQAFAAUABwAFAAUABwAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUAAAAAAAAABQAAAAUABQAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAHAAcAAAAFAAUAAAAHAAcABQAHAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAAAAAAAAAAAAAAAAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAUABQAFAAAAAAAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAABQAFAAUABQAFAAUABQAAAAUABQAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAFAAUABQAFAAUADgAOAA4ADgAOAA4ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAAAAAAAAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAMAAwADAAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkAAAAAAAAAAAAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAAAAAAAAAAAAsADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwACwAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAADgAOAA4AAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAAAA4ADgAOAA4ADgAOAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAAAA4AAAAOAAAAAAAAAAAAAAAAAA4AAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAADgAAAAAAAAAAAA4AAAAOAAAAAAAAAAAADgAOAA4AAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4AAAAAAA4ADgAOAA4ADgAOAA4ADgAOAAAADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4AAAAAAAAAAAAAAAAAAAAAAA4ADgAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAOAA4ADgAOAA4ADgAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAAAAAAAAA=",Vu="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Xr=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var cn=0;cn<Vu.length;cn++)Xr[Vu.charCodeAt(cn)]=cn;var QC=function(r){var e=r.length*.75,i=r.length,s,t=0,o,n,a,A;r[r.length-1]==="="&&(e--,r[r.length-2]==="="&&e--);var l=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u"&&typeof Uint8Array.prototype.slice<"u"?new ArrayBuffer(e):new Array(e),h=Array.isArray(l)?l:new Uint8Array(l);for(s=0;s<i;s+=4)o=Xr[r.charCodeAt(s)],n=Xr[r.charCodeAt(s+1)],a=Xr[r.charCodeAt(s+2)],A=Xr[r.charCodeAt(s+3)],h[t++]=o<<2|n>>4,h[t++]=(n&15)<<4|a>>2,h[t++]=(a&3)<<6|A&63;return l},HC=function(r){for(var e=r.length,i=[],s=0;s<e;s+=2)i.push(r[s+1]<<8|r[s]);return i},VC=function(r){for(var e=r.length,i=[],s=0;s<e;s+=4)i.push(r[s+3]<<24|r[s+2]<<16|r[s+1]<<8|r[s]);return i},Es=5,Cl=11,fA=2,jC=Cl-Es,hf=65536>>Es,GC=1<<Es,gA=GC-1,zC=1024>>Es,KC=hf+zC,WC=KC,XC=32,YC=WC+XC,$C=65536>>Cl,ZC=1<<jC,qC=ZC-1,ju=function(r,e,i){return r.slice?r.slice(e,i):new Uint16Array(Array.prototype.slice.call(r,e,i))},JC=function(r,e,i){return r.slice?r.slice(e,i):new Uint32Array(Array.prototype.slice.call(r,e,i))},e1=function(r,e){var i=QC(r),s=Array.isArray(i)?VC(i):new Uint32Array(i),t=Array.isArray(i)?HC(i):new Uint16Array(i),o=24,n=ju(t,o/2,s[4]/2),a=s[5]===2?ju(t,(o+s[4])/2):JC(s,Math.ceil((o+s[4])/4));return new t1(s[0],s[1],s[2],s[3],n,a)},t1=function(){function r(e,i,s,t,o,n){this.initialValue=e,this.errorValue=i,this.highStart=s,this.highValueIndex=t,this.index=o,this.data=n}return r.prototype.get=function(e){var i;if(e>=0){if(e<55296||e>56319&&e<=65535)return i=this.index[e>>Es],i=(i<<fA)+(e&gA),this.data[i];if(e<=65535)return i=this.index[hf+(e-55296>>Es)],i=(i<<fA)+(e&gA),this.data[i];if(e<this.highStart)return i=YC-$C+(e>>Cl),i=this.index[i],i+=e>>Es&qC,i=this.index[i],i=(i<<fA)+(e&gA),this.data[i];if(e<=1114111)return this.data[this.highValueIndex]}return this.errorValue},r}(),Gu="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i1=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var hn=0;hn<Gu.length;hn++)i1[Gu.charCodeAt(hn)]=hn;var s1=1,mA=2,_A=3,zu=4,Ku=5,r1=7,Wu=8,vA=9,PA=10,Xu=11,Yu=12,$u=13,Zu=14,BA=15,o1=function(r){for(var e=[],i=0,s=r.length;i<s;){var t=r.charCodeAt(i++);if(t>=55296&&t<=56319&&i<s){var o=r.charCodeAt(i++);(o&64512)===56320?e.push(((t&1023)<<10)+(o&1023)+65536):(e.push(t),i--)}else e.push(t)}return e},n1=function(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];if(String.fromCodePoint)return String.fromCodePoint.apply(String,r);var i=r.length;if(!i)return"";for(var s=[],t=-1,o="";++t<i;){var n=r[t];n<=65535?s.push(n):(n-=65536,s.push((n>>10)+55296,n%1024+56320)),(t+1===i||s.length>16384)&&(o+=String.fromCharCode.apply(String,s),s.length=0)}return o},a1=e1(NC),gi="",yA="",A1=function(r){return a1.get(r)},l1=function(r,e,i){var s=i-2,t=e[s],o=e[i-1],n=e[i];if(o===mA&&n===_A)return gi;if(o===mA||o===_A||o===zu||n===mA||n===_A||n===zu)return yA;if(o===Wu&&[Wu,vA,Xu,Yu].indexOf(n)!==-1||(o===Xu||o===vA)&&(n===vA||n===PA)||(o===Yu||o===PA)&&n===PA||n===$u||n===Ku||n===r1||o===s1)return gi;if(o===$u&&n===Zu){for(;t===Ku;)t=e[--s];if(t===Zu)return gi}if(o===BA&&n===BA){for(var a=0;t===BA;)a++,t=e[--s];if(a%2===0)return gi}return yA},c1=function(r){var e=o1(r),i=e.length,s=0,t=0,o=e.map(A1);return{next:function(){if(s>=i)return{done:!0,value:null};for(var n=gi;s<i&&(n=l1(e,o,++s))===gi;);if(n!==gi||s===i){var a=n1.apply(null,e.slice(t,s));return t=s,{value:a,done:!1}}return{done:!0,value:null}}}},h1=function(r){for(var e=c1(r),i=[],s;!(s=e.next()).done;)s.value&&i.push(s.value.slice());return i},u1=function(r){var e=123;if(r.createRange){var i=r.createRange();if(i.getBoundingClientRect){var s=r.createElement("boundtest");s.style.height=e+"px",s.style.display="block",r.body.appendChild(s),i.selectNode(s);var t=i.getBoundingClientRect(),o=Math.round(t.height);if(r.body.removeChild(s),o===e)return!0}}return!1},d1=function(r){var e=r.createElement("boundtest");e.style.width="50px",e.style.display="block",e.style.fontSize="12px",e.style.letterSpacing="0px",e.style.wordSpacing="0px",r.body.appendChild(e);var i=r.createRange();e.innerHTML=typeof"".repeat=="function"?"&#128104;".repeat(10):"";var s=e.firstChild,t=Xn(s.data).map(function(A){return Rt(A)}),o=0,n={},a=t.every(function(A,l){i.setStart(s,o),i.setEnd(s,o+A.length);var h=i.getBoundingClientRect();o+=A.length;var d=h.x>n.x||h.y>n.y;return n=h,l===0?!0:d});return r.body.removeChild(e),a},p1=function(){return typeof new Image().crossOrigin<"u"},f1=function(){return typeof new XMLHttpRequest().responseType=="string"},g1=function(r){var e=new Image,i=r.createElement("canvas"),s=i.getContext("2d");if(!s)return!1;e.src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'></svg>";try{s.drawImage(e,0,0),i.toDataURL()}catch{return!1}return!0},qu=function(r){return r[0]===0&&r[1]===255&&r[2]===0&&r[3]===255},m1=function(r){var e=r.createElement("canvas"),i=100;e.width=i,e.height=i;var s=e.getContext("2d");if(!s)return Promise.reject(!1);s.fillStyle="rgb(0, 255, 0)",s.fillRect(0,0,i,i);var t=new Image,o=e.toDataURL();t.src=o;var n=ul(i,i,0,0,t);return s.fillStyle="red",s.fillRect(0,0,i,i),Ju(n).then(function(a){s.drawImage(a,0,0);var A=s.getImageData(0,0,i,i).data;s.fillStyle="red",s.fillRect(0,0,i,i);var l=r.createElement("div");return l.style.backgroundImage="url("+o+")",l.style.height=i+"px",qu(A)?Ju(ul(i,i,0,0,l)):Promise.reject(!1)}).then(function(a){return s.drawImage(a,0,0),qu(s.getImageData(0,0,i,i).data)}).catch(function(){return!1})},ul=function(r,e,i,s,t){var o="http://www.w3.org/2000/svg",n=document.createElementNS(o,"svg"),a=document.createElementNS(o,"foreignObject");return n.setAttributeNS(null,"width",r.toString()),n.setAttributeNS(null,"height",e.toString()),a.setAttributeNS(null,"width","100%"),a.setAttributeNS(null,"height","100%"),a.setAttributeNS(null,"x",i.toString()),a.setAttributeNS(null,"y",s.toString()),a.setAttributeNS(null,"externalResourcesRequired","true"),n.appendChild(a),a.appendChild(t),n},Ju=function(r){return new Promise(function(e,i){var s=new Image;s.onload=function(){return e(s)},s.onerror=i,s.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(new XMLSerializer().serializeToString(r))})},Yt={get SUPPORT_RANGE_BOUNDS(){var r=u1(document);return Object.defineProperty(Yt,"SUPPORT_RANGE_BOUNDS",{value:r}),r},get SUPPORT_WORD_BREAKING(){var r=Yt.SUPPORT_RANGE_BOUNDS&&d1(document);return Object.defineProperty(Yt,"SUPPORT_WORD_BREAKING",{value:r}),r},get SUPPORT_SVG_DRAWING(){var r=g1(document);return Object.defineProperty(Yt,"SUPPORT_SVG_DRAWING",{value:r}),r},get SUPPORT_FOREIGNOBJECT_DRAWING(){var r=typeof Array.from=="function"&&typeof window.fetch=="function"?m1(document):Promise.resolve(!1);return Object.defineProperty(Yt,"SUPPORT_FOREIGNOBJECT_DRAWING",{value:r}),r},get SUPPORT_CORS_IMAGES(){var r=p1();return Object.defineProperty(Yt,"SUPPORT_CORS_IMAGES",{value:r}),r},get SUPPORT_RESPONSE_TYPE(){var r=f1();return Object.defineProperty(Yt,"SUPPORT_RESPONSE_TYPE",{value:r}),r},get SUPPORT_CORS_XHR(){var r="withCredentials"in new XMLHttpRequest;return Object.defineProperty(Yt,"SUPPORT_CORS_XHR",{value:r}),r},get SUPPORT_NATIVE_TEXT_SEGMENTATION(){var r=!!(typeof Intl<"u"&&Intl.Segmenter);return Object.defineProperty(Yt,"SUPPORT_NATIVE_TEXT_SEGMENTATION",{value:r}),r}},to=function(){function r(e,i){this.text=e,this.bounds=i}return r}(),_1=function(r,e,i,s){var t=B1(e,i),o=[],n=0;return t.forEach(function(a){if(i.textDecorationLine.length||a.trim().length>0)if(Yt.SUPPORT_RANGE_BOUNDS){var A=ed(s,n,a.length).getClientRects();if(A.length>1){var l=El(a),h=0;l.forEach(function(f){o.push(new to(f,qi.fromDOMRectList(r,ed(s,h+n,f.length).getClientRects()))),h+=f.length})}else o.push(new to(a,qi.fromDOMRectList(r,A)))}else{var d=s.splitText(a.length);o.push(new to(a,v1(r,s))),s=d}else Yt.SUPPORT_RANGE_BOUNDS||(s=s.splitText(a.length));n+=a.length}),o},v1=function(r,e){var i=e.ownerDocument;if(i){var s=i.createElement("html2canvaswrapper");s.appendChild(e.cloneNode(!0));var t=e.parentNode;if(t){t.replaceChild(s,e);var o=Wn(r,s);return s.firstChild&&t.replaceChild(s.firstChild,s),o}}return qi.EMPTY},ed=function(r,e,i){var s=r.ownerDocument;if(!s)throw new Error("Node has no owner document");var t=s.createRange();return t.setStart(r,e),t.setEnd(r,e+i),t},El=function(r){if(Yt.SUPPORT_NATIVE_TEXT_SEGMENTATION){var e=new Intl.Segmenter(void 0,{granularity:"grapheme"});return Array.from(e.segment(r)).map(function(i){return i.segment})}return h1(r)},P1=function(r,e){if(Yt.SUPPORT_NATIVE_TEXT_SEGMENTATION){var i=new Intl.Segmenter(void 0,{granularity:"word"});return Array.from(i.segment(r)).map(function(s){return s.segment})}return x1(r,e)},B1=function(r,e){return e.letterSpacing!==0?El(r):P1(r,e)},y1=[32,160,4961,65792,65793,4153,4241],x1=function(r,e){for(var i=$x(r,{lineBreak:e.lineBreak,wordBreak:e.overflowWrap==="break-word"?"break-word":e.wordBreak}),s=[],t,o=function(){if(t.value){var n=t.value.slice(),a=Xn(n),A="";a.forEach(function(l){y1.indexOf(l)===-1?A+=Rt(l):(A.length&&s.push(A),s.push(Rt(l)),A="")}),A.length&&s.push(A)}};!(t=i.next()).done;)o();return s},w1=function(){function r(e,i,s){this.text=b1(i.data,s.textTransform),this.textBounds=_1(e,this.text,s,i)}return r}(),b1=function(r,e){switch(e){case 1:return r.toLowerCase();case 3:return r.replace(C1,E1);case 2:return r.toUpperCase();default:return r}},C1=/(^|\s|:|-|\(|\))([a-z])/g,E1=function(r,e,i){return r.length>0?e+i.toUpperCase():r},uf=function(r){Ei(e,r);function e(i,s){var t=r.call(this,i,s)||this;return t.src=s.currentSrc||s.src,t.intrinsicWidth=s.naturalWidth,t.intrinsicHeight=s.naturalHeight,t.context.cache.addImage(t.src),t}return e}(Ui),df=function(r){Ei(e,r);function e(i,s){var t=r.call(this,i,s)||this;return t.canvas=s,t.intrinsicWidth=s.width,t.intrinsicHeight=s.height,t}return e}(Ui),pf=function(r){Ei(e,r);function e(i,s){var t=r.call(this,i,s)||this,o=new XMLSerializer,n=Wn(i,s);return s.setAttribute("width",n.width+"px"),s.setAttribute("height",n.height+"px"),t.svg="data:image/svg+xml,"+encodeURIComponent(o.serializeToString(s)),t.intrinsicWidth=s.width.baseVal.value,t.intrinsicHeight=s.height.baseVal.value,t.context.cache.addImage(t.svg),t}return e}(Ui),ff=function(r){Ei(e,r);function e(i,s){var t=r.call(this,i,s)||this;return t.value=s.value,t}return e}(Ui),dl=function(r){Ei(e,r);function e(i,s){var t=r.call(this,i,s)||this;return t.start=s.start,t.reversed=typeof s.reversed=="boolean"&&s.reversed===!0,t}return e}(Ui),I1=[{type:15,flags:0,unit:"px",number:3}],F1=[{type:16,flags:0,number:50}],M1=function(r){return r.width>r.height?new qi(r.left+(r.width-r.height)/2,r.top,r.height,r.height):r.width<r.height?new qi(r.left,r.top+(r.height-r.width)/2,r.width,r.width):r},S1=function(r){var e=r.type===T1?new Array(r.value.length+1).join(""):r.value;return e.length===0?r.placeholder||"":e},Ln="checkbox",Un="radio",T1="password",td=707406591,Il=function(r){Ei(e,r);function e(i,s){var t=r.call(this,i,s)||this;switch(t.type=s.type.toLowerCase(),t.checked=s.checked,t.value=S1(s),(t.type===Ln||t.type===Un)&&(t.styles.backgroundColor=3739148031,t.styles.borderTopColor=t.styles.borderRightColor=t.styles.borderBottomColor=t.styles.borderLeftColor=2779096575,t.styles.borderTopWidth=t.styles.borderRightWidth=t.styles.borderBottomWidth=t.styles.borderLeftWidth=1,t.styles.borderTopStyle=t.styles.borderRightStyle=t.styles.borderBottomStyle=t.styles.borderLeftStyle=1,t.styles.backgroundClip=[0],t.styles.backgroundOrigin=[0],t.bounds=M1(t.bounds)),t.type){case Ln:t.styles.borderTopRightRadius=t.styles.borderTopLeftRadius=t.styles.borderBottomRightRadius=t.styles.borderBottomLeftRadius=I1;break;case Un:t.styles.borderTopRightRadius=t.styles.borderTopLeftRadius=t.styles.borderBottomRightRadius=t.styles.borderBottomLeftRadius=F1;break}return t}return e}(Ui),gf=function(r){Ei(e,r);function e(i,s){var t=r.call(this,i,s)||this,o=s.options[s.selectedIndex||0];return t.value=o&&o.text||"",t}return e}(Ui),mf=function(r){Ei(e,r);function e(i,s){var t=r.call(this,i,s)||this;return t.value=s.value,t}return e}(Ui),_f=function(r){Ei(e,r);function e(i,s){var t=r.call(this,i,s)||this;t.src=s.src,t.width=parseInt(s.width,10)||0,t.height=parseInt(s.height,10)||0,t.backgroundColor=t.styles.backgroundColor;try{if(s.contentWindow&&s.contentWindow.document&&s.contentWindow.document.documentElement){t.tree=Pf(i,s.contentWindow.document.documentElement);var o=s.contentWindow.document.documentElement?Jr(i,getComputedStyle(s.contentWindow.document.documentElement).backgroundColor):Yi.TRANSPARENT,n=s.contentWindow.document.body?Jr(i,getComputedStyle(s.contentWindow.document.body).backgroundColor):Yi.TRANSPARENT;t.backgroundColor=cs(o)?cs(n)?t.styles.backgroundColor:n:o}}catch{}return t}return e}(Ui),D1=["OL","UL","MENU"],wn=function(r,e,i,s){for(var t=e.firstChild,o=void 0;t;t=o)if(o=t.nextSibling,Bf(t)&&t.data.trim().length>0)i.textNodes.push(new w1(r,t,i.styles));else if(sr(t))if(bf(t)&&t.assignedNodes)t.assignedNodes().forEach(function(a){return wn(r,a,i,s)});else{var n=vf(r,t);n.styles.isVisible()&&(R1(t,n,s)?n.flags|=4:L1(n.styles)&&(n.flags|=2),D1.indexOf(t.tagName)!==-1&&(n.flags|=8),i.elements.push(n),t.slot,t.shadowRoot?wn(r,t.shadowRoot,n,s):!On(t)&&!yf(t)&&!kn(t)&&wn(r,t,n,s))}},vf=function(r,e){return fl(e)?new uf(r,e):xf(e)?new df(r,e):yf(e)?new pf(r,e):U1(e)?new ff(r,e):O1(e)?new dl(r,e):k1(e)?new Il(r,e):kn(e)?new gf(r,e):On(e)?new mf(r,e):wf(e)?new _f(r,e):new Ui(r,e)},Pf=function(r,e){var i=vf(r,e);return i.flags|=4,wn(r,e,i,i),i},R1=function(r,e,i){return e.styles.isPositionedWithZIndex()||e.styles.opacity<1||e.styles.isTransformed()||Fl(r)&&i.styles.isTransparent()},L1=function(r){return r.isPositioned()||r.isFloating()},Bf=function(r){return r.nodeType===Node.TEXT_NODE},sr=function(r){return r.nodeType===Node.ELEMENT_NODE},pl=function(r){return sr(r)&&typeof r.style<"u"&&!bn(r)},bn=function(r){return typeof r.className=="object"},U1=function(r){return r.tagName==="LI"},O1=function(r){return r.tagName==="OL"},k1=function(r){return r.tagName==="INPUT"},N1=function(r){return r.tagName==="HTML"},yf=function(r){return r.tagName==="svg"},Fl=function(r){return r.tagName==="BODY"},xf=function(r){return r.tagName==="CANVAS"},id=function(r){return r.tagName==="VIDEO"},fl=function(r){return r.tagName==="IMG"},wf=function(r){return r.tagName==="IFRAME"},sd=function(r){return r.tagName==="STYLE"},Q1=function(r){return r.tagName==="SCRIPT"},On=function(r){return r.tagName==="TEXTAREA"},kn=function(r){return r.tagName==="SELECT"},bf=function(r){return r.tagName==="SLOT"},rd=function(r){return r.tagName.indexOf("-")>0},H1=function(){function r(){this.counters={}}return r.prototype.getCounterValue=function(e){var i=this.counters[e];return i&&i.length?i[i.length-1]:1},r.prototype.getCounterValues=function(e){var i=this.counters[e];return i||[]},r.prototype.pop=function(e){var i=this;e.forEach(function(s){return i.counters[s].pop()})},r.prototype.parse=function(e){var i=this,s=e.counterIncrement,t=e.counterReset,o=!0;s!==null&&s.forEach(function(a){var A=i.counters[a.counter];A&&a.increment!==0&&(o=!1,A.length||A.push(1),A[Math.max(0,A.length-1)]+=a.increment)});var n=[];return o&&t.forEach(function(a){var A=i.counters[a.counter];n.push(a.counter),A||(A=i.counters[a.counter]=[]),A.push(a.reset)}),n},r}(),od={integers:[1e3,900,500,400,100,90,50,40,10,9,5,4,1],values:["M","CM","D","CD","C","XC","L","XL","X","IX","V","IV","I"]},nd={integers:[9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,900,800,700,600,500,400,300,200,100,90,80,70,60,50,40,30,20,10,9,8,7,6,5,4,3,2,1],values:["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""]},V1={integers:[1e4,9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,400,300,200,100,90,80,70,60,50,40,30,20,19,18,17,16,15,10,9,8,7,6,5,4,3,2,1],values:["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""]},j1={integers:[1e4,9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,900,800,700,600,500,400,300,200,100,90,80,70,60,50,40,30,20,10,9,8,7,6,5,4,3,2,1],values:["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""]},Ws=function(r,e,i,s,t,o){return r<e||r>i?Ao(r,t,o.length>0):s.integers.reduce(function(n,a,A){for(;r>=a;)r-=a,n+=s.values[A];return n},"")+o},Cf=function(r,e,i,s){var t="";do i||r--,t=s(r)+t,r/=e;while(r*e>=e);return t},Dt=function(r,e,i,s,t){var o=i-e+1;return(r<0?"-":"")+(Cf(Math.abs(r),o,s,function(n){return Rt(Math.floor(n%o)+e)})+t)},_s=function(r,e,i){i===void 0&&(i=". ");var s=e.length;return Cf(Math.abs(r),s,!1,function(t){return e[Math.floor(t%s)]})+i},er=1,Ji=2,es=4,Yr=8,zi=function(r,e,i,s,t,o){if(r<-9999||r>9999)return Ao(r,4,t.length>0);var n=Math.abs(r),a=t;if(n===0)return e[0]+a;for(var A=0;n>0&&A<=4;A++){var l=n%10;l===0&&Qt(o,er)&&a!==""?a=e[l]+a:l>1||l===1&&A===0||l===1&&A===1&&Qt(o,Ji)||l===1&&A===1&&Qt(o,es)&&r>100||l===1&&A>1&&Qt(o,Yr)?a=e[l]+(A>0?i[A-1]:"")+a:l===1&&A>0&&(a=i[A-1]+a),n=Math.floor(n/10)}return(r<0?s:"")+a},ad="",Ad="",ld="",xA="",Ao=function(r,e,i){var s=i?". ":"",t=i?"":"",o=i?", ":"",n=i?" ":"";switch(e){case 0:return""+n;case 1:return""+n;case 2:return""+n;case 5:var a=Dt(r,48,57,!0,s);return a.length<4?"0"+a:a;case 4:return _s(r,"",t);case 6:return Ws(r,1,3999,od,3,s).toLowerCase();case 7:return Ws(r,1,3999,od,3,s);case 8:return Dt(r,945,969,!1,s);case 9:return Dt(r,97,122,!1,s);case 10:return Dt(r,65,90,!1,s);case 11:return Dt(r,1632,1641,!0,s);case 12:case 49:return Ws(r,1,9999,nd,3,s);case 35:return Ws(r,1,9999,nd,3,s).toLowerCase();case 13:return Dt(r,2534,2543,!0,s);case 14:case 30:return Dt(r,6112,6121,!0,s);case 15:return _s(r,"",t);case 16:return _s(r,"",t);case 17:case 48:return zi(r,"",ad,"",t,Ji|es|Yr);case 47:return zi(r,"",Ad,"",t,er|Ji|es|Yr);case 42:return zi(r,"",ad,"",t,Ji|es|Yr);case 41:return zi(r,"",Ad,"",t,er|Ji|es|Yr);case 26:return zi(r,"","",ld,t,0);case 25:return zi(r,"","",ld,t,er|Ji|es);case 31:return zi(r,"","",xA,o,er|Ji|es);case 33:return zi(r,"","",xA,o,0);case 32:return zi(r,"","",xA,o,er|Ji|es);case 18:return Dt(r,2406,2415,!0,s);case 20:return Ws(r,1,19999,j1,3,s);case 21:return Dt(r,2790,2799,!0,s);case 22:return Dt(r,2662,2671,!0,s);case 22:return Ws(r,1,10999,V1,3,s);case 23:return _s(r,"");case 24:return _s(r,"");case 27:return Dt(r,3302,3311,!0,s);case 28:return _s(r,"",t);case 29:return _s(r,"",t);case 34:return Dt(r,3792,3801,!0,s);case 37:return Dt(r,6160,6169,!0,s);case 38:return Dt(r,4160,4169,!0,s);case 39:return Dt(r,2918,2927,!0,s);case 40:return Dt(r,1776,1785,!0,s);case 43:return Dt(r,3046,3055,!0,s);case 44:return Dt(r,3174,3183,!0,s);case 45:return Dt(r,3664,3673,!0,s);case 46:return Dt(r,3872,3881,!0,s);case 3:default:return Dt(r,48,57,!0,s)}},Ef="data-html2canvas-ignore",cd=function(){function r(e,i,s){if(this.context=e,this.options=s,this.scrolledElements=[],this.referenceElement=i,this.counters=new H1,this.quoteDepth=0,!i.ownerDocument)throw new Error("Cloned element does not have an owner document");this.documentElement=this.cloneNode(i.ownerDocument.documentElement,!1)}return r.prototype.toIFrame=function(e,i){var s=this,t=G1(e,i);if(!t.contentWindow)return Promise.reject("Unable to find iframe window");var o=e.defaultView.pageXOffset,n=e.defaultView.pageYOffset,a=t.contentWindow,A=a.document,l=W1(t).then(function(){return oi(s,void 0,void 0,function(){var h,d;return qt(this,function(f){switch(f.label){case 0:return this.scrolledElements.forEach(Z1),a&&(a.scrollTo(i.left,i.top),/(iPad|iPhone|iPod)/g.test(navigator.userAgent)&&(a.scrollY!==i.top||a.scrollX!==i.left)&&(this.context.logger.warn("Unable to restore scroll position for cloned document"),this.context.windowBounds=this.context.windowBounds.add(a.scrollX-i.left,a.scrollY-i.top,0,0))),h=this.options.onclone,d=this.clonedReferenceElement,typeof d>"u"?[2,Promise.reject("Error finding the "+this.referenceElement.nodeName+" in the cloned document")]:A.fonts&&A.fonts.ready?[4,A.fonts.ready]:[3,2];case 1:f.sent(),f.label=2;case 2:return/(AppleWebKit)/g.test(navigator.userAgent)?[4,K1(A)]:[3,4];case 3:f.sent(),f.label=4;case 4:return typeof h=="function"?[2,Promise.resolve().then(function(){return h(A,d)}).then(function(){return t})]:[2,t]}})})});return A.open(),A.write(Y1(document.doctype)+"<html></html>"),$1(this.referenceElement.ownerDocument,o,n),A.replaceChild(A.adoptNode(this.documentElement),A.documentElement),A.close(),l},r.prototype.createElementClone=function(e){if(hl(e,2))debugger;if(xf(e))return this.createCanvasClone(e);if(id(e))return this.createVideoClone(e);if(sd(e))return this.createStyleClone(e);var i=e.cloneNode(!1);return fl(i)&&(fl(e)&&e.currentSrc&&e.currentSrc!==e.src&&(i.src=e.currentSrc,i.srcset=""),i.loading==="lazy"&&(i.loading="eager")),rd(i)?this.createCustomElementClone(i):i},r.prototype.createCustomElementClone=function(e){var i=document.createElement("html2canvascustomelement");return wA(e.style,i),i},r.prototype.createStyleClone=function(e){try{var i=e.sheet;if(i&&i.cssRules){var s=[].slice.call(i.cssRules,0).reduce(function(o,n){return n&&typeof n.cssText=="string"?o+n.cssText:o},""),t=e.cloneNode(!1);return t.textContent=s,t}}catch(o){if(this.context.logger.error("Unable to access cssRules property",o),o.name!=="SecurityError")throw o}return e.cloneNode(!1)},r.prototype.createCanvasClone=function(e){var i;if(this.options.inlineImages&&e.ownerDocument){var s=e.ownerDocument.createElement("img");try{return s.src=e.toDataURL(),s}catch{this.context.logger.info("Unable to inline canvas contents, canvas is tainted",e)}}var t=e.cloneNode(!1);try{t.width=e.width,t.height=e.height;var o=e.getContext("2d"),n=t.getContext("2d");if(n)if(!this.options.allowTaint&&o)n.putImageData(o.getImageData(0,0,e.width,e.height),0,0);else{var a=(i=e.getContext("webgl2"))!==null&&i!==void 0?i:e.getContext("webgl");if(a){var A=a.getContextAttributes();(A==null?void 0:A.preserveDrawingBuffer)===!1&&this.context.logger.warn("Unable to clone WebGL context as it has preserveDrawingBuffer=false",e)}n.drawImage(e,0,0)}return t}catch{this.context.logger.info("Unable to clone canvas as it is tainted",e)}return t},r.prototype.createVideoClone=function(e){var i=e.ownerDocument.createElement("canvas");i.width=e.offsetWidth,i.height=e.offsetHeight;var s=i.getContext("2d");try{return s&&(s.drawImage(e,0,0,i.width,i.height),this.options.allowTaint||s.getImageData(0,0,i.width,i.height)),i}catch{this.context.logger.info("Unable to clone video as it is tainted",e)}var t=e.ownerDocument.createElement("canvas");return t.width=e.offsetWidth,t.height=e.offsetHeight,t},r.prototype.appendChildNode=function(e,i,s){(!sr(i)||!Q1(i)&&!i.hasAttribute(Ef)&&(typeof this.options.ignoreElements!="function"||!this.options.ignoreElements(i)))&&(!this.options.copyStyles||!sr(i)||!sd(i))&&e.appendChild(this.cloneNode(i,s))},r.prototype.cloneChildNodes=function(e,i,s){for(var t=this,o=e.shadowRoot?e.shadowRoot.firstChild:e.firstChild;o;o=o.nextSibling)if(sr(o)&&bf(o)&&typeof o.assignedNodes=="function"){var n=o.assignedNodes();n.length&&n.forEach(function(a){return t.appendChildNode(i,a,s)})}else this.appendChildNode(i,o,s)},r.prototype.cloneNode=function(e,i){if(Bf(e))return document.createTextNode(e.data);if(!e.ownerDocument)return e.cloneNode(!1);var s=e.ownerDocument.defaultView;if(s&&sr(e)&&(pl(e)||bn(e))){var t=this.createElementClone(e);t.style.transitionProperty="none";var o=s.getComputedStyle(e),n=s.getComputedStyle(e,":before"),a=s.getComputedStyle(e,":after");this.referenceElement===e&&pl(t)&&(this.clonedReferenceElement=t),Fl(t)&&eE(t);var A=this.counters.parse(new Hu(this.context,o)),l=this.resolvePseudoContent(e,t,n,io.BEFORE);rd(e)&&(i=!0),id(e)||this.cloneChildNodes(e,t,i),l&&t.insertBefore(l,t.firstChild);var h=this.resolvePseudoContent(e,t,a,io.AFTER);return h&&t.appendChild(h),this.counters.pop(A),(o&&(this.options.copyStyles||bn(e))&&!wf(e)||i)&&wA(o,t),(e.scrollTop!==0||e.scrollLeft!==0)&&this.scrolledElements.push([t,e.scrollLeft,e.scrollTop]),(On(e)||kn(e))&&(On(t)||kn(t))&&(t.value=e.value),t}return e.cloneNode(!1)},r.prototype.resolvePseudoContent=function(e,i,s,t){var o=this;if(s){var n=s.content,a=i.ownerDocument;if(!(!a||!n||n==="none"||n==="-moz-alt-content"||s.display==="none")){this.counters.parse(new Hu(this.context,s));var A=new UC(this.context,s),l=a.createElement("html2canvaspseudoelement");wA(s,l),A.content.forEach(function(d){if(d.type===0)l.appendChild(a.createTextNode(d.value));else if(d.type===22){var f=a.createElement("img");f.src=d.value,f.style.opacity="1",l.appendChild(f)}else if(d.type===18){if(d.name==="attr"){var m=d.values.filter(Pt);m.length&&l.appendChild(a.createTextNode(e.getAttribute(m[0].value)||""))}else if(d.name==="counter"){var _=d.values.filter(ur),u=_[0],P=_[1];if(u&&Pt(u)){var y=o.counters.getCounterValue(u.value),x=P&&Pt(P)?cl.parse(o.context,P.value):3;l.appendChild(a.createTextNode(Ao(y,x,!1)))}}else if(d.name==="counters"){var B=d.values.filter(ur),u=B[0],v=B[1],P=B[2];if(u&&Pt(u)){var w=o.counters.getCounterValues(u.value),C=P&&Pt(P)?cl.parse(o.context,P.value):3,I=v&&v.type===0?v.value:"",E=w.map(function(D){return Ao(D,C,!1)}).join(I);l.appendChild(a.createTextNode(E))}}}else if(d.type===20)switch(d.value){case"open-quote":l.appendChild(a.createTextNode(Qu(A.quotes,o.quoteDepth++,!0)));break;case"close-quote":l.appendChild(a.createTextNode(Qu(A.quotes,--o.quoteDepth,!1)));break;default:l.appendChild(a.createTextNode(d.value))}}),l.className=gl+" "+ml;var h=t===io.BEFORE?" "+gl:" "+ml;return bn(i)?i.className.baseValue+=h:i.className+=h,l}}},r.destroy=function(e){return e.parentNode?(e.parentNode.removeChild(e),!0):!1},r}(),io;(function(r){r[r.BEFORE=0]="BEFORE",r[r.AFTER=1]="AFTER"})(io||(io={}));var G1=function(r,e){var i=r.createElement("iframe");return i.className="html2canvas-container",i.style.visibility="hidden",i.style.position="fixed",i.style.left="-10000px",i.style.top="0px",i.style.border="0",i.width=e.width.toString(),i.height=e.height.toString(),i.scrolling="no",i.setAttribute(Ef,"true"),r.body.appendChild(i),i},z1=function(r){return new Promise(function(e){if(r.complete){e();return}if(!r.src){e();return}r.onload=e,r.onerror=e})},K1=function(r){return Promise.all([].slice.call(r.images,0).map(z1))},W1=function(r){return new Promise(function(e,i){var s=r.contentWindow;if(!s)return i("No window assigned for iframe");var t=s.document;s.onload=r.onload=function(){s.onload=r.onload=null;var o=setInterval(function(){t.body.childNodes.length>0&&t.readyState==="complete"&&(clearInterval(o),e(r))},50)}})},X1=["all","d","content"],wA=function(r,e){for(var i=r.length-1;i>=0;i--){var s=r.item(i);X1.indexOf(s)===-1&&e.style.setProperty(s,r.getPropertyValue(s))}return e},Y1=function(r){var e="";return r&&(e+="<!DOCTYPE ",r.name&&(e+=r.name),r.internalSubset&&(e+=r.internalSubset),r.publicId&&(e+='"'+r.publicId+'"'),r.systemId&&(e+='"'+r.systemId+'"'),e+=">"),e},$1=function(r,e,i){r&&r.defaultView&&(e!==r.defaultView.pageXOffset||i!==r.defaultView.pageYOffset)&&r.defaultView.scrollTo(e,i)},Z1=function(r){var e=r[0],i=r[1],s=r[2];e.scrollLeft=i,e.scrollTop=s},q1=":before",J1=":after",gl="___html2canvas___pseudoelement_before",ml="___html2canvas___pseudoelement_after",hd=`{
    content: "" !important;
    display: none !important;
}`,eE=function(r){tE(r,"."+gl+q1+hd+`
         .`+ml+J1+hd)},tE=function(r,e){var i=r.ownerDocument;if(i){var s=i.createElement("style");s.textContent=e,r.appendChild(s)}},If=function(){function r(){}return r.getOrigin=function(e){var i=r._link;return i?(i.href=e,i.href=i.href,i.protocol+i.hostname+i.port):"about:blank"},r.isSameOrigin=function(e){return r.getOrigin(e)===r._origin},r.setContext=function(e){r._link=e.document.createElement("a"),r._origin=r.getOrigin(e.location.href)},r._origin="about:blank",r}(),iE=function(){function r(e,i){this.context=e,this._options=i,this._cache={}}return r.prototype.addImage=function(e){var i=Promise.resolve();return this.has(e)||(CA(e)||nE(e))&&(this._cache[e]=this.loadImage(e)).catch(function(){}),i},r.prototype.match=function(e){return this._cache[e]},r.prototype.loadImage=function(e){return oi(this,void 0,void 0,function(){var i,s,t,o,n=this;return qt(this,function(a){switch(a.label){case 0:return i=If.isSameOrigin(e),s=!bA(e)&&this._options.useCORS===!0&&Yt.SUPPORT_CORS_IMAGES&&!i,t=!bA(e)&&!i&&!CA(e)&&typeof this._options.proxy=="string"&&Yt.SUPPORT_CORS_XHR&&!s,!i&&this._options.allowTaint===!1&&!bA(e)&&!CA(e)&&!t&&!s?[2]:(o=e,t?[4,this.proxy(o)]:[3,2]);case 1:o=a.sent(),a.label=2;case 2:return this.context.logger.debug("Added image "+e.substring(0,256)),[4,new Promise(function(A,l){var h=new Image;h.onload=function(){return A(h)},h.onerror=l,(aE(o)||s)&&(h.crossOrigin="anonymous"),h.src=o,h.complete===!0&&setTimeout(function(){return A(h)},500),n._options.imageTimeout>0&&setTimeout(function(){return l("Timed out ("+n._options.imageTimeout+"ms) loading image")},n._options.imageTimeout)})];case 3:return[2,a.sent()]}})})},r.prototype.has=function(e){return typeof this._cache[e]<"u"},r.prototype.keys=function(){return Promise.resolve(Object.keys(this._cache))},r.prototype.proxy=function(e){var i=this,s=this._options.proxy;if(!s)throw new Error("No proxy defined");var t=e.substring(0,256);return new Promise(function(o,n){var a=Yt.SUPPORT_RESPONSE_TYPE?"blob":"text",A=new XMLHttpRequest;A.onload=function(){if(A.status===200)if(a==="text")o(A.response);else{var d=new FileReader;d.addEventListener("load",function(){return o(d.result)},!1),d.addEventListener("error",function(f){return n(f)},!1),d.readAsDataURL(A.response)}else n("Failed to proxy resource "+t+" with status code "+A.status)},A.onerror=n;var l=s.indexOf("?")>-1?"&":"?";if(A.open("GET",""+s+l+"url="+encodeURIComponent(e)+"&responseType="+a),a!=="text"&&A instanceof XMLHttpRequest&&(A.responseType=a),i._options.imageTimeout){var h=i._options.imageTimeout;A.timeout=h,A.ontimeout=function(){return n("Timed out ("+h+"ms) proxying "+t)}}A.send()})},r}(),sE=/^data:image\/svg\+xml/i,rE=/^data:image\/.*;base64,/i,oE=/^data:image\/.*/i,nE=function(r){return Yt.SUPPORT_SVG_DRAWING||!AE(r)},bA=function(r){return oE.test(r)},aE=function(r){return rE.test(r)},CA=function(r){return r.substr(0,4)==="blob"},AE=function(r){return r.substr(-3).toLowerCase()==="svg"||sE.test(r)},Re=function(){function r(e,i){this.type=0,this.x=e,this.y=i}return r.prototype.add=function(e,i){return new r(this.x+e,this.y+i)},r}(),Xs=function(r,e,i){return new Re(r.x+(e.x-r.x)*i,r.y+(e.y-r.y)*i)},un=function(){function r(e,i,s,t){this.type=1,this.start=e,this.startControl=i,this.endControl=s,this.end=t}return r.prototype.subdivide=function(e,i){var s=Xs(this.start,this.startControl,e),t=Xs(this.startControl,this.endControl,e),o=Xs(this.endControl,this.end,e),n=Xs(s,t,e),a=Xs(t,o,e),A=Xs(n,a,e);return i?new r(this.start,s,n,A):new r(A,a,o,this.end)},r.prototype.add=function(e,i){return new r(this.start.add(e,i),this.startControl.add(e,i),this.endControl.add(e,i),this.end.add(e,i))},r.prototype.reverse=function(){return new r(this.end,this.endControl,this.startControl,this.start)},r}(),Pi=function(r){return r.type===1},lE=function(){function r(e){var i=e.styles,s=e.bounds,t=Wr(i.borderTopLeftRadius,s.width,s.height),o=t[0],n=t[1],a=Wr(i.borderTopRightRadius,s.width,s.height),A=a[0],l=a[1],h=Wr(i.borderBottomRightRadius,s.width,s.height),d=h[0],f=h[1],m=Wr(i.borderBottomLeftRadius,s.width,s.height),_=m[0],u=m[1],P=[];P.push((o+A)/s.width),P.push((_+d)/s.width),P.push((n+u)/s.height),P.push((l+f)/s.height);var y=Math.max.apply(Math,P);y>1&&(o/=y,n/=y,A/=y,l/=y,d/=y,f/=y,_/=y,u/=y);var x=s.width-A,B=s.height-f,v=s.width-d,w=s.height-u,C=i.borderTopWidth,I=i.borderRightWidth,E=i.borderBottomWidth,S=i.borderLeftWidth,R=yt(i.paddingTop,e.bounds.width),D=yt(i.paddingRight,e.bounds.width),K=yt(i.paddingBottom,e.bounds.width),G=yt(i.paddingLeft,e.bounds.width);this.topLeftBorderDoubleOuterBox=o>0||n>0?bt(s.left+S/3,s.top+C/3,o-S/3,n-C/3,mt.TOP_LEFT):new Re(s.left+S/3,s.top+C/3),this.topRightBorderDoubleOuterBox=o>0||n>0?bt(s.left+x,s.top+C/3,A-I/3,l-C/3,mt.TOP_RIGHT):new Re(s.left+s.width-I/3,s.top+C/3),this.bottomRightBorderDoubleOuterBox=d>0||f>0?bt(s.left+v,s.top+B,d-I/3,f-E/3,mt.BOTTOM_RIGHT):new Re(s.left+s.width-I/3,s.top+s.height-E/3),this.bottomLeftBorderDoubleOuterBox=_>0||u>0?bt(s.left+S/3,s.top+w,_-S/3,u-E/3,mt.BOTTOM_LEFT):new Re(s.left+S/3,s.top+s.height-E/3),this.topLeftBorderDoubleInnerBox=o>0||n>0?bt(s.left+S*2/3,s.top+C*2/3,o-S*2/3,n-C*2/3,mt.TOP_LEFT):new Re(s.left+S*2/3,s.top+C*2/3),this.topRightBorderDoubleInnerBox=o>0||n>0?bt(s.left+x,s.top+C*2/3,A-I*2/3,l-C*2/3,mt.TOP_RIGHT):new Re(s.left+s.width-I*2/3,s.top+C*2/3),this.bottomRightBorderDoubleInnerBox=d>0||f>0?bt(s.left+v,s.top+B,d-I*2/3,f-E*2/3,mt.BOTTOM_RIGHT):new Re(s.left+s.width-I*2/3,s.top+s.height-E*2/3),this.bottomLeftBorderDoubleInnerBox=_>0||u>0?bt(s.left+S*2/3,s.top+w,_-S*2/3,u-E*2/3,mt.BOTTOM_LEFT):new Re(s.left+S*2/3,s.top+s.height-E*2/3),this.topLeftBorderStroke=o>0||n>0?bt(s.left+S/2,s.top+C/2,o-S/2,n-C/2,mt.TOP_LEFT):new Re(s.left+S/2,s.top+C/2),this.topRightBorderStroke=o>0||n>0?bt(s.left+x,s.top+C/2,A-I/2,l-C/2,mt.TOP_RIGHT):new Re(s.left+s.width-I/2,s.top+C/2),this.bottomRightBorderStroke=d>0||f>0?bt(s.left+v,s.top+B,d-I/2,f-E/2,mt.BOTTOM_RIGHT):new Re(s.left+s.width-I/2,s.top+s.height-E/2),this.bottomLeftBorderStroke=_>0||u>0?bt(s.left+S/2,s.top+w,_-S/2,u-E/2,mt.BOTTOM_LEFT):new Re(s.left+S/2,s.top+s.height-E/2),this.topLeftBorderBox=o>0||n>0?bt(s.left,s.top,o,n,mt.TOP_LEFT):new Re(s.left,s.top),this.topRightBorderBox=A>0||l>0?bt(s.left+x,s.top,A,l,mt.TOP_RIGHT):new Re(s.left+s.width,s.top),this.bottomRightBorderBox=d>0||f>0?bt(s.left+v,s.top+B,d,f,mt.BOTTOM_RIGHT):new Re(s.left+s.width,s.top+s.height),this.bottomLeftBorderBox=_>0||u>0?bt(s.left,s.top+w,_,u,mt.BOTTOM_LEFT):new Re(s.left,s.top+s.height),this.topLeftPaddingBox=o>0||n>0?bt(s.left+S,s.top+C,Math.max(0,o-S),Math.max(0,n-C),mt.TOP_LEFT):new Re(s.left+S,s.top+C),this.topRightPaddingBox=A>0||l>0?bt(s.left+Math.min(x,s.width-I),s.top+C,x>s.width+I?0:Math.max(0,A-I),Math.max(0,l-C),mt.TOP_RIGHT):new Re(s.left+s.width-I,s.top+C),this.bottomRightPaddingBox=d>0||f>0?bt(s.left+Math.min(v,s.width-S),s.top+Math.min(B,s.height-E),Math.max(0,d-I),Math.max(0,f-E),mt.BOTTOM_RIGHT):new Re(s.left+s.width-I,s.top+s.height-E),this.bottomLeftPaddingBox=_>0||u>0?bt(s.left+S,s.top+Math.min(w,s.height-E),Math.max(0,_-S),Math.max(0,u-E),mt.BOTTOM_LEFT):new Re(s.left+S,s.top+s.height-E),this.topLeftContentBox=o>0||n>0?bt(s.left+S+G,s.top+C+R,Math.max(0,o-(S+G)),Math.max(0,n-(C+R)),mt.TOP_LEFT):new Re(s.left+S+G,s.top+C+R),this.topRightContentBox=A>0||l>0?bt(s.left+Math.min(x,s.width+S+G),s.top+C+R,x>s.width+S+G?0:A-S+G,l-(C+R),mt.TOP_RIGHT):new Re(s.left+s.width-(I+D),s.top+C+R),this.bottomRightContentBox=d>0||f>0?bt(s.left+Math.min(v,s.width-(S+G)),s.top+Math.min(B,s.height+C+R),Math.max(0,d-(I+D)),f-(E+K),mt.BOTTOM_RIGHT):new Re(s.left+s.width-(I+D),s.top+s.height-(E+K)),this.bottomLeftContentBox=_>0||u>0?bt(s.left+S+G,s.top+w,Math.max(0,_-(S+G)),u-(E+K),mt.BOTTOM_LEFT):new Re(s.left+S+G,s.top+s.height-(E+K))}return r}(),mt;(function(r){r[r.TOP_LEFT=0]="TOP_LEFT",r[r.TOP_RIGHT=1]="TOP_RIGHT",r[r.BOTTOM_RIGHT=2]="BOTTOM_RIGHT",r[r.BOTTOM_LEFT=3]="BOTTOM_LEFT"})(mt||(mt={}));var bt=function(r,e,i,s,t){var o=4*((Math.sqrt(2)-1)/3),n=i*o,a=s*o,A=r+i,l=e+s;switch(t){case mt.TOP_LEFT:return new un(new Re(r,l),new Re(r,l-a),new Re(A-n,e),new Re(A,e));case mt.TOP_RIGHT:return new un(new Re(r,e),new Re(r+n,e),new Re(A,l-a),new Re(A,l));case mt.BOTTOM_RIGHT:return new un(new Re(A,e),new Re(A,e+a),new Re(r+n,l),new Re(r,l));case mt.BOTTOM_LEFT:default:return new un(new Re(A,l),new Re(A-n,l),new Re(r,e+a),new Re(r,e))}},Nn=function(r){return[r.topLeftBorderBox,r.topRightBorderBox,r.bottomRightBorderBox,r.bottomLeftBorderBox]},cE=function(r){return[r.topLeftContentBox,r.topRightContentBox,r.bottomRightContentBox,r.bottomLeftContentBox]},Qn=function(r){return[r.topLeftPaddingBox,r.topRightPaddingBox,r.bottomRightPaddingBox,r.bottomLeftPaddingBox]},hE=function(){function r(e,i,s){this.offsetX=e,this.offsetY=i,this.matrix=s,this.type=0,this.target=6}return r}(),dn=function(){function r(e,i){this.path=e,this.target=i,this.type=1}return r}(),uE=function(){function r(e){this.opacity=e,this.type=2,this.target=6}return r}(),dE=function(r){return r.type===0},Ff=function(r){return r.type===1},pE=function(r){return r.type===2},ud=function(r,e){return r.length===e.length?r.some(function(i,s){return i===e[s]}):!1},fE=function(r,e,i,s,t){return r.map(function(o,n){switch(n){case 0:return o.add(e,i);case 1:return o.add(e+s,i);case 2:return o.add(e+s,i+t);case 3:return o.add(e,i+t)}return o})},Mf=function(){function r(e){this.element=e,this.inlineLevel=[],this.nonInlineLevel=[],this.negativeZIndex=[],this.zeroOrAutoZIndexOrTransformedOrOpacity=[],this.positiveZIndex=[],this.nonPositionedFloats=[],this.nonPositionedInlineLevel=[]}return r}(),Sf=function(){function r(e,i){if(this.container=e,this.parent=i,this.effects=[],this.curves=new lE(this.container),this.container.styles.opacity<1&&this.effects.push(new uE(this.container.styles.opacity)),this.container.styles.transform!==null){var s=this.container.bounds.left+this.container.styles.transformOrigin[0].number,t=this.container.bounds.top+this.container.styles.transformOrigin[1].number,o=this.container.styles.transform;this.effects.push(new hE(s,t,o))}if(this.container.styles.overflowX!==0){var n=Nn(this.curves),a=Qn(this.curves);ud(n,a)?this.effects.push(new dn(n,6)):(this.effects.push(new dn(n,2)),this.effects.push(new dn(a,4)))}}return r.prototype.getEffects=function(e){for(var i=[2,3].indexOf(this.container.styles.position)===-1,s=this.parent,t=this.effects.slice(0);s;){var o=s.effects.filter(function(A){return!Ff(A)});if(i||s.container.styles.position!==0||!s.parent){if(t.unshift.apply(t,o),i=[2,3].indexOf(s.container.styles.position)===-1,s.container.styles.overflowX!==0){var n=Nn(s.curves),a=Qn(s.curves);ud(n,a)||t.unshift(new dn(a,6))}}else t.unshift.apply(t,o);s=s.parent}return t.filter(function(A){return Qt(A.target,e)})},r}(),_l=function(r,e,i,s){r.container.elements.forEach(function(t){var o=Qt(t.flags,4),n=Qt(t.flags,2),a=new Sf(t,r);Qt(t.styles.display,2048)&&s.push(a);var A=Qt(t.flags,8)?[]:s;if(o||n){var l=o||t.styles.isPositioned()?i:e,h=new Mf(a);if(t.styles.isPositioned()||t.styles.opacity<1||t.styles.isTransformed()){var d=t.styles.zIndex.order;if(d<0){var f=0;l.negativeZIndex.some(function(_,u){return d>_.element.container.styles.zIndex.order?(f=u,!1):f>0}),l.negativeZIndex.splice(f,0,h)}else if(d>0){var m=0;l.positiveZIndex.some(function(_,u){return d>=_.element.container.styles.zIndex.order?(m=u+1,!1):m>0}),l.positiveZIndex.splice(m,0,h)}else l.zeroOrAutoZIndexOrTransformedOrOpacity.push(h)}else t.styles.isFloating()?l.nonPositionedFloats.push(h):l.nonPositionedInlineLevel.push(h);_l(a,h,o?h:i,A)}else t.styles.isInlineLevel()?e.inlineLevel.push(a):e.nonInlineLevel.push(a),_l(a,e,i,A);Qt(t.flags,8)&&Tf(t,A)})},Tf=function(r,e){for(var i=r instanceof dl?r.start:1,s=r instanceof dl?r.reversed:!1,t=0;t<e.length;t++){var o=e[t];o.container instanceof ff&&typeof o.container.value=="number"&&o.container.value!==0&&(i=o.container.value),o.listValue=Ao(i,o.container.styles.listStyleType,!0),i+=s?-1:1}},gE=function(r){var e=new Sf(r,null),i=new Mf(e),s=[];return _l(e,i,i,s),Tf(e.container,s),i},dd=function(r,e){switch(e){case 0:return yi(r.topLeftBorderBox,r.topLeftPaddingBox,r.topRightBorderBox,r.topRightPaddingBox);case 1:return yi(r.topRightBorderBox,r.topRightPaddingBox,r.bottomRightBorderBox,r.bottomRightPaddingBox);case 2:return yi(r.bottomRightBorderBox,r.bottomRightPaddingBox,r.bottomLeftBorderBox,r.bottomLeftPaddingBox);case 3:default:return yi(r.bottomLeftBorderBox,r.bottomLeftPaddingBox,r.topLeftBorderBox,r.topLeftPaddingBox)}},mE=function(r,e){switch(e){case 0:return yi(r.topLeftBorderBox,r.topLeftBorderDoubleOuterBox,r.topRightBorderBox,r.topRightBorderDoubleOuterBox);case 1:return yi(r.topRightBorderBox,r.topRightBorderDoubleOuterBox,r.bottomRightBorderBox,r.bottomRightBorderDoubleOuterBox);case 2:return yi(r.bottomRightBorderBox,r.bottomRightBorderDoubleOuterBox,r.bottomLeftBorderBox,r.bottomLeftBorderDoubleOuterBox);case 3:default:return yi(r.bottomLeftBorderBox,r.bottomLeftBorderDoubleOuterBox,r.topLeftBorderBox,r.topLeftBorderDoubleOuterBox)}},_E=function(r,e){switch(e){case 0:return yi(r.topLeftBorderDoubleInnerBox,r.topLeftPaddingBox,r.topRightBorderDoubleInnerBox,r.topRightPaddingBox);case 1:return yi(r.topRightBorderDoubleInnerBox,r.topRightPaddingBox,r.bottomRightBorderDoubleInnerBox,r.bottomRightPaddingBox);case 2:return yi(r.bottomRightBorderDoubleInnerBox,r.bottomRightPaddingBox,r.bottomLeftBorderDoubleInnerBox,r.bottomLeftPaddingBox);case 3:default:return yi(r.bottomLeftBorderDoubleInnerBox,r.bottomLeftPaddingBox,r.topLeftBorderDoubleInnerBox,r.topLeftPaddingBox)}},vE=function(r,e){switch(e){case 0:return pn(r.topLeftBorderStroke,r.topRightBorderStroke);case 1:return pn(r.topRightBorderStroke,r.bottomRightBorderStroke);case 2:return pn(r.bottomRightBorderStroke,r.bottomLeftBorderStroke);case 3:default:return pn(r.bottomLeftBorderStroke,r.topLeftBorderStroke)}},pn=function(r,e){var i=[];return Pi(r)?i.push(r.subdivide(.5,!1)):i.push(r),Pi(e)?i.push(e.subdivide(.5,!0)):i.push(e),i},yi=function(r,e,i,s){var t=[];return Pi(r)?t.push(r.subdivide(.5,!1)):t.push(r),Pi(i)?t.push(i.subdivide(.5,!0)):t.push(i),Pi(s)?t.push(s.subdivide(.5,!0).reverse()):t.push(s),Pi(e)?t.push(e.subdivide(.5,!1).reverse()):t.push(e),t},Df=function(r){var e=r.bounds,i=r.styles;return e.add(i.borderLeftWidth,i.borderTopWidth,-(i.borderRightWidth+i.borderLeftWidth),-(i.borderTopWidth+i.borderBottomWidth))},Hn=function(r){var e=r.styles,i=r.bounds,s=yt(e.paddingLeft,i.width),t=yt(e.paddingRight,i.width),o=yt(e.paddingTop,i.width),n=yt(e.paddingBottom,i.width);return i.add(s+e.borderLeftWidth,o+e.borderTopWidth,-(e.borderRightWidth+e.borderLeftWidth+s+t),-(e.borderTopWidth+e.borderBottomWidth+o+n))},PE=function(r,e){return r===0?e.bounds:r===2?Hn(e):Df(e)},BE=function(r,e){return r===0?e.bounds:r===2?Hn(e):Df(e)},EA=function(r,e,i){var s=PE(tr(r.styles.backgroundOrigin,e),r),t=BE(tr(r.styles.backgroundClip,e),r),o=yE(tr(r.styles.backgroundSize,e),i,s),n=o[0],a=o[1],A=Wr(tr(r.styles.backgroundPosition,e),s.width-n,s.height-a),l=xE(tr(r.styles.backgroundRepeat,e),A,o,s,t),h=Math.round(s.left+A[0]),d=Math.round(s.top+A[1]);return[l,h,d,n,a]},Ys=function(r){return Pt(r)&&r.value===lr.AUTO},fn=function(r){return typeof r=="number"},yE=function(r,e,i){var s=e[0],t=e[1],o=e[2],n=r[0],a=r[1];if(!n)return[0,0];if(kt(n)&&a&&kt(a))return[yt(n,i.width),yt(a,i.height)];var A=fn(o);if(Pt(n)&&(n.value===lr.CONTAIN||n.value===lr.COVER)){if(fn(o)){var l=i.width/i.height;return l<o!=(n.value===lr.COVER)?[i.width,i.width/o]:[i.height*o,i.height]}return[i.width,i.height]}var h=fn(s),d=fn(t),f=h||d;if(Ys(n)&&(!a||Ys(a))){if(h&&d)return[s,t];if(!A&&!f)return[i.width,i.height];if(f&&A){var m=h?s:t*o,_=d?t:s/o;return[m,_]}var u=h?s:i.width,P=d?t:i.height;return[u,P]}if(A){var y=0,x=0;return kt(n)?y=yt(n,i.width):kt(a)&&(x=yt(a,i.height)),Ys(n)?y=x*o:(!a||Ys(a))&&(x=y/o),[y,x]}var B=null,v=null;if(kt(n)?B=yt(n,i.width):a&&kt(a)&&(v=yt(a,i.height)),B!==null&&(!a||Ys(a))&&(v=h&&d?B/s*t:i.height),v!==null&&Ys(n)&&(B=h&&d?v/t*s:i.width),B!==null&&v!==null)return[B,v];throw new Error("Unable to calculate background-size for element")},tr=function(r,e){var i=r[e];return typeof i>"u"?r[0]:i},xE=function(r,e,i,s,t){var o=e[0],n=e[1],a=i[0],A=i[1];switch(r){case 2:return[new Re(Math.round(s.left),Math.round(s.top+n)),new Re(Math.round(s.left+s.width),Math.round(s.top+n)),new Re(Math.round(s.left+s.width),Math.round(A+s.top+n)),new Re(Math.round(s.left),Math.round(A+s.top+n))];case 3:return[new Re(Math.round(s.left+o),Math.round(s.top)),new Re(Math.round(s.left+o+a),Math.round(s.top)),new Re(Math.round(s.left+o+a),Math.round(s.height+s.top)),new Re(Math.round(s.left+o),Math.round(s.height+s.top))];case 1:return[new Re(Math.round(s.left+o),Math.round(s.top+n)),new Re(Math.round(s.left+o+a),Math.round(s.top+n)),new Re(Math.round(s.left+o+a),Math.round(s.top+n+A)),new Re(Math.round(s.left+o),Math.round(s.top+n+A))];default:return[new Re(Math.round(t.left),Math.round(t.top)),new Re(Math.round(t.left+t.width),Math.round(t.top)),new Re(Math.round(t.left+t.width),Math.round(t.height+t.top)),new Re(Math.round(t.left),Math.round(t.height+t.top))]}},wE="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",pd="Hidden Text",bE=function(){function r(e){this._data={},this._document=e}return r.prototype.parseMetrics=function(e,i){var s=this._document.createElement("div"),t=this._document.createElement("img"),o=this._document.createElement("span"),n=this._document.body;s.style.visibility="hidden",s.style.fontFamily=e,s.style.fontSize=i,s.style.margin="0",s.style.padding="0",s.style.whiteSpace="nowrap",n.appendChild(s),t.src=wE,t.width=1,t.height=1,t.style.margin="0",t.style.padding="0",t.style.verticalAlign="baseline",o.style.fontFamily=e,o.style.fontSize=i,o.style.margin="0",o.style.padding="0",o.appendChild(this._document.createTextNode(pd)),s.appendChild(o),s.appendChild(t);var a=t.offsetTop-o.offsetTop+2;s.removeChild(o),s.appendChild(this._document.createTextNode(pd)),s.style.lineHeight="normal",t.style.verticalAlign="super";var A=t.offsetTop-s.offsetTop+2;return n.removeChild(s),{baseline:a,middle:A}},r.prototype.getMetrics=function(e,i){var s=e+" "+i;return typeof this._data[s]>"u"&&(this._data[s]=this.parseMetrics(e,i)),this._data[s]},r}(),Rf=function(){function r(e,i){this.context=e,this.options=i}return r}(),CE=1e4,EE=function(r){Ei(e,r);function e(i,s){var t=r.call(this,i,s)||this;return t._activeEffects=[],t.canvas=s.canvas?s.canvas:document.createElement("canvas"),t.ctx=t.canvas.getContext("2d"),s.canvas||(t.canvas.width=Math.floor(s.width*s.scale),t.canvas.height=Math.floor(s.height*s.scale),t.canvas.style.width=s.width+"px",t.canvas.style.height=s.height+"px"),t.fontMetrics=new bE(document),t.ctx.scale(t.options.scale,t.options.scale),t.ctx.translate(-s.x,-s.y),t.ctx.textBaseline="bottom",t._activeEffects=[],t.context.logger.debug("Canvas renderer initialized ("+s.width+"x"+s.height+") with scale "+s.scale),t}return e.prototype.applyEffects=function(i){for(var s=this;this._activeEffects.length;)this.popEffect();i.forEach(function(t){return s.applyEffect(t)})},e.prototype.applyEffect=function(i){this.ctx.save(),pE(i)&&(this.ctx.globalAlpha=i.opacity),dE(i)&&(this.ctx.translate(i.offsetX,i.offsetY),this.ctx.transform(i.matrix[0],i.matrix[1],i.matrix[2],i.matrix[3],i.matrix[4],i.matrix[5]),this.ctx.translate(-i.offsetX,-i.offsetY)),Ff(i)&&(this.path(i.path),this.ctx.clip()),this._activeEffects.push(i)},e.prototype.popEffect=function(){this._activeEffects.pop(),this.ctx.restore()},e.prototype.renderStack=function(i){return oi(this,void 0,void 0,function(){var s;return qt(this,function(t){switch(t.label){case 0:return s=i.element.container.styles,s.isVisible()?[4,this.renderStackContent(i)]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})},e.prototype.renderNode=function(i){return oi(this,void 0,void 0,function(){return qt(this,function(s){switch(s.label){case 0:if(Qt(i.container.flags,16))debugger;return i.container.styles.isVisible()?[4,this.renderNodeBackgroundAndBorders(i)]:[3,3];case 1:return s.sent(),[4,this.renderNodeContent(i)];case 2:s.sent(),s.label=3;case 3:return[2]}})})},e.prototype.renderTextWithLetterSpacing=function(i,s,t){var o=this;if(s===0)this.ctx.fillText(i.text,i.bounds.left,i.bounds.top+t);else{var n=El(i.text);n.reduce(function(a,A){return o.ctx.fillText(A,a,i.bounds.top+t),a+o.ctx.measureText(A).width},i.bounds.left)}},e.prototype.createFontStyle=function(i){var s=i.fontVariant.filter(function(n){return n==="normal"||n==="small-caps"}).join(""),t=TE(i.fontFamily).join(", "),o=po(i.fontSize)?""+i.fontSize.number+i.fontSize.unit:i.fontSize.number+"px";return[[i.fontStyle,s,i.fontWeight,o,t].join(" "),t,o]},e.prototype.renderTextNode=function(i,s){return oi(this,void 0,void 0,function(){var t,o,n,a,A,l,h,d,f=this;return qt(this,function(m){return t=this.createFontStyle(s),o=t[0],n=t[1],a=t[2],this.ctx.font=o,this.ctx.direction=s.direction===1?"rtl":"ltr",this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic",A=this.fontMetrics.getMetrics(n,a),l=A.baseline,h=A.middle,d=s.paintOrder,i.textBounds.forEach(function(_){d.forEach(function(u){switch(u){case 0:f.ctx.fillStyle=Vt(s.color),f.renderTextWithLetterSpacing(_,s.letterSpacing,l);var P=s.textShadow;P.length&&_.text.trim().length&&(P.slice(0).reverse().forEach(function(y){f.ctx.shadowColor=Vt(y.color),f.ctx.shadowOffsetX=y.offsetX.number*f.options.scale,f.ctx.shadowOffsetY=y.offsetY.number*f.options.scale,f.ctx.shadowBlur=y.blur.number,f.renderTextWithLetterSpacing(_,s.letterSpacing,l)}),f.ctx.shadowColor="",f.ctx.shadowOffsetX=0,f.ctx.shadowOffsetY=0,f.ctx.shadowBlur=0),s.textDecorationLine.length&&(f.ctx.fillStyle=Vt(s.textDecorationColor||s.color),s.textDecorationLine.forEach(function(y){switch(y){case 1:f.ctx.fillRect(_.bounds.left,Math.round(_.bounds.top+l),_.bounds.width,1);break;case 2:f.ctx.fillRect(_.bounds.left,Math.round(_.bounds.top),_.bounds.width,1);break;case 3:f.ctx.fillRect(_.bounds.left,Math.ceil(_.bounds.top+h),_.bounds.width,1);break}}));break;case 1:s.webkitTextStrokeWidth&&_.text.trim().length&&(f.ctx.strokeStyle=Vt(s.webkitTextStrokeColor),f.ctx.lineWidth=s.webkitTextStrokeWidth,f.ctx.lineJoin=window.chrome?"miter":"round",f.ctx.strokeText(_.text,_.bounds.left,_.bounds.top+l)),f.ctx.strokeStyle="",f.ctx.lineWidth=0,f.ctx.lineJoin="miter";break}})}),[2]})})},e.prototype.renderReplacedElement=function(i,s,t){if(t&&i.intrinsicWidth>0&&i.intrinsicHeight>0){var o=Hn(i),n=Qn(s);this.path(n),this.ctx.save(),this.ctx.clip(),this.ctx.drawImage(t,0,0,i.intrinsicWidth,i.intrinsicHeight,o.left,o.top,o.width,o.height),this.ctx.restore()}},e.prototype.renderNodeContent=function(i){return oi(this,void 0,void 0,function(){var s,t,o,n,a,A,x,x,l,h,d,f,v,m,_,w,u,P,y,x,B,v,w;return qt(this,function(C){switch(C.label){case 0:this.applyEffects(i.getEffects(4)),s=i.container,t=i.curves,o=s.styles,n=0,a=s.textNodes,C.label=1;case 1:return n<a.length?(A=a[n],[4,this.renderTextNode(A,o)]):[3,4];case 2:C.sent(),C.label=3;case 3:return n++,[3,1];case 4:if(!(s instanceof uf))return[3,8];C.label=5;case 5:return C.trys.push([5,7,,8]),[4,this.context.cache.match(s.src)];case 6:return x=C.sent(),this.renderReplacedElement(s,t,x),[3,8];case 7:return C.sent(),this.context.logger.error("Error loading image "+s.src),[3,8];case 8:if(s instanceof df&&this.renderReplacedElement(s,t,s.canvas),!(s instanceof pf))return[3,12];C.label=9;case 9:return C.trys.push([9,11,,12]),[4,this.context.cache.match(s.svg)];case 10:return x=C.sent(),this.renderReplacedElement(s,t,x),[3,12];case 11:return C.sent(),this.context.logger.error("Error loading svg "+s.svg.substring(0,255)),[3,12];case 12:return s instanceof _f&&s.tree?(l=new e(this.context,{scale:this.options.scale,backgroundColor:s.backgroundColor,x:0,y:0,width:s.width,height:s.height}),[4,l.render(s.tree)]):[3,14];case 13:h=C.sent(),s.width&&s.height&&this.ctx.drawImage(h,0,0,s.width,s.height,s.bounds.left,s.bounds.top,s.bounds.width,s.bounds.height),C.label=14;case 14:if(s instanceof Il&&(d=Math.min(s.bounds.width,s.bounds.height),s.type===Ln?s.checked&&(this.ctx.save(),this.path([new Re(s.bounds.left+d*.39363,s.bounds.top+d*.79),new Re(s.bounds.left+d*.16,s.bounds.top+d*.5549),new Re(s.bounds.left+d*.27347,s.bounds.top+d*.44071),new Re(s.bounds.left+d*.39694,s.bounds.top+d*.5649),new Re(s.bounds.left+d*.72983,s.bounds.top+d*.23),new Re(s.bounds.left+d*.84,s.bounds.top+d*.34085),new Re(s.bounds.left+d*.39363,s.bounds.top+d*.79)]),this.ctx.fillStyle=Vt(td),this.ctx.fill(),this.ctx.restore()):s.type===Un&&s.checked&&(this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(s.bounds.left+d/2,s.bounds.top+d/2,d/4,0,Math.PI*2,!0),this.ctx.fillStyle=Vt(td),this.ctx.fill(),this.ctx.restore())),IE(s)&&s.value.length){switch(f=this.createFontStyle(o),v=f[0],m=f[1],_=this.fontMetrics.getMetrics(v,m).baseline,this.ctx.font=v,this.ctx.fillStyle=Vt(o.color),this.ctx.textBaseline="alphabetic",this.ctx.textAlign=ME(s.styles.textAlign),w=Hn(s),u=0,s.styles.textAlign){case 1:u+=w.width/2;break;case 2:u+=w.width;break}P=w.add(u,0,0,-w.height/2+1),this.ctx.save(),this.path([new Re(w.left,w.top),new Re(w.left+w.width,w.top),new Re(w.left+w.width,w.top+w.height),new Re(w.left,w.top+w.height)]),this.ctx.clip(),this.renderTextWithLetterSpacing(new to(s.value,P),o.letterSpacing,_),this.ctx.restore(),this.ctx.textBaseline="alphabetic",this.ctx.textAlign="left"}if(!Qt(s.styles.display,2048))return[3,20];if(s.styles.listStyleImage===null)return[3,19];if(y=s.styles.listStyleImage,y.type!==0)return[3,18];x=void 0,B=y.url,C.label=15;case 15:return C.trys.push([15,17,,18]),[4,this.context.cache.match(B)];case 16:return x=C.sent(),this.ctx.drawImage(x,s.bounds.left-(x.width+10),s.bounds.top),[3,18];case 17:return C.sent(),this.context.logger.error("Error loading list-style-image "+B),[3,18];case 18:return[3,20];case 19:i.listValue&&s.styles.listStyleType!==-1&&(v=this.createFontStyle(o)[0],this.ctx.font=v,this.ctx.fillStyle=Vt(o.color),this.ctx.textBaseline="middle",this.ctx.textAlign="right",w=new qi(s.bounds.left,s.bounds.top+yt(s.styles.paddingTop,s.bounds.width),s.bounds.width,ku(o.lineHeight,o.fontSize.number)/2+1),this.renderTextWithLetterSpacing(new to(i.listValue,w),o.letterSpacing,ku(o.lineHeight,o.fontSize.number)/2+2),this.ctx.textBaseline="bottom",this.ctx.textAlign="left"),C.label=20;case 20:return[2]}})})},e.prototype.renderStackContent=function(i){return oi(this,void 0,void 0,function(){var s,t,y,o,n,y,a,A,y,l,h,y,d,f,y,m,_,y,u,P,y;return qt(this,function(x){switch(x.label){case 0:if(Qt(i.element.container.flags,16))debugger;return[4,this.renderNodeBackgroundAndBorders(i.element)];case 1:x.sent(),s=0,t=i.negativeZIndex,x.label=2;case 2:return s<t.length?(y=t[s],[4,this.renderStack(y)]):[3,5];case 3:x.sent(),x.label=4;case 4:return s++,[3,2];case 5:return[4,this.renderNodeContent(i.element)];case 6:x.sent(),o=0,n=i.nonInlineLevel,x.label=7;case 7:return o<n.length?(y=n[o],[4,this.renderNode(y)]):[3,10];case 8:x.sent(),x.label=9;case 9:return o++,[3,7];case 10:a=0,A=i.nonPositionedFloats,x.label=11;case 11:return a<A.length?(y=A[a],[4,this.renderStack(y)]):[3,14];case 12:x.sent(),x.label=13;case 13:return a++,[3,11];case 14:l=0,h=i.nonPositionedInlineLevel,x.label=15;case 15:return l<h.length?(y=h[l],[4,this.renderStack(y)]):[3,18];case 16:x.sent(),x.label=17;case 17:return l++,[3,15];case 18:d=0,f=i.inlineLevel,x.label=19;case 19:return d<f.length?(y=f[d],[4,this.renderNode(y)]):[3,22];case 20:x.sent(),x.label=21;case 21:return d++,[3,19];case 22:m=0,_=i.zeroOrAutoZIndexOrTransformedOrOpacity,x.label=23;case 23:return m<_.length?(y=_[m],[4,this.renderStack(y)]):[3,26];case 24:x.sent(),x.label=25;case 25:return m++,[3,23];case 26:u=0,P=i.positiveZIndex,x.label=27;case 27:return u<P.length?(y=P[u],[4,this.renderStack(y)]):[3,30];case 28:x.sent(),x.label=29;case 29:return u++,[3,27];case 30:return[2]}})})},e.prototype.mask=function(i){this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(this.canvas.width,0),this.ctx.lineTo(this.canvas.width,this.canvas.height),this.ctx.lineTo(0,this.canvas.height),this.ctx.lineTo(0,0),this.formatPath(i.slice(0).reverse()),this.ctx.closePath()},e.prototype.path=function(i){this.ctx.beginPath(),this.formatPath(i),this.ctx.closePath()},e.prototype.formatPath=function(i){var s=this;i.forEach(function(t,o){var n=Pi(t)?t.start:t;o===0?s.ctx.moveTo(n.x,n.y):s.ctx.lineTo(n.x,n.y),Pi(t)&&s.ctx.bezierCurveTo(t.startControl.x,t.startControl.y,t.endControl.x,t.endControl.y,t.end.x,t.end.y)})},e.prototype.renderRepeat=function(i,s,t,o){this.path(i),this.ctx.fillStyle=s,this.ctx.translate(t,o),this.ctx.fill(),this.ctx.translate(-t,-o)},e.prototype.resizeImage=function(i,s,t){var o;if(i.width===s&&i.height===t)return i;var n=(o=this.canvas.ownerDocument)!==null&&o!==void 0?o:document,a=n.createElement("canvas");a.width=Math.max(1,s),a.height=Math.max(1,t);var A=a.getContext("2d");return A.drawImage(i,0,0,i.width,i.height,0,0,s,t),a},e.prototype.renderBackgroundImage=function(i){return oi(this,void 0,void 0,function(){var s,t,o,n,a,A;return qt(this,function(l){switch(l.label){case 0:s=i.styles.backgroundImage.length-1,t=function(h){var d,f,m,R,ue,ae,G,z,E,_,R,ue,ae,G,z,u,P,y,x,B,v,w,C,I,E,S,R,D,K,G,z,le,ue,ae,Pe,be,xe,Ie,Fe,Qe,Ve,V;return qt(this,function(Z){switch(Z.label){case 0:if(h.type!==0)return[3,5];d=void 0,f=h.url,Z.label=1;case 1:return Z.trys.push([1,3,,4]),[4,o.context.cache.match(f)];case 2:return d=Z.sent(),[3,4];case 3:return Z.sent(),o.context.logger.error("Error loading background-image "+f),[3,4];case 4:return d&&(m=EA(i,s,[d.width,d.height,d.width/d.height]),R=m[0],ue=m[1],ae=m[2],G=m[3],z=m[4],E=o.ctx.createPattern(o.resizeImage(d,G,z),"repeat"),o.renderRepeat(R,E,ue,ae)),[3,6];case 5:db(h)?(_=EA(i,s,[null,null,null]),R=_[0],ue=_[1],ae=_[2],G=_[3],z=_[4],u=Ab(h.angle,G,z),P=u[0],y=u[1],x=u[2],B=u[3],v=u[4],w=document.createElement("canvas"),w.width=G,w.height=z,C=w.getContext("2d"),I=C.createLinearGradient(y,B,x,v),Uu(h.stops,P).forEach(function(L){return I.addColorStop(L.stop,Vt(L.color))}),C.fillStyle=I,C.fillRect(0,0,G,z),G>0&&z>0&&(E=o.ctx.createPattern(w,"repeat"),o.renderRepeat(R,E,ue,ae))):pb(h)&&(S=EA(i,s,[null,null,null]),R=S[0],D=S[1],K=S[2],G=S[3],z=S[4],le=h.position.length===0?[wl]:h.position,ue=yt(le[0],G),ae=yt(le[le.length-1],z),Pe=lb(h,ue,ae,G,z),be=Pe[0],xe=Pe[1],be>0&&xe>0&&(Ie=o.ctx.createRadialGradient(D+ue,K+ae,0,D+ue,K+ae,be),Uu(h.stops,be*2).forEach(function(L){return Ie.addColorStop(L.stop,Vt(L.color))}),o.path(R),o.ctx.fillStyle=Ie,be!==xe?(Fe=i.bounds.left+.5*i.bounds.width,Qe=i.bounds.top+.5*i.bounds.height,Ve=xe/be,V=1/Ve,o.ctx.save(),o.ctx.translate(Fe,Qe),o.ctx.transform(1,0,0,Ve,0,0),o.ctx.translate(-Fe,-Qe),o.ctx.fillRect(D,V*(K-Qe)+Qe,G,z*V),o.ctx.restore()):o.ctx.fill())),Z.label=6;case 6:return s--,[2]}})},o=this,n=0,a=i.styles.backgroundImage.slice(0).reverse(),l.label=1;case 1:return n<a.length?(A=a[n],[5,t(A)]):[3,4];case 2:l.sent(),l.label=3;case 3:return n++,[3,1];case 4:return[2]}})})},e.prototype.renderSolidBorder=function(i,s,t){return oi(this,void 0,void 0,function(){return qt(this,function(o){return this.path(dd(t,s)),this.ctx.fillStyle=Vt(i),this.ctx.fill(),[2]})})},e.prototype.renderDoubleBorder=function(i,s,t,o){return oi(this,void 0,void 0,function(){var n,a;return qt(this,function(A){switch(A.label){case 0:return s<3?[4,this.renderSolidBorder(i,t,o)]:[3,2];case 1:return A.sent(),[2];case 2:return n=mE(o,t),this.path(n),this.ctx.fillStyle=Vt(i),this.ctx.fill(),a=_E(o,t),this.path(a),this.ctx.fill(),[2]}})})},e.prototype.renderNodeBackgroundAndBorders=function(i){return oi(this,void 0,void 0,function(){var s,t,o,n,a,A,l,h,d=this;return qt(this,function(f){switch(f.label){case 0:return this.applyEffects(i.getEffects(2)),s=i.container.styles,t=!cs(s.backgroundColor)||s.backgroundImage.length,o=[{style:s.borderTopStyle,color:s.borderTopColor,width:s.borderTopWidth},{style:s.borderRightStyle,color:s.borderRightColor,width:s.borderRightWidth},{style:s.borderBottomStyle,color:s.borderBottomColor,width:s.borderBottomWidth},{style:s.borderLeftStyle,color:s.borderLeftColor,width:s.borderLeftWidth}],n=FE(tr(s.backgroundClip,0),i.curves),t||s.boxShadow.length?(this.ctx.save(),this.path(n),this.ctx.clip(),cs(s.backgroundColor)||(this.ctx.fillStyle=Vt(s.backgroundColor),this.ctx.fill()),[4,this.renderBackgroundImage(i.container)]):[3,2];case 1:f.sent(),this.ctx.restore(),s.boxShadow.slice(0).reverse().forEach(function(m){d.ctx.save();var _=Nn(i.curves),u=m.inset?0:CE,P=fE(_,-u+(m.inset?1:-1)*m.spread.number,(m.inset?1:-1)*m.spread.number,m.spread.number*(m.inset?-2:2),m.spread.number*(m.inset?-2:2));m.inset?(d.path(_),d.ctx.clip(),d.mask(P)):(d.mask(_),d.ctx.clip(),d.path(P)),d.ctx.shadowOffsetX=m.offsetX.number+u,d.ctx.shadowOffsetY=m.offsetY.number,d.ctx.shadowColor=Vt(m.color),d.ctx.shadowBlur=m.blur.number,d.ctx.fillStyle=m.inset?Vt(m.color):"rgba(0,0,0,1)",d.ctx.fill(),d.ctx.restore()}),f.label=2;case 2:a=0,A=0,l=o,f.label=3;case 3:return A<l.length?(h=l[A],h.style!==0&&!cs(h.color)&&h.width>0?h.style!==2?[3,5]:[4,this.renderDashedDottedBorder(h.color,h.width,a,i.curves,2)]:[3,11]):[3,13];case 4:return f.sent(),[3,11];case 5:return h.style!==3?[3,7]:[4,this.renderDashedDottedBorder(h.color,h.width,a,i.curves,3)];case 6:return f.sent(),[3,11];case 7:return h.style!==4?[3,9]:[4,this.renderDoubleBorder(h.color,h.width,a,i.curves)];case 8:return f.sent(),[3,11];case 9:return[4,this.renderSolidBorder(h.color,a,i.curves)];case 10:f.sent(),f.label=11;case 11:a++,f.label=12;case 12:return A++,[3,3];case 13:return[2]}})})},e.prototype.renderDashedDottedBorder=function(i,s,t,o,n){return oi(this,void 0,void 0,function(){var a,A,l,h,d,f,m,_,u,P,y,x,B,v,w,C,w,C;return qt(this,function(I){return this.ctx.save(),a=vE(o,t),A=dd(o,t),n===2&&(this.path(A),this.ctx.clip()),Pi(A[0])?(l=A[0].start.x,h=A[0].start.y):(l=A[0].x,h=A[0].y),Pi(A[1])?(d=A[1].end.x,f=A[1].end.y):(d=A[1].x,f=A[1].y),t===0||t===2?m=Math.abs(l-d):m=Math.abs(h-f),this.ctx.beginPath(),n===3?this.formatPath(a):this.formatPath(A.slice(0,2)),_=s<3?s*3:s*2,u=s<3?s*2:s,n===3&&(_=s,u=s),P=!0,m<=_*2?P=!1:m<=_*2+u?(y=m/(2*_+u),_*=y,u*=y):(x=Math.floor((m+u)/(_+u)),B=(m-x*_)/(x-1),v=(m-(x+1)*_)/x,u=v<=0||Math.abs(u-B)<Math.abs(u-v)?B:v),P&&(n===3?this.ctx.setLineDash([0,_+u]):this.ctx.setLineDash([_,u])),n===3?(this.ctx.lineCap="round",this.ctx.lineWidth=s):this.ctx.lineWidth=s*2+1.1,this.ctx.strokeStyle=Vt(i),this.ctx.stroke(),this.ctx.setLineDash([]),n===2&&(Pi(A[0])&&(w=A[3],C=A[0],this.ctx.beginPath(),this.formatPath([new Re(w.end.x,w.end.y),new Re(C.start.x,C.start.y)]),this.ctx.stroke()),Pi(A[1])&&(w=A[1],C=A[2],this.ctx.beginPath(),this.formatPath([new Re(w.end.x,w.end.y),new Re(C.start.x,C.start.y)]),this.ctx.stroke())),this.ctx.restore(),[2]})})},e.prototype.render=function(i){return oi(this,void 0,void 0,function(){var s;return qt(this,function(t){switch(t.label){case 0:return this.options.backgroundColor&&(this.ctx.fillStyle=Vt(this.options.backgroundColor),this.ctx.fillRect(this.options.x,this.options.y,this.options.width,this.options.height)),s=gE(i),[4,this.renderStack(s)];case 1:return t.sent(),this.applyEffects([]),[2,this.canvas]}})})},e}(Rf),IE=function(r){return r instanceof mf||r instanceof gf?!0:r instanceof Il&&r.type!==Un&&r.type!==Ln},FE=function(r,e){switch(r){case 0:return Nn(e);case 2:return cE(e);case 1:default:return Qn(e)}},ME=function(r){switch(r){case 1:return"center";case 2:return"right";case 0:default:return"left"}},SE=["-apple-system","system-ui"],TE=function(r){return/iPhone OS 15_(0|1)/.test(window.navigator.userAgent)?r.filter(function(e){return SE.indexOf(e)===-1}):r},DE=function(r){Ei(e,r);function e(i,s){var t=r.call(this,i,s)||this;return t.canvas=s.canvas?s.canvas:document.createElement("canvas"),t.ctx=t.canvas.getContext("2d"),t.options=s,t.canvas.width=Math.floor(s.width*s.scale),t.canvas.height=Math.floor(s.height*s.scale),t.canvas.style.width=s.width+"px",t.canvas.style.height=s.height+"px",t.ctx.scale(t.options.scale,t.options.scale),t.ctx.translate(-s.x,-s.y),t.context.logger.debug("EXPERIMENTAL ForeignObject renderer initialized ("+s.width+"x"+s.height+" at "+s.x+","+s.y+") with scale "+s.scale),t}return e.prototype.render=function(i){return oi(this,void 0,void 0,function(){var s,t;return qt(this,function(o){switch(o.label){case 0:return s=ul(this.options.width*this.options.scale,this.options.height*this.options.scale,this.options.scale,this.options.scale,i),[4,RE(s)];case 1:return t=o.sent(),this.options.backgroundColor&&(this.ctx.fillStyle=Vt(this.options.backgroundColor),this.ctx.fillRect(0,0,this.options.width*this.options.scale,this.options.height*this.options.scale)),this.ctx.drawImage(t,-this.options.x*this.options.scale,-this.options.y*this.options.scale),[2,this.canvas]}})})},e}(Rf),RE=function(r){return new Promise(function(e,i){var s=new Image;s.onload=function(){e(s)},s.onerror=i,s.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(new XMLSerializer().serializeToString(r))})},LE=function(){function r(e){var i=e.id,s=e.enabled;this.id=i,this.enabled=s,this.start=Date.now()}return r.prototype.debug=function(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];this.enabled&&(typeof window<"u"&&window.console&&typeof console.debug=="function"?console.debug.apply(console,Ko([this.id,this.getTime()+"ms"],e)):this.info.apply(this,e))},r.prototype.getTime=function(){return Date.now()-this.start},r.prototype.info=function(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];this.enabled&&typeof window<"u"&&window.console&&typeof console.info=="function"&&console.info.apply(console,Ko([this.id,this.getTime()+"ms"],e))},r.prototype.warn=function(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];this.enabled&&(typeof window<"u"&&window.console&&typeof console.warn=="function"?console.warn.apply(console,Ko([this.id,this.getTime()+"ms"],e)):this.info.apply(this,e))},r.prototype.error=function(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];this.enabled&&(typeof window<"u"&&window.console&&typeof console.error=="function"?console.error.apply(console,Ko([this.id,this.getTime()+"ms"],e)):this.info.apply(this,e))},r.instances={},r}(),UE=function(){function r(e,i){var s;this.windowBounds=i,this.instanceName="#"+r.instanceCount++,this.logger=new LE({id:this.instanceName,enabled:e.logging}),this.cache=(s=e.cache)!==null&&s!==void 0?s:new iE(this,e)}return r.instanceCount=1,r}(),fd=function(r,e){return e===void 0&&(e={}),OE(r,e)};typeof window<"u"&&If.setContext(window);var OE=function(r,e){return oi(void 0,void 0,void 0,function(){var i,s,t,o,n,a,A,l,h,d,f,m,_,u,P,y,x,B,v,w,I,C,I,E,S,R,D,K,G,z,le,ue,ae,Pe,be,xe,Ie,Fe,Qe,Ve;return qt(this,function(V){switch(V.label){case 0:if(!r||typeof r!="object")return[2,Promise.reject("Invalid element provided as first argument")];if(i=r.ownerDocument,!i)throw new Error("Element is not attached to a Document");if(s=i.defaultView,!s)throw new Error("Document is not attached to a Window");return t={allowTaint:(E=e.allowTaint)!==null&&E!==void 0?E:!1,imageTimeout:(S=e.imageTimeout)!==null&&S!==void 0?S:15e3,proxy:e.proxy,useCORS:(R=e.useCORS)!==null&&R!==void 0?R:!1},o=ZA({logging:(D=e.logging)!==null&&D!==void 0?D:!0,cache:e.cache},t),n={windowWidth:(K=e.windowWidth)!==null&&K!==void 0?K:s.innerWidth,windowHeight:(G=e.windowHeight)!==null&&G!==void 0?G:s.innerHeight,scrollX:(z=e.scrollX)!==null&&z!==void 0?z:s.pageXOffset,scrollY:(le=e.scrollY)!==null&&le!==void 0?le:s.pageYOffset},a=new qi(n.scrollX,n.scrollY,n.windowWidth,n.windowHeight),A=new UE(o,a),l=(ue=e.foreignObjectRendering)!==null&&ue!==void 0?ue:!1,h={allowTaint:(ae=e.allowTaint)!==null&&ae!==void 0?ae:!1,onclone:e.onclone,ignoreElements:e.ignoreElements,inlineImages:l,copyStyles:l},A.logger.debug("Starting document clone with size "+a.width+"x"+a.height+" scrolled to "+-a.left+","+-a.top),d=new cd(A,r,h),f=d.clonedReferenceElement,f?[4,d.toIFrame(i,a)]:[2,Promise.reject("Unable to find element in cloned iframe")];case 1:return m=V.sent(),_=Fl(f)||N1(f)?fx(f.ownerDocument):Wn(A,f),u=_.width,P=_.height,y=_.left,x=_.top,B=kE(A,f,e.backgroundColor),v={canvas:e.canvas,backgroundColor:B,scale:(be=(Pe=e.scale)!==null&&Pe!==void 0?Pe:s.devicePixelRatio)!==null&&be!==void 0?be:1,x:((xe=e.x)!==null&&xe!==void 0?xe:0)+y,y:((Ie=e.y)!==null&&Ie!==void 0?Ie:0)+x,width:(Fe=e.width)!==null&&Fe!==void 0?Fe:Math.ceil(u),height:(Qe=e.height)!==null&&Qe!==void 0?Qe:Math.ceil(P)},l?(A.logger.debug("Document cloned, using foreign object rendering"),I=new DE(A,v),[4,I.render(f)]):[3,3];case 2:return w=V.sent(),[3,5];case 3:return A.logger.debug("Document cloned, element located at "+y+","+x+" with size "+u+"x"+P+" using computed rendering"),A.logger.debug("Starting DOM parsing"),C=Pf(A,f),B===C.styles.backgroundColor&&(C.styles.backgroundColor=Yi.TRANSPARENT),A.logger.debug("Starting renderer for element at "+v.x+","+v.y+" with size "+v.width+"x"+v.height),I=new EE(A,v),[4,I.render(C)];case 4:w=V.sent(),V.label=5;case 5:return(!((Ve=e.removeContainer)!==null&&Ve!==void 0)||Ve)&&(cd.destroy(m)||A.logger.error("Cannot detach cloned iframe as it is not in the DOM anymore")),A.logger.debug("Finished rendering"),[2,w]}})})},kE=function(r,e,i){var s=e.ownerDocument,t=s.documentElement?Jr(r,getComputedStyle(s.documentElement).backgroundColor):Yi.TRANSPARENT,o=s.body?Jr(r,getComputedStyle(s.body).backgroundColor):Yi.TRANSPARENT,n=typeof i=="string"?Jr(r,i):i===null?Yi.TRANSPARENT:4294967295;return e===s.documentElement?cs(t)?cs(o)?n:o:t:n};class NE{constructor(e){this.language="en",this.localeService=e.localeService||new Ly,this.scene=new g_(this,{canvasId:e.canvasId,canvasElement:e.canvasElement,keyboardEventsElement:e.keyboardEventsElement,contextAttr:{preserveDrawingBuffer:e.preserveDrawingBuffer!==!1,premultipliedAlpha:!!e.premultipliedAlpha,antialias:e.antialias!==!1},spinnerElementId:e.spinnerElementId,transparent:e.transparent!==!1,gammaInput:!0,gammaOutput:!1,backgroundColor:e.backgroundColor,backgroundColorFromAmbientLight:e.backgroundColorFromAmbientLight,ticksPerRender:1,ticksPerOcclusionTest:20,units:e.units,scale:e.scale,origin:e.origin,saoEnabled:e.saoEnabled,alphaDepthMask:e.alphaDepthMask!==!1,entityOffsetsEnabled:!!e.entityOffsetsEnabled,pickSurfacePrecisionEnabled:!!e.pickSurfacePrecisionEnabled,logarithmicDepthBufferEnabled:!!e.logarithmicDepthBufferEnabled,pbrEnabled:!!e.pbrEnabled,colorTextureEnabled:e.colorTextureEnabled!==!1,dtxEnabled:!!e.dtxEnabled,numCachedSectionPlanes:e.numCachedSectionPlanes}),this.metaScene=new px(this,this.scene),this.id=e.id||this.scene.id,this.camera=this.scene.camera,this.cameraFlight=new bs(this.scene,{duration:.5}),this.cameraControl=new lx(this.scene,{doublePickFlyTo:!0}),this._plugins=[],this._eventSubs={}}get capabilities(){return this.scene.capabilities}on(e,i){let s=this._eventSubs[e];s||(s=[],this._eventSubs[e]=s),s.push(i)}fire(e,i){const s=this._eventSubs[e];if(s)for(let t=0,o=s.length;t<o;t++)s[t](i)}off(e){}log(e){console.log(`[xeokit viewer ${this.id}]: ${e}`)}error(e){console.error(`[xeokit viewer ${this.id}]: ${e}`)}addPlugin(e){this._plugins.push(e)}removePlugin(e){for(let i=0,s=this._plugins.length;i<s;i++){const t=this._plugins[i];if(t===e){t.clear&&t.clear(),this._plugins.splice(i,1);return}}}sendToPlugins(e,i){for(let s=0,t=this._plugins.length;s<t;s++){const o=this._plugins[s];o.send&&o.send(e,i)}}clear(){throw`Viewer#clear() no longer implemented - use '#sendToPlugins("clear") instead`}resetView(){throw"Viewer#resetView() no longer implemented - use CameraMemento & ObjectsMemento classes instead"}beginSnapshot(){this._snapshotBegun||(this.scene._renderer.beginSnapshot(),this._snapshotBegun=!0)}getSnapshot(e={}){const i=!this._snapshotBegun,s=e.width!==void 0&&e.height!==void 0,t=this.scene.canvas.canvas,o=t.clientWidth,n=t.clientHeight,a=e.width?Math.floor(e.width):t.width,A=e.height?Math.floor(e.height):t.height;s&&(t.width=a,t.height=A),this._snapshotBegun||this.beginSnapshot({width:a,height:A}),e.includeGizmos||this.sendToPlugins("snapshotStarting");const l={};for(let d=0,f=this._plugins.length;d<f;d++){const m=this._plugins[d];if(m.getContainerElement){const _=m.getContainerElement();_!==document.body&&(l[_.id]||(l[_.id]=!0,fd(_).then(function(u){document.body.appendChild(u)})))}}this.scene._renderer.renderSnapshot();const h=this.scene._renderer.readSnapshot(e);return s&&(t.width=o,t.height=n,this.scene.glRedraw()),e.includeGizmos||this.sendToPlugins("snapshotFinished"),i&&this.endSnapshot(),h}async getSnapshotWithPlugins(e={}){const i=!this._snapshotBegun,s=e.width!==void 0&&e.height!==void 0,t=this.scene.canvas.canvas,o=t.clientWidth,n=t.clientHeight,a=e.width?Math.floor(e.width):t.width,A=e.height?Math.floor(e.height):t.height;s&&(t.width=a,t.height=A),this._snapshotBegun||this.beginSnapshot(),e.includeGizmos||this.sendToPlugins("snapshotStarting"),this.scene._renderer.renderSnapshot();const l=this.scene._renderer.readSnapshotAsCanvas();s&&(t.width=o,t.height=n,this.scene.glRedraw());const h={},d=[];for(let m=0,_=this._plugins.length;m<_;m++){const u=this._plugins[m];if(u.getContainerElement){const P=u.getContainerElement();P!==document.body&&(h[P.id]||(h[P.id]=!0,d.push(P)))}}for(let m=0,_=d.length;m<_;m++){const u=d[m];await fd(u,{canvas:l,backgroundColor:null,scale:l.width/u.clientWidth})}e.includeGizmos||this.sendToPlugins("snapshotFinished"),i&&this.endSnapshot();let f=e.format||"png";return f!=="jpeg"&&f!=="png"&&f!=="bmp"&&(console.error("Unsupported image format: '"+f+"' - supported types are 'jpeg', 'bmp' and 'png' - defaulting to 'png'"),f="png"),e.includeGizmos||this.sendToPlugins("snapshotFinished"),i&&this.endSnapshot(),l.toDataURL(`image/${f}`)}endSnapshot(){this._snapshotBegun&&(this.scene._renderer.endSnapshot(),this.scene._renderer.render({force:!0}),this._snapshotBegun=!1)}destroy(){const e=this._plugins.slice();for(let i=0,s=e.length;i<s;i++)e[i].destroy();this.scene.destroy()}}const QE=!!(typeof process!="object"||String(process)!=="[object process]"||process.browser),gd=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);gd&&parseFloat(gd[1]);function lo(r,e){if(!r)throw new Error("loaders.gl assertion failed.")}const md=typeof process!="object"||String(process)!=="[object process]"||process.browser,HE=typeof window<"u"&&typeof window.orientation<"u",_d=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);_d&&parseFloat(_d[1]);function it(r,e,i){return e in r?Object.defineProperty(r,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):r[e]=i,r}class VE{constructor(e,i){it(this,"name",void 0),it(this,"workerThread",void 0),it(this,"isRunning",!0),it(this,"result",void 0),it(this,"_resolve",()=>{}),it(this,"_reject",()=>{}),this.name=e,this.workerThread=i,this.result=new Promise((s,t)=>{this._resolve=s,this._reject=t})}postMessage(e,i){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:i})}done(e){lo(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){lo(this.isRunning),this.isRunning=!1,this._reject(e)}}class IA{}const FA=new Map;function jE(r){lo(r.source&&!r.url||!r.source&&r.url);let e=FA.get(r.source||r.url);return e||(r.url&&(e=GE(r.url),FA.set(r.url,e)),r.source&&(e=Lf(r.source),FA.set(r.source,e))),lo(e),e}function GE(r){if(!r.startsWith("http"))return r;const e=zE(r);return Lf(e)}function Lf(r){const e=new Blob([r],{type:"application/javascript"});return URL.createObjectURL(e)}function zE(r){return`try {
  importScripts('`.concat(r,`');
} catch (error) {
  console.error(error);
  throw error;
}`)}function Uf(r,e=!0,i){const s=i||new Set;if(r){if(vd(r))s.add(r);else if(vd(r.buffer))s.add(r.buffer);else if(!ArrayBuffer.isView(r)){if(e&&typeof r=="object")for(const t in r)Uf(r[t],e,s)}}return i===void 0?Array.from(s):[]}function vd(r){return r?r instanceof ArrayBuffer||typeof MessagePort<"u"&&r instanceof MessagePort||typeof ImageBitmap<"u"&&r instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&r instanceof OffscreenCanvas:!1}const MA=()=>{};class vl{static isSupported(){return typeof Worker<"u"&&md||typeof IA!==void 0}constructor(e){it(this,"name",void 0),it(this,"source",void 0),it(this,"url",void 0),it(this,"terminated",!1),it(this,"worker",void 0),it(this,"onMessage",void 0),it(this,"onError",void 0),it(this,"_loadableURL","");const{name:i,source:s,url:t}=e;lo(s||t),this.name=i,this.source=s,this.url=t,this.onMessage=MA,this.onError=o=>console.log(o),this.worker=md?this._createBrowserWorker():this._createNodeWorker()}destroy(){this.onMessage=MA,this.onError=MA,this.worker.terminate(),this.terminated=!0}get isRunning(){return!!this.onMessage}postMessage(e,i){i=i||Uf(e),this.worker.postMessage(e,i)}_getErrorFromErrorEvent(e){let i="Failed to load ";return i+="worker ".concat(this.name," from ").concat(this.url,". "),e.message&&(i+="".concat(e.message," in ")),e.lineno&&(i+=":".concat(e.lineno,":").concat(e.colno)),new Error(i)}_createBrowserWorker(){this._loadableURL=jE({source:this.source,url:this.url});const e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=i=>{i.data?this.onMessage(i.data):this.onError(new Error("No data received"))},e.onerror=i=>{this.onError(this._getErrorFromErrorEvent(i)),this.terminated=!0},e.onmessageerror=i=>console.error(i),e}_createNodeWorker(){let e;if(this.url){const s=this.url.includes(":/")||this.url.startsWith("/")?this.url:"./".concat(this.url);e=new IA(s,{eval:!1})}else if(this.source)e=new IA(this.source,{eval:!0});else throw new Error("no worker");return e.on("message",i=>{this.onMessage(i)}),e.on("error",i=>{this.onError(i)}),e.on("exit",i=>{}),e}}class KE{static isSupported(){return vl.isSupported()}constructor(e){it(this,"name","unnamed"),it(this,"source",void 0),it(this,"url",void 0),it(this,"maxConcurrency",1),it(this,"maxMobileConcurrency",1),it(this,"onDebug",()=>{}),it(this,"reuseWorkers",!0),it(this,"props",{}),it(this,"jobQueue",[]),it(this,"idleQueue",[]),it(this,"count",0),it(this,"isDestroyed",!1),this.source=e.source,this.url=e.url,this.setProps(e)}destroy(){this.idleQueue.forEach(e=>e.destroy()),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},e.name!==void 0&&(this.name=e.name),e.maxConcurrency!==void 0&&(this.maxConcurrency=e.maxConcurrency),e.maxMobileConcurrency!==void 0&&(this.maxMobileConcurrency=e.maxMobileConcurrency),e.reuseWorkers!==void 0&&(this.reuseWorkers=e.reuseWorkers),e.onDebug!==void 0&&(this.onDebug=e.onDebug)}async startJob(e,i=(t,o,n)=>t.done(n),s=(t,o)=>t.error(o)){const t=new Promise(o=>(this.jobQueue.push({name:e,onMessage:i,onError:s,onStart:o}),this));return this._startQueuedJob(),await t}async _startQueuedJob(){if(!this.jobQueue.length)return;const e=this._getAvailableWorker();if(!e)return;const i=this.jobQueue.shift();if(i){this.onDebug({message:"Starting job",name:i.name,workerThread:e,backlog:this.jobQueue.length});const s=new VE(i.name,e);e.onMessage=t=>i.onMessage(s,t.type,t.payload),e.onError=t=>i.onError(s,t),i.onStart(s);try{await s.result}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const e="".concat(this.name.toLowerCase()," (#").concat(this.count," of ").concat(this.maxConcurrency,")");return new vl({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return HE?this.maxMobileConcurrency:this.maxConcurrency}}const WE={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}};class Ps{static isSupported(){return vl.isSupported()}static getWorkerFarm(e={}){return Ps._workerFarm=Ps._workerFarm||new Ps({}),Ps._workerFarm.setProps(e),Ps._workerFarm}constructor(e){it(this,"props",void 0),it(this,"workerPools",new Map),this.props={...WE},this.setProps(e),this.workerPools=new Map}destroy(){for(const e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props={...this.props,...e};for(const i of this.workerPools.values())i.setProps(this._getWorkerPoolProps())}getWorkerPool(e){const{name:i,source:s,url:t}=e;let o=this.workerPools.get(i);return o||(o=new KE({name:i,source:s,url:t}),o.setProps(this._getWorkerPoolProps()),this.workerPools.set(i,o)),o}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}}it(Ps,"_workerFarm",void 0);function XE(r){if(typeof window<"u"&&typeof window.process=="object"&&window.process.type==="renderer"||typeof process<"u"&&typeof process.versions=="object"&&process.versions.electron)return!0;const i=typeof navigator=="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent;return!!(i&&i.indexOf("Electron")>=0)}function YE(){return!(typeof process=="object"&&String(process)==="[object process]"&&!process.browser)||XE()}const Cn={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document,process:typeof process=="object"&&process},Pd=Cn.window||Cn.self||Cn.global,Bd=Cn.process||{},Of=typeof __VERSION__<"u"?__VERSION__:"untranspiled source",sa=YE();function $E(r){try{const e=window[r],i="__storage_test__";return e.setItem(i,i),e.removeItem(i),e}catch{return null}}class ZE{constructor(e,i,s="sessionStorage"){this.storage=$E(s),this.id=e,this.config={},Object.assign(this.config,i),this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){return this.config={},this.updateConfiguration(e)}updateConfiguration(e){if(Object.assign(this.config,e),this.storage){const i=JSON.stringify(this.config);this.storage.setItem(this.id,i)}return this}_loadConfiguration(){let e={};if(this.storage){const i=this.storage.getItem(this.id);e=i?JSON.parse(i):{}}return Object.assign(this.config,e),this}}function qE(r){let e;return r<10?e="".concat(r.toFixed(2),"ms"):r<100?e="".concat(r.toFixed(1),"ms"):r<1e3?e="".concat(r.toFixed(0),"ms"):e="".concat((r/1e3).toFixed(2),"s"),e}function JE(r,e=8){const i=Math.max(e-r.length,0);return"".concat(" ".repeat(i)).concat(r)}function SA(r,e,i,s=600){const t=r.src.replace(/\(/g,"%28").replace(/\)/g,"%29");r.width>s&&(i=Math.min(i,s/r.width));const o=r.width*i,n=r.height*i,a=["font-size:1px;","padding:".concat(Math.floor(n/2),"px ").concat(Math.floor(o/2),"px;"),"line-height:".concat(n,"px;"),"background:url(".concat(t,");"),"background-size:".concat(o,"px ").concat(n,"px;"),"color:transparent;"].join("");return["".concat(e," %c+"),a]}const yd={BLACK:30,RED:31,GREEN:32,YELLOW:33,BLUE:34,MAGENTA:35,CYAN:36,WHITE:37,BRIGHT_BLACK:90,BRIGHT_RED:91,BRIGHT_GREEN:92,BRIGHT_YELLOW:93,BRIGHT_BLUE:94,BRIGHT_MAGENTA:95,BRIGHT_CYAN:96,BRIGHT_WHITE:97};function xd(r){return typeof r=="string"?yd[r.toUpperCase()]||yd.WHITE:r}function eI(r,e,i){return!sa&&typeof r=="string"&&(e&&(e=xd(e),r="\x1B[".concat(e,"m").concat(r,"\x1B[39m")),i&&(e=xd(i),r="\x1B[".concat(i+10,"m").concat(r,"\x1B[49m"))),r}function tI(r,e=["constructor"]){const i=Object.getPrototypeOf(r),s=Object.getOwnPropertyNames(i);for(const t of s)typeof r[t]=="function"&&(e.find(o=>t===o)||(r[t]=r[t].bind(r)))}function Vn(r,e){if(!r)throw new Error(e||"Assertion failed")}function $s(){let r;if(sa&&Pd.performance)r=Pd.performance.now();else if(Bd.hrtime){const e=Bd.hrtime();r=e[0]*1e3+e[1]/1e6}else r=Date.now();return r}const Zs={debug:sa&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},iI={enabled:!0,level:0};function mi(){}const wd={},bd={once:!0};function sI(r){for(const e in r)for(const i in r[e])return i||"untitled";return"empty"}class kf{constructor({id:e}={id:""}){this.id=e,this.VERSION=Of,this._startTs=$s(),this._deltaTs=$s(),this.LOG_THROTTLE_TIMEOUT=0,this._storage=new ZE("__probe-".concat(this.id,"__"),iI),this.userData={},this.timeStamp("".concat(this.id," started")),tI(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number(($s()-this._startTs).toPrecision(10))}getDelta(){return Number(($s()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(e=!0){return this._storage.updateConfiguration({enabled:e}),this}setLevel(e){return this._storage.updateConfiguration({level:e}),this}assert(e,i){Vn(e,i)}warn(e){return this._getLogFunction(0,e,Zs.warn,arguments,bd)}error(e){return this._getLogFunction(0,e,Zs.error,arguments)}deprecated(e,i){return this.warn("`".concat(e,"` is deprecated and will be removed in a later version. Use `").concat(i,"` instead"))}removed(e,i){return this.error("`".concat(e,"` has been removed. Use `").concat(i,"` instead"))}probe(e,i){return this._getLogFunction(e,i,Zs.log,arguments,{time:!0,once:!0})}log(e,i){return this._getLogFunction(e,i,Zs.debug,arguments)}info(e,i){return this._getLogFunction(e,i,console.info,arguments)}once(e,i){return this._getLogFunction(e,i,Zs.debug||Zs.info,arguments,bd)}table(e,i,s){return i?this._getLogFunction(e,i,console.table||mi,s&&[s],{tag:sI(i)}):mi}image({logLevel:e,priority:i,image:s,message:t="",scale:o=1}){return this._shouldLog(e||i)?sa?nI({image:s,message:t,scale:o}):oI({image:s,message:t,scale:o}):mi}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}get(e){return this._storage.config[e]}set(e,i){this._storage.updateConfiguration({[e]:i})}time(e,i){return this._getLogFunction(e,i,console.time?console.time:console.info)}timeEnd(e,i){return this._getLogFunction(e,i,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,i){return this._getLogFunction(e,i,console.timeStamp||mi)}group(e,i,s={collapsed:!1}){s=Cd({logLevel:e,message:i,opts:s});const{collapsed:t}=s;return s.method=(t?console.groupCollapsed:console.group)||console.info,this._getLogFunction(s)}groupCollapsed(e,i,s={}){return this.group(e,i,Object.assign({},s,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||mi)}withGroup(e,i,s){this.group(e,i)();try{s()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=Nf(e)}_getLogFunction(e,i,s,t=[],o){if(this._shouldLog(e)){o=Cd({logLevel:e,message:i,args:t,opts:o}),s=s||o.method,Vn(s),o.total=this.getTotal(),o.delta=this.getDelta(),this._deltaTs=$s();const n=o.tag||o.message;if(o.once)if(!wd[n])wd[n]=$s();else return mi;return i=rI(this.id,o.message,o),s.bind(console,i,...o.args)}return mi}}kf.VERSION=Of;function Nf(r){if(!r)return 0;let e;switch(typeof r){case"number":e=r;break;case"object":e=r.logLevel||r.priority||0;break;default:return 0}return Vn(Number.isFinite(e)&&e>=0),e}function Cd(r){const{logLevel:e,message:i}=r;r.logLevel=Nf(e);const s=r.args?Array.from(r.args):[];for(;s.length&&s.shift()!==i;);switch(r.args=s,typeof e){case"string":case"function":i!==void 0&&s.unshift(i),r.message=e;break;case"object":Object.assign(r,e);break}typeof r.message=="function"&&(r.message=r.message());const t=typeof r.message;return Vn(t==="string"||t==="object"),Object.assign(r,r.opts)}function rI(r,e,i){if(typeof e=="string"){const s=i.time?JE(qE(i.total)):"";e=i.time?"".concat(r,": ").concat(s,"  ").concat(e):"".concat(r,": ").concat(e),e=eI(e,i.color,i.background)}return e}function oI({image:r,message:e="",scale:i=1}){let s=null;try{s=ra.require("asciify-image")}catch{}return s?()=>s(r,{fit:"box",width:"".concat(Math.round(80*i),"%")}).then(t=>console.log(t)):mi}function nI({image:r,message:e="",scale:i=1}){if(typeof r=="string"){const t=new Image;return t.onload=()=>{const o=SA(t,e,i);console.log(...o)},t.src=r,mi}const s=r.nodeName||"";if(s.toLowerCase()==="img")return console.log(...SA(r,e,i)),mi;if(s.toLowerCase()==="canvas"){const t=new Image;return t.onload=()=>console.log(...SA(t,e,i)),t.src=r.toDataURL(),mi}return mi}new kf({id:"loaders.gl"});class aI{constructor(){it(this,"console",void 0),this.console=console}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}}new aI;function AI(r){if(typeof window<"u"&&typeof window.process=="object"&&window.process.type==="renderer"||typeof process<"u"&&typeof process.versions=="object"&&process.versions.electron)return!0;const i=typeof navigator=="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent;return!!(i&&i.indexOf("Electron")>=0)}function fo(){return!(typeof process=="object"&&String(process)==="[object process]"&&!process.browser)||AI()}const En={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document,process:typeof process=="object"&&process},gn=En.window||En.self||En.global,Hr=En.process||{},Qf=typeof __VERSION__<"u"?__VERSION__:"untranspiled source";fo();function lI(r){try{const e=window[r],i="__storage_test__";return e.setItem(i,i),e.removeItem(i),e}catch{return null}}class cI{constructor(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"sessionStorage";it(this,"storage",void 0),it(this,"id",void 0),it(this,"config",{}),this.storage=lI(s),this.id=e,this.config={},Object.assign(this.config,i),this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){return this.config={},this.updateConfiguration(e)}updateConfiguration(e){if(Object.assign(this.config,e),this.storage){const i=JSON.stringify(this.config);this.storage.setItem(this.id,i)}return this}_loadConfiguration(){let e={};if(this.storage){const i=this.storage.getItem(this.id);e=i?JSON.parse(i):{}}return Object.assign(this.config,e),this}}function hI(r){let e;return r<10?e="".concat(r.toFixed(2),"ms"):r<100?e="".concat(r.toFixed(1),"ms"):r<1e3?e="".concat(r.toFixed(0),"ms"):e="".concat((r/1e3).toFixed(2),"s"),e}function uI(r){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:8;const i=Math.max(e-r.length,0);return"".concat(" ".repeat(i)).concat(r)}function TA(r,e,i){let s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:600;const t=r.src.replace(/\(/g,"%28").replace(/\)/g,"%29");r.width>s&&(i=Math.min(i,s/r.width));const o=r.width*i,n=r.height*i,a=["font-size:1px;","padding:".concat(Math.floor(n/2),"px ").concat(Math.floor(o/2),"px;"),"line-height:".concat(n,"px;"),"background:url(".concat(t,");"),"background-size:".concat(o,"px ").concat(n,"px;"),"color:transparent;"].join("");return["".concat(e," %c+"),a]}let jn;(function(r){r[r.BLACK=30]="BLACK",r[r.RED=31]="RED",r[r.GREEN=32]="GREEN",r[r.YELLOW=33]="YELLOW",r[r.BLUE=34]="BLUE",r[r.MAGENTA=35]="MAGENTA",r[r.CYAN=36]="CYAN",r[r.WHITE=37]="WHITE",r[r.BRIGHT_BLACK=90]="BRIGHT_BLACK",r[r.BRIGHT_RED=91]="BRIGHT_RED",r[r.BRIGHT_GREEN=92]="BRIGHT_GREEN",r[r.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",r[r.BRIGHT_BLUE=94]="BRIGHT_BLUE",r[r.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",r[r.BRIGHT_CYAN=96]="BRIGHT_CYAN",r[r.BRIGHT_WHITE=97]="BRIGHT_WHITE"})(jn||(jn={}));function Ed(r){return typeof r=="string"?jn[r.toUpperCase()]||jn.WHITE:r}function dI(r,e,i){return!fo&&typeof r=="string"&&(e&&(e=Ed(e),r="\x1B[".concat(e,"m").concat(r,"\x1B[39m")),i&&(e=Ed(i),r="\x1B[".concat(i+10,"m").concat(r,"\x1B[49m"))),r}function pI(r){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:["constructor"];const i=Object.getPrototypeOf(r),s=Object.getOwnPropertyNames(i);for(const t of s)typeof r[t]=="function"&&(e.find(o=>t===o)||(r[t]=r[t].bind(r)))}function Gn(r,e){if(!r)throw new Error(e||"Assertion failed")}function qs(){let r;if(fo&&"performance"in gn){var e,i;r=gn==null||(e=gn.performance)===null||e===void 0||(i=e.now)===null||i===void 0?void 0:i.call(e)}else if("hrtime"in Hr){var s;const t=Hr==null||(s=Hr.hrtime)===null||s===void 0?void 0:s.call(Hr);r=t[0]*1e3+t[1]/1e6}else r=Date.now();return r}const Js={debug:fo&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},fI={enabled:!0,level:0};function _i(){}const Id={},Fd={once:!0};class Hf{constructor(){let{id:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{id:""};it(this,"id",void 0),it(this,"VERSION",Qf),it(this,"_startTs",qs()),it(this,"_deltaTs",qs()),it(this,"_storage",void 0),it(this,"userData",{}),it(this,"LOG_THROTTLE_TIMEOUT",0),this.id=e,this._storage=new cI("__probe-".concat(this.id,"__"),fI),this.userData={},this.timeStamp("".concat(this.id," started")),pI(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((qs()-this._startTs).toPrecision(10))}getDelta(){return Number((qs()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return this._storage.updateConfiguration({enabled:e}),this}setLevel(e){return this._storage.updateConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,i){this._storage.updateConfiguration({[e]:i})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(e,i){Gn(e,i)}warn(e){return this._getLogFunction(0,e,Js.warn,arguments,Fd)}error(e){return this._getLogFunction(0,e,Js.error,arguments)}deprecated(e,i){return this.warn("`".concat(e,"` is deprecated and will be removed in a later version. Use `").concat(i,"` instead"))}removed(e,i){return this.error("`".concat(e,"` has been removed. Use `").concat(i,"` instead"))}probe(e,i){return this._getLogFunction(e,i,Js.log,arguments,{time:!0,once:!0})}log(e,i){return this._getLogFunction(e,i,Js.debug,arguments)}info(e,i){return this._getLogFunction(e,i,console.info,arguments)}once(e,i){for(var s=arguments.length,t=new Array(s>2?s-2:0),o=2;o<s;o++)t[o-2]=arguments[o];return this._getLogFunction(e,i,Js.debug||Js.info,arguments,Fd)}table(e,i,s){return i?this._getLogFunction(e,i,console.table||_i,s&&[s],{tag:vI(i)}):_i}image(e){let{logLevel:i,priority:s,image:t,message:o="",scale:n=1}=e;return this._shouldLog(i||s)?fo?_I({image:t,message:o,scale:n}):mI({image:t,message:o,scale:n}):_i}time(e,i){return this._getLogFunction(e,i,console.time?console.time:console.info)}timeEnd(e,i){return this._getLogFunction(e,i,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,i){return this._getLogFunction(e,i,console.timeStamp||_i)}group(e,i){let s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{collapsed:!1};const t=Md({logLevel:e,message:i,opts:s}),{collapsed:o}=s;return t.method=(o?console.groupCollapsed:console.group)||console.info,this._getLogFunction(t)}groupCollapsed(e,i){let s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return this.group(e,i,Object.assign({},s,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||_i)}withGroup(e,i,s){this.group(e,i)();try{s()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=Vf(e)}_getLogFunction(e,i,s,t,o){if(this._shouldLog(e)){o=Md({logLevel:e,message:i,args:t,opts:o}),s=s||o.method,Gn(s),o.total=this.getTotal(),o.delta=this.getDelta(),this._deltaTs=qs();const n=o.tag||o.message;if(o.once)if(!Id[n])Id[n]=qs();else return _i;return i=gI(this.id,o.message,o),s.bind(console,i,...o.args)}return _i}}it(Hf,"VERSION",Qf);function Vf(r){if(!r)return 0;let e;switch(typeof r){case"number":e=r;break;case"object":e=r.logLevel||r.priority||0;break;default:return 0}return Gn(Number.isFinite(e)&&e>=0),e}function Md(r){const{logLevel:e,message:i}=r;r.logLevel=Vf(e);const s=r.args?Array.from(r.args):[];for(;s.length&&s.shift()!==i;);switch(typeof e){case"string":case"function":i!==void 0&&s.unshift(i),r.message=e;break;case"object":Object.assign(r,e);break}typeof r.message=="function"&&(r.message=r.message());const t=typeof r.message;return Gn(t==="string"||t==="object"),Object.assign(r,{args:s},r.opts)}function gI(r,e,i){if(typeof e=="string"){const s=i.time?uI(hI(i.total)):"";e=i.time?"".concat(r,": ").concat(s,"  ").concat(e):"".concat(r,": ").concat(e),e=dI(e,i.color,i.background)}return e}function mI(r){let{image:e,message:i="",scale:s=1}=r,t=null;try{t=ra.require("asciify-image")}catch{}return t?()=>t(e,{fit:"box",width:"".concat(Math.round(80*s),"%")}).then(o=>console.log(o)):_i}function _I(r){let{image:e,message:i="",scale:s=1}=r;if(typeof e=="string"){const o=new Image;return o.onload=()=>{const n=TA(o,i,s);console.log(...n)},o.src=e,_i}const t=e.nodeName||"";if(t.toLowerCase()==="img")return console.log(...TA(e,i,s)),_i;if(t.toLowerCase()==="canvas"){const o=new Image;return o.onload=()=>console.log(...TA(o,i,s)),o.src=e.toDataURL(),_i}return _i}function vI(r){for(const e in r)for(const i in r[e])return i||"untitled";return"empty"}new Hf({id:"loaders.gl"});var Sd,Td,Dd,Rd,Ld,Ud,Od,kd;(function(r){r[r.NONE=0]="NONE",r[r.BASISLZ=1]="BASISLZ",r[r.ZSTD=2]="ZSTD",r[r.ZLIB=3]="ZLIB"})(Sd||(Sd={})),function(r){r[r.BASICFORMAT=0]="BASICFORMAT"}(Td||(Td={})),function(r){r[r.UNSPECIFIED=0]="UNSPECIFIED",r[r.ETC1S=163]="ETC1S",r[r.UASTC=166]="UASTC"}(Dd||(Dd={})),function(r){r[r.UNSPECIFIED=0]="UNSPECIFIED",r[r.SRGB=1]="SRGB"}(Rd||(Rd={})),function(r){r[r.UNSPECIFIED=0]="UNSPECIFIED",r[r.LINEAR=1]="LINEAR",r[r.SRGB=2]="SRGB",r[r.ITU=3]="ITU",r[r.NTSC=4]="NTSC",r[r.SLOG=5]="SLOG",r[r.SLOG2=6]="SLOG2"}(Ld||(Ld={})),function(r){r[r.ALPHA_STRAIGHT=0]="ALPHA_STRAIGHT",r[r.ALPHA_PREMULTIPLIED=1]="ALPHA_PREMULTIPLIED"}(Ud||(Ud={})),function(r){r[r.RGB=0]="RGB",r[r.RRR=3]="RRR",r[r.GGG=4]="GGG",r[r.AAA=15]="AAA"}(Od||(Od={})),function(r){r[r.RGB=0]="RGB",r[r.RGBA=3]="RGBA",r[r.RRR=4]="RRR",r[r.RRRG=5]="RRRG"}(kd||(kd={}));const PI=[[Int8Array,5120],[Uint8Array,5121],[Int16Array,5122],[Uint16Array,5123],[Uint32Array,5125],[Float32Array,5126],[Float64Array,5130]];new Map(PI);let Nd;(function(r){r[r.NONE=0]="NONE",r[r.Null=1]="Null",r[r.Int=2]="Int",r[r.Float=3]="Float",r[r.Binary=4]="Binary",r[r.Utf8=5]="Utf8",r[r.Bool=6]="Bool",r[r.Decimal=7]="Decimal",r[r.Date=8]="Date",r[r.Time=9]="Time",r[r.Timestamp=10]="Timestamp",r[r.Interval=11]="Interval",r[r.List=12]="List",r[r.Struct=13]="Struct",r[r.Union=14]="Union",r[r.FixedSizeBinary=15]="FixedSizeBinary",r[r.FixedSizeList=16]="FixedSizeList",r[r.Map=17]="Map",r[r.Dictionary=-1]="Dictionary",r[r.Int8=-2]="Int8",r[r.Int16=-3]="Int16",r[r.Int32=-4]="Int32",r[r.Int64=-5]="Int64",r[r.Uint8=-6]="Uint8",r[r.Uint16=-7]="Uint16",r[r.Uint32=-8]="Uint32",r[r.Uint64=-9]="Uint64",r[r.Float16=-10]="Float16",r[r.Float32=-11]="Float32",r[r.Float64=-12]="Float64",r[r.DateDay=-13]="DateDay",r[r.DateMillisecond=-14]="DateMillisecond",r[r.TimestampSecond=-15]="TimestampSecond",r[r.TimestampMillisecond=-16]="TimestampMillisecond",r[r.TimestampMicrosecond=-17]="TimestampMicrosecond",r[r.TimestampNanosecond=-18]="TimestampNanosecond",r[r.TimeSecond=-19]="TimeSecond",r[r.TimeMillisecond=-20]="TimeMillisecond",r[r.TimeMicrosecond=-21]="TimeMicrosecond",r[r.TimeNanosecond=-22]="TimeNanosecond",r[r.DenseUnion=-23]="DenseUnion",r[r.SparseUnion=-24]="SparseUnion",r[r.IntervalDayTime=-25]="IntervalDayTime",r[r.IntervalYearMonth=-26]="IntervalYearMonth"})(Nd||(Nd={}));const BI={DEFAULT:{}};c.vec3();c.vec3();c.mat4();c.vec3();c.AABB3();c.vec3();c.vec3();c.mat4();c.AABB3();c.vec3();c.vec3();class yI{createRootNode(){return document.createElement("ul")}createNodeElement(e,i,s,t,o){const n=document.createElement("li");if(n.id=e.nodeId,e.xrayed&&n.classList.add("xrayed-node"),e.children.length>0){const l=document.createElement("a");l.href="#",l.id=`switch-${e.nodeId}`,l.textContent="+",l.classList.add("plus"),i&&l.addEventListener("click",i),n.appendChild(l)}const a=document.createElement("input");a.id=`checkbox-${e.nodeId}`,a.type="checkbox",a.checked=e.checked,a.style["pointer-events"]="all",s&&a.addEventListener("change",s),n.appendChild(a);const A=document.createElement("span");return A.textContent=e.title,n.appendChild(A),t&&(A.oncontextmenu=t),o&&(A.onclick=o),n}createDisabledNodeElement(e){const i=document.createElement("li"),s=document.createElement("a");s.href="#",s.textContent="!",s.classList.add("warn"),s.classList.add("warning"),i.appendChild(s);const t=document.createElement("span");return t.textContent=e,i.appendChild(t),i}addChildren(e,i){const s=document.createElement("ul");i.forEach(t=>{s.appendChild(t)}),e.parentElement.appendChild(s)}expand(e,i,s){e.classList.remove("plus"),e.classList.add("minus"),e.textContent="-",e.removeEventListener("click",i),e.addEventListener("click",s)}collapse(e,i,s){if(!e)return;const t=e.parentElement;if(!t)return;const o=t.querySelector("ul");o&&(t.removeChild(o),e.classList.remove("minus"),e.classList.add("plus"),e.textContent="+",e.removeEventListener("click",s),e.addEventListener("click",i))}isExpanded(e){return e.parentElement.getElementsByTagName("li")[0]!==void 0}getId(e){return e.parentElement.id}getIdFromCheckbox(e){return e.id.replace("checkbox-","")}getSwitchElement(e){return document.getElementById(`switch-${e}`)}isChecked(e){return e.checked}setCheckbox(e,i){const s=document.getElementById(`checkbox-${e}`);s&&i!==s.checked&&(s.checked=i)}setXRayed(e,i){const s=document.getElementById(e);s&&(i?s.classList.add("xrayed-node"):s.classList.remove("xrayed-node"))}setHighlighted(e,i){const s=document.getElementById(e);s&&(i?(s.scrollIntoView({block:"center"}),s.classList.add("highlighted-node")):s.classList.remove("highlighted-node"))}}const DA=[];class xI extends Ap{constructor(e,i={}){super("TreeViewPlugin",e),this.errors=[],this.valid=!0;const s=i.containerElement||document.getElementById(i.containerElementId);if(!(s instanceof HTMLElement)){this.error("Mandatory config expected: valid containerElementId or containerElement");return}for(let t=0;;t++)if(!DA[t]){DA[t]=this,this._index=t,this._id=`tree-${t}`;break}if(this._containerElement=s,this._metaModels={},this._autoAddModels=i.autoAddModels!==!1,this._autoExpandDepth=i.autoExpandDepth||0,this._sortNodes=i.sortNodes!==!1,this._viewer=e,this._rootElement=null,this._muteSceneEvents=!1,this._muteTreeEvents=!1,this._rootNodes=[],this._objectNodes={},this._nodeNodes={},this._rootNames={},this._sortNodes=i.sortNodes,this._pruneEmptyNodes=i.pruneEmptyNodes,this._showListItemElementId=null,this._renderService=i.renderService||new yI,!this._renderService)throw new Error("TreeViewPlugin: no render service set");if(this._containerElement.oncontextmenu=t=>{t.preventDefault()},this._onObjectVisibility=this._viewer.scene.on("objectVisibility",t=>{if(this._muteSceneEvents)return;const o=t.id,n=this._objectNodes[o];if(!n)return;const a=t.visible;if(!(a!==n.checked))return;this._muteTreeEvents=!0,n.checked=a,a?n.numVisibleEntities++:n.numVisibleEntities--,this._renderService.setCheckbox(n.nodeId,a);let l=n.parent;for(;l;)l.checked=a,a?l.numVisibleEntities++:l.numVisibleEntities--,this._renderService.setCheckbox(l.nodeId,l.numVisibleEntities>0),l=l.parent;this._muteTreeEvents=!1}),this._onObjectXrayed=this._viewer.scene.on("objectXRayed",t=>{if(this._muteSceneEvents)return;const o=t.id,n=this._objectNodes[o];if(!n)return;this._muteTreeEvents=!0;const a=t.xrayed;a!==n.xrayed&&(n.xrayed=a,this._renderService.setXRayed(n.nodeId,a),this._muteTreeEvents=!1)}),this._switchExpandHandler=t=>{t.preventDefault(),t.stopPropagation();const o=t.target;this._expandSwitchElement(o)},this._switchCollapseHandler=t=>{t.preventDefault(),t.stopPropagation();const o=t.target;this._collapseSwitchElement(o)},this._checkboxChangeHandler=t=>{if(this._muteTreeEvents)return;this._muteSceneEvents=!0;const o=t.target,n=this._renderService.isChecked(o),a=this._renderService.getIdFromCheckbox(o),A=this._nodeNodes[a],l=this._viewer.scene.objects;let h=0;this._withNodeTree(A,f=>{const m=f.objectId,_=l[m],u=f.children.length===0;f.numVisibleEntities=n?f.numEntities:0,u&&n!==f.checked&&h++,f.checked=n,this._renderService.setCheckbox(f.nodeId,n),_&&(_.visible=n)});let d=A.parent;for(;d;)d.checked=n,n?d.numVisibleEntities+=h:d.numVisibleEntities-=h,this._renderService.setCheckbox(d.nodeId,d.numVisibleEntities>0),d=d.parent;this._muteSceneEvents=!1},this._hierarchy=i.hierarchy||"containment",this._autoExpandDepth=i.autoExpandDepth||0,this._autoAddModels){const t=Object.keys(this.viewer.metaScene.metaModels);for(let o=0,n=t.length;o<n;o++){const a=t[o];this.viewer.metaScene.metaModels[a].finalized&&this.addModel(a)}this.viewer.scene.on("modelLoaded",o=>{this.viewer.metaScene.metaModels[o]&&this.addModel(o)})}this.hierarchy=i.hierarchy}set hierarchy(e){e=e||"containment",e!=="containment"&&e!=="storeys"&&e!=="types"&&(this.error("Unsupported value for `hierarchy' - defaulting to 'containment'"),e="containment"),this._hierarchy!==e&&(this._hierarchy=e,this._createNodes())}get hierarchy(){return this._hierarchy}addModel(e,i={}){if(!this._containerElement)return;const s=this.viewer.scene.models[e];if(!s)throw"Model not found: "+e;const t=this.viewer.metaScene.metaModels[e];if(!t){this.error("MetaModel not found: "+e);return}if(this._metaModels[e]){this.warn("Model already added: "+e);return}this._metaModels[e]=t,i&&i.rootName&&(this._rootNames[e]=i.rootName),s.on("destroyed",()=>{this.removeModel(s.id)}),this._createNodes()}removeModel(e){!this._containerElement||!this._metaModels[e]||(this._rootNames[e]&&delete this._rootNames[e],delete this._metaModels[e],this._createNodes())}showNode(e){this.unShowNode();const i=this._objectNodes[e];if(!i)return;const s=i.nodeId,t=this._renderService.getSwitchElement(s);if(t)return this._expandSwitchElement(t),t.scrollIntoView(),!0;const o=[];o.unshift(i);let n=i.parent;for(;n;)o.unshift(n),n=n.parent;for(let a=0,A=o.length;a<A;a++){const l=this._renderService.getSwitchElement(o[a].nodeId);l&&this._expandSwitchElement(l)}this._renderService.setHighlighted(s,!0),this._showListItemElementId=s}unShowNode(){this._showListItemElementId&&(this._renderService.setHighlighted(this._showListItemElementId,!1),this._showListItemElementId=null)}expandToDepth(e){this.collapse();const i=(s,t)=>{if(t===e)return;const o=this._renderService.getSwitchElement(s.nodeId);if(o){this._expandSwitchElement(o);const A=s.children;for(var n=0,a=A.length;n<a;n++){const l=A[n];i(l,t+1)}}};for(let s=0,t=this._rootNodes.length;s<t;s++){const o=this._rootNodes[s];i(o,0)}}collapse(){for(let e=0,i=this._rootNodes.length;e<i;e++){const t=this._rootNodes[e].objectId;this._collapseNode(t)}}withNodeTree(e,i){i(e);const s=e.children;if(s)for(let t=0,o=s.length;t<o;t++)this.withNodeTree(s[t],i)}destroy(){this._containerElement&&(this._metaModels={},this._rootElement&&!this._destroyed&&(this._rootElement.parentNode.removeChild(this._rootElement),this._viewer.scene.off(this._onObjectVisibility),this._destroyed=!0),delete DA[this._index],super.destroy())}_createNodes(){this._rootElement&&(this._rootElement.parentNode.removeChild(this._rootElement),this._rootElement=null),this._rootNodes=[],this._objectNodes={},this._nodeNodes={},this._validate(),this.valid||this._hierarchy!=="storeys"?this._createEnabledNodes():this._createDisabledNodes()}_validate(){switch(this.errors=[],this._hierarchy){case"storeys":this.valid=this._validateMetaModelForStoreysHierarchy();break;case"types":this.valid=this._rootNodes.length>0;break;case"containment":default:this.valid=this._rootNodes.length>0;break}return this.valid}_validateMetaModelForStoreysHierarchy(e=0,i,s){return!0}_createEnabledNodes(){switch(this._pruneEmptyNodes&&this._findEmptyNodes(),this._hierarchy){case"storeys":this._createStoreysNodes(),this._rootNodes.length===0&&this.error("Failed to build storeys hierarchy");break;case"types":this._createTypesNodes();break;case"containment":default:this._createContainmentNodes()}this._sortNodes&&this._doSortNodes(),this._synchNodesToEntities(),this._createTrees(),this.expandToDepth(this._autoExpandDepth)}_createDisabledNodes(){const e=this._renderService.createRootNode();this._rootElement=e,this._containerElement.appendChild(e);const i=this._viewer.metaScene.rootMetaObjects;for(let s in i){const t=i[s],o=t.type,n=t.name,a=n&&n!==""&&n!=="Undefined"&&n!=="Default"?n:o,A=this._renderService.createDisabledNodeElement(a);e.appendChild(A)}}_findEmptyNodes(){const e=this._viewer.metaScene.rootMetaObjects;for(let i in e)this._findEmptyNodes2(e[i])}_findEmptyNodes2(e,i=0){const t=this.viewer.scene,o=e.children,n=e.id,a=t.objects[n];if(e._countEntities=0,a&&e._countEntities++,o)for(let A=0,l=o.length;A<l;A++){const h=o[A];h._countEntities=this._findEmptyNodes2(h),e._countEntities+=h._countEntities}return e._countEntities}_createStoreysNodes(){const e=this._viewer.metaScene.rootMetaObjects;for(let i in e)this._createStoreysNodes2(e[i],null,null,null)}_createStoreysNodes2(e,i,s,t){if(this._pruneEmptyNodes&&e._countEntities===0)return;const o=e.type,n=e.name,a=e.children,A=e.id;if(o==="IfcBuilding")i={nodeId:`${this._id}-${A}`,objectId:A,title:e.metaModels.length===0?"na":this._rootNames[e.metaModels[0].id]||(n&&n!==""&&n!=="Undefined"&&n!=="Default"?n:o),type:o,parent:null,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]},this._rootNodes.push(i),this._objectNodes[i.objectId]=i,this._nodeNodes[i.nodeId]=i;else if(o==="IfcBuildingStorey"){if(!i){this.error("Failed to build storeys hierarchy for model '"+this.metaModel.id+"' - model does not have an IfcBuilding object, or is not an IFC model");return}s={nodeId:`${this._id}-${A}`,objectId:A,title:n&&n!==""&&n!=="Undefined"&&n!=="Default"?n:o,type:o,parent:i,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]},i.children.push(s),this._objectNodes[s.objectId]=s,this._nodeNodes[s.nodeId]=s,t={}}else if(s&&this._viewer.scene.objects[A]){t=t||{};let d=t[o];d||(d={nodeId:`${this._id}-${s.objectId}-${o}`,objectId:`${s.objectId}-${o}`,title:o,type:o,parent:s,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]},s.children.push(d),this._objectNodes[d.objectId]=d,this._nodeNodes[d.nodeId]=d,t[o]=d);const f={nodeId:`${this._id}-${A}`,objectId:A,title:n&&n!==""&&n!=="Undefined"&&n!=="Default"?n:o,type:o,parent:d,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]};d.children.push(f),this._objectNodes[f.objectId]=f,this._nodeNodes[f.nodeId]=f}if(a)for(let l=0,h=a.length;l<h;l++){const d=a[l];this._createStoreysNodes2(d,i,s,t)}}_createTypesNodes(){const e=this._viewer.metaScene.rootMetaObjects;for(let i in e)this._createTypesNodes2(e[i],null,null)}_createTypesNodes2(e,i,s){if(this._pruneEmptyNodes&&e._countEntities===0)return;const t=e.type,o=e.name,n=e.children,a=e.id;if(!e.parent)i={nodeId:`${this._id}-${a}`,objectId:a,title:e.metaModels.length===0?"na":this._rootNames[e.metaModels[0].id]||(o&&o!==""&&o!=="Undefined"&&o!=="Default"?o:t),type:t,parent:null,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]},this._rootNodes.push(i),this._objectNodes[i.objectId]=i,this._nodeNodes[i.nodeId]=i,s={};else if(i&&this._viewer.scene.objects[a]){let h=s[t];h||(h={nodeId:`${this._id}-${i.objectId}-${t}`,objectId:`${i.objectId}-${t}`,title:t,type:t,parent:i,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]},i.children.push(h),this._objectNodes[h.objectId]=h,this._nodeNodes[h.nodeId]=h,s[t]=h);const d={nodeId:`${this._id}-${a}`,objectId:a,title:o&&o!==""&&o!=="Default"?o:t,type:t,parent:h,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]};h.children.push(d),this._objectNodes[d.objectId]=d,this._nodeNodes[d.nodeId]=d}if(n)for(let A=0,l=n.length;A<l;A++){const h=n[A];this._createTypesNodes2(h,i,s)}}_createContainmentNodes(){const e=this._viewer.metaScene.rootMetaObjects;for(let i in e)this._createContainmentNodes2(e[i],null)}_createContainmentNodes2(e,i){if(this._pruneEmptyNodes&&e._countEntities===0)return;const s=e.type,t=e.name||s,o=e.children,n=e.id,a={nodeId:`${this._id}-${n}`,objectId:n,title:i?t&&t!==""&&t!=="Undefined"&&t!=="Default"?t:s:e.metaModels.length===0?"na":this._rootNames[e.metaModels[0].id]||t,type:s,parent:i,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]};if(i?i.children.push(a):this._rootNodes.push(a),this._objectNodes[a.objectId]=a,this._nodeNodes[a.nodeId]=a,o)for(let A=0,l=o.length;A<l;A++){const h=o[A];this._createContainmentNodes2(h,a)}}_doSortNodes(){for(let e=0,i=this._rootNodes.length;e<i;e++){const s=this._rootNodes[e];this._sortChildren(s)}}_sortChildren(e){const i=e.children;if(!(!i||i.length===0)){this._hierarchy==="storeys"&&e.type==="IfcBuilding"?i.sort(this._getSpatialSortFunc()):i.sort(this._alphaSortFunc);for(let s=0,t=i.length;s<t;s++){const o=i[s];this._sortChildren(o)}}}_getSpatialSortFunc(){const e=this.viewer,i=e.scene,s=i.camera,t=e.metaScene;return this._spatialSortFunc||(this._spatialSortFunc=(o,n)=>{(!o.aabb||!n.aabb)&&(o.aabb||(o.aabb=i.getAABB(t.getObjectIDsInSubtree(o.objectId))),n.aabb||(n.aabb=i.getAABB(t.getObjectIDsInSubtree(n.objectId))));let a=0;return s.xUp?a=0:s.yUp?a=1:a=2,o.aabb[a]>n.aabb[a]?-1:o.aabb[a]<n.aabb[a]?1:0})}_alphaSortFunc(e,i){const s=e.title.toUpperCase(),t=i.title.toUpperCase();return s<t?-1:s>t?1:0}_synchNodesToEntities(){const e=Object.keys(this.viewer.metaScene.metaObjects),i=this._viewer.metaScene.metaObjects,s=this._viewer.scene.objects;for(let t=0,o=e.length;t<o;t++){const n=e[t];if(i[n]){const A=this._objectNodes[n];if(A){const l=s[n];if(l){const h=l.visible;A.numEntities=1,A.xrayed=l.xrayed,h?(A.numVisibleEntities=1,A.checked=!0):(A.numVisibleEntities=0,A.checked=!1);let d=A.parent;for(;d;)d.numEntities++,h&&(d.numVisibleEntities++,d.checked=!0),d=d.parent}}}}}_withNodeTree(e,i){i(e);const s=e.children;if(s)for(let t=0,o=s.length;t<o;t++)this._withNodeTree(s[t],i)}_createTrees(){if(this._rootNodes.length===0)return;const e=this._rootNodes.map(s=>this._createNodeElement(s)),i=this._renderService.createRootNode();e.forEach(s=>{i.appendChild(s)}),this._containerElement.appendChild(i),this._rootElement=i}_createNodeElement(e){const i=t=>{this.fire("contextmenu",{event:t,viewer:this._viewer,treeViewPlugin:this,treeViewNode:e}),t.preventDefault()},s=t=>{this.fire("nodeTitleClicked",{event:t,viewer:this._viewer,treeViewPlugin:this,treeViewNode:e}),t.preventDefault()};return this._renderService.createNodeElement(e,this._switchExpandHandler,this._checkboxChangeHandler,i,s)}_expandSwitchElement(e){if(this._renderService.isExpanded(e))return;const s=this._renderService.getId(e),t=this._nodeNodes[s].children.map(o=>this._createNodeElement(o));this._renderService.addChildren(e,t),this._renderService.expand(e,this._switchExpandHandler,this._switchCollapseHandler)}_collapseNode(e){const i=this._renderService.getSwitchElement(e);this._collapseSwitchElement(i)}_collapseSwitchElement(e){this._renderService.collapse(e,this._switchExpandHandler,this._switchCollapseHandler)}}/*! pako 2.1.0 https://github.com/nodeca/pako @license (MIT AND Zlib) */(function(r,e){typeof Pl=="object"&&typeof ra<"u"?e(Pl):typeof define=="function"&&define.amd?define(["exports"],e):e((r=typeof globalThis<"u"?globalThis:r||self).pako={})})(void 0,function(r){function e(p){let b=p.length;for(;--b>=0;)p[b]=0}const i=256,s=286,t=30,o=15,n=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),a=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),A=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),l=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),h=new Array(576);e(h);const d=new Array(60);e(d);const f=new Array(512);e(f);const m=new Array(256);e(m);const _=new Array(29);e(_);const u=new Array(t);function P(p,b,g,T,M){this.static_tree=p,this.extra_bits=b,this.extra_base=g,this.elems=T,this.max_length=M,this.has_stree=p&&p.length}let y,x,B;function v(p,b){this.dyn_tree=p,this.max_code=0,this.stat_desc=b}e(u);const w=p=>p<256?f[p]:f[256+(p>>>7)],C=(p,b)=>{p.pending_buf[p.pending++]=255&b,p.pending_buf[p.pending++]=b>>>8&255},I=(p,b,g)=>{p.bi_valid>16-g?(p.bi_buf|=b<<p.bi_valid&65535,C(p,p.bi_buf),p.bi_buf=b>>16-p.bi_valid,p.bi_valid+=g-16):(p.bi_buf|=b<<p.bi_valid&65535,p.bi_valid+=g)},E=(p,b,g)=>{I(p,g[2*b],g[2*b+1])},S=(p,b)=>{let g=0;do g|=1&p,p>>>=1,g<<=1;while(--b>0);return g>>>1},R=(p,b,g)=>{const T=new Array(16);let M,F,q=0;for(M=1;M<=o;M++)q=q+g[M-1]<<1,T[M]=q;for(F=0;F<=b;F++){let N=p[2*F+1];N!==0&&(p[2*F]=S(T[N]++,N))}},D=p=>{let b;for(b=0;b<s;b++)p.dyn_ltree[2*b]=0;for(b=0;b<t;b++)p.dyn_dtree[2*b]=0;for(b=0;b<19;b++)p.bl_tree[2*b]=0;p.dyn_ltree[512]=1,p.opt_len=p.static_len=0,p.sym_next=p.matches=0},K=p=>{p.bi_valid>8?C(p,p.bi_buf):p.bi_valid>0&&(p.pending_buf[p.pending++]=p.bi_buf),p.bi_buf=0,p.bi_valid=0},G=(p,b,g,T)=>{const M=2*b,F=2*g;return p[M]<p[F]||p[M]===p[F]&&T[b]<=T[g]},z=(p,b,g)=>{const T=p.heap[g];let M=g<<1;for(;M<=p.heap_len&&(M<p.heap_len&&G(b,p.heap[M+1],p.heap[M],p.depth)&&M++,!G(b,T,p.heap[M],p.depth));)p.heap[g]=p.heap[M],g=M,M<<=1;p.heap[g]=T},le=(p,b,g)=>{let T,M,F,q,N=0;if(p.sym_next!==0)do T=255&p.pending_buf[p.sym_buf+N++],T+=(255&p.pending_buf[p.sym_buf+N++])<<8,M=p.pending_buf[p.sym_buf+N++],T===0?E(p,M,b):(F=m[M],E(p,F+i+1,b),q=n[F],q!==0&&(M-=_[F],I(p,M,q)),T--,F=w(T),E(p,F,g),q=a[F],q!==0&&(T-=u[F],I(p,T,q)));while(N<p.sym_next);E(p,256,b)},ue=(p,b)=>{const g=b.dyn_tree,T=b.stat_desc.static_tree,M=b.stat_desc.has_stree,F=b.stat_desc.elems;let q,N,_e,H=-1;for(p.heap_len=0,p.heap_max=573,q=0;q<F;q++)g[2*q]!==0?(p.heap[++p.heap_len]=H=q,p.depth[q]=0):g[2*q+1]=0;for(;p.heap_len<2;)_e=p.heap[++p.heap_len]=H<2?++H:0,g[2*_e]=1,p.depth[_e]=0,p.opt_len--,M&&(p.static_len-=T[2*_e+1]);for(b.max_code=H,q=p.heap_len>>1;q>=1;q--)z(p,g,q);_e=F;do q=p.heap[1],p.heap[1]=p.heap[p.heap_len--],z(p,g,1),N=p.heap[1],p.heap[--p.heap_max]=q,p.heap[--p.heap_max]=N,g[2*_e]=g[2*q]+g[2*N],p.depth[_e]=(p.depth[q]>=p.depth[N]?p.depth[q]:p.depth[N])+1,g[2*q+1]=g[2*N+1]=_e,p.heap[1]=_e++,z(p,g,1);while(p.heap_len>=2);p.heap[--p.heap_max]=p.heap[1],(($,qe)=>{const He=qe.dyn_tree,ve=qe.max_code,St=qe.stat_desc.static_tree,lt=qe.stat_desc.has_stree,Ke=qe.stat_desc.extra_bits,dt=qe.stat_desc.extra_base,Ze=qe.stat_desc.max_length;let we,Xe,pt,Me,At,Je,We=0;for(Me=0;Me<=o;Me++)$.bl_count[Me]=0;for(He[2*$.heap[$.heap_max]+1]=0,we=$.heap_max+1;we<573;we++)Xe=$.heap[we],Me=He[2*He[2*Xe+1]+1]+1,Me>Ze&&(Me=Ze,We++),He[2*Xe+1]=Me,Xe>ve||($.bl_count[Me]++,At=0,Xe>=dt&&(At=Ke[Xe-dt]),Je=He[2*Xe],$.opt_len+=Je*(Me+At),lt&&($.static_len+=Je*(St[2*Xe+1]+At)));if(We!==0){do{for(Me=Ze-1;$.bl_count[Me]===0;)Me--;$.bl_count[Me]--,$.bl_count[Me+1]+=2,$.bl_count[Ze]--,We-=2}while(We>0);for(Me=Ze;Me!==0;Me--)for(Xe=$.bl_count[Me];Xe!==0;)pt=$.heap[--we],pt>ve||(He[2*pt+1]!==Me&&($.opt_len+=(Me-He[2*pt+1])*He[2*pt],He[2*pt+1]=Me),Xe--)}})(p,b),R(g,H,p.bl_count)},ae=(p,b,g)=>{let T,M,F=-1,q=b[1],N=0,_e=7,H=4;for(q===0&&(_e=138,H=3),b[2*(g+1)+1]=65535,T=0;T<=g;T++)M=q,q=b[2*(T+1)+1],++N<_e&&M===q||(N<H?p.bl_tree[2*M]+=N:M!==0?(M!==F&&p.bl_tree[2*M]++,p.bl_tree[32]++):N<=10?p.bl_tree[34]++:p.bl_tree[36]++,N=0,F=M,q===0?(_e=138,H=3):M===q?(_e=6,H=3):(_e=7,H=4))},Pe=(p,b,g)=>{let T,M,F=-1,q=b[1],N=0,_e=7,H=4;for(q===0&&(_e=138,H=3),T=0;T<=g;T++)if(M=q,q=b[2*(T+1)+1],!(++N<_e&&M===q)){if(N<H)do E(p,M,p.bl_tree);while(--N!=0);else M!==0?(M!==F&&(E(p,M,p.bl_tree),N--),E(p,16,p.bl_tree),I(p,N-3,2)):N<=10?(E(p,17,p.bl_tree),I(p,N-3,3)):(E(p,18,p.bl_tree),I(p,N-11,7));N=0,F=M,q===0?(_e=138,H=3):M===q?(_e=6,H=3):(_e=7,H=4)}};let be=!1;const xe=(p,b,g,T)=>{I(p,0+(T?1:0),3),K(p),C(p,g),C(p,~g),g&&p.pending_buf.set(p.window.subarray(b,b+g),p.pending),p.pending+=g};var Ie=(p,b,g,T)=>{let M,F,q=0;p.level>0?(p.strm.data_type===2&&(p.strm.data_type=(N=>{let _e,H=4093624447;for(_e=0;_e<=31;_e++,H>>>=1)if(1&H&&N.dyn_ltree[2*_e]!==0)return 0;if(N.dyn_ltree[18]!==0||N.dyn_ltree[20]!==0||N.dyn_ltree[26]!==0)return 1;for(_e=32;_e<i;_e++)if(N.dyn_ltree[2*_e]!==0)return 1;return 0})(p)),ue(p,p.l_desc),ue(p,p.d_desc),q=(N=>{let _e;for(ae(N,N.dyn_ltree,N.l_desc.max_code),ae(N,N.dyn_dtree,N.d_desc.max_code),ue(N,N.bl_desc),_e=18;_e>=3&&N.bl_tree[2*l[_e]+1]===0;_e--);return N.opt_len+=3*(_e+1)+5+5+4,_e})(p),M=p.opt_len+3+7>>>3,F=p.static_len+3+7>>>3,F<=M&&(M=F)):M=F=g+5,g+4<=M&&b!==-1?xe(p,b,g,T):p.strategy===4||F===M?(I(p,2+(T?1:0),3),le(p,h,d)):(I(p,4+(T?1:0),3),((N,_e,H,$)=>{let qe;for(I(N,_e-257,5),I(N,H-1,5),I(N,$-4,4),qe=0;qe<$;qe++)I(N,N.bl_tree[2*l[qe]+1],3);Pe(N,N.dyn_ltree,_e-1),Pe(N,N.dyn_dtree,H-1)})(p,p.l_desc.max_code+1,p.d_desc.max_code+1,q+1),le(p,p.dyn_ltree,p.dyn_dtree)),D(p),T&&K(p)},Fe={_tr_init:p=>{be||((()=>{let b,g,T,M,F;const q=new Array(16);for(T=0,M=0;M<28;M++)for(_[M]=T,b=0;b<1<<n[M];b++)m[T++]=M;for(m[T-1]=M,F=0,M=0;M<16;M++)for(u[M]=F,b=0;b<1<<a[M];b++)f[F++]=M;for(F>>=7;M<t;M++)for(u[M]=F<<7,b=0;b<1<<a[M]-7;b++)f[256+F++]=M;for(g=0;g<=o;g++)q[g]=0;for(b=0;b<=143;)h[2*b+1]=8,b++,q[8]++;for(;b<=255;)h[2*b+1]=9,b++,q[9]++;for(;b<=279;)h[2*b+1]=7,b++,q[7]++;for(;b<=287;)h[2*b+1]=8,b++,q[8]++;for(R(h,287,q),b=0;b<t;b++)d[2*b+1]=5,d[2*b]=S(b,5);y=new P(h,n,257,s,o),x=new P(d,a,0,t,o),B=new P(new Array(0),A,0,19,7)})(),be=!0),p.l_desc=new v(p.dyn_ltree,y),p.d_desc=new v(p.dyn_dtree,x),p.bl_desc=new v(p.bl_tree,B),p.bi_buf=0,p.bi_valid=0,D(p)},_tr_stored_block:xe,_tr_flush_block:Ie,_tr_tally:(p,b,g)=>(p.pending_buf[p.sym_buf+p.sym_next++]=b,p.pending_buf[p.sym_buf+p.sym_next++]=b>>8,p.pending_buf[p.sym_buf+p.sym_next++]=g,b===0?p.dyn_ltree[2*g]++:(p.matches++,b--,p.dyn_ltree[2*(m[g]+i+1)]++,p.dyn_dtree[2*w(b)]++),p.sym_next===p.sym_end),_tr_align:p=>{I(p,2,3),E(p,256,h),(b=>{b.bi_valid===16?(C(b,b.bi_buf),b.bi_buf=0,b.bi_valid=0):b.bi_valid>=8&&(b.pending_buf[b.pending++]=255&b.bi_buf,b.bi_buf>>=8,b.bi_valid-=8)})(p)}},Qe=(p,b,g,T)=>{let M=65535&p|0,F=p>>>16&65535|0,q=0;for(;g!==0;){q=g>2e3?2e3:g,g-=q;do M=M+b[T++]|0,F=F+M|0;while(--q);M%=65521,F%=65521}return M|F<<16|0};const Ve=new Uint32Array((()=>{let p,b=[];for(var g=0;g<256;g++){p=g;for(var T=0;T<8;T++)p=1&p?3988292384^p>>>1:p>>>1;b[g]=p}return b})());var V=(p,b,g,T)=>{const M=Ve,F=T+g;p^=-1;for(let q=T;q<F;q++)p=p>>>8^M[255&(p^b[q])];return-1^p},Z={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},L={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:Q,_tr_stored_block:O,_tr_flush_block:W,_tr_tally:X,_tr_align:te}=Fe,{Z_NO_FLUSH:se,Z_PARTIAL_FLUSH:ie,Z_FULL_FLUSH:oe,Z_FINISH:he,Z_BLOCK:ce,Z_OK:J,Z_STREAM_END:ee,Z_STREAM_ERROR:ge,Z_DATA_ERROR:re,Z_BUF_ERROR:me,Z_DEFAULT_COMPRESSION:de,Z_FILTERED:Y,Z_HUFFMAN_ONLY:Ue,Z_RLE:pe,Z_FIXED:Te,Z_DEFAULT_STRATEGY:fe,Z_UNKNOWN:je,Z_DEFLATED:Ae}=L,De=258,Ge=262,ne=42,ke=113,ze=666,Ne=(p,b)=>(p.msg=Z[b],b),tt=p=>2*p-(p>4?9:0),$e=p=>{let b=p.length;for(;--b>=0;)p[b]=0},at=p=>{let b,g,T,M=p.w_size;b=p.hash_size,T=b;do g=p.head[--T],p.head[T]=g>=M?g-M:0;while(--b);b=M,T=b;do g=p.prev[--T],p.prev[T]=g>=M?g-M:0;while(--b)};let Ce=(p,b,g)=>(b<<p.hash_shift^g)&p.hash_mask;const ot=p=>{const b=p.state;let g=b.pending;g>p.avail_out&&(g=p.avail_out),g!==0&&(p.output.set(b.pending_buf.subarray(b.pending_out,b.pending_out+g),p.next_out),p.next_out+=g,b.pending_out+=g,p.total_out+=g,p.avail_out-=g,b.pending-=g,b.pending===0&&(b.pending_out=0))},Ye=(p,b)=>{W(p,p.block_start>=0?p.block_start:-1,p.strstart-p.block_start,b),p.block_start=p.strstart,ot(p.strm)},Se=(p,b)=>{p.pending_buf[p.pending++]=b},Be=(p,b)=>{p.pending_buf[p.pending++]=b>>>8&255,p.pending_buf[p.pending++]=255&b},ht=(p,b,g,T)=>{let M=p.avail_in;return M>T&&(M=T),M===0?0:(p.avail_in-=M,b.set(p.input.subarray(p.next_in,p.next_in+M),g),p.state.wrap===1?p.adler=Qe(p.adler,b,M,g):p.state.wrap===2&&(p.adler=V(p.adler,b,M,g)),p.next_in+=M,p.total_in+=M,M)},Mt=(p,b)=>{let g,T,M=p.max_chain_length,F=p.strstart,q=p.prev_length,N=p.nice_match;const _e=p.strstart>p.w_size-Ge?p.strstart-(p.w_size-Ge):0,H=p.window,$=p.w_mask,qe=p.prev,He=p.strstart+De;let ve=H[F+q-1],St=H[F+q];p.prev_length>=p.good_match&&(M>>=2),N>p.lookahead&&(N=p.lookahead);do if(g=b,H[g+q]===St&&H[g+q-1]===ve&&H[g]===H[F]&&H[++g]===H[F+1]){F+=2,g++;do;while(H[++F]===H[++g]&&H[++F]===H[++g]&&H[++F]===H[++g]&&H[++F]===H[++g]&&H[++F]===H[++g]&&H[++F]===H[++g]&&H[++F]===H[++g]&&H[++F]===H[++g]&&F<He);if(T=De-(He-F),F=He-De,T>q){if(p.match_start=b,q=T,T>=N)break;ve=H[F+q-1],St=H[F+q]}}while((b=qe[b&$])>_e&&--M!=0);return q<=p.lookahead?q:p.lookahead},ut=p=>{const b=p.w_size;let g,T,M;do{if(T=p.window_size-p.lookahead-p.strstart,p.strstart>=b+(b-Ge)&&(p.window.set(p.window.subarray(b,b+b-T),0),p.match_start-=b,p.strstart-=b,p.block_start-=b,p.insert>p.strstart&&(p.insert=p.strstart),at(p),T+=b),p.strm.avail_in===0)break;if(g=ht(p.strm,p.window,p.strstart+p.lookahead,T),p.lookahead+=g,p.lookahead+p.insert>=3)for(M=p.strstart-p.insert,p.ins_h=p.window[M],p.ins_h=Ce(p,p.ins_h,p.window[M+1]);p.insert&&(p.ins_h=Ce(p,p.ins_h,p.window[M+3-1]),p.prev[M&p.w_mask]=p.head[p.ins_h],p.head[p.ins_h]=M,M++,p.insert--,!(p.lookahead+p.insert<3)););}while(p.lookahead<Ge&&p.strm.avail_in!==0)},gt=(p,b)=>{let g,T,M,F=p.pending_buf_size-5>p.w_size?p.w_size:p.pending_buf_size-5,q=0,N=p.strm.avail_in;do{if(g=65535,M=p.bi_valid+42>>3,p.strm.avail_out<M||(M=p.strm.avail_out-M,T=p.strstart-p.block_start,g>T+p.strm.avail_in&&(g=T+p.strm.avail_in),g>M&&(g=M),g<F&&(g===0&&b!==he||b===se||g!==T+p.strm.avail_in)))break;q=b===he&&g===T+p.strm.avail_in?1:0,O(p,0,0,q),p.pending_buf[p.pending-4]=g,p.pending_buf[p.pending-3]=g>>8,p.pending_buf[p.pending-2]=~g,p.pending_buf[p.pending-1]=~g>>8,ot(p.strm),T&&(T>g&&(T=g),p.strm.output.set(p.window.subarray(p.block_start,p.block_start+T),p.strm.next_out),p.strm.next_out+=T,p.strm.avail_out-=T,p.strm.total_out+=T,p.block_start+=T,g-=T),g&&(ht(p.strm,p.strm.output,p.strm.next_out,g),p.strm.next_out+=g,p.strm.avail_out-=g,p.strm.total_out+=g)}while(q===0);return N-=p.strm.avail_in,N&&(N>=p.w_size?(p.matches=2,p.window.set(p.strm.input.subarray(p.strm.next_in-p.w_size,p.strm.next_in),0),p.strstart=p.w_size,p.insert=p.strstart):(p.window_size-p.strstart<=N&&(p.strstart-=p.w_size,p.window.set(p.window.subarray(p.w_size,p.w_size+p.strstart),0),p.matches<2&&p.matches++,p.insert>p.strstart&&(p.insert=p.strstart)),p.window.set(p.strm.input.subarray(p.strm.next_in-N,p.strm.next_in),p.strstart),p.strstart+=N,p.insert+=N>p.w_size-p.insert?p.w_size-p.insert:N),p.block_start=p.strstart),p.high_water<p.strstart&&(p.high_water=p.strstart),q?4:b!==se&&b!==he&&p.strm.avail_in===0&&p.strstart===p.block_start?2:(M=p.window_size-p.strstart,p.strm.avail_in>M&&p.block_start>=p.w_size&&(p.block_start-=p.w_size,p.strstart-=p.w_size,p.window.set(p.window.subarray(p.w_size,p.w_size+p.strstart),0),p.matches<2&&p.matches++,M+=p.w_size,p.insert>p.strstart&&(p.insert=p.strstart)),M>p.strm.avail_in&&(M=p.strm.avail_in),M&&(ht(p.strm,p.window,p.strstart,M),p.strstart+=M,p.insert+=M>p.w_size-p.insert?p.w_size-p.insert:M),p.high_water<p.strstart&&(p.high_water=p.strstart),M=p.bi_valid+42>>3,M=p.pending_buf_size-M>65535?65535:p.pending_buf_size-M,F=M>p.w_size?p.w_size:M,T=p.strstart-p.block_start,(T>=F||(T||b===he)&&b!==se&&p.strm.avail_in===0&&T<=M)&&(g=T>M?M:T,q=b===he&&p.strm.avail_in===0&&g===T?1:0,O(p,p.block_start,g,q),p.block_start+=g,ot(p.strm)),q?3:1)},Ot=(p,b)=>{let g,T;for(;;){if(p.lookahead<Ge){if(ut(p),p.lookahead<Ge&&b===se)return 1;if(p.lookahead===0)break}if(g=0,p.lookahead>=3&&(p.ins_h=Ce(p,p.ins_h,p.window[p.strstart+3-1]),g=p.prev[p.strstart&p.w_mask]=p.head[p.ins_h],p.head[p.ins_h]=p.strstart),g!==0&&p.strstart-g<=p.w_size-Ge&&(p.match_length=Mt(p,g)),p.match_length>=3)if(T=X(p,p.strstart-p.match_start,p.match_length-3),p.lookahead-=p.match_length,p.match_length<=p.max_lazy_match&&p.lookahead>=3){p.match_length--;do p.strstart++,p.ins_h=Ce(p,p.ins_h,p.window[p.strstart+3-1]),g=p.prev[p.strstart&p.w_mask]=p.head[p.ins_h],p.head[p.ins_h]=p.strstart;while(--p.match_length!=0);p.strstart++}else p.strstart+=p.match_length,p.match_length=0,p.ins_h=p.window[p.strstart],p.ins_h=Ce(p,p.ins_h,p.window[p.strstart+1]);else T=X(p,0,p.window[p.strstart]),p.lookahead--,p.strstart++;if(T&&(Ye(p,!1),p.strm.avail_out===0))return 1}return p.insert=p.strstart<2?p.strstart:2,b===he?(Ye(p,!0),p.strm.avail_out===0?3:4):p.sym_next&&(Ye(p,!1),p.strm.avail_out===0)?1:2},xi=(p,b)=>{let g,T,M;for(;;){if(p.lookahead<Ge){if(ut(p),p.lookahead<Ge&&b===se)return 1;if(p.lookahead===0)break}if(g=0,p.lookahead>=3&&(p.ins_h=Ce(p,p.ins_h,p.window[p.strstart+3-1]),g=p.prev[p.strstart&p.w_mask]=p.head[p.ins_h],p.head[p.ins_h]=p.strstart),p.prev_length=p.match_length,p.prev_match=p.match_start,p.match_length=2,g!==0&&p.prev_length<p.max_lazy_match&&p.strstart-g<=p.w_size-Ge&&(p.match_length=Mt(p,g),p.match_length<=5&&(p.strategy===Y||p.match_length===3&&p.strstart-p.match_start>4096)&&(p.match_length=2)),p.prev_length>=3&&p.match_length<=p.prev_length){M=p.strstart+p.lookahead-3,T=X(p,p.strstart-1-p.prev_match,p.prev_length-3),p.lookahead-=p.prev_length-1,p.prev_length-=2;do++p.strstart<=M&&(p.ins_h=Ce(p,p.ins_h,p.window[p.strstart+3-1]),g=p.prev[p.strstart&p.w_mask]=p.head[p.ins_h],p.head[p.ins_h]=p.strstart);while(--p.prev_length!=0);if(p.match_available=0,p.match_length=2,p.strstart++,T&&(Ye(p,!1),p.strm.avail_out===0))return 1}else if(p.match_available){if(T=X(p,0,p.window[p.strstart-1]),T&&Ye(p,!1),p.strstart++,p.lookahead--,p.strm.avail_out===0)return 1}else p.match_available=1,p.strstart++,p.lookahead--}return p.match_available&&(T=X(p,0,p.window[p.strstart-1]),p.match_available=0),p.insert=p.strstart<2?p.strstart:2,b===he?(Ye(p,!0),p.strm.avail_out===0?3:4):p.sym_next&&(Ye(p,!1),p.strm.avail_out===0)?1:2};function Bt(p,b,g,T,M){this.good_length=p,this.max_lazy=b,this.nice_length=g,this.max_chain=T,this.func=M}const fr=[new Bt(0,0,0,0,gt),new Bt(4,4,8,4,Ot),new Bt(4,5,16,8,Ot),new Bt(4,6,32,32,Ot),new Bt(4,4,16,16,xi),new Bt(8,16,32,32,xi),new Bt(8,16,128,128,xi),new Bt(8,32,128,256,xi),new Bt(32,128,258,1024,xi),new Bt(32,258,258,4096,xi)];function zf(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=Ae,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(1146),this.dyn_dtree=new Uint16Array(122),this.bl_tree=new Uint16Array(78),$e(this.dyn_ltree),$e(this.dyn_dtree),$e(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(16),this.heap=new Uint16Array(573),$e(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(573),$e(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const gr=p=>{if(!p)return 1;const b=p.state;return!b||b.strm!==p||b.status!==ne&&b.status!==57&&b.status!==69&&b.status!==73&&b.status!==91&&b.status!==103&&b.status!==ke&&b.status!==ze?1:0},Ml=p=>{if(gr(p))return Ne(p,ge);p.total_in=p.total_out=0,p.data_type=je;const b=p.state;return b.pending=0,b.pending_out=0,b.wrap<0&&(b.wrap=-b.wrap),b.status=b.wrap===2?57:b.wrap?ne:ke,p.adler=b.wrap===2?0:1,b.last_flush=-2,Q(b),J},Sl=p=>{const b=Ml(p);var g;return b===J&&((g=p.state).window_size=2*g.w_size,$e(g.head),g.max_lazy_match=fr[g.level].max_lazy,g.good_match=fr[g.level].good_length,g.nice_match=fr[g.level].nice_length,g.max_chain_length=fr[g.level].max_chain,g.strstart=0,g.block_start=0,g.lookahead=0,g.insert=0,g.match_length=g.prev_length=2,g.match_available=0,g.ins_h=0),b},Tl=(p,b,g,T,M,F)=>{if(!p)return ge;let q=1;if(b===de&&(b=6),T<0?(q=0,T=-T):T>15&&(q=2,T-=16),M<1||M>9||g!==Ae||T<8||T>15||b<0||b>9||F<0||F>Te||T===8&&q!==1)return Ne(p,ge);T===8&&(T=9);const N=new zf;return p.state=N,N.strm=p,N.status=ne,N.wrap=q,N.gzhead=null,N.w_bits=T,N.w_size=1<<N.w_bits,N.w_mask=N.w_size-1,N.hash_bits=M+7,N.hash_size=1<<N.hash_bits,N.hash_mask=N.hash_size-1,N.hash_shift=~~((N.hash_bits+3-1)/3),N.window=new Uint8Array(2*N.w_size),N.head=new Uint16Array(N.hash_size),N.prev=new Uint16Array(N.w_size),N.lit_bufsize=1<<M+6,N.pending_buf_size=4*N.lit_bufsize,N.pending_buf=new Uint8Array(N.pending_buf_size),N.sym_buf=N.lit_bufsize,N.sym_end=3*(N.lit_bufsize-1),N.level=b,N.strategy=F,N.method=g,Sl(p)};var mr={deflateInit:(p,b)=>Tl(p,b,Ae,15,8,fe),deflateInit2:Tl,deflateReset:Sl,deflateResetKeep:Ml,deflateSetHeader:(p,b)=>gr(p)||p.state.wrap!==2?ge:(p.state.gzhead=b,J),deflate:(p,b)=>{if(gr(p)||b>ce||b<0)return p?Ne(p,ge):ge;const g=p.state;if(!p.output||p.avail_in!==0&&!p.input||g.status===ze&&b!==he)return Ne(p,p.avail_out===0?me:ge);const T=g.last_flush;if(g.last_flush=b,g.pending!==0){if(ot(p),p.avail_out===0)return g.last_flush=-1,J}else if(p.avail_in===0&&tt(b)<=tt(T)&&b!==he)return Ne(p,me);if(g.status===ze&&p.avail_in!==0)return Ne(p,me);if(g.status===ne&&g.wrap===0&&(g.status=ke),g.status===ne){let M=Ae+(g.w_bits-8<<4)<<8,F=-1;if(F=g.strategy>=Ue||g.level<2?0:g.level<6?1:g.level===6?2:3,M|=F<<6,g.strstart!==0&&(M|=32),M+=31-M%31,Be(g,M),g.strstart!==0&&(Be(g,p.adler>>>16),Be(g,65535&p.adler)),p.adler=1,g.status=ke,ot(p),g.pending!==0)return g.last_flush=-1,J}if(g.status===57){if(p.adler=0,Se(g,31),Se(g,139),Se(g,8),g.gzhead)Se(g,(g.gzhead.text?1:0)+(g.gzhead.hcrc?2:0)+(g.gzhead.extra?4:0)+(g.gzhead.name?8:0)+(g.gzhead.comment?16:0)),Se(g,255&g.gzhead.time),Se(g,g.gzhead.time>>8&255),Se(g,g.gzhead.time>>16&255),Se(g,g.gzhead.time>>24&255),Se(g,g.level===9?2:g.strategy>=Ue||g.level<2?4:0),Se(g,255&g.gzhead.os),g.gzhead.extra&&g.gzhead.extra.length&&(Se(g,255&g.gzhead.extra.length),Se(g,g.gzhead.extra.length>>8&255)),g.gzhead.hcrc&&(p.adler=V(p.adler,g.pending_buf,g.pending,0)),g.gzindex=0,g.status=69;else if(Se(g,0),Se(g,0),Se(g,0),Se(g,0),Se(g,0),Se(g,g.level===9?2:g.strategy>=Ue||g.level<2?4:0),Se(g,3),g.status=ke,ot(p),g.pending!==0)return g.last_flush=-1,J}if(g.status===69){if(g.gzhead.extra){let M=g.pending,F=(65535&g.gzhead.extra.length)-g.gzindex;for(;g.pending+F>g.pending_buf_size;){let N=g.pending_buf_size-g.pending;if(g.pending_buf.set(g.gzhead.extra.subarray(g.gzindex,g.gzindex+N),g.pending),g.pending=g.pending_buf_size,g.gzhead.hcrc&&g.pending>M&&(p.adler=V(p.adler,g.pending_buf,g.pending-M,M)),g.gzindex+=N,ot(p),g.pending!==0)return g.last_flush=-1,J;M=0,F-=N}let q=new Uint8Array(g.gzhead.extra);g.pending_buf.set(q.subarray(g.gzindex,g.gzindex+F),g.pending),g.pending+=F,g.gzhead.hcrc&&g.pending>M&&(p.adler=V(p.adler,g.pending_buf,g.pending-M,M)),g.gzindex=0}g.status=73}if(g.status===73){if(g.gzhead.name){let M,F=g.pending;do{if(g.pending===g.pending_buf_size){if(g.gzhead.hcrc&&g.pending>F&&(p.adler=V(p.adler,g.pending_buf,g.pending-F,F)),ot(p),g.pending!==0)return g.last_flush=-1,J;F=0}M=g.gzindex<g.gzhead.name.length?255&g.gzhead.name.charCodeAt(g.gzindex++):0,Se(g,M)}while(M!==0);g.gzhead.hcrc&&g.pending>F&&(p.adler=V(p.adler,g.pending_buf,g.pending-F,F)),g.gzindex=0}g.status=91}if(g.status===91){if(g.gzhead.comment){let M,F=g.pending;do{if(g.pending===g.pending_buf_size){if(g.gzhead.hcrc&&g.pending>F&&(p.adler=V(p.adler,g.pending_buf,g.pending-F,F)),ot(p),g.pending!==0)return g.last_flush=-1,J;F=0}M=g.gzindex<g.gzhead.comment.length?255&g.gzhead.comment.charCodeAt(g.gzindex++):0,Se(g,M)}while(M!==0);g.gzhead.hcrc&&g.pending>F&&(p.adler=V(p.adler,g.pending_buf,g.pending-F,F))}g.status=103}if(g.status===103){if(g.gzhead.hcrc){if(g.pending+2>g.pending_buf_size&&(ot(p),g.pending!==0))return g.last_flush=-1,J;Se(g,255&p.adler),Se(g,p.adler>>8&255),p.adler=0}if(g.status=ke,ot(p),g.pending!==0)return g.last_flush=-1,J}if(p.avail_in!==0||g.lookahead!==0||b!==se&&g.status!==ze){let M=g.level===0?gt(g,b):g.strategy===Ue?((F,q)=>{let N;for(;;){if(F.lookahead===0&&(ut(F),F.lookahead===0)){if(q===se)return 1;break}if(F.match_length=0,N=X(F,0,F.window[F.strstart]),F.lookahead--,F.strstart++,N&&(Ye(F,!1),F.strm.avail_out===0))return 1}return F.insert=0,q===he?(Ye(F,!0),F.strm.avail_out===0?3:4):F.sym_next&&(Ye(F,!1),F.strm.avail_out===0)?1:2})(g,b):g.strategy===pe?((F,q)=>{let N,_e,H,$;const qe=F.window;for(;;){if(F.lookahead<=De){if(ut(F),F.lookahead<=De&&q===se)return 1;if(F.lookahead===0)break}if(F.match_length=0,F.lookahead>=3&&F.strstart>0&&(H=F.strstart-1,_e=qe[H],_e===qe[++H]&&_e===qe[++H]&&_e===qe[++H])){$=F.strstart+De;do;while(_e===qe[++H]&&_e===qe[++H]&&_e===qe[++H]&&_e===qe[++H]&&_e===qe[++H]&&_e===qe[++H]&&_e===qe[++H]&&_e===qe[++H]&&H<$);F.match_length=De-($-H),F.match_length>F.lookahead&&(F.match_length=F.lookahead)}if(F.match_length>=3?(N=X(F,1,F.match_length-3),F.lookahead-=F.match_length,F.strstart+=F.match_length,F.match_length=0):(N=X(F,0,F.window[F.strstart]),F.lookahead--,F.strstart++),N&&(Ye(F,!1),F.strm.avail_out===0))return 1}return F.insert=0,q===he?(Ye(F,!0),F.strm.avail_out===0?3:4):F.sym_next&&(Ye(F,!1),F.strm.avail_out===0)?1:2})(g,b):fr[g.level].func(g,b);if(M!==3&&M!==4||(g.status=ze),M===1||M===3)return p.avail_out===0&&(g.last_flush=-1),J;if(M===2&&(b===ie?te(g):b!==ce&&(O(g,0,0,!1),b===oe&&($e(g.head),g.lookahead===0&&(g.strstart=0,g.block_start=0,g.insert=0))),ot(p),p.avail_out===0))return g.last_flush=-1,J}return b!==he?J:g.wrap<=0?ee:(g.wrap===2?(Se(g,255&p.adler),Se(g,p.adler>>8&255),Se(g,p.adler>>16&255),Se(g,p.adler>>24&255),Se(g,255&p.total_in),Se(g,p.total_in>>8&255),Se(g,p.total_in>>16&255),Se(g,p.total_in>>24&255)):(Be(g,p.adler>>>16),Be(g,65535&p.adler)),ot(p),g.wrap>0&&(g.wrap=-g.wrap),g.pending!==0?J:ee)},deflateEnd:p=>{if(gr(p))return ge;const b=p.state.status;return p.state=null,b===ke?Ne(p,re):J},deflateSetDictionary:(p,b)=>{let g=b.length;if(gr(p))return ge;const T=p.state,M=T.wrap;if(M===2||M===1&&T.status!==ne||T.lookahead)return ge;if(M===1&&(p.adler=Qe(p.adler,b,g,0)),T.wrap=0,g>=T.w_size){M===0&&($e(T.head),T.strstart=0,T.block_start=0,T.insert=0);let _e=new Uint8Array(T.w_size);_e.set(b.subarray(g-T.w_size,g),0),b=_e,g=T.w_size}const F=p.avail_in,q=p.next_in,N=p.input;for(p.avail_in=g,p.next_in=0,p.input=b,ut(T);T.lookahead>=3;){let _e=T.strstart,H=T.lookahead-2;do T.ins_h=Ce(T,T.ins_h,T.window[_e+3-1]),T.prev[_e&T.w_mask]=T.head[T.ins_h],T.head[T.ins_h]=_e,_e++;while(--H);T.strstart=_e,T.lookahead=2,ut(T)}return T.strstart+=T.lookahead,T.block_start=T.strstart,T.insert=T.lookahead,T.lookahead=0,T.match_length=T.prev_length=2,T.match_available=0,p.next_in=q,p.input=N,p.avail_in=F,T.wrap=M,J},deflateInfo:"pako deflate (from Nodeca project)"};const Kf=(p,b)=>Object.prototype.hasOwnProperty.call(p,b);var Dl=function(p){const b=Array.prototype.slice.call(arguments,1);for(;b.length;){const g=b.shift();if(g){if(typeof g!="object")throw new TypeError(g+"must be non-object");for(const T in g)Kf(g,T)&&(p[T]=g[T])}}return p},Rl=p=>{let b=0;for(let T=0,M=p.length;T<M;T++)b+=p[T].length;const g=new Uint8Array(b);for(let T=0,M=0,F=p.length;T<F;T++){let q=p[T];g.set(q,M),M+=q.length}return g};let Ll=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{Ll=!1}const _r=new Uint8Array(256);for(let p=0;p<256;p++)_r[p]=p>=252?6:p>=248?5:p>=240?4:p>=224?3:p>=192?2:1;_r[254]=_r[254]=1;var oa=p=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(p);let b,g,T,M,F,q=p.length,N=0;for(M=0;M<q;M++)g=p.charCodeAt(M),(64512&g)==55296&&M+1<q&&(T=p.charCodeAt(M+1),(64512&T)==56320&&(g=65536+(g-55296<<10)+(T-56320),M++)),N+=g<128?1:g<2048?2:g<65536?3:4;for(b=new Uint8Array(N),F=0,M=0;F<N;M++)g=p.charCodeAt(M),(64512&g)==55296&&M+1<q&&(T=p.charCodeAt(M+1),(64512&T)==56320&&(g=65536+(g-55296<<10)+(T-56320),M++)),g<128?b[F++]=g:g<2048?(b[F++]=192|g>>>6,b[F++]=128|63&g):g<65536?(b[F++]=224|g>>>12,b[F++]=128|g>>>6&63,b[F++]=128|63&g):(b[F++]=240|g>>>18,b[F++]=128|g>>>12&63,b[F++]=128|g>>>6&63,b[F++]=128|63&g);return b},Wf=(p,b)=>{const g=b||p.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(p.subarray(0,b));let T,M;const F=new Array(2*g);for(M=0,T=0;T<g;){let q=p[T++];if(q<128){F[M++]=q;continue}let N=_r[q];if(N>4)F[M++]=65533,T+=N-1;else{for(q&=N===2?31:N===3?15:7;N>1&&T<g;)q=q<<6|63&p[T++],N--;N>1?F[M++]=65533:q<65536?F[M++]=q:(q-=65536,F[M++]=55296|q>>10&1023,F[M++]=56320|1023&q)}}return((q,N)=>{if(N<65534&&q.subarray&&Ll)return String.fromCharCode.apply(null,q.length===N?q:q.subarray(0,N));let _e="";for(let H=0;H<N;H++)_e+=String.fromCharCode(q[H]);return _e})(F,M)},Xf=(p,b)=>{(b=b||p.length)>p.length&&(b=p.length);let g=b-1;for(;g>=0&&(192&p[g])==128;)g--;return g<0||g===0?b:g+_r[p[g]]>b?g:b},Ul=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const Ol=Object.prototype.toString,{Z_NO_FLUSH:Yf,Z_SYNC_FLUSH:$f,Z_FULL_FLUSH:Zf,Z_FINISH:qf,Z_OK:go,Z_STREAM_END:Jf,Z_DEFAULT_COMPRESSION:eg,Z_DEFAULT_STRATEGY:tg,Z_DEFLATED:ig}=L;function vr(p){this.options=Dl({level:eg,method:ig,chunkSize:16384,windowBits:15,memLevel:8,strategy:tg},p||{});let b=this.options;b.raw&&b.windowBits>0?b.windowBits=-b.windowBits:b.gzip&&b.windowBits>0&&b.windowBits<16&&(b.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Ul,this.strm.avail_out=0;let g=mr.deflateInit2(this.strm,b.level,b.method,b.windowBits,b.memLevel,b.strategy);if(g!==go)throw new Error(Z[g]);if(b.header&&mr.deflateSetHeader(this.strm,b.header),b.dictionary){let T;if(T=typeof b.dictionary=="string"?oa(b.dictionary):Ol.call(b.dictionary)==="[object ArrayBuffer]"?new Uint8Array(b.dictionary):b.dictionary,g=mr.deflateSetDictionary(this.strm,T),g!==go)throw new Error(Z[g]);this._dict_set=!0}}function na(p,b){const g=new vr(b);if(g.push(p,!0),g.err)throw g.msg||Z[g.err];return g.result}vr.prototype.push=function(p,b){const g=this.strm,T=this.options.chunkSize;let M,F;if(this.ended)return!1;for(F=b===~~b?b:b===!0?qf:Yf,typeof p=="string"?g.input=oa(p):Ol.call(p)==="[object ArrayBuffer]"?g.input=new Uint8Array(p):g.input=p,g.next_in=0,g.avail_in=g.input.length;;)if(g.avail_out===0&&(g.output=new Uint8Array(T),g.next_out=0,g.avail_out=T),(F===$f||F===Zf)&&g.avail_out<=6)this.onData(g.output.subarray(0,g.next_out)),g.avail_out=0;else{if(M=mr.deflate(g,F),M===Jf)return g.next_out>0&&this.onData(g.output.subarray(0,g.next_out)),M=mr.deflateEnd(this.strm),this.onEnd(M),this.ended=!0,M===go;if(g.avail_out!==0){if(F>0&&g.next_out>0)this.onData(g.output.subarray(0,g.next_out)),g.avail_out=0;else if(g.avail_in===0)break}else this.onData(g.output)}return!0},vr.prototype.onData=function(p){this.chunks.push(p)},vr.prototype.onEnd=function(p){p===go&&(this.result=Rl(this.chunks)),this.chunks=[],this.err=p,this.msg=this.strm.msg};var sg={Deflate:vr,deflate:na,deflateRaw:function(p,b){return(b=b||{}).raw=!0,na(p,b)},gzip:function(p,b){return(b=b||{}).gzip=!0,na(p,b)},constants:L};const mo=16209;var rg=function(p,b){let g,T,M,F,q,N,_e,H,$,qe,He,ve,St,lt,Ke,dt,Ze,we,Xe,pt,Me,At,Je,We;const rt=p.state;g=p.next_in,Je=p.input,T=g+(p.avail_in-5),M=p.next_out,We=p.output,F=M-(b-p.avail_out),q=M+(p.avail_out-257),N=rt.dmax,_e=rt.wsize,H=rt.whave,$=rt.wnext,qe=rt.window,He=rt.hold,ve=rt.bits,St=rt.lencode,lt=rt.distcode,Ke=(1<<rt.lenbits)-1,dt=(1<<rt.distbits)-1;e:do{ve<15&&(He+=Je[g++]<<ve,ve+=8,He+=Je[g++]<<ve,ve+=8),Ze=St[He&Ke];t:for(;;){if(we=Ze>>>24,He>>>=we,ve-=we,we=Ze>>>16&255,we===0)We[M++]=65535&Ze;else{if(!(16&we)){if(!(64&we)){Ze=St[(65535&Ze)+(He&(1<<we)-1)];continue t}if(32&we){rt.mode=16191;break e}p.msg="invalid literal/length code",rt.mode=mo;break e}Xe=65535&Ze,we&=15,we&&(ve<we&&(He+=Je[g++]<<ve,ve+=8),Xe+=He&(1<<we)-1,He>>>=we,ve-=we),ve<15&&(He+=Je[g++]<<ve,ve+=8,He+=Je[g++]<<ve,ve+=8),Ze=lt[He&dt];i:for(;;){if(we=Ze>>>24,He>>>=we,ve-=we,we=Ze>>>16&255,!(16&we)){if(!(64&we)){Ze=lt[(65535&Ze)+(He&(1<<we)-1)];continue i}p.msg="invalid distance code",rt.mode=mo;break e}if(pt=65535&Ze,we&=15,ve<we&&(He+=Je[g++]<<ve,ve+=8,ve<we&&(He+=Je[g++]<<ve,ve+=8)),pt+=He&(1<<we)-1,pt>N){p.msg="invalid distance too far back",rt.mode=mo;break e}if(He>>>=we,ve-=we,we=M-F,pt>we){if(we=pt-we,we>H&&rt.sane){p.msg="invalid distance too far back",rt.mode=mo;break e}if(Me=0,At=qe,$===0){if(Me+=_e-we,we<Xe){Xe-=we;do We[M++]=qe[Me++];while(--we);Me=M-pt,At=We}}else if($<we){if(Me+=_e+$-we,we-=$,we<Xe){Xe-=we;do We[M++]=qe[Me++];while(--we);if(Me=0,$<Xe){we=$,Xe-=we;do We[M++]=qe[Me++];while(--we);Me=M-pt,At=We}}}else if(Me+=$-we,we<Xe){Xe-=we;do We[M++]=qe[Me++];while(--we);Me=M-pt,At=We}for(;Xe>2;)We[M++]=At[Me++],We[M++]=At[Me++],We[M++]=At[Me++],Xe-=3;Xe&&(We[M++]=At[Me++],Xe>1&&(We[M++]=At[Me++]))}else{Me=M-pt;do We[M++]=We[Me++],We[M++]=We[Me++],We[M++]=We[Me++],Xe-=3;while(Xe>2);Xe&&(We[M++]=We[Me++],Xe>1&&(We[M++]=We[Me++]))}break}}break}}while(g<T&&M<q);Xe=ve>>3,g-=Xe,ve-=Xe<<3,He&=(1<<ve)-1,p.next_in=g,p.next_out=M,p.avail_in=g<T?T-g+5:5-(g-T),p.avail_out=M<q?q-M+257:257-(M-q),rt.hold=He,rt.bits=ve};const _o=15,og=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),ng=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),ag=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),Ag=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var Pr=(p,b,g,T,M,F,q,N)=>{const _e=N.bits;let H,$,qe,He,ve,St,lt=0,Ke=0,dt=0,Ze=0,we=0,Xe=0,pt=0,Me=0,At=0,Je=0,We=null;const rt=new Uint16Array(16),ei=new Uint16Array(16);let xr,wo,bo,Co=null;for(lt=0;lt<=_o;lt++)rt[lt]=0;for(Ke=0;Ke<T;Ke++)rt[b[g+Ke]]++;for(we=_e,Ze=_o;Ze>=1&&rt[Ze]===0;Ze--);if(we>Ze&&(we=Ze),Ze===0)return M[F++]=20971520,M[F++]=20971520,N.bits=1,0;for(dt=1;dt<Ze&&rt[dt]===0;dt++);for(we<dt&&(we=dt),Me=1,lt=1;lt<=_o;lt++)if(Me<<=1,Me-=rt[lt],Me<0)return-1;if(Me>0&&(p===0||Ze!==1))return-1;for(ei[1]=0,lt=1;lt<_o;lt++)ei[lt+1]=ei[lt]+rt[lt];for(Ke=0;Ke<T;Ke++)b[g+Ke]!==0&&(q[ei[b[g+Ke]]++]=Ke);if(p===0?(We=Co=q,St=20):p===1?(We=og,Co=ng,St=257):(We=ag,Co=Ag,St=0),Je=0,Ke=0,lt=dt,ve=F,Xe=we,pt=0,qe=-1,At=1<<we,He=At-1,p===1&&At>852||p===2&&At>592)return 1;for(;;){xr=lt-pt,q[Ke]+1<St?(wo=0,bo=q[Ke]):q[Ke]>=St?(wo=Co[q[Ke]-St],bo=We[q[Ke]-St]):(wo=96,bo=0),H=1<<lt-pt,$=1<<Xe,dt=$;do $-=H,M[ve+(Je>>pt)+$]=xr<<24|wo<<16|bo|0;while($!==0);for(H=1<<lt-1;Je&H;)H>>=1;if(H!==0?(Je&=H-1,Je+=H):Je=0,Ke++,--rt[lt]==0){if(lt===Ze)break;lt=b[g+q[Ke]]}if(lt>we&&(Je&He)!==qe){for(pt===0&&(pt=we),ve+=dt,Xe=lt-pt,Me=1<<Xe;Xe+pt<Ze&&(Me-=rt[Xe+pt],!(Me<=0));)Xe++,Me<<=1;if(At+=1<<Xe,p===1&&At>852||p===2&&At>592)return 1;qe=Je&He,M[qe]=we<<24|Xe<<16|ve-F|0}}return Je!==0&&(M[ve+Je]=lt-pt<<24|64<<16|0),N.bits=we,0};const{Z_FINISH:kl,Z_BLOCK:lg,Z_TREES:vo,Z_OK:ds,Z_STREAM_END:cg,Z_NEED_DICT:hg,Z_STREAM_ERROR:pi,Z_DATA_ERROR:Nl,Z_MEM_ERROR:Ql,Z_BUF_ERROR:ug,Z_DEFLATED:Hl}=L,Po=16180,Bo=16190,Ni=16191,aa=16192,Aa=16194,yo=16199,xo=16200,la=16206,wt=16209,Vl=p=>(p>>>24&255)+(p>>>8&65280)+((65280&p)<<8)+((255&p)<<24);function dg(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const ps=p=>{if(!p)return 1;const b=p.state;return!b||b.strm!==p||b.mode<Po||b.mode>16211?1:0},jl=p=>{if(ps(p))return pi;const b=p.state;return p.total_in=p.total_out=b.total=0,p.msg="",b.wrap&&(p.adler=1&b.wrap),b.mode=Po,b.last=0,b.havedict=0,b.flags=-1,b.dmax=32768,b.head=null,b.hold=0,b.bits=0,b.lencode=b.lendyn=new Int32Array(852),b.distcode=b.distdyn=new Int32Array(592),b.sane=1,b.back=-1,ds},Gl=p=>{if(ps(p))return pi;const b=p.state;return b.wsize=0,b.whave=0,b.wnext=0,jl(p)},zl=(p,b)=>{let g;if(ps(p))return pi;const T=p.state;return b<0?(g=0,b=-b):(g=5+(b>>4),b<48&&(b&=15)),b&&(b<8||b>15)?pi:(T.window!==null&&T.wbits!==b&&(T.window=null),T.wrap=g,T.wbits=b,Gl(p))},Kl=(p,b)=>{if(!p)return pi;const g=new dg;p.state=g,g.strm=p,g.window=null,g.mode=Po;const T=zl(p,b);return T!==ds&&(p.state=null),T};let ca,ha,Wl=!0;const pg=p=>{if(Wl){ca=new Int32Array(512),ha=new Int32Array(32);let b=0;for(;b<144;)p.lens[b++]=8;for(;b<256;)p.lens[b++]=9;for(;b<280;)p.lens[b++]=7;for(;b<288;)p.lens[b++]=8;for(Pr(1,p.lens,0,288,ca,0,p.work,{bits:9}),b=0;b<32;)p.lens[b++]=5;Pr(2,p.lens,0,32,ha,0,p.work,{bits:5}),Wl=!1}p.lencode=ca,p.lenbits=9,p.distcode=ha,p.distbits=5},Xl=(p,b,g,T)=>{let M;const F=p.state;return F.window===null&&(F.wsize=1<<F.wbits,F.wnext=0,F.whave=0,F.window=new Uint8Array(F.wsize)),T>=F.wsize?(F.window.set(b.subarray(g-F.wsize,g),0),F.wnext=0,F.whave=F.wsize):(M=F.wsize-F.wnext,M>T&&(M=T),F.window.set(b.subarray(g-T,g-T+M),F.wnext),(T-=M)?(F.window.set(b.subarray(g-T,g),0),F.wnext=T,F.whave=F.wsize):(F.wnext+=M,F.wnext===F.wsize&&(F.wnext=0),F.whave<F.wsize&&(F.whave+=M))),0};var Qi={inflateReset:Gl,inflateReset2:zl,inflateResetKeep:jl,inflateInit:p=>Kl(p,15),inflateInit2:Kl,inflate:(p,b)=>{let g,T,M,F,q,N,_e,H,$,qe,He,ve,St,lt,Ke,dt,Ze,we,Xe,pt,Me,At,Je=0;const We=new Uint8Array(4);let rt,ei;const xr=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(ps(p)||!p.output||!p.input&&p.avail_in!==0)return pi;g=p.state,g.mode===Ni&&(g.mode=aa),q=p.next_out,M=p.output,_e=p.avail_out,F=p.next_in,T=p.input,N=p.avail_in,H=g.hold,$=g.bits,qe=N,He=_e,At=ds;e:for(;;)switch(g.mode){case Po:if(g.wrap===0){g.mode=aa;break}for(;$<16;){if(N===0)break e;N--,H+=T[F++]<<$,$+=8}if(2&g.wrap&&H===35615){g.wbits===0&&(g.wbits=15),g.check=0,We[0]=255&H,We[1]=H>>>8&255,g.check=V(g.check,We,2,0),H=0,$=0,g.mode=16181;break}if(g.head&&(g.head.done=!1),!(1&g.wrap)||(((255&H)<<8)+(H>>8))%31){p.msg="incorrect header check",g.mode=wt;break}if((15&H)!==Hl){p.msg="unknown compression method",g.mode=wt;break}if(H>>>=4,$-=4,Me=8+(15&H),g.wbits===0&&(g.wbits=Me),Me>15||Me>g.wbits){p.msg="invalid window size",g.mode=wt;break}g.dmax=1<<g.wbits,g.flags=0,p.adler=g.check=1,g.mode=512&H?16189:Ni,H=0,$=0;break;case 16181:for(;$<16;){if(N===0)break e;N--,H+=T[F++]<<$,$+=8}if(g.flags=H,(255&g.flags)!==Hl){p.msg="unknown compression method",g.mode=wt;break}if(57344&g.flags){p.msg="unknown header flags set",g.mode=wt;break}g.head&&(g.head.text=H>>8&1),512&g.flags&&4&g.wrap&&(We[0]=255&H,We[1]=H>>>8&255,g.check=V(g.check,We,2,0)),H=0,$=0,g.mode=16182;case 16182:for(;$<32;){if(N===0)break e;N--,H+=T[F++]<<$,$+=8}g.head&&(g.head.time=H),512&g.flags&&4&g.wrap&&(We[0]=255&H,We[1]=H>>>8&255,We[2]=H>>>16&255,We[3]=H>>>24&255,g.check=V(g.check,We,4,0)),H=0,$=0,g.mode=16183;case 16183:for(;$<16;){if(N===0)break e;N--,H+=T[F++]<<$,$+=8}g.head&&(g.head.xflags=255&H,g.head.os=H>>8),512&g.flags&&4&g.wrap&&(We[0]=255&H,We[1]=H>>>8&255,g.check=V(g.check,We,2,0)),H=0,$=0,g.mode=16184;case 16184:if(1024&g.flags){for(;$<16;){if(N===0)break e;N--,H+=T[F++]<<$,$+=8}g.length=H,g.head&&(g.head.extra_len=H),512&g.flags&&4&g.wrap&&(We[0]=255&H,We[1]=H>>>8&255,g.check=V(g.check,We,2,0)),H=0,$=0}else g.head&&(g.head.extra=null);g.mode=16185;case 16185:if(1024&g.flags&&(ve=g.length,ve>N&&(ve=N),ve&&(g.head&&(Me=g.head.extra_len-g.length,g.head.extra||(g.head.extra=new Uint8Array(g.head.extra_len)),g.head.extra.set(T.subarray(F,F+ve),Me)),512&g.flags&&4&g.wrap&&(g.check=V(g.check,T,ve,F)),N-=ve,F+=ve,g.length-=ve),g.length))break e;g.length=0,g.mode=16186;case 16186:if(2048&g.flags){if(N===0)break e;ve=0;do Me=T[F+ve++],g.head&&Me&&g.length<65536&&(g.head.name+=String.fromCharCode(Me));while(Me&&ve<N);if(512&g.flags&&4&g.wrap&&(g.check=V(g.check,T,ve,F)),N-=ve,F+=ve,Me)break e}else g.head&&(g.head.name=null);g.length=0,g.mode=16187;case 16187:if(4096&g.flags){if(N===0)break e;ve=0;do Me=T[F+ve++],g.head&&Me&&g.length<65536&&(g.head.comment+=String.fromCharCode(Me));while(Me&&ve<N);if(512&g.flags&&4&g.wrap&&(g.check=V(g.check,T,ve,F)),N-=ve,F+=ve,Me)break e}else g.head&&(g.head.comment=null);g.mode=16188;case 16188:if(512&g.flags){for(;$<16;){if(N===0)break e;N--,H+=T[F++]<<$,$+=8}if(4&g.wrap&&H!==(65535&g.check)){p.msg="header crc mismatch",g.mode=wt;break}H=0,$=0}g.head&&(g.head.hcrc=g.flags>>9&1,g.head.done=!0),p.adler=g.check=0,g.mode=Ni;break;case 16189:for(;$<32;){if(N===0)break e;N--,H+=T[F++]<<$,$+=8}p.adler=g.check=Vl(H),H=0,$=0,g.mode=Bo;case Bo:if(g.havedict===0)return p.next_out=q,p.avail_out=_e,p.next_in=F,p.avail_in=N,g.hold=H,g.bits=$,hg;p.adler=g.check=1,g.mode=Ni;case Ni:if(b===lg||b===vo)break e;case aa:if(g.last){H>>>=7&$,$-=7&$,g.mode=la;break}for(;$<3;){if(N===0)break e;N--,H+=T[F++]<<$,$+=8}switch(g.last=1&H,H>>>=1,$-=1,3&H){case 0:g.mode=16193;break;case 1:if(pg(g),g.mode=yo,b===vo){H>>>=2,$-=2;break e}break;case 2:g.mode=16196;break;case 3:p.msg="invalid block type",g.mode=wt}H>>>=2,$-=2;break;case 16193:for(H>>>=7&$,$-=7&$;$<32;){if(N===0)break e;N--,H+=T[F++]<<$,$+=8}if((65535&H)!=(H>>>16^65535)){p.msg="invalid stored block lengths",g.mode=wt;break}if(g.length=65535&H,H=0,$=0,g.mode=Aa,b===vo)break e;case Aa:g.mode=16195;case 16195:if(ve=g.length,ve){if(ve>N&&(ve=N),ve>_e&&(ve=_e),ve===0)break e;M.set(T.subarray(F,F+ve),q),N-=ve,F+=ve,_e-=ve,q+=ve,g.length-=ve;break}g.mode=Ni;break;case 16196:for(;$<14;){if(N===0)break e;N--,H+=T[F++]<<$,$+=8}if(g.nlen=257+(31&H),H>>>=5,$-=5,g.ndist=1+(31&H),H>>>=5,$-=5,g.ncode=4+(15&H),H>>>=4,$-=4,g.nlen>286||g.ndist>30){p.msg="too many length or distance symbols",g.mode=wt;break}g.have=0,g.mode=16197;case 16197:for(;g.have<g.ncode;){for(;$<3;){if(N===0)break e;N--,H+=T[F++]<<$,$+=8}g.lens[xr[g.have++]]=7&H,H>>>=3,$-=3}for(;g.have<19;)g.lens[xr[g.have++]]=0;if(g.lencode=g.lendyn,g.lenbits=7,rt={bits:g.lenbits},At=Pr(0,g.lens,0,19,g.lencode,0,g.work,rt),g.lenbits=rt.bits,At){p.msg="invalid code lengths set",g.mode=wt;break}g.have=0,g.mode=16198;case 16198:for(;g.have<g.nlen+g.ndist;){for(;Je=g.lencode[H&(1<<g.lenbits)-1],Ke=Je>>>24,dt=Je>>>16&255,Ze=65535&Je,!(Ke<=$);){if(N===0)break e;N--,H+=T[F++]<<$,$+=8}if(Ze<16)H>>>=Ke,$-=Ke,g.lens[g.have++]=Ze;else{if(Ze===16){for(ei=Ke+2;$<ei;){if(N===0)break e;N--,H+=T[F++]<<$,$+=8}if(H>>>=Ke,$-=Ke,g.have===0){p.msg="invalid bit length repeat",g.mode=wt;break}Me=g.lens[g.have-1],ve=3+(3&H),H>>>=2,$-=2}else if(Ze===17){for(ei=Ke+3;$<ei;){if(N===0)break e;N--,H+=T[F++]<<$,$+=8}H>>>=Ke,$-=Ke,Me=0,ve=3+(7&H),H>>>=3,$-=3}else{for(ei=Ke+7;$<ei;){if(N===0)break e;N--,H+=T[F++]<<$,$+=8}H>>>=Ke,$-=Ke,Me=0,ve=11+(127&H),H>>>=7,$-=7}if(g.have+ve>g.nlen+g.ndist){p.msg="invalid bit length repeat",g.mode=wt;break}for(;ve--;)g.lens[g.have++]=Me}}if(g.mode===wt)break;if(g.lens[256]===0){p.msg="invalid code -- missing end-of-block",g.mode=wt;break}if(g.lenbits=9,rt={bits:g.lenbits},At=Pr(1,g.lens,0,g.nlen,g.lencode,0,g.work,rt),g.lenbits=rt.bits,At){p.msg="invalid literal/lengths set",g.mode=wt;break}if(g.distbits=6,g.distcode=g.distdyn,rt={bits:g.distbits},At=Pr(2,g.lens,g.nlen,g.ndist,g.distcode,0,g.work,rt),g.distbits=rt.bits,At){p.msg="invalid distances set",g.mode=wt;break}if(g.mode=yo,b===vo)break e;case yo:g.mode=xo;case xo:if(N>=6&&_e>=258){p.next_out=q,p.avail_out=_e,p.next_in=F,p.avail_in=N,g.hold=H,g.bits=$,rg(p,He),q=p.next_out,M=p.output,_e=p.avail_out,F=p.next_in,T=p.input,N=p.avail_in,H=g.hold,$=g.bits,g.mode===Ni&&(g.back=-1);break}for(g.back=0;Je=g.lencode[H&(1<<g.lenbits)-1],Ke=Je>>>24,dt=Je>>>16&255,Ze=65535&Je,!(Ke<=$);){if(N===0)break e;N--,H+=T[F++]<<$,$+=8}if(dt&&!(240&dt)){for(we=Ke,Xe=dt,pt=Ze;Je=g.lencode[pt+((H&(1<<we+Xe)-1)>>we)],Ke=Je>>>24,dt=Je>>>16&255,Ze=65535&Je,!(we+Ke<=$);){if(N===0)break e;N--,H+=T[F++]<<$,$+=8}H>>>=we,$-=we,g.back+=we}if(H>>>=Ke,$-=Ke,g.back+=Ke,g.length=Ze,dt===0){g.mode=16205;break}if(32&dt){g.back=-1,g.mode=Ni;break}if(64&dt){p.msg="invalid literal/length code",g.mode=wt;break}g.extra=15&dt,g.mode=16201;case 16201:if(g.extra){for(ei=g.extra;$<ei;){if(N===0)break e;N--,H+=T[F++]<<$,$+=8}g.length+=H&(1<<g.extra)-1,H>>>=g.extra,$-=g.extra,g.back+=g.extra}g.was=g.length,g.mode=16202;case 16202:for(;Je=g.distcode[H&(1<<g.distbits)-1],Ke=Je>>>24,dt=Je>>>16&255,Ze=65535&Je,!(Ke<=$);){if(N===0)break e;N--,H+=T[F++]<<$,$+=8}if(!(240&dt)){for(we=Ke,Xe=dt,pt=Ze;Je=g.distcode[pt+((H&(1<<we+Xe)-1)>>we)],Ke=Je>>>24,dt=Je>>>16&255,Ze=65535&Je,!(we+Ke<=$);){if(N===0)break e;N--,H+=T[F++]<<$,$+=8}H>>>=we,$-=we,g.back+=we}if(H>>>=Ke,$-=Ke,g.back+=Ke,64&dt){p.msg="invalid distance code",g.mode=wt;break}g.offset=Ze,g.extra=15&dt,g.mode=16203;case 16203:if(g.extra){for(ei=g.extra;$<ei;){if(N===0)break e;N--,H+=T[F++]<<$,$+=8}g.offset+=H&(1<<g.extra)-1,H>>>=g.extra,$-=g.extra,g.back+=g.extra}if(g.offset>g.dmax){p.msg="invalid distance too far back",g.mode=wt;break}g.mode=16204;case 16204:if(_e===0)break e;if(ve=He-_e,g.offset>ve){if(ve=g.offset-ve,ve>g.whave&&g.sane){p.msg="invalid distance too far back",g.mode=wt;break}ve>g.wnext?(ve-=g.wnext,St=g.wsize-ve):St=g.wnext-ve,ve>g.length&&(ve=g.length),lt=g.window}else lt=M,St=q-g.offset,ve=g.length;ve>_e&&(ve=_e),_e-=ve,g.length-=ve;do M[q++]=lt[St++];while(--ve);g.length===0&&(g.mode=xo);break;case 16205:if(_e===0)break e;M[q++]=g.length,_e--,g.mode=xo;break;case la:if(g.wrap){for(;$<32;){if(N===0)break e;N--,H|=T[F++]<<$,$+=8}if(He-=_e,p.total_out+=He,g.total+=He,4&g.wrap&&He&&(p.adler=g.check=g.flags?V(g.check,M,He,q-He):Qe(g.check,M,He,q-He)),He=_e,4&g.wrap&&(g.flags?H:Vl(H))!==g.check){p.msg="incorrect data check",g.mode=wt;break}H=0,$=0}g.mode=16207;case 16207:if(g.wrap&&g.flags){for(;$<32;){if(N===0)break e;N--,H+=T[F++]<<$,$+=8}if(4&g.wrap&&H!==(4294967295&g.total)){p.msg="incorrect length check",g.mode=wt;break}H=0,$=0}g.mode=16208;case 16208:At=cg;break e;case wt:At=Nl;break e;case 16210:return Ql;default:return pi}return p.next_out=q,p.avail_out=_e,p.next_in=F,p.avail_in=N,g.hold=H,g.bits=$,(g.wsize||He!==p.avail_out&&g.mode<wt&&(g.mode<la||b!==kl))&&Xl(p,p.output,p.next_out,He-p.avail_out),qe-=p.avail_in,He-=p.avail_out,p.total_in+=qe,p.total_out+=He,g.total+=He,4&g.wrap&&He&&(p.adler=g.check=g.flags?V(g.check,M,He,p.next_out-He):Qe(g.check,M,He,p.next_out-He)),p.data_type=g.bits+(g.last?64:0)+(g.mode===Ni?128:0)+(g.mode===yo||g.mode===Aa?256:0),(qe===0&&He===0||b===kl)&&At===ds&&(At=ug),At},inflateEnd:p=>{if(ps(p))return pi;let b=p.state;return b.window&&(b.window=null),p.state=null,ds},inflateGetHeader:(p,b)=>{if(ps(p))return pi;const g=p.state;return 2&g.wrap?(g.head=b,b.done=!1,ds):pi},inflateSetDictionary:(p,b)=>{const g=b.length;let T,M,F;return ps(p)?pi:(T=p.state,T.wrap!==0&&T.mode!==Bo?pi:T.mode===Bo&&(M=1,M=Qe(M,b,g,0),M!==T.check)?Nl:(F=Xl(p,b,g,g),F?(T.mode=16210,Ql):(T.havedict=1,ds)))},inflateInfo:"pako inflate (from Nodeca project)"},fg=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const Yl=Object.prototype.toString,{Z_NO_FLUSH:gg,Z_FINISH:mg,Z_OK:Br,Z_STREAM_END:ua,Z_NEED_DICT:da,Z_STREAM_ERROR:_g,Z_DATA_ERROR:$l,Z_MEM_ERROR:vg}=L;function yr(p){this.options=Dl({chunkSize:65536,windowBits:15,to:""},p||{});const b=this.options;b.raw&&b.windowBits>=0&&b.windowBits<16&&(b.windowBits=-b.windowBits,b.windowBits===0&&(b.windowBits=-15)),!(b.windowBits>=0&&b.windowBits<16)||p&&p.windowBits||(b.windowBits+=32),b.windowBits>15&&b.windowBits<48&&!(15&b.windowBits)&&(b.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Ul,this.strm.avail_out=0;let g=Qi.inflateInit2(this.strm,b.windowBits);if(g!==Br)throw new Error(Z[g]);if(this.header=new fg,Qi.inflateGetHeader(this.strm,this.header),b.dictionary&&(typeof b.dictionary=="string"?b.dictionary=oa(b.dictionary):Yl.call(b.dictionary)==="[object ArrayBuffer]"&&(b.dictionary=new Uint8Array(b.dictionary)),b.raw&&(g=Qi.inflateSetDictionary(this.strm,b.dictionary),g!==Br)))throw new Error(Z[g])}function pa(p,b){const g=new yr(b);if(g.push(p),g.err)throw g.msg||Z[g.err];return g.result}yr.prototype.push=function(p,b){const g=this.strm,T=this.options.chunkSize,M=this.options.dictionary;let F,q,N;if(this.ended)return!1;for(q=b===~~b?b:b===!0?mg:gg,Yl.call(p)==="[object ArrayBuffer]"?g.input=new Uint8Array(p):g.input=p,g.next_in=0,g.avail_in=g.input.length;;){for(g.avail_out===0&&(g.output=new Uint8Array(T),g.next_out=0,g.avail_out=T),F=Qi.inflate(g,q),F===da&&M&&(F=Qi.inflateSetDictionary(g,M),F===Br?F=Qi.inflate(g,q):F===$l&&(F=da));g.avail_in>0&&F===ua&&g.state.wrap>0&&p[g.next_in]!==0;)Qi.inflateReset(g),F=Qi.inflate(g,q);switch(F){case _g:case $l:case da:case vg:return this.onEnd(F),this.ended=!0,!1}if(N=g.avail_out,g.next_out&&(g.avail_out===0||F===ua))if(this.options.to==="string"){let _e=Xf(g.output,g.next_out),H=g.next_out-_e,$=Wf(g.output,_e);g.next_out=H,g.avail_out=T-H,H&&g.output.set(g.output.subarray(_e,_e+H),0),this.onData($)}else this.onData(g.output.length===g.next_out?g.output:g.output.subarray(0,g.next_out));if(F!==Br||N!==0){if(F===ua)return F=Qi.inflateEnd(this.strm),this.onEnd(F),this.ended=!0,!0;if(g.avail_in===0)break}}return!0},yr.prototype.onData=function(p){this.chunks.push(p)},yr.prototype.onEnd=function(p){p===Br&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=Rl(this.chunks)),this.chunks=[],this.err=p,this.msg=this.strm.msg};var Pg={Inflate:yr,inflate:pa,inflateRaw:function(p,b){return(b=b||{}).raw=!0,pa(p,b)},ungzip:pa,constants:L};const{Deflate:Bg,deflate:yg,deflateRaw:xg,gzip:wg}=sg,{Inflate:bg,inflate:Cg,inflateRaw:Eg,ungzip:Ig}=Pg;var Zl=Bg,ql=yg,Jl=xg,ec=wg,tc=bg,ic=Cg,sc=Eg,rc=Ig,oc=L,Fg={Deflate:Zl,deflate:ql,deflateRaw:Jl,gzip:ec,Inflate:tc,inflate:ic,inflateRaw:sc,ungzip:rc,constants:oc};r.Deflate=Zl,r.Inflate=tc,r.constants=oc,r.default=Fg,r.deflate=ql,r.deflateRaw=Jl,r.gzip=ec,r.inflate=ic,r.inflateRaw=sc,r.ungzip=rc,Object.defineProperty(r,"__esModule",{value:!0})});var Oi=Object.freeze({__proto__:null});let ri=window.pako||Oi;ri.inflate||(ri=ri.default);const wI=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();function bI(r){return{positions:r[0],normals:r[1],indices:r[2],edgeIndices:r[3],meshPositions:r[4],meshIndices:r[5],meshEdgesIndices:r[6],meshColors:r[7],entityIDs:r[8],entityMeshes:r[9],entityIsObjects:r[10],positionsDecodeMatrix:r[11]}}function CI(r){return{positions:new Uint16Array(ri.inflate(r.positions).buffer),normals:new Int8Array(ri.inflate(r.normals).buffer),indices:new Uint32Array(ri.inflate(r.indices).buffer),edgeIndices:new Uint32Array(ri.inflate(r.edgeIndices).buffer),meshPositions:new Uint32Array(ri.inflate(r.meshPositions).buffer),meshIndices:new Uint32Array(ri.inflate(r.meshIndices).buffer),meshEdgesIndices:new Uint32Array(ri.inflate(r.meshEdgesIndices).buffer),meshColors:new Uint8Array(ri.inflate(r.meshColors).buffer),entityIDs:ri.inflate(r.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(ri.inflate(r.entityMeshes).buffer),entityIsObjects:new Uint8Array(ri.inflate(r.entityIsObjects).buffer),positionsDecodeMatrix:new Float32Array(ri.inflate(r.positionsDecodeMatrix).buffer)}}function EI(r,e,i,s,t,o){o.getNextId(),s.positionsCompression="precompressed",s.normalsCompression="precompressed";const n=i.positions,a=i.normals,A=i.indices,l=i.edgeIndices,h=i.meshPositions,d=i.meshIndices,f=i.meshEdgesIndices,m=i.meshColors,_=JSON.parse(i.entityIDs),u=i.entityMeshes,P=i.entityIsObjects,y=h.length,x=u.length;for(let B=0;B<x;B++){const v=_[B],w=e.globalizeObjectIds?c.globalizeObjectId(s.id,v):v,C=r.metaScene.metaObjects[w],I={},E={};if(C){if(e.excludeTypesMap&&C.type&&e.excludeTypesMap[C.type]||e.includeTypesMap&&C.type&&!e.includeTypesMap[C.type])continue;const D=e.objectDefaults?e.objectDefaults[C.type]||e.objectDefaults.DEFAULT:null;D&&(D.visible===!1&&(I.visible=!1),D.pickable===!1&&(I.pickable=!1),D.colorize&&(E.color=D.colorize),D.opacity!==void 0&&D.opacity!==null&&(E.opacity=D.opacity))}else if(e.excludeUnclassifiedObjects)continue;const S=B===x-1,R=[];for(let D=u[B],K=S?u.length:u[B+1];D<K;D++){const G=D===y-1,z=w+".mesh."+D,le=wI(m.subarray(D*4,D*4+3)),ue=m[D*4+3]/255;s.createMesh(Le.apply(E,{id:z,primitive:"triangles",positionsCompressed:n.subarray(h[D],G?n.length:h[D+1]),normalsCompressed:a.subarray(h[D],G?n.length:h[D+1]),indices:A.subarray(d[D],G?A.length:d[D+1]),edgeIndices:l.subarray(f[D],G?l.length:f[D+1]),positionsDecodeMatrix:i.positionsDecodeMatrix,color:le,opacity:ue})),R.push(z)}s.createEntity(Le.apply(I,{id:w,isObject:P[B]===1,meshIds:R}))}}const Qd={version:1,parse:function(r,e,i,s,t,o){const n=bI(i),a=CI(n);EI(r,e,a,s,t,o)}};let jt=window.pako||Oi;jt.inflate||(jt=jt.default);function II(r){return{positions:r[0],normals:r[1],indices:r[2],edgeIndices:r[3],meshPositions:r[4],meshIndices:r[5],meshEdgesIndices:r[6],meshColors:r[7],entityIDs:r[8],entityMeshes:r[9],entityIsObjects:r[10],positionsDecodeMatrix:r[11],entityMeshIds:r[12],entityMatrices:r[13],entityUsesInstancing:r[14]}}function FI(r){return{positions:new Uint16Array(jt.inflate(r.positions).buffer),normals:new Int8Array(jt.inflate(r.normals).buffer),indices:new Uint32Array(jt.inflate(r.indices).buffer),edgeIndices:new Uint32Array(jt.inflate(r.edgeIndices).buffer),meshPositions:new Uint32Array(jt.inflate(r.meshPositions).buffer),meshIndices:new Uint32Array(jt.inflate(r.meshIndices).buffer),meshEdgesIndices:new Uint32Array(jt.inflate(r.meshEdgesIndices).buffer),meshColors:new Uint8Array(jt.inflate(r.meshColors).buffer),entityIDs:jt.inflate(r.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(jt.inflate(r.entityMeshes).buffer),entityIsObjects:new Uint8Array(jt.inflate(r.entityIsObjects).buffer),positionsDecodeMatrix:new Float32Array(jt.inflate(r.positionsDecodeMatrix).buffer),entityMeshIds:new Uint32Array(jt.inflate(r.entityMeshIds).buffer),entityMatrices:new Float32Array(jt.inflate(r.entityMatrices).buffer),entityUsesInstancing:new Uint8Array(jt.inflate(r.entityUsesInstancing).buffer)}}const MI=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();function SI(r,e,i,s,t,o){const n=o.getNextId();s.positionsCompression="precompressed",s.normalsCompression="precompressed";const a=i.positions,A=i.normals,l=i.indices,h=i.edgeIndices,d=i.meshPositions,f=i.meshIndices,m=i.meshEdgesIndices,_=i.meshColors,u=JSON.parse(i.entityIDs),P=i.entityMeshes,y=i.entityIsObjects,x=i.entityMeshIds,B=i.entityMatrices,v=i.entityUsesInstancing,w=d.length,C=P.length,I={};for(let E=0;E<C;E++){const S=u[E],R=e.globalizeObjectIds?c.globalizeObjectId(s.id,S):S,D=r.metaScene.metaObjects[R],K={},G={},z=B.subarray(E*16,E*16+16);if(D){if(e.excludeTypesMap&&D.type&&e.excludeTypesMap[D.type]||e.includeTypesMap&&D.type&&!e.includeTypesMap[D.type])continue;const ae=e.objectDefaults?e.objectDefaults[D.type]||e.objectDefaults.DEFAULT:null;ae&&(ae.visible===!1&&(K.visible=!1),ae.pickable===!1&&(K.pickable=!1),ae.colorize&&(G.color=ae.colorize),ae.opacity!==void 0&&ae.opacity!==null&&(G.opacity=ae.opacity))}else if(e.excludeUnclassifiedObjects)continue;const le=E===C-1,ue=[];for(let ae=P[E],Pe=le?x.length:P[E+1];ae<Pe;ae++){const be=x[ae],xe=be===w-1,Ie=o.getNextId(),Fe=MI(_.subarray(be*4,be*4+3)),Qe=_[be*4+3]/255,Ve=a.subarray(d[be],xe?a.length:d[be+1]),V=A.subarray(d[be],xe?a.length:d[be+1]),Z=l.subarray(f[be],xe?l.length:f[be+1]),L=h.subarray(m[be],xe?h.length:m[be+1]);if(v[E]===1){const Q=`${n}.geometry.${Ie}.${be}`;Q in I||(s.createGeometry({id:Q,positionsCompressed:Ve,normalsCompressed:V,indices:Z,edgeIndices:L,primitive:"triangles",positionsDecodeMatrix:i.positionsDecodeMatrix}),I[Q]=!0),s.createMesh(Le.apply(G,{id:Ie,color:Fe,opacity:Qe,matrix:z,geometryId:Q})),ue.push(Ie)}else s.createMesh(Le.apply(G,{id:Ie,primitive:"triangles",positionsCompressed:Ve,normalsCompressed:V,indices:Z,edgeIndices:L,positionsDecodeMatrix:i.positionsDecodeMatrix,color:Fe,opacity:Qe})),ue.push(Ie)}ue.length&&s.createEntity(Le.apply(K,{id:R,isObject:y[E]===1,meshIds:ue}))}}const Hd={version:2,parse:function(r,e,i,s,t,o){const n=II(i),a=FI(n);SI(r,e,a,s,t,o)}};let Nt=window.pako||Oi;Nt.inflate||(Nt=Nt.default);function TI(r){return{positions:r[0],normals:r[1],indices:r[2],edgeIndices:r[3],meshPositions:r[4],meshIndices:r[5],meshEdgesIndices:r[6],meshColors:r[7],entityIDs:r[8],entityMeshes:r[9],entityIsObjects:r[10],instancedPositionsDecodeMatrix:r[11],batchedPositionsDecodeMatrix:r[12],entityMeshIds:r[13],entityMatrices:r[14],entityUsesInstancing:r[15]}}function DI(r){return{positions:new Uint16Array(Nt.inflate(r.positions).buffer),normals:new Int8Array(Nt.inflate(r.normals).buffer),indices:new Uint32Array(Nt.inflate(r.indices).buffer),edgeIndices:new Uint32Array(Nt.inflate(r.edgeIndices).buffer),meshPositions:new Uint32Array(Nt.inflate(r.meshPositions).buffer),meshIndices:new Uint32Array(Nt.inflate(r.meshIndices).buffer),meshEdgesIndices:new Uint32Array(Nt.inflate(r.meshEdgesIndices).buffer),meshColors:new Uint8Array(Nt.inflate(r.meshColors).buffer),entityIDs:Nt.inflate(r.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(Nt.inflate(r.entityMeshes).buffer),entityIsObjects:new Uint8Array(Nt.inflate(r.entityIsObjects).buffer),instancedPositionsDecodeMatrix:new Float32Array(Nt.inflate(r.instancedPositionsDecodeMatrix).buffer),batchedPositionsDecodeMatrix:new Float32Array(Nt.inflate(r.batchedPositionsDecodeMatrix).buffer),entityMeshIds:new Uint32Array(Nt.inflate(r.entityMeshIds).buffer),entityMatrices:new Float32Array(Nt.inflate(r.entityMatrices).buffer),entityUsesInstancing:new Uint8Array(Nt.inflate(r.entityUsesInstancing).buffer)}}const RI=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();function LI(r,e,i,s,t,o){const n=o.getNextId();s.positionsCompression="precompressed",s.normalsCompression="precompressed";const a=i.positions,A=i.normals,l=i.indices,h=i.edgeIndices,d=i.meshPositions,f=i.meshIndices,m=i.meshEdgesIndices,_=i.meshColors,u=JSON.parse(i.entityIDs),P=i.entityMeshes,y=i.entityIsObjects,x=i.entityMeshIds,B=i.entityMatrices,v=i.entityUsesInstancing,w=d.length,C=P.length,I={};for(let G=0;G<C;G++){const z=u[G],le=e.globalizeObjectIds?c.globalizeObjectId(s.id,z):z,ue=r.metaScene.metaObjects[le],ae={},Pe={},be=B.subarray(G*16,G*16+16);if(ue){if(e.excludeTypesMap&&ue.type&&e.excludeTypesMap[ue.type]||e.includeTypesMap&&ue.type&&!e.includeTypesMap[ue.type])continue;const Fe=e.objectDefaults?e.objectDefaults[ue.type]||e.objectDefaults.DEFAULT:null;Fe&&(Fe.visible===!1&&(ae.visible=!1),Fe.pickable===!1&&(ae.pickable=!1),Fe.colorize&&(Pe.color=Fe.colorize),Fe.opacity!==void 0&&Fe.opacity!==null&&(Pe.opacity=Fe.opacity))}else if(e.excludeUnclassifiedObjects)continue;const xe=G===C-1,Ie=[];for(let Fe=P[G],Qe=xe?x.length:P[G+1];Fe<Qe;Fe++){var E=x[Fe];const Ve=E===w-1,V=`${n}.${le}.mesh.${E}`,Z=RI(_.subarray(E*4,E*4+3)),L=_[E*4+3]/255;var S=a.subarray(d[E],Ve?a.length:d[E+1]),R=A.subarray(d[E],Ve?a.length:d[E+1]),D=l.subarray(f[E],Ve?l.length:f[E+1]),K=h.subarray(m[E],Ve?h.length:m[E+1]);if(v[G]===1){const Q=`${n}.geometry.${V}.${E}`;Q in I||(s.createGeometry({id:Q,positionsCompressed:S,normalsCompressed:R,indices:D,edgeIndices:K,primitive:"triangles",positionsDecodeMatrix:i.instancedPositionsDecodeMatrix}),I[Q]=!0),s.createMesh(Le.apply(Pe,{id:V,color:Z,opacity:L,matrix:be,geometryId:Q})),Ie.push(V)}else s.createMesh(Le.apply(Pe,{id:V,primitive:"triangles",positionsCompressed:S,normalsCompressed:R,indices:D,edgeIndices:K,positionsDecodeMatrix:i.batchedPositionsDecodeMatrix,color:Z,opacity:L})),Ie.push(V)}Ie.length&&s.createEntity(Le.apply(ae,{id:le,isObject:y[G]===1,meshIds:Ie}))}}const Vd={version:3,parse:function(r,e,i,s,t,o){const n=TI(i),a=DI(n);LI(r,e,a,s,t,o)}};let Gt=window.pako||Oi;Gt.inflate||(Gt=Gt.default);function UI(r){return{positions:r[0],normals:r[1],indices:r[2],edgeIndices:r[3],decodeMatrices:r[4],matrices:r[5],eachPrimitivePositionsAndNormalsPortion:r[6],eachPrimitiveIndicesPortion:r[7],eachPrimitiveEdgeIndicesPortion:r[8],eachPrimitiveDecodeMatricesPortion:r[9],eachPrimitiveColor:r[10],primitiveInstances:r[11],eachEntityId:r[12],eachEntityPrimitiveInstancesPortion:r[13],eachEntityMatricesPortion:r[14],eachEntityMatrix:r[15]}}function OI(r){return{positions:new Uint16Array(Gt.inflate(r.positions).buffer),normals:new Int8Array(Gt.inflate(r.normals).buffer),indices:new Uint32Array(Gt.inflate(r.indices).buffer),edgeIndices:new Uint32Array(Gt.inflate(r.edgeIndices).buffer),decodeMatrices:new Float32Array(Gt.inflate(r.decodeMatrices).buffer),matrices:new Float32Array(Gt.inflate(r.matrices).buffer),eachPrimitivePositionsAndNormalsPortion:new Uint32Array(Gt.inflate(r.eachPrimitivePositionsAndNormalsPortion).buffer),eachPrimitiveIndicesPortion:new Uint32Array(Gt.inflate(r.eachPrimitiveIndicesPortion).buffer),eachPrimitiveEdgeIndicesPortion:new Uint32Array(Gt.inflate(r.eachPrimitiveEdgeIndicesPortion).buffer),eachPrimitiveDecodeMatricesPortion:new Uint32Array(Gt.inflate(r.eachPrimitiveDecodeMatricesPortion).buffer),eachPrimitiveColor:new Uint8Array(Gt.inflate(r.eachPrimitiveColor).buffer),primitiveInstances:new Uint32Array(Gt.inflate(r.primitiveInstances).buffer),eachEntityId:Gt.inflate(r.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array(Gt.inflate(r.eachEntityPrimitiveInstancesPortion).buffer),eachEntityMatricesPortion:new Uint32Array(Gt.inflate(r.eachEntityMatricesPortion).buffer)}}const kI=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();function NI(r,e,i,s,t,o){const n=o.getNextId();s.positionsCompression="precompressed",s.normalsCompression="precompressed";const a=i.positions,A=i.normals,l=i.indices,h=i.edgeIndices,d=i.decodeMatrices,f=i.matrices,m=i.eachPrimitivePositionsAndNormalsPortion,_=i.eachPrimitiveIndicesPortion,u=i.eachPrimitiveEdgeIndicesPortion,P=i.eachPrimitiveDecodeMatricesPortion,y=i.eachPrimitiveColor,x=i.primitiveInstances,B=JSON.parse(i.eachEntityId),v=i.eachEntityPrimitiveInstancesPortion,w=i.eachEntityMatricesPortion,C=m.length,I=x.length,E=new Uint8Array(C),S=new Uint32Array(C),R=B.length;for(let G=0;G<C;G++)S[G]=G;S.sort((G,z)=>P[G]<P[z]?-1:P[G]>P[z]?1:0);for(let G=0;G<I;G++){const z=x[G];E[z]++}const D={};for(let G=0;G<R;G++){const z=R-1,le=G===z,ue=v[G],ae=le?v[z]:v[G+1];for(let Pe=ue;Pe<ae;Pe++){const be=x[Pe];E[be]>1||(D[be]=G)}}for(let G=0;G<C;G++){const z=S[G],le=z===C-1,ae=E[z]>1,Pe=kI(y.subarray(z*4,z*4+3)),be=y[z*4+3]/255,xe=a.subarray(m[z],le?a.length:m[z+1]),Ie=A.subarray(m[z],le?A.length:m[z+1]),Fe=l.subarray(_[z],le?l.length:_[z+1]),Qe=h.subarray(u[z],le?h.length:u[z+1]),Ve=d.subarray(P[z],P[z]+16);if(ae){const V=`${n}-geometry.${z}`;s.createGeometry({id:V,primitive:"triangles",positionsCompressed:xe,normalsCompressed:Ie,indices:Fe,edgeIndices:Qe,positionsDecodeMatrix:Ve})}else{const V=`${n}-${z}`,Z=D[z];B[Z];const L={};s.createMesh(Le.apply(L,{id:V,primitive:"triangles",positionsCompressed:xe,normalsCompressed:Ie,indices:Fe,edgeIndices:Qe,positionsDecodeMatrix:Ve,color:Pe,opacity:be}))}}let K=0;for(let G=0;G<R;G++){const z=R-1,le=G===z,ue=B[G],ae=v[G],Pe=le?v[z]:v[G+1],be=[];for(let xe=ae;xe<Pe;xe++){const Ie=x[xe];if(E[Ie]>1){const Ve={},V=`${n}-instance.${K++}`,Z=`${n}-geometry.${Ie}`,L=w[G]*16,Q=f.subarray(L,L+16);s.createMesh(Le.apply(Ve,{id:V,geometryId:Z,matrix:Q})),be.push(V)}else be.push(Ie)}if(be.length>0){const xe={};s.createEntity(Le.apply(xe,{id:ue,isObject:!0,meshIds:be}))}}}const jd={version:4,parse:function(r,e,i,s,t,o){const n=UI(i),a=OI(n);NI(r,e,a,s,t,o)}};let Zt=window.pako||Oi;Zt.inflate||(Zt=Zt.default);function QI(r){return{positions:r[0],normals:r[1],indices:r[2],edgeIndices:r[3],matrices:r[4],eachPrimitivePositionsAndNormalsPortion:r[5],eachPrimitiveIndicesPortion:r[6],eachPrimitiveEdgeIndicesPortion:r[7],eachPrimitiveColor:r[8],primitiveInstances:r[9],eachEntityId:r[10],eachEntityPrimitiveInstancesPortion:r[11],eachEntityMatricesPortion:r[12]}}function HI(r){return{positions:new Float32Array(Zt.inflate(r.positions).buffer),normals:new Int8Array(Zt.inflate(r.normals).buffer),indices:new Uint32Array(Zt.inflate(r.indices).buffer),edgeIndices:new Uint32Array(Zt.inflate(r.edgeIndices).buffer),matrices:new Float32Array(Zt.inflate(r.matrices).buffer),eachPrimitivePositionsAndNormalsPortion:new Uint32Array(Zt.inflate(r.eachPrimitivePositionsAndNormalsPortion).buffer),eachPrimitiveIndicesPortion:new Uint32Array(Zt.inflate(r.eachPrimitiveIndicesPortion).buffer),eachPrimitiveEdgeIndicesPortion:new Uint32Array(Zt.inflate(r.eachPrimitiveEdgeIndicesPortion).buffer),eachPrimitiveColor:new Uint8Array(Zt.inflate(r.eachPrimitiveColor).buffer),primitiveInstances:new Uint32Array(Zt.inflate(r.primitiveInstances).buffer),eachEntityId:Zt.inflate(r.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array(Zt.inflate(r.eachEntityPrimitiveInstancesPortion).buffer),eachEntityMatricesPortion:new Uint32Array(Zt.inflate(r.eachEntityMatricesPortion).buffer)}}const VI=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();function jI(r,e,i,s,t,o){const n=o.getNextId();s.positionsCompression="disabled",s.normalsCompression="precompressed";const a=i.positions,A=i.normals,l=i.indices,h=i.edgeIndices,d=i.matrices,f=i.eachPrimitivePositionsAndNormalsPortion,m=i.eachPrimitiveIndicesPortion,_=i.eachPrimitiveEdgeIndicesPortion,u=i.eachPrimitiveColor,P=i.primitiveInstances,y=JSON.parse(i.eachEntityId),x=i.eachEntityPrimitiveInstancesPortion,B=i.eachEntityMatricesPortion,v=f.length,w=P.length,C=new Uint8Array(v),I=y.length;for(let R=0;R<w;R++){const D=P[R];C[D]++}const E={};for(let R=0;R<I;R++){const D=I-1,K=R===D,G=x[R],z=K?x[D]:x[R+1];for(let le=G;le<z;le++){const ue=P[le];C[ue]>1||(E[ue]=R)}}for(let R=0;R<v;R++){const D=R===v-1,G=C[R]>1,z=VI(u.subarray(R*4,R*4+3)),le=u[R*4+3]/255,ue=a.subarray(f[R],D?a.length:f[R+1]),ae=A.subarray(f[R],D?A.length:f[R+1]),Pe=l.subarray(m[R],D?l.length:m[R+1]),be=h.subarray(_[R],D?h.length:_[R+1]);if(G){const xe=`${n}-geometry.${R}`;s.createGeometry({id:xe,primitive:"triangles",positionsCompressed:ue,normalsCompressed:ae,indices:Pe,edgeIndices:be})}else{const xe=R,Ie=E[R];y[Ie];const Fe={};s.createMesh(Le.apply(Fe,{id:xe,primitive:"triangles",positionsCompressed:ue,normalsCompressed:ae,indices:Pe,edgeIndices:be,color:z,opacity:le}))}}let S=0;for(let R=0;R<I;R++){const D=I-1,K=R===D,G=y[R],z=x[R],le=K?x[D]:x[R+1],ue=[];for(let ae=z;ae<le;ae++){const Pe=P[ae];if(C[Pe]>1){const Ie={},Fe="instance."+S++,Qe="geometry"+Pe,Ve=B[R]*16,V=d.subarray(Ve,Ve+16);s.createMesh(Le.apply(Ie,{id:Fe,geometryId:Qe,matrix:V})),ue.push(Fe)}else ue.push(Pe)}if(ue.length>0){const ae={};s.createEntity(Le.apply(ae,{id:G,isObject:!0,meshIds:ue}))}}}const Gd={version:5,parse:function(r,e,i,s,t,o){const n=QI(i),a=HI(n);jI(r,e,a,s,t,o)}};let so=window.pako||Oi;so.inflate||(so=so.default);function GI(r){return{positions:r[0],normals:r[1],indices:r[2],edgeIndices:r[3],matrices:r[4],reusedPrimitivesDecodeMatrix:r[5],eachPrimitivePositionsAndNormalsPortion:r[6],eachPrimitiveIndicesPortion:r[7],eachPrimitiveEdgeIndicesPortion:r[8],eachPrimitiveColorAndOpacity:r[9],primitiveInstances:r[10],eachEntityId:r[11],eachEntityPrimitiveInstancesPortion:r[12],eachEntityMatricesPortion:r[13],eachTileAABB:r[14],eachTileEntitiesPortion:r[15]}}function zI(r){function e(i,s){return i.length===0?[]:so.inflate(i,s).buffer}return{positions:new Uint16Array(e(r.positions)),normals:new Int8Array(e(r.normals)),indices:new Uint32Array(e(r.indices)),edgeIndices:new Uint32Array(e(r.edgeIndices)),matrices:new Float32Array(e(r.matrices)),reusedPrimitivesDecodeMatrix:new Float32Array(e(r.reusedPrimitivesDecodeMatrix)),eachPrimitivePositionsAndNormalsPortion:new Uint32Array(e(r.eachPrimitivePositionsAndNormalsPortion)),eachPrimitiveIndicesPortion:new Uint32Array(e(r.eachPrimitiveIndicesPortion)),eachPrimitiveEdgeIndicesPortion:new Uint32Array(e(r.eachPrimitiveEdgeIndicesPortion)),eachPrimitiveColorAndOpacity:new Uint8Array(e(r.eachPrimitiveColorAndOpacity)),primitiveInstances:new Uint32Array(e(r.primitiveInstances)),eachEntityId:so.inflate(r.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array(e(r.eachEntityPrimitiveInstancesPortion)),eachEntityMatricesPortion:new Uint32Array(e(r.eachEntityMatricesPortion)),eachTileAABB:new Float64Array(e(r.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(e(r.eachTileEntitiesPortion))}}const KI=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();function WI(r,e,i,s,t,o){const n=o.getNextId(),a=i.positions,A=i.normals,l=i.indices,h=i.edgeIndices,d=i.matrices,f=i.reusedPrimitivesDecodeMatrix,m=i.eachPrimitivePositionsAndNormalsPortion,_=i.eachPrimitiveIndicesPortion,u=i.eachPrimitiveEdgeIndicesPortion,P=i.eachPrimitiveColorAndOpacity,y=i.primitiveInstances,x=JSON.parse(i.eachEntityId),B=i.eachEntityPrimitiveInstancesPortion,v=i.eachEntityMatricesPortion,w=i.eachTileAABB,C=i.eachTileEntitiesPortion,I=m.length,E=y.length,S=x.length,R=C.length,D=new Uint32Array(I);for(let z=0;z<E;z++){const le=y[z];D[le]!==void 0?D[le]++:D[le]=1}const K=c.vec3(),G=c.AABB3();for(let z=0;z<R;z++){const le=R-1,ue=z===le,ae=C[z],Pe=ue?S:C[z+1],be=z*6,xe=w.subarray(be,be+6);c.getAABB3Center(xe,K),G[0]=xe[0]-K[0],G[1]=xe[1]-K[1],G[2]=xe[2]-K[2],G[3]=xe[3]-K[0],G[4]=xe[4]-K[1],G[5]=xe[5]-K[2];const Ie=st.createPositionsDecodeMatrix(G),Fe={};for(let Qe=ae;Qe<Pe;Qe++){const Ve=x[Qe],V=e.globalizeObjectIds?c.globalizeObjectId(s.id,Ve):Ve,Z=v[Qe],L=d.slice(Z,Z+16),Q=S-1,O=Qe===Q,W=B[Qe],X=O?y.length:B[Qe+1],te=[],se=r.metaScene.metaObjects[V],ie={},oe={};if(se){if(e.excludeTypesMap&&se.type&&e.excludeTypesMap[se.type]||e.includeTypesMap&&se.type&&!e.includeTypesMap[se.type])continue;const he=e.objectDefaults?e.objectDefaults[se.type]||e.objectDefaults.DEFAULT:null;he&&(he.visible===!1&&(ie.visible=!1),he.pickable===!1&&(ie.pickable=!1),he.colorize&&(oe.color=he.colorize),he.opacity!==void 0&&he.opacity!==null&&(oe.opacity=he.opacity))}else if(e.excludeUnclassifiedObjects)continue;for(let he=W;he<X;he++){const ce=y[he],ee=D[ce]>1,ge=ce===I-1,re=a.subarray(m[ce],ge?a.length:m[ce+1]),me=A.subarray(m[ce],ge?A.length:m[ce+1]),de=l.subarray(_[ce],ge?l.length:_[ce+1]),Y=h.subarray(u[ce],ge?h.length:u[ce+1]),Ue=KI(P.subarray(ce*4,ce*4+3)),pe=P[ce*4+3]/255,Te=o.getNextId();if(ee){const fe=`${n}-geometry.${z}.${ce}`;Fe[fe]||(s.createGeometry({id:fe,primitive:"triangles",positionsCompressed:re,indices:de,edgeIndices:Y,positionsDecodeMatrix:f}),Fe[fe]=!0),s.createMesh(Le.apply(oe,{id:Te,geometryId:fe,origin:K,matrix:L,color:Ue,opacity:pe})),te.push(Te)}else s.createMesh(Le.apply(oe,{id:Te,origin:K,primitive:"triangles",positionsCompressed:re,normalsCompressed:me,indices:de,edgeIndices:Y,positionsDecodeMatrix:Ie,color:Ue,opacity:pe})),te.push(Te)}te.length>0&&s.createEntity(Le.apply(ie,{id:V,isObject:!0,meshIds:te}))}}}const zd={version:6,parse:function(r,e,i,s,t,o){const n=GI(i),a=zI(n);WI(r,e,a,s,t,o)}};let ro=window.pako||Oi;ro.inflate||(ro=ro.default);function XI(r){return{positions:r[0],normals:r[1],colors:r[2],indices:r[3],edgeIndices:r[4],matrices:r[5],reusedGeometriesDecodeMatrix:r[6],eachGeometryPrimitiveType:r[7],eachGeometryPositionsPortion:r[8],eachGeometryNormalsPortion:r[9],eachGeometryColorsPortion:r[10],eachGeometryIndicesPortion:r[11],eachGeometryEdgeIndicesPortion:r[12],eachMeshGeometriesPortion:r[13],eachMeshMatricesPortion:r[14],eachMeshMaterial:r[15],eachEntityId:r[16],eachEntityMeshesPortion:r[17],eachTileAABB:r[18],eachTileEntitiesPortion:r[19]}}function YI(r){function e(i,s){return i.length===0?[]:ro.inflate(i,s).buffer}return{positions:new Uint16Array(e(r.positions)),normals:new Int8Array(e(r.normals)),colors:new Uint8Array(e(r.colors)),indices:new Uint32Array(e(r.indices)),edgeIndices:new Uint32Array(e(r.edgeIndices)),matrices:new Float32Array(e(r.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(e(r.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(e(r.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(e(r.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(e(r.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(e(r.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(e(r.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(e(r.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(e(r.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(e(r.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(e(r.eachMeshMaterial)),eachEntityId:ro.inflate(r.eachEntityId,{to:"string"}),eachEntityMeshesPortion:new Uint32Array(e(r.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(e(r.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(e(r.eachTileEntitiesPortion))}}const $I=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();function Kd(r){const e=[];for(let i=0,s=r.length;i<s;i+=3)e.push(r[i]),e.push(r[i+1]),e.push(r[i+2]),e.push(1);return e}function ZI(r,e,i,s,t,o){const n=o.getNextId(),a=i.positions,A=i.normals,l=i.colors,h=i.indices,d=i.edgeIndices,f=i.matrices,m=i.reusedGeometriesDecodeMatrix,_=i.eachGeometryPrimitiveType,u=i.eachGeometryPositionsPortion,P=i.eachGeometryNormalsPortion,y=i.eachGeometryColorsPortion,x=i.eachGeometryIndicesPortion,B=i.eachGeometryEdgeIndicesPortion,v=i.eachMeshGeometriesPortion,w=i.eachMeshMatricesPortion,C=i.eachMeshMaterial,I=JSON.parse(i.eachEntityId),E=i.eachEntityMeshesPortion,S=i.eachTileAABB,R=i.eachTileEntitiesPortion,D=u.length,K=v.length,G=I.length,z=R.length,le=new Uint32Array(D);for(let Pe=0;Pe<K;Pe++){const be=v[Pe];le[be]!==void 0?le[be]++:le[be]=1}const ue=c.vec3(),ae=c.AABB3();for(let Pe=0;Pe<z;Pe++){const be=z-1,xe=Pe===be,Ie=R[Pe],Fe=xe?G:R[Pe+1],Qe=Pe*6,Ve=S.subarray(Qe,Qe+6);c.getAABB3Center(Ve,ue),ae[0]=Ve[0]-ue[0],ae[1]=Ve[1]-ue[1],ae[2]=Ve[2]-ue[2],ae[3]=Ve[3]-ue[0],ae[4]=Ve[4]-ue[1],ae[5]=Ve[5]-ue[2];const V=st.createPositionsDecodeMatrix(ae),Z={};for(let L=Ie;L<Fe;L++){const Q=I[L],O=e.globalizeObjectIds?c.globalizeObjectId(s.id,Q):Q,W=G-1,X=L===W,te=E[L],se=X?v.length:E[L+1],ie=[],oe=r.metaScene.metaObjects[O],he={},ce={};if(oe){if(e.excludeTypesMap&&oe.type&&e.excludeTypesMap[oe.type]||e.includeTypesMap&&oe.type&&!e.includeTypesMap[oe.type])continue;const J=e.objectDefaults?e.objectDefaults[oe.type]||e.objectDefaults.DEFAULT:null;J&&(J.visible===!1&&(he.visible=!1),J.pickable===!1&&(he.pickable=!1),J.colorize&&(ce.color=J.colorize),J.opacity!==void 0&&J.opacity!==null&&(ce.opacity=J.opacity),J.metallic!==void 0&&J.metallic!==null&&(ce.metallic=J.metallic),J.roughness!==void 0&&J.roughness!==null&&(ce.roughness=J.roughness))}else if(e.excludeUnclassifiedObjects)continue;for(let J=te;J<se;J++){const ee=v[J],re=le[ee]>1,me=ee===D-1,de=$I(C.subarray(J*6,J*6+3)),Y=C[J*6+3]/255,Ue=C[J*6+4]/255,pe=C[J*6+5]/255,Te=o.getNextId();if(re){const fe=w[J],je=f.slice(fe,fe+16),Ae=`${n}-geometry.${Pe}.${ee}`;if(!Z[Ae]){const De=_[ee];let Ge,ne,ke,ze,Ne,tt;switch(De){case 0:Ge="solid",ne=a.subarray(u[ee],me?a.length:u[ee+1]),ke=A.subarray(P[ee],me?A.length:P[ee+1]),Ne=h.subarray(x[ee],me?h.length:x[ee+1]),tt=d.subarray(B[ee],me?d.length:B[ee+1]);break;case 1:Ge="surface",ne=a.subarray(u[ee],me?a.length:u[ee+1]),ke=A.subarray(P[ee],me?A.length:P[ee+1]),Ne=h.subarray(x[ee],me?h.length:x[ee+1]),tt=d.subarray(B[ee],me?d.length:B[ee+1]);break;case 2:Ge="points",ne=a.subarray(u[ee],me?a.length:u[ee+1]),ze=Kd(l.subarray(y[ee],me?l.length:y[ee+1]));break;case 3:Ge="lines",ne=a.subarray(u[ee],me?a.length:u[ee+1]),Ne=h.subarray(x[ee],me?h.length:x[ee+1]);break;default:continue}s.createGeometry({id:Ae,primitive:Ge,positionsCompressed:ne,normalsCompressed:ke,colors:ze,indices:Ne,edgeIndices:tt,positionsDecodeMatrix:m}),Z[Ae]=!0}s.createMesh(Le.apply(ce,{id:Te,geometryId:Ae,origin:ue,matrix:je,color:de,metallic:Ue,roughness:pe,opacity:Y})),ie.push(Te)}else{const fe=_[ee];let je,Ae,De,Ge,ne,ke;switch(fe){case 0:je="solid",Ae=a.subarray(u[ee],me?a.length:u[ee+1]),De=A.subarray(P[ee],me?A.length:P[ee+1]),ne=h.subarray(x[ee],me?h.length:x[ee+1]),ke=d.subarray(B[ee],me?d.length:B[ee+1]);break;case 1:je="surface",Ae=a.subarray(u[ee],me?a.length:u[ee+1]),De=A.subarray(P[ee],me?A.length:P[ee+1]),ne=h.subarray(x[ee],me?h.length:x[ee+1]),ke=d.subarray(B[ee],me?d.length:B[ee+1]);break;case 2:je="points",Ae=a.subarray(u[ee],me?a.length:u[ee+1]),Ge=Kd(l.subarray(y[ee],me?l.length:y[ee+1]));break;case 3:je="lines",Ae=a.subarray(u[ee],me?a.length:u[ee+1]),ne=h.subarray(x[ee],me?h.length:x[ee+1]);break;default:continue}s.createMesh(Le.apply(ce,{id:Te,origin:ue,primitive:je,positionsCompressed:Ae,normalsCompressed:De,colors:Ge,indices:ne,edgeIndices:ke,positionsDecodeMatrix:V,color:de,metallic:Ue,roughness:pe,opacity:Y})),ie.push(Te)}}ie.length>0&&s.createEntity(Le.apply(he,{id:O,isObject:!0,meshIds:ie}))}}}const Wd={version:7,parse:function(r,e,i,s,t,o){const n=XI(i),a=YI(n);ZI(r,e,a,s,t,o)}};let ws=window.pako||Oi;ws.inflate||(ws=ws.default);const Ki=c.vec4(),Xd=c.vec4();function qI(r){return{types:r[0],eachMetaObjectId:r[1],eachMetaObjectType:r[2],eachMetaObjectName:r[3],eachMetaObjectParent:r[4],positions:r[5],normals:r[6],colors:r[7],indices:r[8],edgeIndices:r[9],matrices:r[10],reusedGeometriesDecodeMatrix:r[11],eachGeometryPrimitiveType:r[12],eachGeometryPositionsPortion:r[13],eachGeometryNormalsPortion:r[14],eachGeometryColorsPortion:r[15],eachGeometryIndicesPortion:r[16],eachGeometryEdgeIndicesPortion:r[17],eachMeshGeometriesPortion:r[18],eachMeshMatricesPortion:r[19],eachMeshMaterial:r[20],eachEntityMetaObject:r[21],eachEntityMeshesPortion:r[22],eachTileAABB:r[23],eachTileEntitiesPortion:r[24]}}function JI(r){function e(i,s){return i.length===0?[]:ws.inflate(i,s).buffer}return{types:ws.inflate(r.types,{to:"string"}),eachMetaObjectId:ws.inflate(r.eachMetaObjectId,{to:"string"}),eachMetaObjectType:new Uint32Array(e(r.eachMetaObjectType)),eachMetaObjectName:ws.inflate(r.eachMetaObjectName,{to:"string"}),eachMetaObjectParent:new Uint32Array(e(r.eachMetaObjectParent)),positions:new Uint16Array(e(r.positions)),normals:new Int8Array(e(r.normals)),colors:new Uint8Array(e(r.colors)),indices:new Uint32Array(e(r.indices)),edgeIndices:new Uint32Array(e(r.edgeIndices)),matrices:new Float32Array(e(r.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(e(r.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(e(r.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(e(r.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(e(r.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(e(r.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(e(r.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(e(r.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(e(r.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(e(r.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(e(r.eachMeshMaterial)),eachEntityMetaObject:new Uint32Array(e(r.eachEntityMetaObject)),eachEntityMeshesPortion:new Uint32Array(e(r.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(e(r.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(e(r.eachTileEntitiesPortion))}}const eF=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();function Yd(r){const e=[];for(let i=0,s=r.length;i<s;i+=3)e.push(r[i]),e.push(r[i+1]),e.push(r[i+2]),e.push(1);return e}function tF(r,e,i,s,t,o){const n=o.getNextId(),a=JSON.parse(i.types),A=JSON.parse(i.eachMetaObjectId),l=i.eachMetaObjectType,h=JSON.parse(i.eachMetaObjectName),d=i.eachMetaObjectParent,f=i.positions,m=i.normals,_=i.colors,u=i.indices,P=i.edgeIndices,y=i.matrices,x=i.reusedGeometriesDecodeMatrix,B=i.eachGeometryPrimitiveType,v=i.eachGeometryPositionsPortion,w=i.eachGeometryNormalsPortion,C=i.eachGeometryColorsPortion,I=i.eachGeometryIndicesPortion,E=i.eachGeometryEdgeIndicesPortion,S=i.eachMeshGeometriesPortion,R=i.eachMeshMatricesPortion,D=i.eachMeshMaterial,K=i.eachEntityMetaObject,G=i.eachEntityMeshesPortion,z=i.eachTileAABB,le=i.eachTileEntitiesPortion,ue=A.length,ae=v.length,Pe=S.length,be=K.length,xe=le.length;if(t){const V={metaObjects:[]};for(let Z=0;Z<ue;Z++){const L=A[Z],Q=l[Z],O=a[Q]||"default",W=h[Z],X=d[Z],te=X!==Z?A[X]:null;V.metaObjects.push({id:L,type:O,name:W,parent:te})}t.loadData(V,{includeTypes:e.includeTypes,excludeTypes:e.excludeTypes,globalizeObjectIds:e.globalizeObjectIds})}const Ie=new Uint32Array(ae);for(let V=0;V<Pe;V++){const Z=S[V];Ie[Z]!==void 0?Ie[Z]++:Ie[Z]=1}const Fe=c.vec3(),Qe=c.AABB3(),Ve={};for(let V=0;V<xe;V++){const Z=xe-1,L=V===Z,Q=le[V],O=L?be:le[V+1],W=V*6,X=z.subarray(W,W+6);c.getAABB3Center(X,Fe),Qe[0]=X[0]-Fe[0],Qe[1]=X[1]-Fe[1],Qe[2]=X[2]-Fe[2],Qe[3]=X[3]-Fe[0],Qe[4]=X[4]-Fe[1],Qe[5]=X[5]-Fe[2];const te=st.createPositionsDecodeMatrix(Qe),se={};for(let ie=Q;ie<O;ie++){const oe=K[ie],ce=A[oe],J=e.globalizeObjectIds?c.globalizeObjectId(s.id,ce):ce,ee=be-1,ge=ie===ee,re=G[ie],me=ge?S.length:G[ie+1],de=[],Y=r.metaScene.metaObjects[J],Ue={},pe={};if(Y){if(e.excludeTypesMap&&Y.type&&e.excludeTypesMap[Y.type]||e.includeTypesMap&&Y.type&&!e.includeTypesMap[Y.type])continue;const Te=e.objectDefaults?e.objectDefaults[Y.type]||e.objectDefaults.DEFAULT:null;Te&&(Te.visible===!1&&(Ue.visible=!1),Te.pickable===!1&&(Ue.pickable=!1),Te.colorize&&(pe.color=Te.colorize),Te.opacity!==void 0&&Te.opacity!==null&&(pe.opacity=Te.opacity),Te.metallic!==void 0&&Te.metallic!==null&&(pe.metallic=Te.metallic),Te.roughness!==void 0&&Te.roughness!==null&&(pe.roughness=Te.roughness))}else if(e.excludeUnclassifiedObjects)continue;for(let Te=re;Te<me;Te++){const fe=S[Te],Ae=Ie[fe]>1,De=fe===ae-1,Ge=eF(D.subarray(Te*6,Te*6+3)),ne=D[Te*6+3]/255,ke=D[Te*6+4]/255,ze=D[Te*6+5]/255,Ne=o.getNextId();if(Ae){const tt=R[Te],$e=y.slice(tt,tt+16),at=`${n}-geometry.${V}.${fe}`;let Ce=Ve[at];if(!Ce){Ce={batchThisMesh:!e.reuseGeometries};const ot=B[fe];let Ye=!1;switch(ot){case 0:Ce.primitiveName="solid",Ce.geometryPositions=f.subarray(v[fe],De?f.length:v[fe+1]),Ce.geometryNormals=m.subarray(w[fe],De?m.length:w[fe+1]),Ce.geometryIndices=u.subarray(I[fe],De?u.length:I[fe+1]),Ce.geometryEdgeIndices=P.subarray(E[fe],De?P.length:E[fe+1]),Ye=Ce.geometryPositions.length>0&&Ce.geometryIndices.length>0;break;case 1:Ce.primitiveName="surface",Ce.geometryPositions=f.subarray(v[fe],De?f.length:v[fe+1]),Ce.geometryNormals=m.subarray(w[fe],De?m.length:w[fe+1]),Ce.geometryIndices=u.subarray(I[fe],De?u.length:I[fe+1]),Ce.geometryEdgeIndices=P.subarray(E[fe],De?P.length:E[fe+1]),Ye=Ce.geometryPositions.length>0&&Ce.geometryIndices.length>0;break;case 2:Ce.primitiveName="points",Ce.geometryPositions=f.subarray(v[fe],De?f.length:v[fe+1]),Ce.geometryColors=Yd(_.subarray(C[fe],De?_.length:C[fe+1])),Ye=Ce.geometryPositions.length>0;break;case 3:Ce.primitiveName="lines",Ce.geometryPositions=f.subarray(v[fe],De?f.length:v[fe+1]),Ce.geometryIndices=u.subarray(I[fe],De?u.length:I[fe+1]),Ye=Ce.geometryPositions.length>0&&Ce.geometryIndices.length>0;break;default:continue}if(Ye||(Ce=null),Ce&&(Ce.geometryPositions.length>1e3,Ce.batchThisMesh)){Ce.decompressedPositions=new Float32Array(Ce.geometryPositions.length);const Se=Ce.geometryPositions,Be=Ce.decompressedPositions;for(let ht=0,Mt=Se.length;ht<Mt;ht+=3)Be[ht+0]=Se[ht+0]*x[0]+x[12],Be[ht+1]=Se[ht+1]*x[5]+x[13],Be[ht+2]=Se[ht+2]*x[10]+x[14];Ce.geometryPositions=null,Ve[at]=Ce}}if(Ce)if(Ce.batchThisMesh){const ot=Ce.decompressedPositions,Ye=new Uint16Array(ot.length);for(let Se=0,Be=ot.length;Se<Be;Se+=3)Ki[0]=ot[Se+0],Ki[1]=ot[Se+1],Ki[2]=ot[Se+2],Ki[3]=1,c.transformVec4($e,Ki,Xd),st.compressPosition(Xd,Qe,Ki),Ye[Se+0]=Ki[0],Ye[Se+1]=Ki[1],Ye[Se+2]=Ki[2];s.createMesh(Le.apply(pe,{id:Ne,origin:Fe,primitive:Ce.primitiveName,positionsCompressed:Ye,normalsCompressed:Ce.geometryNormals,colorsCompressed:Ce.geometryColors,indices:Ce.geometryIndices,edgeIndices:Ce.geometryEdgeIndices,positionsDecodeMatrix:te,color:Ge,metallic:ke,roughness:ze,opacity:ne})),de.push(Ne)}else se[at]||(s.createGeometry({id:at,primitive:Ce.primitiveName,positionsCompressed:Ce.geometryPositions,normalsCompressed:Ce.geometryNormals,colorsCompressed:Ce.geometryColors,indices:Ce.geometryIndices,edgeIndices:Ce.geometryEdgeIndices,positionsDecodeMatrix:x}),se[at]=!0),s.createMesh(Le.apply(pe,{id:Ne,geometryId:at,origin:Fe,matrix:$e,color:Ge,metallic:ke,roughness:ze,opacity:ne})),de.push(Ne)}else{const tt=B[fe];let $e,at,Ce,ot,Ye,Se,Be=!1;switch(tt){case 0:$e="solid",at=f.subarray(v[fe],De?f.length:v[fe+1]),Ce=m.subarray(w[fe],De?m.length:w[fe+1]),Ye=u.subarray(I[fe],De?u.length:I[fe+1]),Se=P.subarray(E[fe],De?P.length:E[fe+1]),Be=at.length>0&&Ye.length>0;break;case 1:$e="surface",at=f.subarray(v[fe],De?f.length:v[fe+1]),Ce=m.subarray(w[fe],De?m.length:w[fe+1]),Ye=u.subarray(I[fe],De?u.length:I[fe+1]),Se=P.subarray(E[fe],De?P.length:E[fe+1]),Be=at.length>0&&Ye.length>0;break;case 2:$e="points",at=f.subarray(v[fe],De?f.length:v[fe+1]),ot=Yd(_.subarray(C[fe],De?_.length:C[fe+1])),Be=at.length>0;break;case 3:$e="lines",at=f.subarray(v[fe],De?f.length:v[fe+1]),Ye=u.subarray(I[fe],De?u.length:I[fe+1]),Be=at.length>0&&Ye.length>0;break;default:continue}Be&&(s.createMesh(Le.apply(pe,{id:Ne,origin:Fe,primitive:$e,positionsCompressed:at,normalsCompressed:Ce,colorsCompressed:ot,indices:Ye,edgeIndices:Se,positionsDecodeMatrix:te,color:Ge,metallic:ke,roughness:ze,opacity:ne})),de.push(Ne))}}de.length>0&&s.createEntity(Le.apply(Ue,{id:J,isObject:!0,meshIds:de}))}}}const $d={version:8,parse:function(r,e,i,s,t,o){const n=qI(i),a=JI(n);tF(r,e,a,s,t,o)}};let cr=window.pako||Oi;cr.inflate||(cr=cr.default);const Wi=c.vec4(),Zd=c.vec4();function iF(r){return{metadata:r[0],positions:r[1],normals:r[2],colors:r[3],indices:r[4],edgeIndices:r[5],matrices:r[6],reusedGeometriesDecodeMatrix:r[7],eachGeometryPrimitiveType:r[8],eachGeometryPositionsPortion:r[9],eachGeometryNormalsPortion:r[10],eachGeometryColorsPortion:r[11],eachGeometryIndicesPortion:r[12],eachGeometryEdgeIndicesPortion:r[13],eachMeshGeometriesPortion:r[14],eachMeshMatricesPortion:r[15],eachMeshMaterial:r[16],eachEntityId:r[17],eachEntityMeshesPortion:r[18],eachTileAABB:r[19],eachTileEntitiesPortion:r[20]}}function sF(r){function e(i,s){return i.length===0?[]:cr.inflate(i,s).buffer}return{metadata:JSON.parse(cr.inflate(r.metadata,{to:"string"})),positions:new Uint16Array(e(r.positions)),normals:new Int8Array(e(r.normals)),colors:new Uint8Array(e(r.colors)),indices:new Uint32Array(e(r.indices)),edgeIndices:new Uint32Array(e(r.edgeIndices)),matrices:new Float32Array(e(r.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(e(r.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(e(r.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(e(r.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(e(r.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(e(r.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(e(r.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(e(r.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(e(r.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(e(r.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(e(r.eachMeshMaterial)),eachEntityId:JSON.parse(cr.inflate(r.eachEntityId,{to:"string"})),eachEntityMeshesPortion:new Uint32Array(e(r.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(e(r.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(e(r.eachTileEntitiesPortion))}}const rF=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();function oF(r,e,i,s,t,o){const n=o.getNextId(),a=i.metadata,A=i.positions,l=i.normals,h=i.colors,d=i.indices,f=i.edgeIndices,m=i.matrices,_=i.reusedGeometriesDecodeMatrix,u=i.eachGeometryPrimitiveType,P=i.eachGeometryPositionsPortion,y=i.eachGeometryNormalsPortion,x=i.eachGeometryColorsPortion,B=i.eachGeometryIndicesPortion,v=i.eachGeometryEdgeIndicesPortion,w=i.eachMeshGeometriesPortion,C=i.eachMeshMatricesPortion,I=i.eachMeshMaterial,E=i.eachEntityId,S=i.eachEntityMeshesPortion,R=i.eachTileAABB,D=i.eachTileEntitiesPortion,K=P.length,G=w.length,z=S.length,le=D.length;t&&t.loadData(a,{includeTypes:e.includeTypes,excludeTypes:e.excludeTypes,globalizeObjectIds:e.globalizeObjectIds});const ue=new Uint32Array(K);for(let xe=0;xe<G;xe++){const Ie=w[xe];ue[Ie]!==void 0?ue[Ie]++:ue[Ie]=1}const ae=c.vec3(),Pe=c.AABB3(),be={};for(let xe=0;xe<le;xe++){const Ie=le-1,Fe=xe===Ie,Qe=D[xe],Ve=Fe?z-1:D[xe+1]-1,V=xe*6,Z=R.subarray(V,V+6);c.getAABB3Center(Z,ae),Pe[0]=Z[0]-ae[0],Pe[1]=Z[1]-ae[1],Pe[2]=Z[2]-ae[2],Pe[3]=Z[3]-ae[0],Pe[4]=Z[4]-ae[1],Pe[5]=Z[5]-ae[2];const L=st.createPositionsDecodeMatrix(Pe),Q={};for(let O=Qe;O<=Ve;O++){const W=E[O],X=e.globalizeObjectIds?c.globalizeObjectId(s.id,W):W,te=z-1,se=O===te,ie=S[O],oe=se?w.length-1:S[O+1]-1,he=[],ce=r.metaScene.metaObjects[X],J={},ee={};if(ce){if(e.excludeTypesMap&&ce.type&&e.excludeTypesMap[ce.type]||e.includeTypesMap&&ce.type&&!e.includeTypesMap[ce.type])continue;const ge=e.objectDefaults?e.objectDefaults[ce.type]||e.objectDefaults.DEFAULT:null;ge&&(ge.visible===!1&&(J.visible=!1),ge.pickable===!1&&(J.pickable=!1),ge.colorize&&(ee.color=ge.colorize),ge.opacity!==void 0&&ge.opacity!==null&&(ee.opacity=ge.opacity),ge.metallic!==void 0&&ge.metallic!==null&&(ee.metallic=ge.metallic),ge.roughness!==void 0&&ge.roughness!==null&&(ee.roughness=ge.roughness))}else if(e.excludeUnclassifiedObjects)continue;for(let ge=ie;ge<=oe;ge++){const re=w[ge],de=ue[re]>1,Y=re===K-1,Ue=rF(I.subarray(ge*6,ge*6+3)),pe=I[ge*6+3]/255,Te=I[ge*6+4]/255,fe=I[ge*6+5]/255,je=o.getNextId();if(de){const Ae=C[ge],De=m.slice(Ae,Ae+16),Ge=`${n}-geometry.${xe}.${re}`;let ne=be[Ge];if(!ne){ne={batchThisMesh:!e.reuseGeometries};const ke=u[re];let ze=!1;switch(ke){case 0:ne.primitiveName="solid",ne.geometryPositions=A.subarray(P[re],Y?A.length:P[re+1]),ne.geometryNormals=l.subarray(y[re],Y?l.length:y[re+1]),ne.geometryIndices=d.subarray(B[re],Y?d.length:B[re+1]),ne.geometryEdgeIndices=f.subarray(v[re],Y?f.length:v[re+1]),ze=ne.geometryPositions.length>0&&ne.geometryIndices.length>0;break;case 1:ne.primitiveName="surface",ne.geometryPositions=A.subarray(P[re],Y?A.length:P[re+1]),ne.geometryNormals=l.subarray(y[re],Y?l.length:y[re+1]),ne.geometryIndices=d.subarray(B[re],Y?d.length:B[re+1]),ne.geometryEdgeIndices=f.subarray(v[re],Y?f.length:v[re+1]),ze=ne.geometryPositions.length>0&&ne.geometryIndices.length>0;break;case 2:ne.primitiveName="points",ne.geometryPositions=A.subarray(P[re],Y?A.length:P[re+1]),ne.geometryColors=h.subarray(x[re],Y?h.length:x[re+1]),ze=ne.geometryPositions.length>0;break;case 3:ne.primitiveName="lines",ne.geometryPositions=A.subarray(P[re],Y?A.length:P[re+1]),ne.geometryIndices=d.subarray(B[re],Y?d.length:B[re+1]),ze=ne.geometryPositions.length>0&&ne.geometryIndices.length>0;break;default:continue}if(ze||(ne=null),ne&&(ne.geometryPositions.length>1e3,ne.batchThisMesh)){ne.decompressedPositions=new Float32Array(ne.geometryPositions.length),ne.transformedAndRecompressedPositions=new Uint16Array(ne.geometryPositions.length);const Ne=ne.geometryPositions,tt=ne.decompressedPositions;for(let $e=0,at=Ne.length;$e<at;$e+=3)tt[$e+0]=Ne[$e+0]*_[0]+_[12],tt[$e+1]=Ne[$e+1]*_[5]+_[13],tt[$e+2]=Ne[$e+2]*_[10]+_[14];ne.geometryPositions=null,be[Ge]=ne}}if(ne)if(ne.batchThisMesh){const ke=ne.decompressedPositions,ze=ne.transformedAndRecompressedPositions;for(let Ne=0,tt=ke.length;Ne<tt;Ne+=3)Wi[0]=ke[Ne+0],Wi[1]=ke[Ne+1],Wi[2]=ke[Ne+2],Wi[3]=1,c.transformVec4(De,Wi,Zd),st.compressPosition(Zd,Pe,Wi),ze[Ne+0]=Wi[0],ze[Ne+1]=Wi[1],ze[Ne+2]=Wi[2];s.createMesh(Le.apply(ee,{id:je,origin:ae,primitive:ne.primitiveName,positionsCompressed:ze,normalsCompressed:ne.geometryNormals,colorsCompressed:ne.geometryColors,indices:ne.geometryIndices,edgeIndices:ne.geometryEdgeIndices,positionsDecodeMatrix:L,color:Ue,metallic:Te,roughness:fe,opacity:pe})),he.push(je)}else Q[Ge]||(s.createGeometry({id:Ge,primitive:ne.primitiveName,positionsCompressed:ne.geometryPositions,normalsCompressed:ne.geometryNormals,colorsCompressed:ne.geometryColors,indices:ne.geometryIndices,edgeIndices:ne.geometryEdgeIndices,positionsDecodeMatrix:_}),Q[Ge]=!0),s.createMesh(Le.apply(ee,{id:je,geometryId:Ge,origin:ae,matrix:De,color:Ue,metallic:Te,roughness:fe,opacity:pe})),he.push(je)}else{const Ae=u[re];let De,Ge,ne,ke,ze,Ne,tt=!1;switch(Ae){case 0:De="solid",Ge=A.subarray(P[re],Y?A.length:P[re+1]),ne=l.subarray(y[re],Y?l.length:y[re+1]),ze=d.subarray(B[re],Y?d.length:B[re+1]),Ne=f.subarray(v[re],Y?f.length:v[re+1]),tt=Ge.length>0&&ze.length>0;break;case 1:De="surface",Ge=A.subarray(P[re],Y?A.length:P[re+1]),ne=l.subarray(y[re],Y?l.length:y[re+1]),ze=d.subarray(B[re],Y?d.length:B[re+1]),Ne=f.subarray(v[re],Y?f.length:v[re+1]),tt=Ge.length>0&&ze.length>0;break;case 2:De="points",Ge=A.subarray(P[re],Y?A.length:P[re+1]),ke=h.subarray(x[re],Y?h.length:x[re+1]),tt=Ge.length>0;break;case 3:De="lines",Ge=A.subarray(P[re],Y?A.length:P[re+1]),ze=d.subarray(B[re],Y?d.length:B[re+1]),tt=Ge.length>0&&ze.length>0;break;default:continue}tt&&(s.createMesh(Le.apply(ee,{id:je,origin:ae,primitive:De,positionsCompressed:Ge,normalsCompressed:ne,colorsCompressed:ke,indices:ze,edgeIndices:Ne,positionsDecodeMatrix:L,color:Ue,metallic:Te,roughness:fe,opacity:pe})),he.push(je))}}he.length>0&&s.createEntity(Le.apply(J,{id:X,isObject:!0,meshIds:he}))}}}const qd={version:9,parse:function(r,e,i,s,t,o){const n=iF(i),a=sF(n);oF(r,e,a,s,t,o)}};let hr=window.pako||Oi;hr.inflate||(hr=hr.default);const Xi=c.vec4(),Jd=c.vec4(),nF=9;function aF(r){let e=0;return{metadata:r[e++],textureData:r[e++],eachTextureDataPortion:r[e++],eachTextureAttributes:r[e++],positions:r[e++],normals:r[e++],colors:r[e++],uvs:r[e++],indices:r[e++],edgeIndices:r[e++],eachTextureSetTextures:r[e++],matrices:r[e++],reusedGeometriesDecodeMatrix:r[e++],eachGeometryPrimitiveType:r[e++],eachGeometryPositionsPortion:r[e++],eachGeometryNormalsPortion:r[e++],eachGeometryColorsPortion:r[e++],eachGeometryUVsPortion:r[e++],eachGeometryIndicesPortion:r[e++],eachGeometryEdgeIndicesPortion:r[e++],eachMeshGeometriesPortion:r[e++],eachMeshMatricesPortion:r[e++],eachMeshTextureSet:r[e++],eachMeshMaterialAttributes:r[e++],eachEntityId:r[e++],eachEntityMeshesPortion:r[e++],eachTileAABB:r[e++],eachTileEntitiesPortion:r[e++]}}function AF(r){function e(i,s){return i.length===0?[]:hr.inflate(i,s).buffer}return{metadata:JSON.parse(hr.inflate(r.metadata,{to:"string"})),textureData:new Uint8Array(e(r.textureData)),eachTextureDataPortion:new Uint32Array(e(r.eachTextureDataPortion)),eachTextureAttributes:new Uint16Array(e(r.eachTextureAttributes)),positions:new Uint16Array(e(r.positions)),normals:new Int8Array(e(r.normals)),colors:new Uint8Array(e(r.colors)),uvs:new Float32Array(e(r.uvs)),indices:new Uint32Array(e(r.indices)),edgeIndices:new Uint32Array(e(r.edgeIndices)),eachTextureSetTextures:new Int32Array(e(r.eachTextureSetTextures)),matrices:new Float32Array(e(r.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(e(r.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(e(r.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(e(r.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(e(r.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(e(r.eachGeometryColorsPortion)),eachGeometryUVsPortion:new Uint32Array(e(r.eachGeometryUVsPortion)),eachGeometryIndicesPortion:new Uint32Array(e(r.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(e(r.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(e(r.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(e(r.eachMeshMatricesPortion)),eachMeshTextureSet:new Int32Array(e(r.eachMeshTextureSet)),eachMeshMaterialAttributes:new Uint8Array(e(r.eachMeshMaterialAttributes)),eachEntityId:JSON.parse(hr.inflate(r.eachEntityId,{to:"string"})),eachEntityMeshesPortion:new Uint32Array(e(r.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(e(r.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(e(r.eachTileEntitiesPortion))}}const lF=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();(function(){const r=document.createElement("canvas"),e=r.getContext("2d");return function(i){return r.width=i.width,r.height=i.height,e.putImageData(i,0,0),r.toDataURL()}})();function cF(r,e,i,s,t,o){const n=o.getNextId(),a=i.metadata,A=i.textureData,l=i.eachTextureDataPortion,h=i.eachTextureAttributes,d=i.positions,f=i.normals,m=i.colors,_=i.uvs,u=i.indices,P=i.edgeIndices,y=i.eachTextureSetTextures,x=i.matrices,B=i.reusedGeometriesDecodeMatrix,v=i.eachGeometryPrimitiveType,w=i.eachGeometryPositionsPortion,C=i.eachGeometryNormalsPortion,I=i.eachGeometryColorsPortion,E=i.eachGeometryUVsPortion,S=i.eachGeometryIndicesPortion,R=i.eachGeometryEdgeIndicesPortion,D=i.eachMeshGeometriesPortion,K=i.eachMeshMatricesPortion,G=i.eachMeshTextureSet,z=i.eachMeshMaterialAttributes,le=i.eachEntityId,ue=i.eachEntityMeshesPortion,ae=i.eachTileAABB,Pe=i.eachTileEntitiesPortion,be=l.length,xe=y.length/5,Ie=w.length,Fe=D.length,Qe=ue.length,Ve=Pe.length;t&&t.loadData(a,{includeTypes:e.includeTypes,excludeTypes:e.excludeTypes,globalizeObjectIds:e.globalizeObjectIds});for(let O=0;O<be;O++){const W=O===be-1,X=l[O],te=W?A.length:l[O+1],ie=te-X>0,oe=O*nF,he=h[oe+0]===1,ce=h[oe+1];h[oe+2],h[oe+3];const J=h[oe+4],ee=h[oe+5],ge=h[oe+6],re=h[oe+7],me=h[oe+8];if(ie){const Y=new Uint8Array(A.subarray(X,te)).buffer,Ue=`${n}-texture-${O}`;if(he)s.createTexture({id:Ue,buffers:[Y],minFilter:J,magFilter:ee,wrapS:ge,wrapT:re,wrapR:me});else{const pe=ce===H_?"image/jpeg":ce===V_?"image/png":"image/gif",Te=new Blob([Y],{type:pe}),je=(window.URL||window.webkitURL).createObjectURL(Te),Ae=document.createElement("img");Ae.src=je,s.createTexture({id:Ue,image:Ae,minFilter:J,magFilter:ee,wrapS:ge,wrapT:re,wrapR:me})}}}for(let O=0;O<xe;O++){const W=O*5,X=`${n}-textureSet-${O}`,te=y[W+0],se=y[W+1],ie=y[W+2],oe=y[W+3],he=y[W+4];s.createTextureSet({id:X,colorTextureId:te>=0?`${n}-texture-${te}`:null,normalsTextureId:ie>=0?`${n}-texture-${ie}`:null,metallicRoughnessTextureId:se>=0?`${n}-texture-${se}`:null,emissiveTextureId:oe>=0?`${n}-texture-${oe}`:null,occlusionTextureId:he>=0?`${n}-texture-${he}`:null})}const V=new Uint32Array(Ie);for(let O=0;O<Fe;O++){const W=D[O];V[W]!==void 0?V[W]++:V[W]=1}const Z=c.vec3(),L=c.AABB3(),Q={};for(let O=0;O<Ve;O++){const W=Ve-1,X=O===W,te=Pe[O],se=X?Qe-1:Pe[O+1]-1,ie=O*6,oe=ae.subarray(ie,ie+6);c.getAABB3Center(oe,Z),L[0]=oe[0]-Z[0],L[1]=oe[1]-Z[1],L[2]=oe[2]-Z[2],L[3]=oe[3]-Z[0],L[4]=oe[4]-Z[1],L[5]=oe[5]-Z[2];const he=st.createPositionsDecodeMatrix(L),ce={};for(let J=te;J<=se;J++){const ee=le[J],ge=e.globalizeObjectIds?c.globalizeObjectId(s.id,ee):ee,re=Qe-1,me=J===re,de=ue[J],Y=me?D.length-1:ue[J+1]-1,Ue=[],pe=r.metaScene.metaObjects[ge],Te={},fe={};if(pe){if(e.excludeTypesMap&&pe.type&&e.excludeTypesMap[pe.type]||e.includeTypesMap&&pe.type&&!e.includeTypesMap[pe.type])continue;const je=e.objectDefaults?e.objectDefaults[pe.type]||e.objectDefaults.DEFAULT:null;je&&(je.visible===!1&&(Te.visible=!1),je.pickable===!1&&(Te.pickable=!1),je.colorize&&(fe.color=je.colorize),je.opacity!==void 0&&je.opacity!==null&&(fe.opacity=je.opacity),je.metallic!==void 0&&je.metallic!==null&&(fe.metallic=je.metallic),je.roughness!==void 0&&je.roughness!==null&&(fe.roughness=je.roughness))}else if(e.excludeUnclassifiedObjects)continue;for(let je=de;je<=Y;je++){const Ae=D[je],Ge=V[Ae]>1,ne=Ae===Ie-1,ke=G[je],ze=ke>=0?`${n}-textureSet-${ke}`:null,Ne=lF(z.subarray(je*6,je*6+3)),tt=z[je*6+3]/255,$e=z[je*6+4]/255,at=z[je*6+5]/255,Ce=o.getNextId();if(Ge){const ot=K[je],Ye=x.slice(ot,ot+16),Se=`${n}-geometry.${O}.${Ae}`;let Be=Q[Se];if(!Be){Be={batchThisMesh:!e.reuseGeometries};const ht=v[Ae];let Mt=!1;switch(ht){case 0:Be.primitiveName="solid",Be.geometryPositions=d.subarray(w[Ae],ne?d.length:w[Ae+1]),Be.geometryNormals=f.subarray(C[Ae],ne?f.length:C[Ae+1]),Be.geometryUVs=_.subarray(E[Ae],ne?_.length:E[Ae+1]),Be.geometryIndices=u.subarray(S[Ae],ne?u.length:S[Ae+1]),Be.geometryEdgeIndices=P.subarray(R[Ae],ne?P.length:R[Ae+1]),Mt=Be.geometryPositions.length>0&&Be.geometryIndices.length>0;break;case 1:Be.primitiveName="surface",Be.geometryPositions=d.subarray(w[Ae],ne?d.length:w[Ae+1]),Be.geometryNormals=f.subarray(C[Ae],ne?f.length:C[Ae+1]),Be.geometryUVs=_.subarray(E[Ae],ne?_.length:E[Ae+1]),Be.geometryIndices=u.subarray(S[Ae],ne?u.length:S[Ae+1]),Be.geometryEdgeIndices=P.subarray(R[Ae],ne?P.length:R[Ae+1]),Mt=Be.geometryPositions.length>0&&Be.geometryIndices.length>0;break;case 2:Be.primitiveName="points",Be.geometryPositions=d.subarray(w[Ae],ne?d.length:w[Ae+1]),Be.geometryColors=m.subarray(I[Ae],ne?m.length:I[Ae+1]),Mt=Be.geometryPositions.length>0;break;case 3:Be.primitiveName="lines",Be.geometryPositions=d.subarray(w[Ae],ne?d.length:w[Ae+1]),Be.geometryIndices=u.subarray(S[Ae],ne?u.length:S[Ae+1]),Mt=Be.geometryPositions.length>0&&Be.geometryIndices.length>0;break;case 4:Be.primitiveName="lines",Be.geometryPositions=d.subarray(w[Ae],ne?d.length:w[Ae+1]),Be.geometryIndices=ep(Be.geometryPositions,u.subarray(S[Ae],ne?u.length:S[Ae+1])),Mt=Be.geometryPositions.length>0&&Be.geometryIndices.length>0;break;default:continue}if(Mt||(Be=null),Be&&(Be.geometryPositions.length>1e3,Be.batchThisMesh)){Be.decompressedPositions=new Float32Array(Be.geometryPositions.length),Be.transformedAndRecompressedPositions=new Uint16Array(Be.geometryPositions.length);const ut=Be.geometryPositions,gt=Be.decompressedPositions;for(let Ot=0,xi=ut.length;Ot<xi;Ot+=3)gt[Ot+0]=ut[Ot+0]*B[0]+B[12],gt[Ot+1]=ut[Ot+1]*B[5]+B[13],gt[Ot+2]=ut[Ot+2]*B[10]+B[14];Be.geometryPositions=null,Q[Se]=Be}}if(Be)if(Be.batchThisMesh){const ht=Be.decompressedPositions,Mt=Be.transformedAndRecompressedPositions;for(let ut=0,gt=ht.length;ut<gt;ut+=3)Xi[0]=ht[ut+0],Xi[1]=ht[ut+1],Xi[2]=ht[ut+2],Xi[3]=1,c.transformVec4(Ye,Xi,Jd),st.compressPosition(Jd,L,Xi),Mt[ut+0]=Xi[0],Mt[ut+1]=Xi[1],Mt[ut+2]=Xi[2];s.createMesh(Le.apply(fe,{id:Ce,textureSetId:ze,origin:Z,primitive:Be.primitiveName,positionsCompressed:Mt,normalsCompressed:Be.geometryNormals,uv:Be.geometryUVs,colorsCompressed:Be.geometryColors,indices:Be.geometryIndices,edgeIndices:Be.geometryEdgeIndices,positionsDecodeMatrix:he,color:Ne,metallic:$e,roughness:at,opacity:tt})),Ue.push(Ce)}else ce[Se]||(s.createGeometry({id:Se,primitive:Be.primitiveName,positionsCompressed:Be.geometryPositions,normalsCompressed:Be.geometryNormals,uv:Be.geometryUVs,colorsCompressed:Be.geometryColors,indices:Be.geometryIndices,edgeIndices:Be.geometryEdgeIndices,positionsDecodeMatrix:B}),ce[Se]=!0),s.createMesh(Le.apply(fe,{id:Ce,geometryId:Se,textureSetId:ze,matrix:Ye,color:Ne,metallic:$e,roughness:at,opacity:tt,origin:Z})),Ue.push(Ce)}else{const ot=v[Ae];let Ye,Se,Be,ht,Mt,ut,gt,Ot=!1;switch(ot){case 0:Ye="solid",Se=d.subarray(w[Ae],ne?d.length:w[Ae+1]),Be=f.subarray(C[Ae],ne?f.length:C[Ae+1]),ht=_.subarray(E[Ae],ne?_.length:E[Ae+1]),ut=u.subarray(S[Ae],ne?u.length:S[Ae+1]),gt=P.subarray(R[Ae],ne?P.length:R[Ae+1]),Ot=Se.length>0&&ut.length>0;break;case 1:Ye="surface",Se=d.subarray(w[Ae],ne?d.length:w[Ae+1]),Be=f.subarray(C[Ae],ne?f.length:C[Ae+1]),ht=_.subarray(E[Ae],ne?_.length:E[Ae+1]),ut=u.subarray(S[Ae],ne?u.length:S[Ae+1]),gt=P.subarray(R[Ae],ne?P.length:R[Ae+1]),Ot=Se.length>0&&ut.length>0;break;case 2:Ye="points",Se=d.subarray(w[Ae],ne?d.length:w[Ae+1]),Mt=m.subarray(I[Ae],ne?m.length:I[Ae+1]),Ot=Se.length>0;break;case 3:Ye="lines",Se=d.subarray(w[Ae],ne?d.length:w[Ae+1]),ut=u.subarray(S[Ae],ne?u.length:S[Ae+1]),Ot=Se.length>0&&ut.length>0;break;case 4:Ye="lines",Se=d.subarray(w[Ae],ne?d.length:w[Ae+1]),ut=ep(Se,u.subarray(S[Ae],ne?u.length:S[Ae+1])),Ot=Se.length>0&&ut.length>0;break;default:continue}Ot&&(s.createMesh(Le.apply(fe,{id:Ce,textureSetId:ze,origin:Z,primitive:Ye,positionsCompressed:Se,normalsCompressed:Be,uv:ht&&ht.length>0?ht:null,colorsCompressed:Mt,indices:ut,edgeIndices:gt,positionsDecodeMatrix:he,color:Ne,metallic:$e,roughness:at,opacity:tt})),Ue.push(Ce))}}Ue.length>0&&s.createEntity(Le.apply(Te,{id:ge,isObject:!0,meshIds:Ue}))}}}function ep(r,e){const i=[];if(e.length>1)for(let s=0,t=e.length-1;s<t;s++)i.push(e[s]),i.push(e[s+1]);else if(r.length>1)for(let s=0,t=r.length/3-1;s<t;s++)i.push(s),i.push(s+1);return i}const tp={version:10,parse:function(r,e,i,s,t,o){const n=aF(i),a=AF(n);cF(r,e,a,s,t,o)}},ki={};ki[Qd.version]=Qd;ki[Hd.version]=Hd;ki[Vd.version]=Vd;ki[jd.version]=jd;ki[Gd.version]=Gd;ki[zd.version]=zd;ki[Wd.version]=Wd;ki[$d.version]=$d;ki[qd.version]=qd;ki[tp.version]=tp;var jf={};(function(r){var e="File format is not recognized.",i="CRC failed.",s="File contains encrypted entry.",t="File is using Zip64 (4gb+ file size).",o="Error while reading zip file.",n="Error while writing zip file.",a="Error while writing file data.",A="Error while reading file data.",l="File already exists.",h=524288,d="text/plain",f;try{f=new Blob([new DataView(new ArrayBuffer(0))]).size===0}catch{}function m(){this.crc=-1}m.prototype.append=function(Q){for(var O=this.crc|0,W=this.table,X=0,te=Q.length|0;X<te;X++)O=O>>>8^W[(O^Q[X])&255];this.crc=O},m.prototype.get=function(){return~this.crc},m.prototype.table=function(){var L,Q,O,W=[];for(L=0;L<256;L++){for(O=L,Q=0;Q<8;Q++)O&1?O=O>>>1^3988292384:O=O>>>1;W[L]=O}return W}();function _(){}_.prototype.append=function(Q,O){return Q},_.prototype.flush=function(){};function u(L,Q,O){if(Q<0||O<0||Q+O>L.size)throw new RangeError("offset:"+Q+", length:"+O+", size:"+L.size);if(L.slice)return L.slice(Q,Q+O);if(L.webkitSlice)return L.webkitSlice(Q,Q+O);if(L.mozSlice)return L.mozSlice(Q,Q+O);if(L.msSlice)return L.msSlice(Q,Q+O)}function P(L,Q){var O,W;return O=new ArrayBuffer(L),W=new Uint8Array(O),Q&&W.set(Q,0),{buffer:O,array:W,view:new DataView(O)}}function y(){}function x(L){var Q=this,O;function W(te,se){var ie=new Blob([L],{type:d});O=new v(ie),O.init(function(){Q.size=O.size,te()},se)}function X(te,se,ie,oe){O.readUint8Array(te,se,ie,oe)}Q.size=0,Q.init=W,Q.readUint8Array=X}x.prototype=new y,x.prototype.constructor=x;function B(L){var Q=this,O;function W(te){for(var se=L.length;L.charAt(se-1)=="=";)se--;O=L.indexOf(",")+1,Q.size=Math.floor((se-O)*.75),te()}function X(te,se,ie){var oe,he=P(se),ce=Math.floor(te/3)*4,J=Math.ceil((te+se)/3)*4,ee=r.atob(L.substring(ce+O,J+O)),ge=te-Math.floor(ce/4)*3;for(oe=ge;oe<ge+se;oe++)he.array[oe-ge]=ee.charCodeAt(oe);ie(he.array)}Q.size=0,Q.init=W,Q.readUint8Array=X}B.prototype=new y,B.prototype.constructor=B;function v(L){var Q=this;function O(X){Q.size=L.size,X()}function W(X,te,se,ie){var oe=new FileReader;oe.onload=function(he){se(new Uint8Array(he.target.result))},oe.onerror=ie;try{oe.readAsArrayBuffer(u(L,X,te))}catch(he){ie(he)}}Q.size=0,Q.init=O,Q.readUint8Array=W}v.prototype=new y,v.prototype.constructor=v;function w(){}w.prototype.getData=function(L){L(this.data)};function C(L){var Q=this,O;function W(se){O=new Blob([],{type:d}),se()}function X(se,ie){O=new Blob([O,f?se:se.buffer],{type:d}),ie()}function te(se,ie){var oe=new FileReader;oe.onload=function(he){se(he.target.result)},oe.onerror=ie,oe.readAsText(O,L)}Q.init=W,Q.writeUint8Array=X,Q.getData=te}C.prototype=new w,C.prototype.constructor=C;function I(L){var Q=this,O="",W="";function X(ie){O+="data:"+(L||"")+";base64,",ie()}function te(ie,oe){var he,ce=W.length,J=W;for(W="",he=0;he<Math.floor((ce+ie.length)/3)*3-ce;he++)J+=String.fromCharCode(ie[he]);for(;he<ie.length;he++)W+=String.fromCharCode(ie[he]);J.length>2?O+=r.btoa(J):W=J,oe()}function se(ie){ie(O+r.btoa(W))}Q.init=X,Q.writeUint8Array=te,Q.getData=se}I.prototype=new w,I.prototype.constructor=I;function E(L){var Q,O=this;function W(se){Q=new Blob([],{type:L}),se()}function X(se,ie){Q=new Blob([Q,f?se:se.buffer],{type:L}),ie()}function te(se){se(Q)}O.init=W,O.writeUint8Array=X,O.getData=te}E.prototype=new w,E.prototype.constructor=E;function S(L,Q,O,W,X,te,se,ie,oe,he){var ce=0,J,ee,ge=Q.sn,re;function me(){L.removeEventListener("message",de,!1),ie(ee,re)}function de(Ue){var pe=Ue.data,Te=pe.data,fe=pe.error;if(fe){fe.toString=function(){return"Error: "+this.message},oe(fe);return}if(pe.sn===ge)switch(typeof pe.codecTime=="number"&&(L.codecTime+=pe.codecTime),typeof pe.crcTime=="number"&&(L.crcTime+=pe.crcTime),pe.type){case"append":Te?(ee+=Te.length,W.writeUint8Array(Te,function(){Y()},he)):Y();break;case"flush":re=pe.crc,Te?(ee+=Te.length,W.writeUint8Array(Te,function(){me()},he)):me();break;case"progress":se&&se(J+pe.loaded,te);break;case"importScripts":case"newTask":case"echo":break;default:console.warn("zip.js:launchWorkerProcess: unknown message: ",pe)}}function Y(){J=ce*h,J<=te?O.readUint8Array(X+J,Math.min(h,te-J),function(Ue){se&&se(J,te);var pe=J===0?Q:{sn:ge};pe.type="append",pe.data=Ue;try{L.postMessage(pe,[Ue.buffer])}catch{L.postMessage(pe)}ce++},oe):L.postMessage({sn:ge,type:"flush"})}ee=0,L.addEventListener("message",de,!1),Y()}function R(L,Q,O,W,X,te,se,ie,oe,he){var ce=0,J,ee=0,ge=te==="input",re=te==="output",me=new m;function de(){var Y;if(J=ce*h,J<X)Q.readUint8Array(W+J,Math.min(h,X-J),function(Ue){var pe;try{pe=L.append(Ue,function(Te){se&&se(J+Te,X)})}catch(Te){oe(Te);return}pe?(ee+=pe.length,O.writeUint8Array(pe,function(){ce++,setTimeout(de,1)},he),re&&me.append(pe)):(ce++,setTimeout(de,1)),ge&&me.append(Ue),se&&se(J,X)},oe);else{try{Y=L.flush()}catch(Ue){oe(Ue);return}Y?(re&&me.append(Y),ee+=Y.length,O.writeUint8Array(Y,function(){ie(ee,me.get())},he)):ie(ee,me.get())}}de()}function D(L,Q,O,W,X,te,se,ie,oe,he,ce){var J=se?"output":"none";if(r.zip.useWebWorkers){var ee={sn:Q,codecClass:"Inflater",crcType:J};S(L,ee,O,W,X,te,oe,ie,he,ce)}else R(new r.zip.Inflater,O,W,X,te,J,oe,ie,he,ce)}function K(L,Q,O,W,X,te,se,ie,oe){var he="input";if(r.zip.useWebWorkers){var ce={sn:Q,options:{level:X},codecClass:"Deflater",crcType:he};S(L,ce,O,W,0,O.size,se,te,ie,oe)}else R(new r.zip.Deflater,O,W,0,O.size,he,se,te,ie,oe)}function G(L,Q,O,W,X,te,se,ie,oe,he,ce){var J="input";if(r.zip.useWebWorkers&&se){var ee={sn:Q,codecClass:"NOOP",crcType:J};S(L,ee,O,W,X,te,oe,ie,he,ce)}else R(new _,O,W,X,te,J,oe,ie,he,ce)}function z(L){var Q,O="",W,X=["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","_","_","_","","","","","","","","","+","+","","","+","+","-","-","+","-","+","","","+","+","-","-","","-","+","","","","","","","i","","","","+","+","_","_","","","_","","","","","","","","","","","","","","","","","","","_","","","","","","","","","","","","_"," "];for(Q=0;Q<L.length;Q++)W=L.charCodeAt(Q)&255,W>127?O+=X[W-128]:O+=String.fromCharCode(W);return O}function le(L){return decodeURIComponent(escape(L))}function ue(L){var Q,O="";for(Q=0;Q<L.length;Q++)O+=String.fromCharCode(L[Q]);return O}function ae(L){var Q=(L&4294901760)>>16,O=L&65535;try{return new Date(1980+((Q&65024)>>9),((Q&480)>>5)-1,Q&31,(O&63488)>>11,(O&2016)>>5,(O&31)*2,0)}catch{}}function Pe(L,Q,O,W,X){if(L.version=Q.view.getUint16(O,!0),L.bitFlag=Q.view.getUint16(O+2,!0),L.compressionMethod=Q.view.getUint16(O+4,!0),L.lastModDateRaw=Q.view.getUint32(O+6,!0),L.lastModDate=ae(L.lastModDateRaw),(L.bitFlag&1)===1){X(s);return}if((W||(L.bitFlag&8)!=8)&&(L.crc32=Q.view.getUint32(O+10,!0),L.compressedSize=Q.view.getUint32(O+14,!0),L.uncompressedSize=Q.view.getUint32(O+18,!0)),L.compressedSize===4294967295||L.uncompressedSize===4294967295){X(t);return}L.filenameLength=Q.view.getUint16(O+22,!0),L.extraFieldLength=Q.view.getUint16(O+24,!0)}function be(L,Q,O){var W=0;function X(){}X.prototype.getData=function(ie,oe,he,ce){var J=this;function ee(de){var Y=P(4);return Y.view.setUint32(0,de),J.crc32==Y.view.getUint32(0)}function ge(de,Y){ce&&!ee(Y)?O(i):ie.getData(function(Ue){oe(Ue)})}function re(de){O(de||A)}function me(de){O(de||a)}L.readUint8Array(J.offset,30,function(de){var Y=P(de.length,de),Ue;if(Y.view.getUint32(0)!=1347093252){O(e);return}Pe(J,Y,4,!1,O),Ue=J.offset+30+J.filenameLength+J.extraFieldLength,ie.init(function(){J.compressionMethod===0?G(J._worker,W++,L,ie,Ue,J.compressedSize,ce,ge,he,re,me):D(J._worker,W++,L,ie,Ue,J.compressedSize,ce,ge,he,re,me)},me)},re)};function te(ie){var oe=22;if(L.size<oe){O(e);return}var he=256*256,ce=oe+he;J(oe,function(){J(Math.min(ce,L.size),function(){O(e)})});function J(ee,ge){L.readUint8Array(L.size-ee,ee,function(re){for(var me=re.length-oe;me>=0;me--)if(re[me]===80&&re[me+1]===75&&re[me+2]===5&&re[me+3]===6){ie(new DataView(re.buffer,me,oe));return}ge()},function(){O(o)})}}var se={getEntries:function(ie){var oe=this._worker;te(function(he){var ce,J;if(ce=he.getUint32(16,!0),J=he.getUint16(8,!0),ce<0||ce>=L.size){O(e);return}L.readUint8Array(ce,L.size-ce,function(ee){var ge,re=0,me=[],de,Y,Ue,pe=P(ee.length,ee);for(ge=0;ge<J;ge++){if(de=new X,de._worker=oe,pe.view.getUint32(re)!=1347092738){O(e);return}Pe(de,pe,re+6,!0,O),de.commentLength=pe.view.getUint16(re+32,!0),de.directory=(pe.view.getUint8(re+38)&16)==16,de.offset=pe.view.getUint32(re+42,!0),Y=ue(pe.array.subarray(re+46,re+46+de.filenameLength)),de.filename=(de.bitFlag&2048)===2048?le(Y):z(Y),!de.directory&&de.filename.charAt(de.filename.length-1)=="/"&&(de.directory=!0),Ue=ue(pe.array.subarray(re+46+de.filenameLength+de.extraFieldLength,re+46+de.filenameLength+de.extraFieldLength+de.commentLength)),de.comment=(de.bitFlag&2048)===2048?le(Ue):z(Ue),me.push(de),re+=46+de.filenameLength+de.extraFieldLength+de.commentLength}ie(me)},function(){O(o)})})},close:function(ie){this._worker&&(this._worker.terminate(),this._worker=null),ie&&ie()},_worker:null};r.zip.useWebWorkers?V("inflater",function(ie){se._worker=ie,Q(se)},function(ie){O(ie)}):Q(se)}function xe(L){return unescape(encodeURIComponent(L))}function Ie(L){var Q,O=[];for(Q=0;Q<L.length;Q++)O.push(L.charCodeAt(Q));return O}function Fe(L,Q,O,W){var X={},te=[],se=0,ie=0;function oe(J){O(J||n)}function he(J){O(J||A)}var ce={add:function(J,ee,ge,re,me){var de,Y,Ue,pe=this._worker;function Te(Ae){var De;Ue=me.lastModDate||new Date,de=P(26),X[J]={headerArray:de.array,directory:me.directory,filename:Y,offset:se,comment:Ie(xe(me.comment||""))},de.view.setUint32(0,335546376),me.version&&de.view.setUint8(0,me.version),!W&&me.level!==0&&!me.directory&&de.view.setUint16(4,2048),de.view.setUint16(6,(Ue.getHours()<<6|Ue.getMinutes())<<5|Ue.getSeconds()/2,!0),de.view.setUint16(8,(Ue.getFullYear()-1980<<4|Ue.getMonth()+1)<<5|Ue.getDate(),!0),de.view.setUint16(22,Y.length,!0),De=P(30+Y.length),De.view.setUint32(0,1347093252),De.array.set(de.array,4),De.array.set(Y,30),se+=De.array.length,L.writeUint8Array(De.array,Ae,oe)}function fe(Ae,De){var Ge=P(16);se+=Ae||0,Ge.view.setUint32(0,1347094280),typeof De<"u"&&(de.view.setUint32(10,De,!0),Ge.view.setUint32(4,De,!0)),ee&&(Ge.view.setUint32(8,Ae,!0),de.view.setUint32(14,Ae,!0),Ge.view.setUint32(12,ee.size,!0),de.view.setUint32(18,ee.size,!0)),L.writeUint8Array(Ge.array,function(){se+=16,ge()},oe)}function je(){if(me=me||{},J=J.trim(),me.directory&&J.charAt(J.length-1)!="/"&&(J+="/"),X.hasOwnProperty(J)){O(l);return}Y=Ie(xe(J)),te.push(J),Te(function(){ee?W||me.level===0?G(pe,ie++,ee,L,0,ee.size,!0,fe,re,he,oe):K(pe,ie++,ee,L,me.level,fe,re,he,oe):fe()})}ee?ee.init(je,he):je()},close:function(J){this._worker&&(this._worker.terminate(),this._worker=null);var ee,ge=0,re=0,me,de;for(me=0;me<te.length;me++)de=X[te[me]],ge+=46+de.filename.length+de.comment.length;for(ee=P(ge+22),me=0;me<te.length;me++)de=X[te[me]],ee.view.setUint32(re,1347092738),ee.view.setUint16(re+4,5120),ee.array.set(de.headerArray,re+6),ee.view.setUint16(re+32,de.comment.length,!0),de.directory&&ee.view.setUint8(re+38,16),ee.view.setUint32(re+42,de.offset,!0),ee.array.set(de.filename,re+46),ee.array.set(de.comment,re+46+de.filename.length),re+=46+de.filename.length+de.comment.length;ee.view.setUint32(re,1347093766),ee.view.setUint16(re+8,te.length,!0),ee.view.setUint16(re+10,te.length,!0),ee.view.setUint32(re+12,ge,!0),ee.view.setUint32(re+16,se,!0),L.writeUint8Array(ee.array,function(){L.getData(J)},oe)},_worker:null};r.zip.useWebWorkers?V("deflater",function(J){ce._worker=J,Q(ce)},function(J){O(J)}):Q(ce)}function Qe(L){var Q=document.createElement("a");return L.map(function(O){return Q.href=O,Q.href})}var Ve={deflater:["z-worker.js","deflate.js"],inflater:["z-worker.js","inflate.js"]};function V(L,Q,O){if(r.zip.workerScripts!==null&&r.zip.workerScriptsPath!==null){O(new Error("Either zip.workerScripts or zip.workerScriptsPath may be set, not both."));return}var W;if(r.zip.workerScripts){if(W=r.zip.workerScripts[L],!Array.isArray(W)){O(new Error("zip.workerScripts."+L+" is not an array!"));return}W=Qe(W)}else W=Ve[L].slice(0),W[0]=(r.zip.workerScriptsPath||"")+W[0];var X=new Worker(W[0]);X.codecTime=X.crcTime=0,X.postMessage({type:"importScripts",scripts:W.slice(1)}),X.addEventListener("message",te);function te(ie){var oe=ie.data;if(oe.error){X.terminate(),O(oe.error);return}oe.type==="importScripts"&&(X.removeEventListener("message",te),X.removeEventListener("error",se),Q(X))}X.addEventListener("error",se);function se(ie){X.terminate(),O(ie)}}function Z(L){console.error(L)}r.zip={Reader:y,Writer:w,BlobReader:v,Data64URIReader:B,TextReader:x,BlobWriter:E,Data64URIWriter:I,TextWriter:C,createReader:function(L,Q,O){O=O||Z,L.init(function(){be(L,Q,O)},O)},createWriter:function(L,Q,O,W){O=O||Z,W=!!W,L.init(function(){Fe(L,Q,O,W)},O)},useWebWorkers:!0,workerScriptsPath:null,workerScripts:null}})(jf);const hF=function(r){var e="HTTP Range not supported.",i=r.Reader,s=r.Writer,t,o;try{o=new Blob([new DataView(new ArrayBuffer(0))]).size===0}catch{}function n(f){var m=document.createElement("a");return m.href=f,m.protocol==="http:"||m.protocol==="https:"}function a(f){var m=this;function _(y,x){var B;m.data?y():(B=new XMLHttpRequest,B.addEventListener("load",function(){m.size||(m.size=Number(B.getResponseHeader("Content-Length"))||Number(B.response.byteLength)),m.data=new Uint8Array(B.response),y()},!1),B.addEventListener("error",x,!1),B.open("GET",f),B.responseType="arraybuffer",B.send())}function u(y,x){if(!n(f)){_(y,x);return}var B=new XMLHttpRequest;B.addEventListener("load",function(){m.size=Number(B.getResponseHeader("Content-Length")),m.size?y():_(y,x)},!1),B.addEventListener("error",x,!1),B.open("HEAD",f),B.send()}function P(y,x,B,v){_(function(){B(new Uint8Array(m.data.subarray(y,y+x)))},v)}m.size=0,m.init=u,m.readUint8Array=P}a.prototype=new i,a.prototype.constructor=a;function A(f){var m=this;function _(y,x){var B=new XMLHttpRequest;B.addEventListener("load",function(){m.size=Number(B.getResponseHeader("Content-Length")),B.getResponseHeader("Accept-Ranges")=="bytes"?y():x(e)},!1),B.addEventListener("error",x,!1),B.open("HEAD",f),B.send()}function u(y,x,B,v){var w=new XMLHttpRequest;w.open("GET",f),w.responseType="arraybuffer",w.setRequestHeader("Range","bytes="+y+"-"+(y+x-1)),w.addEventListener("load",function(){B(w.response)},!1),w.addEventListener("error",v,!1),w.send()}function P(y,x,B,v){u(y,x,function(w){B(new Uint8Array(w))},v)}m.size=0,m.init=_,m.readUint8Array=P}A.prototype=new i,A.prototype.constructor=A;function l(f){var m=this;function _(P,y){m.size=f.byteLength,P()}function u(P,y,x,B){x(new Uint8Array(f.slice(P,P+y)))}m.size=0,m.init=_,m.readUint8Array=u}l.prototype=new i,l.prototype.constructor=l;function h(){var f,m=this;function _(y,x){f=new Uint8Array,y()}function u(y,x,B){var v=new Uint8Array(f.length+y.length);v.set(f),v.set(y,f.length),f=v,x()}function P(y){y(f.buffer)}m.init=_,m.writeUint8Array=u,m.getData=P}h.prototype=new s,h.prototype.constructor=h;function d(f,m){var _,u=this;function P(B,v){f.createWriter(function(w){_=w,B()},v)}function y(B,v,w){var C=new Blob([o?B:B.buffer],{type:m});_.onwrite=function(){_.onwrite=null,v()},_.onerror=w,_.write(C)}function x(B){f.file(B)}u.init=P,u.writeUint8Array=y,u.getData=x}d.prototype=new s,d.prototype.constructor=d,r.FileWriter=d,r.HttpReader=a,r.HttpRangeReader=A,r.ArrayBufferReader=l,r.ArrayBufferWriter=h,r.fs&&(t=r.fs.ZipDirectoryEntry,t.prototype.addHttpContent=function(f,m,_){function u(P,y,x,B){if(P.directory)return B?new t(P.fs,y,x,P):new r.fs.ZipFileEntry(P.fs,y,x,P);throw"Parent entry is not a directory."}return u(this,f,{data:m,Reader:_?A:a})},t.prototype.importHttpContent=function(f,m,_,u){this.importZip(m?new A(f):new a(f),_,u)},r.fs.FS.prototype.importHttpContent=function(f,m,_,u){this.entries=[],this.root=new t(this),this.root.importHttpContent(f,m,_,u)})},uF=jf.zip;hF(uF);class dF{constructor(){}getIFC(e,i,s){var t=()=>{};i=i||t,s=s||t;const o=/^data:(.*?)(;base64)?,(.*)$/,n=e.match(o);if(n){const l=!!n[2];var a=n[3];a=window.decodeURIComponent(a),l&&(a=window.atob(a));try{const h=new ArrayBuffer(a.length),d=new Uint8Array(h);for(var A=0;A<a.length;A++)d[A]=a.charCodeAt(A);i(h)}catch(h){s(h)}}else{const l=new XMLHttpRequest;l.open("GET",e,!0),l.responseType="arraybuffer",l.onreadystatechange=function(){l.readyState===4&&(l.status===200?i(l.response):s("getXKT error : "+l.response))},l.send(null)}}}class pF extends Ap{constructor(e,i={}){if(super("ifcLoader",e,i),this.dataSource=i.dataSource,this.objectDefaults=i.objectDefaults,this.includeTypes=i.includeTypes,this.excludeTypes=i.excludeTypes,this.excludeUnclassifiedObjects=i.excludeUnclassifiedObjects,!i.WebIFC)throw"Parameter expected: WebIFC";if(!i.IfcAPI)throw"Parameter expected: IfcAPI";this._webIFC=i.WebIFC,this._ifcAPI=i.IfcAPI}get supportedVersions(){return["2x3","4"]}get dataSource(){return this._dataSource}set dataSource(e){this._dataSource=e||new dF}get objectDefaults(){return this._objectDefaults}set objectDefaults(e){this._objectDefaults=e||BI}get includeTypes(){return this._includeTypes}set includeTypes(e){this._includeTypes=e}get excludeTypes(){return this._excludeTypes}set excludeTypes(e){this._excludeTypes=e}get excludeUnclassifiedObjects(){return this._excludeUnclassifiedObjects}set excludeUnclassifiedObjects(e){this._excludeUnclassifiedObjects=!!e}get globalizeObjectIds(){return this._globalizeObjectIds}set globalizeObjectIds(e){this._globalizeObjectIds=!!e}load(e={}){e.id&&this.viewer.scene.components[e.id]&&(this.error("Component with this ID already exists in viewer: "+e.id+" - will autogenerate this ID"),delete e.id);const i=new Ry(this.viewer.scene,Le.apply(e,{isModel:!0}));if(!e.src&&!e.ifc)return this.error("load() param expected: src or IFC"),i;const s={autoNormals:!0};if(e.loadMetadata!==!1){const t=e.includeTypes||this._includeTypes,o=e.excludeTypes||this._excludeTypes,n=e.objectDefaults||this._objectDefaults;if(t){s.includeTypesMap={};for(let a=0,A=t.length;a<A;a++)s.includeTypesMap[t[a]]=!0}if(o){s.excludeTypesMap={};for(let a=0,A=o.length;a<A;a++)s.excludeTypesMap[o[a]]=!0}n&&(s.objectDefaults=n),s.excludeUnclassifiedObjects=e.excludeUnclassifiedObjects!==void 0?!!e.excludeUnclassifiedObjects:this._excludeUnclassifiedObjects,s.globalizeObjectIds=e.globalizeObjectIds!==void 0?!!e.globalizeObjectIds:this._globalizeObjectIds}try{e.src?this._loadModel(e.src,e,s,i):this._parseModel(e.ifc,e,s,i)}catch(t){this.error(t),i.fire("error",t)}return i}_loadModel(e,i,s,t){const o=this.viewer.scene.canvas.spinner;o.processes++,this._dataSource.getIFC(i.src,n=>{this._parseModel(n,i,s,t),o.processes--},n=>{o.processes--,this.error(n),t.fire("error",n)})}_parseModel(e,i,s,t){if(t.destroyed)return;const o=i.stats||{};if(o.sourceFormat="IFC",o.schemaVersion="",o.title="",o.author="",o.created="",o.numMetaObjects=0,o.numPropertySets=0,o.numObjects=0,o.numGeometries=0,o.numTriangles=0,o.numVertices=0,!this._ifcAPI)throw"WebIFCLoaderPlugin has no WebIFC instance configured - please inject via WebIFCLoaderPlugin constructor";const n=new Uint8Array(e),a=this._ifcAPI.OpenModel(n),A=this._ifcAPI.GetModelSchema(a),h=this._ifcAPI.GetLineIDsWithType(a,this._webIFC.IFCPROJECT).get(0),d=i.loadMetadata!==!1,f=d?{id:"",projectId:""+h,author:"",createdAt:"",schema:"",creatingApplication:"",metaObjects:[],propertySets:[]}:null,m={modelID:a,modelSchema:A,sceneModel:t,loadMetadata:d,metadata:f,metaObjects:{},options:s,log:function(_){},nextId:0,stats:o};if(d){if(s.includeTypes){m.includeTypes={};for(let _=0,u=s.includeTypes.length;_<u;_++)m.includeTypes[s.includeTypes[_]]=!0}if(s.excludeTypes){m.excludeTypes={};for(let _=0,u=s.excludeTypes.length;_<u;_++)m.excludeTypes[s.excludeTypes[_]]=!0}this._parseMetaObjects(m),this._parsePropertySets(m)}if(this._parseGeometry(m),t.finalize(),d){const _=t.id;this.viewer.metaScene.createMetaModel(_,m.metadata,s)}t.scene.once("tick",()=>{t.destroyed||(t.scene.fire("modelLoaded",t.id),t.fire("loaded",!0,!1))})}_parseMetaObjects(e){const s=this._ifcAPI.GetLineIDsWithType(e.modelID,this._webIFC.IFCPROJECT).get(0),t=this._ifcAPI.GetLine(e.modelID,s);this._parseSpatialChildren(e,t)}_parseSpatialChildren(e,i,s){const t=this._ifcAPI.GetNameFromTypeCode(i.type);if(e.includeTypes&&!e.includeTypes[t]||e.excludeTypes&&e.excludeTypes[t])return;this._createMetaObject(e,i,s);const o=i.GlobalId.value;this._parseRelatedItemsOfType(e,i.expressID,"RelatingObject","RelatedObjects",this._webIFC.IFCRELAGGREGATES,o),this._parseRelatedItemsOfType(e,i.expressID,"RelatingStructure","RelatedElements",this._webIFC.IFCRELCONTAINEDINSPATIALSTRUCTURE,o)}_createMetaObject(e,i,s){const t=i.GlobalId.value,o=this._ifcAPI.GetNameFromTypeCode(i.type),n=i.Name&&i.Name.value!==""?i.Name.value:o,a={id:t,name:n,type:o,parent:s};e.metadata.metaObjects.push(a),e.metaObjects[t]=a,e.stats.numMetaObjects++}_parseRelatedItemsOfType(e,i,s,t,o,n){const a=this._ifcAPI.GetLineIDsWithType(e.modelID,o);for(let A=0;A<a.size();A++){const l=a.get(A),h=this._ifcAPI.GetLine(e.modelID,l),d=h[s];let f=!1;if(Array.isArray(d)?f=d.map(_=>_.value).includes(i):f=d.value===i,f){const m=h[t];if(Array.isArray(m))m.forEach(_=>{const u=this._ifcAPI.GetLine(e.modelID,_.value);this._parseSpatialChildren(e,u,n)});else{const _=this._ifcAPI.GetLine(e.modelID,m.value);this._parseSpatialChildren(e,_,n)}}}}_parsePropertySets(e){const i=this._ifcAPI.GetLineIDsWithType(e.modelID,this._webIFC.IFCRELDEFINESBYPROPERTIES);for(let s=0;s<i.size();s++){let t=i.get(s),o=this._ifcAPI.GetLine(e.modelID,t,!0);if(o){const n=o.RelatingPropertyDefinition;if(!n)continue;const a=n.GlobalId.value,A=n.HasProperties;if(A&&A.length>0){const l="Default",h=n.Name.value,d=[];for(let _=0,u=A.length;_<u;_++){const P=A[_],y=P.Name,x=P.NominalValue;if(y&&x){const B={name:y.value,type:x.type,value:x.value,valueType:x.valueType};P.Description?B.description=P.Description.value:x.description&&(B.description=x.description),d.push(B)}}const f={id:a,type:l,name:h,properties:d};e.metadata.propertySets.push(f),e.stats.numPropertySets++;const m=o.RelatedObjects;if(!m||m.length===0)return;for(let _=0,u=m.length;_<u;_++){const y=m[_].GlobalId.value,x=e.metaObjects[y];x&&(x.propertySetIds||(x.propertySetIds=[]),x.propertySetIds.push(a))}}}}}_parseGeometry(e){this._ifcAPI.StreamAllMeshes(e.modelID,i=>{const s=i.expressID,t=i.geometries,o=[],a=this._ifcAPI.GetLine(e.modelID,s).GlobalId.value;if(e.loadMetadata){const d=a,f=e.metaObjects[d];if(e.includeTypes&&(!f||!e.includeTypes[f.type])||e.excludeTypes&&(!f||e.excludeTypes[f.type]))return}const A=c.mat4(),l=c.vec3();for(let d=0,f=t.size();d<f;d++){const m=t.get(d),_=this._ifcAPI.GetGeometry(e.modelID,m.geometryExpressID),u=this._ifcAPI.GetVertexArray(_.GetVertexData(),_.GetVertexDataSize()),P=this._ifcAPI.GetIndexArray(_.GetIndexData(),_.GetIndexDataSize()),y=new Float64Array(u.length/2),x=new Float32Array(u.length/2);for(let w=0,C=0,I=u.length/6;w<I;w++,C+=3)y[C+0]=u[w*6+0],y[C+1]=u[w*6+1],y[C+2]=u[w*6+2];A.set(m.flatTransformation),c.transformPositions3(A,y);const B=LA(y,y,l);if(!e.options.autoNormals)for(let w=0,C=0,I=u.length/6;w<I;w++,C+=3)x[C+0]=u[w*6+3],x[C+1]=u[w*6+4],x[C+2]=u[w*6+5];e.stats.numGeometries++,e.stats.numVertices+=y.length/3,e.stats.numTriangles+=P.length/3;const v="mesh"+e.nextId++;e.sceneModel.createMesh({id:v,primitive:"triangles",origin:B?l:null,positions:y,normals:e.options.autoNormals?null:x,indices:P,color:[m.color.x,m.color.y,m.color.z],opacity:m.color.w}),o.push(v)}const h=e.options.globalizeObjectIds?c.globalizeObjectId(e.sceneModel.id,a):a;e.sceneModel.createEntity({id:h,meshIds:o,isObject:!0}),e.stats.numObjects++})}}c.vec2();c.vec3();c.vec3();c.vec3();var fF=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function gF(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var Gf={exports:{}};(function(r,e){(function(i,s){r.exports=s()})(fF,function(){var i=function(){function s(m){return n.appendChild(m.dom),m}function t(m){for(var _=0;_<n.children.length;_++)n.children[_].style.display=_===m?"block":"none";o=m}var o=0,n=document.createElement("div");n.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",n.addEventListener("click",function(m){m.preventDefault(),t(++o%n.children.length)},!1);var a=(performance||Date).now(),A=a,l=0,h=s(new i.Panel("FPS","#0ff","#002")),d=s(new i.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var f=s(new i.Panel("MB","#f08","#201"));return t(0),{REVISION:16,dom:n,addPanel:s,showPanel:t,begin:function(){a=(performance||Date).now()},end:function(){l++;var m=(performance||Date).now();if(d.update(m-a,200),m>A+1e3&&(h.update(1e3*l/(m-A),100),A=m,l=0,f)){var _=performance.memory;f.update(_.usedJSHeapSize/1048576,_.jsHeapSizeLimit/1048576)}return m},update:function(){a=this.end()},domElement:n,setMode:t}};return i.Panel=function(s,t,o){var n=1/0,a=0,A=Math.round,l=A(window.devicePixelRatio||1),h=80*l,d=48*l,f=3*l,m=2*l,_=3*l,u=15*l,P=74*l,y=30*l,x=document.createElement("canvas");x.width=h,x.height=d,x.style.cssText="width:80px;height:48px";var B=x.getContext("2d");return B.font="bold "+9*l+"px Helvetica,Arial,sans-serif",B.textBaseline="top",B.fillStyle=o,B.fillRect(0,0,h,d),B.fillStyle=t,B.fillText(s,f,m),B.fillRect(_,u,P,y),B.fillStyle=o,B.globalAlpha=.9,B.fillRect(_,u,P,y),{dom:x,update:function(v,w){n=Math.min(n,v),a=Math.max(a,v),B.fillStyle=o,B.globalAlpha=1,B.fillRect(0,0,h,u),B.fillStyle=t,B.fillText(A(v)+" "+s+" ("+A(n)+"-"+A(a)+")",f,m),B.drawImage(x,_+l,u,P-l,y,_,u,P-l,y),B.fillRect(_+P-l,u,l,y),B.fillStyle=o,B.globalAlpha=.9,B.fillRect(_+P-l,u,l,A((1-v/w)*y))}}},i})})(Gf);var mF=Gf.exports;const _F=gF(mF);function vF(r){const e=new xI(r,{containerElement:document.getElementById("treeViewContainer"),hierarchy:"types",autoExpandDepth:1}),i=new RA({items:[[{title:"View Fit",doAction:function(s){const t=s.viewer.scene,o=[];s.treeViewPlugin.withNodeTree(s.treeViewNode,n=>{n.objectId&&o.push(n.objectId)}),t.setObjectsVisible(o,!0),t.setObjectsHighlighted(o,!0),s.viewer.cameraFlight.flyTo({projection:"perspective",aabb:t.getAABB(o),duration:.5},()=>{setTimeout(function(){t.setObjectsHighlighted(t.highlightedObjectIds,!1)},500)})}},{title:"View Fit All",doAction:function(s){const t=s.viewer.scene;s.viewer.cameraFlight.flyTo({projection:"perspective",aabb:t.getAABB({}),duration:.5})}}],[{title:"Hide",doAction:function(s){s.treeViewPlugin.withNodeTree(s.treeViewNode,t=>{if(t.objectId){const o=s.viewer.scene.objects[t.objectId];o&&(o.visible=!1)}})}},{title:"Hide Others",doAction:function(s){const t=s.viewer.scene;t.setObjectsVisible(t.visibleObjectIds,!1),t.setObjectsXRayed(t.xrayedObjectIds,!1),t.setObjectsSelected(t.selectedObjectIds,!1),t.setObjectsHighlighted(t.highlightedObjectIds,!1),s.treeViewPlugin.withNodeTree(s.treeViewNode,o=>{if(o.objectId){const n=t.objects[o.objectId];n&&(n.visible=!0)}})}},{title:"Hide All",getEnabled:function(s){return s.viewer.scene.visibleObjectIds.length>0},doAction:function(s){s.viewer.scene.setObjectsVisible(s.viewer.scene.visibleObjectIds,!1)}}],[{title:"Show",doAction:function(s){s.treeViewPlugin.withNodeTree(s.treeViewNode,t=>{if(t.objectId){const o=s.viewer.scene.objects[t.objectId];o&&(o.visible=!0,o.xrayed=!1,o.selected=!1)}})}},{title:"Show Others",doAction:function(s){const t=s.viewer.scene;t.setObjectsVisible(t.objectIds,!0),t.setObjectsXRayed(t.xrayedObjectIds,!1),t.setObjectsSelected(t.selectedObjectIds,!1),s.treeViewPlugin.withNodeTree(s.treeViewNode,o=>{if(o.objectId){const n=t.objects[o.objectId];n&&(n.visible=!1)}})}},{title:"Show All",getEnabled:function(s){const t=s.viewer.scene;return t.numVisibleObjects<t.numObjects},doAction:function(s){const t=s.viewer.scene;t.setObjectsVisible(t.objectIds,!0),t.setObjectsXRayed(t.xrayedObjectIds,!1),t.setObjectsSelected(t.selectedObjectIds,!1)}}],[{title:"X-Ray",doAction:function(s){s.treeViewPlugin.withNodeTree(s.treeViewNode,t=>{if(t.objectId){const o=s.viewer.scene.objects[t.objectId];o&&(o.xrayed=!0,o.visible=!0)}})}},{title:"Undo X-Ray",doAction:function(s){s.treeViewPlugin.withNodeTree(s.treeViewNode,t=>{if(t.objectId){const o=s.viewer.scene.objects[t.objectId];o&&(o.xrayed=!1)}})}},{title:"X-Ray Others",doAction:function(s){const t=s.viewer.scene;t.setObjectsVisible(t.objectIds,!0),t.setObjectsXRayed(t.objectIds,!0),t.setObjectsSelected(t.selectedObjectIds,!1),t.setObjectsHighlighted(t.highlightedObjectIds,!1),s.treeViewPlugin.withNodeTree(s.treeViewNode,o=>{if(o.objectId){const n=t.objects[o.objectId];n&&(n.xrayed=!1)}})}},{title:"Reset X-Ray",getEnabled:function(s){return s.viewer.scene.numXRayedObjects>0},doAction:function(s){s.viewer.scene.setObjectsXRayed(s.viewer.scene.xrayedObjectIds,!1)}}],[{title:"Select",doAction:function(s){s.treeViewPlugin.withNodeTree(s.treeViewNode,t=>{if(t.objectId){const o=s.viewer.scene.objects[t.objectId];o&&(o.selected=!0,o.visible=!0)}})}},{title:"Deselect",doAction:function(s){s.treeViewPlugin.withNodeTree(s.treeViewNode,t=>{if(t.objectId){const o=s.viewer.scene.objects[t.objectId];o&&(o.selected=!1)}})}},{title:"Clear Selection",getEnabled:function(s){return s.viewer.scene.numSelectedObjects>0},doAction:function(s){s.viewer.scene.setObjectsSelected(s.viewer.scene.selectedObjectIds,!1)}}]]});return e.on("contextmenu",s=>{i.context={viewer:s.viewer,treeViewPlugin:s.treeViewPlugin,treeViewNode:s.treeViewNode,entity:s.viewer.scene.objects[s.treeViewNode.objectId]},i.show(s.event.pageX,s.event.pageY)}),e.on("nodeTitleClicked",s=>{var A;const t=r.scene,o=[];s.treeViewPlugin.withNodeTree(s.treeViewNode,l=>{l.objectId&&o.push(l.objectId)}),r.cameraFlight.flyTo({aabb:t.getAABB(o),duration:.5});const n=((A=r.metaScene.metaObjects[s.treeViewNode.objectId])==null?void 0:A.propertySets)??[],a={};for(const l of n)for(const h of l.properties)a[h.name]=h.value;console.log(a)}),e}function PF(r,e){const i=new RA({enabled:!0,context:{viewer:r},items:[[{title:"Hide All",getEnabled:function(a){return a.viewer.scene.numVisibleObjects>0},doAction:function(a){a.viewer.scene.setObjectsVisible(a.viewer.scene.visibleObjectIds,!1)}},{title:"Show All",getEnabled:function(a){const A=a.viewer.scene;return A.numVisibleObjects<A.numObjects},doAction:function(a){const A=a.viewer.scene;A.setObjectsVisible(A.objectIds,!0),A.setObjectsXRayed(A.xrayedObjectIds,!1),A.setObjectsSelected(A.selectedObjectIds,!1)}}],[{title:"View Fit All",doAction:function(a){a.viewer.cameraFlight.flyTo({aabb:a.viewer.scene.getAABB()})}}]]}),s=new RA({items:[[{title:"View Fit",doAction:function(a){const A=a.viewer,l=A.scene,h=a.entity;A.cameraFlight.flyTo({aabb:h.aabb,duration:.5},()=>{setTimeout(function(){l.setObjectsHighlighted(l.highlightedObjectIds,!1)},500)})}},{title:"View Fit All",doAction:function(a){const A=a.viewer.scene;a.viewer.cameraFlight.flyTo({projection:"perspective",aabb:A.getAABB(),duration:.5})}},{title:"Show in Tree",doAction:function(a){const A=a.entity.id;a.treeViewPlugin.showNode(A)}}],[{title:"Hide",getEnabled:function(a){return a.entity.visible},doAction:function(a){a.entity.visible=!1}},{title:"Hide Others",doAction:function(a){const A=a.viewer,l=A.scene,h=a.entity,d=A.metaScene.metaObjects[h.id];d&&(l.setObjectsVisible(l.visibleObjectIds,!1),l.setObjectsXRayed(l.xrayedObjectIds,!1),l.setObjectsSelected(l.selectedObjectIds,!1),l.setObjectsHighlighted(l.highlightedObjectIds,!1),d.withMetaObjectsInSubtree(f=>{const m=l.objects[f.id];m&&(m.visible=!0)}))}},{title:"Hide All",getEnabled:function(a){return a.viewer.scene.numVisibleObjects>0},doAction:function(a){a.viewer.scene.setObjectsVisible(a.viewer.scene.visibleObjectIds,!1)}},{title:"Show All",getEnabled:function(a){const A=a.viewer.scene;return A.numVisibleObjects<A.numObjects},doAction:function(a){const A=a.viewer.scene;A.setObjectsVisible(A.objectIds,!0)}}],[{title:"X-Ray",getEnabled:function(a){return!a.entity.xrayed},doAction:function(a){a.entity.xrayed=!0}},{title:"Undo X-Ray",getEnabled:function(a){return a.entity.xrayed},doAction:function(a){a.entity.xrayed=!1}},{title:"X-Ray Others",doAction:function(a){const A=a.viewer,l=A.scene,h=a.entity,d=A.metaScene.metaObjects[h.id];d&&(l.setObjectsVisible(l.objectIds,!0),l.setObjectsXRayed(l.objectIds,!0),l.setObjectsSelected(l.selectedObjectIds,!1),l.setObjectsHighlighted(l.highlightedObjectIds,!1),d.withMetaObjectsInSubtree(f=>{const m=l.objects[f.id];m&&(m.xrayed=!1)}))}},{title:"Reset X-Ray",getEnabled:function(a){return a.viewer.scene.numXRayedObjects>0},doAction:function(a){a.viewer.scene.setObjectsXRayed(a.viewer.scene.xrayedObjectIds,!1)}}],[{title:"Select",getEnabled:function(a){return!a.entity.selected},doAction:function(a){a.entity.selected=!0}},{title:"Undo select",getEnabled:function(a){return a.entity.selected},doAction:function(a){a.entity.selected=!1}},{title:"Clear Selection",getEnabled:function(a){return a.viewer.scene.numSelectedObjects>0},doAction:function(a){a.viewer.scene.setObjectsSelected(a.viewer.scene.selectedObjectIds,!1)}}]],enabled:!0});r.cameraControl.on("rightClick",function(a){var A=r.scene.pick({canvasPos:a.canvasPos});A&&A.entity.isObject?(s.context={viewer:r,treeViewPlugin:e,entity:A.entity},s.show(a.pagePos[0],a.pagePos[1])):(i.context={viewer:r},i.show(a.pagePos[0],a.pagePos[1])),a.event.preventDefault()});let t=0,o=0,n="";document.querySelector("#xeokit_canvas").addEventListener("mousedown",a=>{t=a.offsetX,o=a.offsetY}),document.querySelector("#xeokit_canvas").addEventListener("mouseup",a=>{if(a.offsetX!=t||a.offsetY!=o)return;const A=r.scene.pick({canvasPos:[a.offsetX,a.offsetY],pickSurfacePrecision:!0});if(!(!A||!A.entity))switch(n="",a.button){case 0:a.shiftKey?r.scene.setObjectsSelected([A.entity.id],!A.entity.selected):r.scene.selectedObjectIds.length==0?r.scene.setObjectsSelected([A.entity.id],!A.entity.selected):(r.scene.setObjectsSelected(r.scene.selectedObjectIds,!1),r.scene.setObjectsSelected([A.entity.id],!0));break;case 1:r.cameraFlight.flyTo({aabb:A.entity.aabb,duration:.5});break}}),document.querySelector("#xeokit_canvas").addEventListener("mousemove",a=>{if(r.scene.setObjectsSelected([n],!1),a.buttons!=0)return;const A=r.scene.pick({canvasPos:[a.offsetX,a.offsetY],pickSurfacePrecision:!0});!A||!A.entity||(n=A.entity.id,r.scene.setObjectsSelected([n],!0))})}console.log("AA");const dr=new NE({canvasId:"xeokit_canvas",transparent:!0,dtxEnabled:!0}),zn=new _F;zn.showPanel(0);document.body.appendChild(zn.dom);console.log(dr.scene);dr.scene.on("tick",r=>{zn.begin(),zn.end()});const ip=document.querySelector("input");ip.addEventListener("change",async()=>{const r=await ip.files[0].arrayBuffer(),e=new nc.IfcAPI;e.SetWasmPath("https://cdn.jsdelivr.net/npm/web-ifc@0.0.51/"),await e.Init();const s=new pF(dr,{WebIFC:nc,IfcAPI:e}).load({id:"myModel",edges:!0,ifc:r});s.on("loaded",()=>{dr.cameraFlight.jumpTo(s)}),s.on("error",t=>{console.log(t)})});const BF=vF(dr);PF(dr,BF)});export default yF();
