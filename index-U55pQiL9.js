var N_=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);var hL=N_((vc,Qa)=>{(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function t(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=t(s);fetch(s.href,o)}})();class Si{constructor(e,t){this.items=e||[],this._lastUniqueId=(t||0)+1}addItem(){let e;if(arguments.length===2){const t=arguments[0];if(e=arguments[1],this.items[t])throw"ID clash: '"+t+"'";return this.items[t]=e,t}else for(e=arguments[0]||{};;){const t=this._lastUniqueId++;if(!this.items[t])return this.items[t]=e,t}}removeItem(e){const t=this.items[e];return delete this.items[e],t}}const ph=new Si;class Q_{constructor(e){this.id=e,this.parentItem=null,this.groups=[],this.menuElement=null,this.shown=!1,this.mouseOver=0}}class H_{constructor(){this.items=[]}}class V_{constructor(e,t,i,s,o){this.id=e,this.getTitle=t,this.doAction=i,this.getEnabled=s,this.getShown=o,this.itemElement=null,this.subMenu=null,this.enabled=!0}}class bl{constructor(e={}){this._id=ph.addItem(),this._context=null,this._enabled=!1,this._itemsCfg=[],this._rootMenu=null,this._menuList=[],this._menuMap={},this._itemList=[],this._itemMap={},this._shown=!1,this._nextId=0,this._eventSubs={},e.hideOnMouseDown!==!1&&(document.addEventListener("mousedown",t=>{t.target.classList.contains("xeokit-context-menu-item")||this.hide()}),document.addEventListener("touchstart",this._canvasTouchStartHandler=t=>{t.target.classList.contains("xeokit-context-menu-item")||this.hide()})),e.items&&(this.items=e.items),this._hideOnAction=e.hideOnAction!==!1,this.context=e.context,this.enabled=e.enabled!==!1,this.hide()}on(e,t){let i=this._eventSubs[e];i||(i=[],this._eventSubs[e]=i),i.push(t)}fire(e,t){const i=this._eventSubs[e];if(i)for(let s=0,o=i.length;s<o;s++)i[s](t)}set items(e){this._clear(),this._itemsCfg=e||[],this._parseItems(e),this._createUI()}get items(){return this._itemsCfg}set enabled(e){e=!!e,e!==this._enabled&&(this._enabled=e,this._enabled||this.hide())}get enabled(){return this._enabled}set context(e){this._context=e}get context(){return this._context}show(e,t){if(!this._context){console.error("ContextMenu cannot be shown without a context - set context first");return}this._enabled&&(this._shown||(this._hideAllMenus(),this._updateItemsTitles(),this._updateItemsEnabledStatus(),this._showMenu(this._rootMenu.id,e,t),this._shown=!0,this.fire("shown",{})))}get shown(){return this._shown}hide(){this._enabled&&this._shown&&(this._hideAllMenus(),this._shown=!1,this.fire("hidden",{}))}destroy(){this._context=null,this._clear(),this._id!==null&&(ph.removeItem(this._id),this._id=null)}_clear(){for(let e=0,t=this._menuList.length;e<t;e++){const s=this._menuList[e].menuElement;s.parentElement.removeChild(s)}this._itemsCfg=[],this._rootMenu=null,this._menuList=[],this._menuMap={},this._itemList=[],this._itemMap={}}_parseItems(e){const t=i=>{const s=this._getNextId(),o=new Q_(s);for(let n=0,a=i.length;n<a;n++){const A=i[n],l=new H_;o.groups.push(l);for(let h=0,d=A.length;h<d;h++){const f=A[h],m=f.items,_=m&&m.length>0,u=this._getNextId(),B=f.getTitle||(()=>f.title||""),y=f.doAction||f.callback||(()=>{}),x=f.getEnabled||(()=>!0),P=f.getShown||(()=>!0),v=new V_(u,B,y,x,P);if(v.parentMenu=o,l.items.push(v),_){const b=t(m);v.subMenu=b,b.parentItem=v}this._itemList.push(v),this._itemMap[v.id]=v}}return this._menuList.push(o),this._menuMap[o.id]=o,o};this._rootMenu=t(e)}_getNextId(){return"ContextMenu_"+this._id+"_"+this._nextId++}_createUI(){const e=t=>{this._createMenuUI(t);const i=t.groups;for(let s=0,o=i.length;s<o;s++){const a=i[s].items;for(let A=0,l=a.length;A<l;A++){const d=a[A].subMenu;d&&e(d)}}};e(this._rootMenu)}_createMenuUI(e){const t=e.groups,i=[];if(i.push('<div class="xeokit-context-menu '+e.id+'" style="z-index:300000; position: absolute;">'),i.push("<ul>"),t)for(let A=0,l=t.length;A<l;A++){const h=t[A],d=A,f=l,m=h.items;if(m)for(let _=0,u=m.length;_<u;_++){const B=m[_],y=B.subMenu,x=B.title||"";y?i.push('<li id="'+B.id+'" class="xeokit-context-menu-item" style="'+(d===f-1||_<u-1?"border-bottom: 0":"border-bottom: 1px solid black")+'">'+x+" [MORE]</li>"):i.push('<li id="'+B.id+'" class="xeokit-context-menu-item" style="'+(d===f-1||_<u-1?"border-bottom: 0":"border-bottom: 1px solid black")+'">'+x+"</li>")}}i.push("</ul>"),i.push("</div>");const s=i.join("");document.body.insertAdjacentHTML("beforeend",s);const o=document.querySelector("."+e.id);e.menuElement=o,o.style["border-radius"]="4px",o.style.display="none",o.style["z-index"]=3e5,o.style.background="white",o.style.border="1px solid black",o.style["box-shadow"]="0 4px 5px 0 gray",o.oncontextmenu=A=>{A.preventDefault()};const n=this;let a=null;if(t)for(let A=0,l=t.length;A<l;A++){const d=t[A].items;if(d)for(let f=0,m=d.length;f<m;f++){const _=d[f],u=_.subMenu;if(_.itemElement=document.getElementById(_.id),!_.itemElement){console.error("ContextMenu item element not found: "+_.id);continue}_.itemElement.addEventListener("mouseenter",B=>{B.preventDefault();const y=_.subMenu;if(!y){a&&(n._hideMenu(a.id),a=null);return}if(a&&a.id!==y.id&&(n._hideMenu(a.id),a=null),_.enabled===!1)return;const x=_.itemElement,P=y.menuElement,v=x.getBoundingClientRect();P.getBoundingClientRect();const b=200;v.right+b>window.innerWidth?n._showMenu(y.id,v.left-b,v.top-1):n._showMenu(y.id,v.right-5,v.top-1),a=y}),u||(_.itemElement.addEventListener("click",B=>{B.preventDefault(),n._context&&_.enabled!==!1&&(_.doAction&&_.doAction(n._context),this._hideOnAction?n.hide():(n._updateItemsTitles(),n._updateItemsEnabledStatus()))}),_.itemElement.addEventListener("mouseup",B=>{B.which===3&&(B.preventDefault(),n._context&&_.enabled!==!1&&(_.doAction&&_.doAction(n._context),this._hideOnAction?n.hide():(n._updateItemsTitles(),n._updateItemsEnabledStatus())))}),_.itemElement.addEventListener("mouseenter",B=>{B.preventDefault(),_.enabled!==!1&&_.doHover&&_.doHover(n._context)}))}}}_updateItemsTitles(){if(this._context)for(let e=0,t=this._itemList.length;e<t;e++){const i=this._itemList[e],s=i.itemElement;if(!s)continue;const o=i.getShown;if(!o||!o(this._context))continue;const n=i.getTitle(this._context);i.subMenu,s.innerText=n}}_updateItemsEnabledStatus(){if(this._context)for(let e=0,t=this._itemList.length;e<t;e++){const i=this._itemList[e],s=i.itemElement;if(!s)continue;const o=i.getEnabled;if(!o)continue;const n=i.getShown;if(!n)continue;const a=n(this._context);if(i.shown=a,a)s.style.visibility="visible",s.style.height="auto",s.style.padding=null;else{s.style.visibility="hidden",s.style.height="0",s.style.padding="0";continue}const A=o(this._context);i.enabled=A,A?s.classList.remove("disabled"):s.classList.add("disabled")}}_showMenu(e,t,i){const s=this._menuMap[e];if(!s){console.error("Menu not found: "+e);return}if(s.shown)return;const o=s.menuElement;o&&(this._showMenuElement(o,t,i),s.shown=!0)}_hideMenu(e){const t=this._menuMap[e];if(!t){console.error("Menu not found: "+e);return}if(!t.shown)return;const i=t.menuElement;i&&(this._hideMenuElement(i),t.shown=!1)}_hideAllMenus(){for(let e=0,t=this._menuList.length;e<t;e++){const i=this._menuList[e];this._hideMenu(i.id)}}_showMenuElement(e,t,i){e.style.display="block";const s=e.offsetHeight,o=e.offsetWidth;i+s>window.innerHeight&&(i=window.innerHeight-s),t+o>window.innerWidth&&(t=window.innerWidth-o),e.style.left=t+"px",e.style.top=i+"px"}_hideMenuElement(e){e.style.display="none"}}let Yn=!0,ye=Yn?Float64Array:Float32Array;const Vs=new ye(3),on=new ye(16),nn=new ye(16),G_=new ye(4),c={setDoublePrecisionEnabled(r){Yn=r,ye=Yn?Float64Array:Float32Array},getDoublePrecisionEnabled(){return Yn},MIN_DOUBLE:-Number.MAX_SAFE_INTEGER,MAX_DOUBLE:Number.MAX_SAFE_INTEGER,MAX_INT:1e7,DEGTORAD:.0174532925,RADTODEG:57.295779513,unglobalizeObjectId(r,e){const t=e.indexOf("#");return t===r.length&&e.startsWith(r)?e.substring(t+1):e},globalizeObjectId(r,e){return r+"#"+e},safeInv(r){const e=1/r;return isNaN(e)||!isFinite(e)?1:e},vec2(r){return new ye(r||2)},vec3(r){return new ye(r||3)},vec4(r){return new ye(r||4)},mat3(r){return new ye(r||9)},mat3ToMat4(r,e=new ye(16)){return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=0,e[4]=r[3],e[5]=r[4],e[6]=r[5],e[7]=0,e[8]=r[6],e[9]=r[7],e[10]=r[8],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},mat4(r){return new ye(r||16)},mat4ToMat3(r,e){},doublesToFloats(r,e,t){const i=new ye(2);for(let s=0,o=r.length;s<o;s++)c.splitDouble(r[s],i),e[s]=i[0],t[s]=i[1]},splitDouble(r,e){const t=ye.from([r])[0],i=r-t;e[0]=t,e[1]=i},createUUID:(()=>{const r=[];for(let e=0;e<256;e++)r[e]=(e<16?"0":"")+e.toString(16);return()=>{const e=Math.random()*4294967295|0,t=Math.random()*4294967295|0,i=Math.random()*4294967295|0,s=Math.random()*4294967295|0;return`${r[e&255]+r[e>>8&255]+r[e>>16&255]+r[e>>24&255]}-${r[t&255]}${r[t>>8&255]}-${r[t>>16&15|64]}${r[t>>24&255]}-${r[i&63|128]}${r[i>>8&255]}-${r[i>>16&255]}${r[i>>24&255]}${r[s&255]}${r[s>>8&255]}${r[s>>16&255]}${r[s>>24&255]}`}})(),clamp(r,e,t){return Math.max(e,Math.min(t,r))},fmod(r,e){if(r<e)return console.error("math.fmod : Attempting to find modulus within negative range - would be infinite loop - ignoring"),r;for(;e<=r;)r-=e;return r},compareVec3(r,e){return r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2]},negateVec3(r,e){return e||(e=r),e[0]=-r[0],e[1]=-r[1],e[2]=-r[2],e},negateVec4(r,e){return e||(e=r),e[0]=-r[0],e[1]=-r[1],e[2]=-r[2],e[3]=-r[3],e},addVec4(r,e,t){return t||(t=r),t[0]=r[0]+e[0],t[1]=r[1]+e[1],t[2]=r[2]+e[2],t[3]=r[3]+e[3],t},addVec4Scalar(r,e,t){return t||(t=r),t[0]=r[0]+e,t[1]=r[1]+e,t[2]=r[2]+e,t[3]=r[3]+e,t},addVec3(r,e,t){return t||(t=r),t[0]=r[0]+e[0],t[1]=r[1]+e[1],t[2]=r[2]+e[2],t},addVec3Scalar(r,e,t){return t||(t=r),t[0]=r[0]+e,t[1]=r[1]+e,t[2]=r[2]+e,t},subVec4(r,e,t){return t||(t=r),t[0]=r[0]-e[0],t[1]=r[1]-e[1],t[2]=r[2]-e[2],t[3]=r[3]-e[3],t},subVec3(r,e,t){return t||(t=r),t[0]=r[0]-e[0],t[1]=r[1]-e[1],t[2]=r[2]-e[2],t},subVec2(r,e,t){return t||(t=r),t[0]=r[0]-e[0],t[1]=r[1]-e[1],t},geometricMeanVec2(...r){const e=new ye(r[0]);for(let t=1;t<r.length;t++)e[0]+=r[t][0],e[1]+=r[t][1];return e[0]/=r.length,e[1]/=r.length,e},subVec4Scalar(r,e,t){return t||(t=r),t[0]=r[0]-e,t[1]=r[1]-e,t[2]=r[2]-e,t[3]=r[3]-e,t},subScalarVec4(r,e,t){return t||(t=r),t[0]=e-r[0],t[1]=e-r[1],t[2]=e-r[2],t[3]=e-r[3],t},mulVec4(r,e,t){return t||(t=r),t[0]=r[0]*e[0],t[1]=r[1]*e[1],t[2]=r[2]*e[2],t[3]=r[3]*e[3],t},mulVec4Scalar(r,e,t){return t||(t=r),t[0]=r[0]*e,t[1]=r[1]*e,t[2]=r[2]*e,t[3]=r[3]*e,t},mulVec3Scalar(r,e,t){return t||(t=r),t[0]=r[0]*e,t[1]=r[1]*e,t[2]=r[2]*e,t},mulVec2Scalar(r,e,t){return t||(t=r),t[0]=r[0]*e,t[1]=r[1]*e,t},divVec3(r,e,t){return t||(t=r),t[0]=r[0]/e[0],t[1]=r[1]/e[1],t[2]=r[2]/e[2],t},divVec4(r,e,t){return t||(t=r),t[0]=r[0]/e[0],t[1]=r[1]/e[1],t[2]=r[2]/e[2],t[3]=r[3]/e[3],t},divScalarVec3(r,e,t){return t||(t=e),t[0]=r/e[0],t[1]=r/e[1],t[2]=r/e[2],t},divVec3Scalar(r,e,t){return t||(t=r),t[0]=r[0]/e,t[1]=r[1]/e,t[2]=r[2]/e,t},divVec4Scalar(r,e,t){return t||(t=r),t[0]=r[0]/e,t[1]=r[1]/e,t[2]=r[2]/e,t[3]=r[3]/e,t},divScalarVec4(r,e,t){return t||(t=e),t[0]=r/e[0],t[1]=r/e[1],t[2]=r/e[2],t[3]=r/e[3],t},dotVec4(r,e){return r[0]*e[0]+r[1]*e[1]+r[2]*e[2]+r[3]*e[3]},cross3Vec4(r,e){const t=r[0],i=r[1],s=r[2],o=e[0],n=e[1],a=e[2];return[i*a-s*n,s*o-t*a,t*n-i*o,0]},cross3Vec3(r,e,t){t||(t=r);const i=r[0],s=r[1],o=r[2],n=e[0],a=e[1],A=e[2];return t[0]=s*A-o*a,t[1]=o*n-i*A,t[2]=i*a-s*n,t},sqLenVec4(r){return c.dotVec4(r,r)},lenVec4(r){return Math.sqrt(c.sqLenVec4(r))},dotVec3(r,e){return r[0]*e[0]+r[1]*e[1]+r[2]*e[2]},dotVec2(r,e){return r[0]*e[0]+r[1]*e[1]},sqLenVec3(r){return c.dotVec3(r,r)},sqLenVec2(r){return c.dotVec2(r,r)},lenVec3(r){return Math.sqrt(c.sqLenVec3(r))},distVec3:(()=>{const r=new ye(3);return(e,t)=>c.lenVec3(c.subVec3(e,t,r))})(),lenVec2(r){return Math.sqrt(c.sqLenVec2(r))},distVec2:(()=>{const r=new ye(2);return(e,t)=>c.lenVec2(c.subVec2(e,t,r))})(),rcpVec3(r,e){return c.divScalarVec3(1,r,e)},normalizeVec4(r,e){const t=1/c.lenVec4(r);return c.mulVec4Scalar(r,t,e)},normalizeVec3(r,e){const t=1/c.lenVec3(r);return c.mulVec3Scalar(r,t,e)},normalizeVec2(r,e){const t=1/c.lenVec2(r);return c.mulVec2Scalar(r,t,e)},angleVec3(r,e){let t=c.dotVec3(r,e)/Math.sqrt(c.sqLenVec3(r)*c.sqLenVec3(e));return t=t<-1?-1:t>1?1:t,Math.acos(t)},vec3FromMat4Scale:(()=>{const r=new ye(3);return(e,t)=>(r[0]=e[0],r[1]=e[1],r[2]=e[2],t[0]=c.lenVec3(r),r[0]=e[4],r[1]=e[5],r[2]=e[6],t[1]=c.lenVec3(r),r[0]=e[8],r[1]=e[9],r[2]=e[10],t[2]=c.lenVec3(r),t)})(),vecToArray:(()=>{function r(e){return Math.round(e*1e5)/1e5}return e=>{e=Array.prototype.slice.call(e);for(let t=0,i=e.length;t<i;t++)e[t]=r(e[t]);return e}})(),xyzArrayToObject(r){return{x:r[0],y:r[1],z:r[2]}},xyzObjectToArray(r,e){return e=e||c.vec3(),e[0]=r.x,e[1]=r.y,e[2]=r.z,e},dupMat4(r){return r.slice(0,16)},mat4To3(r){return[r[0],r[1],r[2],r[4],r[5],r[6],r[8],r[9],r[10]]},m4s(r){return[r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r]},setMat4ToZeroes(){return c.m4s(0)},setMat4ToOnes(){return c.m4s(1)},diagonalMat4v(r){return new ye([r[0],0,0,0,0,r[1],0,0,0,0,r[2],0,0,0,0,r[3]])},diagonalMat4c(r,e,t,i){return c.diagonalMat4v([r,e,t,i])},diagonalMat4s(r){return c.diagonalMat4c(r,r,r,r)},identityMat4(r=new ye(16)){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r},identityMat3(r=new ye(9)){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=0,r[7]=0,r[8]=1,r},isIdentityMat4(r){return!(r[0]!==1||r[1]!==0||r[2]!==0||r[3]!==0||r[4]!==0||r[5]!==1||r[6]!==0||r[7]!==0||r[8]!==0||r[9]!==0||r[10]!==1||r[11]!==0||r[12]!==0||r[13]!==0||r[14]!==0||r[15]!==1)},negateMat4(r,e){return e||(e=r),e[0]=-r[0],e[1]=-r[1],e[2]=-r[2],e[3]=-r[3],e[4]=-r[4],e[5]=-r[5],e[6]=-r[6],e[7]=-r[7],e[8]=-r[8],e[9]=-r[9],e[10]=-r[10],e[11]=-r[11],e[12]=-r[12],e[13]=-r[13],e[14]=-r[14],e[15]=-r[15],e},addMat4(r,e,t){return t||(t=r),t[0]=r[0]+e[0],t[1]=r[1]+e[1],t[2]=r[2]+e[2],t[3]=r[3]+e[3],t[4]=r[4]+e[4],t[5]=r[5]+e[5],t[6]=r[6]+e[6],t[7]=r[7]+e[7],t[8]=r[8]+e[8],t[9]=r[9]+e[9],t[10]=r[10]+e[10],t[11]=r[11]+e[11],t[12]=r[12]+e[12],t[13]=r[13]+e[13],t[14]=r[14]+e[14],t[15]=r[15]+e[15],t},addMat4Scalar(r,e,t){return t||(t=r),t[0]=r[0]+e,t[1]=r[1]+e,t[2]=r[2]+e,t[3]=r[3]+e,t[4]=r[4]+e,t[5]=r[5]+e,t[6]=r[6]+e,t[7]=r[7]+e,t[8]=r[8]+e,t[9]=r[9]+e,t[10]=r[10]+e,t[11]=r[11]+e,t[12]=r[12]+e,t[13]=r[13]+e,t[14]=r[14]+e,t[15]=r[15]+e,t},addScalarMat4(r,e,t){return c.addMat4Scalar(e,r,t)},subMat4(r,e,t){return t||(t=r),t[0]=r[0]-e[0],t[1]=r[1]-e[1],t[2]=r[2]-e[2],t[3]=r[3]-e[3],t[4]=r[4]-e[4],t[5]=r[5]-e[5],t[6]=r[6]-e[6],t[7]=r[7]-e[7],t[8]=r[8]-e[8],t[9]=r[9]-e[9],t[10]=r[10]-e[10],t[11]=r[11]-e[11],t[12]=r[12]-e[12],t[13]=r[13]-e[13],t[14]=r[14]-e[14],t[15]=r[15]-e[15],t},subMat4Scalar(r,e,t){return t||(t=r),t[0]=r[0]-e,t[1]=r[1]-e,t[2]=r[2]-e,t[3]=r[3]-e,t[4]=r[4]-e,t[5]=r[5]-e,t[6]=r[6]-e,t[7]=r[7]-e,t[8]=r[8]-e,t[9]=r[9]-e,t[10]=r[10]-e,t[11]=r[11]-e,t[12]=r[12]-e,t[13]=r[13]-e,t[14]=r[14]-e,t[15]=r[15]-e,t},subScalarMat4(r,e,t){return t||(t=e),t[0]=r-e[0],t[1]=r-e[1],t[2]=r-e[2],t[3]=r-e[3],t[4]=r-e[4],t[5]=r-e[5],t[6]=r-e[6],t[7]=r-e[7],t[8]=r-e[8],t[9]=r-e[9],t[10]=r-e[10],t[11]=r-e[11],t[12]=r-e[12],t[13]=r-e[13],t[14]=r-e[14],t[15]=r-e[15],t},mulMat4(r,e,t){t||(t=r);const i=r[0],s=r[1],o=r[2],n=r[3],a=r[4],A=r[5],l=r[6],h=r[7],d=r[8],f=r[9],m=r[10],_=r[11],u=r[12],B=r[13],y=r[14],x=r[15],P=e[0],v=e[1],b=e[2],C=e[3],I=e[4],E=e[5],S=e[6],R=e[7],D=e[8],K=e[9],j=e[10],z=e[11],le=e[12],ue=e[13],ae=e[14],Be=e[15];return t[0]=P*i+v*a+b*d+C*u,t[1]=P*s+v*A+b*f+C*B,t[2]=P*o+v*l+b*m+C*y,t[3]=P*n+v*h+b*_+C*x,t[4]=I*i+E*a+S*d+R*u,t[5]=I*s+E*A+S*f+R*B,t[6]=I*o+E*l+S*m+R*y,t[7]=I*n+E*h+S*_+R*x,t[8]=D*i+K*a+j*d+z*u,t[9]=D*s+K*A+j*f+z*B,t[10]=D*o+K*l+j*m+z*y,t[11]=D*n+K*h+j*_+z*x,t[12]=le*i+ue*a+ae*d+Be*u,t[13]=le*s+ue*A+ae*f+Be*B,t[14]=le*o+ue*l+ae*m+Be*y,t[15]=le*n+ue*h+ae*_+Be*x,t},mulMat3(r,e,t){t||(t=new ye(9));const i=r[0],s=r[3],o=r[6],n=r[1],a=r[4],A=r[7],l=r[2],h=r[5],d=r[8],f=e[0],m=e[3],_=e[6],u=e[1],B=e[4],y=e[7],x=e[2],P=e[5],v=e[8];return t[0]=i*f+s*u+o*x,t[3]=i*m+s*B+o*P,t[6]=i*_+s*y+o*v,t[1]=n*f+a*u+A*x,t[4]=n*m+a*B+A*P,t[7]=n*_+a*y+A*v,t[2]=l*f+h*u+d*x,t[5]=l*m+h*B+d*P,t[8]=l*_+h*y+d*v,t},mulMat4Scalar(r,e,t){return t||(t=r),t[0]=r[0]*e,t[1]=r[1]*e,t[2]=r[2]*e,t[3]=r[3]*e,t[4]=r[4]*e,t[5]=r[5]*e,t[6]=r[6]*e,t[7]=r[7]*e,t[8]=r[8]*e,t[9]=r[9]*e,t[10]=r[10]*e,t[11]=r[11]*e,t[12]=r[12]*e,t[13]=r[13]*e,t[14]=r[14]*e,t[15]=r[15]*e,t},mulMat4v4(r,e,t=c.vec4()){const i=e[0],s=e[1],o=e[2],n=e[3];return t[0]=r[0]*i+r[4]*s+r[8]*o+r[12]*n,t[1]=r[1]*i+r[5]*s+r[9]*o+r[13]*n,t[2]=r[2]*i+r[6]*s+r[10]*o+r[14]*n,t[3]=r[3]*i+r[7]*s+r[11]*o+r[15]*n,t},transposeMat4(r,e){const t=r[4],i=r[14],s=r[8],o=r[13],n=r[12],a=r[9];if(!e||r===e){const A=r[1],l=r[2],h=r[3],d=r[6],f=r[7],m=r[11];return r[1]=t,r[2]=s,r[3]=n,r[4]=A,r[6]=a,r[7]=o,r[8]=l,r[9]=d,r[11]=i,r[12]=h,r[13]=f,r[14]=m,r}return e[0]=r[0],e[1]=t,e[2]=s,e[3]=n,e[4]=r[1],e[5]=r[5],e[6]=a,e[7]=o,e[8]=r[2],e[9]=r[6],e[10]=r[10],e[11]=i,e[12]=r[3],e[13]=r[7],e[14]=r[11],e[15]=r[15],e},transposeMat3(r,e){if(e===r){const t=r[1],i=r[2],s=r[5];e[1]=r[3],e[2]=r[6],e[3]=t,e[5]=r[7],e[6]=i,e[7]=s}else e[0]=r[0],e[1]=r[3],e[2]=r[6],e[3]=r[1],e[4]=r[4],e[5]=r[7],e[6]=r[2],e[7]=r[5],e[8]=r[8];return e},determinantMat4(r){const e=r[0],t=r[1],i=r[2],s=r[3],o=r[4],n=r[5],a=r[6],A=r[7],l=r[8],h=r[9],d=r[10],f=r[11],m=r[12],_=r[13],u=r[14],B=r[15];return m*h*a*s-l*_*a*s-m*n*d*s+o*_*d*s+l*n*u*s-o*h*u*s-m*h*i*A+l*_*i*A+m*t*d*A-e*_*d*A-l*t*u*A+e*h*u*A+m*n*i*f-o*_*i*f-m*t*a*f+e*_*a*f+o*t*u*f-e*n*u*f-l*n*i*B+o*h*i*B+l*t*a*B-e*h*a*B-o*t*d*B+e*n*d*B},inverseMat4(r,e){e||(e=r);const t=r[0],i=r[1],s=r[2],o=r[3],n=r[4],a=r[5],A=r[6],l=r[7],h=r[8],d=r[9],f=r[10],m=r[11],_=r[12],u=r[13],B=r[14],y=r[15],x=t*a-i*n,P=t*A-s*n,v=t*l-o*n,b=i*A-s*a,C=i*l-o*a,I=s*l-o*A,E=h*u-d*_,S=h*B-f*_,R=h*y-m*_,D=d*B-f*u,K=d*y-m*u,j=f*y-m*B,z=1/(x*j-P*K+v*D+b*R-C*S+I*E);return e[0]=(a*j-A*K+l*D)*z,e[1]=(-i*j+s*K-o*D)*z,e[2]=(u*I-B*C+y*b)*z,e[3]=(-d*I+f*C-m*b)*z,e[4]=(-n*j+A*R-l*S)*z,e[5]=(t*j-s*R+o*S)*z,e[6]=(-_*I+B*v-y*P)*z,e[7]=(h*I-f*v+m*P)*z,e[8]=(n*K-a*R+l*E)*z,e[9]=(-t*K+i*R-o*E)*z,e[10]=(_*C-u*v+y*x)*z,e[11]=(-h*C+d*v-m*x)*z,e[12]=(-n*D+a*S-A*E)*z,e[13]=(t*D-i*S+s*E)*z,e[14]=(-_*b+u*P-B*x)*z,e[15]=(h*b-d*P+f*x)*z,e},traceMat4(r){return r[0]+r[5]+r[10]+r[15]},translationMat4v(r,e){const t=e||c.identityMat4();return t[12]=r[0],t[13]=r[1],t[14]=r[2],t},translationMat3v(r,e){const t=e||c.identityMat3();return t[6]=r[0],t[7]=r[1],t},translationMat4c:(()=>{const r=new ye(3);return(e,t,i,s)=>(r[0]=e,r[1]=t,r[2]=i,c.translationMat4v(r,s))})(),translationMat4s(r,e){return c.translationMat4c(r,r,r,e)},translateMat4v(r,e){return c.translateMat4c(r[0],r[1],r[2],e)},translateMat4c(r,e,t,i){const s=i[3];i[0]+=s*r,i[1]+=s*e,i[2]+=s*t;const o=i[7];i[4]+=o*r,i[5]+=o*e,i[6]+=o*t;const n=i[11];i[8]+=n*r,i[9]+=n*e,i[10]+=n*t;const a=i[15];return i[12]+=a*r,i[13]+=a*e,i[14]+=a*t,i},setMat4Translation(r,e,t){return t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3],t[4]=r[4],t[5]=r[5],t[6]=r[6],t[7]=r[7],t[8]=r[8],t[9]=r[9],t[10]=r[10],t[11]=r[11],t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=r[15],t},rotationMat4v(r,e,t){const i=c.normalizeVec4([e[0],e[1],e[2],0],[]),s=Math.sin(r),o=Math.cos(r),n=1-o,a=i[0],A=i[1],l=i[2];let h,d,f,m,_,u;return h=a*A,d=A*l,f=l*a,m=a*s,_=A*s,u=l*s,t=t||c.mat4(),t[0]=n*a*a+o,t[1]=n*h+u,t[2]=n*f-_,t[3]=0,t[4]=n*h-u,t[5]=n*A*A+o,t[6]=n*d+m,t[7]=0,t[8]=n*f+_,t[9]=n*d-m,t[10]=n*l*l+o,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},rotationMat4c(r,e,t,i,s){return c.rotationMat4v(r,[e,t,i],s)},scalingMat4v(r,e=c.identityMat4()){return e[0]=r[0],e[5]=r[1],e[10]=r[2],e},scalingMat3v(r,e=c.identityMat3()){return e[0]=r[0],e[4]=r[1],e},scalingMat4c:(()=>{const r=new ye(3);return(e,t,i,s)=>(r[0]=e,r[1]=t,r[2]=i,c.scalingMat4v(r,s))})(),scaleMat4c(r,e,t,i){return i[0]*=r,i[4]*=e,i[8]*=t,i[1]*=r,i[5]*=e,i[9]*=t,i[2]*=r,i[6]*=e,i[10]*=t,i[3]*=r,i[7]*=e,i[11]*=t,i},scaleMat4v(r,e){const t=r[0],i=r[1],s=r[2];return e[0]*=t,e[4]*=i,e[8]*=s,e[1]*=t,e[5]*=i,e[9]*=s,e[2]*=t,e[6]*=i,e[10]*=s,e[3]*=t,e[7]*=i,e[11]*=s,e},scalingMat4s(r){return c.scalingMat4c(r,r,r)},rotationTranslationMat4(r,e,t=c.mat4()){const i=r[0],s=r[1],o=r[2],n=r[3],a=i+i,A=s+s,l=o+o,h=i*a,d=i*A,f=i*l,m=s*A,_=s*l,u=o*l,B=n*a,y=n*A,x=n*l;return t[0]=1-(m+u),t[1]=d+x,t[2]=f-y,t[3]=0,t[4]=d-x,t[5]=1-(h+u),t[6]=_+B,t[7]=0,t[8]=f+y,t[9]=_-B,t[10]=1-(h+m),t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t},mat4ToEuler(r,e,t=c.vec4()){const i=c.clamp,s=r[0],o=r[4],n=r[8],a=r[1],A=r[5],l=r[9],h=r[2],d=r[6],f=r[10];return e==="XYZ"?(t[1]=Math.asin(i(n,-1,1)),Math.abs(n)<.99999?(t[0]=Math.atan2(-l,f),t[2]=Math.atan2(-o,s)):(t[0]=Math.atan2(d,A),t[2]=0)):e==="YXZ"?(t[0]=Math.asin(-i(l,-1,1)),Math.abs(l)<.99999?(t[1]=Math.atan2(n,f),t[2]=Math.atan2(a,A)):(t[1]=Math.atan2(-h,s),t[2]=0)):e==="ZXY"?(t[0]=Math.asin(i(d,-1,1)),Math.abs(d)<.99999?(t[1]=Math.atan2(-h,f),t[2]=Math.atan2(-o,A)):(t[1]=0,t[2]=Math.atan2(a,s))):e==="ZYX"?(t[1]=Math.asin(-i(h,-1,1)),Math.abs(h)<.99999?(t[0]=Math.atan2(d,f),t[2]=Math.atan2(a,s)):(t[0]=0,t[2]=Math.atan2(-o,A))):e==="YZX"?(t[2]=Math.asin(i(a,-1,1)),Math.abs(a)<.99999?(t[0]=Math.atan2(-l,A),t[1]=Math.atan2(-h,s)):(t[0]=0,t[1]=Math.atan2(n,f))):e==="XZY"&&(t[2]=Math.asin(-i(o,-1,1)),Math.abs(o)<.99999?(t[0]=Math.atan2(d,A),t[1]=Math.atan2(n,s)):(t[0]=Math.atan2(-l,f),t[1]=0)),t},composeMat4(r,e,t,i=c.mat4()){return c.quaternionToRotationMat4(e,i),c.scaleMat4v(t,i),c.translateMat4v(r,i),i},decomposeMat4:(()=>{const r=new ye(3),e=new ye(16);return function(i,s,o,n){r[0]=i[0],r[1]=i[1],r[2]=i[2];let a=c.lenVec3(r);r[0]=i[4],r[1]=i[5],r[2]=i[6];const A=c.lenVec3(r);r[8]=i[8],r[9]=i[9],r[10]=i[10];const l=c.lenVec3(r);c.determinantMat4(i)<0&&(a=-a),s[0]=i[12],s[1]=i[13],s[2]=i[14],e.set(i);const d=1/a,f=1/A,m=1/l;return e[0]*=d,e[1]*=d,e[2]*=d,e[4]*=f,e[5]*=f,e[6]*=f,e[8]*=m,e[9]*=m,e[10]*=m,c.mat4ToQuaternion(e,o),n[0]=a,n[1]=A,n[2]=l,this}})(),getColMat4(r,e){const t=e*4;return[r[t],r[t+1],r[t+2],r[t+3]]},setRowMat4(r,e,t){r[e]=t[0],r[e+4]=t[1],r[e+8]=t[2],r[e+12]=t[3]},lookAtMat4v(r,e,t,i){i||(i=c.mat4());const s=r[0],o=r[1],n=r[2],a=t[0],A=t[1],l=t[2],h=e[0],d=e[1],f=e[2];if(s===h&&o===d&&n===f)return c.identityMat4();let m,_,u,B,y,x,P,v,b,C;return m=s-h,_=o-d,u=n-f,C=1/Math.sqrt(m*m+_*_+u*u),m*=C,_*=C,u*=C,B=A*u-l*_,y=l*m-a*u,x=a*_-A*m,C=Math.sqrt(B*B+y*y+x*x),C?(C=1/C,B*=C,y*=C,x*=C):(B=0,y=0,x=0),P=_*x-u*y,v=u*B-m*x,b=m*y-_*B,C=Math.sqrt(P*P+v*v+b*b),C?(C=1/C,P*=C,v*=C,b*=C):(P=0,v=0,b=0),i[0]=B,i[1]=P,i[2]=m,i[3]=0,i[4]=y,i[5]=v,i[6]=_,i[7]=0,i[8]=x,i[9]=b,i[10]=u,i[11]=0,i[12]=-(B*s+y*o+x*n),i[13]=-(P*s+v*o+b*n),i[14]=-(m*s+_*o+u*n),i[15]=1,i},lookAtMat4c(r,e,t,i,s,o,n,a,A){return c.lookAtMat4v([r,e,t],[i,s,o],[n,a,A],[])},orthoMat4c(r,e,t,i,s,o,n){n||(n=c.mat4());const a=e-r,A=i-t,l=o-s;return n[0]=2/a,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=2/A,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=-2/l,n[11]=0,n[12]=-(r+e)/a,n[13]=-(i+t)/A,n[14]=-(o+s)/l,n[15]=1,n},frustumMat4v(r,e,t){t||(t=c.mat4());const i=[r[0],r[1],r[2],0],s=[e[0],e[1],e[2],0];c.addVec4(s,i,on),c.subVec4(s,i,nn);const o=2*i[2],n=nn[0],a=nn[1],A=nn[2];return t[0]=o/n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=o/a,t[6]=0,t[7]=0,t[8]=on[0]/n,t[9]=on[1]/a,t[10]=-on[2]/A,t[11]=-1,t[12]=0,t[13]=0,t[14]=-o*s[2]/A,t[15]=0,t},frustumMat4(r,e,t,i,s,o,n){n||(n=c.mat4());const a=e-r,A=i-t,l=o-s;return n[0]=s*2/a,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=s*2/A,n[6]=0,n[7]=0,n[8]=(e+r)/a,n[9]=(i+t)/A,n[10]=-(o+s)/l,n[11]=-1,n[12]=0,n[13]=0,n[14]=-(o*s*2)/l,n[15]=0,n},perspectiveMat4(r,e,t,i,s){const o=[],n=[];return o[2]=t,n[2]=i,n[1]=o[2]*Math.tan(r/2),o[1]=-n[1],n[0]=n[1]*e,o[0]=-n[0],c.frustumMat4v(o,n,s)},compareMat4(r,e){return r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2]&&r[3]===e[3]&&r[4]===e[4]&&r[5]===e[5]&&r[6]===e[6]&&r[7]===e[7]&&r[8]===e[8]&&r[9]===e[9]&&r[10]===e[10]&&r[11]===e[11]&&r[12]===e[12]&&r[13]===e[13]&&r[14]===e[14]&&r[15]===e[15]},transformPoint3(r,e,t=c.vec3()){const i=e[0],s=e[1],o=e[2];return t[0]=r[0]*i+r[4]*s+r[8]*o+r[12],t[1]=r[1]*i+r[5]*s+r[9]*o+r[13],t[2]=r[2]*i+r[6]*s+r[10]*o+r[14],t},transformPoint4(r,e,t=c.vec4()){return t[0]=r[0]*e[0]+r[4]*e[1]+r[8]*e[2]+r[12]*e[3],t[1]=r[1]*e[0]+r[5]*e[1]+r[9]*e[2]+r[13]*e[3],t[2]=r[2]*e[0]+r[6]*e[1]+r[10]*e[2]+r[14]*e[3],t[3]=r[3]*e[0]+r[7]*e[1]+r[11]*e[2]+r[15]*e[3],t},transformPoints3(r,e,t){const i=t||[],s=e.length;let o,n,a,A;const l=r[0],h=r[1],d=r[2],f=r[3],m=r[4],_=r[5],u=r[6],B=r[7],y=r[8],x=r[9],P=r[10],v=r[11],b=r[12],C=r[13],I=r[14],E=r[15];let S;for(let R=0;R<s;++R)A=e[R],o=A[0],n=A[1],a=A[2],S=i[R]||(i[R]=[0,0,0]),S[0]=l*o+m*n+y*a+b,S[1]=h*o+_*n+x*a+C,S[2]=d*o+u*n+P*a+I,S[3]=f*o+B*n+v*a+E;return i.length=s,i},transformPositions3(r,e,t=e){let i;const s=e.length;let o,n,a;const A=r[0],l=r[1],h=r[2];r[3];const d=r[4],f=r[5],m=r[6];r[7];const _=r[8],u=r[9],B=r[10];r[11];const y=r[12],x=r[13],P=r[14];for(r[15],i=0;i<s;i+=3)o=e[i+0],n=e[i+1],a=e[i+2],t[i+0]=A*o+d*n+_*a+y,t[i+1]=l*o+f*n+u*a+x,t[i+2]=h*o+m*n+B*a+P;return t},transformPositions4(r,e,t=e){let i;const s=e.length;let o,n,a;const A=r[0],l=r[1],h=r[2],d=r[3],f=r[4],m=r[5],_=r[6],u=r[7],B=r[8],y=r[9],x=r[10],P=r[11],v=r[12],b=r[13],C=r[14],I=r[15];for(i=0;i<s;i+=4)o=e[i+0],n=e[i+1],a=e[i+2],t[i+0]=A*o+f*n+B*a+v,t[i+1]=l*o+m*n+y*a+b,t[i+2]=h*o+_*n+x*a+C,t[i+3]=d*o+u*n+P*a+I;return t},transformVec3(r,e,t){const i=e[0],s=e[1],o=e[2];return t=t||this.vec3(),t[0]=r[0]*i+r[4]*s+r[8]*o,t[1]=r[1]*i+r[5]*s+r[9]*o,t[2]=r[2]*i+r[6]*s+r[10]*o,t},transformVec4(r,e,t){const i=e[0],s=e[1],o=e[2],n=e[3];return t=t||c.vec4(),t[0]=r[0]*i+r[4]*s+r[8]*o+r[12]*n,t[1]=r[1]*i+r[5]*s+r[9]*o+r[13]*n,t[2]=r[2]*i+r[6]*s+r[10]*o+r[14]*n,t[3]=r[3]*i+r[7]*s+r[11]*o+r[15]*n,t},rotateVec2(r,e,t,i=r){const s=Math.cos(t),o=Math.sin(t),n=r[0]-e[0],a=r[1]-e[1];return i[0]=n*s-a*o+e[0],i[1]=n*o+a*s+e[1],r},rotateVec3X(r,e,t,i){const s=[],o=[];return s[0]=r[0]-e[0],s[1]=r[1]-e[1],s[2]=r[2]-e[2],o[0]=s[0],o[1]=s[1]*Math.cos(t)-s[2]*Math.sin(t),o[2]=s[1]*Math.sin(t)+s[2]*Math.cos(t),i[0]=o[0]+e[0],i[1]=o[1]+e[1],i[2]=o[2]+e[2],i},rotateVec3Y(r,e,t,i){const s=[],o=[];return s[0]=r[0]-e[0],s[1]=r[1]-e[1],s[2]=r[2]-e[2],o[0]=s[2]*Math.sin(t)+s[0]*Math.cos(t),o[1]=s[1],o[2]=s[2]*Math.cos(t)-s[0]*Math.sin(t),i[0]=o[0]+e[0],i[1]=o[1]+e[1],i[2]=o[2]+e[2],i},rotateVec3Z(r,e,t,i){const s=[],o=[];return s[0]=r[0]-e[0],s[1]=r[1]-e[1],s[2]=r[2]-e[2],o[0]=s[0]*Math.cos(t)-s[1]*Math.sin(t),o[1]=s[0]*Math.sin(t)+s[1]*Math.cos(t),o[2]=s[2],i[0]=o[0]+e[0],i[1]=o[1]+e[1],i[2]=o[2]+e[2],i},projectVec4(r,e){const t=1/r[3];return e=e||c.vec2(),e[0]=r[0]*t,e[1]=r[1]*t,e},unprojectVec3:(()=>{const r=new ye(16),e=new ye(16),t=new ye(16);return function(i,s,o,n){return this.transformVec3(this.mulMat4(this.inverseMat4(s,r),this.inverseMat4(o,e),t),i,n)}})(),lerpVec3(r,e,t,i,s,o){const n=o||c.vec3(),a=(r-e)/(t-e);return n[0]=i[0]+a*(s[0]-i[0]),n[1]=i[1]+a*(s[1]-i[1]),n[2]=i[2]+a*(s[2]-i[2]),n},lerpMat4(r,e,t,i,s,o){const n=o||c.mat4(),a=(r-e)/(t-e);return n[0]=i[0]+a*(s[0]-i[0]),n[1]=i[1]+a*(s[1]-i[1]),n[2]=i[2]+a*(s[2]-i[2]),n[3]=i[3]+a*(s[3]-i[3]),n[4]=i[4]+a*(s[4]-i[4]),n[5]=i[5]+a*(s[5]-i[5]),n[6]=i[6]+a*(s[6]-i[6]),n[7]=i[7]+a*(s[7]-i[7]),n[8]=i[8]+a*(s[8]-i[8]),n[9]=i[9]+a*(s[9]-i[9]),n[10]=i[10]+a*(s[10]-i[10]),n[11]=i[11]+a*(s[11]-i[11]),n[12]=i[12]+a*(s[12]-i[12]),n[13]=i[13]+a*(s[13]-i[13]),n[14]=i[14]+a*(s[14]-i[14]),n[15]=i[15]+a*(s[15]-i[15]),n},flatten(r){const e=[];let t,i,s,o,n;for(t=0,i=r.length;t<i;t++)for(n=r[t],s=0,o=n.length;s<o;s++)e.push(n[s]);return e},identityQuaternion(r=c.vec4()){return r[0]=0,r[1]=0,r[2]=0,r[3]=1,r},eulerToQuaternion(r,e,t=c.vec4()){const i=r[0]*c.DEGTORAD/2,s=r[1]*c.DEGTORAD/2,o=r[2]*c.DEGTORAD/2,n=Math.cos(i),a=Math.cos(s),A=Math.cos(o),l=Math.sin(i),h=Math.sin(s),d=Math.sin(o);return e==="XYZ"?(t[0]=l*a*A+n*h*d,t[1]=n*h*A-l*a*d,t[2]=n*a*d+l*h*A,t[3]=n*a*A-l*h*d):e==="YXZ"?(t[0]=l*a*A+n*h*d,t[1]=n*h*A-l*a*d,t[2]=n*a*d-l*h*A,t[3]=n*a*A+l*h*d):e==="ZXY"?(t[0]=l*a*A-n*h*d,t[1]=n*h*A+l*a*d,t[2]=n*a*d+l*h*A,t[3]=n*a*A-l*h*d):e==="ZYX"?(t[0]=l*a*A-n*h*d,t[1]=n*h*A+l*a*d,t[2]=n*a*d-l*h*A,t[3]=n*a*A+l*h*d):e==="YZX"?(t[0]=l*a*A+n*h*d,t[1]=n*h*A+l*a*d,t[2]=n*a*d-l*h*A,t[3]=n*a*A-l*h*d):e==="XZY"&&(t[0]=l*a*A-n*h*d,t[1]=n*h*A-l*a*d,t[2]=n*a*d+l*h*A,t[3]=n*a*A+l*h*d),t},mat4ToQuaternion(r,e=c.vec4()){const t=r[0],i=r[4],s=r[8],o=r[1],n=r[5],a=r[9],A=r[2],l=r[6],h=r[10];let d;const f=t+n+h;return f>0?(d=.5/Math.sqrt(f+1),e[3]=.25/d,e[0]=(l-a)*d,e[1]=(s-A)*d,e[2]=(o-i)*d):t>n&&t>h?(d=2*Math.sqrt(1+t-n-h),e[3]=(l-a)/d,e[0]=.25*d,e[1]=(i+o)/d,e[2]=(s+A)/d):n>h?(d=2*Math.sqrt(1+n-t-h),e[3]=(s-A)/d,e[0]=(i+o)/d,e[1]=.25*d,e[2]=(a+l)/d):(d=2*Math.sqrt(1+h-t-n),e[3]=(o-i)/d,e[0]=(s+A)/d,e[1]=(a+l)/d,e[2]=.25*d),e},vec3PairToQuaternion(r,e,t=c.vec4()){const i=Math.sqrt(c.dotVec3(r,r)*c.dotVec3(e,e));let s=i+c.dotVec3(r,e);return s<1e-8*i?(s=0,Math.abs(r[0])>Math.abs(r[2])?(t[0]=-r[1],t[1]=r[0],t[2]=0):(t[0]=0,t[1]=-r[2],t[2]=r[1])):c.cross3Vec3(r,e,t),t[3]=s,c.normalizeQuaternion(t)},angleAxisToQuaternion(r,e=c.vec4()){const t=r[3]/2,i=Math.sin(t);return e[0]=i*r[0],e[1]=i*r[1],e[2]=i*r[2],e[3]=Math.cos(t),e},quaternionToEuler:(()=>{const r=new ye(16);return(e,t,i)=>(i=i||c.vec3(),c.quaternionToRotationMat4(e,r),c.mat4ToEuler(r,t,i),i)})(),mulQuaternions(r,e,t=c.vec4()){const i=r[0],s=r[1],o=r[2],n=r[3],a=e[0],A=e[1],l=e[2],h=e[3];return t[0]=n*a+i*h+s*l-o*A,t[1]=n*A+s*h+o*a-i*l,t[2]=n*l+o*h+i*A-s*a,t[3]=n*h-i*a-s*A-o*l,t},vec3ApplyQuaternion(r,e,t=c.vec3()){const i=e[0],s=e[1],o=e[2],n=r[0],a=r[1],A=r[2],l=r[3],h=l*i+a*o-A*s,d=l*s+A*i-n*o,f=l*o+n*s-a*i,m=-n*i-a*s-A*o;return t[0]=h*l+m*-n+d*-A-f*-a,t[1]=d*l+m*-a+f*-n-h*-A,t[2]=f*l+m*-A+h*-a-d*-n,t},quaternionToMat4(r,e){e=c.identityMat4(e);const t=r[0],i=r[1],s=r[2],o=r[3],n=2*t,a=2*i,A=2*s,l=n*o,h=a*o,d=A*o,f=n*t,m=a*t,_=A*t,u=a*i,B=A*i,y=A*s;return e[0]=1-(u+y),e[1]=m+d,e[2]=_-h,e[4]=m-d,e[5]=1-(f+y),e[6]=B+l,e[8]=_+h,e[9]=B-l,e[10]=1-(f+u),e},quaternionToRotationMat4(r,e){const t=r[0],i=r[1],s=r[2],o=r[3],n=t+t,a=i+i,A=s+s,l=t*n,h=t*a,d=t*A,f=i*a,m=i*A,_=s*A,u=o*n,B=o*a,y=o*A;return e[0]=1-(f+_),e[4]=h-y,e[8]=d+B,e[1]=h+y,e[5]=1-(l+_),e[9]=m-u,e[2]=d-B,e[6]=m+u,e[10]=1-(l+f),e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},normalizeQuaternion(r,e=r){const t=c.lenVec4([r[0],r[1],r[2],r[3]]);return e[0]=r[0]/t,e[1]=r[1]/t,e[2]=r[2]/t,e[3]=r[3]/t,e},conjugateQuaternion(r,e=r){return e[0]=-r[0],e[1]=-r[1],e[2]=-r[2],e[3]=r[3],e},inverseQuaternion(r,e){return c.normalizeQuaternion(c.conjugateQuaternion(r,e))},quaternionToAngleAxis(r,e=c.vec4()){r=c.normalizeQuaternion(r,G_);const t=r[3],i=2*Math.acos(t),s=Math.sqrt(1-t*t);return s<.001?(e[0]=r[0],e[1]=r[1],e[2]=r[2]):(e[0]=r[0]/s,e[1]=r[1]/s,e[2]=r[2]/s),e[3]=i,e},AABB3(r){return new ye(r||6)},AABB2(r){return new ye(r||4)},OBB3(r){return new ye(r||32)},OBB2(r){return new ye(r||16)},Sphere3(r,e,t,i){return new ye([r,e,t,i])},transformOBB3(r,e,t=e){let i;const s=e.length;let o,n,a;const A=r[0],l=r[1],h=r[2],d=r[3],f=r[4],m=r[5],_=r[6],u=r[7],B=r[8],y=r[9],x=r[10],P=r[11],v=r[12],b=r[13],C=r[14],I=r[15];for(i=0;i<s;i+=4)o=e[i+0],n=e[i+1],a=e[i+2],t[i+0]=A*o+f*n+B*a+v,t[i+1]=l*o+m*n+y*a+b,t[i+2]=h*o+_*n+x*a+C,t[i+3]=d*o+u*n+P*a+I;return t},containsAABB3:function(r,e){return r[0]<=e[0]&&e[3]<=r[3]&&r[1]<=e[1]&&e[4]<=r[4]&&r[2]<=e[2]&&e[5]<=r[5]},getAABB3Diag:(()=>{const r=new ye(3),e=new ye(3),t=new ye(3);return i=>(r[0]=i[0],r[1]=i[1],r[2]=i[2],e[0]=i[3],e[1]=i[4],e[2]=i[5],c.subVec3(e,r,t),Math.abs(c.lenVec3(t)))})(),getAABB3DiagPoint:(()=>{const r=new ye(3),e=new ye(3),t=new ye(3);return(i,s)=>{r[0]=i[0],r[1]=i[1],r[2]=i[2],e[0]=i[3],e[1]=i[4],e[2]=i[5];const o=c.subVec3(e,r,t),n=s[0]-i[0],a=i[3]-s[0],A=s[1]-i[1],l=i[4]-s[1],h=s[2]-i[2],d=i[5]-s[2];return o[0]+=n>a?n:a,o[1]+=A>l?A:l,o[2]+=h>d?h:d,Math.abs(c.lenVec3(o))}})(),getAABB3Area(r){const e=r[3]-r[0],t=r[4]-r[1],i=r[5]-r[2];return e*t*i},getAABB3Center(r,e){const t=e||c.vec3();return t[0]=(r[0]+r[3])/2,t[1]=(r[1]+r[4])/2,t[2]=(r[2]+r[5])/2,t},getAABB2Center(r,e){const t=e||c.vec2();return t[0]=(r[2]+r[0])/2,t[1]=(r[3]+r[1])/2,t},collapseAABB3(r=c.AABB3()){return r[0]=c.MAX_DOUBLE,r[1]=c.MAX_DOUBLE,r[2]=c.MAX_DOUBLE,r[3]=c.MIN_DOUBLE,r[4]=c.MIN_DOUBLE,r[5]=c.MIN_DOUBLE,r},AABB3ToOBB3(r,e=c.OBB3()){return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=1,e[4]=r[3],e[5]=r[1],e[6]=r[2],e[7]=1,e[8]=r[3],e[9]=r[4],e[10]=r[2],e[11]=1,e[12]=r[0],e[13]=r[4],e[14]=r[2],e[15]=1,e[16]=r[0],e[17]=r[1],e[18]=r[5],e[19]=1,e[20]=r[3],e[21]=r[1],e[22]=r[5],e[23]=1,e[24]=r[3],e[25]=r[4],e[26]=r[5],e[27]=1,e[28]=r[0],e[29]=r[4],e[30]=r[5],e[31]=1,e},positions3ToAABB3:(()=>{const r=new ye(3);return(e,t,i)=>{t=t||c.AABB3();let s=c.MAX_DOUBLE,o=c.MAX_DOUBLE,n=c.MAX_DOUBLE,a=c.MIN_DOUBLE,A=c.MIN_DOUBLE,l=c.MIN_DOUBLE,h,d,f;for(let m=0,_=e.length;m<_;m+=3)i?(r[0]=e[m+0],r[1]=e[m+1],r[2]=e[m+2],c.decompressPosition(r,i,r),h=r[0],d=r[1],f=r[2]):(h=e[m+0],d=e[m+1],f=e[m+2]),h<s&&(s=h),d<o&&(o=d),f<n&&(n=f),h>a&&(a=h),d>A&&(A=d),f>l&&(l=f);return t[0]=s,t[1]=o,t[2]=n,t[3]=a,t[4]=A,t[5]=l,t}})(),OBB3ToAABB3(r,e=c.AABB3()){let t=c.MAX_DOUBLE,i=c.MAX_DOUBLE,s=c.MAX_DOUBLE,o=c.MIN_DOUBLE,n=c.MIN_DOUBLE,a=c.MIN_DOUBLE,A,l,h;for(let d=0,f=r.length;d<f;d+=4)A=r[d+0],l=r[d+1],h=r[d+2],A<t&&(t=A),l<i&&(i=l),h<s&&(s=h),A>o&&(o=A),l>n&&(n=l),h>a&&(a=h);return e[0]=t,e[1]=i,e[2]=s,e[3]=o,e[4]=n,e[5]=a,e},points3ToAABB3(r,e=c.AABB3()){let t=c.MAX_DOUBLE,i=c.MAX_DOUBLE,s=c.MAX_DOUBLE,o=c.MIN_DOUBLE,n=c.MIN_DOUBLE,a=c.MIN_DOUBLE,A,l,h;for(let d=0,f=r.length;d<f;d++)A=r[d][0],l=r[d][1],h=r[d][2],A<t&&(t=A),l<i&&(i=l),h<s&&(s=h),A>o&&(o=A),l>n&&(n=l),h>a&&(a=h);return e[0]=t,e[1]=i,e[2]=s,e[3]=o,e[4]=n,e[5]=a,e},points3ToSphere3:(()=>{const r=new ye(3);return(e,t)=>{t=t||c.vec4();let i=0,s=0,o=0,n;const a=e.length;for(n=0;n<a;n++)i+=e[n][0],s+=e[n][1],o+=e[n][2];t[0]=i/a,t[1]=s/a,t[2]=o/a;let A=0,l;for(n=0;n<a;n++)l=Math.abs(c.lenVec3(c.subVec3(e[n],t,r))),l>A&&(A=l);return t[3]=A,t}})(),positions3ToSphere3:(()=>{const r=new ye(3),e=new ye(3);return(t,i)=>{i=i||c.vec4();let s=0,o=0,n=0,a;const A=t.length;let l=0;for(a=0;a<A;a+=3)s+=t[a],o+=t[a+1],n+=t[a+2];const h=A/3;i[0]=s/h,i[1]=o/h,i[2]=n/h;let d;for(a=0;a<A;a+=3)r[0]=t[a],r[1]=t[a+1],r[2]=t[a+2],d=Math.abs(c.lenVec3(c.subVec3(r,i,e))),d>l&&(l=d);return i[3]=l,i}})(),OBB3ToSphere3:(()=>{const r=new ye(3),e=new ye(3);return(t,i)=>{i=i||c.vec4();let s=0,o=0,n=0,a;const A=t.length,l=A/4;for(a=0;a<A;a+=4)s+=t[a+0],o+=t[a+1],n+=t[a+2];i[0]=s/l,i[1]=o/l,i[2]=n/l;let h=0,d;for(a=0;a<A;a+=4)r[0]=t[a+0],r[1]=t[a+1],r[2]=t[a+2],d=Math.abs(c.lenVec3(c.subVec3(r,i,e))),d>h&&(h=d);return i[3]=h,i}})(),getSphere3Center(r,e=c.vec3()){return e[0]=r[0],e[1]=r[1],e[2]=r[2],e},getPositionsCenter(r,e=c.vec3()){let t=0,i=0,s=0;for(var o=0,n=r.length;o<n;o+=3)t+=r[o+0],i+=r[o+1],s+=r[o+2];const a=r.length/3;return e[0]=t/a,e[1]=i/a,e[2]=s/a,e},expandAABB3(r,e){return r[0]>e[0]&&(r[0]=e[0]),r[1]>e[1]&&(r[1]=e[1]),r[2]>e[2]&&(r[2]=e[2]),r[3]<e[3]&&(r[3]=e[3]),r[4]<e[4]&&(r[4]=e[4]),r[5]<e[5]&&(r[5]=e[5]),r},expandAABB3Point3(r,e){return r[0]>e[0]&&(r[0]=e[0]),r[1]>e[1]&&(r[1]=e[1]),r[2]>e[2]&&(r[2]=e[2]),r[3]<e[0]&&(r[3]=e[0]),r[4]<e[1]&&(r[4]=e[1]),r[5]<e[2]&&(r[5]=e[2]),r},expandAABB3Points3(r,e){for(var t,i,s,o=0,n=e.length;o<n;o+=3)t=e[o],i=e[o+1],s=e[o+2],r[0]>t&&(r[0]=t),r[1]>i&&(r[1]=i),r[2]>s&&(r[2]=s),r[3]<t&&(r[3]=t),r[4]<i&&(r[4]=i),r[5]<s&&(r[5]=s);return r},collapseAABB2(r=c.AABB2()){return r[0]=c.MAX_DOUBLE,r[1]=c.MAX_DOUBLE,r[2]=c.MIN_DOUBLE,r[3]=c.MIN_DOUBLE,r},point3AABB3Intersect(r,e){return r[0]>e[0]||r[3]<e[0]||r[1]>e[1]||r[4]<e[1]||r[2]>e[2]||r[5]<e[2]},planeAABB3Intersect(r,e,t){let i,s;return r[0]>0?(i=r[0]*t[0],s=r[0]*t[3]):(i=r[0]*t[3],s=r[0]*t[0]),r[1]>0?(i+=r[1]*t[1],s+=r[1]*t[4]):(i+=r[1]*t[4],s+=r[1]*t[1]),r[2]>0?(i+=r[2]*t[2],s+=r[2]*t[5]):(i+=r[2]*t[5],s+=r[2]*t[2]),i<=-e&&s<=-e?-1:i>=-e&&s>=-e?1:0},OBB3ToAABB2(r,e=c.AABB2()){let t=c.MAX_DOUBLE,i=c.MAX_DOUBLE,s=c.MIN_DOUBLE,o=c.MIN_DOUBLE,n,a,A,l;for(let h=0,d=r.length;h<d;h+=4)n=r[h+0],a=r[h+1],A=r[h+3]||1,l=1/A,n*=l,a*=l,n<t&&(t=n),a<i&&(i=a),n>s&&(s=n),a>o&&(o=a);return e[0]=t,e[1]=i,e[2]=s,e[3]=o,e},expandAABB2(r,e){return r[0]>e[0]&&(r[0]=e[0]),r[1]>e[1]&&(r[1]=e[1]),r[2]<e[2]&&(r[2]=e[2]),r[3]<e[3]&&(r[3]=e[3]),r},expandAABB2Point2(r,e){return r[0]>e[0]&&(r[0]=e[0]),r[1]>e[1]&&(r[1]=e[1]),r[2]<e[0]&&(r[2]=e[0]),r[3]<e[1]&&(r[3]=e[1]),r},AABB2ToCanvas(r,e,t,i=r){const s=(r[0]+1)*.5,o=(r[1]+1)*.5,n=(r[2]+1)*.5,a=(r[3]+1)*.5;return i[0]=Math.floor(s*e),i[1]=t-Math.floor(a*t),i[2]=Math.floor(n*e),i[3]=t-Math.floor(o*t),i},tangentQuadraticBezier(r,e,t,i){return 2*(1-r)*(t-e)+2*r*(i-t)},tangentQuadraticBezier3(r,e,t,i,s){return-3*e*(1-r)*(1-r)+3*t*(1-r)*(1-r)-6*r*t*(1-r)+6*r*i*(1-r)-3*r*r*i+3*r*r*s},tangentSpline(r){const e=6*r*r-6*r,t=3*r*r-4*r+1,i=-6*r*r+6*r,s=3*r*r-2*r;return e+t+i+s},catmullRomInterpolate(r,e,t,i,s){const o=(t-r)*.5,n=(i-e)*.5,a=s*s,A=s*a;return(2*e-2*t+o+n)*A+(-3*e+3*t-2*o-n)*a+o*s+e},b2p0(r,e){const t=1-r;return t*t*e},b2p1(r,e){return 2*(1-r)*r*e},b2p2(r,e){return r*r*e},b2(r,e,t,i){return this.b2p0(r,e)+this.b2p1(r,t)+this.b2p2(r,i)},b3p0(r,e){const t=1-r;return t*t*t*e},b3p1(r,e){const t=1-r;return 3*t*t*r*e},b3p2(r,e){return 3*(1-r)*r*r*e},b3p3(r,e){return r*r*r*e},b3(r,e,t,i,s){return this.b3p0(r,e)+this.b3p1(r,t)+this.b3p2(r,i)+this.b3p3(r,s)},triangleNormal(r,e,t,i=c.vec3()){const s=e[0]-r[0],o=e[1]-r[1],n=e[2]-r[2],a=t[0]-r[0],A=t[1]-r[1],l=t[2]-r[2],h=o*l-n*A,d=n*a-s*l,f=s*A-o*a,m=Math.sqrt(h*h+d*d+f*f);return m===0?(i[0]=0,i[1]=0,i[2]=0):(i[0]=h/m,i[1]=d/m,i[2]=f/m),i},rayTriangleIntersect:(()=>{const r=new ye(3),e=new ye(3),t=new ye(3),i=new ye(3),s=new ye(3);return(o,n,a,A,l,h)=>{h=h||c.vec3();const d=1e-6,f=c.subVec3(A,a,r),m=c.subVec3(l,a,e),_=c.cross3Vec3(n,m,t),u=c.dotVec3(f,_);if(u<d)return null;const B=c.subVec3(o,a,i),y=c.dotVec3(B,_);if(y<0||y>u)return null;const x=c.cross3Vec3(B,f,s),P=c.dotVec3(n,x);if(P<0||y+P>u)return null;const v=c.dotVec3(m,x)/u;return h[0]=o[0]+v*n[0],h[1]=o[1]+v*n[1],h[2]=o[2]+v*n[2],h}})(),rayPlaneIntersect:(()=>{const r=new ye(3),e=new ye(3),t=new ye(3),i=new ye(3);return(s,o,n,a,A,l)=>{l=l||c.vec3(),o=c.normalizeVec3(o,r);const h=c.subVec3(a,n,e),d=c.subVec3(A,n,t),f=c.cross3Vec3(h,d,i);c.normalizeVec3(f,f);const m=-c.dotVec3(n,f),_=-(c.dotVec3(s,f)+m)/c.dotVec3(o,f);return l[0]=s[0]+_*o[0],l[1]=s[1]+_*o[1],l[2]=s[2]+_*o[2],l}})(),cartesianToBarycentric:(()=>{const r=new ye(3),e=new ye(3),t=new ye(3);return(i,s,o,n,a)=>{const A=c.subVec3(n,s,r),l=c.subVec3(o,s,e),h=c.subVec3(i,s,t),d=c.dotVec3(A,A),f=c.dotVec3(A,l),m=c.dotVec3(A,h),_=c.dotVec3(l,l),u=c.dotVec3(l,h),B=d*_-f*f;if(B===0)return null;const y=1/B,x=(_*m-f*u)*y,P=(d*u-f*m)*y;return a[0]=1-x-P,a[1]=P,a[2]=x,a}})(),barycentricInsideTriangle(r){const e=r[1],t=r[2];return t>=0&&e>=0&&t+e<1},barycentricToCartesian(r,e,t,i,s=c.vec3()){const o=r[0],n=r[1],a=r[2];return s[0]=e[0]*o+t[0]*n+i[0]*a,s[1]=e[1]*o+t[1]*n+i[1]*a,s[2]=e[2]*o+t[2]*n+i[2]*a,s},mergeVertices(r,e,t,i){const s={},o=[],n=[],a=e?[]:null,A=t?[]:null,l=[];let h,d,f,m;const u=10**4;let B,y,x=0;for(B=0,y=r.length;B<y;B+=3)h=r[B],d=r[B+1],f=r[B+2],m=`${Math.round(h*u)}_${Math.round(d*u)}_${Math.round(f*u)}`,s[m]===void 0&&(s[m]=n.length/3,n.push(h),n.push(d),n.push(f),e&&(a.push(e[B]),a.push(e[B+1]),a.push(e[B+2])),t&&(A.push(t[x]),A.push(t[x+1]))),o[B/3]=s[m],x+=2;for(B=0,y=i.length;B<y;B++)l[B]=o[i[B]];const P={positions:n,indices:l};return a&&(P.normals=a),A&&(P.uv=A),P},buildNormals:(()=>{const r=new ye(3),e=new ye(3),t=new ye(3),i=new ye(3),s=new ye(3),o=new ye(3);return(n,a,A)=>{let l,h;const d=new Array(n.length/3);let f,m,_;for(l=0,h=a.length;l<h;l+=3){f=a[l],m=a[l+1],_=a[l+2],r[0]=n[f*3],r[1]=n[f*3+1],r[2]=n[f*3+2],e[0]=n[m*3],e[1]=n[m*3+1],e[2]=n[m*3+2],t[0]=n[_*3],t[1]=n[_*3+1],t[2]=n[_*3+2],c.subVec3(e,r,i),c.subVec3(t,r,s);const P=c.vec3();c.normalizeVec3(c.cross3Vec3(i,s,o),P),d[f]||(d[f]=[]),d[m]||(d[m]=[]),d[_]||(d[_]=[]),d[f].push(P),d[m].push(P),d[_].push(P)}A=A&&A.length===n.length?A:new Float32Array(n.length);let u,B,y,x;for(l=0,h=d.length;l<h;l++){u=d[l].length,B=0,y=0,x=0;for(let P=0;P<u;P++)B+=d[l][P][0],y+=d[l][P][1],x+=d[l][P][2];A[l*3]=B/u,A[l*3+1]=y/u,A[l*3+2]=x/u}return A}})(),buildTangents:(()=>{const r=new ye(3),e=new ye(3),t=new ye(3),i=new ye(3),s=new ye(3),o=new ye(3),n=new ye(3);return(a,A,l)=>{const h=new Float32Array(a.length);for(let d=0;d<A.length;d+=3){let f=A[d];const m=a.subarray(f*3,f*3+3),_=l.subarray(f*2,f*2+2);f=A[d+1];const u=a.subarray(f*3,f*3+3),B=l.subarray(f*2,f*2+2);f=A[d+2];const y=a.subarray(f*3,f*3+3),x=l.subarray(f*2,f*2+2),P=c.subVec3(u,m,r),v=c.subVec3(y,m,e),b=c.subVec2(B,_,t),C=c.subVec2(x,_,i),I=1/(b[0]*C[1]-b[1]*C[0]),E=c.mulVec3Scalar(c.subVec3(c.mulVec3Scalar(P,C[1],s),c.mulVec3Scalar(v,b[1],o),n),I,o);let S;for(let R=0;R<3;R++)S=A[d+R]*3,h[S]+=E[0],h[S+1]+=E[1],h[S+2]+=E[2]}return h}})(),buildPickTriangles(r,e,t){const i=e.length,s=t?new Uint16Array(i*9):new Float32Array(i*9),o=new Uint8Array(i*12);let n=0,a,A=0,l=0,h,d,f,m,_;for(let u=0;u<i;u+=3)_=n>>24&255,m=n>>16&255,f=n>>8&255,d=n&255,h=e[u],a=h*3,s[A++]=r[a],s[A++]=r[a+1],s[A++]=r[a+2],o[l++]=d,o[l++]=f,o[l++]=m,o[l++]=_,h=e[u+1],a=h*3,s[A++]=r[a],s[A++]=r[a+1],s[A++]=r[a+2],o[l++]=d,o[l++]=f,o[l++]=m,o[l++]=_,h=e[u+2],a=h*3,s[A++]=r[a],s[A++]=r[a+1],s[A++]=r[a+2],o[l++]=d,o[l++]=f,o[l++]=m,o[l++]=_,n++;return{positions:s,colors:o}},faceToVertexNormals(r,e,t={}){const i=t.smoothNormalsAngleThreshold||20,s={},o=[],n={};let a,A,l,h,d;const m=10**4;let _,u,B,y,x,P;for(u=0,y=r.length;u<y;u+=3){_=u/3,A=r[u],l=r[u+1],h=r[u+2],d=`${Math.round(A*m)}_${Math.round(l*m)}_${Math.round(h*m)}`,s[d]===void 0?s[d]=[_]:s[d].push(_);const v=c.normalizeVec3([e[u],e[u+1],e[u+2]]);o[_]=v,a=c.vec4([v[0],v[1],v[2],1]),n[_]=a}for(d in s)if(s.hasOwnProperty(d)){const v=s[d],b=v.length;for(u=0;u<b;u++){const C=v[u];for(a=n[C],B=0;B<b;B++){if(u===B)continue;const I=v[B];x=o[C],P=o[I],Math.abs(c.angleVec3(x,P)/c.DEGTORAD)<i&&(a[0]+=P[0],a[1]+=P[1],a[2]+=P[2],a[3]+=1)}}}for(u=0,y=e.length;u<y;u+=3)a=n[u/3],e[u+0]=a[0]/a[3],e[u+1]=a[1]/a[3],e[u+2]=a[2]/a[3]},transformRay:(()=>{const r=new ye(4),e=new ye(4);return(t,i,s,o,n)=>{r[0]=i[0],r[1]=i[1],r[2]=i[2],r[3]=1,c.transformVec4(t,r,e),o[0]=e[0],o[1]=e[1],o[2]=e[2],r[0]=s[0],r[1]=s[1],r[2]=s[2],c.transformVec3(t,r,e),c.normalizeVec3(e),n[0]=e[0],n[1]=e[1],n[2]=e[2]}})(),canvasPosToWorldRay:(()=>{const r=new ye(16),e=new ye(16),t=new ye(4),i=new ye(4),s=new ye(4),o=new ye(4);return(n,a,A,l,h,d)=>{const f=c.mulMat4(A,a,r),m=c.inverseMat4(f,e),_=n.width,u=n.height,B=(l[0]-_/2)/(_/2),y=-(l[1]-u/2)/(u/2);t[0]=B,t[1]=y,t[2]=-1,t[3]=1,c.transformVec4(m,t,i),c.mulVec4Scalar(i,1/i[3]),s[0]=B,s[1]=y,s[2]=1,s[3]=1,c.transformVec4(m,s,o),c.mulVec4Scalar(o,1/o[3]),h[0]=o[0],h[1]=o[1],h[2]=o[2],c.subVec3(o,i,d),c.normalizeVec3(d)}})(),canvasPosToLocalRay:(()=>{const r=new ye(3),e=new ye(3);return(t,i,s,o,n,a,A)=>{c.canvasPosToWorldRay(t,i,s,n,r,e),c.worldRayToLocalRay(o,r,e,a,A)}})(),worldRayToLocalRay:(()=>{const r=new ye(16),e=new ye(4),t=new ye(4);return(i,s,o,n,a)=>{const A=c.inverseMat4(i,r);e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=1,c.transformVec4(A,e,t),n[0]=t[0],n[1]=t[1],n[2]=t[2],c.transformVec3(A,o,a)}})(),buildKDTree:(()=>{const t=new Float32Array;function i(s,o,n,a){const A=new ye(6),l={triangles:null,left:null,right:null,leaf:!1,splitDim:0,aabb:A};A[0]=A[1]=A[2]=Number.POSITIVE_INFINITY,A[3]=A[4]=A[5]=Number.NEGATIVE_INFINITY;let h,d;for(h=0,d=s.length;h<d;++h){var f=s[h]*3;for(let P=0;P<3;++P){const v=o[f+P]*3;n[v]<A[0]&&(A[0]=n[v]),n[v]>A[3]&&(A[3]=n[v]),n[v+1]<A[1]&&(A[1]=n[v+1]),n[v+1]>A[4]&&(A[4]=n[v+1]),n[v+2]<A[2]&&(A[2]=n[v+2]),n[v+2]>A[5]&&(A[5]=n[v+2])}}if(s.length<20||a>10)return l.triangles=s,l.leaf=!0,l;t[0]=A[3]-A[0],t[1]=A[4]-A[1],t[2]=A[5]-A[2];let m=0;t[1]>t[m]&&(m=1),t[2]>t[m]&&(m=2),l.splitDim=m;const _=(A[m]+A[m+3])/2,u=new Array(s.length);let B=0;const y=new Array(s.length);let x=0;for(h=0,d=s.length;h<d;++h){var f=s[h]*3;const v=o[f],b=o[f+1],C=o[f+2],I=v*3,E=b*3,S=C*3;n[I+m]<=_||n[E+m]<=_||n[S+m]<=_?u[B++]=s[h]:y[x++]=s[h]}return u.length=B,y.length=x,l.left=i(u,o,n,a+1),l.right=i(y,o,n,a+1),l}return(s,o)=>{const n=s.length/3,a=new Array(n);for(let A=0;A<n;++A)a[A]=A;return i(a,s,o,0)}})(),decompressPosition(r,e,t){t=t||r,t[0]=r[0]*e[0]+e[12],t[1]=r[1]*e[5]+e[13],t[2]=r[2]*e[10]+e[14]},decompressPositions(r,e,t=new Float32Array(r.length)){for(let i=0,s=r.length;i<s;i+=3)t[i+0]=r[i+0]*e[0]+e[12],t[i+1]=r[i+1]*e[5]+e[13],t[i+2]=r[i+2]*e[10]+e[14];return t},decompressUV(r,e,t){t[0]=r[0]*e[0]+e[6],t[1]=r[1]*e[4]+e[7]},decompressUVs(r,e,t=new Float32Array(r.length)){for(let i=0,s=r.length;i<s;i+=3)t[i+0]=r[i+0]*e[0]+e[6],t[i+1]=r[i+1]*e[4]+e[7];return t},octDecodeVec2(r,e){let t=r[0],i=r[1];t=(2*t+1)/255,i=(2*i+1)/255;const s=1-Math.abs(t)-Math.abs(i);s<0&&(t=(1-Math.abs(i))*(t>=0?1:-1),i=(1-Math.abs(t))*(i>=0?1:-1));const o=Math.sqrt(t*t+i*i+s*s);return e[0]=t/o,e[1]=i/o,e[2]=s/o,e},octDecodeVec2s(r,e){for(let t=0,i=0,s=r.length;t<s;t+=2){let o=r[t+0],n=r[t+1];o=(2*o+1)/255,n=(2*n+1)/255;const a=1-Math.abs(o)-Math.abs(n);a<0&&(o=(1-Math.abs(n))*(o>=0?1:-1),n=(1-Math.abs(o))*(n>=0?1:-1));const A=Math.sqrt(o*o+n*n+a*a);e[i+0]=o/A,e[i+1]=n/A,e[i+2]=a/A,i+=3}return e}};c.buildEdgeIndices=function(){const r=[],e=[],t=[],i=[],s=[];let o=0;const n=new Uint16Array(3),a=new Uint16Array(3),A=new Uint16Array(3),l=c.vec3(),h=c.vec3(),d=c.vec3(),f=c.vec3(),m=c.vec3(),_=c.vec3(),u=c.vec3();function B(x,P){const v={};let b,C,I,E;const R=Math.pow(10,4);let D,K,j=0;for(D=0,K=x.length;D<K;D+=3)b=x[D],C=x[D+1],I=x[D+2],E=Math.round(b*R)+"_"+Math.round(C*R)+"_"+Math.round(I*R),v[E]===void 0&&(v[E]=j/3,r[j++]=b,r[j++]=C,r[j++]=I),e[D/3]=v[E];for(D=0,K=P.length;D<K;D++)i[D]=e[P[D]],t[i[D]]=P[D]}function y(x,P){o=0;for(let v=0,b=x;v<b;v+=3){const C=i[v]*3,I=i[v+1]*3,E=i[v+2]*3;P?(n[0]=r[C],n[1]=r[C+1],n[2]=r[C+2],a[0]=r[I],a[1]=r[I+1],a[2]=r[I+2],A[0]=r[E],A[1]=r[E+1],A[2]=r[E+2],c.decompressPosition(n,P,l),c.decompressPosition(a,P,h),c.decompressPosition(A,P,d)):(l[0]=r[C],l[1]=r[C+1],l[2]=r[C+2],h[0]=r[I],h[1]=r[I+1],h[2]=r[I+2],d[0]=r[E],d[1]=r[E+1],d[2]=r[E+2]),c.subVec3(d,h,f),c.subVec3(l,h,m),c.cross3Vec3(f,m,_),c.normalizeVec3(_,u);const S=s[o]||(s[o]={normal:c.vec3()});S.normal[0]=u[0],S.normal[1]=u[1],S.normal[2]=u[2],o++}}return function(x,P,v,b){B(x,P),y(P.length,v);const C=[],I=Math.cos(c.DEGTORAD*b),E={};let S,R,D,K,j,z=!1,le,ue,ae,Be,be,xe;for(let Ie=0,Fe=P.length;Ie<Fe;Ie+=3){const Qe=Ie/3;for(let Ge=0;Ge<3;Ge++)S=i[Ie+Ge],R=i[Ie+(Ge+1)%3],D=Math.min(S,R),K=Math.max(S,R),j=D+","+K,E[j]===void 0?E[j]={index1:D,index2:K,face1:Qe,face2:void 0}:E[j].face2=Qe}for(j in E)le=E[j],!(le.face2!==void 0&&(ue=s[le.face1].normal,ae=s[le.face2].normal,Be=c.dotVec3(ue,ae),Be>I))&&(be=t[le.index1],xe=t[le.index2],(!z&&be>65535||xe>65535)&&(z=!0),C.push(be),C.push(xe));return z?new Uint32Array(C):new Uint16Array(C)}}();c.planeClipsPositions3=function(r,e,t,i=3){for(let s=0,o=t.length;s<o;s+=i)if(Vs[0]=t[s+0]-r[0],Vs[1]=t[s+1]-r[1],Vs[2]=t[s+2]-r[2],Vs[0]*e[0]+Vs[1]*e[1]+Vs[2]*e[2]<0)return!0;return!1};class j_{constructor(){this._head=[],this._headLength=0,this._tail=[],this._index=0,this._length=0}get length(){return this._length}shift(){if(this._index>=this._headLength){const t=this._head;if(t.length=0,this._head=this._tail,this._tail=t,this._index=0,this._headLength=this._head.length,!this._headLength)return}const e=this._head[this._index];return this._index<0?delete this._head[this._index++]:this._head[this._index++]=void 0,this._length--,e}push(e){return this._length++,this._tail.push(e),this}unshift(e){return this._head[--this._index]=e,this._length++,this}}const vt={build:{version:"0.8"},client:{browser:navigator&&navigator.userAgent?navigator.userAgent:"n/a"},components:{scenes:0,models:0,meshes:0,objects:0},memory:{meshes:0,positions:0,colors:0,normals:0,uvs:0,indices:0,textures:0,transforms:0,materials:0,programs:0},frame:{frameCount:0,fps:0,useProgram:0,bindTexture:0,bindArray:0,drawElements:0,drawArrays:0,tasksRun:0,tasksScheduled:0}};function Df(r,e){if(r.nodeType===r.TEXT_NODE){var t=r.nodeValue;if(t.match(/^\s+$/)===null)return t}else if(r.nodeType===r.ELEMENT_NODE||r.nodeType===r.DOCUMENT_NODE){var i={type:r.nodeName,children:[]};if(r.nodeType===r.ELEMENT_NODE)for(var s=0;s<r.attributes.length;s++){var o=r.attributes[s],n=e[o.nodeName]||o.nodeName;i[n]=o.nodeValue}for(var a=0;a<r.childNodes.length;a++){var A=r.childNodes[a],s=Df(A,e);s&&i.children.push(s)}return i}}function z_(r){return JSON.parse(JSON.stringify(r))}var K_=[["0",10],["A",26],["a",26],["_",1],["$",1]].map(function(r){for(var e=[],t=r[0].charCodeAt(0),i=t+r[1],s=t;s<i;++s)e.push(s);return String.fromCharCode.apply(null,e)}).join("");function fh(r,e){var t=!e||e===4?[0,6,12,18]:[0,6];return t.map(function(i){return K_.substr(parseInt(r/(1<<i))%64,1)}).reverse().join("")}function W_(r){var e=[0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30].map(function(t){return parseInt(r.substr(t,2),16)});return fh(e[0],2)+[1,4,7,10,13].map(function(t){return fh((e[t]<<16)+(e[t+1]<<8)+e[t+2])}).join("")}function X_(r,e){var t=[],i=function(s){s.type===e&&t.push(s),(s.children||[]).forEach(function(o){i(o)})};return i(r),t}function Y_(r){return new Promise(function(e,t){setTimeout(e,r)})}function J_(r){return new Promise(function(e,t){var i=new XMLHttpRequest;i.open(r.method||"GET",r.url,!0),i.onload=function(s){i.readyState===4&&(i.status===200?e(i.responseXML):t(i.statusText))},i.send(null)})}const Z_=function(){for(var r={},e=window.location.search.substring(1),t=e.split("&"),i=0;i<t.length;i++){var s=t[i].split("=");if(typeof r[s[0]]>"u")r[s[0]]=decodeURIComponent(s[1]);else if(typeof r[s[0]]=="string"){var o=[r[s[0]],decodeURIComponent(s[1])];r[s[0]]=o}else r[s[0]].push(decodeURIComponent(s[1]))}return r}();function q_(r,e,t){var i=o=>{};e=e||i,t=t||i;var s=new XMLHttpRequest;s.overrideMimeType("application/json"),s.open("GET",r,!0),s.addEventListener("load",function(o){var n=o.target.response;if(this.status===200){var a;try{a=JSON.parse(n)}catch(A){t(`utils.loadJSON(): Failed to parse JSON response - ${A}`)}e(a)}else if(this.status===0){console.warn("loadFile: HTTP Status 0 received.");try{e(JSON.parse(n))}catch(A){t(`utils.loadJSON(): Failed to parse JSON response - ${A}`)}}else t(o)},!1),s.addEventListener("error",function(o){t(o)},!1),s.send(null)}function $_(r,e,t){var i=A=>{};e=e||i,t=t||i;const s=/^data:(.*?)(;base64)?,(.*)$/,o=r.match(s);if(o){const A=!!o[2];var n=o[3];n=window.decodeURIComponent(n),A&&(n=window.atob(n));try{const l=new ArrayBuffer(n.length),h=new Uint8Array(l);for(var a=0;a<n.length;a++)h[a]=n.charCodeAt(a);Bt.scheduleTask(()=>{e(l)})}catch(l){Bt.scheduleTask(()=>{t(l)})}}else{const A=new XMLHttpRequest;A.open("GET",r,!0),A.responseType="arraybuffer",A.onreadystatechange=function(){A.readyState===4&&(A.status===200?e(A.response):t("loadArrayBuffer error : "+A.response))},A.send(null)}}function e0(r){return r&&!r.propertyIsEnumerable("length")&&typeof r=="object"&&typeof r.length=="number"}function t0(r){return typeof r=="string"||r instanceof String}function i0(r){return!isNaN(parseFloat(r))&&isFinite(r)}function s0(r){return Se.isString(r)||Se.isNumeric(r)}function r0(r,e){if(!r||!e)return!1;const t=Se.isNumeric(r)||Se.isString(r)?`${r}`:r.id,i=Se.isNumeric(e)||Se.isString(e)?`${e}`:e.id;return t===i}function o0(r){return typeof r=="function"}function n0(r){const e={}.constructor;return!!r&&r.constructor===e}function a0(r){return Se.apply(r,{})}function A0(r,e){for(const t in r)r.hasOwnProperty(t)&&(e[t]=r[t]);return e}function l0(r,e){for(const t in r)r.hasOwnProperty(t)&&r[t]!==void 0&&r[t]!==null&&(e[t]=r[t]);return e}function c0(r,e){for(const t in r)r.hasOwnProperty(t)&&(e[t]===void 0||e[t]===null)&&(e[t]=r[t]);return e}function h0(r){for(const e in r)if(r.hasOwnProperty(e))return!1;return!0}function u0(r){return Se.isNumeric(r)?`${r}`:`'${r}'`}function d0(r,e){const t=new r.constructor(r.length+e.length);return t.set(r),t.set(e,r.length),t}function p0(r){var e=[];function t(i){i.id=i.uuid,delete i.oid,e.push(i);var s=i.children;if(s)for(var o=0,n=s.length;o<n;o++){const a=s[o];a.parent=i.id,t(s[o])}i.children=[]}return t(r),e}const Se={xmlToJson:Df,clone:z_,compressGuid:W_,findNodeOfType:X_,timeout:Y_,httpRequest:J_,loadJSON:q_,loadArraybuffer:$_,queryString:Z_,isArray:e0,isString:t0,isNumeric:i0,isID:s0,isSameComponent:r0,isFunction:o0,isObject:n0,copy:a0,apply:A0,apply2:l0,applyIf:c0,isEmptyObject:h0,inQuotes:u0,concat:d0,flattenParentChildHierarchy:p0},na={},gh=new Si,Gs=new j_,Ji={sceneId:null,time:null,startTime:null,prevTime:null,deltaTime:null},mh=10,gs=[],Rf=30;let Po=0,vr,Br=0;function f0(){this.version="1.0.0",this.scenes={},this._superTypes={},this._addScene=function(r){if(r.id){if(Bt.scenes[r.id]){console.error(`[ERROR] Scene ${Se.inQuotes(r.id)} already exists`);return}}else r.id=gh.addItem({});Bt.scenes[r.id]=r;const e=r.ticksPerOcclusionTest,t=r.ticksPerRender;na[r.id]={ticksPerOcclusionTest:e,ticksPerRender:t,renderCountdown:t},vt.components.scenes++,r.once("destroyed",()=>{gh.removeItem(r.id),delete Bt.scenes[r.id],delete na[r.id],vt.components.scenes--})},this.clear=function(){let r;for(const e in Bt.scenes)Bt.scenes.hasOwnProperty(e)&&(r=Bt.scenes[e],e==="default.scene"?r.clear():(r.destroy(),delete Bt.scenes[r.id]))},this.scheduleTask=function(r,e=null){Gs.push(r),Gs.push(e)},this.runTasks=function(r=-1){let e=new Date().getTime(),t,i,s=0;for(;Gs.length>0&&(r<0||e<r);)t=Gs.shift(),i=Gs.shift(),i?t.call(i):t(),e=new Date().getTime(),s++;return s},this.getNumTasks=function(){return Gs.length}}const Bt=new f0,Lf=function(){let r=Date.now();if(vr=r-Po,Po>0&&vr>0){var e=1e3/vr;Br+=e,gs.push(e),gs.length>=Rf&&(Br-=gs.shift()),vt.frame.fps=Math.round(Br/gs.length)}for(let t in Bt.scenes)Bt.scenes[t].compile();Of(r),Po=r};function g0(r,e){let t=Date.now()+e;function i(){const s=Date.now()-t;r(),t+=e,setTimeout(i,Math.max(0,e-s))}return i(),{cancel:function(){}}}g0(()=>{Lf()},100);const Uf=function(){let r=Date.now();if(vr=r-Po,Po>0&&vr>0){var e=1e3/vr;Br+=e,gs.push(e),gs.length>=Rf&&(Br-=gs.shift()),vt.frame.fps=Math.round(Br/gs.length)}Of(r),m0(r),_0(),window.requestPostAnimationFrame!==void 0?window.requestPostAnimationFrame(Lf):requestAnimationFrame(Uf)};Uf();function Of(r){const e=Bt.runTasks(r+mh),t=Bt.getNumTasks();vt.frame.tasksRun=e,vt.frame.tasksScheduled=t,vt.frame.tasksBudget=mh}function m0(r){Ji.time=r;for(var e in Bt.scenes)if(Bt.scenes.hasOwnProperty(e)){var t=Bt.scenes[e];Ji.sceneId=e,Ji.startTime=t.startTime,Ji.deltaTime=Ji.prevTime!=null?Ji.time-Ji.prevTime:0,t.fire("tick",Ji,!0)}Ji.prevTime=r}function _0(){const r=Bt.scenes,e=!1;let t,i,s,o,n;for(n in r)r.hasOwnProperty(n)&&(t=r[n],i=na[n],i||(i=na[n]={}),s=t.ticksPerOcclusionTest,i.ticksPerOcclusionTest!==s&&(i.ticksPerOcclusionTest=s,i.renderCountdown=s),--t.occlusionTestCountdown<=0&&(t.doOcclusionTest(),t.occlusionTestCountdown=s),o=t.ticksPerRender,i.ticksPerRender!==o&&(i.ticksPerRender=o,i.renderCountdown=o),--i.renderCountdown===0&&(t.render(e),i.renderCountdown=o))}class It{get type(){return"Component"}get isComponent(){return!0}constructor(e=null,t={}){if(this.scene=null,this.type==="Scene")this.scene=this,this.viewer=t.viewer;else{if(e.type==="Scene")this.scene=e;else if(e instanceof It)this.scene=e.scene;else throw"Invalid param: owner must be a Component";this._owner=e}this._dontClear=!!t.dontClear,this._renderer=this.scene._renderer,this.meta=t.meta||{},this.id=t.id,this.destroyed=!1,this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._eventSubsNum=null,this._events=null,this._eventCallDepth=0,this._ownedComponents=null,this!==this.scene&&this.scene._addComponent(this),this._updateScheduled=!1,e&&e._own(this)}glRedraw(){this._renderer&&(this._renderer.imageDirty(),this.castsShadow&&this._renderer.shadowsDirty())}glResort(){this._renderer&&this._renderer.needStateSort()}get owner(){return this._owner}isType(e){return this.type===e}fire(e,t,i){this._events||(this._events={}),this._eventSubs||(this._eventSubs={},this._eventSubsNum={}),i!==!0&&(this._events[e]=t||!0);const s=this._eventSubs[e];let o;if(s)for(const n in s)s.hasOwnProperty(n)&&(o=s[n],this._eventCallDepth++,this._eventCallDepth<300?o.callback.call(o.scope,t):this.error("fire: potential stack overflow from recursive event '"+e+"' - dropping this event"),this._eventCallDepth--)}on(e,t,i){this._events||(this._events={}),this._subIdMap||(this._subIdMap=new Si),this._subIdEvents||(this._subIdEvents={}),this._eventSubs||(this._eventSubs={}),this._eventSubsNum||(this._eventSubsNum={});let s=this._eventSubs[e];s?this._eventSubsNum[e]++:(s={},this._eventSubs[e]=s,this._eventSubsNum[e]=1);const o=this._subIdMap.addItem();s[o]={callback:t,scope:i||this},this._subIdEvents[o]=e;const n=this._events[e];return n!==void 0&&t.call(i||this,n),o}off(e){if(e==null||!this._subIdEvents)return;const t=this._subIdEvents[e];if(t){delete this._subIdEvents[e];const i=this._eventSubs[t];i&&(delete i[e],this._eventSubsNum[t]--),this._subIdMap.removeItem(e)}}once(e,t,i){const s=this,o=this.on(e,function(n){s.off(o),t.call(i||this,n)},i)}hasSubs(e){return this._eventSubsNum&&this._eventSubsNum[e]>0}log(e){e="[LOG]"+this._message(e),window.console.log(e),this.scene.fire("log",e)}_message(e){return" ["+this.type+" "+Se.inQuotes(this.id)+"]: "+e}warn(e){e="[WARN]"+this._message(e),window.console.warn(e),this.scene.fire("warn",e)}error(e){e="[ERROR]"+this._message(e),window.console.error(e),this.scene.fire("error",e)}_attach(e){const t=e.name;if(!t){this.error("Component 'name' expected");return}let i=e.component;const s=e.sceneDefault,o=e.sceneSingleton,n=e.type,a=e.on,A=e.recompiles!==!1;let l=!1;if(i&&(Se.isNumeric(i)||Se.isString(i))){const _=i;if(i=this.scene.components[_],!i){this.error("Component not found: "+Se.inQuotes(_));return}}if(!i){if(o===!0){const _=this.scene.types[n];for(const u in _)if(_.hasOwnProperty){i=_[u];break}if(!i)return this.error("Scene has no default component for '"+t+"'"),null}else if(s===!0&&(i=this.scene[t],!i))return this.error("Scene has no default component for '"+t+"'"),null}if(i){if(i.scene.id!==this.scene.id){this.error("Not in same scene: "+i.type+" "+Se.inQuotes(i.id));return}if(n&&!i.isType(n)){this.error("Expected a "+n+" type or subtype: "+i.type+" "+Se.inQuotes(i.id));return}}this._attachments||(this._attachments={});const h=this._attached[t];let d,f,m;if(h){if(i&&h.id===i.id)return;const _=this._attachments[h.id];for(d=_.subs,f=0,m=d.length;f<m;f++)h.off(d[f]);delete this._attached[t],delete this._attachments[h.id];const u=_.params.onDetached;u&&(Se.isFunction(u)?u(h):u.scope?u.callback.call(u.scope,h):u.callback(h)),_.managingLifecycle&&h.destroy()}if(i){const _={params:e,component:i,subs:[],managingLifecycle:l};_.subs.push(i.once("destroyed",function(){_.params.component=null,this._attach(_.params)},this)),A&&_.subs.push(i.on("dirty",function(){this.fire("dirty",this)},this)),this._attached[t]=i,this._attachments[i.id]=_;const u=e.onAttached;if(u&&(Se.isFunction(u)?u(i):u.scope?u.callback.call(u.scope,i):u.callback(i)),a){let B,y,x,P;for(B in a)if(a.hasOwnProperty(B)){if(y=a[B],Se.isFunction(y)?(x=y,P=null):(x=y.callback,P=y.scope),!x)continue;_.subs.push(i.on(B,x,P))}}}return A&&this.fire("dirty",this),this.fire(t,i),i}_checkComponent(e,t){if(!t.isComponent)if(Se.isID(t)){const i=t;if(t=this.scene.components[i],!t){this.error("Component not found: "+i);return}}else{this.error("Expected a Component or ID");return}if(e!==t.type){this.error("Expected a "+e+" Component");return}if(t.scene.id!==this.scene.id){this.error("Not in same scene: "+t.type);return}return t}_checkComponent2(e,t){if(!t.isComponent)if(Se.isID(t)){const o=t;if(t=this.scene.components[o],!t){this.error("Component not found: "+o);return}}else{this.error("Expected a Component or ID");return}if(t.scene.id!==this.scene.id){this.error("Not in same scene: "+t.type);return}for(var i=0,s=e.length;i<s;i++)if(e[i]===t.type)return t;return this.error("Expected component types: "+e),null}_own(e){this._ownedComponents||(this._ownedComponents={}),this._ownedComponents[e.id]||(this._ownedComponents[e.id]=e),e.once("destroyed",()=>{delete this._ownedComponents[e.id]},this)}_needUpdate(e){this._updateScheduled||(this._updateScheduled=!0,e===0?this._doUpdate():Bt.scheduleTask(this._doUpdate,this))}_doUpdate(){this._updateScheduled&&(this._updateScheduled=!1,this._update&&this._update())}scheduleTask(e){Bt.scheduleTask(e,null)}_update(){}clear(){if(this._ownedComponents)for(var e in this._ownedComponents)this._ownedComponents.hasOwnProperty(e)&&(this._ownedComponents[e].destroy(),delete this._ownedComponents[e])}destroy(){if(this.destroyed)return;this.fire("destroyed",this.destroyed=!0);let e,t,i,s,o,n;if(this._attachments){for(e in this._attachments)if(this._attachments.hasOwnProperty(e)){for(t=this._attachments[e],i=t.component,s=t.subs,o=0,n=s.length;o<n;o++)i.off(s[o]);t.managingLifecycle&&i.destroy()}}if(this._ownedComponents)for(e in this._ownedComponents)this._ownedComponents.hasOwnProperty(e)&&(i=this._ownedComponents[e],i.destroy(),delete this._ownedComponents[e]);this.scene._removeComponent(this),this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._events=null,this._eventCallDepth=0,this._ownedComponents=null,this._updateScheduled=!1}}const v0=c.vec3(),B0=c.vec3(),P0=c.mat4();class js{constructor(){this.normal=c.vec3(),this.offset=0,this.testVertex=c.vec3()}set(e,t,i,s){const o=1/Math.sqrt(e*e+t*t+i*i);this.normal[0]=e*o,this.normal[1]=t*o,this.normal[2]=i*o,this.offset=s*o,this.testVertex[0]=this.normal[0]>=0?1:0,this.testVertex[1]=this.normal[1]>=0?1:0,this.testVertex[2]=this.normal[2]>=0?1:0}}class xi{constructor(){this.planes=[new js,new js,new js,new js,new js,new js]}}xi.INSIDE=0;xi.INTERSECT=1;xi.OUTSIDE=2;function y0(r,e,t){const i=c.mulMat4(t,e,P0),s=i[0],o=i[1],n=i[2],a=i[3],A=i[4],l=i[5],h=i[6],d=i[7],f=i[8],m=i[9],_=i[10],u=i[11],B=i[12],y=i[13],x=i[14],P=i[15];r.planes[0].set(a-s,d-A,u-f,P-B),r.planes[1].set(a+s,d+A,u+f,P+B),r.planes[2].set(a-o,d-l,u-m,P-y),r.planes[3].set(a+o,d+l,u+m,P+y),r.planes[4].set(a-n,d-h,u-_,P-x),r.planes[5].set(a+n,d+h,u+_,P+x)}function Za(r,e){let t=xi.INSIDE;const i=v0,s=B0;i[0]=e[0],i[1]=e[1],i[2]=e[2],s[0]=e[3],s[1]=e[4],s[2]=e[5];const o=[i,s];for(let n=0;n<6;++n){const a=r.planes[n];if(a.normal[0]*o[a.testVertex[0]][0]+a.normal[1]*o[a.testVertex[1]][1]+a.normal[2]*o[a.testVertex[2]][2]+a.offset<0)return xi.OUTSIDE;a.normal[0]*o[1-a.testVertex[0]][0]+a.normal[1]*o[1-a.testVertex[1]][1]+a.normal[2]*o[1-a.testVertex[2]][2]+a.offset<0&&(t=xi.INTERSECT)}return t}class Ss extends It{constructor(e={}){if(!e.viewer)throw"[MarqueePicker] Missing config: viewer";if(!e.objectsKdTree3)throw"[MarqueePicker] Missing config: objectsKdTree3";super(e.viewer.scene,e),this.viewer=e.viewer,this._objectsKdTree3=e.objectsKdTree3,this._canvasMarqueeCorner1=c.vec2(),this._canvasMarqueeCorner2=c.vec2(),this._canvasMarquee=c.AABB2(),this._marqueeFrustum=new xi,this._marqueeFrustumProjMat=c.mat4(),this._pickMode=!1,this._marqueeElement=document.createElement("div"),document.body.appendChild(this._marqueeElement),this._marqueeElement.style.position="absolute",this._marqueeElement.style["z-index"]="40000005",this._marqueeElement.style.width="8px",this._marqueeElement.style.height="8px",this._marqueeElement.style.visibility="hidden",this._marqueeElement.style.top="0px",this._marqueeElement.style.left="0px",this._marqueeElement.style["box-shadow"]="0 2px 5px 0 #182A3D;",this._marqueeElement.style.opacity=1,this._marqueeElement.style["pointer-events"]="none"}setMarqueeCorner1(e){this._canvasMarqueeCorner1.set(e),this._canvasMarqueeCorner2.set(e),this._updateMarquee()}setMarqueeCorner2(e){this._canvasMarqueeCorner2.set(e),this._updateMarquee()}setMarquee(e,t){this._canvasMarqueeCorner1.set(e),this._canvasMarqueeCorner2.set(t),this._updateMarquee()}setMarqueeVisible(e){this._marqueVisible=e,this._marqueeElement.style.visibility=e?"visible":"hidden"}getMarqueeVisible(){return this._marqueVisible}setPickMode(e){if(e!==Ss.PICK_MODE_INSIDE&&e!==Ss.PICK_MODE_INTERSECTS)throw"Illegal MarqueePicker pickMode: must be MarqueePicker.PICK_MODE_INSIDE or MarqueePicker.PICK_MODE_INTERSECTS";e!==this._pickMode&&(this._marqueeElement.style["background-image"]=e===Ss.PICK_MODE_INSIDE?`url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='6' ry='6' stroke='%23333' stroke-width='4'/%3e%3c/svg%3e")`:`url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='6' ry='6' stroke='%23333' stroke-width='4' stroke-dasharray='6%2c 14' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e")`,this._pickMode=e)}getPickMode(){return this._pickMode}clear(){this.fire("clear",{})}pick(){this._updateMarquee(),this._buildMarqueeFrustum();const e=[],t=(i,s=xi.INTERSECT)=>{if(s===xi.INTERSECT&&(s=Za(this._marqueeFrustum,i.aabb)),s!==xi.OUTSIDE){if(i.entities){const o=i.entities;for(let n=0,a=o.length;n<a;n++){const A=o[n];if(!A.visible)continue;const l=A.aabb;this._pickMode===Ss.PICK_MODE_INSIDE?Za(this._marqueeFrustum,l)===xi.INSIDE&&e.push(A.id):Za(this._marqueeFrustum,l)!==xi.OUTSIDE&&e.push(A.id)}}i.left&&t(i.left,s),i.right&&t(i.right,s)}};return(this._canvasMarquee[2]-this._canvasMarquee[0]>3||this._canvasMarquee[3]-this._canvasMarquee[1]>3)&&t(this._objectsKdTree3.root),this.fire("picked",e),e}_updateMarquee(){this._canvasMarquee[0]=Math.min(this._canvasMarqueeCorner1[0],this._canvasMarqueeCorner2[0]),this._canvasMarquee[1]=Math.min(this._canvasMarqueeCorner1[1],this._canvasMarqueeCorner2[1]),this._canvasMarquee[2]=Math.max(this._canvasMarqueeCorner1[0],this._canvasMarqueeCorner2[0]),this._canvasMarquee[3]=Math.max(this._canvasMarqueeCorner1[1],this._canvasMarqueeCorner2[1]),this._marqueeElement.style.width=`${this._canvasMarquee[2]-this._canvasMarquee[0]}px`,this._marqueeElement.style.height=`${this._canvasMarquee[3]-this._canvasMarquee[1]}px`,this._marqueeElement.style.left=`${this._canvasMarquee[0]}px`,this._marqueeElement.style.top=`${this._canvasMarquee[1]}px`}_buildMarqueeFrustum(){const e=this.viewer.scene.canvas.canvas,t=e.clientWidth,i=e.clientHeight,s=e.clientLeft,o=e.clientTop,n=2/t,a=2/i,A=17,l=e.clientHeight/e.clientWidth,h=1e4,d=(this._canvasMarquee[0]-s)*n+-1,f=(this._canvasMarquee[2]-s)*n+-1,m=-(this._canvasMarquee[3]-o)*a+1,_=-(this._canvasMarquee[1]-o)*a+1,u=this.viewer.scene.camera.frustum.near*(A*l),B=h;c.frustumMat4(d,f,m*l,_*l,u,B,this._marqueeFrustumProjMat),y0(this._marqueeFrustum,this.viewer.scene.camera.viewMatrix,this._marqueeFrustumProjMat)}destroy(){super.destroy(),this._marqueeElement.parentElement&&(this._marqueeElement.parentElement.removeChild(this._marqueeElement),this._marqueeElement=null,this._objectsKdTree3=null)}}Ss.PICK_MODE_INTERSECTS=0;Ss.PICK_MODE_INSIDE=1;class kf{constructor(e,t,i){this.id=i&&i.id?i.id:e,this.viewer=t,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._eventSubsNum=null,this._events=null,this._eventCallDepth=0,t.addPlugin(this)}scheduleTask(e){Bt.scheduleTask(e,null)}fire(e,t,i){this._events||(this._events={}),this._eventSubs||(this._eventSubs={},this._eventSubsNum={}),i!==!0&&(this._events[e]=t||!0);const s=this._eventSubs[e];let o;if(s)for(const n in s)s.hasOwnProperty(n)&&(o=s[n],this._eventCallDepth++,this._eventCallDepth<300?o.callback.call(o.scope,t):this.error("fire: potential stack overflow from recursive event '"+e+"' - dropping this event"),this._eventCallDepth--)}on(e,t,i){this._events||(this._events={}),this._subIdMap||(this._subIdMap=new Si),this._subIdEvents||(this._subIdEvents={}),this._eventSubs||(this._eventSubs={}),this._eventSubsNum||(this._eventSubsNum={});let s=this._eventSubs[e];s?this._eventSubsNum[e]++:(s={},this._eventSubs[e]=s,this._eventSubsNum[e]=1);const o=this._subIdMap.addItem();s[o]={callback:t,scope:i||this},this._subIdEvents[o]=e;const n=this._events[e];return n!==void 0&&t.call(i||this,n),o}off(e){if(e==null||!this._subIdEvents)return;const t=this._subIdEvents[e];if(t){delete this._subIdEvents[e];const i=this._eventSubs[t];i&&(delete i[e],this._eventSubsNum[t]--),this._subIdMap.removeItem(e)}}once(e,t,i){const s=this,o=this.on(e,function(n){s.off(o),t.call(i||this,n)},i)}hasSubs(e){return this._eventSubsNum&&this._eventSubsNum[e]>0}log(e){console.log(`[xeokit plugin ${this.id}]: ${e}`)}warn(e){console.warn(`[xeokit plugin ${this.id}]: ${e}`)}error(e){console.error(`[xeokit plugin ${this.id}]: ${e}`)}send(e,t){}destroy(){this.viewer.removePlugin(this)}}const Nf=c.vec3(),ft=function(){const r=new Float64Array(16),e=new Float64Array(4),t=new Float64Array(4);return function(i,s,o){return o=o||r,e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=1,c.transformVec4(i,e,t),c.setMat4Translation(i,t,o),o.slice()}}();function _h(r,e,t){const i=Float32Array.from([r[0]])[0],s=r[0]-i,o=Float32Array.from([r[1]])[0],n=r[1]-o,a=Float32Array.from([r[2]])[0],A=r[2]-a;e[0]=i,e[1]=o,e[2]=a,t[0]=s,t[1]=n,t[2]=A}function Cl(r,e,t,i=1e3){const s=c.getPositionsCenter(r,Nf),o=Math.round(s[0]/i)*i,n=Math.round(s[1]/i)*i,a=Math.round(s[2]/i)*i;t[0]=o,t[1]=n,t[2]=a;const A=t[0]!==0||t[1]!==0||t[2]!==0;if(A)for(let l=0,h=r.length;l<h;l+=3)e[l+0]=r[l+0]-o,e[l+1]=r[l+1]-n,e[l+2]=r[l+2]-a;return A}function Ot(r,e,t,i){const s=c.dotVec3(e,t)+r,o=c.normalizeVec3(e,Nf);return c.mulVec3Scalar(o,-s,i),i}const k={VISIBLE:1,CULLED:4,PICKABLE:8,CLIPPABLE:16,COLLIDABLE:32,CAST_SHADOW:64,RECEIVE_SHADOW:128,XRAYED:256,HIGHLIGHTED:512,SELECTED:1024,EDGES:2048,BACKFACES:4096,TRANSPARENT:8192},an=new Float32Array([0,0,0]),An=new Uint16Array([0,0,0]);c.OBB3();class x0{constructor(e,t,i,s,o,n){this._isObject=t,this.scene=e.scene,this.model=e,this.meshes=s,this._numPrimitives=0;for(let a=0,A=this.meshes.length;a<A;a++){const l=this.meshes[a];l.parent=this,l.entity=this,this._numPrimitives+=l.numPrimitives}this.id=i,this.originalSystemId=c.unglobalizeObjectId(e.id,i),this._flags=o,this._aabb=c.AABB3(),this._aabbDirty=!0,this._offset=c.vec3(),this._colorizeUpdated=!1,this._opacityUpdated=!1,this._lodCullable=!!n,this._culled=!1,this._culledVFC=!1,this._culledLOD=!1,this._isObject&&e.scene._registerObject(this)}_transformDirty(){this._aabbDirty=!0,this.model._transformDirty()}_sceneModelDirty(){this._aabbDirty=!0;for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._sceneModelDirty()}get aabb(){if(this._aabbDirty){c.collapseAABB3(this._aabb);for(let e=0,t=this.meshes.length;e<t;e++)c.expandAABB3(this._aabb,this.meshes[e].aabb);this._aabbDirty=!1}return this._aabb}get isEntity(){return!0}get isModel(){return!1}get isObject(){return this._isObject}get numPrimitives(){return this._numPrimitives}get numTriangles(){return this._numPrimitives}get visible(){return this._getFlag(k.VISIBLE)}set visible(e){if(!!(this._flags&k.VISIBLE)!==e){e?this._flags=this._flags|k.VISIBLE:this._flags=this._flags&~k.VISIBLE;for(let t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setVisible(this._flags);this._isObject&&this.model.scene._objectVisibilityUpdated(this),this.model.glRedraw()}}get highlighted(){return this._getFlag(k.HIGHLIGHTED)}set highlighted(e){if(!!(this._flags&k.HIGHLIGHTED)!==e){e?this._flags=this._flags|k.HIGHLIGHTED:this._flags=this._flags&~k.HIGHLIGHTED;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setHighlighted(this._flags);this._isObject&&this.model.scene._objectHighlightedUpdated(this),this.model.glRedraw()}}get xrayed(){return this._getFlag(k.XRAYED)}set xrayed(e){if(!!(this._flags&k.XRAYED)!==e){e?this._flags=this._flags|k.XRAYED:this._flags=this._flags&~k.XRAYED;for(let t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setXRayed(this._flags);this._isObject&&this.model.scene._objectXRayedUpdated(this),this.model.glRedraw()}}get selected(){return this._getFlag(k.SELECTED)}set selected(e){if(!!(this._flags&k.SELECTED)!==e){e?this._flags=this._flags|k.SELECTED:this._flags=this._flags&~k.SELECTED;for(let t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setSelected(this._flags);this._isObject&&this.model.scene._objectSelectedUpdated(this),this.model.glRedraw()}}get edges(){return this._getFlag(k.EDGES)}set edges(e){if(!!(this._flags&k.EDGES)!==e){e?this._flags=this._flags|k.EDGES:this._flags=this._flags&~k.EDGES;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setEdges(this._flags);this.model.glRedraw()}}get culledVFC(){return!!this._culledVFC}set culledVFC(e){this._culledVFC=e,this._setCulled()}get culledLOD(){return!!this._culledLOD}set culledLOD(e){this._culledLOD=e,this._setCulled()}get culled(){return!!this._culled}set culled(e){this._culled=e,this._setCulled()}_setCulled(){let e=!!this._culled||!!(this._culledLOD&&this._lodCullable)||!!this._culledVFC;if(!!(this._flags&k.CULLED)!==e){e?this._flags=this._flags|k.CULLED:this._flags=this._flags&~k.CULLED;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setCulled(this._flags);this.model.glRedraw()}}get clippable(){return this._getFlag(k.CLIPPABLE)}set clippable(e){if(!!(this._flags&k.CLIPPABLE)!==e){e?this._flags=this._flags|k.CLIPPABLE:this._flags=this._flags&~k.CLIPPABLE;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setClippable(this._flags);this.model.glRedraw()}}get collidable(){return this._getFlag(k.COLLIDABLE)}set collidable(e){if(!!(this._flags&k.COLLIDABLE)!==e){e?this._flags=this._flags|k.COLLIDABLE:this._flags=this._flags&~k.COLLIDABLE;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setCollidable(this._flags)}}get pickable(){return this._getFlag(k.PICKABLE)}set pickable(e){if(!!(this._flags&k.PICKABLE)!==e){e?this._flags=this._flags|k.PICKABLE:this._flags=this._flags&~k.PICKABLE;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setPickable(this._flags)}}get colorize(){if(this.meshes.length===0)return null;const e=this.meshes[0]._colorize;return an[0]=e[0]/255,an[1]=e[1]/255,an[2]=e[2]/255,an}set colorize(e){if(e){An[0]=Math.floor(e[0]*255),An[1]=Math.floor(e[1]*255),An[2]=Math.floor(e[2]*255);for(let t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setColorize(An)}else for(let t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setColorize(null);if(this._isObject){const t=!!e;this.scene._objectColorizeUpdated(this,t),this._colorizeUpdated=t}this.model.glRedraw()}get opacity(){return this.meshes.length>0?this.meshes[0]._colorize[3]/255:1}set opacity(e){if(this.meshes.length===0)return;const t=e!=null,i=this.meshes[0]._colorize[3];let s=255;if(t){if(e<0?e=0:e>1&&(e=1),s=Math.floor(e*255),i===s)return}else if(s=255,i===s)return;for(let o=0,n=this.meshes.length;o<n;o++)this.meshes[o]._setOpacity(s,this._flags);this._isObject&&(this.scene._objectOpacityUpdated(this,t),this._opacityUpdated=t),this.model.glRedraw()}get offset(){return this._offset}set offset(e){e?(this._offset[0]=e[0],this._offset[1]=e[1],this._offset[2]=e[2]):(this._offset[0]=0,this._offset[1]=0,this._offset[2]=0);for(let t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setOffset(this._offset);this._aabbDirty=!0,this.model._aabbDirty=!0,this.scene._aabbDirty=!0,this.scene._objectOffsetUpdated(this,e),this.model.glRedraw()}get saoEnabled(){return this.model.saoEnabled}getEachVertex(e){for(let t=0,i=this.meshes.length;t<i;t++)this.meshes[t].getEachVertex(e)}_getFlag(e){return!!(this._flags&e)}_finalize(){const e=this.model.scene;this._isObject&&(this.visible&&e._objectVisibilityUpdated(this),this.highlighted&&e._objectHighlightedUpdated(this),this.xrayed&&e._objectXRayedUpdated(this),this.selected&&e._objectSelectedUpdated(this));for(let t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._finalize(this._flags)}_finalize2(){for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._finalize2()}_destroy(){const e=this.model.scene;this._isObject&&(e._deregisterObject(this),this.visible&&e._deRegisterVisibleObject(this),this.xrayed&&e._deRegisterXRayedObject(this),this.selected&&e._deRegisterSelectedObject(this),this.highlighted&&e._deRegisterHighlightedObject(this),this._colorizeUpdated&&this.scene._deRegisterColorizedObject(this),this._opacityUpdated&&this.scene._deRegisterOpacityObject(this),this._offset&&(this._offset[0]!==0||this._offset[1]!==0||this._offset[2]!==0)&&this.scene._deRegisterOffsetObject(this));for(let t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._destroy();e._aabbDirty=!0}}c.vec4();c.vec4();c.vec3();c.vec3();c.vec3();c.vec3();c.vec3();const w0=".sk-fading-circle {        background: transparent;        margin: 20px auto;        width: 50px;        height:50px;        position: relative;        }        .sk-fading-circle .sk-circle {        width: 120%;        height: 120%;        position: absolute;        left: 0;        top: 0;        }        .sk-fading-circle .sk-circle:before {        content: '';        display: block;        margin: 0 auto;        width: 15%;        height: 15%;        background-color: #ff8800;        border-radius: 100%;        -webkit-animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        }        .sk-fading-circle .sk-circle2 {        -webkit-transform: rotate(30deg);        -ms-transform: rotate(30deg);        transform: rotate(30deg);    }    .sk-fading-circle .sk-circle3 {        -webkit-transform: rotate(60deg);        -ms-transform: rotate(60deg);        transform: rotate(60deg);    }    .sk-fading-circle .sk-circle4 {        -webkit-transform: rotate(90deg);        -ms-transform: rotate(90deg);        transform: rotate(90deg);    }    .sk-fading-circle .sk-circle5 {        -webkit-transform: rotate(120deg);        -ms-transform: rotate(120deg);        transform: rotate(120deg);    }    .sk-fading-circle .sk-circle6 {        -webkit-transform: rotate(150deg);        -ms-transform: rotate(150deg);        transform: rotate(150deg);    }    .sk-fading-circle .sk-circle7 {        -webkit-transform: rotate(180deg);        -ms-transform: rotate(180deg);        transform: rotate(180deg);    }    .sk-fading-circle .sk-circle8 {        -webkit-transform: rotate(210deg);        -ms-transform: rotate(210deg);        transform: rotate(210deg);    }    .sk-fading-circle .sk-circle9 {        -webkit-transform: rotate(240deg);        -ms-transform: rotate(240deg);        transform: rotate(240deg);    }    .sk-fading-circle .sk-circle10 {        -webkit-transform: rotate(270deg);        -ms-transform: rotate(270deg);        transform: rotate(270deg);    }    .sk-fading-circle .sk-circle11 {        -webkit-transform: rotate(300deg);        -ms-transform: rotate(300deg);        transform: rotate(300deg);    }    .sk-fading-circle .sk-circle12 {        -webkit-transform: rotate(330deg);        -ms-transform: rotate(330deg);        transform: rotate(330deg);    }    .sk-fading-circle .sk-circle2:before {        -webkit-animation-delay: -1.1s;        animation-delay: -1.1s;    }    .sk-fading-circle .sk-circle3:before {        -webkit-animation-delay: -1s;        animation-delay: -1s;    }    .sk-fading-circle .sk-circle4:before {        -webkit-animation-delay: -0.9s;        animation-delay: -0.9s;    }    .sk-fading-circle .sk-circle5:before {        -webkit-animation-delay: -0.8s;        animation-delay: -0.8s;    }    .sk-fading-circle .sk-circle6:before {        -webkit-animation-delay: -0.7s;        animation-delay: -0.7s;    }    .sk-fading-circle .sk-circle7:before {        -webkit-animation-delay: -0.6s;        animation-delay: -0.6s;    }    .sk-fading-circle .sk-circle8:before {        -webkit-animation-delay: -0.5s;        animation-delay: -0.5s;    }    .sk-fading-circle .sk-circle9:before {        -webkit-animation-delay: -0.4s;        animation-delay: -0.4s;    }    .sk-fading-circle .sk-circle10:before {        -webkit-animation-delay: -0.3s;        animation-delay: -0.3s;    }    .sk-fading-circle .sk-circle11:before {        -webkit-animation-delay: -0.2s;        animation-delay: -0.2s;    }    .sk-fading-circle .sk-circle12:before {        -webkit-animation-delay: -0.1s;        animation-delay: -0.1s;    }    @-webkit-keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }    @keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }";class b0 extends It{get type(){return"Spinner"}constructor(e,t={}){super(e,t),this._canvas=t.canvas,this._element=null,this._isCustom=!1,t.elementId&&(this._element=document.getElementById(t.elementId),this._element?this._adjustPosition():this.error("Can't find given Spinner HTML element: '"+t.elementId+"' - will automatically create default element")),this._element||this._createDefaultSpinner(),this.processes=0}_createDefaultSpinner(){this._injectDefaultCSS();const e=document.createElement("div"),t=e.style;t["z-index"]="9000",t.position="absolute",e.innerHTML='<div class="sk-fading-circle">                <div class="sk-circle1 sk-circle"></div>                <div class="sk-circle2 sk-circle"></div>                <div class="sk-circle3 sk-circle"></div>                <div class="sk-circle4 sk-circle"></div>                <div class="sk-circle5 sk-circle"></div>                <div class="sk-circle6 sk-circle"></div>                <div class="sk-circle7 sk-circle"></div>                <div class="sk-circle8 sk-circle"></div>                <div class="sk-circle9 sk-circle"></div>                <div class="sk-circle10 sk-circle"></div>                <div class="sk-circle11 sk-circle"></div>                <div class="sk-circle12 sk-circle"></div>                </div>',this._canvas.parentElement.appendChild(e),this._element=e,this._isCustom=!1,this._adjustPosition()}_injectDefaultCSS(){const e="xeokit-spinner-css";if(document.getElementById(e))return;const t=document.createElement("style");t.innerHTML=w0,t.id=e,document.body.appendChild(t)}_adjustPosition(){if(this._isCustom)return;const e=this._canvas,t=this._element,i=t.style;i.left=e.offsetLeft+e.clientWidth*.5-t.clientWidth*.5+"px",i.top=e.offsetTop+e.clientHeight*.5-t.clientHeight*.5+"px"}set processes(e){if(e=e||0,this._processes===e||e<0)return;const t=this._processes;this._processes=e;const i=this._element;i&&(i.style.visibility=this._processes>0?"visible":"hidden"),this.fire("processes",this._processes),this._processes===0&&this._processes!==t&&this.fire("zeroProcesses",this._processes)}get processes(){return this._processes}_destroy(){this._element&&!this._isCustom&&(this._element.parentNode.removeChild(this._element),this._element=null);const e=document.getElementById("xeokit-spinner-css");e&&e.parentNode.removeChild(e)}}const vh=["webgl2","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"];class C0 extends It{constructor(e,t={}){super(e,t),this._backgroundColor=c.vec3([t.backgroundColor?t.backgroundColor[0]:1,t.backgroundColor?t.backgroundColor[1]:1,t.backgroundColor?t.backgroundColor[2]:1]),this._backgroundColorFromAmbientLight=!!t.backgroundColorFromAmbientLight,this.canvas=t.canvas,this.gl=null,this.webgl2=!1,this.transparent=!!t.transparent,this.contextAttr=t.contextAttr||{},this.contextAttr.alpha=this.transparent,this.contextAttr.preserveDrawingBuffer=!!this.contextAttr.preserveDrawingBuffer,this.contextAttr.stencil=!1,this.contextAttr.premultipliedAlpha=!!this.contextAttr.premultipliedAlpha,this.contextAttr.antialias=this.contextAttr.antialias!==!1,this.resolutionScale=t.resolutionScale,this.canvas.width=Math.round(this.canvas.clientWidth*this._resolutionScale),this.canvas.height=Math.round(this.canvas.clientHeight*this._resolutionScale),this.boundary=[this.canvas.offsetLeft,this.canvas.offsetTop,this.canvas.clientWidth,this.canvas.clientHeight],this._initWebGL(t);const i=this;this.canvas.addEventListener("webglcontextlost",this._webglcontextlostListener=function(n){console.time("webglcontextrestored"),i.scene._webglContextLost(),i.fire("webglcontextlost"),n.preventDefault()},!1),this.canvas.addEventListener("webglcontextrestored",this._webglcontextrestoredListener=function(n){i._initWebGL(),i.gl&&(i.scene._webglContextRestored(i.gl),i.fire("webglcontextrestored",i.gl),n.preventDefault()),console.timeEnd("webglcontextrestored")},!1);let s=!0;new ResizeObserver(n=>{for(const a of n)a.contentBoxSize&&(s=!0)}).observe(this.canvas),this._tick=this.scene.on("tick",()=>{s&&(s=!1,i.canvas.width=Math.round(i.canvas.clientWidth*i._resolutionScale),i.canvas.height=Math.round(i.canvas.clientHeight*i._resolutionScale),i.boundary[0]=i.canvas.offsetLeft,i.boundary[1]=i.canvas.offsetTop,i.boundary[2]=i.canvas.clientWidth,i.boundary[3]=i.canvas.clientHeight,i.fire("boundary",i.boundary))}),this._spinner=new b0(this.scene,{canvas:this.canvas,elementId:t.spinnerElementId})}get type(){return"Canvas"}get backgroundColorFromAmbientLight(){return this._backgroundColorFromAmbientLight}set backgroundColorFromAmbientLight(e){this._backgroundColorFromAmbientLight=e!==!1,this.glRedraw()}get backgroundColor(){return this._backgroundColor}set backgroundColor(e){e?(this._backgroundColor[0]=e[0],this._backgroundColor[1]=e[1],this._backgroundColor[2]=e[2]):(this._backgroundColor[0]=1,this._backgroundColor[1]=1,this._backgroundColor[2]=1),this.glRedraw()}get resolutionScale(){return this._resolutionScale}set resolutionScale(e){if(e=e||1,e===this._resolutionScale)return;this._resolutionScale=e;const t=this.canvas;t.width=Math.round(t.clientWidth*this._resolutionScale),t.height=Math.round(t.clientHeight*this._resolutionScale),this.glRedraw()}get spinner(){return this._spinner}_createCanvas(){const e="xeokit-canvas-"+c.createUUID(),t=document.getElementsByTagName("body")[0],i=document.createElement("div"),s=i.style;s.height="100%",s.width="100%",s.padding="0",s.margin="0",s.background="rgba(0,0,0,0);",s.float="left",s.left="0",s.top="0",s.position="absolute",s.opacity="1.0",s["z-index"]="-10000",i.innerHTML+='<canvas id="'+e+'" style="width: 100%; height: 100%; float: left; margin: 0; padding: 0;"></canvas>',t.appendChild(i),this.canvas=document.getElementById(e)}_getElementXY(e){let t=0,i=0;for(;e;)t+=e.offsetLeft-e.scrollLeft,i+=e.offsetTop-e.scrollTop,e=e.offsetParent;return{x:t,y:i}}_initWebGL(){if(!this.gl)for(let e=0;!this.gl&&e<vh.length;e++)try{this.gl=this.canvas.getContext(vh[e],this.contextAttr)}catch{}this.gl||(this.error("Failed to get a WebGL context"),this.fire("webglContextFailed",!0,!0));{const e=this.gl;let t="__",i=e.activeTexture;e.activeTexture=function(n){t!==n&&(t=n,i.call(this,n))};let s={},o=e.bindTexture;e.bindTexture=function(n,a){s[t]!==a&&(s[t]=a,o.call(this,n,a))}}this.gl&&this.webgl2&&(this.gl.hint(this.gl.FRAGMENT_SHADER_DERIVATIVE_HINT,this.gl.FASTEST),this.gl instanceof WebGL2RenderingContext)}getSnapshot(e){throw"Canvas#getSnapshot() has been replaced by Viewer#getSnapshot() - use that method instead."}readPixels(e,t,i,s){return this.scene._renderer.readPixels(e,t,i,s)}loseWebGLContext(){this.canvas.loseContext&&this.canvas.loseContext()}destroy(){this.scene.off(this._tick),this._spinner._destroy(),this.canvas.removeEventListener("webglcontextlost",this._webglcontextlostListener),this.canvas.removeEventListener("webglcontextrestored",this._webglcontextrestoredListener),this.gl=null,super.destroy()}}class E0{constructor(e){this._scene=e,this._matPool=[],this._matPoolNextFreeIndex=0,this._rtcViewMats={},this._rtcPickViewMats={},this.reset()}reset(){this._matPoolNextFreeIndex=0,this._rtcViewMats={},this._rtcPickViewMats={},this.gl=this._scene.canvas.gl,this.lastProgramId=null,this.pbrEnabled=!1,this.colorTextureEnabled=!1,this.withSAO=!1,this.backfaces=!1,this.frontface=!0,this.textureUnit=0,this.drawElements=0,this.drawArrays=0,this.useProgram=0,this.bindTexture=0,this.bindArray=0,this.pass=0,this.shadowViewMatrix=null,this.shadowProjMatrix=null,this.pickViewMatrix=null,this.pickProjMatrix=null,this.pickZNear=.01,this.pickZFar=5e3,this.pickInvisible=!1,this.pickElementsCount=null,this.pickElementsOffset=null,this.lineWidth=1,this.snapPickLayerParams={},this.snapPickLayerNumber=0,this.snapPickCoordinateScale=c.vec3(),this.snapPickOrigin=c.vec3()}getRTCViewMatrix(e,t){let i=this._rtcViewMats[e];return i||(i=this._getNewMat(),ft(this._scene.camera.viewMatrix,t,i),this._rtcViewMats[e]=i),i}getRTCPickViewMatrix(e,t){let i=this._rtcPickViewMats[e];if(!i){i=this._getNewMat();const s=this.pickViewMatrix||this._scene.camera.viewMatrix;ft(s,t,i),this._rtcPickViewMats[e]=i}return i}_getNewMat(){let e=this._matPool[this._matPoolNextFreeIndex];return e||(e=c.mat4(),this._matPool[this._matPoolNextFreeIndex]=e),this._matPoolNextFreeIndex++,e}}const _t={WEBGL:!1,SUPPORTED_EXTENSIONS:{}},qa=document.createElement("canvas");if(qa){const r=qa.getContext("webgl",{antialias:!0})||qa.getContext("experimental-webgl",{antialias:!0});_t.WEBGL=!!r,_t.WEBGL&&(_t.ANTIALIAS=r.getContextAttributes().antialias,r.getShaderPrecisionFormat?r.getShaderPrecisionFormat(r.FRAGMENT_SHADER,r.HIGH_FLOAT).precision>0?_t.FS_MAX_FLOAT_PRECISION="highp":r.getShaderPrecisionFormat(r.FRAGMENT_SHADER,r.MEDIUM_FLOAT).precision>0?_t.FS_MAX_FLOAT_PRECISION="mediump":_t.FS_MAX_FLOAT_PRECISION="lowp":_t.FS_MAX_FLOAT_PRECISION="mediump",_t.DEPTH_BUFFER_BITS=r.getParameter(r.DEPTH_BITS),_t.MAX_TEXTURE_SIZE=r.getParameter(r.MAX_TEXTURE_SIZE),_t.MAX_CUBE_MAP_SIZE=r.getParameter(r.MAX_CUBE_MAP_TEXTURE_SIZE),_t.MAX_RENDERBUFFER_SIZE=r.getParameter(r.MAX_RENDERBUFFER_SIZE),_t.MAX_TEXTURE_UNITS=r.getParameter(r.MAX_COMBINED_TEXTURE_IMAGE_UNITS),_t.MAX_TEXTURE_IMAGE_UNITS=r.getParameter(r.MAX_TEXTURE_IMAGE_UNITS),_t.MAX_VERTEX_ATTRIBS=r.getParameter(r.MAX_VERTEX_ATTRIBS),_t.MAX_VERTEX_UNIFORM_VECTORS=r.getParameter(r.MAX_VERTEX_UNIFORM_VECTORS),_t.MAX_FRAGMENT_UNIFORM_VECTORS=r.getParameter(r.MAX_FRAGMENT_UNIFORM_VECTORS),_t.MAX_VARYING_VECTORS=r.getParameter(r.MAX_VARYING_VECTORS),r.getSupportedExtensions().forEach(function(e){_t.SUPPORTED_EXTENSIONS[e]=!0}))}class El{constructor(){this.entity=null,this.primitive=null,this.primIndex=-1,this.pickSurfacePrecision=!1,this.touchInput=!1,this.snappedToEdge=!1,this.snappedToVertex=!1,this._origin=new Float64Array([0,0,0]),this._direction=new Float64Array([0,0,0]),this._indices=new Int32Array(3),this._localPos=new Float64Array([0,0,0]),this._worldPos=new Float64Array([0,0,0]),this._viewPos=new Float64Array([0,0,0]),this._canvasPos=new Int16Array([0,0]),this._snappedCanvasPos=new Int16Array([0,0]),this._bary=new Float64Array([0,0,0]),this._worldNormal=new Float64Array([0,0,0]),this._uv=new Float64Array([0,0]),this.reset()}get canvasPos(){return this._gotCanvasPos?this._canvasPos:null}set canvasPos(e){e?(this._canvasPos[0]=e[0],this._canvasPos[1]=e[1],this._gotCanvasPos=!0):this._gotCanvasPos=!1}get origin(){return this._gotOrigin?this._origin:null}set origin(e){e?(this._origin[0]=e[0],this._origin[1]=e[1],this._origin[2]=e[2],this._gotOrigin=!0):this._gotOrigin=!1}get direction(){return this._gotDirection?this._direction:null}set direction(e){e?(this._direction[0]=e[0],this._direction[1]=e[1],this._direction[2]=e[2],this._gotDirection=!0):this._gotDirection=!1}get indices(){return this.entity&&this._gotIndices?this._indices:null}set indices(e){e?(this._indices[0]=e[0],this._indices[1]=e[1],this._indices[2]=e[2],this._gotIndices=!0):this._gotIndices=!1}get localPos(){return this.entity&&this._gotLocalPos?this._localPos:null}set localPos(e){e?(this._localPos[0]=e[0],this._localPos[1]=e[1],this._localPos[2]=e[2],this._gotLocalPos=!0):this._gotLocalPos=!1}get snappedCanvasPos(){return this._gotSnappedCanvasPos?this._snappedCanvasPos:null}set snappedCanvasPos(e){e?(this._snappedCanvasPos[0]=e[0],this._snappedCanvasPos[1]=e[1],this._gotSnappedCanvasPos=!0):this._gotSnappedCanvasPos=!1}get worldPos(){return this._gotWorldPos?this._worldPos:null}set worldPos(e){e?(this._worldPos[0]=e[0],this._worldPos[1]=e[1],this._worldPos[2]=e[2],this._gotWorldPos=!0):this._gotWorldPos=!1}get viewPos(){return this.entity&&this._gotViewPos?this._viewPos:null}set viewPos(e){e?(this._viewPos[0]=e[0],this._viewPos[1]=e[1],this._viewPos[2]=e[2],this._gotViewPos=!0):this._gotViewPos=!1}get bary(){return this.entity&&this._gotBary?this._bary:null}set bary(e){e?(this._bary[0]=e[0],this._bary[1]=e[1],this._bary[2]=e[2],this._gotBary=!0):this._gotBary=!1}get worldNormal(){return this.entity&&this._gotWorldNormal?this._worldNormal:null}set worldNormal(e){e?(this._worldNormal[0]=e[0],this._worldNormal[1]=e[1],this._worldNormal[2]=e[2],this._gotWorldNormal=!0):this._gotWorldNormal=!1}get uv(){return this.entity&&this._gotUV?this._uv:null}set uv(e){e?(this._uv[0]=e[0],this._uv[1]=e[1],this._gotUV=!0):this._gotUV=!1}get snapped(){return this.snappedToEdge||this.snappedToVertex}reset(){this.entity=null,this.primIndex=-1,this.primitive=null,this.pickSurfacePrecision=!1,this._gotCanvasPos=!1,this._gotSnappedCanvasPos=!1,this._gotOrigin=!1,this._gotDirection=!1,this._gotIndices=!1,this._gotLocalPos=!1,this._gotWorldPos=!1,this._gotViewPos=!1,this._gotBary=!1,this._gotWorldNormal=!1,this._gotUV=!1,this.touchInput=!1,this.snappedToEdge=!1,this.snappedToVertex=!1}}class Bh{constructor(e,t,i){if(this.allocated=!1,this.compiled=!1,this.handle=e.createShader(t),!this.handle){this.errors=["Failed to allocate"];return}if(this.allocated=!0,e.shaderSource(this.handle,i),e.compileShader(this.handle),this.compiled=e.getShaderParameter(this.handle,e.COMPILE_STATUS),!this.compiled&&!e.isContextLost()){const s=i.split(`
`),o=[];for(let n=0;n<s.length;n++)o.push(n+1+": "+s[n]+`
`);this.errors=[],this.errors.push(""),this.errors.push(e.getShaderInfoLog(this.handle)),this.errors=this.errors.concat(o.join(""))}}destroy(){}}class Ph{constructor(e,t){this.bindTexture=function(i,s){return i.bind(s)?(e.uniform1i(t,s),!0):!1}}}class I0{constructor(e,t){this._gl=e,this.location=t}bindArrayBuffer(e){e&&(e.bind(),this._gl.enableVertexAttribArray(this.location),this._gl.vertexAttribPointer(this.location,e.itemSize,e.itemType,e.normalized,e.stride,e.offset))}}const yh=new Si({});function xh(r){const e=[];let t,i;for(let s=0,o=r.length;s<o;s++)t=r[s],i=t.indexOf("/"),i>0&&t.charAt(i+1)==="/"&&(t=t.substring(0,i)),e.push(t);return e.join(`
`)}function Kr(r){console.error(r.join(`
`))}class Ft{constructor(e,t){this.id=yh.addItem({}),this.source=t,this.init(e)}init(e){if(this.gl=e,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errors=null,this.uniforms={},this.samplers={},this.attributes={},this._vertexShader=new Bh(e,e.VERTEX_SHADER,xh(this.source.vertex)),this._fragmentShader=new Bh(e,e.FRAGMENT_SHADER,xh(this.source.fragment)),!this._vertexShader.allocated){this.errors=["Vertex shader failed to allocate"].concat(this._vertexShader.errors),Kr(this.errors);return}if(!this._fragmentShader.allocated){this.errors=["Fragment shader failed to allocate"].concat(this._fragmentShader.errors),Kr(this.errors);return}if(this.allocated=!0,!this._vertexShader.compiled){this.errors=["Vertex shader failed to compile"].concat(this._vertexShader.errors),Kr(this.errors);return}if(!this._fragmentShader.compiled){this.errors=["Fragment shader failed to compile"].concat(this._fragmentShader.errors),Kr(this.errors);return}this.compiled=!0;let t,i,s,o,n;if(this.handle=e.createProgram(),!this.handle){this.errors=["Failed to allocate program"];return}if(e.attachShader(this.handle,this._vertexShader.handle),e.attachShader(this.handle,this._fragmentShader.handle),e.linkProgram(this.handle),this.linked=e.getProgramParameter(this.handle,e.LINK_STATUS),this.validated=!0,!this.linked||!this.validated){this.errors=[],this.errors.push(""),this.errors.push(e.getProgramInfoLog(this.handle)),this.errors.push(`
Vertex shader:
`),this.errors=this.errors.concat(this.source.vertex),this.errors.push(`
Fragment shader:
`),this.errors=this.errors.concat(this.source.fragment),Kr(this.errors);return}const a=e.getProgramParameter(this.handle,e.ACTIVE_UNIFORMS);for(i=0;i<a;++i)s=e.getActiveUniform(this.handle,i),s&&(o=s.name,o[o.length-1]==="\0"&&(o=o.substr(0,o.length-1)),n=e.getUniformLocation(this.handle,o),s.type===e.SAMPLER_2D||s.type===e.SAMPLER_CUBE||s.type===35682?this.samplers[o]=new Ph(e,n):e instanceof WebGL2RenderingContext&&(s.type===e.UNSIGNED_INT_SAMPLER_2D||s.type===e.INT_SAMPLER_2D)?this.samplers[o]=new Ph(e,n):this.uniforms[o]=n);const A=e.getProgramParameter(this.handle,e.ACTIVE_ATTRIBUTES);for(i=0;i<A;i++)t=e.getActiveAttrib(this.handle,i),t&&(n=e.getAttribLocation(this.handle,t.name),this.attributes[t.name]=new I0(e,n));this.allocated=!0}bind(){this.allocated&&this.gl.useProgram(this.handle)}getLocation(e){if(this.allocated)return this.uniforms[e]}getAttribute(e){if(this.allocated)return this.attributes[e]}bindTexture(e,t,i){if(!this.allocated)return!1;const s=this.samplers[e];return s?s.bindTexture(t,i):!1}destroy(){this.allocated&&(yh.removeItem(this.id),this.gl.deleteProgram(this.handle),this.gl.deleteShader(this._vertexShader.handle),this.gl.deleteShader(this._fragmentShader.handle),this.handle=null,this.attributes=null,this.uniforms=null,this.samplers=null,this.allocated=!1)}}class Ee{constructor(e,t,i,s,o,n,a,A,l){switch(this._gl=e,this.type=t,this.allocated=!1,i.constructor){case Uint8Array:this.itemType=e.UNSIGNED_BYTE,this.itemByteSize=1;break;case Int8Array:this.itemType=e.BYTE,this.itemByteSize=1;break;case Uint16Array:this.itemType=e.UNSIGNED_SHORT,this.itemByteSize=2;break;case Int16Array:this.itemType=e.SHORT,this.itemByteSize=2;break;case Uint32Array:this.itemType=e.UNSIGNED_INT,this.itemByteSize=4;break;case Int32Array:this.itemType=e.INT,this.itemByteSize=4;break;default:this.itemType=e.FLOAT,this.itemByteSize=4}this.usage=n,this.length=0,this.dataLength=s,this.numItems=0,this.itemSize=o,this.normalized=!!a,this.stride=A||0,this.offset=l||0,this._allocate(i)}_allocate(e){if(this.allocated=!1,this._handle=this._gl.createBuffer(),!this._handle)throw"Failed to allocate WebGL ArrayBuffer";this._handle&&(this._gl.bindBuffer(this.type,this._handle),this._gl.bufferData(this.type,e.length>this.dataLength?e.slice(0,this.dataLength):e,this.usage),this._gl.bindBuffer(this.type,null),this.length=e.length,this.numItems=this.length/this.itemSize,this.allocated=!0)}setData(e,t){this.allocated&&(e.length+(t||0)>this.length?(this.destroy(),this._allocate(e)):(this._gl.bindBuffer(this.type,this._handle),t||t===0?this._gl.bufferSubData(this.type,t*this.itemByteSize,e):this._gl.bufferData(this.type,e,this.usage),this._gl.bindBuffer(this.type,null)))}bind(){this.allocated&&this._gl.bindBuffer(this.type,this._handle)}unbind(){this.allocated&&this._gl.bindBuffer(this.type,null)}destroy(){this.allocated&&(this._gl.deleteBuffer(this._handle),this._handle=null,this.allocated=!1)}}class wh{constructor(e,t){this.scene=e,this.aabb=c.AABB3(),this.origin=c.vec3(t),this.originHash=this.origin.join(),this.numMarkers=0,this.markers={},this.markerList=[],this.markerIndices={},this.positions=[],this.indices=[],this.positionsBuf=null,this.lenPositionsBuf=0,this.indicesBuf=null,this.sectionPlanesActive=[],this.culledBySectionPlanes=!1,this.occlusionTestList=[],this.lenOcclusionTestList=0,this.pixels=[],this.aabbDirty=!1,this.markerListDirty=!1,this.positionsDirty=!0,this.occlusionTestListDirty=!1}addMarker(e){this.markers[e.id]=e,this.markerListDirty=!0,this.numMarkers++}markerWorldPosUpdated(e){if(!this.markers[e.id])return;const t=this.markerIndices[e.id];this.positions[t*3+0]=e.worldPos[0],this.positions[t*3+1]=e.worldPos[1],this.positions[t*3+2]=e.worldPos[2],this.positionsDirty=!0}removeMarker(e){delete this.markers[e.id],this.markerListDirty=!0,this.numMarkers--}update(){this.markerListDirty&&(this._buildMarkerList(),this.markerListDirty=!1,this.positionsDirty=!0,this.occlusionTestListDirty=!0),this.positionsDirty&&(this._buildPositions(),this.positionsDirty=!1,this.aabbDirty=!0,this.vbosDirty=!0),this.aabbDirty&&(this._buildAABB(),this.aabbDirty=!1),this.vbosDirty&&(this._buildVBOs(),this.vbosDirty=!1),this.occlusionTestListDirty&&this._buildOcclusionTestList(),this._updateActiveSectionPlanes()}_buildMarkerList(){this.numMarkers=0;for(var e in this.markers)this.markers.hasOwnProperty(e)&&(this.markerList[this.numMarkers]=this.markers[e],this.markerIndices[e]=this.numMarkers,this.numMarkers++);this.markerList.length=this.numMarkers}_buildPositions(){let e=0;for(let t=0;t<this.numMarkers;t++)if(this.markerList[t]){const s=this.markerList[t].worldPos;this.positions[e++]=s[0],this.positions[e++]=s[1],this.positions[e++]=s[2],this.indices[t]=t}this.positions.length=this.numMarkers*3,this.indices.length=this.numMarkers}_buildAABB(){const e=this.aabb;c.collapseAABB3(e),c.expandAABB3Points3(e,this.positions);const t=this.origin;e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e[3]+=t[0],e[4]+=t[1],e[5]+=t[2]}_buildVBOs(){if(this.positionsBuf){if(this.lenPositionsBuf===this.positions.length){this.positionsBuf.setData(this.positions);return}this.positionsBuf.destroy(),this.positionsBuf=null,this.indicesBuf.destroy(),this.indicesBuf=null}const e=this.scene.canvas.gl,t=this.numMarkers*3,i=this.numMarkers;this.positionsBuf=new Ee(e,e.ARRAY_BUFFER,new Float32Array(this.positions),t,3,e.STATIC_DRAW),this.indicesBuf=new Ee(e,e.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),i,1,e.STATIC_DRAW),this.lenPositionsBuf=this.positions.length}_buildOcclusionTestList(){const e=this.scene.canvas,t=this.scene.camera.perspective.near,i=e.boundary,s=i[2],o=i[3];let n=0;this.lenOcclusionTestList=0;for(let a=0;a<this.numMarkers;a++){const A=this.markerList[a];if(A.viewPos[2]>-t){A._setVisible(!1);continue}const h=A.canvasPos,d=h[0],f=h[1];if(d+10<0||f+10<0||d-10>s||f-10>o){A._setVisible(!1);continue}if(A.entity&&!A.entity.visible){A._setVisible(!1);continue}if(A.occludable){this.occlusionTestList[this.lenOcclusionTestList++]=A,this.pixels[n++]=d,this.pixels[n++]=f;continue}A._setVisible(!0)}}_updateActiveSectionPlanes(){const e=this.scene._sectionPlanesState.sectionPlanes,t=e.length;if(t>0)for(let i=0;i<t;i++){const s=e[i];if(!s.active)this.sectionPlanesActive[i]=!1;else{const o=c.planeAABB3Intersect(s.dir,s.dist,this.aabb);if(o===-1){this.culledBySectionPlanes=!0;return}const a=o===0;this.sectionPlanesActive[i]=a}}this.culledBySectionPlanes=!1}destroy(){this.markers={},this.markerList.length=0,this.positionsBuf&&this.positionsBuf.destroy(),this.indicesBuf&&this.indicesBuf.destroy()}}const $a=c.vec3([1,0,0]),F0=20,M0=-.001,S0=c.vec3();class T0{constructor(e,t){this._scene=e,this._renderBufferManager=t,this._occlusionLayers={},this._occlusionLayersList=[],this._occlusionLayersListDirty=!1,this._shaderSource=null,this._program=null,this._shaderSourceHash=null,this._shaderSourceDirty=!0,this._programDirty=!1,this._markersToOcclusionLayersMap={},this._onCameraViewMatrix=e.camera.on("viewMatrix",()=>{this._occlusionTestListDirty=!0}),this._onCameraProjMatrix=e.camera.on("projMatrix",()=>{this._occlusionTestListDirty=!0}),this._onCanvasBoundary=e.canvas.on("boundary",()=>{this._occlusionTestListDirty=!0})}addMarker(e){const t=e.origin.join();let i=this._occlusionLayers[t];i||(i=new wh(this._scene,e.origin),this._occlusionLayers[i.originHash]=i,this._occlusionLayersListDirty=!0),i.addMarker(e),this._markersToOcclusionLayersMap[e.id]=i,this._occlusionTestListDirty=!0}markerWorldPosUpdated(e){const t=this._markersToOcclusionLayersMap[e.id];if(!t)return;const i=e.origin.join();if(i!==t.originHash){t.numMarkers===1?(t.destroy(),delete this._occlusionLayers[t.originHash],this._occlusionLayersListDirty=!0):t.removeMarker(e);let s=this._occlusionLayers[i];s||(s=new wh(this._scene,e.origin),this._occlusionLayers[i]=t,this._occlusionLayersListDirty=!0),s.addMarker(e),this._markersToOcclusionLayersMap[e.id]=s}else t.markerWorldPosUpdated(e)}removeMarker(e){const t=e.origin.join();let i=this._occlusionLayers[t];i&&(i.numMarkers===1?(i.destroy(),delete this._occlusionLayers[i.originHash],this._occlusionLayersListDirty=!0):i.removeMarker(e),delete this._markersToOcclusionLayersMap[e.id])}get needOcclusionTest(){return this._occlusionTestListDirty}bindRenderBuf(){const e=[this._scene.canvas.canvas.id,this._scene._sectionPlanesState.getHash()].join(";");if(e!==this._shaderSourceHash&&(this._shaderSourceHash=e,this._shaderSourceDirty=!0),this._shaderSourceDirty&&(this._buildShaderSource(),this._shaderSourceDirty=!1,this._programDirty=!0),this._programDirty&&(this._buildProgram(),this._programDirty=!1,this._occlusionTestListDirty=!0),this._occlusionLayersListDirty&&(this._buildOcclusionLayersList(),this._occlusionLayersListDirty=!1),this._occlusionTestListDirty){for(let t=0,i=this._occlusionLayersList.length;t<i;t++){const s=this._occlusionLayersList[t];s.occlusionTestListDirty=!0}this._occlusionTestListDirty=!1}this._readPixelBuf=this._renderBufferManager.getRenderBuffer("occlusionReadPix"),this._readPixelBuf.bind(),this._readPixelBuf.clear()}_buildOcclusionLayersList(){let e=0;for(let t in this._occlusionLayers)this._occlusionLayers.hasOwnProperty(t)&&(this._occlusionLayersList[e++]=this._occlusionLayers[t]);this._occlusionLayersList.length=e}_buildShaderSource(){this._shaderSource={vertex:this._buildVertexShaderSource(),fragment:this._buildFragmentShaderSource()}}_buildVertexShaderSource(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// OcclusionTester vertex shader"),i.push("in vec3 position;"),i.push("uniform mat4 modelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;")),t&&i.push("out vec4 vWorldPosition;"),i.push("void main(void) {"),i.push("vec4 worldPosition = vec4(position, 1.0); "),i.push("   vec4 viewPosition = viewMatrix * worldPosition;"),t&&i.push("   vWorldPosition = worldPosition;"),i.push("   vec4 clipPos = projMatrix * viewPosition;"),i.push("   gl_PointSize = "+F0+".0;"),e.logarithmicDepthBufferEnabled?i.push("vFragDepth = 1.0 + clipPos.w;"):i.push("clipPos.z += "+M0+";"),i.push("   gl_Position = clipPos;"),i.push("}"),i}_buildFragmentShaderSource(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// OcclusionTester fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;");for(let n=0;n<t.sectionPlanes.length;n++)s.push("uniform bool sectionPlaneActive"+n+";"),s.push("uniform vec3 sectionPlanePos"+n+";"),s.push("uniform vec3 sectionPlaneDir"+n+";")}if(s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  float dist = 0.0;");for(var o=0;o<t.sectionPlanes.length;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outColor = vec4(1.0, 0.0, 0.0, 1.0); "),s.push("}"),s}_buildProgram(){this._program&&this._program.destroy();const e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new Ft(t,this._shaderSource),this._program.errors){this.errors=this._program.errors;return}const s=this._program;this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];const o=i.sectionPlanes;for(let n=0,a=o.length;n<a;n++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+n),pos:s.getLocation("sectionPlanePos"+n),dir:s.getLocation("sectionPlaneDir"+n)});this._aPosition=s.getAttribute("position"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}drawMarkers(){const e=this._scene,t=e.canvas.gl,i=this._program,s=e._sectionPlanesState,o=e.camera,n=e.camera.project;if(i.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,o._project._state.matrix),e.logarithmicDepthBufferEnabled){const a=2/(Math.log(n.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,a)}for(let a=0,A=this._occlusionLayersList.length;a<A;a++){const l=this._occlusionLayersList[a];if(l.update(),l.culledBySectionPlanes)continue;const h=l.origin;t.uniformMatrix4fv(this._uViewMatrix,!1,ft(o.viewMatrix,h));const d=s.sectionPlanes.length;if(d>0){const m=s.sectionPlanes;for(let _=0;_<d;_++){const u=this._uSectionPlanes[_];if(u){const B=l.sectionPlanesActive[_];if(t.uniform1i(u.active,B?1:0),B){const y=m[_];t.uniform3fv(u.pos,Ot(y.dist,y.dir,h,S0)),t.uniform3fv(u.dir,y.dir)}}}}this._aPosition.bindArrayBuffer(l.positionsBuf);const f=l.indicesBuf;f.bind(),t.drawElements(t.POINTS,f.numItems,f.itemType,0)}}doOcclusionTest(){{const e=this._scene.canvas.resolutionScale,t=$a[0]*255,i=$a[1]*255,s=$a[2]*255;for(let o=0,n=this._occlusionLayersList.length;o<n;o++){const a=this._occlusionLayersList[o];for(let A=0;A<a.lenOcclusionTestList;A++){const l=a.occlusionTestList[A],h=A*2,d=this._readPixelBuf.read(Math.round(a.pixels[h]*e),Math.round(a.pixels[h+1]*e)),f=d[0]===t&&d[1]===i&&d[2]===s;l._setVisible(f)}}}}unbindRenderBuf(){this._readPixelBuf.unbind()}destroy(){if(!this.destroyed){for(let e=0,t=this._occlusionLayersList.length;e<t;e++)this._occlusionLayersList[e].destroy();this._program&&this._program.destroy(),this._scene.camera.off(this._onCameraViewMatrix),this._scene.camera.off(this._onCameraProjMatrix),this._scene.canvas.off(this._onCanvasBoundary),this.destroyed=!0}}}const eA=c.vec2();class D0{constructor(e){this._scene=e,this._numSamples=null,this._program=null,this._programError=!1,this._aPosition=null,this._aUV=null,this._uDepthTexture="uDepthTexture",this._uCameraNear=null,this._uCameraFar=null,this._uCameraProjectionMatrix=null,this._uCameraInverseProjectionMatrix=null,this._uScale=null,this._uIntensity=null,this._uBias=null,this._uKernelRadius=null,this._uMinResolution=null,this._uRandomSeed=null,this._uvBuf=null,this._positionsBuf=null,this._indicesBuf=null}render(e){if(this._build(),this._programError)return;this._getInverseProjectMat||(this._getInverseProjectMat=(()=>{let B=!0;this._scene.camera.on("projMatrix",function(){B=!0});const y=c.mat4();return()=>(B&&c.inverseMat4(s.camera.projMatrix,y),y)})());const t=this._scene.canvas.gl,i=this._program,s=this._scene,o=s.sao,n=t.drawingBufferWidth,a=t.drawingBufferHeight,A=s.camera.project._state,l=A.near,h=A.far,d=A.matrix,f=this._getInverseProjectMat(),m=Math.random(),_=s.camera.projection==="perspective";eA[0]=n,eA[1]=a,t.viewport(0,0,n,a),t.clearColor(0,0,0,1),t.disable(t.DEPTH_TEST),t.disable(t.BLEND),t.frontFace(t.CCW),t.clear(t.COLOR_BUFFER_BIT),i.bind(),t.uniform1f(this._uCameraNear,l),t.uniform1f(this._uCameraFar,h),t.uniformMatrix4fv(this._uCameraProjectionMatrix,!1,d),t.uniformMatrix4fv(this._uCameraInverseProjectionMatrix,!1,f),t.uniform1i(this._uPerspective,_),t.uniform1f(this._uScale,o.scale*(h/5)),t.uniform1f(this._uIntensity,o.intensity),t.uniform1f(this._uBias,o.bias),t.uniform1f(this._uKernelRadius,o.kernelRadius),t.uniform1f(this._uMinResolution,o.minResolution),t.uniform2fv(this._uViewport,eA),t.uniform1f(this._uRandomSeed,m);const u=e.getDepthTexture();i.bindTexture(this._uDepthTexture,u,0),this._aUV.bindArrayBuffer(this._uvBuf),this._aPosition.bindArrayBuffer(this._positionsBuf),this._indicesBuf.bind(),t.drawElements(t.TRIANGLES,this._indicesBuf.numItems,this._indicesBuf.itemType,0)}_build(){let e=!1;const t=this._scene.sao;if(t.numSamples!==this._numSamples&&(this._numSamples=Math.floor(t.numSamples),e=!0),!e)return;const i=this._scene.canvas.gl;if(this._program&&(this._program.destroy(),this._program=null),this._program=new Ft(i,{vertex:[`#version 300 es
                    precision highp float;
                    precision highp int;
                    
                    in vec3 aPosition;
                    in vec2 aUV;            
                    
                    out vec2 vUV;
                    
                    void main () {
                        gl_Position = vec4(aPosition, 1.0);
                        vUV = aUV;
                    }`],fragment:[`#version 300 es      
                precision highp float;
                precision highp int;           
                
                #define NORMAL_TEXTURE 0
                #define PI 3.14159265359
                #define PI2 6.28318530718
                #define EPSILON 1e-6
                #define NUM_SAMPLES ${this._numSamples}
                #define NUM_RINGS 4              
            
                in vec2        vUV;
            
                uniform sampler2D   uDepthTexture;
               
                uniform float       uCameraNear;
                uniform float       uCameraFar;
                uniform mat4        uProjectMatrix;
                uniform mat4        uInverseProjectMatrix;
                
                uniform bool        uPerspective;

                uniform float       uScale;
                uniform float       uIntensity;
                uniform float       uBias;
                uniform float       uKernelRadius;
                uniform float       uMinResolution;
                uniform vec2        uViewport;
                uniform float       uRandomSeed;

                float pow2( const in float x ) { return x*x; }
                
                highp float rand( const in vec2 uv ) {
                    const highp float a = 12.9898, b = 78.233, c = 43758.5453;
                    highp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );
                    return fract(sin(sn) * c);
                }

                vec3 packNormalToRGB( const in vec3 normal ) {
                    return normalize( normal ) * 0.5 + 0.5;
                }

                vec3 unpackRGBToNormal( const in vec3 rgb ) {
                    return 2.0 * rgb.xyz - 1.0;
                }

                const float packUpscale = 256. / 255.;
                const float unpackDownScale = 255. / 256.; 

                const vec3 packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );
                const vec4 unPackFactors = unpackDownScale / vec4( packFactors, 1. );   

                const float shiftRights = 1. / 256.;

                vec4 packFloatToRGBA( const in float v ) {
                    vec4 r = vec4( fract( v * packFactors ), v );
                    r.yzw -= r.xyz * shiftRights; 
                    return r * packUpscale;
                }

                float unpackRGBAToFloat( const in vec4 v ) {                   
                    return dot( floor( v * 255.0 + 0.5 ) / 255.0, unPackFactors );
                }
                
                float perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {
                    return ( near * far ) / ( ( far - near ) * invClipZ - far );
                }

                float orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {
                    return linearClipZ * ( near - far ) - near;
                }
                
                float getDepth( const in vec2 screenPosition ) {
                    return vec4(texture(uDepthTexture, screenPosition)).r;
                }

                float getViewZ( const in float depth ) {
                     if (uPerspective) {
                         return perspectiveDepthToViewZ( depth, uCameraNear, uCameraFar );
                     } else {
                        return orthographicDepthToViewZ( depth, uCameraNear, uCameraFar );
                     }
                }

                vec3 getViewPos( const in vec2 screenPos, const in float depth, const in float viewZ ) {
                	float clipW = uProjectMatrix[2][3] * viewZ + uProjectMatrix[3][3];
                	vec4 clipPosition = vec4( ( vec3( screenPos, depth ) - 0.5 ) * 2.0, 1.0 );
                	clipPosition *= clipW; 
                	return ( uInverseProjectMatrix * clipPosition ).xyz;
                }

                vec3 getViewNormal( const in vec3 viewPosition, const in vec2 screenPos ) {               
                    return normalize( cross( dFdx( viewPosition ), dFdy( viewPosition ) ) );
                }

                float scaleDividedByCameraFar;
                float minResolutionMultipliedByCameraFar;

                float getOcclusion( const in vec3 centerViewPosition, const in vec3 centerViewNormal, const in vec3 sampleViewPosition ) {
                	vec3 viewDelta = sampleViewPosition - centerViewPosition;
                	float viewDistance = length( viewDelta );
                	float scaledScreenDistance = scaleDividedByCameraFar * viewDistance;
                	return max(0.0, (dot(centerViewNormal, viewDelta) - minResolutionMultipliedByCameraFar) / scaledScreenDistance - uBias) / (1.0 + pow2( scaledScreenDistance ) );
                }

                const float ANGLE_STEP = PI2 * float( NUM_RINGS ) / float( NUM_SAMPLES );
                const float INV_NUM_SAMPLES = 1.0 / float( NUM_SAMPLES );

                float getAmbientOcclusion( const in vec3 centerViewPosition ) {
            
                	scaleDividedByCameraFar = uScale / uCameraFar;
                	minResolutionMultipliedByCameraFar = uMinResolution * uCameraFar;
                	vec3 centerViewNormal = getViewNormal( centerViewPosition, vUV );

                	float angle = rand( vUV + uRandomSeed ) * PI2;
                	vec2 radius = vec2( uKernelRadius * INV_NUM_SAMPLES ) / uViewport;
                	vec2 radiusStep = radius;

                	float occlusionSum = 0.0;
                	float weightSum = 0.0;

                	for( int i = 0; i < NUM_SAMPLES; i ++ ) {
                		vec2 sampleUv = vUV + vec2( cos( angle ), sin( angle ) ) * radius;
                		radius += radiusStep;
                		angle += ANGLE_STEP;

                		float sampleDepth = getDepth( sampleUv );
                		if( sampleDepth >= ( 1.0 - EPSILON ) ) {
                			continue;
                		}

                		float sampleViewZ = getViewZ( sampleDepth );
                		vec3 sampleViewPosition = getViewPos( sampleUv, sampleDepth, sampleViewZ );
                		occlusionSum += getOcclusion( centerViewPosition, centerViewNormal, sampleViewPosition );
                		weightSum += 1.0;
                	}

                	if( weightSum == 0.0 ) discard;

                	return occlusionSum * ( uIntensity / weightSum );
                }

                out vec4 outColor;
   
                void main() {
                
                	float centerDepth = getDepth( vUV );
                	
                	if( centerDepth >= ( 1.0 - EPSILON ) ) {
                		discard;
                	}

                	float centerViewZ = getViewZ( centerDepth );
                	vec3 viewPosition = getViewPos( vUV, centerDepth, centerViewZ );

                	float ambientOcclusion = getAmbientOcclusion( viewPosition );
                
                	outColor = packFloatToRGBA(  1.0- ambientOcclusion );
                }`]}),this._program.errors){console.error(this._program.errors.join(`
`)),this._programError=!0;return}const s=new Float32Array([1,1,0,1,0,0,1,0]),o=new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),n=new Uint32Array([0,1,2,0,2,3]);this._positionsBuf=new Ee(i,i.ARRAY_BUFFER,o,o.length,3,i.STATIC_DRAW),this._uvBuf=new Ee(i,i.ARRAY_BUFFER,s,s.length,2,i.STATIC_DRAW),this._indicesBuf=new Ee(i,i.ELEMENT_ARRAY_BUFFER,n,n.length,1,i.STATIC_DRAW),this._program.bind(),this._uCameraNear=this._program.getLocation("uCameraNear"),this._uCameraFar=this._program.getLocation("uCameraFar"),this._uCameraProjectionMatrix=this._program.getLocation("uProjectMatrix"),this._uCameraInverseProjectionMatrix=this._program.getLocation("uInverseProjectMatrix"),this._uPerspective=this._program.getLocation("uPerspective"),this._uScale=this._program.getLocation("uScale"),this._uIntensity=this._program.getLocation("uIntensity"),this._uBias=this._program.getLocation("uBias"),this._uKernelRadius=this._program.getLocation("uKernelRadius"),this._uMinResolution=this._program.getLocation("uMinResolution"),this._uViewport=this._program.getLocation("uViewport"),this._uRandomSeed=this._program.getLocation("uRandomSeed"),this._aPosition=this._program.getAttribute("aPosition"),this._aUV=this._program.getAttribute("aUV"),this._dirty=!1}destroy(){this._program&&(this._program.destroy(),this._program=null)}}const R0=4,L0=.01,Ea=16,U0=new Float32Array(Qf(Ea+1,[0,1])),O0=new Float32Array(Qf(Ea+1,[1,0])),k0=new Float32Array(Q0(Ea+1,R0)),tA=new Float32Array(2);class N0{constructor(e){this._scene=e,this._program=null,this._programError=!1,this._aPosition=null,this._aUV=null,this._uDepthTexture="uDepthTexture",this._uOcclusionTexture="uOcclusionTexture",this._uViewport=null,this._uCameraNear=null,this._uCameraFar=null,this._uCameraProjectionMatrix=null,this._uCameraInverseProjectionMatrix=null,this._uvBuf=null,this._positionsBuf=null,this._indicesBuf=null,this.init()}init(){const e=this._scene.canvas.gl;if(this._program=new Ft(e,{vertex:[`#version 300 es
                precision highp float;
                precision highp int;
                    
                in vec3 aPosition;
                in vec2 aUV;
                uniform vec2 uViewport;
                out vec2 vUV;
                out vec2 vInvSize;
                void main () {
                    vUV = aUV;
                    vInvSize = 1.0 / uViewport;
                    gl_Position = vec4(aPosition, 1.0);
                }`],fragment:[`#version 300 es
                precision highp float;
                precision highp int;
                    
                #define PI 3.14159265359
                #define PI2 6.28318530718
                #define EPSILON 1e-6

                #define KERNEL_RADIUS ${Ea}

                in vec2        vUV;
                in vec2        vInvSize;
            
                uniform sampler2D   uDepthTexture;
                uniform sampler2D   uOcclusionTexture;              
               
                uniform float       uCameraNear;
                uniform float       uCameraFar;               
                uniform float       uDepthCutoff;

                uniform vec2        uSampleOffsets[ KERNEL_RADIUS + 1 ];
                uniform float       uSampleWeights[ KERNEL_RADIUS + 1 ];

                const float         unpackDownscale = 255. / 256.; 

                const vec3          packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );
                const vec4          unpackFactors = unpackDownscale / vec4( packFactors, 1. );   

                const float packUpscale = 256. / 255.;
       
                const float shiftRights = 1. / 256.;
                
                float unpackRGBAToFloat( const in vec4 v ) {
                    return dot( floor( v * 255.0 + 0.5 ) / 255.0, unpackFactors );
                }               

                vec4 packFloatToRGBA( const in float v ) {
                    vec4 r = vec4( fract( v * packFactors ), v );
                    r.yzw -= r.xyz * shiftRights; 
                    return r * packUpscale;
                }

                float viewZToOrthographicDepth( const in float viewZ) {
                    return ( viewZ + uCameraNear ) / ( uCameraNear - uCameraFar );
                }
              
                float orthographicDepthToViewZ( const in float linearClipZ) {
                    return linearClipZ * ( uCameraNear - uCameraFar ) - uCameraNear;
                }

                float viewZToPerspectiveDepth( const in float viewZ) {
                    return (( uCameraNear + viewZ ) * uCameraFar ) / (( uCameraFar - uCameraNear ) * viewZ );
                }
                
                float perspectiveDepthToViewZ( const in float invClipZ) {
                    return ( uCameraNear * uCameraFar ) / ( ( uCameraFar - uCameraNear ) * invClipZ - uCameraFar );
                }

                float getDepth( const in vec2 screenPosition ) {
                    return vec4(texture(uDepthTexture, screenPosition)).r;
                }

                float getViewZ( const in float depth ) {
                     return perspectiveDepthToViewZ( depth );
                }

                out vec4 outColor;
        
                void main() {
                
                    float depth = getDepth( vUV );
                    if( depth >= ( 1.0 - EPSILON ) ) {
                        discard;
                    }

                    float centerViewZ = -getViewZ( depth );
                    bool rBreak = false;
                    bool lBreak = false;

                    float weightSum = uSampleWeights[0];
                    float occlusionSum = unpackRGBAToFloat(texture( uOcclusionTexture, vUV )) * weightSum;

                    for( int i = 1; i <= KERNEL_RADIUS; i ++ ) {

                        float sampleWeight = uSampleWeights[i];
                        vec2 sampleUVOffset = uSampleOffsets[i] * vInvSize;

                        vec2 sampleUV = vUV + sampleUVOffset;
                        float viewZ = -getViewZ( getDepth( sampleUV ) );

                        if( abs( viewZ - centerViewZ ) > uDepthCutoff ) {
                            rBreak = true;
                        }

                        if( ! rBreak ) {
                            occlusionSum += unpackRGBAToFloat(texture( uOcclusionTexture, sampleUV )) * sampleWeight;
                            weightSum += sampleWeight;
                        }

                        sampleUV = vUV - sampleUVOffset;
                        viewZ = -getViewZ( getDepth( sampleUV ) );

                        if( abs( viewZ - centerViewZ ) > uDepthCutoff ) {
                            lBreak = true;
                        }

                        if( ! lBreak ) {
                            occlusionSum += unpackRGBAToFloat(texture( uOcclusionTexture, sampleUV )) * sampleWeight;
                            weightSum += sampleWeight;
                        }
                    }

                    outColor = packFloatToRGBA(occlusionSum / weightSum);
                }`]}),this._program.errors){console.error(this._program.errors.join(`
`)),this._programError=!0;return}const t=new Float32Array([1,1,0,1,0,0,1,0]),i=new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),s=new Uint32Array([0,1,2,0,2,3]);this._positionsBuf=new Ee(e,e.ARRAY_BUFFER,i,i.length,3,e.STATIC_DRAW),this._uvBuf=new Ee(e,e.ARRAY_BUFFER,t,t.length,2,e.STATIC_DRAW),this._indicesBuf=new Ee(e,e.ELEMENT_ARRAY_BUFFER,s,s.length,1,e.STATIC_DRAW),this._program.bind(),this._uViewport=this._program.getLocation("uViewport"),this._uCameraNear=this._program.getLocation("uCameraNear"),this._uCameraFar=this._program.getLocation("uCameraFar"),this._uDepthCutoff=this._program.getLocation("uDepthCutoff"),this._uSampleOffsets=e.getUniformLocation(this._program.handle,"uSampleOffsets"),this._uSampleWeights=e.getUniformLocation(this._program.handle,"uSampleWeights"),this._aPosition=this._program.getAttribute("aPosition"),this._aUV=this._program.getAttribute("aUV")}render(e,t,i){if(this._programError)return;this._getInverseProjectMat||(this._getInverseProjectMat=(()=>{let _=!0;this._scene.camera.on("projMatrix",function(){_=!0});const u=c.mat4();return()=>(_&&c.inverseMat4(n.camera.projMatrix,u),u)})());const s=this._scene.canvas.gl,o=this._program,n=this._scene,a=s.drawingBufferWidth,A=s.drawingBufferHeight,l=n.camera.project._state,h=l.near,d=l.far;s.viewport(0,0,a,A),s.clearColor(0,0,0,1),s.enable(s.DEPTH_TEST),s.disable(s.BLEND),s.frontFace(s.CCW),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),o.bind(),tA[0]=a,tA[1]=A,s.uniform2fv(this._uViewport,tA),s.uniform1f(this._uCameraNear,h),s.uniform1f(this._uCameraFar,d),s.uniform1f(this._uDepthCutoff,L0),i===0?s.uniform2fv(this._uSampleOffsets,O0):s.uniform2fv(this._uSampleOffsets,U0),s.uniform1fv(this._uSampleWeights,k0);const f=e.getDepthTexture(),m=t.getTexture();o.bindTexture(this._uDepthTexture,f,0),o.bindTexture(this._uOcclusionTexture,m,1),this._aUV.bindArrayBuffer(this._uvBuf),this._aPosition.bindArrayBuffer(this._positionsBuf),this._indicesBuf.bind(),s.drawElements(s.TRIANGLES,this._indicesBuf.numItems,this._indicesBuf.itemType,0)}destroy(){this._program.destroy()}}function Q0(r,e){const t=[];for(let i=0;i<=r;i++)t.push(H0(i,e));return t}function H0(r,e){return Math.exp(-(r*r)/(2*(e*e)))/(Math.sqrt(2*Math.PI)*e)}function Qf(r,e){const t=[];for(let i=0;i<=r;i++)t.push(e[0]*i),t.push(e[1]*i);return t}class Hf{constructor(e,t,i){i=i||{},this.gl=t,this.allocated=!1,this.canvas=e,this.buffer=null,this.bound=!1,this.size=i.size,this._hasDepthTexture=!!i.depthTexture}setSize(e){this.size=e}webglContextRestored(e){this.gl=e,this.buffer=null,this.allocated=!1,this.bound=!1}bind(...e){if(this._touch(...e),this.bound)return;const t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,this.buffer.framebuf),this.bound=!0}createTexture(e,t,i=null){const s=this.gl,o=s.createTexture();return s.bindTexture(s.TEXTURE_2D,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),i?s.texStorage2D(s.TEXTURE_2D,1,i,e,t):s.texImage2D(s.TEXTURE_2D,0,s.RGBA,e,t,0,s.RGBA,s.UNSIGNED_BYTE,null),o}_touch(...e){let t,i;const s=this.gl;if(this.size?(t=this.size[0],i=this.size[1]):(t=s.drawingBufferWidth,i=s.drawingBufferHeight),this.buffer){if(this.buffer.width===t&&this.buffer.height===i)return;this.buffer.textures.forEach(h=>s.deleteTexture(h)),s.deleteFramebuffer(this.buffer.framebuf),s.deleteRenderbuffer(this.buffer.renderbuf)}const o=[];e.length>0?o.push(...e.map(h=>this.createTexture(t,i,h))):o.push(this.createTexture(t,i));let n;this._hasDepthTexture&&(n=s.createTexture(),s.bindTexture(s.TEXTURE_2D,n),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texImage2D(s.TEXTURE_2D,0,s.DEPTH_COMPONENT32F,t,i,0,s.DEPTH_COMPONENT,s.FLOAT,null));const a=s.createRenderbuffer();s.bindRenderbuffer(s.RENDERBUFFER,a),s.renderbufferStorage(s.RENDERBUFFER,s.DEPTH_COMPONENT32F,t,i);const A=s.createFramebuffer();s.bindFramebuffer(s.FRAMEBUFFER,A);for(let h=0;h<o.length;h++)s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0+h,s.TEXTURE_2D,o[h],0);if(e.length>0&&s.drawBuffers(o.map((h,d)=>s.COLOR_ATTACHMENT0+d)),this._hasDepthTexture?s.framebufferTexture2D(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.TEXTURE_2D,n,0):s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.RENDERBUFFER,a),s.bindTexture(s.TEXTURE_2D,null),s.bindRenderbuffer(s.RENDERBUFFER,null),s.bindFramebuffer(s.FRAMEBUFFER,null),s.bindFramebuffer(s.FRAMEBUFFER,A),!s.isFramebuffer(A))throw"Invalid framebuffer";s.bindFramebuffer(s.FRAMEBUFFER,null);const l=s.checkFramebufferStatus(s.FRAMEBUFFER);switch(l){case s.FRAMEBUFFER_COMPLETE:break;case s.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case s.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case s.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case s.FRAMEBUFFER_UNSUPPORTED:throw"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"Incomplete framebuffer: "+l}this.buffer={framebuf:A,renderbuf:a,texture:o[0],textures:o,depthTexture:n,width:t,height:i},this.bound=!1}clear(){if(!this.bound)throw"Render buffer not bound";const e=this.gl;e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}read(e,t,i=null,s=null,o=Uint8Array,n=4,a=0){const A=e,l=this.buffer.height?this.buffer.height-t-1:this.gl.drawingBufferHeight-t,h=new o(n),d=this.gl;return d.readBuffer(d.COLOR_ATTACHMENT0+a),d.readPixels(A,l,1,1,i||d.RGBA,s||d.UNSIGNED_BYTE,h,0),h}readArray(e=null,t=null,i=Uint8Array,s=4,o=0){const n=new i(this.buffer.width*this.buffer.height*s),a=this.gl;return a.readBuffer(a.COLOR_ATTACHMENT0+o),a.readPixels(0,0,this.buffer.width,this.buffer.height,e||a.RGBA,t||a.UNSIGNED_BYTE,n,0),n}readImageAsCanvas(){const e=this.gl,t=this._getImageDataCache(),i=t.pixelData,s=t.canvas,o=t.imageData,n=t.context;e.readPixels(0,0,this.buffer.width,this.buffer.height,e.RGBA,e.UNSIGNED_BYTE,i);const a=this.buffer.width,A=this.buffer.height,l=A/2|0,h=a*4,d=new Uint8Array(a*4);for(let f=0;f<l;++f){const m=f*h,_=(A-f-1)*h;d.set(i.subarray(m,m+h)),i.copyWithin(m,_,_+h),i.set(d,_)}return o.data.set(i),n.putImageData(o,0,0),s}readImage(e){const t=this.gl,i=this._getImageDataCache(),s=i.pixelData,o=i.canvas,n=i.imageData,a=i.context,{width:A,height:l}=this.buffer;t.readPixels(0,0,A,l,t.RGBA,t.UNSIGNED_BYTE,s),n.data.set(s),a.putImageData(n,0,0),a.save(),a.globalCompositeOperation="copy",a.scale(1,-1),a.drawImage(o,0,-l,A,l),a.restore();let h=e.format||"png";return h!=="jpeg"&&h!=="png"&&h!=="bmp"&&(console.error("Unsupported image format: '"+h+"' - supported types are 'jpeg', 'bmp' and 'png' - defaulting to 'png'"),h="png"),o.toDataURL(`image/${h}`)}_getImageDataCache(e=Uint8Array,t=4){const i=this.buffer.width,s=this.buffer.height;let o=this._imageDataCache;if(o&&(o.width!==i||o.height!==s)&&(this._imageDataCache=null,o=null),!o){const n=document.createElement("canvas"),a=n.getContext("2d");n.width=i,n.height=s,o={pixelData:new e(i*s*t),canvas:n,context:a,imageData:a.createImageData(i,s),width:i,height:s},this._imageDataCache=o}return o.context.resetTransform(),o}unbind(){const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),this.bound=!1}getTexture(e=0){const t=this;return this._texture||(this._texture={renderBuffer:this,bind:function(i){return t.buffer&&t.buffer.textures[e]?(t.gl.activeTexture(t.gl["TEXTURE"+i]),t.gl.bindTexture(t.gl.TEXTURE_2D,t.buffer.textures[e]),!0):!1},unbind:function(i){t.buffer&&t.buffer.textures[e]&&(t.gl.activeTexture(t.gl["TEXTURE"+i]),t.gl.bindTexture(t.gl.TEXTURE_2D,null))}})}hasDepthTexture(){return this._hasDepthTexture}getDepthTexture(){if(!this._hasDepthTexture)return null;const e=this;return this._depthTexture||(this._dethTexture={renderBuffer:this,bind:function(t){return e.buffer&&e.buffer.depthTexture?(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,e.buffer.depthTexture),!0):!1},unbind:function(t){e.buffer&&e.buffer.depthTexture&&(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,null))}})}destroy(){if(this.allocated){const e=this.gl;this.buffer.textures.forEach(t=>e.deleteTexture(t)),e.deleteTexture(this.buffer.depthTexture),e.deleteFramebuffer(this.buffer.framebuf),e.deleteRenderbuffer(this.buffer.renderbuf),this.allocated=!1,this.buffer=null,this.bound=!1}this._imageDataCache=null,this._texture=null,this._depthTexture=null}}class V0{constructor(e){this.scene=e,this._renderBuffersBasic={},this._renderBuffersScaled={}}getRenderBuffer(e,t){const i=this.scene.canvas.resolutionScale===1?this._renderBuffersBasic:this._renderBuffersScaled;let s=i[e];return s||(s=new Hf(this.scene.canvas.canvas,this.scene.canvas.gl,t),i[e]=s),s}destroy(){for(let e in this._renderBuffersBasic)this._renderBuffersBasic[e].destroy();for(let e in this._renderBuffersScaled)this._renderBuffersScaled[e].destroy()}}function li(r,e){if(r._cachedExtensions===void 0&&(r._cachedExtensions={}),r._cachedExtensions[e]!==void 0)return r._cachedExtensions[e];let t;switch(e){case"WEBGL_depth_texture":t=r.getExtension("WEBGL_depth_texture")||r.getExtension("MOZ_WEBGL_depth_texture")||r.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":t=r.getExtension("EXT_texture_filter_anisotropic")||r.getExtension("MOZ_EXT_texture_filter_anisotropic")||r.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":t=r.getExtension("WEBGL_compressed_texture_s3tc")||r.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||r.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":t=r.getExtension("WEBGL_compressed_texture_pvrtc")||r.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:t=r.getExtension(e)}return r._cachedExtensions[e]=t,t}const G0=function(r,e){e=e||{};const t=new E0(r),i=r.canvas.canvas,s=r.canvas.gl,o=!!e.transparent,n=e.alphaDepthMask,a=new Si({});let A={},l={},h=!0,d=!0,f=!0,m=!0,_=!0,u=!0,B=!0,y=!0;const x=new V0(r);let P=!1;const v=new D0(r),b=new N0(r);this.scene=r,this._occlusionTester=null,this.capabilities={astcSupported:!!li(s,"WEBGL_compressed_texture_astc"),etc1Supported:!0,etc2Supported:!!li(s,"WEBGL_compressed_texture_etc"),dxtSupported:!!li(s,"WEBGL_compressed_texture_s3tc"),bptcSupported:!!li(s,"EXT_texture_compression_bptc"),pvrtcSupported:!!(li(s,"WEBGL_compressed_texture_pvrtc")||li(s,"WEBKIT_WEBGL_compressed_texture_pvrtc"))},this.setTransparentEnabled=function(V){m=V,f=!0},this.setEdgesEnabled=function(V){_=V,f=!0},this.setSAOEnabled=function(V){u=V,f=!0},this.setPBREnabled=function(V){B=V,f=!0},this.setColorTextureEnabled=function(V){y=V,f=!0},this.needStateSort=function(){d=!0},this.shadowsDirty=function(){},this.imageDirty=function(){f=!0},this.webglContextLost=function(){},this.webglContextRestored=function(V){v.init(),b.init(),f=!0},this.addDrawable=function(V,Z){const L=Z.type;if(!L){console.error("Renderer#addDrawable() : drawable with ID "+V+" has no 'type' - ignoring");return}let Q=A[L];Q||(Q={type:Z.type,count:0,isStateSortable:Z.isStateSortable,stateSortCompare:Z.stateSortCompare,drawableMap:{},drawableListPreCull:[],drawableList:[]},A[L]=Q),Q.count++,Q.drawableMap[V]=Z,l[V]=Z,h=!0},this.removeDrawable=function(V){const Z=l[V];if(!Z){console.error("Renderer#removeDrawable() : drawable not found with ID "+V+" - ignoring");return}const L=Z.type,Q=A[L];--Q.count<=0?delete A[L]:delete Q.drawableMap[V],delete l[V],h=!0},this.getPickID=function(V){return a.addItem(V)},this.putPickID=function(V){a.removeItem(V)},this.clear=function(V){if(s.viewport(0,0,s.drawingBufferWidth,s.drawingBufferHeight),o)s.clearColor(1,1,1,1);else{const Z=r.canvas.backgroundColorFromAmbientLight?this.lights.getAmbientColorAndIntensity():r.canvas.backgroundColor;s.clearColor(Z[0],Z[1],Z[2],1)}s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT)},this.needsRender=function(){return f||h||d},this.render=function(V){V=V||{},V.force&&(f=!0),C(),f&&(R(V),vt.frame.frameCount++,f=!1)};function C(){h&&(I(),h=!1,d=!0),d&&(E(),d=!1,f=!0),f&&S()}function I(){for(let V in A)if(A.hasOwnProperty(V)){const Z=A[V],L=Z.drawableMap,Q=Z.drawableListPreCull;let O=0;for(let W in L)L.hasOwnProperty(W)&&(Q[O++]=L[W]);Q.length=O}}function E(){for(let V in A)if(A.hasOwnProperty(V)){const Z=A[V];Z.isStateSortable&&Z.drawableListPreCull.sort(Z.stateSortCompare)}}function S(){for(let V in A)if(A.hasOwnProperty(V)){const Z=A[V],L=Z.drawableListPreCull,Q=Z.drawableList;let O=0;for(let W=0,X=L.length;W<X;W++){const te=L[W];te.rebuildRenderFlags(),te.renderFlags.culled||(Q[O++]=te)}Q.length=O}}function R(V){const Z=r.sao;u&&Z.possible&&D(V),j(),le(V)}function D(V){const Z=r.sao,L=x.getRenderBuffer("saoDepth",{depthTexture:!0});L.bind(),L.clear(),K(V),L.unbind();const Q=x.getRenderBuffer("saoOcclusion");if(Q.bind(),Q.clear(),v.render(L),Q.unbind(),Z.blur){const O=x.getRenderBuffer("saoOcclusion2");O.bind(),O.clear(),b.render(L,Q,0),O.unbind(),Q.bind(),Q.clear(),b.render(L,O,1),Q.unbind()}}function K(V){t.reset(),t.pass=V.pass,s.viewport(0,0,s.drawingBufferWidth,s.drawingBufferHeight),s.clearColor(0,0,0,0),s.enable(s.DEPTH_TEST),s.frontFace(s.CCW),s.enable(s.CULL_FACE),s.depthMask(!0),V.clear!==!1&&s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT);for(let Z in A)if(A.hasOwnProperty(Z)){const Q=A[Z].drawableList;for(let O=0,W=Q.length;O<W;O++){const X=Q[O];X.culled===!0||X.visible===!1||!X.drawDepth||!X.saoEnabled||X.renderFlags.colorOpaque&&X.drawDepth(t)}}}function j(){let V=r._lightsState.lights;for(let Z=0,L=V.length;Z<L;Z++){const Q=V[Z];Q.castsShadow&&z(Q)}}function z(V){if(!V.castsShadow)return;const L=V.getShadowRenderBuf();if(L){L.bind(),t.reset(),t.backfaces=!0,t.frontface=!0,t.shadowViewMatrix=V.getShadowViewMatrix(),t.shadowProjMatrix=V.getShadowProjMatrix(),s.viewport(0,0,s.drawingBufferWidth,s.drawingBufferHeight),s.clearColor(0,0,0,1),s.enable(s.DEPTH_TEST),s.disable(s.BLEND),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT);for(let Q in A)if(A.hasOwnProperty(Q)){const W=A[Q].drawableList;for(let X=0,te=W.length;X<te;X++){const se=W[X];se.visible===!1||!se.castsShadow||!se.drawShadow||se.renderFlags.colorOpaque&&se.drawShadow(t)}}L.unbind()}}function le(V){const Z=[],L=[],Q=[],O=[],W=[],X=[],te=[],se=[],ie=[],oe=[],he=[],ce=[],$=[],ee=[],ge=[],re=[],me=r._lightsState.getAmbientColorAndIntensity();if(t.reset(),t.pass=V.pass,t.withSAO=!1,t.pbrEnabled=B&&!!r.pbrEnabled,t.colorTextureEnabled=y&&!!r.colorTextureEnabled,s.viewport(0,0,s.drawingBufferWidth,s.drawingBufferHeight),o)s.clearColor(0,0,0,0);else{const gt=r.canvas.backgroundColorFromAmbientLight?me:r.canvas.backgroundColor;s.clearColor(gt[0],gt[1],gt[2],1)}s.enable(s.DEPTH_TEST),s.frontFace(s.CCW),s.enable(s.CULL_FACE),s.depthMask(!0),s.lineWidth(1),t.lineWidth=1;const de=r.sao.possible;if(u&&de){const gt=x.getRenderBuffer("saoOcclusion");t.occlusionTexture=gt?gt.getTexture():null}else t.occlusionTexture=null;let Y,Ue,pe;const De=Date.now();V.clear!==!1&&s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT);let fe=0,je=0,Ae=0,Re=0,ze=0,ne=0,ke=0,Ke=0,Ne=0,it=0,Ze=0,at=0,Ce=0,ot=0,Je=0,Te=0;for(let gt in A)if(A.hasOwnProperty(gt)){const Ii=A[gt].drawableList;for(Y=0,Ue=Ii.length;Y<Ue;Y++){if(pe=Ii[Y],pe.culled===!0||pe.visible===!1)continue;const yt=pe.renderFlags;yt.colorOpaque&&(u&&de&&pe.saoEnabled?Z[fe++]=pe:pe.drawColorOpaque(t)),m&&yt.colorTransparent&&(Q[Ae++]=pe),yt.xrayedSilhouetteTransparent&&(te[ke++]=pe),yt.xrayedSilhouetteOpaque&&(W[ze++]=pe),yt.highlightedSilhouetteTransparent&&(he[Ze++]=pe),yt.highlightedSilhouetteOpaque&&(ie[Ne++]=pe),yt.selectedSilhouetteTransparent&&(ge[Je++]=pe),yt.selectedSilhouetteOpaque&&($[Ce++]=pe),pe.edges&&_&&(yt.edgesOpaque&&(L[je++]=pe),yt.edgesTransparent&&(O[Re++]=pe),yt.selectedEdgesTransparent&&(re[Te++]=pe),yt.selectedEdgesOpaque&&(ee[ot++]=pe),yt.xrayedEdgesTransparent&&(se[Ke++]=pe),yt.xrayedEdgesOpaque&&(X[ne++]=pe),yt.highlightedEdgesTransparent&&(ce[at++]=pe),yt.highlightedEdgesOpaque&&(oe[it++]=pe))}}if(fe>0)for(t.withSAO=!0,Y=0;Y<fe;Y++)Z[Y].drawColorOpaque(t);if(je>0)for(Y=0;Y<je;Y++)L[Y].drawEdgesColorOpaque(t);if(ze>0)for(Y=0;Y<ze;Y++)W[Y].drawSilhouetteXRayed(t);if(ne>0)for(Y=0;Y<ne;Y++)X[Y].drawEdgesXRayed(t);if(ke>0||Ke>0||Ae>0||Re>0){if(s.enable(s.CULL_FACE),s.enable(s.BLEND),o?(s.blendEquation(s.FUNC_ADD),s.blendFuncSeparate(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA,s.ONE,s.ONE_MINUS_SRC_ALPHA)):(s.blendEquation(s.FUNC_ADD),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA)),t.backfaces=!1,n||s.depthMask(!1),(Ae>0||Re>0)&&s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA),Re>0)for(Y=0;Y<Re;Y++)pe=O[Y],pe.drawEdgesColorTransparent(t);if(Ae>0)for(Y=0;Y<Ae;Y++)pe=Q[Y],pe.drawColorTransparent(t);if(Ke>0)for(Y=0;Y<Ke;Y++)se[Y].drawEdgesXRayed(t);if(ke>0)for(Y=0;Y<ke;Y++)te[Y].drawSilhouetteXRayed(t);s.disable(s.BLEND),n||s.depthMask(!0)}if(Ne>0||it>0){if(t.lastProgramId=null,r.highlightMaterial.glowThrough&&s.clear(s.DEPTH_BUFFER_BIT),it>0)for(Y=0;Y<it;Y++)oe[Y].drawEdgesHighlighted(t);if(Ne>0)for(Y=0;Y<Ne;Y++)ie[Y].drawSilhouetteHighlighted(t)}if(Ze>0||at>0||Ne>0){if(t.lastProgramId=null,r.selectedMaterial.glowThrough&&s.clear(s.DEPTH_BUFFER_BIT),s.enable(s.BLEND),o?(s.blendEquation(s.FUNC_ADD),s.blendFuncSeparate(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA,s.ONE,s.ONE_MINUS_SRC_ALPHA)):s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA),s.enable(s.CULL_FACE),at>0)for(Y=0;Y<at;Y++)ce[Y].drawEdgesHighlighted(t);if(Ze>0)for(Y=0;Y<Ze;Y++)he[Y].drawSilhouetteHighlighted(t);s.disable(s.BLEND)}if(Ce>0||ot>0){if(t.lastProgramId=null,r.selectedMaterial.glowThrough&&s.clear(s.DEPTH_BUFFER_BIT),ot>0)for(Y=0;Y<ot;Y++)ee[Y].drawEdgesSelected(t);if(Ce>0)for(Y=0;Y<Ce;Y++)$[Y].drawSilhouetteSelected(t)}if(Je>0||Te>0){if(t.lastProgramId=null,r.selectedMaterial.glowThrough&&s.clear(s.DEPTH_BUFFER_BIT),s.enable(s.CULL_FACE),s.enable(s.BLEND),o?(s.blendEquation(s.FUNC_ADD),s.blendFuncSeparate(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA,s.ONE,s.ONE_MINUS_SRC_ALPHA)):s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA),Te>0)for(Y=0;Y<Te;Y++)re[Y].drawEdgesSelected(t);if(Je>0)for(Y=0;Y<Je;Y++)ge[Y].drawSilhouetteSelected(t);s.disable(s.BLEND)}const Pe=Date.now(),ht=vt.frame;ht.renderTime=(Pe-De)/1e3,ht.drawElements=t.drawElements,ht.drawArrays=t.drawArrays,ht.useProgram=t.useProgram,ht.bindTexture=t.bindTexture,ht.bindArray=t.bindArray;const St=_t.MAX_TEXTURE_IMAGE_UNITS;for(let gt=0;gt<St;gt++)s.activeTexture(s.TEXTURE0+gt);s.bindTexture(s.TEXTURE_CUBE_MAP,null),s.bindTexture(s.TEXTURE_2D,null);const ut=_t.MAX_VERTEX_ATTRIBS;for(let gt=0;gt<ut;gt++)s.disableVertexAttribArray(gt)}this.pick=function(){const V=c.vec3();c.mat4();const Z=c.mat4(),L=c.vec3(),Q=c.vec3([0,1,0]),O=new El,W=c.vec2(),X=c.vec3(),te=c.vec3(),se=c.vec3();return c.vec3(),c.vec3(),function(ie,oe=O){oe.reset(),C();let he,ce=null,$=null;oe.pickSurface=ie.pickSurface,ie.canvasPos?(X[0]=ie.canvasPos[0],X[1]=ie.canvasPos[1],ce=r.camera.viewMatrix,$=r.camera.projMatrix,oe.canvasPos=ie.canvasPos):(ie.matrix?(ce=ie.matrix,$=r.camera.projMatrix):(te.set(ie.origin||[0,0,0]),se.set(ie.direction||[0,0,1]),he=c.addVec3(te,se,V),L[0]=Math.random(),L[1]=Math.random(),L[2]=Math.random(),c.normalizeVec3(L),c.cross3Vec3(se,L,Q),ce=c.lookAtMat4v(te,he,Q,Z),$=r.camera.ortho.matrix,oe.origin=te,oe.direction=se),X[0]=i.clientWidth*.5,X[1]=i.clientHeight*.5);for(let me in A)if(A.hasOwnProperty(me)){const de=A[me].drawableList;for(let Y=0,Ue=de.length;Y<Ue;Y++){const pe=de[Y];pe.setPickMatrices&&pe.setPickMatrices(ce,$)}}const ee=x.getRenderBuffer("pick",{size:[1,1]});ee.bind();const ge=ue(ee,X,ce,$,ie,oe);if(!ge)return ee.unbind(),null;const re=ge.delegatePickedEntity?ge.delegatePickedEntity():ge;return re?(ie.pickSurface&&(ge.canPickTriangle&&ge.canPickTriangle()?(ae(ee,ge,X,ce,$,oe),ge.pickTriangleSurface(ce,$,oe),oe.pickSurfacePrecision=!1):ge.canPickWorldPos&&ge.canPickWorldPos()&&(W[0]=r.camera.project.near,W[1]=r.camera.project.far,Be(ee,ge,X,ce,$,W,oe),ie.pickSurfaceNormal!==!1&&Ge(ee,ge,X,ce,$,oe),oe.pickSurfacePrecision=!1)),ee.unbind(),oe.entity=re,oe):(ee.unbind(),null)}}();function ue(V,Z,L,Q,O,W){const X=r.canvas.resolutionScale;t.reset(),t.backfaces=!0,t.frontface=!0,t.pickOrigin=W.origin,t.pickViewMatrix=L,t.pickProjMatrix=Q,t.pickInvisible=!!O.pickInvisible,t.pickClipPos=[Ie(Z[0]*X,s.drawingBufferWidth),Fe(Z[1]*X,s.drawingBufferHeight)],s.viewport(0,0,1,1),s.depthMask(!0),s.enable(s.DEPTH_TEST),s.disable(s.CULL_FACE),s.disable(s.BLEND),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT);const te=O.includeEntityIds,se=O.excludeEntityIds;for(let ce in A)if(A.hasOwnProperty(ce)){const ee=A[ce].drawableList;for(let ge=0,re=ee.length;ge<re;ge++){const me=ee[ge];!me.drawPickMesh||O.pickInvisible!==!0&&me.visible===!1||me.pickable===!1||te&&!te[me.id]||se&&se[me.id]||me.drawPickMesh(t)}}const ie=V.read(0,0),oe=ie[0]+(ie[1]<<8)+(ie[2]<<16)+(ie[3]<<24);return oe<0?void 0:a.items[oe]}function ae(V,Z,L,Q,O,W){if(!Z.drawPickTriangles)return;const X=r.canvas.resolutionScale;t.reset(),t.backfaces=!0,t.frontface=!0,t.pickOrigin=W.origin,t.pickViewMatrix=Q,t.pickProjMatrix=O,t.pickClipPos=[Ie(L[0]*X,s.drawingBufferWidth),Fe(L[1]*X,s.drawingBufferHeight)],s.viewport(0,0,1,1),s.clearColor(0,0,0,0),s.enable(s.DEPTH_TEST),s.disable(s.CULL_FACE),s.disable(s.BLEND),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),Z.drawPickTriangles(t);const te=V.read(0,0);let se=te[0]+te[1]*256+te[2]*256*256+te[3]*256*256*256;se*=3,W.primIndex=se}const Be=function(){const V=c.vec4(),Z=c.vec4(),L=c.vec4(),Q=c.vec4(),O=c.vec4(),W=c.mat4(),X=c.mat4(),te=c.mat4();return function(se,ie,oe,he,ce,$,ee){const ge=r.canvas.resolutionScale;t.reset(),t.backfaces=!0,t.frontface=!0,t.pickOrigin=ee.origin,t.pickViewMatrix=he,t.pickProjMatrix=ce,t.pickZNear=$[0],t.pickZFar=$[1],t.pickElementsCount=ie.pickElementsCount,t.pickElementsOffset=ie.pickElementsOffset,t.pickClipPos=[Ie(oe[0]*ge,s.drawingBufferWidth),Fe(oe[1]*ge,s.drawingBufferHeight)],s.viewport(0,0,1,1),s.clearColor(0,0,0,0),s.depthMask(!0),s.enable(s.DEPTH_TEST),s.disable(s.CULL_FACE),s.disable(s.BLEND),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),ie.drawPickDepths(t);const re=se.read(0,0),me=Qe(re),de=(oe[0]-i.clientWidth/2)/(i.clientWidth/2),Y=-(oe[1]-i.clientHeight/2)/(i.clientHeight/2),Ue=ie.origin;let pe;if(Ue){const ze=ft(he,Ue,W);pe=c.mulMat4(ce,ze,X)}else pe=c.mulMat4(ce,he,X);const De=c.inverseMat4(pe,te);V[0]=de,V[1]=Y,V[2]=-1,V[3]=1;let fe=c.transformVec4(De,V);fe=c.mulVec4Scalar(fe,1/fe[3]),Z[0]=de,Z[1]=Y,Z[2]=1,Z[3]=1;let je=c.transformVec4(De,Z);je=c.mulVec4Scalar(je,1/je[3]);const Ae=c.subVec3(je,fe,L),Re=c.addVec3(fe,c.mulVec4Scalar(Ae,me,Q),O);Ue&&c.addVec3(Re,Ue),ee.worldPos=Re}}();function be(V){V.snapPickLayerParams=[],V.snapPickLayerNumber=0;for(let Z in A){const Q=A[Z].drawableList;for(let O=0,W=Q.length;O<W;O++){const X=Q[O];X.drawSnapInit&&!X.culled&&X.visible&&X.pickable&&X.drawSnapInit(V)}}return V.snapPickLayerParams}function xe(V){V.snapPickLayerParams=V.snapPickLayerParams||[],V.snapPickLayerNumber=V.snapPickLayerParams.length;for(let Z in A){const Q=A[Z].drawableList;for(let O=0,W=Q.length;O<W;O++){const X=Q[O];X.drawSnap&&!X.culled&&X.visible&&X.pickable&&X.drawSnap(V)}}return V.snapPickLayerParams}function Ie(V,Z){return 2*(V/Z)-1}function Fe(V,Z){return 1-2*(V/Z)}this.snapPick=function(){const V=new El;return function(Z,L,Q,O,W=V){if(!Q&&!O)return this.pick({canvasPos:Z,pickSurface:!0});const X=r.canvas.resolutionScale;t.reset(),t.backfaces=!0,t.frontface=!0,t.pickZNear=r.camera.project.near,t.pickZFar=r.camera.project.far,L=L||30;const te=x.getRenderBuffer("uniquePickColors-aabs",{depthTexture:!0,size:[2*L+1,2*L+1]});t.snapVectorA=[Ie(Z[0]*X,s.drawingBufferWidth),Fe(Z[1]*X,s.drawingBufferHeight)],t.snapInvVectorAB=[s.drawingBufferWidth/(2*L),s.drawingBufferHeight/(2*L)],te.bind(s.RGBA32I,s.RGBA32I,s.RGBA8UI),s.viewport(0,0,te.size[0],te.size[1]),s.enable(s.DEPTH_TEST),s.frontFace(s.CCW),s.disable(s.CULL_FACE),s.depthMask(!0),s.disable(s.BLEND),s.depthFunc(s.LEQUAL),s.clear(s.DEPTH_BUFFER_BIT),s.clearBufferiv(s.COLOR,0,new Int32Array([0,0,0,0])),s.clearBufferiv(s.COLOR,1,new Int32Array([0,0,0,0])),s.clearBufferuiv(s.COLOR,2,new Uint32Array([0,0,0,0]));const se=r.camera.viewMatrix,ie=r.camera.projMatrix;for(let ke in A)if(A.hasOwnProperty(ke)){const Ke=A[ke].drawableList;for(let Ne=0,it=Ke.length;Ne<it;Ne++){const Ze=Ke[Ne];Ze.setPickMatrices&&Ze.setPickMatrices(se,ie)}}s.drawBuffers([s.COLOR_ATTACHMENT0,s.COLOR_ATTACHMENT1,s.COLOR_ATTACHMENT2]);const oe=be(t),he=[];t.snapPickLayerParams=he,s.depthMask(!1),s.drawBuffers([s.COLOR_ATTACHMENT0]),Q&&O?(t.snapMode="edge",xe(t),t.snapMode="vertex",t.snapPickLayerNumber++,xe(t)):(t.snapMode=Q?"vertex":"edge",xe(t)),s.depthMask(!0);const ce=te.readArray(s.RGBA_INTEGER,s.INT,Int32Array,4),$=te.readArray(s.RGBA_INTEGER,s.INT,Int32Array,4,1),ee=te.readArray(s.RGBA_INTEGER,s.UNSIGNED_INT,Uint32Array,4,2);te.unbind();let ge=null;const re=L,me=L,de=re*4+me*te.size[0]*4,Y=ce.slice(de,de+4),Ue=$.slice(de,de+4),pe=ee.slice(de,de+4);if(Y[3]!==0){const ke=oe[Math.abs(Y[3])%oe.length],Ke=ke.origin,Ne=ke.coordinateScale;ge=[Y[0]*Ne[0]+Ke[0],Y[1]*Ne[1]+Ke[1],Y[2]*Ne[2]+Ke[2]],c.normalizeVec3([Ue[0]/c.MAX_INT,Ue[1]/c.MAX_INT,Ue[2]/c.MAX_INT]);const it=pe[0]+(pe[1]<<8)+(pe[2]<<16)+(pe[3]<<24);a.items[it]}let De=[];for(let ke=0;ke<ce.length;ke+=4)if(ce[ke+3]>0){const Ke=Math.floor(ke/4),Ne=te.size[0],it=Ke%Ne-Math.floor(Ne/2),Ze=Math.floor(Ke/Ne)-Math.floor(Ne/2),at=Math.sqrt(Math.pow(it,2)+Math.pow(Ze,2));De.push({x:it,y:Ze,dist:at,isVertex:Q&&O?ce[ke+3]>he.length/2:Q,result:[ce[ke+0],ce[ke+1],ce[ke+2],ce[ke+3]],normal:[$[ke+0],$[ke+1],$[ke+2],$[ke+3]],id:[ee[ke+0],ee[ke+1],ee[ke+2],ee[ke+3]]})}let fe=null,je=null,Ae=null,Re=null;if(De.length>0){De.sort((Ce,ot)=>Ce.isVertex!==ot.isVertex?Ce.isVertex?-1:1:Ce.dist-ot.dist),Re=De[0].isVertex?"vertex":"edge";const ke=De[0].result,Ke=De[0].normal,Ne=De[0].id,it=he[ke[3]],Ze=it.origin,at=it.coordinateScale;je=c.normalizeVec3([Ke[0]/c.MAX_INT,Ke[1]/c.MAX_INT,Ke[2]/c.MAX_INT]),fe=[ke[0]*at[0]+Ze[0],ke[1]*at[1]+Ze[1],ke[2]*at[2]+Ze[2]],Ae=a.items[Ne[0]+(Ne[1]<<8)+(Ne[2]<<16)+(Ne[3]<<24)]}if(ge===null&&fe==null)return null;let ze=null;fe!==null&&(ze=r.camera.projectWorldPos(fe));const ne=Ae&&Ae.delegatePickedEntity?Ae.delegatePickedEntity():Ae;return W.reset(),W.snappedToEdge=Re==="edge",W.snappedToVertex=Re==="vertex",W.worldPos=fe,W.worldNormal=je,W.entity=ne,W.canvasPos=Z,W.snappedCanvasPos=ze||Z,W}}();function Qe(V){const Z=[V[0]/256,V[1]/256,V[2]/256,V[3]/256],L=[1/(256*256*256),1/(256*256),1/256,1];return c.dotVec4(Z,L)}function Ge(V,Z,L,Q,O,W){const X=r.canvas.resolutionScale;t.reset(),t.backfaces=!0,t.frontface=!0,t.pickOrigin=W.origin,t.pickViewMatrix=Q,t.pickProjMatrix=O,t.pickClipPos=[Ie(L[0]*X,s.drawingBufferWidth),Fe(L[1]*X,s.drawingBufferHeight)];const te=x.getRenderBuffer("pick-normal",{size:[3,3]});te.bind(s.RGBA32I),s.viewport(0,0,te.size[0],te.size[1]),s.enable(s.DEPTH_TEST),s.disable(s.CULL_FACE),s.disable(s.BLEND),s.clear(s.DEPTH_BUFFER_BIT),s.clearBufferiv(s.COLOR,0,new Int32Array([0,0,0,0])),Z.drawPickNormals(t);const se=te.read(1,1,s.RGBA_INTEGER,s.INT,Int32Array,4);te.unbind();const ie=[se[0]/c.MAX_INT,se[1]/c.MAX_INT,se[2]/c.MAX_INT];c.normalizeVec3(ie),W.worldNormal=ie}this.addMarker=function(V){this._occlusionTester=this._occlusionTester||new T0(r,x),this._occlusionTester.addMarker(V),r.occlusionTestCountdown=0},this.markerWorldPosUpdated=function(V){this._occlusionTester.markerWorldPosUpdated(V)},this.removeMarker=function(V){this._occlusionTester.removeMarker(V)},this.doOcclusionTest=function(){if(this._occlusionTester&&this._occlusionTester.needOcclusionTest){C(),this._occlusionTester.bindRenderBuf(),t.reset(),t.backfaces=!0,t.frontface=!0,s.viewport(0,0,s.drawingBufferWidth,s.drawingBufferHeight),s.clearColor(0,0,0,0),s.enable(s.DEPTH_TEST),s.disable(s.CULL_FACE),s.disable(s.BLEND),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT);for(let V in A)if(A.hasOwnProperty(V)){const L=A[V].drawableList;for(let Q=0,O=L.length;Q<O;Q++){const W=L[Q];!W.drawOcclusion||W.culled===!0||W.visible===!1||W.pickable===!1||W.drawOcclusion(t)}}this._occlusionTester.drawMarkers(t),this._occlusionTester.doOcclusionTest(),this._occlusionTester.unbindRenderBuf()}},this.readPixels=function(V,Z,L,Q){const O=x.getRenderBuffer("snapshot");O.bind(),O.clear(),this.render({force:!0,opaqueOnly:Q});let W,X,te,se;for(X=0;X<L;X++)te=X*2,se=X*4,W=O.read(V[te],V[te+1]),Z[se]=W[0],Z[se+1]=W[1],Z[se+2]=W[2],Z[se+3]=W[3];O.unbind(),f=!0},this.beginSnapshot=function(V={}){const Z=x.getRenderBuffer("snapshot");V.width&&V.height&&Z.setSize([V.width,V.height]),Z.bind(),Z.clear(),P=!0},this.renderSnapshot=function(){if(!P)return;x.getRenderBuffer("snapshot").clear(),this.render({force:!0,opaqueOnly:!1}),f=!0},this.readSnapshot=function(V){return x.getRenderBuffer("snapshot").readImage(V)},this.readSnapshotAsCanvas=function(){return x.getRenderBuffer("snapshot").readImageAsCanvas()},this.endSnapshot=function(){if(!P)return;x.getRenderBuffer("snapshot").unbind(),P=!1},this.destroy=function(){A={},l={},x.destroy(),v.destroy(),b.destroy(),this._occlusionTester&&this._occlusionTester.destroy()}};class j0 extends It{constructor(e,t={}){super(e,t),this.KEY_BACKSPACE=8,this.KEY_TAB=9,this.KEY_ENTER=13,this.KEY_SHIFT=16,this.KEY_CTRL=17,this.KEY_ALT=18,this.KEY_PAUSE_BREAK=19,this.KEY_CAPS_LOCK=20,this.KEY_ESCAPE=27,this.KEY_PAGE_UP=33,this.KEY_PAGE_DOWN=34,this.KEY_END=35,this.KEY_HOME=36,this.KEY_LEFT_ARROW=37,this.KEY_UP_ARROW=38,this.KEY_RIGHT_ARROW=39,this.KEY_DOWN_ARROW=40,this.KEY_INSERT=45,this.KEY_DELETE=46,this.KEY_NUM_0=48,this.KEY_NUM_1=49,this.KEY_NUM_2=50,this.KEY_NUM_3=51,this.KEY_NUM_4=52,this.KEY_NUM_5=53,this.KEY_NUM_6=54,this.KEY_NUM_7=55,this.KEY_NUM_8=56,this.KEY_NUM_9=57,this.KEY_A=65,this.KEY_B=66,this.KEY_C=67,this.KEY_D=68,this.KEY_E=69,this.KEY_F=70,this.KEY_G=71,this.KEY_H=72,this.KEY_I=73,this.KEY_J=74,this.KEY_K=75,this.KEY_L=76,this.KEY_M=77,this.KEY_N=78,this.KEY_O=79,this.KEY_P=80,this.KEY_Q=81,this.KEY_R=82,this.KEY_S=83,this.KEY_T=84,this.KEY_U=85,this.KEY_V=86,this.KEY_W=87,this.KEY_X=88,this.KEY_Y=89,this.KEY_Z=90,this.KEY_LEFT_WINDOW=91,this.KEY_RIGHT_WINDOW=92,this.KEY_SELECT_KEY=93,this.KEY_NUMPAD_0=96,this.KEY_NUMPAD_1=97,this.KEY_NUMPAD_2=98,this.KEY_NUMPAD_3=99,this.KEY_NUMPAD_4=100,this.KEY_NUMPAD_5=101,this.KEY_NUMPAD_6=102,this.KEY_NUMPAD_7=103,this.KEY_NUMPAD_8=104,this.KEY_NUMPAD_9=105,this.KEY_MULTIPLY=106,this.KEY_ADD=107,this.KEY_SUBTRACT=109,this.KEY_DECIMAL_POINT=110,this.KEY_DIVIDE=111,this.KEY_F1=112,this.KEY_F2=113,this.KEY_F3=114,this.KEY_F4=115,this.KEY_F5=116,this.KEY_F6=117,this.KEY_F7=118,this.KEY_F8=119,this.KEY_F9=120,this.KEY_F10=121,this.KEY_F11=122,this.KEY_F12=123,this.KEY_NUM_LOCK=144,this.KEY_SCROLL_LOCK=145,this.KEY_SEMI_COLON=186,this.KEY_EQUAL_SIGN=187,this.KEY_COMMA=188,this.KEY_DASH=189,this.KEY_PERIOD=190,this.KEY_FORWARD_SLASH=191,this.KEY_GRAVE_ACCENT=192,this.KEY_OPEN_BRACKET=219,this.KEY_BACK_SLASH=220,this.KEY_CLOSE_BRACKET=221,this.KEY_SINGLE_QUOTE=222,this.KEY_SPACE=32,this.element=t.element,this.altDown=!1,this.ctrlDown=!1,this.mouseDownLeft=!1,this.mouseDownMiddle=!1,this.mouseDownRight=!1,this.keyDown=[],this.enabled=!0,this.keyboardEnabled=!0,this.mouseover=!1,this.mouseCanvasPos=c.vec2(),this._keyboardEventsElement=t.keyboardEventsElement||document,this._bindEvents()}_bindEvents(){if(this._eventsBound)return;this._keyboardEventsElement.addEventListener("keydown",this._keyDownListener=i=>{!this.enabled||!this.keyboardEnabled||i.target.tagName!=="INPUT"&&i.target.tagName!=="TEXTAREA"&&(i.keyCode===this.KEY_CTRL?this.ctrlDown=!0:i.keyCode===this.KEY_ALT?this.altDown=!0:i.keyCode===this.KEY_SHIFT&&(this.shiftDown=!0),this.keyDown[i.keyCode]=!0,this.fire("keydown",i.keyCode,!0))},!1),this._keyboardEventsElement.addEventListener("keyup",this._keyUpListener=i=>{!this.enabled||!this.keyboardEnabled||i.target.tagName!=="INPUT"&&i.target.tagName!=="TEXTAREA"&&(i.keyCode===this.KEY_CTRL?this.ctrlDown=!1:i.keyCode===this.KEY_ALT?this.altDown=!1:i.keyCode===this.KEY_SHIFT&&(this.shiftDown=!1),this.keyDown[i.keyCode]=!1,this.fire("keyup",i.keyCode,!0))}),this.element.addEventListener("mouseenter",this._mouseEnterListener=i=>{this.enabled&&(this.mouseover=!0,this._getMouseCanvasPos(i),this.fire("mouseenter",this.mouseCanvasPos,!0))}),this.element.addEventListener("mouseleave",this._mouseLeaveListener=i=>{this.enabled&&(this.mouseover=!1,this._getMouseCanvasPos(i),this.fire("mouseleave",this.mouseCanvasPos,!0))}),this.element.addEventListener("mousedown",this._mouseDownListener=i=>{if(this.enabled){switch(i.which){case 1:this.mouseDownLeft=!0;break;case 2:this.mouseDownMiddle=!0;break;case 3:this.mouseDownRight=!0;break}this._getMouseCanvasPos(i),this.element.focus(),this.fire("mousedown",this.mouseCanvasPos,!0),this.mouseover&&i.preventDefault()}}),document.addEventListener("mouseup",this._mouseUpListener=i=>{if(this.enabled){switch(i.which){case 1:this.mouseDownLeft=!1;break;case 2:this.mouseDownMiddle=!1;break;case 3:this.mouseDownRight=!1;break}this.fire("mouseup",this.mouseCanvasPos,!0)}},!0),document.addEventListener("click",this._clickListener=i=>{if(this.enabled){switch(i.which){case 1:this.mouseDownLeft=!1,this.mouseDownRight=!1;break;case 2:this.mouseDownMiddle=!1;break;case 3:this.mouseDownLeft=!1,this.mouseDownRight=!1;break}this._getMouseCanvasPos(i),this.fire("click",this.mouseCanvasPos,!0),this.mouseover&&i.preventDefault()}}),document.addEventListener("dblclick",this._dblClickListener=i=>{if(this.enabled){switch(i.which){case 1:this.mouseDownLeft=!1,this.mouseDownRight=!1;break;case 2:this.mouseDownMiddle=!1;break;case 3:this.mouseDownLeft=!1,this.mouseDownRight=!1;break}this._getMouseCanvasPos(i),this.fire("dblclick",this.mouseCanvasPos,!0),this.mouseover&&i.preventDefault()}});const e=this.scene.tickify(()=>this.fire("mousemove",this.mouseCanvasPos,!0));this.element.addEventListener("mousemove",this._mouseMoveListener=i=>{this.enabled&&(this._getMouseCanvasPos(i),e(),this.mouseover&&i.preventDefault())});const t=this.scene.tickify(i=>{this.fire("mousewheel",i,!0)});this.element.addEventListener("wheel",this._mouseWheelListener=(i,s)=>{if(!this.enabled)return;const o=Math.max(-1,Math.min(1,-i.deltaY*40));t(o)},{passive:!0});{let i,s;this.on("mousedown",n=>{i=n[0],s=n[1]}),this.on("mouseup",n=>{i>=n[0]-2&&i<=n[0]+2&&s>=n[1]-2&&s<=n[1]+2&&this.fire("mouseclicked",n,!0)})}this._eventsBound=!0}_unbindEvents(){this._eventsBound&&(this._keyboardEventsElement.removeEventListener("keydown",this._keyDownListener),this._keyboardEventsElement.removeEventListener("keyup",this._keyUpListener),this.element.removeEventListener("mouseenter",this._mouseEnterListener),this.element.removeEventListener("mouseleave",this._mouseLeaveListener),this.element.removeEventListener("mousedown",this._mouseDownListener),document.removeEventListener("mouseup",this._mouseDownListener),document.removeEventListener("click",this._clickListener),document.removeEventListener("dblclick",this._dblClickListener),this.element.removeEventListener("mousemove",this._mouseMoveListener),this.element.removeEventListener("wheel",this._mouseWheelListener),window.OrientationChangeEvent&&window.removeEventListener("orientationchange",this._orientationchangedListener),window.DeviceMotionEvent&&window.removeEventListener("devicemotion",this._deviceMotionListener),window.DeviceOrientationEvent&&window.removeEventListener("deviceorientation",this._deviceOrientListener),this._eventsBound=!1)}_getMouseCanvasPos(e){if(!e)e=window.event,this.mouseCanvasPos[0]=e.x,this.mouseCanvasPos[1]=e.y;else{let t=e.target,i=0,s=0;for(;t.offsetParent;)i+=t.offsetLeft,s+=t.offsetTop,t=t.offsetParent;this.mouseCanvasPos[0]=e.pageX-i,this.mouseCanvasPos[1]=e.pageY-s}}setEnabled(e){this.enabled!==e&&this.fire("enabled",this.enabled=e)}getEnabled(){return this.enabled}setKeyboardEnabled(e){this.keyboardEnabled=e}getKeyboardEnabled(){return this.keyboardEnabled}destroy(){super.destroy(),this._unbindEvents()}}const bh=new Si({});class Mt{constructor(e){this.id=bh.addItem({});for(const t in e)e.hasOwnProperty(t)&&(this[t]=e[t])}destroy(){bh.removeItem(this.id)}}class z0 extends It{get type(){return"Viewport"}constructor(e,t={}){super(e,t),this._state=new Mt({boundary:[0,0,100,100]}),this.boundary=t.boundary,this.autoBoundary=t.autoBoundary}set boundary(e){if(!this._autoBoundary){if(!e){const t=this.scene.canvas.boundary,i=t[2],s=t[3];e=[0,0,i,s]}this._state.boundary=e,this.glRedraw(),this.fire("boundary",this._state.boundary)}}get boundary(){return this._state.boundary}set autoBoundary(e){e=!!e,e!==this._autoBoundary&&(this._autoBoundary=e,this._autoBoundary?this._onCanvasSize=this.scene.canvas.on("boundary",function(t){const i=t[2],s=t[3];this._state.boundary=[0,0,i,s],this.glRedraw(),this.fire("boundary",this._state.boundary)},this):this._onCanvasSize&&(this.scene.canvas.off(this._onCanvasSize),this._onCanvasSize=null),this.fire("autoBoundary",this._autoBoundary))}get autoBoundary(){return this._autoBoundary}_getState(){return this._state}destroy(){super.destroy(),this._state.destroy()}}class K0 extends It{get type(){return"Perspective"}constructor(e,t={}){super(e,t),this.camera=e,this._state=new Mt({matrix:c.mat4(),inverseMatrix:c.mat4(),transposedMatrix:c.mat4(),near:.1,far:1e4}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this._fov=60,this._canvasResized=this.scene.canvas.on("boundary",this._needUpdate,this),this.fov=t.fov,this.fovAxis=t.fovAxis,this.near=t.near,this.far=t.far}_update(){const i=this.scene.canvas.boundary,s=i[2]/i[3],o=this._fovAxis;let n=this._fov;(o==="x"||o==="min"&&s<1||o==="max"&&s>1)&&(n=n/s),n=Math.min(n,120),c.perspectiveMat4(n*(Math.PI/180),s,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.camera._updateScheduled=!0,this.fire("matrix",this._state.matrix)}set fov(e){e=e??60,e!==this._fov&&(this._fov=e,this._needUpdate(0),this.fire("fov",this._fov))}get fov(){return this._fov}set fovAxis(e){e=e||"min",this._fovAxis!==e&&(e!=="x"&&e!=="y"&&e!=="min"&&(this.error("Unsupported value for 'fovAxis': "+e+" - defaulting to 'min'"),e="min"),this._fovAxis=e,this._needUpdate(0),this.fire("fovAxis",this._fovAxis))}get fovAxis(){return this._fovAxis}set near(e){const t=e??.1;this._state.near!==t&&(this._state.near=t,this._needUpdate(0),this.fire("near",this._state.near))}get near(){return this._state.near}set far(e){const t=e??1e4;this._state.far!==t&&(this._state.far=t,this._needUpdate(0),this.fire("far",this._state.far))}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(c.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(c.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(e,t,i,s,o){const n=this.scene.canvas.canvas,a=n.offsetWidth/2,A=n.offsetHeight/2;return i[0]=(e[0]-a)/a,i[1]=(e[1]-A)/A,i[2]=t,i[3]=1,c.mulMat4v4(this.inverseMatrix,i,s),c.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1,c.mulMat4v4(this.camera.inverseViewMatrix,s,o),o}destroy(){super.destroy(),this._state.destroy(),this.scene.canvas.off(this._canvasResized)}}class W0 extends It{get type(){return"Ortho"}constructor(e,t={}){super(e,t),this.camera=e,this._state=new Mt({matrix:c.mat4(),inverseMatrix:c.mat4(),transposedMatrix:c.mat4(),near:.1,far:1e4}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.scale=t.scale,this.near=t.near,this.far=t.far,this._onCanvasBoundary=this.scene.canvas.on("boundary",this._needUpdate,this)}_update(){const i=this.scene,o=.5*this._scale,n=i.canvas.boundary,a=n[2],A=n[3],l=a/A;let h,d,f,m;a>A?(h=-o,d=o,f=o/l,m=-o/l):(h=-o*l,d=o*l,f=o,m=-o),c.orthoMat4c(h,d,m,f,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}set scale(e){e==null&&(e=1),e<=0&&(e=.01),this._scale=e,this._needUpdate(0),this.fire("scale",this._scale)}get scale(){return this._scale}set near(e){const t=e??.1;this._state.near!==t&&(this._state.near=t,this._needUpdate(0),this.fire("near",this._state.near))}get near(){return this._state.near}set far(e){const t=e??1e4;this._state.far!==t&&(this._state.far=t,this._needUpdate(0),this.fire("far",this._state.far))}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(c.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(c.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(e,t,i,s,o){const n=this.scene.canvas.canvas,a=n.offsetWidth/2,A=n.offsetHeight/2;return i[0]=(e[0]-a)/a,i[1]=(e[1]-A)/A,i[2]=t,i[3]=1,c.mulMat4v4(this.inverseMatrix,i,s),c.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1,c.mulMat4v4(this.camera.inverseViewMatrix,s,o),o}destroy(){super.destroy(),this._state.destroy(),this.scene.canvas.off(this._onCanvasBoundary)}}class X0 extends It{get type(){return"Frustum"}constructor(e,t={}){super(e,t),this.camera=e,this._state=new Mt({matrix:c.mat4(),inverseMatrix:c.mat4(),transposedMatrix:c.mat4(),near:.1,far:1e4}),this._left=-1,this._right=1,this._bottom=-1,this._top=1,this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.left=t.left,this.right=t.right,this.bottom=t.bottom,this.top=t.top,this.near=t.near,this.far=t.far}_update(){c.frustumMat4(this._left,this._right,this._bottom,this._top,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}set left(e){this._left=e??-1,this._needUpdate(0),this.fire("left",this._left)}get left(){return this._left}set right(e){this._right=e??1,this._needUpdate(0),this.fire("right",this._right)}get right(){return this._right}set top(e){this._top=e??1,this._needUpdate(0),this.fire("top",this._top)}get top(){return this._top}set bottom(e){this._bottom=e??-1,this._needUpdate(0),this.fire("bottom",this._bottom)}get bottom(){return this._bottom}set near(e){this._state.near=e??.1,this._needUpdate(0),this.fire("near",this._state.near)}get near(){return this._state.near}set far(e){this._state.far=e??1e4,this._needUpdate(0),this.fire("far",this._state.far)}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(c.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(c.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(e,t,i,s,o){const n=this.scene.canvas.canvas,a=n.offsetWidth/2,A=n.offsetHeight/2;return i[0]=(e[0]-a)/a,i[1]=(e[1]-A)/A,i[2]=t,i[3]=1,c.mulMat4v4(this.inverseMatrix,i,s),c.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1,c.mulMat4v4(this.camera.inverseViewMatrix,s,o),o}destroy(){super.destroy(),this._state.destroy(),super.destroy()}}class Y0 extends It{get type(){return"CustomProjection"}constructor(e,t={}){super(e,t),this.camera=e,this._state=new Mt({matrix:c.mat4(),inverseMatrix:c.mat4(),transposedMatrix:c.mat4()}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!1,this.matrix=t.matrix}set matrix(e){this._state.matrix.set(e||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}get matrix(){return this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(c.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(c.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(e,t,i,s,o){const n=this.scene.canvas.canvas,a=n.offsetWidth/2,A=n.offsetHeight/2;return i[0]=(e[0]-a)/a,i[1]=(e[1]-A)/A,i[2]=t,i[3]=1,c.mulMat4v4(this.inverseMatrix,i,s),c.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1,c.mulMat4v4(this.camera.inverseViewMatrix,s,o),o}destroy(){super.destroy(),this._state.destroy()}}const Cs=c.vec3(),zs=c.vec3(),Ks=c.vec3(),Ws=c.vec3(),iA=c.vec3(),sA=c.vec3(),J0=c.vec4(),Z0=c.vec4(),q0=c.vec4(),_i=c.mat4(),Ch=c.mat4(),Eh=c.vec3(),Ih=c.vec3(),Fh=c.vec3(),Mh=c.vec3();class $0 extends It{get type(){return"Camera"}constructor(e,t={}){super(e,t),this._state=new Mt({deviceMatrix:c.mat4(),hasDeviceMatrix:!1,matrix:c.mat4(),normalMatrix:c.mat4(),inverseMatrix:c.mat4()}),this._perspective=new K0(this),this._ortho=new W0(this),this._frustum=new X0(this),this._customProjection=new Y0(this),this._project=this._perspective,this._eye=c.vec3([0,0,10]),this._look=c.vec3([0,0,0]),this._up=c.vec3([0,1,0]),this._worldUp=c.vec3([0,1,0]),this._worldRight=c.vec3([1,0,0]),this._worldForward=c.vec3([0,0,-1]),this.deviceMatrix=t.deviceMatrix,this.eye=t.eye,this.look=t.look,this.up=t.up,this.worldAxis=t.worldAxis,this.gimbalLock=t.gimbalLock,this.constrainPitch=t.constrainPitch,this.projection=t.projection,this._perspective.on("matrix",()=>{this._projectionType==="perspective"&&this.fire("projMatrix",this._perspective.matrix)}),this._ortho.on("matrix",()=>{this._projectionType==="ortho"&&this.fire("projMatrix",this._ortho.matrix)}),this._frustum.on("matrix",()=>{this._projectionType==="frustum"&&this.fire("projMatrix",this._frustum.matrix)}),this._customProjection.on("matrix",()=>{this._projectionType==="customProjection"&&this.fire("projMatrix",this._customProjection.matrix)})}_update(){const e=this._state;let t;this.projection==="ortho"?(c.subVec3(this._eye,this._look,Eh),c.normalizeVec3(Eh,Ih),c.mulVec3Scalar(Ih,1e3,Fh),c.addVec3(this._look,Fh,Mh),t=Mh):t=this._eye,e.hasDeviceMatrix?(c.lookAtMat4v(t,this._look,this._up,Ch),c.mulMat4(e.deviceMatrix,Ch,e.matrix)):c.lookAtMat4v(t,this._look,this._up,e.matrix),c.inverseMat4(this._state.matrix,this._state.inverseMatrix),c.transposeMat4(this._state.inverseMatrix,this._state.normalMatrix),this.glRedraw(),this.fire("matrix",this._state.matrix),this.fire("viewMatrix",this._state.matrix)}orbitYaw(e){let t=c.subVec3(this._eye,this._look,Cs);c.rotationMat4v(e*.0174532925,this._gimbalLock?this._worldUp:this._up,_i),t=c.transformPoint3(_i,t,zs),this.eye=c.addVec3(this._look,t,Ks),this.up=c.transformPoint3(_i,this._up,Ws)}orbitPitch(e){if(this._constrainPitch&&(e=c.dotVec3(this._up,this._worldUp)/c.DEGTORAD,e<1))return;let t=c.subVec3(this._eye,this._look,Cs);const i=c.cross3Vec3(c.normalizeVec3(t,zs),c.normalizeVec3(this._up,Ks));c.rotationMat4v(e*.0174532925,i,_i),t=c.transformPoint3(_i,t,Ws),this.up=c.transformPoint3(_i,this._up,iA),this.eye=c.addVec3(t,this._look,sA)}yaw(e){let t=c.subVec3(this._look,this._eye,Cs);c.rotationMat4v(e*.0174532925,this._gimbalLock?this._worldUp:this._up,_i),t=c.transformPoint3(_i,t,zs),this.look=c.addVec3(t,this._eye,Ks),this._gimbalLock&&(this.up=c.transformPoint3(_i,this._up,Ws))}pitch(e){if(this._constrainPitch&&(e=c.dotVec3(this._up,this._worldUp)/c.DEGTORAD,e<1))return;let t=c.subVec3(this._look,this._eye,Cs);const i=c.cross3Vec3(c.normalizeVec3(t,zs),c.normalizeVec3(this._up,Ks));c.rotationMat4v(e*.0174532925,i,_i),this.up=c.transformPoint3(_i,this._up,sA),t=c.transformPoint3(_i,t,Ws),this.look=c.addVec3(t,this._eye,iA)}pan(e){const t=c.subVec3(this._eye,this._look,Cs),i=[0,0,0];let s;if(e[0]!==0){const o=c.cross3Vec3(c.normalizeVec3(t,[]),c.normalizeVec3(this._up,zs));s=c.mulVec3Scalar(o,e[0]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]}e[1]!==0&&(s=c.mulVec3Scalar(c.normalizeVec3(this._up,Ks),e[1]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]),e[2]!==0&&(s=c.mulVec3Scalar(c.normalizeVec3(t,Ws),e[2]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]),this.eye=c.addVec3(this._eye,i,iA),this.look=c.addVec3(this._look,i,sA)}zoom(e){const t=c.subVec3(this._eye,this._look,Cs),i=Math.abs(c.lenVec3(t,zs)),s=Math.abs(i+e);if(s<.5)return;const o=c.normalizeVec3(t,Ks);this.eye=c.addVec3(this._look,c.mulVec3Scalar(o,s),Ws)}set eye(e){this._eye.set(e||[0,0,10]),this._needUpdate(0),this.fire("eye",this._eye)}get eye(){return this._eye}set look(e){this._look.set(e||[0,0,0]),this._needUpdate(0),this.fire("look",this._look)}get look(){return this._look}set up(e){this._up.set(e||[0,1,0]),this._needUpdate(0),this.fire("up",this._up)}get up(){return this._up}set deviceMatrix(e){this._state.deviceMatrix.set(e||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._state.hasDeviceMatrix=!!e,this._needUpdate(0),this.fire("deviceMatrix",this._state.deviceMatrix)}get deviceMatrix(){return this._state.deviceMatrix}set worldAxis(e){e=e||[1,0,0,0,1,0,0,0,1],this._worldAxis?this._worldAxis.set(e):this._worldAxis=c.vec3(e),this._worldRight[0]=this._worldAxis[0],this._worldRight[1]=this._worldAxis[1],this._worldRight[2]=this._worldAxis[2],this._worldUp[0]=this._worldAxis[3],this._worldUp[1]=this._worldAxis[4],this._worldUp[2]=this._worldAxis[5],this._worldForward[0]=this._worldAxis[6],this._worldForward[1]=this._worldAxis[7],this._worldForward[2]=this._worldAxis[8],this.fire("worldAxis",this._worldAxis)}get worldAxis(){return this._worldAxis}get worldUp(){return this._worldUp}get xUp(){return this._worldUp[0]>this._worldUp[1]&&this._worldUp[0]>this._worldUp[2]}get yUp(){return this._worldUp[1]>this._worldUp[0]&&this._worldUp[1]>this._worldUp[2]}get zUp(){return this._worldUp[2]>this._worldUp[0]&&this._worldUp[2]>this._worldUp[1]}get worldRight(){return this._worldRight}get worldForward(){return this._worldForward}set gimbalLock(e){this._gimbalLock=e!==!1,this.fire("gimbalLock",this._gimbalLock)}get gimbalLock(){return this._gimbalLock}set constrainPitch(e){this._constrainPitch=!!e,this.fire("constrainPitch",this._constrainPitch)}get eyeLookDist(){return c.lenVec3(c.subVec3(this._look,this._eye,Cs))}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get viewMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get normalMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}get viewNormalMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}get inverseViewMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.inverseMatrix}get projMatrix(){return this[this.projection].matrix}get perspective(){return this._perspective}get ortho(){return this._ortho}get frustum(){return this._frustum}get customProjection(){return this._customProjection}set projection(e){e=e||"perspective",this._projectionType!==e&&(e==="perspective"?this._project=this._perspective:e==="ortho"?this._project=this._ortho:e==="frustum"?this._project=this._frustum:e==="customProjection"?this._project=this._customProjection:(this.error("Unsupported value for 'projection': "+e+" defaulting to 'perspective'"),this._project=this._perspective,e="perspective"),this._project._update(),this._projectionType=e,this.glRedraw(),this._update(),this.fire("dirty"),this.fire("projection",this._projectionType),this.fire("projMatrix",this._project.matrix))}get projection(){return this._projectionType}get project(){return this._project}projectWorldPos(e){const t=J0,i=Z0,s=q0;t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=1,c.mulMat4v4(this.viewMatrix,t,i),c.mulMat4v4(this.projMatrix,i,s),c.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1;const o=this.scene.canvas.canvas,n=o.offsetWidth/2,a=o.offsetHeight/2;return[s[0]*n+n,s[1]*a+a]}destroy(){super.destroy(),this._state.destroy()}}class Vf extends It{get type(){return"Light"}get isLight(){return!0}constructor(e,t={}){super(e,t)}}class Sh extends Vf{get type(){return"DirLight"}constructor(e,t={}){super(e,t),this._shadowRenderBuf=null,this._shadowViewMatrix=null,this._shadowProjMatrix=null,this._shadowViewMatrixDirty=!0,this._shadowProjMatrixDirty=!0;const i=this.scene.camera,s=this.scene.canvas;this._onCameraViewMatrix=i.on("viewMatrix",()=>{this._shadowViewMatrixDirty=!0}),this._onCameraProjMatrix=i.on("projMatrix",()=>{this._shadowProjMatrixDirty=!0}),this._onCanvasBoundary=s.on("boundary",()=>{this._shadowProjMatrixDirty=!0}),this._state=new Mt({type:"dir",dir:c.vec3([1,1,1]),color:c.vec3([.7,.7,.8]),intensity:1,space:t.space||"view",castsShadow:!1,getShadowViewMatrix:()=>{if(this._shadowViewMatrixDirty){this._shadowViewMatrix||(this._shadowViewMatrix=c.identityMat4());const o=this.scene.camera,n=this._state.dir,a=o.look,A=[a[0]-n[0],a[1]-n[1],a[2]-n[2]],l=[0,1,0];c.lookAtMat4v(A,a,l,this._shadowViewMatrix),this._shadowViewMatrixDirty=!1}return this._shadowViewMatrix},getShadowProjMatrix:()=>(this._shadowProjMatrixDirty&&(this._shadowProjMatrix||(this._shadowProjMatrix=c.identityMat4()),c.orthoMat4c(-40,40,-40,40,-40,80,this._shadowProjMatrix),this._shadowProjMatrixDirty=!1),this._shadowProjMatrix),getShadowRenderBuf:()=>(this._shadowRenderBuf||(this._shadowRenderBuf=new Hf(this.scene.canvas.canvas,this.scene.canvas.gl,{size:[1024,1024]})),this._shadowRenderBuf)}),this.dir=t.dir,this.color=t.color,this.intensity=t.intensity,this.castsShadow=t.castsShadow,this.scene._lightCreated(this)}set dir(e){this._state.dir.set(e||[1,1,1]),this._shadowViewMatrixDirty=!0,this.glRedraw()}get dir(){return this._state.dir}set color(e){this._state.color.set(e||[.7,.7,.8]),this.glRedraw()}get color(){return this._state.color}set intensity(e){e=e!==void 0?e:1,this._state.intensity=e,this.glRedraw()}get intensity(){return this._state.intensity}set castsShadow(e){e=!!e,this._state.castsShadow!==e&&(this._state.castsShadow=e,this._shadowViewMatrixDirty=!0,this.glRedraw())}get castsShadow(){return this._state.castsShadow}destroy(){const e=this.scene.camera,t=this.scene.canvas;e.off(this._onCameraViewMatrix),e.off(this._onCameraProjMatrix),t.off(this._onCanvasBoundary),super.destroy(),this._state.destroy(),this._shadowRenderBuf&&this._shadowRenderBuf.destroy(),this.scene._lightDestroyed(this),this.glRedraw()}}class ev extends Vf{get type(){return"AmbientLight"}constructor(e,t={}){super(e,t),this._state={type:"ambient",color:c.vec3([.7,.7,.7]),intensity:1},this.color=t.color,this.intensity=t.intensity,this.scene._lightCreated(this)}set color(e){this._state.color.set(e||[.7,.7,.8]),this.glRedraw()}get color(){return this._state.color}set intensity(e){this._state.intensity=e!==void 0?e:1,this.glRedraw()}get intensity(){return this._state.intensity}destroy(){super.destroy(),this.scene._lightDestroyed(this)}}class Gf extends It{get type(){return"Geometry"}get isGeometry(){return!0}constructor(e,t={}){super(e,t),vt.memory.meshes++}destroy(){super.destroy(),vt.memory.meshes--}}var us=function(){const r=[],e=[],t=[],i=[],s=[];let o=0;const n=new Uint16Array(3),a=new Uint16Array(3),A=new Uint16Array(3),l=c.vec3(),h=c.vec3(),d=c.vec3(),f=c.vec3(),m=c.vec3(),_=c.vec3(),u=c.vec3();function B(x,P){const v={};let b,C,I,E;const R=Math.pow(10,4);let D,K,j=0;for(D=0,K=x.length;D<K;D+=3)b=x[D],C=x[D+1],I=x[D+2],E=Math.round(b*R)+"_"+Math.round(C*R)+"_"+Math.round(I*R),v[E]===void 0&&(v[E]=j/3,r[j++]=b,r[j++]=C,r[j++]=I),e[D/3]=v[E];for(D=0,K=P.length;D<K;D++)i[D]=e[P[D]],t[i[D]]=P[D]}function y(x,P){o=0;for(let v=0,b=x;v<b;v+=3){const C=i[v]*3,I=i[v+1]*3,E=i[v+2]*3;P?(n[0]=r[C],n[1]=r[C+1],n[2]=r[C+2],a[0]=r[I],a[1]=r[I+1],a[2]=r[I+2],A[0]=r[E],A[1]=r[E+1],A[2]=r[E+2],c.decompressPosition(n,P,l),c.decompressPosition(a,P,h),c.decompressPosition(A,P,d)):(l[0]=r[C],l[1]=r[C+1],l[2]=r[C+2],h[0]=r[I],h[1]=r[I+1],h[2]=r[I+2],d[0]=r[E],d[1]=r[E+1],d[2]=r[E+2]),c.subVec3(d,h,f),c.subVec3(l,h,m),c.cross3Vec3(f,m,_),c.normalizeVec3(_,u);const S=s[o]||(s[o]={normal:c.vec3()});S.normal[0]=u[0],S.normal[1]=u[1],S.normal[2]=u[2],o++}}return function(x,P,v,b){B(x,P),y(P.length,v);const C=[],I=Math.cos(c.DEGTORAD*b),E={};let S,R,D,K,j,z=!1,le,ue,ae,Be,be,xe;for(let Ie=0,Fe=P.length;Ie<Fe;Ie+=3){const Qe=Ie/3;for(let Ge=0;Ge<3;Ge++)S=i[Ie+Ge],R=i[Ie+(Ge+1)%3],D=Math.min(S,R),K=Math.max(S,R),j=D+","+K,E[j]===void 0?E[j]={index1:D,index2:K,face1:Qe,face2:void 0}:E[j].face2=Qe}for(j in E)le=E[j],!(le.face2!==void 0&&(ue=s[le.face1].normal,ae=s[le.face2].normal,Be=c.dotVec3(ue,ae),Be>I))&&(be=t[le.index1],xe=t[le.index2],(!z&&be>65535||xe>65535)&&(z=!0),C.push(be),C.push(xe));return z?new Uint32Array(C):new Uint16Array(C)}}();function tv(r){const e=new Float32Array(3),t=new Float32Array(3);let i,s;for(i=0;i<3;i++)e[i]=Number.MAX_VALUE,t[i]=-Number.MAX_VALUE;for(i=0;i<r.length;i+=3)for(s=0;s<3;s++)e[s]=Math.min(e[s],r[i+s]),t[s]=Math.max(t[s],r[i+s]);return{min:e,max:t}}const iv=function(){const r=c.mat4(),e=c.mat4();return function(t,i){i=i||c.mat4();const s=t[0],o=t[1],n=t[2],a=t[3]-s,A=t[4]-o,l=t[5]-n,h=65535;return c.identityMat4(r),c.translationMat4v(t,r),c.identityMat4(e),c.scalingMat4v([a/h,A/h,l/h],e),c.mulMat4(r,e,i),i}}();var sv=function(){const r=c.mat4(),e=c.mat4();return function(t,i,s){const o=new Uint16Array(t.length),n=new Float32Array([s[0]!==i[0]?65535/(s[0]-i[0]):0,s[1]!==i[1]?65535/(s[1]-i[1]):0,s[2]!==i[2]?65535/(s[2]-i[2]):0]);let a;for(a=0;a<t.length;a+=3)o[a+0]=Math.max(0,Math.min(65535,Math.floor((t[a+0]-i[0])*n[0]))),o[a+1]=Math.max(0,Math.min(65535,Math.floor((t[a+1]-i[1])*n[1]))),o[a+2]=Math.max(0,Math.min(65535,Math.floor((t[a+2]-i[2])*n[2])));c.identityMat4(r),c.translationMat4v(i,r),c.identityMat4(e),c.scalingMat4v([(s[0]-i[0])/65535,(s[1]-i[1])/65535,(s[2]-i[2])/65535],e);const A=c.mulMat4(r,e,c.identityMat4());return{quantized:o,decodeMatrix:A}}}();function rv(r,e,t){const i=new Float32Array([e[3]!==e[0]?65535/(e[3]-e[0]):0,e[4]!==e[1]?65535/(e[4]-e[1]):0,e[5]!==e[2]?65535/(e[5]-e[2]):0]);t[0]=Math.max(0,Math.min(65535,Math.floor((r[0]-e[0])*i[0]))),t[1]=Math.max(0,Math.min(65535,Math.floor((r[1]-e[1])*i[1]))),t[2]=Math.max(0,Math.min(65535,Math.floor((r[2]-e[2])*i[2])))}function ov(r,e,t){return t[0]=r[0]*e[0]+e[12],t[1]=r[1]*e[5]+e[13],t[2]=r[2]*e[10]+e[14],t}function nv(r,e,t=r){return t[0]=r[0]*e[0]+e[12],t[1]=r[1]*e[5]+e[13],t[2]=r[2]*e[10]+e[14],t[3]=r[3]*e[0]+e[12],t[4]=r[4]*e[5]+e[13],t[5]=r[5]*e[10]+e[14],t}function av(r,e,t=new Float32Array(r.length)){for(let i=0,s=r.length;i<s;i+=3)t[i+0]=r[i+0]*e[0]+e[12],t[i+1]=r[i+1]*e[5]+e[13],t[i+2]=r[i+2]*e[10]+e[14];return t}function Av(r){const e=new Float32Array(2),t=new Float32Array(2);let i,s;for(i=0;i<2;i++)e[i]=Number.MAX_VALUE,t[i]=-Number.MAX_VALUE;for(i=0;i<r.length;i+=2)for(s=0;s<2;s++)e[s]=Math.min(e[s],r[i+s]),t[s]=Math.max(t[s],r[i+s]);return{min:e,max:t}}var lv=function(){const r=c.mat3(),e=c.mat3();return function(t,i,s){const o=new Uint16Array(t.length),n=new Float32Array([65535/(s[0]-i[0]),65535/(s[1]-i[1])]);let a;for(a=0;a<t.length;a+=2)o[a+0]=Math.max(0,Math.min(65535,Math.floor((t[a+0]-i[0])*n[0]))),o[a+1]=Math.max(0,Math.min(65535,Math.floor((t[a+1]-i[1])*n[1])));c.identityMat3(r),c.translationMat3v(i,r),c.identityMat3(e),c.scalingMat3v([(s[0]-i[0])/65535,(s[1]-i[1])/65535],e);const A=c.mulMat3(r,e,c.identityMat3());return{quantized:o,decodeMatrix:A}}}();function cv(r){const e=new Int8Array(r.length);let t,i,s,o,n;for(let a=0;a<r.length;a+=3)s=t=ln(r,a,"floor","floor"),i=cn(t),o=n=hn(r,a,i),t=ln(r,a,"ceil","floor"),i=cn(t),o=hn(r,a,i),o>n&&(s=t,n=o),t=ln(r,a,"floor","ceil"),i=cn(t),o=hn(r,a,i),o>n&&(s=t,n=o),t=ln(r,a,"ceil","ceil"),i=cn(t),o=hn(r,a,i),o>n&&(s=t,n=o),e[a]=s[0],e[a+1]=s[1];return e}function ln(r,e,t,i){let s=r[e]/(Math.abs(r[e])+Math.abs(r[e+1])+Math.abs(r[e+2])),o=r[e+1]/(Math.abs(r[e])+Math.abs(r[e+1])+Math.abs(r[e+2]));if(r[e+2]<0){let n=(1-Math.abs(o))*(s>=0?1:-1),a=(1-Math.abs(s))*(o>=0?1:-1);s=n,o=a}return new Int8Array([Math[t](s*127.5+(s<0?-1:0)),Math[i](o*127.5+(o<0?-1:0))])}function cn(r){let e=r[0],t=r[1];e/=e<0?127:128,t/=t<0?127:128;const i=1-Math.abs(e)-Math.abs(t);i<0&&(e=(1-Math.abs(t))*(e>=0?1:-1),t=(1-Math.abs(e))*(t>=0?1:-1));const s=Math.sqrt(e*e+t*t+i*i);return[e/s,t/s,i/s]}function hn(r,e,t){return r[e]*t[0]+r[e+1]*t[1]+r[e+2]*t[2]}function hv(r,e,t){t[0]=r[0]*e[0]+e[6],t[1]=r[1]*e[4]+e[7]}function uv(r,e,t=new Float32Array(r.length)){for(let i=0,s=r.length;i<s;i+=3)t[i+0]=r[i+0]*e[0]+e[6],t[i+1]=r[i+1]*e[4]+e[7];return t}function dv(r,e){let t=r[0],i=r[1];t=(2*t+1)/255,i=(2*i+1)/255;const s=1-Math.abs(t)-Math.abs(i);s<0&&(t=(1-Math.abs(i))*(t>=0?1:-1),i=(1-Math.abs(t))*(i>=0?1:-1));const o=Math.sqrt(t*t+i*i+s*s);return e[0]=t/o,e[1]=i/o,e[2]=s/o,e}function pv(r,e){for(let t=0,i=0,s=r.length;t<s;t+=2){let o=r[t+0],n=r[t+1];o=(2*o+1)/255,n=(2*n+1)/255;const a=1-Math.abs(o)-Math.abs(n);a<0&&(o=(1-Math.abs(n))*(o>=0?1:-1),n=(1-Math.abs(o))*(n>=0?1:-1));const A=Math.sqrt(o*o+n*n+a*a);e[i+0]=o/A,e[i+1]=n/A,e[i+2]=a/A,i+=3}return e}const st={getPositionsBounds:tv,createPositionsDecodeMatrix:iv,compressPositions:sv,compressPosition:rv,decompressPositions:av,decompressPosition:ov,decompressAABB:nv,getUVBounds:Av,compressUVs:lv,decompressUVs:uv,decompressUV:hv,compressNormals:cv,decompressNormals:pv,decompressNormal:dv},Di=vt.memory,Th=c.AABB3();class fv extends Gf{get type(){return"ReadableGeometry"}get isReadableGeometry(){return!0}constructor(e,t={}){super(e,t),this._state=new Mt({compressGeometry:!!t.compressGeometry,primitive:null,primitiveName:null,positions:null,normals:null,colors:null,uv:null,indices:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,positionsBuf:null,normalsBuf:null,colorsbuf:null,uvBuf:null,indicesBuf:null,hash:""}),this._numTriangles=0,this._edgeThreshold=t.edgeThreshold||10,this._edgeIndicesBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._aabbDirty=!0,this._boundingSphere=!0,this._aabb=null,this._aabbDirty=!0,this._obb=null,this._obbDirty=!0;const i=this._state,s=this.scene.canvas.gl;switch(t.primitive=t.primitive||"triangles",t.primitive){case"points":i.primitive=s.POINTS,i.primitiveName=t.primitive;break;case"lines":i.primitive=s.LINES,i.primitiveName=t.primitive;break;case"line-loop":i.primitive=s.LINE_LOOP,i.primitiveName=t.primitive;break;case"line-strip":i.primitive=s.LINE_STRIP,i.primitiveName=t.primitive;break;case"triangles":i.primitive=s.TRIANGLES,i.primitiveName=t.primitive;break;case"triangle-strip":i.primitive=s.TRIANGLE_STRIP,i.primitiveName=t.primitive;break;case"triangle-fan":i.primitive=s.TRIANGLE_FAN,i.primitiveName=t.primitive;break;default:this.error("Unsupported value for 'primitive': '"+t.primitive+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),i.primitive=s.TRIANGLES,i.primitiveName=t.primitive}if(t.positions)if(this._state.compressGeometry){const o=st.getPositionsBounds(t.positions),n=st.compressPositions(t.positions,o.min,o.max);i.positions=n.quantized,i.positionsDecodeMatrix=n.decodeMatrix}else i.positions=t.positions.constructor===Float32Array?t.positions:new Float32Array(t.positions);if(t.colors&&(i.colors=t.colors.constructor===Float32Array?t.colors:new Float32Array(t.colors)),t.uv)if(this._state.compressGeometry){const o=st.getUVBounds(t.uv),n=st.compressUVs(t.uv,o.min,o.max);i.uv=n.quantized,i.uvDecodeMatrix=n.decodeMatrix}else i.uv=t.uv.constructor===Float32Array?t.uv:new Float32Array(t.uv);t.normals&&(this._state.compressGeometry?i.normals=st.compressNormals(t.normals):i.normals=t.normals.constructor===Float32Array?t.normals:new Float32Array(t.normals)),t.indices&&(i.indices=t.indices.constructor===Uint32Array||t.indices.constructor===Uint16Array?t.indices:new Uint32Array(t.indices),this._state.primitiveName==="triangles"&&(this._numTriangles=t.indices.length/3)),this._buildHash(),Di.meshes++,this._buildVBOs()}_buildVBOs(){const e=this._state,t=this.scene.canvas.gl;if(e.indices&&(e.indicesBuf=new Ee(t,t.ELEMENT_ARRAY_BUFFER,e.indices,e.indices.length,1,t.STATIC_DRAW),Di.indices+=e.indicesBuf.numItems),e.positions&&(e.positionsBuf=new Ee(t,t.ARRAY_BUFFER,e.positions,e.positions.length,3,t.STATIC_DRAW),Di.positions+=e.positionsBuf.numItems),e.normals){let i=e.compressGeometry;e.normalsBuf=new Ee(t,t.ARRAY_BUFFER,e.normals,e.normals.length,3,t.STATIC_DRAW,i),Di.normals+=e.normalsBuf.numItems}e.colors&&(e.colorsBuf=new Ee(t,t.ARRAY_BUFFER,e.colors,e.colors.length,4,t.STATIC_DRAW),Di.colors+=e.colorsBuf.numItems),e.uv&&(e.uvBuf=new Ee(t,t.ARRAY_BUFFER,e.uv,e.uv.length,2,t.STATIC_DRAW),Di.uvs+=e.uvBuf.numItems)}_buildHash(){const e=this._state,t=["/g"];t.push("/"+e.primitive+";"),e.positions&&t.push("p"),e.colors&&t.push("c"),(e.normals||e.autoVertexNormals)&&t.push("n"),e.uv&&t.push("u"),e.compressGeometry&&t.push("cp"),t.push(";"),e.hash=t.join("")}_getEdgeIndices(){return this._edgeIndicesBuf||this._buildEdgeIndices(),this._edgeIndicesBuf}_getPickTrianglePositions(){return this._pickTrianglePositionsBuf||this._buildPickTriangleVBOs(),this._pickTrianglePositionsBuf}_getPickTriangleColors(){return this._pickTriangleColorsBuf||this._buildPickTriangleVBOs(),this._pickTriangleColorsBuf}_buildEdgeIndices(){const e=this._state;if(!e.positions||!e.indices)return;const t=this.scene.canvas.gl,i=us(e.positions,e.indices,e.positionsDecodeMatrix,this._edgeThreshold);this._edgeIndicesBuf=new Ee(t,t.ELEMENT_ARRAY_BUFFER,i,i.length,1,t.STATIC_DRAW),Di.indices+=this._edgeIndicesBuf.numItems}_buildPickTriangleVBOs(){const e=this._state;if(!e.positions||!e.indices)return;const t=this.scene.canvas.gl,i=c.buildPickTriangles(e.positions,e.indices,e.compressGeometry),s=i.positions,o=i.colors;this._pickTrianglePositionsBuf=new Ee(t,t.ARRAY_BUFFER,s,s.length,3,t.STATIC_DRAW),this._pickTriangleColorsBuf=new Ee(t,t.ARRAY_BUFFER,o,o.length,4,t.STATIC_DRAW,!0),Di.positions+=this._pickTrianglePositionsBuf.numItems,Di.colors+=this._pickTriangleColorsBuf.numItems}_buildPickVertexVBOs(){}_webglContextLost(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextLost()}_webglContextRestored(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextRestored(),this._buildVBOs(),this._edgeIndicesBuf=null,this._pickVertexPositionsBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._pickVertexPositionsBuf=null,this._pickVertexColorsBuf=null}get primitive(){return this._state.primitiveName}get compressGeometry(){return this._state.compressGeometry}get positions(){return this._state.positions?this._state.compressGeometry?(this._decompressedPositions||(this._decompressedPositions=new Float32Array(this._state.positions.length),st.decompressPositions(this._state.positions,this._state.positionsDecodeMatrix,this._decompressedPositions)),this._decompressedPositions):this._state.positions:null}set positions(e){const t=this._state,i=t.positions;if(!i){this.error("can't update geometry positions - geometry has no positions");return}if(i.length!==e.length){this.error("can't update geometry positions - new positions are wrong length");return}if(this._state.compressGeometry){const s=st.getPositionsBounds(e),o=st.compressPositions(e,s.min,s.max);e=o.quantized,t.positionsDecodeMatrix=o.decodeMatrix}i.set(e),t.positionsBuf&&t.positionsBuf.setData(i),this._setAABBDirty(),this.glRedraw()}get normals(){if(this._state.normals){if(!this._state.compressGeometry)return this._state.normals;if(!this._decompressedNormals){const e=this._state.normals.length,t=e+e/2;this._decompressedNormals=new Float32Array(t),st.decompressNormals(this._state.normals,this._decompressedNormals)}return this._decompressedNormals}}set normals(e){if(this._state.compressGeometry){this.error("can't update geometry normals - quantized geometry is immutable");return}const t=this._state,i=t.normals;if(!i){this.error("can't update geometry normals - geometry has no normals");return}if(i.length!==e.length){this.error("can't update geometry normals - new normals are wrong length");return}i.set(e),t.normalsBuf&&t.normalsBuf.setData(i),this.glRedraw()}get uv(){return this._state.uv?this._state.compressGeometry?(this._decompressedUV||(this._decompressedUV=new Float32Array(this._state.uv.length),st.decompressUVs(this._state.uv,this._state.uvDecodeMatrix,this._decompressedUV)),this._decompressedUV):this._state.uv:null}set uv(e){if(this._state.compressGeometry){this.error("can't update geometry UVs - quantized geometry is immutable");return}const t=this._state,i=t.uv;if(!i){this.error("can't update geometry UVs - geometry has no UVs");return}if(i.length!==e.length){this.error("can't update geometry UVs - new UVs are wrong length");return}i.set(e),t.uvBuf&&t.uvBuf.setData(i),this.glRedraw()}get colors(){return this._state.colors}set colors(e){if(this._state.compressGeometry){this.error("can't update geometry colors - quantized geometry is immutable");return}const t=this._state,i=t.colors;if(!i){this.error("can't update geometry colors - geometry has no colors");return}if(i.length!==e.length){this.error("can't update geometry colors - new colors are wrong length");return}i.set(e),t.colorsBuf&&t.colorsBuf.setData(i),this.glRedraw()}get indices(){return this._state.indices}get aabb(){return this._aabbDirty&&(this._aabb||(this._aabb=c.AABB3()),c.positions3ToAABB3(this._state.positions,this._aabb,this._state.positionsDecodeMatrix),this._aabbDirty=!1),this._aabb}get obb(){return this._obbDirty&&(this._obb||(this._obb=c.OBB3()),c.positions3ToAABB3(this._state.positions,Th,this._state.positionsDecodeMatrix),c.AABB3ToOBB3(Th,this._obb),this._obbDirty=!1),this._obb}get numTriangles(){return this._numTriangles}_setAABBDirty(){this._aabbDirty||(this._aabbDirty=!0,this._aabbDirty=!0,this._obbDirty=!0)}_getState(){return this._state}destroy(){super.destroy();const e=this._state;e.indicesBuf&&e.indicesBuf.destroy(),e.positionsBuf&&e.positionsBuf.destroy(),e.normalsBuf&&e.normalsBuf.destroy(),e.uvBuf&&e.uvBuf.destroy(),e.colorsBuf&&e.colorsBuf.destroy(),this._edgeIndicesBuf&&this._edgeIndicesBuf.destroy(),this._pickTrianglePositionsBuf&&this._pickTrianglePositionsBuf.destroy(),this._pickTriangleColorsBuf&&this._pickTriangleColorsBuf.destroy(),this._pickVertexPositionsBuf&&this._pickVertexPositionsBuf.destroy(),this._pickVertexColorsBuf&&this._pickVertexColorsBuf.destroy(),e.destroy(),Di.meshes--}}function gv(r={}){let e=r.xSize||1;e<0&&(console.error("negative xSize not allowed - will invert"),e*=-1);let t=r.ySize||1;t<0&&(console.error("negative ySize not allowed - will invert"),t*=-1);let i=r.zSize||1;i<0&&(console.error("negative zSize not allowed - will invert"),i*=-1);const s=r.center,o=s?s[0]:0,n=s?s[1]:0,a=s?s[2]:0,A=-e+o,l=-t+n,h=-i+a,d=e+o,f=t+n,m=i+a;return Se.apply(r,{positions:[d,f,m,A,f,m,A,l,m,d,l,m,d,f,m,d,l,m,d,l,h,d,f,h,d,f,m,d,f,h,A,f,h,A,f,m,A,f,m,A,f,h,A,l,h,A,l,m,A,l,h,d,l,h,d,l,m,A,l,m,d,l,h,A,l,h,A,f,h,d,f,h],normals:[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],uv:[1,0,0,0,0,1,1,1,0,0,0,1,1,1,1,0,1,1,1,0,0,0,0,1,1,0,0,0,0,1,1,1,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]})}class ko extends It{get type(){return"Material"}constructor(e,t={}){super(e,t),vt.memory.materials++}destroy(){super.destroy(),vt.memory.materials--}}const mv={opaque:0,mask:1,blend:2},_v=["opaque","mask","blend"];class jf extends ko{get type(){return"PhongMaterial"}constructor(e,t={}){super(e,t),this._state=new Mt({type:"PhongMaterial",ambient:c.vec3([1,1,1]),diffuse:c.vec3([1,1,1]),specular:c.vec3([1,1,1]),emissive:c.vec3([0,0,0]),alpha:null,shininess:null,reflectivity:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this.ambient=t.ambient,this.diffuse=t.diffuse,this.specular=t.specular,this.emissive=t.emissive,this.alpha=t.alpha,this.shininess=t.shininess,this.reflectivity=t.reflectivity,this.lineWidth=t.lineWidth,this.pointSize=t.pointSize,t.ambientMap&&(this._ambientMap=this._checkComponent("Texture",t.ambientMap)),t.diffuseMap&&(this._diffuseMap=this._checkComponent("Texture",t.diffuseMap)),t.specularMap&&(this._specularMap=this._checkComponent("Texture",t.specularMap)),t.emissiveMap&&(this._emissiveMap=this._checkComponent("Texture",t.emissiveMap)),t.alphaMap&&(this._alphaMap=this._checkComponent("Texture",t.alphaMap)),t.reflectivityMap&&(this._reflectivityMap=this._checkComponent("Texture",t.reflectivityMap)),t.normalMap&&(this._normalMap=this._checkComponent("Texture",t.normalMap)),t.occlusionMap&&(this._occlusionMap=this._checkComponent("Texture",t.occlusionMap)),t.diffuseFresnel&&(this._diffuseFresnel=this._checkComponent("Fresnel",t.diffuseFresnel)),t.specularFresnel&&(this._specularFresnel=this._checkComponent("Fresnel",t.specularFresnel)),t.emissiveFresnel&&(this._emissiveFresnel=this._checkComponent("Fresnel",t.emissiveFresnel)),t.alphaFresnel&&(this._alphaFresnel=this._checkComponent("Fresnel",t.alphaFresnel)),t.reflectivityFresnel&&(this._reflectivityFresnel=this._checkComponent("Fresnel",t.reflectivityFresnel)),this.alphaMode=t.alphaMode,this.alphaCutoff=t.alphaCutoff,this.backfaces=t.backfaces,this.frontface=t.frontface,this._makeHash()}_makeHash(){const e=this._state,t=["/p"];this._normalMap&&(t.push("/nm"),this._normalMap.hasMatrix&&t.push("/mat")),this._ambientMap&&(t.push("/am"),this._ambientMap.hasMatrix&&t.push("/mat"),t.push("/"+this._ambientMap.encoding)),this._diffuseMap&&(t.push("/dm"),this._diffuseMap.hasMatrix&&t.push("/mat"),t.push("/"+this._diffuseMap.encoding)),this._specularMap&&(t.push("/sm"),this._specularMap.hasMatrix&&t.push("/mat")),this._emissiveMap&&(t.push("/em"),this._emissiveMap.hasMatrix&&t.push("/mat"),t.push("/"+this._emissiveMap.encoding)),this._alphaMap&&(t.push("/opm"),this._alphaMap.hasMatrix&&t.push("/mat")),this._reflectivityMap&&(t.push("/rm"),this._reflectivityMap.hasMatrix&&t.push("/mat")),this._occlusionMap&&(t.push("/ocm"),this._occlusionMap.hasMatrix&&t.push("/mat")),this._diffuseFresnel&&t.push("/df"),this._specularFresnel&&t.push("/sf"),this._emissiveFresnel&&t.push("/ef"),this._alphaFresnel&&t.push("/of"),this._reflectivityFresnel&&t.push("/rf"),t.push(";"),e.hash=t.join("")}set ambient(e){let t=this._state.ambient;if(!t)t=this._state.ambient=new Float32Array(3);else if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return;e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this.glRedraw()}get ambient(){return this._state.ambient}set diffuse(e){let t=this._state.diffuse;if(!t)t=this._state.diffuse=new Float32Array(3);else if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return;e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this.glRedraw()}get diffuse(){return this._state.diffuse}set specular(e){let t=this._state.specular;if(!t)t=this._state.specular=new Float32Array(3);else if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return;e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this.glRedraw()}get specular(){return this._state.specular}set emissive(e){let t=this._state.emissive;if(!t)t=this._state.emissive=new Float32Array(3);else if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return;e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=0,t[1]=0,t[2]=0),this.glRedraw()}get emissive(){return this._state.emissive}set alpha(e){e=e??1,this._state.alpha!==e&&(this._state.alpha=e,this.glRedraw())}get alpha(){return this._state.alpha}set shininess(e){this._state.shininess=e!==void 0?e:80,this.glRedraw()}get shininess(){return this._state.shininess}set lineWidth(e){this._state.lineWidth=e||1,this.glRedraw()}get lineWidth(){return this._state.lineWidth}set pointSize(e){this._state.pointSize=e||1,this.glRedraw()}get pointSize(){return this._state.pointSize}set reflectivity(e){this._state.reflectivity=e!==void 0?e:1,this.glRedraw()}get reflectivity(){return this._state.reflectivity}get normalMap(){return this._normalMap}get ambientMap(){return this._ambientMap}get diffuseMap(){return this._diffuseMap}get specularMap(){return this._specularMap}get emissiveMap(){return this._emissiveMap}get alphaMap(){return this._alphaMap}get reflectivityMap(){return this._reflectivityMap}get occlusionMap(){return this._occlusionMap}get diffuseFresnel(){return this._diffuseFresnel}get specularFresnel(){return this._specularFresnel}get emissiveFresnel(){return this._emissiveFresnel}get alphaFresnel(){return this._alphaFresnel}get reflectivityFresnel(){return this._reflectivityFresnel}set alphaMode(e){e=e||"opaque";let t=mv[e];t===void 0&&(this.error("Unsupported value for 'alphaMode': "+e+" - defaulting to 'opaque'"),t="opaque"),this._state.alphaMode!==t&&(this._state.alphaMode=t,this.glRedraw())}get alphaMode(){return _v[this._state.alphaMode]}set alphaCutoff(e){e==null&&(e=.5),this._state.alphaCutoff!==e&&(this._state.alphaCutoff=e)}get alphaCutoff(){return this._state.alphaCutoff}set backfaces(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this.glRedraw())}get backfaces(){return this._state.backfaces}set frontface(e){e=e!=="cw",this._state.frontface!==e&&(this._state.frontface=e,this.glRedraw())}get frontface(){return this._state.frontface?"ccw":"cw"}destroy(){super.destroy(),this._state.destroy()}}const rA={default:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1},defaultWhiteBG:{fill:!0,fillColor:[1,1,1],fillAlpha:.6,edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1},defaultDarkBG:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.5,.5,.5],edgeAlpha:.5,edgeWidth:1},phosphorous:{fill:!0,fillColor:[0,0,0],fillAlpha:.4,edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:2},sunset:{fill:!0,fillColor:[.9,.9,.6],fillAlpha:.2,edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:1},vectorscope:{fill:!0,fillColor:[0,0,0],fillAlpha:.7,edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:2},battlezone:{fill:!0,fillColor:[0,0,0],fillAlpha:1,edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:3},sepia:{fill:!0,fillColor:[.970588207244873,.7965892553329468,.6660899519920349],fillAlpha:.4,edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1},yellowHighlight:{fill:!0,fillColor:[1,1,0],fillAlpha:.5,edges:!0,edgeColor:[1,1,1],edgeAlpha:1,edgeWidth:1},greenSelected:{fill:!0,fillColor:[0,1,0],fillAlpha:.5,edges:!0,edgeColor:[1,1,1],edgeAlpha:1,edgeWidth:1},gamegrid:{fill:!0,fillColor:[.2,.2,.7],fillAlpha:.9,edges:!0,edgeColor:[.4,.4,1.6],edgeAlpha:.8,edgeWidth:3}};class oA extends ko{get type(){return"EmphasisMaterial"}get presets(){return rA}constructor(e,t={}){super(e,t),this._state=new Mt({type:"EmphasisMaterial",fill:null,fillColor:null,fillAlpha:null,edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null,backfaces:!0,glowThrough:!0}),this._preset="default",t.preset?(this.preset=t.preset,t.fill!==void 0&&(this.fill=t.fill),t.fillColor&&(this.fillColor=t.fillColor),t.fillAlpha!==void 0&&(this.fillAlpha=t.fillAlpha),t.edges!==void 0&&(this.edges=t.edges),t.edgeColor&&(this.edgeColor=t.edgeColor),t.edgeAlpha!==void 0&&(this.edgeAlpha=t.edgeAlpha),t.edgeWidth!==void 0&&(this.edgeWidth=t.edgeWidth),t.backfaces!==void 0&&(this.backfaces=t.backfaces),t.glowThrough!==void 0&&(this.glowThrough=t.glowThrough)):(this.fill=t.fill,this.fillColor=t.fillColor,this.fillAlpha=t.fillAlpha,this.edges=t.edges,this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth,this.backfaces=t.backfaces,this.glowThrough=t.glowThrough)}set fill(e){e=e!==!1,this._state.fill!==e&&(this._state.fill=e,this.glRedraw())}get fill(){return this._state.fill}set fillColor(e){let t=this._state.fillColor;if(!t)t=this._state.fillColor=new Float32Array(3);else if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return;e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.4,t[1]=.4,t[2]=.4),this.glRedraw()}get fillColor(){return this._state.fillColor}set fillAlpha(e){e=e??.2,this._state.fillAlpha!==e&&(this._state.fillAlpha=e,this.glRedraw())}get fillAlpha(){return this._state.fillAlpha}set edges(e){e=e!==!1,this._state.edges!==e&&(this._state.edges=e,this.glRedraw())}get edges(){return this._state.edges}set edgeColor(e){let t=this._state.edgeColor;if(!t)t=this._state.edgeColor=new Float32Array(3);else if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return;e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this.glRedraw()}get edgeColor(){return this._state.edgeColor}set edgeAlpha(e){e=e??.5,this._state.edgeAlpha!==e&&(this._state.edgeAlpha=e,this.glRedraw())}get edgeAlpha(){return this._state.edgeAlpha}set edgeWidth(e){this._state.edgeWidth=e||1,this.glRedraw()}get edgeWidth(){return this._state.edgeWidth}set backfaces(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this.glRedraw())}get backfaces(){return this._state.backfaces}set glowThrough(e){e=e!==!1,this._state.glowThrough!==e&&(this._state.glowThrough=e,this.glRedraw())}get glowThrough(){return this._state.glowThrough}set preset(e){if(e=e||"default",this._preset===e)return;const t=rA[e];if(!t){this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(rA).join(", "));return}this.fill=t.fill,this.fillColor=t.fillColor,this.fillAlpha=t.fillAlpha,this.edges=t.edges,this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth,this.glowThrough=t.glowThrough,this._preset=e}get preset(){return this._preset}destroy(){super.destroy(),this._state.destroy()}}const nA={default:{edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1},defaultWhiteBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultDarkBG:{edgeColor:[.5,.5,.5],edgeAlpha:1,edgeWidth:1}};class vv extends ko{get type(){return"EdgeMaterial"}get presets(){return nA}constructor(e,t={}){super(e,t),this._state=new Mt({type:"EdgeMaterial",edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null}),this._preset="default",t.preset?(this.preset=t.preset,t.edgeColor&&(this.edgeColor=t.edgeColor),t.edgeAlpha!==void 0&&(this.edgeAlpha=t.edgeAlpha),t.edgeWidth!==void 0&&(this.edgeWidth=t.edgeWidth)):(this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth),this.edges=t.edges!==!1}set edges(e){e=e!==!1,this._state.edges!==e&&(this._state.edges=e,this.glRedraw())}get edges(){return this._state.edges}set edgeColor(e){let t=this._state.edgeColor;if(!t)t=this._state.edgeColor=new Float32Array(3);else if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return;e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this.glRedraw()}get edgeColor(){return this._state.edgeColor}set edgeAlpha(e){e=e??1,this._state.edgeAlpha!==e&&(this._state.edgeAlpha=e,this.glRedraw())}get edgeAlpha(){return this._state.edgeAlpha}set edgeWidth(e){this._state.edgeWidth=e||1,this.glRedraw()}get edgeWidth(){return this._state.edgeWidth}set preset(e){if(e=e||"default",this._preset===e)return;const t=nA[e];if(!t){this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(nA).join(", "));return}this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth,this._preset=e}get preset(){return this._preset}destroy(){super.destroy(),this._state.destroy()}}const Dh={meters:{abbrev:"m"},metres:{abbrev:"m"},centimeters:{abbrev:"cm"},centimetres:{abbrev:"cm"},millimeters:{abbrev:"mm"},millimetres:{abbrev:"mm"},yards:{abbrev:"yd"},feet:{abbrev:"ft"},inches:{abbrev:"in"}};class Bv extends It{constructor(e,t={}){super(e,t),this._units="meters",this._scale=1,this._origin=c.vec3([0,0,0]),this.units=t.units,this.scale=t.scale,this.origin=t.origin}get unitsInfo(){return Dh}set units(e){e||(e="meters"),Dh[e]||(this.error("Unsupported value for 'units': "+e+" defaulting to 'meters'"),e="meters"),this._units=e,this.fire("units",this._units)}get units(){return this._units}set scale(e){if(e=e||1,e<=0){this.error("scale value should be larger than zero");return}this._scale=e,this.fire("scale",this._scale)}get scale(){return this._scale}set origin(e){if(!e){this._origin[0]=0,this._origin[1]=0,this._origin[2]=0;return}this._origin[0]=e[0],this._origin[1]=e[1],this._origin[2]=e[2],this.fire("origin",this._origin)}get origin(){return this._origin}worldToRealPos(e,t=c.vec3(3)){t[0]=this._origin[0]+this._scale*e[0],t[1]=this._origin[1]+this._scale*e[1],t[2]=this._origin[2]+this._scale*e[2]}realToWorldPos(e,t=c.vec3(3)){return t[0]=(e[0]-this._origin[0])/this._scale,t[1]=(e[1]-this._origin[1])/this._scale,t[2]=(e[2]-this._origin[2])/this._scale,t}}class Pv extends It{constructor(e,t={}){super(e,t),this._supported=_t.SUPPORTED_EXTENSIONS.OES_standard_derivatives,this.enabled=t.enabled,this.kernelRadius=t.kernelRadius,this.intensity=t.intensity,this.bias=t.bias,this.scale=t.scale,this.minResolution=t.minResolution,this.numSamples=t.numSamples,this.blur=t.blur,this.blendCutoff=t.blendCutoff,this.blendFactor=t.blendFactor}get supported(){return this._supported}set enabled(e){e=!!e,this._enabled!==e&&(this._enabled=e,this.glRedraw())}get enabled(){return this._enabled}get possible(){if(!this._supported||!this._enabled)return!1;const e=this.scene.camera.projection;return!(e==="customProjection"||e==="frustum")}get active(){return this._active}set kernelRadius(e){e==null&&(e=100),this._kernelRadius!==e&&(this._kernelRadius=e,this.glRedraw())}get kernelRadius(){return this._kernelRadius}set intensity(e){e==null&&(e=.15),this._intensity!==e&&(this._intensity=e,this.glRedraw())}get intensity(){return this._intensity}set bias(e){e==null&&(e=.5),this._bias!==e&&(this._bias=e,this.glRedraw())}get bias(){return this._bias}set scale(e){e==null&&(e=1),this._scale!==e&&(this._scale=e,this.glRedraw())}get scale(){return this._scale}set minResolution(e){e==null&&(e=0),this._minResolution!==e&&(this._minResolution=e,this.glRedraw())}get minResolution(){return this._minResolution}set numSamples(e){e==null&&(e=10),this._numSamples!==e&&(this._numSamples=e,this.glRedraw())}get numSamples(){return this._numSamples}set blur(e){e=e!==!1,this._blur!==e&&(this._blur=e,this.glRedraw())}get blur(){return this._blur}set blendCutoff(e){e==null&&(e=.3),this._blendCutoff!==e&&(this._blendCutoff=e,this.glRedraw())}get blendCutoff(){return this._blendCutoff}set blendFactor(e){e==null&&(e=1),this._blendFactor!==e&&(this._blendFactor=e,this.glRedraw())}get blendFactor(){return this._blendFactor}destroy(){super.destroy()}}class yv extends It{constructor(e,t={}){super(e,t),this.sliceColor=t.sliceColor,this.sliceThickness=t.sliceThickness}set sliceThickness(e){e==null&&(e=0),this._sliceThickness!==e&&(this._sliceThickness=e,this.glRedraw())}get sliceThickness(){return this._sliceThickness}set sliceColor(e){e==null&&(e=[0,0,0,1]),this._sliceColor!==e&&(this._sliceColor=e,this.glRedraw())}get sliceColor(){return this._sliceColor}destroy(){super.destroy()}}const aA={default:{pointSize:4,roundPoints:!0,perspectivePoints:!0},square:{pointSize:4,roundPoints:!1,perspectivePoints:!0},round:{pointSize:4,roundPoints:!0,perspectivePoints:!0}};class xv extends ko{get type(){return"PointsMaterial"}get presets(){return aA}constructor(e,t={}){super(e,t),this._state=new Mt({type:"PointsMaterial",pointSize:null,roundPoints:null,perspectivePoints:null,minPerspectivePointSize:null,maxPerspectivePointSize:null,filterIntensity:null,minIntensity:null,maxIntensity:null}),t.preset?(this.preset=t.preset,t.pointSize!==void 0&&(this.pointSize=t.pointSize),t.roundPoints!==void 0&&(this.roundPoints=t.roundPoints),t.perspectivePoints!==void 0&&(this.perspectivePoints=t.perspectivePoints),t.minPerspectivePointSize!==void 0&&(this.minPerspectivePointSize=t.minPerspectivePointSize),t.maxPerspectivePointSize!==void 0&&(this.maxPerspectivePointSize=t.minPerspectivePointSize)):(this._preset="default",this.pointSize=t.pointSize,this.roundPoints=t.roundPoints,this.perspectivePoints=t.perspectivePoints,this.minPerspectivePointSize=t.minPerspectivePointSize,this.maxPerspectivePointSize=t.maxPerspectivePointSize),this.filterIntensity=t.filterIntensity,this.minIntensity=t.minIntensity,this.maxIntensity=t.maxIntensity}set pointSize(e){this._state.pointSize=e||2,this.glRedraw()}get pointSize(){return this._state.pointSize}set roundPoints(e){e=e!==!1,this._state.roundPoints!==e&&(this._state.roundPoints=e,this.scene._needRecompile=!0,this.glRedraw())}get roundPoints(){return this._state.roundPoints}set perspectivePoints(e){e=e!==!1,this._state.perspectivePoints!==e&&(this._state.perspectivePoints=e,this.scene._needRecompile=!0,this.glRedraw())}get perspectivePoints(){return this._state.perspectivePoints}set minPerspectivePointSize(e){this._state.minPerspectivePointSize=e||1,this.scene._needRecompile=!0,this.glRedraw()}get minPerspectivePointSize(){return this._state.minPerspectivePointSize}set maxPerspectivePointSize(e){this._state.maxPerspectivePointSize=e||6,this.scene._needRecompile=!0,this.glRedraw()}get maxPerspectivePointSize(){return this._state.maxPerspectivePointSize}set filterIntensity(e){e=e!==!1,this._state.filterIntensity!==e&&(this._state.filterIntensity=e,this.scene._needRecompile=!0,this.glRedraw())}get filterIntensity(){return this._state.filterIntensity}set minIntensity(e){this._state.minIntensity=e??0,this.glRedraw()}get minIntensity(){return this._state.minIntensity}set maxIntensity(e){this._state.maxIntensity=e??1,this.glRedraw()}get maxIntensity(){return this._state.maxIntensity}set preset(e){if(e=e||"default",this._preset===e)return;const t=aA[e];if(!t){this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(aA).join(", "));return}this.pointSize=t.pointSize,this.roundPoints=t.roundPoints,this.perspectivePoints=t.perspectivePoints,this.minPerspectivePointSize=t.minPerspectivePointSize,this.maxPerspectivePointSize=t.maxPerspectivePointSize,this._preset=e}get preset(){return this._preset}get hash(){return[this.pointSize,this.roundPoints,this.perspectivePoints,this.minPerspectivePointSize,this.maxPerspectivePointSize,this.filterIntensity].join(";")}destroy(){super.destroy(),this._state.destroy()}}const AA={default:{lineWidth:1},thick:{lineWidth:2},thicker:{lineWidth:4}};class wv extends ko{get type(){return"LinesMaterial"}get presets(){return AA}constructor(e,t={}){super(e,t),this._state=new Mt({type:"LinesMaterial",lineWidth:null}),t.preset?(this.preset=t.preset,t.lineWidth!==void 0&&(this.lineWidth=t.lineWidth)):(this._preset="default",this.lineWidth=t.lineWidth)}set lineWidth(e){this._state.lineWidth=e||1,this.glRedraw()}get lineWidth(){return this._state.lineWidth}set preset(e){if(e=e||"default",this._preset===e)return;const t=AA[e];if(!t){this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(AA).join(", "));return}this.lineWidth=t.lineWidth,this._preset=e}get preset(){return this._preset}get hash(){return[""+this.lineWidth].join(";")}destroy(){super.destroy(),this._state.destroy()}}function Rh(r,e){const t={};let i,s;for(let o=0,n=e.length;o<n;o++){if(i=e[o],s=r.components[i],!s){r.warn("pick(): Component not found: "+i);continue}if(!s.isEntity){r.warn("pick(): Component is not an Entity: "+i);continue}t[i]=!0}return t}class bv extends It{get type(){return"Scene"}constructor(e,t={}){super(null,t);const i=t.canvasElement||document.getElementById(t.canvasId);if(!(i instanceof HTMLCanvasElement))throw"Mandatory config expected: valid canvasId or canvasElement";this._tickifiedFunctions={};const s=!!t.transparent,o=!!t.alphaDepthMask;this._aabbDirty=!0,this.viewer=e,this.occlusionTestCountdown=0,this.loading=0,this.startTime=new Date().getTime(),this.models={},this.objects={},this._numObjects=0,this.visibleObjects={},this._numVisibleObjects=0,this.xrayedObjects={},this._numXRayedObjects=0,this.highlightedObjects={},this._numHighlightedObjects=0,this.selectedObjects={},this._numSelectedObjects=0,this.colorizedObjects={},this._numColorizedObjects=0,this.opacityObjects={},this._numOpacityObjects=0,this.offsetObjects={},this._numOffsetObjects=0,this._modelIds=null,this._objectIds=null,this._visibleObjectIds=null,this._xrayedObjectIds=null,this._highlightedObjectIds=null,this._selectedObjectIds=null,this._colorizedObjectIds=null,this._opacityObjectIds=null,this._offsetObjectIds=null,this._collidables={},this._compilables={},this._needRecompile=!1,this.types={},this.components={},this.sectionPlanes={},this.lights={},this.lightMaps={},this.reflectionMaps={},this.bitmaps={},this.lineSets={},this.realWorldOffset=t.realWorldOffset||new Float64Array([0,0,0]),this.canvas=new C0(this,{dontClear:!0,canvas:i,spinnerElementId:t.spinnerElementId,transparent:s,webgl2:t.webgl2!==!1,contextAttr:t.contextAttr||{},backgroundColor:t.backgroundColor,backgroundColorFromAmbientLight:t.backgroundColorFromAmbientLight,premultipliedAlpha:t.premultipliedAlpha}),this.canvas.on("boundary",()=>{this.glRedraw()}),this.canvas.on("webglContextFailed",()=>{alert("xeokit failed to find WebGL!")}),this._renderer=new G0(this,{transparent:s,alphaDepthMask:o}),this._sectionPlanesState=new function(){this.sectionPlanes=[],this.clippingCaps=!1,this._numCachedSectionPlanes=0;let n=null;this.getHash=function(){if(n)return n;const a=this.getNumAllocatedSectionPlanes();if(this.sectionPlanes,a===0)return this.hash=";";const A=[];for(let l=0,h=a;l<h;l++)A.push("cp");return A.push(";"),n=A.join(""),n},this.addSectionPlane=function(a){this.sectionPlanes.push(a),n=null},this.removeSectionPlane=function(a){for(let A=0,l=this.sectionPlanes.length;A<l;A++)if(this.sectionPlanes[A].id===a.id){this.sectionPlanes.splice(A,1),n=null;return}},this.setNumCachedSectionPlanes=function(a){this._numCachedSectionPlanes=a,n=null},this.getNumCachedSectionPlanes=function(){return this._numCachedSectionPlanes},this.getNumAllocatedSectionPlanes=function(){const a=this.sectionPlanes.length;return a>this._numCachedSectionPlanes?a:this._numCachedSectionPlanes}},this._sectionPlanesState.setNumCachedSectionPlanes(t.numCachedSectionPlanes||0),this._lightsState=new function(){const n=c.vec4([0,0,0,0]),a=c.vec4();this.lights=[],this.reflectionMaps=[],this.lightMaps=[];let A=null,l=null;this.getHash=function(){if(A)return A;const h=[],d=this.lights;let f;for(let m=0,_=d.length;m<_;m++)f=d[m],h.push("/"),h.push(f.type),h.push(f.space==="world"?"w":"v"),f.castsShadow&&h.push("sh");return this.lightMaps.length>0&&h.push("/lm"),this.reflectionMaps.length>0&&h.push("/rm"),h.push(";"),A=h.join(""),A},this.addLight=function(h){this.lights.push(h),l=null,A=null},this.removeLight=function(h){for(let d=0,f=this.lights.length;d<f;d++)if(this.lights[d].id===h.id){this.lights.splice(d,1),l&&l.id===h.id&&(l=null),A=null;return}},this.addReflectionMap=function(h){this.reflectionMaps.push(h),A=null},this.removeReflectionMap=function(h){for(let d=0,f=this.reflectionMaps.length;d<f;d++)if(this.reflectionMaps[d].id===h.id){this.reflectionMaps.splice(d,1),A=null;return}},this.addLightMap=function(h){this.lightMaps.push(h),A=null},this.removeLightMap=function(h){for(let d=0,f=this.lightMaps.length;d<f;d++)if(this.lightMaps[d].id===h.id){this.lightMaps.splice(d,1),A=null;return}},this.getAmbientColorAndIntensity=function(){if(!l)for(let h=0,d=this.lights.length;h<d;h++){const f=this.lights[h];if(f.type==="ambient"){l=f;break}}if(l){const h=l.color,d=l.intensity;return a[0]=h[0],a[1]=h[1],a[2]=h[2],a[3]=d,a}else return n}},this.input=new j0(this,{dontClear:!0,element:this.canvas.canvas,keyboardEventsElement:t.keyboardEventsElement}),this.metrics=new Bv(this,{units:t.units,scale:t.scale,origin:t.origin}),this.sao=new Pv(this,{enabled:t.saoEnabled}),this.crossSections=new yv(this,{}),this.ticksPerRender=t.ticksPerRender,this.ticksPerOcclusionTest=t.ticksPerOcclusionTest,this.passes=t.passes,this.clearEachPass=t.clearEachPass,this.gammaInput=t.gammaInput,this.gammaOutput=t.gammaOutput,this.gammaFactor=t.gammaFactor,this._entityOffsetsEnabled=!!t.entityOffsetsEnabled,this._logarithmicDepthBufferEnabled=!!t.logarithmicDepthBufferEnabled,this._dtxEnabled=t.dtxEnabled!==!1,this._pbrEnabled=!!t.pbrEnabled,this._colorTextureEnabled=t.colorTextureEnabled!==!1,this._dtxEnabled=!!t.dtxEnabled,Bt._addScene(this),this._initDefaults(),this._viewport=new z0(this,{id:"default.viewport",autoBoundary:!0,dontClear:!0}),this._camera=new $0(this,{id:"default.camera",dontClear:!0}),new ev(this,{color:[1,1,1],intensity:.7}),new Sh(this,{dir:[.8,-.5,-.5],color:[.67,.67,1],intensity:.7,space:"world"}),new Sh(this,{dir:[-.8,-1,.5],color:[1,1,.9],intensity:.9,space:"world"}),this._camera.on("dirty",()=>{this._renderer.imageDirty()})}_initDefaults(){}_addComponent(e){if(e.id&&this.components[e.id]&&(this.error("Component "+Se.inQuotes(e.id)+" already exists in Scene - ignoring ID, will randomly-generate instead"),e.id=null),!e.id)for(window.nextID===void 0&&(window.nextID=0),e.id="__"+window.nextID++;this.components[e.id];)e.id=c.createUUID();this.components[e.id]=e;const t=e.type;let i=this.types[e.type];i||(i=this.types[t]={}),i[e.id]=e,e.compile&&(this._compilables[e.id]=e),e.isDrawable&&(this._renderer.addDrawable(e.id,e),this._collidables[e.id]=e)}_removeComponent(e){var t=e.id,i=e.type;delete this.components[t];const s=this.types[i];s&&(delete s[t],Se.isEmptyObject(s)&&delete this.types[i]),e.compile&&delete this._compilables[e.id],e.isDrawable&&(this._renderer.removeDrawable(e.id),delete this._collidables[e.id])}_sectionPlaneCreated(e){this.sectionPlanes[e.id]=e,this.scene._sectionPlanesState.addSectionPlane(e._state),this.scene.fire("sectionPlaneCreated",e,!0),this._needRecompile=!0}_bitmapCreated(e){this.bitmaps[e.id]=e,this.scene.fire("bitmapCreated",e,!0)}_lineSetCreated(e){this.lineSets[e.id]=e,this.scene.fire("lineSetCreated",e,!0)}_lightCreated(e){this.lights[e.id]=e,this.scene._lightsState.addLight(e._state),this._needRecompile=!0}_lightMapCreated(e){this.lightMaps[e.id]=e,this.scene._lightsState.addLightMap(e._state),this._needRecompile=!0}_reflectionMapCreated(e){this.reflectionMaps[e.id]=e,this.scene._lightsState.addReflectionMap(e._state),this._needRecompile=!0}_sectionPlaneDestroyed(e){delete this.sectionPlanes[e.id],this.scene._sectionPlanesState.removeSectionPlane(e._state),this.scene.fire("sectionPlaneDestroyed",e,!0),this._needRecompile=!0}_bitmapDestroyed(e){delete this.bitmaps[e.id],this.scene.fire("bitmapDestroyed",e,!0)}_lineSetDestroyed(e){delete this.lineSets[e.id],this.scene.fire("lineSetDestroyed",e,!0)}_lightDestroyed(e){delete this.lights[e.id],this.scene._lightsState.removeLight(e._state),this._needRecompile=!0}_lightMapDestroyed(e){delete this.lightMaps[e.id],this.scene._lightsState.removeLightMap(e._state),this._needRecompile=!0}_reflectionMapDestroyed(e){delete this.reflectionMaps[e.id],this.scene._lightsState.removeReflectionMap(e._state),this._needRecompile=!0}_registerModel(e){this.models[e.id]=e,this._modelIds=null}_deregisterModel(e){const t=e.id;delete this.models[t],this._modelIds=null,this.fire("modelUnloaded",t)}_registerObject(e){this.objects[e.id]=e,this._numObjects++,this._objectIds=null}_deregisterObject(e){delete this.objects[e.id],this._numObjects--,this._objectIds=null}_objectVisibilityUpdated(e,t=!0){e.visible?(this.visibleObjects[e.id]=e,this._numVisibleObjects++):(delete this.visibleObjects[e.id],this._numVisibleObjects--),this._visibleObjectIds=null,t&&this.fire("objectVisibility",e,!0)}_deRegisterVisibleObject(e){delete this.visibleObjects[e.id],this._numVisibleObjects--,this._visibleObjectIds=null}_objectXRayedUpdated(e,t=!0){e.xrayed?(this.xrayedObjects[e.id]=e,this._numXRayedObjects++):(delete this.xrayedObjects[e.id],this._numXRayedObjects--),this._xrayedObjectIds=null,t&&this.fire("objectXRayed",e,!0)}_deRegisterXRayedObject(e){delete this.xrayedObjects[e.id],this._numXRayedObjects--,this._xrayedObjectIds=null}_objectHighlightedUpdated(e){e.highlighted?(this.highlightedObjects[e.id]=e,this._numHighlightedObjects++):(delete this.highlightedObjects[e.id],this._numHighlightedObjects--),this._highlightedObjectIds=null}_deRegisterHighlightedObject(e){delete this.highlightedObjects[e.id],this._numHighlightedObjects--,this._highlightedObjectIds=null}_objectSelectedUpdated(e,t=!0){e.selected?(this.selectedObjects[e.id]=e,this._numSelectedObjects++):(delete this.selectedObjects[e.id],this._numSelectedObjects--),this._selectedObjectIds=null,t&&this.fire("objectSelected",e,!0)}_deRegisterSelectedObject(e){delete this.selectedObjects[e.id],this._numSelectedObjects--,this._selectedObjectIds=null}_objectColorizeUpdated(e,t){t?(this.colorizedObjects[e.id]=e,this._numColorizedObjects++):(delete this.colorizedObjects[e.id],this._numColorizedObjects--),this._colorizedObjectIds=null}_deRegisterColorizedObject(e){delete this.colorizedObjects[e.id],this._numColorizedObjects--,this._colorizedObjectIds=null}_objectOpacityUpdated(e,t){t?(this.opacityObjects[e.id]=e,this._numOpacityObjects++):(delete this.opacityObjects[e.id],this._numOpacityObjects--),this._opacityObjectIds=null}_deRegisterOpacityObject(e){delete this.opacityObjects[e.id],this._numOpacityObjects--,this._opacityObjectIds=null}_objectOffsetUpdated(e,t){!t||t[0]===0&&t[1]===0&&t[2]===0?(this.offsetObjects[e.id]=e,this._numOffsetObjects++):(delete this.offsetObjects[e.id],this._numOffsetObjects--),this._offsetObjectIds=null}_deRegisterOffsetObject(e){delete this.offsetObjects[e.id],this._numOffsetObjects--,this._offsetObjectIds=null}_webglContextLost(){this.canvas.spinner.processes++;for(const e in this.components)if(this.components.hasOwnProperty(e)){const t=this.components[e];t._webglContextLost&&t._webglContextLost()}this._renderer.webglContextLost()}_webglContextRestored(){const e=this.canvas.gl;for(const t in this.components)if(this.components.hasOwnProperty(t)){const i=this.components[t];i._webglContextRestored&&i._webglContextRestored(e)}this._renderer.webglContextRestored(e),this.canvas.spinner.processes--}get capabilities(){return this._renderer.capabilities}get entityOffsetsEnabled(){return this._entityOffsetsEnabled}get pickSurfacePrecisionEnabled(){return!1}get logarithmicDepthBufferEnabled(){return this._logarithmicDepthBufferEnabled}set numCachedSectionPlanes(e){e=e||0,this._sectionPlanesState.getNumCachedSectionPlanes()!==e&&(this._sectionPlanesState.setNumCachedSectionPlanes(e),this._needRecompile=!0,this.glRedraw())}get numCachedSectionPlanes(){return this._sectionPlanesState.getNumCachedSectionPlanes()}set pbrEnabled(e){this._pbrEnabled=!!e,this.glRedraw()}get pbrEnabled(){return this._pbrEnabled}set dtxEnabled(e){e=!!e,this._dtxEnabled!==e&&(this._dtxEnabled=e)}get dtxEnabled(){return this._dtxEnabled}set colorTextureEnabled(e){this._colorTextureEnabled=!!e,this.glRedraw()}get colorTextureEnabled(){return this._colorTextureEnabled}doOcclusionTest(){this._needRecompile&&(this._recompile(),this._needRecompile=!1),this._renderer.doOcclusionTest()}render(e){e&&Bt.runTasks();const t={sceneId:null,pass:0};if(this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1),!e&&!this._renderer.needsRender())return;t.sceneId=this.id;const i=this._passes,s=this._clearEachPass;let o,n;for(o=0;o<i;o++)t.pass=o,this.fire("rendering",t,!0),n=s||o===0,this._renderer.render({pass:o,clear:n,force:e}),this.fire("rendered",t,!0);this._saveAmbientColor()}compile(){this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1)}_recompile(){for(const e in this._compilables)this._compilables.hasOwnProperty(e)&&this._compilables[e].compile();this._renderer.shadowsDirty(),this.fire("compile",this,!0)}_saveAmbientColor(){const e=this.canvas;if(!e.transparent&&!e.backgroundImage&&!e.backgroundColor){const t=this._lightsState.getAmbientColorAndIntensity();(!this._lastAmbientColor||this._lastAmbientColor[0]!==t[0]||this._lastAmbientColor[1]!==t[1]||this._lastAmbientColor[2]!==t[2]||this._lastAmbientColor[3]!==t[3])&&(e.backgroundColor=t,this._lastAmbientColor||(this._lastAmbientColor=c.vec4([0,0,0,1])),this._lastAmbientColor.set(t))}else this._lastAmbientColor=null}get modelIds(){return this._modelIds||(this._modelIds=Object.keys(this.models)),this._modelIds}get numObjects(){return this._numObjects}get objectIds(){return this._objectIds||(this._objectIds=Object.keys(this.objects)),this._objectIds}get numVisibleObjects(){return this._numVisibleObjects}get visibleObjectIds(){return this._visibleObjectIds||(this._visibleObjectIds=Object.keys(this.visibleObjects)),this._visibleObjectIds}get numXRayedObjects(){return this._numXRayedObjects}get xrayedObjectIds(){return this._xrayedObjectIds||(this._xrayedObjectIds=Object.keys(this.xrayedObjects)),this._xrayedObjectIds}get numHighlightedObjects(){return this._numHighlightedObjects}get highlightedObjectIds(){return this._highlightedObjectIds||(this._highlightedObjectIds=Object.keys(this.highlightedObjects)),this._highlightedObjectIds}get numSelectedObjects(){return this._numSelectedObjects}get selectedObjectIds(){return this._selectedObjectIds||(this._selectedObjectIds=Object.keys(this.selectedObjects)),this._selectedObjectIds}get numColorizedObjects(){return this._numColorizedObjects}get colorizedObjectIds(){return this._colorizedObjectIds||(this._colorizedObjectIds=Object.keys(this.colorizedObjects)),this._colorizedObjectIds}get opacityObjectIds(){return this._opacityObjectIds||(this._opacityObjectIds=Object.keys(this.opacityObjects)),this._opacityObjectIds}get offsetObjectIds(){return this._offsetObjectIds||(this._offsetObjectIds=Object.keys(this.offsetObjects)),this._offsetObjectIds}set ticksPerRender(e){e==null?e=1:(!Se.isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'ticksPerRender': '"+e+"' - should be an integer greater than zero."),e=1),e!==this._ticksPerRender&&(this._ticksPerRender=e)}get ticksPerRender(){return this._ticksPerRender}set ticksPerOcclusionTest(e){e==null?e=20:(!Se.isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'ticksPerOcclusionTest': '"+e+"' - should be an integer greater than zero."),e=20),e!==this._ticksPerOcclusionTest&&(this._ticksPerOcclusionTest=e)}get ticksPerOcclusionTest(){return this._ticksPerOcclusionTest}set passes(e){e==null?e=1:(!Se.isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'passes': '"+e+"' - should be an integer greater than zero."),e=1),e!==this._passes&&(this._passes=e,this.glRedraw())}get passes(){return this._passes}set clearEachPass(e){e=!!e,e!==this._clearEachPass&&(this._clearEachPass=e,this.glRedraw())}get clearEachPass(){return this._clearEachPass}set gammaInput(e){e=e!==!1,e!==this._renderer.gammaInput&&(this._renderer.gammaInput=e,this._needRecompile=!0,this.glRedraw())}get gammaInput(){return this._renderer.gammaInput}set gammaOutput(e){e=!!e,e!==this._renderer.gammaOutput&&(this._renderer.gammaOutput=e,this._needRecompile=!0,this.glRedraw())}get gammaOutput(){return this._renderer.gammaOutput}set gammaFactor(e){e=e??2.2,e!==this._renderer.gammaFactor&&(this._renderer.gammaFactor=e,this.glRedraw())}get gammaFactor(){return this._renderer.gammaFactor}get geometry(){return this.components["default.geometry"]||gv(fv)}get material(){return this.components["default.material"]||new jf(this,{id:"default.material",emissive:[.4,.4,.4],dontClear:!0})}get xrayMaterial(){return this.components["default.xrayMaterial"]||new oA(this,{id:"default.xrayMaterial",preset:"sepia",dontClear:!0})}get highlightMaterial(){return this.components["default.highlightMaterial"]||new oA(this,{id:"default.highlightMaterial",preset:"yellowHighlight",dontClear:!0})}get selectedMaterial(){return this.components["default.selectedMaterial"]||new oA(this,{id:"default.selectedMaterial",preset:"greenSelected",dontClear:!0})}get edgeMaterial(){return this.components["default.edgeMaterial"]||new vv(this,{id:"default.edgeMaterial",preset:"default",edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1,dontClear:!0})}get pointsMaterial(){return this.components["default.pointsMaterial"]||new xv(this,{id:"default.pointsMaterial",preset:"default",dontClear:!0})}get linesMaterial(){return this.components["default.linesMaterial"]||new wv(this,{id:"default.linesMaterial",preset:"default",dontClear:!0})}get viewport(){return this._viewport}get camera(){return this._camera}get center(){if(this._aabbDirty||!this._center){(!this._center||!this._center)&&(this._center=c.vec3());const e=this.aabb;this._center[0]=(e[0]+e[3])/2,this._center[1]=(e[1]+e[4])/2,this._center[2]=(e[2]+e[5])/2}return this._center}get aabb(){if(this._aabbDirty){this._aabb||(this._aabb=c.AABB3());let e=c.MAX_DOUBLE,t=c.MAX_DOUBLE,i=c.MAX_DOUBLE,s=c.MIN_DOUBLE,o=c.MIN_DOUBLE,n=c.MIN_DOUBLE,a;const A=this._collidables;let l,h=!1;for(const d in A)if(A.hasOwnProperty(d)){if(l=A[d],l.collidable===!1)continue;a=l.aabb,a[0]<e&&(e=a[0]),a[1]<t&&(t=a[1]),a[2]<i&&(i=a[2]),a[3]>s&&(s=a[3]),a[4]>o&&(o=a[4]),a[5]>n&&(n=a[5]),h=!0}h||(e=-100,t=-100,i=-100,s=100,o=100,n=100),this._aabb[0]=e,this._aabb[1]=t,this._aabb[2]=i,this._aabb[3]=s,this._aabb[4]=o,this._aabb[5]=n,this._aabbDirty=!1}return this._aabb}_setAABBDirty(){this._aabbDirty=!0,this.fire("boundary")}pick(e,t){if(this.canvas.boundary[2]===0||this.canvas.boundary[3]===0)return this.error("Picking not allowed while canvas has zero width or height"),null;e=e||{},e.pickSurface=e.pickSurface||e.rayPick,!e.canvasPos&&!e.matrix&&(!e.origin||!e.direction)&&this.warn("picking without canvasPos, matrix, or ray origin and direction");const i=e.includeEntities||e.include;i&&(e.includeEntityIds=Rh(this,i));const s=e.excludeEntities||e.exclude;return s&&(e.excludeEntityIds=Rh(this,s)),this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1),e.snapToEdge||e.snapToVertex?t=this._renderer.snapPick(e.canvasPos,e.snapRadius||30,e.snapToVertex,e.snapToEdge,t):t=this._renderer.pick(e,t),t&&t.entity&&t.entity.fire&&t.entity.fire("picked",t),t}snapPick(e){return this._warnSnapPickDeprecated===void 0&&(this._warnSnapPickDeprecated=!0,this.warn("Scene.snapPick() is deprecated since v2.4.2 - use Scene.pick() instead")),this._renderer.snapPick(e.canvasPos,e.snapRadius||30,e.snapToVertex,e.snapToEdge)}clear(){var e;for(const t in this.components)this.components.hasOwnProperty(t)&&(e=this.components[t],e._dontClear||e.destroy())}clearLights(){const e=Object.keys(this.lights);for(let t=0,i=e.length;t<i;t++)this.lights[e[t]].destroy()}clearSectionPlanes(){const e=Object.keys(this.sectionPlanes);for(let t=0,i=e.length;t<i;t++)this.sectionPlanes[e[t]].destroy()}clearBitmaps(){const e=Object.keys(this.bitmaps);for(let t=0,i=e.length;t<i;t++)this.bitmaps[e[t]].destroy()}clearLines(){const e=Object.keys(this.lineSets);for(let t=0,i=e.length;t<i;t++)this.lineSets[e[t]].destroy()}getAABB(e){if(e===void 0)return this.aabb;if(Se.isString(e)){const l=this.objects[e];if(l&&l.aabb)return l.aabb;e=[e]}if(e.length===0)return this.aabb;let t=c.MAX_DOUBLE,i=c.MAX_DOUBLE,s=c.MAX_DOUBLE,o=c.MIN_DOUBLE,n=c.MIN_DOUBLE,a=c.MIN_DOUBLE,A;if(this.withObjects(e,l=>{if(l.collidable){const h=l.aabb;h[0]<t&&(t=h[0]),h[1]<i&&(i=h[1]),h[2]<s&&(s=h[2]),h[3]>o&&(o=h[3]),h[4]>n&&(n=h[4]),h[5]>a&&(a=h[5]),A=!0}}),A){const l=c.AABB3();return l[0]=t,l[1]=i,l[2]=s,l[3]=o,l[4]=n,l[5]=a,l}else return this.aabb}setObjectsVisible(e,t){return this.withObjects(e,i=>{const s=i.visible!==t;return i.visible=t,s})}setObjectsCollidable(e,t){return this.withObjects(e,i=>{const s=i.collidable!==t;return i.collidable=t,s})}setObjectsCulled(e,t){return this.withObjects(e,i=>{const s=i.culled!==t;return i.culled=t,s})}setObjectsSelected(e,t){return this.withObjects(e,i=>{const s=i.selected!==t;return i.selected=t,s})}setObjectsHighlighted(e,t){return this.withObjects(e,i=>{const s=i.highlighted!==t;return i.highlighted=t,s})}setObjectsXRayed(e,t){return this.withObjects(e,i=>{const s=i.xrayed!==t;return i.xrayed=t,s})}setObjectsEdges(e,t){return this.withObjects(e,i=>{const s=i.edges!==t;return i.edges=t,s})}setObjectsColorized(e,t){return this.withObjects(e,i=>{i.colorize=t})}setObjectsOpacity(e,t){return this.withObjects(e,i=>{const s=i.opacity!==t;return i.opacity=t,s})}setObjectsPickable(e,t){return this.withObjects(e,i=>{const s=i.pickable!==t;return i.pickable=t,s})}setObjectsOffset(e,t){this.withObjects(e,i=>{i.offset=t})}withObjects(e,t){Se.isString(e)&&(e=[e]);let i=!1;for(let s=0,o=e.length;s<o;s++){const n=e[s];let a=this.objects[n];if(a)i=t(a)||i;else{const A=this.modelIds;for(let l=0,h=A.length;l<h;l++){const d=A[l],f=c.globalizeObjectId(d,n);a=this.objects[f],a&&(i=t(a)||i)}}}return i}tickify(e){const t=e.toString();if(t in this._tickifiedFunctions)return this._tickifiedFunctions[t].wrapperFunc;let i=0,s=0,o;const n=function(...A){o=A,s++},a=this.on("tick",()=>{const A=s;A>i&&(i=A,e(...o))});return this._tickifiedFunctions[t]={tickSubId:a,wrapperFunc:n},n}destroy(){super.destroy();for(const e in this.components)this.components.hasOwnProperty(e)&&this.components[e].destroy();this.canvas.gl=null,this.components=null,this.models=null,this.objects=null,this.visibleObjects=null,this.xrayedObjects=null,this.highlightedObjects=null,this.selectedObjects=null,this.colorizedObjects=null,this.opacityObjects=null,this.sectionPlanes=null,this.lights=null,this.lightMaps=null,this.reflectionMaps=null,this._objectIds=null,this._visibleObjectIds=null,this._xrayedObjectIds=null,this._highlightedObjectIds=null,this._selectedObjectIds=null,this._colorizedObjectIds=null,this.types=null,this.components=null,this.canvas=null,this._renderer=null,this.input=null,this._viewport=null,this._camera=null}}const Ht=1e3,Ls=1001,Pr=1002,To=1003,Bc=1004,Cv=1004,Ev=1005,aa=1005,Qi=1006,Pc=1007,yo=1008,zf=1008,Kf=1009,Iv=1010,Fv=1011,Mv=1012,Sv=1013,Tv=1014,Dv=1015,Rv=1016,Lv=1017,Uv=1018,Ov=1020,kv=1021,Nv=1022,Aa=1023,Qv=1024,Hv=1025,Vv=1026,Gv=1027,jv=1028,zv=1029,Kv=1030,Wv=1031,Xv=1033,Jn=33776,lA=33777,cA=33778,Zn=33779,Il=35840,Lh=35841,Fl=35842,Uh=35843,Wf=36196,Ml=37492,Sl=37496,Tl=37808,Oh=37809,kh=37810,Nh=37811,Qh=37812,Hh=37813,Vh=37814,Gh=37815,jh=37816,zh=37817,Kh=37818,Wh=37819,Xh=37820,Yh=37821,Dl=36492,yr=3e3,wt=3001,Yv=10001,Jv=10002,Zv=function(r){r._material._state.type==="LambertMaterial"?(this.vertex=$v(r),this.fragment=eB(r)):(this.vertex=tB(r),this.fragment=iB(r))},ds={};ds[yr]="linearToLinear";ds[wt]="sRGBToLinear";function Xf(r){if(!r.receivesShadow)return!1;const e=r.scene._lightsState.lights;if(!e||e.length===0)return!1;for(let t=0,i=e.length;t<i;t++)if(e[t].castsShadow)return!0;return!1}function qv(r){if(!r._geometry._state.uvBuf)return!1;const e=r._material;return!!(e._ambientMap||e._occlusionMap||e._baseColorMap||e._diffuseMap||e._alphaMap||e._specularMap||e._glossinessMap||e._specularGlossinessMap||e._emissiveMap||e._metallicMap||e._roughnessMap||e._metallicRoughnessMap||e._reflectivityMap||e._normalMap)}function Yf(r){const e=r._geometry._state.primitiveName;return!!((r._geometry._state.autoVertexNormals||r._geometry._state.normalsBuf)&&(e==="triangles"||e==="triangle-strip"||e==="triangle-fan"))}function $v(r){const e=r.scene,t=r.scene._sectionPlanesState,i=r.scene._lightsState,s=r._geometry._state,o=r._state.billboard,n=r._state.stationary,a=t.getNumAllocatedSectionPlanes()>0,A=!!s.compressGeometry,l=[];if(l.push("#version 300 es"),l.push("// Lambertian drawing vertex shader"),l.push("in vec3 position;"),l.push("uniform mat4 modelMatrix;"),l.push("uniform mat4 viewMatrix;"),l.push("uniform mat4 projMatrix;"),l.push("uniform vec4 colorize;"),l.push("uniform vec3 offset;"),A&&l.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(l.push("uniform float logDepthBufFC;"),l.push("out float vFragDepth;"),l.push("bool isPerspectiveMatrix(mat4 m) {"),l.push("    return (m[2][3] == - 1.0);"),l.push("}"),l.push("out float isPerspective;")),a&&l.push("out vec4 vWorldPosition;"),l.push("uniform vec4 lightAmbient;"),l.push("uniform vec4 materialColor;"),l.push("uniform vec3 materialEmissive;"),s.normalsBuf){l.push("in vec3 normal;"),l.push("uniform mat4 modelNormalMatrix;"),l.push("uniform mat4 viewNormalMatrix;");for(let h=0,d=i.lights.length;h<d;h++){const f=i.lights[h];f.type!=="ambient"&&(l.push("uniform vec4 lightColor"+h+";"),f.type==="dir"&&l.push("uniform vec3 lightDir"+h+";"),f.type==="point"&&l.push("uniform vec3 lightPos"+h+";"),f.type==="spot"&&(l.push("uniform vec3 lightPos"+h+";"),l.push("uniform vec3 lightDir"+h+";")))}A&&(l.push("vec3 octDecode(vec2 oct) {"),l.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),l.push("    if (v.z < 0.0) {"),l.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),l.push("    }"),l.push("    return normalize(v);"),l.push("}"))}if(l.push("out vec4 vColor;"),s.primitiveName==="points"&&l.push("uniform float pointSize;"),(o==="spherical"||o==="cylindrical")&&(l.push("void billboard(inout mat4 mat) {"),l.push("   mat[0][0] = 1.0;"),l.push("   mat[0][1] = 0.0;"),l.push("   mat[0][2] = 0.0;"),o==="spherical"&&(l.push("   mat[1][0] = 0.0;"),l.push("   mat[1][1] = 1.0;"),l.push("   mat[1][2] = 0.0;")),l.push("   mat[2][0] = 0.0;"),l.push("   mat[2][1] = 0.0;"),l.push("   mat[2][2] =1.0;"),l.push("}")),l.push("void main(void) {"),l.push("vec4 localPosition = vec4(position, 1.0); "),l.push("vec4 worldPosition;"),A&&l.push("localPosition = positionsDecodeMatrix * localPosition;"),s.normalsBuf&&(A?l.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):l.push("vec4 localNormal = vec4(normal, 0.0); "),l.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),l.push("mat4 viewNormalMatrix2 = viewNormalMatrix;")),l.push("mat4 viewMatrix2 = viewMatrix;"),l.push("mat4 modelMatrix2 = modelMatrix;"),n&&l.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),o==="spherical"||o==="cylindrical"?(l.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),l.push("billboard(modelMatrix2);"),l.push("billboard(viewMatrix2);"),l.push("billboard(modelViewMatrix);"),s.normalsBuf&&(l.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),l.push("billboard(modelNormalMatrix2);"),l.push("billboard(viewNormalMatrix2);"),l.push("billboard(modelViewNormalMatrix);")),l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("worldPosition.xyz = worldPosition.xyz + offset;"),l.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("worldPosition.xyz = worldPosition.xyz + offset;"),l.push("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),s.normalsBuf&&l.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);"),l.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),l.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),l.push("float lambertian = 1.0;"),s.normalsBuf)for(let h=0,d=i.lights.length;h<d;h++){const f=i.lights[h];if(f.type!=="ambient"){if(f.type==="dir")f.space==="view"?l.push("viewLightDir = normalize(lightDir"+h+");"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+h+", 0.0)).xyz);");else if(f.type==="point")f.space==="view"?l.push("viewLightDir = -normalize(lightPos"+h+" - viewPosition.xyz);"):l.push("viewLightDir = -normalize((viewMatrix2 * vec4(lightPos"+h+", 0.0)).xyz);");else if(f.type==="spot")f.space==="view"?l.push("viewLightDir = normalize(lightDir"+h+");"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+h+", 0.0)).xyz);");else continue;l.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),l.push("reflectedColor += lambertian * (lightColor"+h+".rgb * lightColor"+h+".a);")}}return l.push("vColor = vec4((lightAmbient.rgb * lightAmbient.a * materialColor.rgb) + materialEmissive.rgb + (reflectedColor * materialColor.rgb), materialColor.a) * colorize;"),a&&l.push("vWorldPosition = worldPosition;"),s.primitiveName==="points"&&l.push("gl_PointSize = pointSize;"),l.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(l.push("vFragDepth = 1.0 + clipPos.w;"),l.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),l.push("gl_Position = clipPos;"),l.push("}"),l}function eB(r){const e=r.scene,t=e._sectionPlanesState;r._material._state;const i=r._geometry._state,s=t.getNumAllocatedSectionPlanes()>0,o=e.gammaOutput,n=[];if(n.push("#version 300 es"),n.push("// Lambertian drawing fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),s){n.push("in vec4 vWorldPosition;"),n.push("uniform bool clippable;");for(let a=0,A=t.getNumAllocatedSectionPlanes();a<A;a++)n.push("uniform bool sectionPlaneActive"+a+";"),n.push("uniform vec3 sectionPlanePos"+a+";"),n.push("uniform vec3 sectionPlaneDir"+a+";")}if(n.push("in vec4 vColor;"),o&&(n.push("uniform float gammaFactor;"),n.push("    vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),n.push("    return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),n.push("}")),n.push("out vec4 outColor;"),n.push("void main(void) {"),s){n.push("if (clippable) {"),n.push("  float dist = 0.0;");for(let a=0,A=t.getNumAllocatedSectionPlanes();a<A;a++)n.push("if (sectionPlaneActive"+a+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > 0.0) { discard; }"),n.push("}")}return i.primitiveName==="points"&&(n.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),n.push("float r = dot(cxy, cxy);"),n.push("if (r > 1.0) {"),n.push("   discard;"),n.push("}")),e.logarithmicDepthBufferEnabled&&n.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),o?n.push("outColor = linearToGamma(vColor, gammaFactor);"):n.push("outColor = vColor;"),n.push("}"),n}function tB(r){const e=r.scene;r._material;const t=r._state,i=e._sectionPlanesState,s=r._geometry._state,o=e._lightsState;let n;const a=t.billboard,A=t.background,l=t.stationary,h=qv(r),d=Yf(r),f=i.getNumAllocatedSectionPlanes()>0,m=Xf(r),_=!!s.compressGeometry,u=[];if(u.push("#version 300 es"),u.push("// Drawing vertex shader"),u.push("in  vec3 position;"),_&&u.push("uniform mat4 positionsDecodeMatrix;"),u.push("uniform  mat4 modelMatrix;"),u.push("uniform  mat4 viewMatrix;"),u.push("uniform  mat4 projMatrix;"),u.push("out  vec3 vViewPosition;"),u.push("uniform  vec3 offset;"),f&&u.push("out vec4 vWorldPosition;"),e.logarithmicDepthBufferEnabled&&(u.push("uniform float logDepthBufFC;"),u.push("out float vFragDepth;"),u.push("bool isPerspectiveMatrix(mat4 m) {"),u.push("    return (m[2][3] == - 1.0);"),u.push("}"),u.push("out float isPerspective;")),o.lightMaps.length>0&&u.push("out    vec3 vWorldNormal;"),d){u.push("in  vec3 normal;"),u.push("uniform    mat4 modelNormalMatrix;"),u.push("uniform    mat4 viewNormalMatrix;"),u.push("out    vec3 vViewNormal;");for(let B=0,y=o.lights.length;B<y;B++)n=o.lights[B],n.type!=="ambient"&&(n.type==="dir"&&u.push("uniform vec3 lightDir"+B+";"),n.type==="point"&&u.push("uniform vec3 lightPos"+B+";"),n.type==="spot"&&(u.push("uniform vec3 lightPos"+B+";"),u.push("uniform vec3 lightDir"+B+";")),n.type==="dir"&&n.space==="view"||u.push("out vec4 vViewLightReverseDirAndDist"+B+";"));_&&(u.push("vec3 octDecode(vec2 oct) {"),u.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),u.push("    if (v.z < 0.0) {"),u.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),u.push("    }"),u.push("    return normalize(v);"),u.push("}"))}if(h&&(u.push("in vec2 uv;"),u.push("out vec2 vUV;"),_&&u.push("uniform mat3 uvDecodeMatrix;")),s.colors&&(u.push("in vec4 color;"),u.push("out vec4 vColor;")),s.primitiveName==="points"&&u.push("uniform float pointSize;"),(a==="spherical"||a==="cylindrical")&&(u.push("void billboard(inout mat4 mat) {"),u.push("   mat[0][0] = 1.0;"),u.push("   mat[0][1] = 0.0;"),u.push("   mat[0][2] = 0.0;"),a==="spherical"&&(u.push("   mat[1][0] = 0.0;"),u.push("   mat[1][1] = 1.0;"),u.push("   mat[1][2] = 0.0;")),u.push("   mat[2][0] = 0.0;"),u.push("   mat[2][1] = 0.0;"),u.push("   mat[2][2] =1.0;"),u.push("}")),m){u.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);");for(let B=0,y=o.lights.length;B<y;B++)o.lights[B].castsShadow&&(u.push("uniform mat4 shadowViewMatrix"+B+";"),u.push("uniform mat4 shadowProjMatrix"+B+";"),u.push("out vec4 vShadowPosFromLight"+B+";"))}if(u.push("void main(void) {"),u.push("vec4 localPosition = vec4(position, 1.0); "),u.push("vec4 worldPosition;"),_&&u.push("localPosition = positionsDecodeMatrix * localPosition;"),d&&(_?u.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):u.push("vec4 localNormal = vec4(normal, 0.0); "),u.push("mat4 modelNormalMatrix2    = modelNormalMatrix;"),u.push("mat4 viewNormalMatrix2     = viewNormalMatrix;")),u.push("mat4 viewMatrix2           = viewMatrix;"),u.push("mat4 modelMatrix2          = modelMatrix;"),l?u.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"):A&&u.push("viewMatrix2[3] = vec4(0.0, 0.0, 0.0 ,1.0);"),a==="spherical"||a==="cylindrical"?(u.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),u.push("billboard(modelMatrix2);"),u.push("billboard(viewMatrix2);"),u.push("billboard(modelViewMatrix);"),d&&(u.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),u.push("billboard(modelNormalMatrix2);"),u.push("billboard(viewNormalMatrix2);"),u.push("billboard(modelViewNormalMatrix);")),u.push("worldPosition = modelMatrix2 * localPosition;"),u.push("worldPosition.xyz = worldPosition.xyz + offset;"),u.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(u.push("worldPosition = modelMatrix2 * localPosition;"),u.push("worldPosition.xyz = worldPosition.xyz + offset;"),u.push("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),d){u.push("vec3 worldNormal = (modelNormalMatrix2 * localNormal).xyz; "),o.lightMaps.length>0&&u.push("vWorldNormal = worldNormal;"),u.push("vViewNormal = normalize((viewNormalMatrix2 * vec4(worldNormal, 1.0)).xyz);"),u.push("vec3 tmpVec3;"),u.push("float lightDist;");for(let B=0,y=o.lights.length;B<y;B++)n=o.lights[B],n.type!=="ambient"&&(n.type==="dir"&&n.space==="world"&&(u.push("tmpVec3 = vec3(viewMatrix2 * vec4(lightDir"+B+", 0.0) ).xyz;"),u.push("vViewLightReverseDirAndDist"+B+" = vec4(-tmpVec3, 0.0);")),n.type==="point"&&(n.space==="world"?(u.push("tmpVec3 = (viewMatrix2 * vec4(lightPos"+B+", 1.0)).xyz - viewPosition.xyz;"),u.push("lightDist = abs(length(tmpVec3));")):(u.push("tmpVec3 = lightPos"+B+".xyz - viewPosition.xyz;"),u.push("lightDist = abs(length(tmpVec3));")),u.push("vViewLightReverseDirAndDist"+B+" = vec4(tmpVec3, lightDist);")))}if(h&&(_?u.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"):u.push("vUV = uv;")),s.colors&&u.push("vColor = color;"),s.primitiveName==="points"&&u.push("gl_PointSize = pointSize;"),f&&u.push("vWorldPosition = worldPosition;"),u.push("   vViewPosition = viewPosition.xyz;"),u.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(u.push("vFragDepth = 1.0 + clipPos.w;"),u.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),A&&u.push("clipPos.z = clipPos.w;"),u.push("gl_Position = clipPos;"),m){u.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);"),u.push("vec4 tempx; ");for(let B=0,y=o.lights.length;B<y;B++)o.lights[B].castsShadow&&u.push("vShadowPosFromLight"+B+" = texUnitConverter * shadowProjMatrix"+B+" * (shadowViewMatrix"+B+" * worldPosition); ")}return u.push("}"),u}function iB(r){const e=r.scene;e.canvas.gl;const t=r._material,i=r._geometry._state,s=r.scene._sectionPlanesState,o=r.scene._lightsState,n=r._material._state,a=s.getNumAllocatedSectionPlanes()>0,A=Yf(r),l=i.uvBuf,h=n.type==="PhongMaterial",d=n.type==="MetallicMaterial",f=n.type==="SpecularMaterial",m=Xf(r);e.gammaInput;const _=e.gammaOutput,u=[];if(u.push("#version 300 es"),u.push("// Drawing fragment shader"),u.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),u.push("precision highp float;"),u.push("precision highp int;"),u.push("#else"),u.push("precision mediump float;"),u.push("precision mediump int;"),u.push("#endif"),e.logarithmicDepthBufferEnabled&&(u.push("in float isPerspective;"),u.push("uniform float logDepthBufFC;"),u.push("in float vFragDepth;")),m&&(u.push("float unpackDepth (vec4 color) {"),u.push("  const vec4 bitShift = vec4(1.0, 1.0/256.0, 1.0/(256.0 * 256.0), 1.0/(256.0*256.0*256.0));"),u.push("  return dot(color, bitShift);"),u.push("}")),u.push("uniform float gammaFactor;"),u.push("vec4 linearToLinear( in vec4 value ) {"),u.push("  return value;"),u.push("}"),u.push("vec4 sRGBToLinear( in vec4 value ) {"),u.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),u.push("}"),u.push("vec4 gammaToLinear( in vec4 value) {"),u.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),u.push("}"),_&&(u.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),u.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),u.push("}")),a){u.push("in vec4 vWorldPosition;"),u.push("uniform bool clippable;");for(var B=0;B<s.getNumAllocatedSectionPlanes();B++)u.push("uniform bool sectionPlaneActive"+B+";"),u.push("uniform vec3 sectionPlanePos"+B+";"),u.push("uniform vec3 sectionPlaneDir"+B+";")}if(A&&(o.lightMaps.length>0&&(u.push("uniform samplerCube lightMap;"),u.push("uniform mat4 viewNormalMatrix;")),o.reflectionMaps.length>0&&u.push("uniform samplerCube reflectionMap;"),(o.lightMaps.length>0||o.reflectionMaps.length>0)&&u.push("uniform mat4 viewMatrix;"),u.push("#define PI 3.14159265359"),u.push("#define RECIPROCAL_PI 0.31830988618"),u.push("#define RECIPROCAL_PI2 0.15915494"),u.push("#define EPSILON 1e-6"),u.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),u.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),u.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),u.push("}"),u.push("struct IncidentLight {"),u.push("   vec3 color;"),u.push("   vec3 direction;"),u.push("};"),u.push("struct ReflectedLight {"),u.push("   vec3 diffuse;"),u.push("   vec3 specular;"),u.push("};"),u.push("struct Geometry {"),u.push("   vec3 position;"),u.push("   vec3 viewNormal;"),u.push("   vec3 worldNormal;"),u.push("   vec3 viewEyeDir;"),u.push("};"),u.push("struct Material {"),u.push("   vec3    diffuseColor;"),u.push("   float   specularRoughness;"),u.push("   vec3    specularColor;"),u.push("   float   shine;"),u.push("};"),h&&((o.lightMaps.length>0||o.reflectionMaps.length>0)&&(u.push("void computePhongLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),o.lightMaps.length>0&&(u.push("   vec3 irradiance = "+ds[o.lightMaps[0].encoding]+"(texture(lightMap, geometry.worldNormal)).rgb;"),u.push("   irradiance *= PI;"),u.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),u.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),o.reflectionMaps.length>0&&(u.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),u.push("   vec3 radiance               = texture(reflectionMap, reflectVec).rgb * 0.2;"),u.push("   radiance *= PI;"),u.push("   reflectedLight.specular     += radiance;")),u.push("}")),u.push("void computePhongLighting(const in IncidentLight directLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),u.push("   float dotNL     = saturate(dot(geometry.viewNormal, directLight.direction));"),u.push("   vec3 irradiance = dotNL * directLight.color * PI;"),u.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),u.push("   reflectedLight.specular += directLight.color * material.specularColor * pow(max(dot(reflect(-directLight.direction, -geometry.viewNormal), geometry.viewEyeDir), 0.0), material.shine);"),u.push("}")),(d||f)&&(u.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),u.push("   float r = ggxRoughness + 0.0001;"),u.push("   return (2.0 / (r * r) - 2.0);"),u.push("}"),u.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),u.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),u.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),u.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),u.push("}"),o.reflectionMaps.length>0&&(u.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),u.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),u.push("   vec3 envMapColor = "+ds[o.reflectionMaps[0].encoding]+"(texture(reflectionMap, reflectVec, mipLevel)).rgb;"),u.push("  return envMapColor;"),u.push("}")),u.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),u.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),u.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),u.push("}"),u.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),u.push("   float a2 = ( alpha * alpha );"),u.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),u.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),u.push("   return 1.0 / ( gl * gv );"),u.push("}"),u.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),u.push("   float a2 = ( alpha * alpha );"),u.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),u.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),u.push("   return 0.5 / max( gv + gl, EPSILON );"),u.push("}"),u.push("float D_GGX(const in float alpha, const in float dotNH) {"),u.push("   float a2 = ( alpha * alpha );"),u.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),u.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),u.push("}"),u.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),u.push("   float alpha = ( roughness * roughness );"),u.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),u.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),u.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),u.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),u.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),u.push("   vec3  F = F_Schlick( specularColor, dotLH );"),u.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),u.push("   float D = D_GGX( alpha, dotNH );"),u.push("   return F * (G * D);"),u.push("}"),u.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),u.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),u.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),u.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),u.push("   vec4 r = roughness * c0 + c1;"),u.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),u.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),u.push("   return specularColor * AB.x + AB.y;"),u.push("}"),(o.lightMaps.length>0||o.reflectionMaps.length>0)&&(u.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),o.lightMaps.length>0&&(u.push("   vec3 irradiance = sRGBToLinear(texture(lightMap, geometry.worldNormal)).rgb;"),u.push("   irradiance *= PI;"),u.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),u.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),o.reflectionMaps.length>0&&(u.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),u.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),u.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),u.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),u.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),u.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),u.push("}")),u.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),u.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),u.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),u.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),u.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),u.push("}"))),u.push("in vec3 vViewPosition;"),i.colors&&u.push("in vec4 vColor;"),l&&(A&&t._normalMap||t._ambientMap||t._baseColorMap||t._diffuseMap||t._emissiveMap||t._metallicMap||t._roughnessMap||t._metallicRoughnessMap||t._specularMap||t._glossinessMap||t._specularGlossinessMap||t._occlusionMap||t._alphaMap)&&u.push("in vec2 vUV;"),A&&(o.lightMaps.length>0&&u.push("in vec3 vWorldNormal;"),u.push("in vec3 vViewNormal;")),n.ambient&&u.push("uniform vec3 materialAmbient;"),n.baseColor&&u.push("uniform vec3 materialBaseColor;"),n.alpha!==void 0&&n.alpha!==null&&u.push("uniform vec4 materialAlphaModeCutoff;"),n.emissive&&u.push("uniform vec3 materialEmissive;"),n.diffuse&&u.push("uniform vec3 materialDiffuse;"),n.glossiness!==void 0&&n.glossiness!==null&&u.push("uniform float materialGlossiness;"),n.shininess!==void 0&&n.shininess!==null&&u.push("uniform float materialShininess;"),n.specular&&u.push("uniform vec3 materialSpecular;"),n.metallic!==void 0&&n.metallic!==null&&u.push("uniform float materialMetallic;"),n.roughness!==void 0&&n.roughness!==null&&u.push("uniform float materialRoughness;"),n.specularF0!==void 0&&n.specularF0!==null&&u.push("uniform float materialSpecularF0;"),l&&t._ambientMap&&(u.push("uniform sampler2D ambientMap;"),t._ambientMap._state.matrix&&u.push("uniform mat4 ambientMapMatrix;")),l&&t._baseColorMap&&(u.push("uniform sampler2D baseColorMap;"),t._baseColorMap._state.matrix&&u.push("uniform mat4 baseColorMapMatrix;")),l&&t._diffuseMap&&(u.push("uniform sampler2D diffuseMap;"),t._diffuseMap._state.matrix&&u.push("uniform mat4 diffuseMapMatrix;")),l&&t._emissiveMap&&(u.push("uniform sampler2D emissiveMap;"),t._emissiveMap._state.matrix&&u.push("uniform mat4 emissiveMapMatrix;")),A&&l&&t._metallicMap&&(u.push("uniform sampler2D metallicMap;"),t._metallicMap._state.matrix&&u.push("uniform mat4 metallicMapMatrix;")),A&&l&&t._roughnessMap&&(u.push("uniform sampler2D roughnessMap;"),t._roughnessMap._state.matrix&&u.push("uniform mat4 roughnessMapMatrix;")),A&&l&&t._metallicRoughnessMap&&(u.push("uniform sampler2D metallicRoughnessMap;"),t._metallicRoughnessMap._state.matrix&&u.push("uniform mat4 metallicRoughnessMapMatrix;")),A&&t._normalMap&&(u.push("uniform sampler2D normalMap;"),t._normalMap._state.matrix&&u.push("uniform mat4 normalMapMatrix;"),u.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),u.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),u.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),u.push("      vec2 st0 = dFdx( uv.st );"),u.push("      vec2 st1 = dFdy( uv.st );"),u.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),u.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),u.push("      vec3 N = normalize( surf_norm );"),u.push("      vec3 mapN = texture( normalMap, uv ).xyz * 2.0 - 1.0;"),u.push("      mat3 tsn = mat3( S, T, N );"),u.push("      return normalize( tsn * mapN );"),u.push("}")),l&&t._occlusionMap&&(u.push("uniform sampler2D occlusionMap;"),t._occlusionMap._state.matrix&&u.push("uniform mat4 occlusionMapMatrix;")),l&&t._alphaMap&&(u.push("uniform sampler2D alphaMap;"),t._alphaMap._state.matrix&&u.push("uniform mat4 alphaMapMatrix;")),A&&l&&t._specularMap&&(u.push("uniform sampler2D specularMap;"),t._specularMap._state.matrix&&u.push("uniform mat4 specularMapMatrix;")),A&&l&&t._glossinessMap&&(u.push("uniform sampler2D glossinessMap;"),t._glossinessMap._state.matrix&&u.push("uniform mat4 glossinessMapMatrix;")),A&&l&&t._specularGlossinessMap&&(u.push("uniform sampler2D materialSpecularGlossinessMap;"),t._specularGlossinessMap._state.matrix&&u.push("uniform mat4 materialSpecularGlossinessMapMatrix;")),A&&(t._diffuseFresnel||t._specularFresnel||t._alphaFresnel||t._emissiveFresnel||t._reflectivityFresnel)&&(u.push("float fresnel(vec3 eyeDir, vec3 normal, float edgeBias, float centerBias, float power) {"),u.push("    float fr = abs(dot(eyeDir, normal));"),u.push("    float finalFr = clamp((fr - edgeBias) / (centerBias - edgeBias), 0.0, 1.0);"),u.push("    return pow(finalFr, power);"),u.push("}"),t._diffuseFresnel&&(u.push("uniform float  diffuseFresnelCenterBias;"),u.push("uniform float  diffuseFresnelEdgeBias;"),u.push("uniform float  diffuseFresnelPower;"),u.push("uniform vec3   diffuseFresnelCenterColor;"),u.push("uniform vec3   diffuseFresnelEdgeColor;")),t._specularFresnel&&(u.push("uniform float  specularFresnelCenterBias;"),u.push("uniform float  specularFresnelEdgeBias;"),u.push("uniform float  specularFresnelPower;"),u.push("uniform vec3   specularFresnelCenterColor;"),u.push("uniform vec3   specularFresnelEdgeColor;")),t._alphaFresnel&&(u.push("uniform float  alphaFresnelCenterBias;"),u.push("uniform float  alphaFresnelEdgeBias;"),u.push("uniform float  alphaFresnelPower;"),u.push("uniform vec3   alphaFresnelCenterColor;"),u.push("uniform vec3   alphaFresnelEdgeColor;")),t._reflectivityFresnel&&(u.push("uniform float  materialSpecularF0FresnelCenterBias;"),u.push("uniform float  materialSpecularF0FresnelEdgeBias;"),u.push("uniform float  materialSpecularF0FresnelPower;"),u.push("uniform vec3   materialSpecularF0FresnelCenterColor;"),u.push("uniform vec3   materialSpecularF0FresnelEdgeColor;")),t._emissiveFresnel&&(u.push("uniform float  emissiveFresnelCenterBias;"),u.push("uniform float  emissiveFresnelEdgeBias;"),u.push("uniform float  emissiveFresnelPower;"),u.push("uniform vec3   emissiveFresnelCenterColor;"),u.push("uniform vec3   emissiveFresnelEdgeColor;"))),u.push("uniform vec4   lightAmbient;"),A)for(let y=0,x=o.lights.length;y<x;y++){const P=o.lights[y];P.type!=="ambient"&&(u.push("uniform vec4 lightColor"+y+";"),P.type==="point"&&u.push("uniform vec3 lightAttenuation"+y+";"),P.type==="dir"&&P.space==="view"&&u.push("uniform vec3 lightDir"+y+";"),P.type==="point"&&P.space==="view"?u.push("uniform vec3 lightPos"+y+";"):u.push("in vec4 vViewLightReverseDirAndDist"+y+";"))}if(m)for(let y=0,x=o.lights.length;y<x;y++)o.lights[y].castsShadow&&(u.push("in vec4 vShadowPosFromLight"+y+";"),u.push("uniform sampler2D shadowMap"+y+";"));if(u.push("uniform vec4 colorize;"),u.push("out vec4 outColor;"),u.push("void main(void) {"),a){u.push("if (clippable) {"),u.push("  float dist = 0.0;");for(var B=0;B<s.getNumAllocatedSectionPlanes();B++)u.push("if (sectionPlaneActive"+B+") {"),u.push("   dist += clamp(dot(-sectionPlaneDir"+B+".xyz, vWorldPosition.xyz - sectionPlanePos"+B+".xyz), 0.0, 1000.0);"),u.push("}");u.push("  if (dist > 0.0) { discard; }"),u.push("}")}if(i.primitiveName==="points"&&(u.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),u.push("float r = dot(cxy, cxy);"),u.push("if (r > 1.0) {"),u.push("   discard;"),u.push("}")),u.push("float occlusion = 1.0;"),n.ambient?u.push("vec3 ambientColor = materialAmbient;"):u.push("vec3 ambientColor = vec3(1.0, 1.0, 1.0);"),n.diffuse?u.push("vec3 diffuseColor = materialDiffuse;"):n.baseColor?u.push("vec3 diffuseColor = materialBaseColor;"):u.push("vec3 diffuseColor = vec3(1.0, 1.0, 1.0);"),i.colors&&u.push("diffuseColor *= vColor.rgb;"),n.emissive?u.push("vec3 emissiveColor = materialEmissive;"):u.push("vec3  emissiveColor = vec3(0.0, 0.0, 0.0);"),n.specular?u.push("vec3 specular = materialSpecular;"):u.push("vec3 specular = vec3(1.0, 1.0, 1.0);"),n.alpha!==void 0?u.push("float alpha = materialAlphaModeCutoff[0];"):u.push("float alpha = 1.0;"),i.colors&&u.push("alpha *= vColor.a;"),n.glossiness!==void 0?u.push("float glossiness = materialGlossiness;"):u.push("float glossiness = 1.0;"),n.metallic!==void 0?u.push("float metallic = materialMetallic;"):u.push("float metallic = 1.0;"),n.roughness!==void 0?u.push("float roughness = materialRoughness;"):u.push("float roughness = 1.0;"),n.specularF0!==void 0?u.push("float specularF0 = materialSpecularF0;"):u.push("float specularF0 = 1.0;"),l&&(A&&t._normalMap||t._ambientMap||t._baseColorMap||t._diffuseMap||t._occlusionMap||t._emissiveMap||t._metallicMap||t._roughnessMap||t._metallicRoughnessMap||t._specularMap||t._glossinessMap||t._specularGlossinessMap||t._alphaMap)&&(u.push("vec4 texturePos = vec4(vUV.s, vUV.t, 1.0, 1.0);"),u.push("vec2 textureCoord;")),l&&t._ambientMap&&(t._ambientMap._state.matrix?u.push("textureCoord = (ambientMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("vec4 ambientTexel = texture(ambientMap, textureCoord).rgb;"),u.push("ambientTexel = "+ds[t._ambientMap._state.encoding]+"(ambientTexel);"),u.push("ambientColor *= ambientTexel.rgb;")),l&&t._diffuseMap&&(t._diffuseMap._state.matrix?u.push("textureCoord = (diffuseMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("vec4 diffuseTexel = texture(diffuseMap, textureCoord);"),u.push("diffuseTexel = "+ds[t._diffuseMap._state.encoding]+"(diffuseTexel);"),u.push("diffuseColor *= diffuseTexel.rgb;"),u.push("alpha *= diffuseTexel.a;")),l&&t._baseColorMap&&(t._baseColorMap._state.matrix?u.push("textureCoord = (baseColorMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("vec4 baseColorTexel = texture(baseColorMap, textureCoord);"),u.push("baseColorTexel = "+ds[t._baseColorMap._state.encoding]+"(baseColorTexel);"),u.push("diffuseColor *= baseColorTexel.rgb;"),u.push("alpha *= baseColorTexel.a;")),l&&t._emissiveMap&&(t._emissiveMap._state.matrix?u.push("textureCoord = (emissiveMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("vec4 emissiveTexel = texture(emissiveMap, textureCoord);"),u.push("emissiveTexel = "+ds[t._emissiveMap._state.encoding]+"(emissiveTexel);"),u.push("emissiveColor = emissiveTexel.rgb;")),l&&t._alphaMap&&(t._alphaMap._state.matrix?u.push("textureCoord = (alphaMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("alpha *= texture(alphaMap, textureCoord).r;")),l&&t._occlusionMap&&(t._occlusionMap._state.matrix?u.push("textureCoord = (occlusionMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("occlusion *= texture(occlusionMap, textureCoord).r;")),A&&(o.lights.length>0||o.lightMaps.length>0||o.reflectionMaps.length>0)){l&&t._normalMap?(t._normalMap._state.matrix?u.push("textureCoord = (normalMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("vec3 viewNormal = perturbNormal2Arb( vViewPosition, normalize(vViewNormal), textureCoord );")):u.push("vec3 viewNormal = normalize(vViewNormal);"),l&&t._specularMap&&(t._specularMap._state.matrix?u.push("textureCoord = (specularMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("specular *= texture(specularMap, textureCoord).rgb;")),l&&t._glossinessMap&&(t._glossinessMap._state.matrix?u.push("textureCoord = (glossinessMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("glossiness *= texture(glossinessMap, textureCoord).r;")),l&&t._specularGlossinessMap&&(t._specularGlossinessMap._state.matrix?u.push("textureCoord = (materialSpecularGlossinessMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("vec4 specGlossRGB = texture(materialSpecularGlossinessMap, textureCoord).rgba;"),u.push("specular *= specGlossRGB.rgb;"),u.push("glossiness *= specGlossRGB.a;")),l&&t._metallicMap&&(t._metallicMap._state.matrix?u.push("textureCoord = (metallicMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("metallic *= texture(metallicMap, textureCoord).r;")),l&&t._roughnessMap&&(t._roughnessMap._state.matrix?u.push("textureCoord = (roughnessMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("roughness *= texture(roughnessMap, textureCoord).r;")),l&&t._metallicRoughnessMap&&(t._metallicRoughnessMap._state.matrix?u.push("textureCoord = (metallicRoughnessMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("vec3 metalRoughRGB = texture(metallicRoughnessMap, textureCoord).rgb;"),u.push("metallic *= metalRoughRGB.b;"),u.push("roughness *= metalRoughRGB.g;")),u.push("vec3 viewEyeDir = normalize(-vViewPosition);"),t._diffuseFresnel&&(u.push("float diffuseFresnel = fresnel(viewEyeDir, viewNormal, diffuseFresnelEdgeBias, diffuseFresnelCenterBias, diffuseFresnelPower);"),u.push("diffuseColor *= mix(diffuseFresnelEdgeColor, diffuseFresnelCenterColor, diffuseFresnel);")),t._specularFresnel&&(u.push("float specularFresnel = fresnel(viewEyeDir, viewNormal, specularFresnelEdgeBias, specularFresnelCenterBias, specularFresnelPower);"),u.push("specular *= mix(specularFresnelEdgeColor, specularFresnelCenterColor, specularFresnel);")),t._alphaFresnel&&(u.push("float alphaFresnel = fresnel(viewEyeDir, viewNormal, alphaFresnelEdgeBias, alphaFresnelCenterBias, alphaFresnelPower);"),u.push("alpha *= mix(alphaFresnelEdgeColor.r, alphaFresnelCenterColor.r, alphaFresnel);")),t._emissiveFresnel&&(u.push("float emissiveFresnel = fresnel(viewEyeDir, viewNormal, emissiveFresnelEdgeBias, emissiveFresnelCenterBias, emissiveFresnelPower);"),u.push("emissiveColor *= mix(emissiveFresnelEdgeColor, emissiveFresnelCenterColor, emissiveFresnel);")),u.push("if (materialAlphaModeCutoff[1] == 1.0 && alpha < materialAlphaModeCutoff[2]) {"),u.push("   discard;"),u.push("}"),u.push("IncidentLight  light;"),u.push("Material       material;"),u.push("Geometry       geometry;"),u.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),u.push("vec3           viewLightDir;"),h&&(u.push("material.diffuseColor      = diffuseColor;"),u.push("material.specularColor     = specular;"),u.push("material.shine             = materialShininess;")),f&&(u.push("float oneMinusSpecularStrength = 1.0 - max(max(specular.r, specular.g ),specular.b);"),u.push("material.diffuseColor      = diffuseColor * oneMinusSpecularStrength;"),u.push("material.specularRoughness = clamp( 1.0 - glossiness, 0.04, 1.0 );"),u.push("material.specularColor     = specular;")),d&&(u.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),u.push("material.diffuseColor      = diffuseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),u.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),u.push("material.specularColor     = mix(vec3(dielectricSpecular), diffuseColor, metallic);")),u.push("geometry.position      = vViewPosition;"),o.lightMaps.length>0&&u.push("geometry.worldNormal   = normalize(vWorldNormal);"),u.push("geometry.viewNormal    = viewNormal;"),u.push("geometry.viewEyeDir    = viewEyeDir;"),h&&(o.lightMaps.length>0||o.reflectionMaps.length>0)&&u.push("computePhongLightMapping(geometry, material, reflectedLight);"),(f||d)&&(o.lightMaps.length>0||o.reflectionMaps.length>0)&&u.push("computePBRLightMapping(geometry, material, reflectedLight);"),u.push("float shadow = 1.0;"),u.push("float shadowAcneRemover = 0.007;"),u.push("vec3 fragmentDepth;"),u.push("float texelSize = 1.0 / 1024.0;"),u.push("float amountInLight = 0.0;"),u.push("vec3 shadowCoord;"),u.push("vec4 rgbaDepth;"),u.push("float depth;");for(let y=0,x=o.lights.length;y<x;y++){const P=o.lights[y];P.type!=="ambient"&&(P.type==="dir"&&P.space==="view"?u.push("viewLightDir = -normalize(lightDir"+y+");"):P.type==="point"&&P.space==="view"?u.push("viewLightDir = normalize(lightPos"+y+" - vViewPosition);"):u.push("viewLightDir = normalize(vViewLightReverseDirAndDist"+y+".xyz);"),m&&P.castsShadow?(u.push("shadow = 0.0;"),u.push("fragmentDepth = vShadowPosFromLight"+y+".xyz;"),u.push("fragmentDepth.z -= shadowAcneRemover;"),u.push("for (int x = -3; x <= 3; x++) {"),u.push("  for (int y = -3; y <= 3; y++) {"),u.push("      float texelDepth = unpackDepth(texture(shadowMap"+y+", fragmentDepth.xy + vec2(x, y) * texelSize));"),u.push("      if (fragmentDepth.z < texelDepth) {"),u.push("          shadow += 1.0;"),u.push("      }"),u.push("  }"),u.push("}"),u.push("shadow = shadow / 9.0;"),u.push("light.color =  lightColor"+y+".rgb * (lightColor"+y+".a * shadow);")):u.push("light.color =  lightColor"+y+".rgb * (lightColor"+y+".a );"),u.push("light.direction = viewLightDir;"),h&&u.push("computePhongLighting(light, geometry, material, reflectedLight);"),(f||d)&&u.push("computePBRLighting(light, geometry, material, reflectedLight);"))}h?u.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * diffuseColor) + ((occlusion * (( reflectedLight.diffuse + reflectedLight.specular)))) + emissiveColor;"):u.push("vec3 outgoingLight = (occlusion * (reflectedLight.diffuse)) + (occlusion * reflectedLight.specular) + emissiveColor;")}else u.push("ambientColor *= (lightAmbient.rgb * lightAmbient.a);"),u.push("vec3 outgoingLight = emissiveColor + ambientColor;");return u.push("vec4 fragColor = vec4(outgoingLight, alpha) * colorize;"),_&&u.push("fragColor = linearToGamma(fragColor, gammaFactor);"),u.push("outColor = fragColor;"),e.logarithmicDepthBufferEnabled&&u.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),u.push("}"),u}const sB=c.vec3(),Jf=new Si({}),Vi=function(r,e){this.id=Jf.addItem({}),this._hash=r,this._scene=e.scene,this._useCount=0,this._shaderSource=new Zv(e),this._allocate(e)},Rl={};Vi.get=function(r){const e=r.scene,t=[e.canvas.canvas.id,(e.gammaInput?"gi;":";")+(e.gammaOutput?"go":""),e._lightsState.getHash(),e._sectionPlanesState.getHash(),r._geometry._state.hash,r._material._state.hash,r._state.drawHash].join(";");let i=Rl[t];if(!i){if(i=new Vi(t,r),i.errors)return console.log(i.errors.join(`
`)),null;Rl[t]=i,vt.memory.programs++}return i._useCount++,i};Vi.prototype.put=function(){--this._useCount===0&&(Jf.removeItem(this.id),this._program&&this._program.destroy(),delete Rl[this._hash],vt.memory.programs--)};Vi.prototype.webglContextRestored=function(){this._program=null};Vi.prototype.drawMesh=function(r,e){this._program||this._allocate(e);const t=_t.MAX_TEXTURE_UNITS,i=e.scene,s=e._material,o=i.canvas.gl,n=this._program,a=e._state,A=e._material._state,l=e._geometry._state,h=i.camera,d=e.origin,f=a.background;if(r.lastProgramId!==this._program.id&&(r.lastProgramId=this._program.id,f&&o.depthFunc(o.LEQUAL),this._bindProgram(r)),o.uniformMatrix4fv(this._uViewMatrix,!1,d?r.getRTCViewMatrix(a.originHash,d):h.viewMatrix),o.uniformMatrix4fv(this._uViewNormalMatrix,!1,h.viewNormalMatrix),a.clippable){const y=i._sectionPlanesState.getNumAllocatedSectionPlanes(),x=i._sectionPlanesState.sectionPlanes.length;if(y>0){const P=i._sectionPlanesState.sectionPlanes,v=e.renderFlags;for(let b=0;b<y;b++){const C=this._uSectionPlanes[b];if(C)if(b<x){const I=v.sectionPlanesActivePerLayer[b];if(o.uniform1i(C.active,I?1:0),I){const E=P[b];if(d){const S=Ot(E.dist,E.dir,d,sB);o.uniform3fv(C.pos,S)}else o.uniform3fv(C.pos,E.pos);o.uniform3fv(C.dir,E.dir)}}else o.uniform1i(C.active,0)}}}if(A.id!==this._lastMaterialId){r.textureUnit=this._baseTextureUnit;const y=A.backfaces;r.backfaces!==y&&(y?o.disable(o.CULL_FACE):o.enable(o.CULL_FACE),r.backfaces=y);const x=A.frontface;switch(r.frontface!==x&&(x?o.frontFace(o.CCW):o.frontFace(o.CW),r.frontface=x),r.lineWidth!==A.lineWidth&&(o.lineWidth(A.lineWidth),r.lineWidth=A.lineWidth),this._uPointSize&&o.uniform1f(this._uPointSize,A.pointSize),A.type){case"LambertMaterial":this._uMaterialAmbient&&o.uniform3fv(this._uMaterialAmbient,A.ambient),this._uMaterialColor&&o.uniform4f(this._uMaterialColor,A.color[0],A.color[1],A.color[2],A.alpha),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,A.emissive);break;case"PhongMaterial":this._uMaterialShininess&&o.uniform1f(this._uMaterialShininess,A.shininess),this._uMaterialAmbient&&o.uniform3fv(this._uMaterialAmbient,A.ambient),this._uMaterialDiffuse&&o.uniform3fv(this._uMaterialDiffuse,A.diffuse),this._uMaterialSpecular&&o.uniform3fv(this._uMaterialSpecular,A.specular),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,A.emissive),this._uAlphaModeCutoff&&o.uniform4f(this._uAlphaModeCutoff,1*A.alpha,A.alphaMode===1?1:0,A.alphaCutoff,0),s._ambientMap&&s._ambientMap._state.texture&&this._uMaterialAmbientMap&&(n.bindTexture(this._uMaterialAmbientMap,s._ambientMap._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uMaterialAmbientMapMatrix&&o.uniformMatrix4fv(this._uMaterialAmbientMapMatrix,!1,s._ambientMap._state.matrix)),s._diffuseMap&&s._diffuseMap._state.texture&&this._uDiffuseMap&&(n.bindTexture(this._uDiffuseMap,s._diffuseMap._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uDiffuseMapMatrix&&o.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,s._diffuseMap._state.matrix)),s._specularMap&&s._specularMap._state.texture&&this._uSpecularMap&&(n.bindTexture(this._uSpecularMap,s._specularMap._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uSpecularMapMatrix&&o.uniformMatrix4fv(this._uSpecularMapMatrix,!1,s._specularMap._state.matrix)),s._emissiveMap&&s._emissiveMap._state.texture&&this._uEmissiveMap&&(n.bindTexture(this._uEmissiveMap,s._emissiveMap._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uEmissiveMapMatrix&&o.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,s._emissiveMap._state.matrix)),s._alphaMap&&s._alphaMap._state.texture&&this._uAlphaMap&&(n.bindTexture(this._uAlphaMap,s._alphaMap._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uAlphaMapMatrix&&o.uniformMatrix4fv(this._uAlphaMapMatrix,!1,s._alphaMap._state.matrix)),s._reflectivityMap&&s._reflectivityMap._state.texture&&this._uReflectivityMap&&(n.bindTexture(this._uReflectivityMap,s._reflectivityMap._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,this._uReflectivityMapMatrix&&o.uniformMatrix4fv(this._uReflectivityMapMatrix,!1,s._reflectivityMap._state.matrix)),s._normalMap&&s._normalMap._state.texture&&this._uNormalMap&&(n.bindTexture(this._uNormalMap,s._normalMap._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uNormalMapMatrix&&o.uniformMatrix4fv(this._uNormalMapMatrix,!1,s._normalMap._state.matrix)),s._occlusionMap&&s._occlusionMap._state.texture&&this._uOcclusionMap&&(n.bindTexture(this._uOcclusionMap,s._occlusionMap._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uOcclusionMapMatrix&&o.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,s._occlusionMap._state.matrix)),s._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias&&o.uniform1f(this._uDiffuseFresnelEdgeBias,s._diffuseFresnel.edgeBias),this._uDiffuseFresnelCenterBias&&o.uniform1f(this._uDiffuseFresnelCenterBias,s._diffuseFresnel.centerBias),this._uDiffuseFresnelEdgeColor&&o.uniform3fv(this._uDiffuseFresnelEdgeColor,s._diffuseFresnel.edgeColor),this._uDiffuseFresnelCenterColor&&o.uniform3fv(this._uDiffuseFresnelCenterColor,s._diffuseFresnel.centerColor),this._uDiffuseFresnelPower&&o.uniform1f(this._uDiffuseFresnelPower,s._diffuseFresnel.power)),s._specularFresnel&&(this._uSpecularFresnelEdgeBias&&o.uniform1f(this._uSpecularFresnelEdgeBias,s._specularFresnel.edgeBias),this._uSpecularFresnelCenterBias&&o.uniform1f(this._uSpecularFresnelCenterBias,s._specularFresnel.centerBias),this._uSpecularFresnelEdgeColor&&o.uniform3fv(this._uSpecularFresnelEdgeColor,s._specularFresnel.edgeColor),this._uSpecularFresnelCenterColor&&o.uniform3fv(this._uSpecularFresnelCenterColor,s._specularFresnel.centerColor),this._uSpecularFresnelPower&&o.uniform1f(this._uSpecularFresnelPower,s._specularFresnel.power)),s._alphaFresnel&&(this._uAlphaFresnelEdgeBias&&o.uniform1f(this._uAlphaFresnelEdgeBias,s._alphaFresnel.edgeBias),this._uAlphaFresnelCenterBias&&o.uniform1f(this._uAlphaFresnelCenterBias,s._alphaFresnel.centerBias),this._uAlphaFresnelEdgeColor&&o.uniform3fv(this._uAlphaFresnelEdgeColor,s._alphaFresnel.edgeColor),this._uAlphaFresnelCenterColor&&o.uniform3fv(this._uAlphaFresnelCenterColor,s._alphaFresnel.centerColor),this._uAlphaFresnelPower&&o.uniform1f(this._uAlphaFresnelPower,s._alphaFresnel.power)),s._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias&&o.uniform1f(this._uReflectivityFresnelEdgeBias,s._reflectivityFresnel.edgeBias),this._uReflectivityFresnelCenterBias&&o.uniform1f(this._uReflectivityFresnelCenterBias,s._reflectivityFresnel.centerBias),this._uReflectivityFresnelEdgeColor&&o.uniform3fv(this._uReflectivityFresnelEdgeColor,s._reflectivityFresnel.edgeColor),this._uReflectivityFresnelCenterColor&&o.uniform3fv(this._uReflectivityFresnelCenterColor,s._reflectivityFresnel.centerColor),this._uReflectivityFresnelPower&&o.uniform1f(this._uReflectivityFresnelPower,s._reflectivityFresnel.power)),s._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias&&o.uniform1f(this._uEmissiveFresnelEdgeBias,s._emissiveFresnel.edgeBias),this._uEmissiveFresnelCenterBias&&o.uniform1f(this._uEmissiveFresnelCenterBias,s._emissiveFresnel.centerBias),this._uEmissiveFresnelEdgeColor&&o.uniform3fv(this._uEmissiveFresnelEdgeColor,s._emissiveFresnel.edgeColor),this._uEmissiveFresnelCenterColor&&o.uniform3fv(this._uEmissiveFresnelCenterColor,s._emissiveFresnel.centerColor),this._uEmissiveFresnelPower&&o.uniform1f(this._uEmissiveFresnelPower,s._emissiveFresnel.power));break;case"MetallicMaterial":this._uBaseColor&&o.uniform3fv(this._uBaseColor,A.baseColor),this._uMaterialMetallic&&o.uniform1f(this._uMaterialMetallic,A.metallic),this._uMaterialRoughness&&o.uniform1f(this._uMaterialRoughness,A.roughness),this._uMaterialSpecularF0&&o.uniform1f(this._uMaterialSpecularF0,A.specularF0),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,A.emissive),this._uAlphaModeCutoff&&o.uniform4f(this._uAlphaModeCutoff,1*A.alpha,A.alphaMode===1?1:0,A.alphaCutoff,0);const P=s._baseColorMap;P&&P._state.texture&&this._uBaseColorMap&&(n.bindTexture(this._uBaseColorMap,P._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uBaseColorMapMatrix&&o.uniformMatrix4fv(this._uBaseColorMapMatrix,!1,P._state.matrix));const v=s._metallicMap;v&&v._state.texture&&this._uMetallicMap&&(n.bindTexture(this._uMetallicMap,v._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uMetallicMapMatrix&&o.uniformMatrix4fv(this._uMetallicMapMatrix,!1,v._state.matrix));const b=s._roughnessMap;b&&b._state.texture&&this._uRoughnessMap&&(n.bindTexture(this._uRoughnessMap,b._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uRoughnessMapMatrix&&o.uniformMatrix4fv(this._uRoughnessMapMatrix,!1,b._state.matrix));const C=s._metallicRoughnessMap;C&&C._state.texture&&this._uMetallicRoughnessMap&&(n.bindTexture(this._uMetallicRoughnessMap,C._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uMetallicRoughnessMapMatrix&&o.uniformMatrix4fv(this._uMetallicRoughnessMapMatrix,!1,C._state.matrix));var m=s._emissiveMap;m&&m._state.texture&&this._uEmissiveMap&&(n.bindTexture(this._uEmissiveMap,m._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uEmissiveMapMatrix&&o.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,m._state.matrix));var _=s._occlusionMap;_&&s._occlusionMap._state.texture&&this._uOcclusionMap&&(n.bindTexture(this._uOcclusionMap,_._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uOcclusionMapMatrix&&o.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,_._state.matrix));var u=s._alphaMap;u&&u._state.texture&&this._uAlphaMap&&(n.bindTexture(this._uAlphaMap,u._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uAlphaMapMatrix&&o.uniformMatrix4fv(this._uAlphaMapMatrix,!1,u._state.matrix));var B=s._normalMap;B&&B._state.texture&&this._uNormalMap&&(n.bindTexture(this._uNormalMap,B._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uNormalMapMatrix&&o.uniformMatrix4fv(this._uNormalMapMatrix,!1,B._state.matrix));break;case"SpecularMaterial":this._uMaterialDiffuse&&o.uniform3fv(this._uMaterialDiffuse,A.diffuse),this._uMaterialSpecular&&o.uniform3fv(this._uMaterialSpecular,A.specular),this._uMaterialGlossiness&&o.uniform1f(this._uMaterialGlossiness,A.glossiness),this._uMaterialReflectivity&&o.uniform1f(this._uMaterialReflectivity,A.reflectivity),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,A.emissive),this._uAlphaModeCutoff&&o.uniform4f(this._uAlphaModeCutoff,1*A.alpha,A.alphaMode===1?1:0,A.alphaCutoff,0);const I=s._diffuseMap;I&&I._state.texture&&this._uDiffuseMap&&(n.bindTexture(this._uDiffuseMap,I._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uDiffuseMapMatrix&&o.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,I._state.matrix));const E=s._specularMap;E&&E._state.texture&&this._uSpecularMap&&(n.bindTexture(this._uSpecularMap,E._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uSpecularMapMatrix&&o.uniformMatrix4fv(this._uSpecularMapMatrix,!1,E._state.matrix));const S=s._glossinessMap;S&&S._state.texture&&this._uGlossinessMap&&(n.bindTexture(this._uGlossinessMap,S._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uGlossinessMapMatrix&&o.uniformMatrix4fv(this._uGlossinessMapMatrix,!1,S._state.matrix));const R=s._specularGlossinessMap;R&&R._state.texture&&this._uSpecularGlossinessMap&&(n.bindTexture(this._uSpecularGlossinessMap,R._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uSpecularGlossinessMapMatrix&&o.uniformMatrix4fv(this._uSpecularGlossinessMapMatrix,!1,R._state.matrix));var m=s._emissiveMap;m&&m._state.texture&&this._uEmissiveMap&&(n.bindTexture(this._uEmissiveMap,m._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uEmissiveMapMatrix&&o.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,m._state.matrix));var _=s._occlusionMap;_&&_._state.texture&&this._uOcclusionMap&&(n.bindTexture(this._uOcclusionMap,_._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uOcclusionMapMatrix&&o.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,_._state.matrix));var u=s._alphaMap;u&&u._state.texture&&this._uAlphaMap&&(n.bindTexture(this._uAlphaMap,u._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uAlphaMapMatrix&&o.uniformMatrix4fv(this._uAlphaMapMatrix,!1,u._state.matrix));var B=s._normalMap;B&&B._state.texture&&this._uNormalMap&&(n.bindTexture(this._uNormalMap,B._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uNormalMapMatrix&&o.uniformMatrix4fv(this._uNormalMapMatrix,!1,B._state.matrix));break}this._lastMaterialId=A.id}if(o.uniformMatrix4fv(this._uModelMatrix,o.FALSE,e.worldMatrix),this._uModelNormalMatrix&&o.uniformMatrix4fv(this._uModelNormalMatrix,o.FALSE,e.worldNormalMatrix),this._uClippable&&o.uniform1i(this._uClippable,a.clippable),this._uColorize){const y=a.colorize,x=this._lastColorize;(x[0]!==y[0]||x[1]!==y[1]||x[2]!==y[2]||x[3]!==y[3])&&(o.uniform4fv(this._uColorize,y),x[0]=y[0],x[1]=y[1],x[2]=y[2],x[3]=y[3])}o.uniform3fv(this._uOffset,a.offset),l.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._uUVDecodeMatrix&&o.uniformMatrix3fv(this._uUVDecodeMatrix,!1,l.uvDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(l.positionsBuf),r.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(l.normalsBuf),r.bindArray++),this._aUV&&(this._aUV.bindArrayBuffer(l.uvBuf),r.bindArray++),this._aColor&&(this._aColor.bindArrayBuffer(l.colorsBuf),r.bindArray++),this._aFlags&&(this._aFlags.bindArrayBuffer(l.flagsBuf),r.bindArray++),l.indicesBuf&&(l.indicesBuf.bind(),r.bindArray++),this._lastGeometryId=l.id),l.indicesBuf?(o.drawElements(l.primitive,l.indicesBuf.numItems,l.indicesBuf.itemType,0),r.drawElements++):l.positions&&(o.drawArrays(o.TRIANGLES,0,l.positions.numItems),r.drawArrays++),f&&o.depthFunc(o.LESS)};Vi.prototype._allocate=function(r){const e=r.scene,t=e.canvas.gl,i=r._material,s=e._lightsState,o=e._sectionPlanesState,n=r._material._state;if(this._program=new Ft(t,this._shaderSource),this._program.errors){this.errors=this._program.errors;return}const a=this._program;this._uPositionsDecodeMatrix=a.getLocation("positionsDecodeMatrix"),this._uUVDecodeMatrix=a.getLocation("uvDecodeMatrix"),this._uModelMatrix=a.getLocation("modelMatrix"),this._uModelNormalMatrix=a.getLocation("modelNormalMatrix"),this._uViewMatrix=a.getLocation("viewMatrix"),this._uViewNormalMatrix=a.getLocation("viewNormalMatrix"),this._uProjMatrix=a.getLocation("projMatrix"),this._uGammaFactor=a.getLocation("gammaFactor"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[],this._uShadowViewMatrix=[],this._uShadowProjMatrix=[],e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=a.getLocation("logDepthBufFC"));const A=s.lights;let l;for(var h=0,d=A.length;h<d;h++){switch(l=A[h],l.type){case"ambient":this._uLightAmbient[h]=a.getLocation("lightAmbient");break;case"dir":this._uLightColor[h]=a.getLocation("lightColor"+h),this._uLightPos[h]=null,this._uLightDir[h]=a.getLocation("lightDir"+h);break;case"point":this._uLightColor[h]=a.getLocation("lightColor"+h),this._uLightPos[h]=a.getLocation("lightPos"+h),this._uLightDir[h]=null,this._uLightAttenuation[h]=a.getLocation("lightAttenuation"+h);break;case"spot":this._uLightColor[h]=a.getLocation("lightColor"+h),this._uLightPos[h]=a.getLocation("lightPos"+h),this._uLightDir[h]=a.getLocation("lightDir"+h),this._uLightAttenuation[h]=a.getLocation("lightAttenuation"+h);break}l.castsShadow&&(this._uShadowViewMatrix[h]=a.getLocation("shadowViewMatrix"+h),this._uShadowProjMatrix[h]=a.getLocation("shadowProjMatrix"+h))}s.lightMaps.length>0&&(this._uLightMap="lightMap"),s.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),this._uSectionPlanes=[];const f=o.sectionPlanes;for(var h=0,d=f.length;h<d;h++)this._uSectionPlanes.push({active:a.getLocation("sectionPlaneActive"+h),pos:a.getLocation("sectionPlanePos"+h),dir:a.getLocation("sectionPlaneDir"+h)});switch(this._uPointSize=a.getLocation("pointSize"),n.type){case"LambertMaterial":this._uMaterialColor=a.getLocation("materialColor"),this._uMaterialEmissive=a.getLocation("materialEmissive"),this._uAlphaModeCutoff=a.getLocation("materialAlphaModeCutoff");break;case"PhongMaterial":this._uMaterialAmbient=a.getLocation("materialAmbient"),this._uMaterialDiffuse=a.getLocation("materialDiffuse"),this._uMaterialSpecular=a.getLocation("materialSpecular"),this._uMaterialEmissive=a.getLocation("materialEmissive"),this._uAlphaModeCutoff=a.getLocation("materialAlphaModeCutoff"),this._uMaterialShininess=a.getLocation("materialShininess"),i._ambientMap&&(this._uMaterialAmbientMap="ambientMap",this._uMaterialAmbientMapMatrix=a.getLocation("ambientMapMatrix")),i._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=a.getLocation("diffuseMapMatrix")),i._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=a.getLocation("specularMapMatrix")),i._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=a.getLocation("emissiveMapMatrix")),i._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=a.getLocation("alphaMapMatrix")),i._reflectivityMap&&(this._uReflectivityMap="reflectivityMap",this._uReflectivityMapMatrix=a.getLocation("reflectivityMapMatrix")),i._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=a.getLocation("normalMapMatrix")),i._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=a.getLocation("occlusionMapMatrix")),i._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias=a.getLocation("diffuseFresnelEdgeBias"),this._uDiffuseFresnelCenterBias=a.getLocation("diffuseFresnelCenterBias"),this._uDiffuseFresnelEdgeColor=a.getLocation("diffuseFresnelEdgeColor"),this._uDiffuseFresnelCenterColor=a.getLocation("diffuseFresnelCenterColor"),this._uDiffuseFresnelPower=a.getLocation("diffuseFresnelPower")),i._specularFresnel&&(this._uSpecularFresnelEdgeBias=a.getLocation("specularFresnelEdgeBias"),this._uSpecularFresnelCenterBias=a.getLocation("specularFresnelCenterBias"),this._uSpecularFresnelEdgeColor=a.getLocation("specularFresnelEdgeColor"),this._uSpecularFresnelCenterColor=a.getLocation("specularFresnelCenterColor"),this._uSpecularFresnelPower=a.getLocation("specularFresnelPower")),i._alphaFresnel&&(this._uAlphaFresnelEdgeBias=a.getLocation("alphaFresnelEdgeBias"),this._uAlphaFresnelCenterBias=a.getLocation("alphaFresnelCenterBias"),this._uAlphaFresnelEdgeColor=a.getLocation("alphaFresnelEdgeColor"),this._uAlphaFresnelCenterColor=a.getLocation("alphaFresnelCenterColor"),this._uAlphaFresnelPower=a.getLocation("alphaFresnelPower")),i._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias=a.getLocation("reflectivityFresnelEdgeBias"),this._uReflectivityFresnelCenterBias=a.getLocation("reflectivityFresnelCenterBias"),this._uReflectivityFresnelEdgeColor=a.getLocation("reflectivityFresnelEdgeColor"),this._uReflectivityFresnelCenterColor=a.getLocation("reflectivityFresnelCenterColor"),this._uReflectivityFresnelPower=a.getLocation("reflectivityFresnelPower")),i._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias=a.getLocation("emissiveFresnelEdgeBias"),this._uEmissiveFresnelCenterBias=a.getLocation("emissiveFresnelCenterBias"),this._uEmissiveFresnelEdgeColor=a.getLocation("emissiveFresnelEdgeColor"),this._uEmissiveFresnelCenterColor=a.getLocation("emissiveFresnelCenterColor"),this._uEmissiveFresnelPower=a.getLocation("emissiveFresnelPower"));break;case"MetallicMaterial":this._uBaseColor=a.getLocation("materialBaseColor"),this._uMaterialMetallic=a.getLocation("materialMetallic"),this._uMaterialRoughness=a.getLocation("materialRoughness"),this._uMaterialSpecularF0=a.getLocation("materialSpecularF0"),this._uMaterialEmissive=a.getLocation("materialEmissive"),this._uAlphaModeCutoff=a.getLocation("materialAlphaModeCutoff"),i._baseColorMap&&(this._uBaseColorMap="baseColorMap",this._uBaseColorMapMatrix=a.getLocation("baseColorMapMatrix")),i._metallicMap&&(this._uMetallicMap="metallicMap",this._uMetallicMapMatrix=a.getLocation("metallicMapMatrix")),i._roughnessMap&&(this._uRoughnessMap="roughnessMap",this._uRoughnessMapMatrix=a.getLocation("roughnessMapMatrix")),i._metallicRoughnessMap&&(this._uMetallicRoughnessMap="metallicRoughnessMap",this._uMetallicRoughnessMapMatrix=a.getLocation("metallicRoughnessMapMatrix")),i._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=a.getLocation("emissiveMapMatrix")),i._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=a.getLocation("occlusionMapMatrix")),i._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=a.getLocation("alphaMapMatrix")),i._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=a.getLocation("normalMapMatrix"));break;case"SpecularMaterial":this._uMaterialDiffuse=a.getLocation("materialDiffuse"),this._uMaterialSpecular=a.getLocation("materialSpecular"),this._uMaterialGlossiness=a.getLocation("materialGlossiness"),this._uMaterialReflectivity=a.getLocation("reflectivityFresnel"),this._uMaterialEmissive=a.getLocation("materialEmissive"),this._uAlphaModeCutoff=a.getLocation("materialAlphaModeCutoff"),i._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=a.getLocation("diffuseMapMatrix")),i._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=a.getLocation("specularMapMatrix")),i._glossinessMap&&(this._uGlossinessMap="glossinessMap",this._uGlossinessMapMatrix=a.getLocation("glossinessMapMatrix")),i._specularGlossinessMap&&(this._uSpecularGlossinessMap="materialSpecularGlossinessMap",this._uSpecularGlossinessMapMatrix=a.getLocation("materialSpecularGlossinessMapMatrix")),i._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=a.getLocation("emissiveMapMatrix")),i._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=a.getLocation("occlusionMapMatrix")),i._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=a.getLocation("alphaMapMatrix")),i._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=a.getLocation("normalMapMatrix"));break}this._aPosition=a.getAttribute("position"),this._aNormal=a.getAttribute("normal"),this._aUV=a.getAttribute("uv"),this._aColor=a.getAttribute("color"),this._aFlags=a.getAttribute("flags"),this._uClippable=a.getLocation("clippable"),this._uColorize=a.getLocation("colorize"),this._uOffset=a.getLocation("offset"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize=new Float32Array(4),this._baseTextureUnit=0};Vi.prototype._bindProgram=function(r){const e=_t.MAX_TEXTURE_UNITS,t=this._scene,i=t.canvas.gl,s=t._lightsState,o=t.camera.project;let n;const a=this._program;if(a.bind(),r.useProgram++,r.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize[0]=-1,this._lastColorize[1]=-1,this._lastColorize[2]=-1,this._lastColorize[3]=-1,i.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),t.logarithmicDepthBufferEnabled){const h=2/(Math.log(o.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,h)}for(var A=0,l=s.lights.length;A<l;A++)if(n=s.lights[A],this._uLightAmbient[A])i.uniform4f(this._uLightAmbient[A],n.color[0],n.color[1],n.color[2],n.intensity);else if(this._uLightColor[A]&&i.uniform4f(this._uLightColor[A],n.color[0],n.color[1],n.color[2],n.intensity),this._uLightPos[A]&&(i.uniform3fv(this._uLightPos[A],n.pos),this._uLightAttenuation[A]&&i.uniform1f(this._uLightAttenuation[A],n.attenuation)),this._uLightDir[A]&&i.uniform3fv(this._uLightDir[A],n.dir),n.castsShadow){this._uShadowViewMatrix[A]&&i.uniformMatrix4fv(this._uShadowViewMatrix[A],!1,n.getShadowViewMatrix()),this._uShadowProjMatrix[A]&&i.uniformMatrix4fv(this._uShadowProjMatrix[A],!1,n.getShadowProjMatrix());const h=n.getShadowRenderBuf();h&&(a.bindTexture("shadowMap"+A,h.getTexture(),r.textureUnit),r.textureUnit=(r.textureUnit+1)%e,r.bindTexture++)}s.lightMaps.length>0&&s.lightMaps[0].texture&&this._uLightMap&&(a.bindTexture(this._uLightMap,s.lightMaps[0].texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%e,r.bindTexture++),s.reflectionMaps.length>0&&s.reflectionMaps[0].texture&&this._uReflectionMap&&(a.bindTexture(this._uReflectionMap,s.reflectionMaps[0].texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%e,r.bindTexture++),this._uGammaFactor&&i.uniform1f(this._uGammaFactor,t.gammaFactor),this._baseTextureUnit=r.textureUnit};class rB{constructor(e){this.vertex=oB(e),this.fragment=aB(e)}}function oB(r){const e=r.scene,t=e._lightsState,i=nB(r),o=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,n=!!r._geometry._state.compressGeometry,a=r._state.billboard,A=r._state.stationary,l=[];if(l.push("#version 300 es"),l.push("// EmphasisFillShaderSource vertex shader"),l.push("in vec3 position;"),l.push("uniform mat4 modelMatrix;"),l.push("uniform mat4 viewMatrix;"),l.push("uniform mat4 projMatrix;"),l.push("uniform vec4 colorize;"),l.push("uniform vec3 offset;"),n&&l.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(l.push("uniform float logDepthBufFC;"),l.push("out float vFragDepth;"),l.push("bool isPerspectiveMatrix(mat4 m) {"),l.push("    return (m[2][3] == - 1.0);"),l.push("}"),l.push("out float isPerspective;")),o&&l.push("out vec4 vWorldPosition;"),l.push("uniform vec4   lightAmbient;"),l.push("uniform vec4   fillColor;"),i){l.push("in vec3 normal;"),l.push("uniform mat4 modelNormalMatrix;"),l.push("uniform mat4 viewNormalMatrix;");for(let h=0,d=t.lights.length;h<d;h++){const f=t.lights[h];f.type!=="ambient"&&(l.push("uniform vec4 lightColor"+h+";"),f.type==="dir"&&l.push("uniform vec3 lightDir"+h+";"),f.type==="point"&&l.push("uniform vec3 lightPos"+h+";"),f.type==="spot"&&l.push("uniform vec3 lightPos"+h+";"))}n&&(l.push("vec3 octDecode(vec2 oct) {"),l.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),l.push("    if (v.z < 0.0) {"),l.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),l.push("    }"),l.push("    return normalize(v);"),l.push("}"))}if(l.push("out vec4 vColor;"),(a==="spherical"||a==="cylindrical")&&(l.push("void billboard(inout mat4 mat) {"),l.push("   mat[0][0] = 1.0;"),l.push("   mat[0][1] = 0.0;"),l.push("   mat[0][2] = 0.0;"),a==="spherical"&&(l.push("   mat[1][0] = 0.0;"),l.push("   mat[1][1] = 1.0;"),l.push("   mat[1][2] = 0.0;")),l.push("   mat[2][0] = 0.0;"),l.push("   mat[2][1] = 0.0;"),l.push("   mat[2][2] =1.0;"),l.push("}")),l.push("void main(void) {"),l.push("vec4 localPosition = vec4(position, 1.0); "),l.push("vec4 worldPosition;"),n&&l.push("localPosition = positionsDecodeMatrix * localPosition;"),i&&(n?l.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):l.push("vec4 localNormal = vec4(normal, 0.0); "),l.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),l.push("mat4 viewNormalMatrix2 = viewNormalMatrix;")),l.push("mat4 viewMatrix2 = viewMatrix;"),l.push("mat4 modelMatrix2 = modelMatrix;"),A&&l.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),a==="spherical"||a==="cylindrical"?(l.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),l.push("billboard(modelMatrix2);"),l.push("billboard(viewMatrix2);"),l.push("billboard(modelViewMatrix);"),i&&(l.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),l.push("billboard(modelNormalMatrix2);"),l.push("billboard(viewNormalMatrix2);"),l.push("billboard(modelViewNormalMatrix);")),l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("worldPosition.xyz = worldPosition.xyz + offset;"),l.push("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),i&&l.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);"),l.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),l.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),l.push("float lambertian = 1.0;"),i)for(let h=0,d=t.lights.length;h<d;h++){const f=t.lights[h];if(f.type!=="ambient"){if(f.type==="dir")f.space==="view"?l.push("viewLightDir = normalize(lightDir"+h+");"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+h+", 0.0)).xyz);");else if(f.type==="point")f.space==="view"?l.push("viewLightDir = normalize(lightPos"+h+" - viewPosition.xyz);"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightPos"+h+", 0.0)).xyz);");else continue;l.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),l.push("reflectedColor += lambertian * (lightColor"+h+".rgb * lightColor"+h+".a);")}}return l.push("vColor = vec4(reflectedColor * fillColor.rgb, fillColor.a);"),o&&l.push("vWorldPosition = worldPosition;"),r._geometry._state.primitiveName==="points"&&l.push("gl_PointSize = pointSize;"),l.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(l.push("vFragDepth = 1.0 + clipPos.w;"),l.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),l.push("gl_Position = clipPos;"),l.push("}"),l}function nB(r){const e=r._geometry._state.primitiveName;return!!((r._geometry._state.autoVertexNormals||r._geometry._state.normalsBuf)&&(e==="triangles"||e==="triangle-strip"||e==="triangle-fan"))}function aB(r){const e=r.scene,t=r.scene._sectionPlanesState,i=r.scene.gammaOutput,s=t.getNumAllocatedSectionPlanes()>0,o=[];if(o.push("#version 300 es"),o.push("// Lambertian drawing fragment shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&(o.push("in float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),i&&(o.push("uniform float gammaFactor;"),o.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}")),s){o.push("in vec4 vWorldPosition;"),o.push("uniform bool clippable;");for(let n=0,a=t.getNumAllocatedSectionPlanes();n<a;n++)o.push("uniform bool sectionPlaneActive"+n+";"),o.push("uniform vec3 sectionPlanePos"+n+";"),o.push("uniform vec3 sectionPlaneDir"+n+";")}if(o.push("in vec4 vColor;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),s){o.push("if (clippable) {"),o.push("  float dist = 0.0;");for(let n=0,a=t.getNumAllocatedSectionPlanes();n<a;n++)o.push("if (sectionPlaneActive"+n+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}return r._geometry._state.primitiveName==="points"&&(o.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),o.push("float r = dot(cxy, cxy);"),o.push("if (r > 1.0) {"),o.push("   discard;"),o.push("}")),e.logarithmicDepthBufferEnabled&&o.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i?o.push("outColor = linearToGamma(vColor, gammaFactor);"):o.push("outColor = vColor;"),o.push("}"),o}const Zf=new Si({}),AB=c.vec3(),Mi=function(r,e){this.id=Zf.addItem({}),this._hash=r,this._scene=e.scene,this._useCount=0,this._shaderSource=new rB(e),this._allocate(e)},Ll={};Mi.get=function(r){const e=[r.scene.id,r.scene.gammaOutput?"go":"",r.scene._sectionPlanesState.getHash(),r._geometry._state.normalsBuf?"n":"",r._geometry._state.compressGeometry?"cp":"",r._state.hash].join(";");let t=Ll[e];return t||(t=new Mi(e,r),Ll[e]=t,vt.memory.programs++),t._useCount++,t};Mi.prototype.put=function(){--this._useCount===0&&(Zf.removeItem(this.id),this._program&&this._program.destroy(),delete Ll[this._hash],vt.memory.programs--)};Mi.prototype.webglContextRestored=function(){this._program=null};Mi.prototype.drawMesh=function(r,e,t){this._program||this._allocate(e);const i=this._scene,s=i.camera,o=i.canvas.gl,n=t===0?e._xrayMaterial._state:t===1?e._highlightMaterial._state:e._selectedMaterial._state,a=e._state,A=e._geometry._state,l=e.origin;if(r.lastProgramId!==this._program.id&&(r.lastProgramId=this._program.id,this._bindProgram(r)),o.uniformMatrix4fv(this._uViewMatrix,!1,l?r.getRTCViewMatrix(a.originHash,l):s.viewMatrix),o.uniformMatrix4fv(this._uViewNormalMatrix,!1,s.viewNormalMatrix),a.clippable){const h=i._sectionPlanesState.getNumAllocatedSectionPlanes(),d=i._sectionPlanesState.sectionPlanes.length;if(h>0){const f=i._sectionPlanesState.sectionPlanes,m=e.renderFlags;for(let _=0;_<h;_++){const u=this._uSectionPlanes[_];if(u)if(_<d){const B=m.sectionPlanesActivePerLayer[_];if(o.uniform1i(u.active,B?1:0),B){const y=f[_];if(l){const x=Ot(y.dist,y.dir,l,AB);o.uniform3fv(u.pos,x)}else o.uniform3fv(u.pos,y.pos);o.uniform3fv(u.dir,y.dir)}}else o.uniform1i(u.active,0)}}}if(n.id!==this._lastMaterialId){const h=n.fillColor,d=n.backfaces;r.backfaces!==d&&(d?o.disable(o.CULL_FACE):o.enable(o.CULL_FACE),r.backfaces=d),o.uniform4f(this._uFillColor,h[0],h[1],h[2],n.fillAlpha),this._lastMaterialId=n.id}o.uniformMatrix4fv(this._uModelMatrix,o.FALSE,e.worldMatrix),this._uModelNormalMatrix&&o.uniformMatrix4fv(this._uModelNormalMatrix,o.FALSE,e.worldNormalMatrix),this._uClippable&&o.uniform1i(this._uClippable,a.clippable),o.uniform3fv(this._uOffset,a.offset),A.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,A.positionsDecodeMatrix),this._uUVDecodeMatrix&&o.uniformMatrix3fv(this._uUVDecodeMatrix,!1,A.uvDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(A.positionsBuf),r.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(A.normalsBuf),r.bindArray++),A.indicesBuf?(A.indicesBuf.bind(),r.bindArray++):A.positionsBuf,this._lastGeometryId=A.id),A.indicesBuf?(o.drawElements(A.primitive,A.indicesBuf.numItems,A.indicesBuf.itemType,0),r.drawElements++):A.positionsBuf&&(o.drawArrays(o.TRIANGLES,0,A.positionsBuf.numItems),r.drawArrays++)};Mi.prototype._allocate=function(r){const e=r.scene,t=e._lightsState,i=e._sectionPlanesState,s=e.canvas.gl;if(this._program=new Ft(s,this._shaderSource),this._program.errors){this.errors=this._program.errors;return}const o=this._program;this._uPositionsDecodeMatrix=o.getLocation("positionsDecodeMatrix"),this._uModelMatrix=o.getLocation("modelMatrix"),this._uModelNormalMatrix=o.getLocation("modelNormalMatrix"),this._uViewMatrix=o.getLocation("viewMatrix"),this._uViewNormalMatrix=o.getLocation("viewNormalMatrix"),this._uProjMatrix=o.getLocation("projMatrix"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(let n=0,a=t.lights.length;n<a;n++)switch(t.lights[n].type){case"ambient":this._uLightAmbient[n]=o.getLocation("lightAmbient");break;case"dir":this._uLightColor[n]=o.getLocation("lightColor"+n),this._uLightPos[n]=null,this._uLightDir[n]=o.getLocation("lightDir"+n);break;case"point":this._uLightColor[n]=o.getLocation("lightColor"+n),this._uLightPos[n]=o.getLocation("lightPos"+n),this._uLightDir[n]=null,this._uLightAttenuation[n]=o.getLocation("lightAttenuation"+n);break}this._uSectionPlanes=[];for(let n=0,a=i.getNumAllocatedSectionPlanes();n<a;n++)this._uSectionPlanes.push({active:o.getLocation("sectionPlaneActive"+n),pos:o.getLocation("sectionPlanePos"+n),dir:o.getLocation("sectionPlaneDir"+n)});this._uFillColor=o.getLocation("fillColor"),this._aPosition=o.getAttribute("position"),this._aNormal=o.getAttribute("normal"),this._uClippable=o.getLocation("clippable"),this._uGammaFactor=o.getLocation("gammaFactor"),this._uOffset=o.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=o.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null};Mi.prototype._bindProgram=function(r){const e=this._scene,t=e.canvas.gl,i=e._lightsState,s=e.camera,o=s.project;if(this._program.bind(),r.useProgram++,r.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastIndicesBufId=null,t.uniformMatrix4fv(this._uViewNormalMatrix,!1,s.normalMatrix),t.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),e.logarithmicDepthBufferEnabled){const a=2/(Math.log(o.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,a)}for(let a=0,A=i.lights.length;a<A;a++){const l=i.lights[a];this._uLightAmbient[a]?t.uniform4f(this._uLightAmbient[a],l.color[0],l.color[1],l.color[2],l.intensity):(this._uLightColor[a]&&t.uniform4f(this._uLightColor[a],l.color[0],l.color[1],l.color[2],l.intensity),this._uLightPos[a]&&(t.uniform3fv(this._uLightPos[a],l.pos),this._uLightAttenuation[a]&&t.uniform1f(this._uLightAttenuation[a],l.attenuation)),this._uLightDir[a]&&t.uniform3fv(this._uLightDir[a],l.dir))}this._uGammaFactor&&t.uniform1f(this._uGammaFactor,e.gammaFactor)};class lB{constructor(e){this.vertex=cB(e),this.fragment=hB(e)}}function cB(r){const e=r.scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=!!r._geometry._state.compressGeometry,o=r._state.billboard,n=r._state.stationary,a=[];return a.push("#version 300 es"),a.push("// Edges drawing vertex shader"),a.push("in vec3 position;"),a.push("uniform mat4 modelMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("uniform vec4 edgeColor;"),a.push("uniform vec3 offset;"),s&&a.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),a.push("out float vFragDepth;"),a.push("bool isPerspectiveMatrix(mat4 m) {"),a.push("    return (m[2][3] == - 1.0);"),a.push("}"),a.push("out float isPerspective;")),i&&a.push("out vec4 vWorldPosition;"),a.push("out vec4 vColor;"),(o==="spherical"||o==="cylindrical")&&(a.push("void billboard(inout mat4 mat) {"),a.push("   mat[0][0] = 1.0;"),a.push("   mat[0][1] = 0.0;"),a.push("   mat[0][2] = 0.0;"),o==="spherical"&&(a.push("   mat[1][0] = 0.0;"),a.push("   mat[1][1] = 1.0;"),a.push("   mat[1][2] = 0.0;")),a.push("   mat[2][0] = 0.0;"),a.push("   mat[2][1] = 0.0;"),a.push("   mat[2][2] =1.0;"),a.push("}")),a.push("void main(void) {"),a.push("vec4 localPosition = vec4(position, 1.0); "),a.push("vec4 worldPosition;"),s&&a.push("localPosition = positionsDecodeMatrix * localPosition;"),a.push("mat4 viewMatrix2 = viewMatrix;"),a.push("mat4 modelMatrix2 = modelMatrix;"),n&&a.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),o==="spherical"||o==="cylindrical"?(a.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),a.push("billboard(modelMatrix2);"),a.push("billboard(viewMatrix2);"),a.push("billboard(modelViewMatrix);"),a.push("worldPosition = modelMatrix2 * localPosition;"),a.push("worldPosition.xyz = worldPosition.xyz + offset;"),a.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(a.push("worldPosition = modelMatrix2 * localPosition;"),a.push("worldPosition.xyz = worldPosition.xyz + offset;"),a.push("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),a.push("vColor = edgeColor;"),i&&a.push("vWorldPosition = worldPosition;"),a.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(a.push("vFragDepth = 1.0 + clipPos.w;"),a.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),a.push("gl_Position = clipPos;"),a.push("}"),a}function hB(r){const e=r.scene,t=r.scene._sectionPlanesState,i=r.scene.gammaOutput,s=t.getNumAllocatedSectionPlanes()>0,o=[];if(o.push("#version 300 es"),o.push("// Edges drawing fragment shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&(o.push("in float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),i&&(o.push("uniform float gammaFactor;"),o.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}")),s){o.push("in vec4 vWorldPosition;"),o.push("uniform bool clippable;");for(let n=0,a=t.getNumAllocatedSectionPlanes();n<a;n++)o.push("uniform bool sectionPlaneActive"+n+";"),o.push("uniform vec3 sectionPlanePos"+n+";"),o.push("uniform vec3 sectionPlaneDir"+n+";")}if(o.push("in vec4 vColor;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),s){o.push("if (clippable) {"),o.push("  float dist = 0.0;");for(let n=0,a=t.getNumAllocatedSectionPlanes();n<a;n++)o.push("if (sectionPlaneActive"+n+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}return e.logarithmicDepthBufferEnabled&&o.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i?o.push("outColor = linearToGamma(vColor, gammaFactor);"):o.push("outColor = vColor;"),o.push("}"),o}const qf=new Si({}),uB=c.vec3(),fi=function(r,e){this.id=qf.addItem({}),this._hash=r,this._scene=e.scene,this._useCount=0,this._shaderSource=new lB(e),this._allocate(e)},Ul={};fi.get=function(r){const e=[r.scene.id,r.scene.gammaOutput?"go":"",r.scene._sectionPlanesState.getHash(),r._geometry._state.compressGeometry?"cp":"",r._state.hash].join(";");let t=Ul[e];return t||(t=new fi(e,r),Ul[e]=t,vt.memory.programs++),t._useCount++,t};fi.prototype.put=function(){--this._useCount===0&&(qf.removeItem(this.id),this._program&&this._program.destroy(),delete Ul[this._hash],vt.memory.programs--)};fi.prototype.webglContextRestored=function(){this._program=null};fi.prototype.drawMesh=function(r,e,t){this._program||this._allocate(e);const i=this._scene,s=i.camera,o=i.canvas.gl;let n;const a=e._state,A=e._geometry,l=A._state,h=e.origin;if(r.lastProgramId!==this._program.id&&(r.lastProgramId=this._program.id,this._bindProgram(r)),o.uniformMatrix4fv(this._uViewMatrix,!1,h?r.getRTCViewMatrix(a.originHash,h):s.viewMatrix),a.clippable){const f=i._sectionPlanesState.getNumAllocatedSectionPlanes(),m=i._sectionPlanesState.sectionPlanes.length;if(f>0){const _=i._sectionPlanesState.sectionPlanes,u=e.renderFlags;for(let B=0;B<f;B++){const y=this._uSectionPlanes[B];if(y)if(B<m){const x=u.sectionPlanesActivePerLayer[B];if(o.uniform1i(y.active,x?1:0),x){const P=_[B];if(h){const v=Ot(P.dist,P.dir,h,uB);o.uniform3fv(y.pos,v)}else o.uniform3fv(y.pos,P.pos);o.uniform3fv(y.dir,P.dir)}}else o.uniform1i(y.active,0)}}}switch(t){case 0:n=e._xrayMaterial._state;break;case 1:n=e._highlightMaterial._state;break;case 2:n=e._selectedMaterial._state;break;case 3:default:n=e._edgeMaterial._state;break}if(n.id!==this._lastMaterialId){const f=n.backfaces;if(r.backfaces!==f&&(f?o.disable(o.CULL_FACE):o.enable(o.CULL_FACE),r.backfaces=f),r.lineWidth!==n.edgeWidth&&(o.lineWidth(n.edgeWidth),r.lineWidth=n.edgeWidth),this._uEdgeColor){const m=n.edgeColor,_=n.edgeAlpha;o.uniform4f(this._uEdgeColor,m[0],m[1],m[2],_)}this._lastMaterialId=n.id}o.uniformMatrix4fv(this._uModelMatrix,o.FALSE,e.worldMatrix),this._uClippable&&o.uniform1i(this._uClippable,a.clippable),o.uniform3fv(this._uOffset,a.offset);let d;l.primitive===o.TRIANGLES?d=A._getEdgeIndices():l.primitive===o.LINES&&(d=l.indicesBuf),d&&(l.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(l.positionsBuf,l.compressGeometry?o.UNSIGNED_SHORT:o.FLOAT),r.bindArray++),d.bind(),r.bindArray++,this._lastGeometryId=l.id),o.drawElements(o.LINES,d.numItems,d.itemType,0),r.drawElements++)};fi.prototype._allocate=function(r){const e=r.scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new Ft(t,this._shaderSource),this._program.errors){this.errors=this._program.errors;return}const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let o=0,n=i.getNumAllocatedSectionPlanes();o<n;o++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+o),pos:s.getLocation("sectionPlanePos"+o),dir:s.getLocation("sectionPlaneDir"+o)});this._uEdgeColor=s.getLocation("edgeColor"),this._aPosition=s.getAttribute("position"),this._uClippable=s.getLocation("clippable"),this._uGammaFactor=s.getLocation("gammaFactor"),this._uOffset=s.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null};fi.prototype._bindProgram=function(r){const e=this._program,t=this._scene,i=t.canvas.gl,o=t.camera.project;if(e.bind(),r.useProgram++,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,i.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),t.logarithmicDepthBufferEnabled){const n=2/(Math.log(o.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,n)}this._uGammaFactor&&i.uniform1f(this._uGammaFactor,t.gammaFactor)};class dB{constructor(e){this.vertex=pB(e),this.fragment=fB(e)}}function pB(r){const e=r.scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=!!r._geometry._state.compressGeometry,o=r._state.billboard,n=r._state.stationary,a=[];return a.push("#version 300 es"),a.push("// Mesh picking vertex shader"),a.push("in vec3 position;"),a.push("uniform mat4 modelMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("out vec4 vViewPosition;"),a.push("uniform vec3 offset;"),s&&a.push("uniform mat4 positionsDecodeMatrix;"),i&&a.push("out vec4 vWorldPosition;"),e.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),a.push("out float vFragDepth;"),a.push("bool isPerspectiveMatrix(mat4 m) {"),a.push("    return (m[2][3] == - 1.0);"),a.push("}"),a.push("out float isPerspective;")),(o==="spherical"||o==="cylindrical")&&(a.push("void billboard(inout mat4 mat) {"),a.push("   mat[0][0] = 1.0;"),a.push("   mat[0][1] = 0.0;"),a.push("   mat[0][2] = 0.0;"),o==="spherical"&&(a.push("   mat[1][0] = 0.0;"),a.push("   mat[1][1] = 1.0;"),a.push("   mat[1][2] = 0.0;")),a.push("   mat[2][0] = 0.0;"),a.push("   mat[2][1] = 0.0;"),a.push("   mat[2][2] =1.0;"),a.push("}")),a.push("uniform vec2 pickClipPos;"),a.push("vec4 remapClipPos(vec4 clipPos) {"),a.push("    clipPos.xy /= clipPos.w;"),a.push("    clipPos.xy -= pickClipPos;"),a.push("    clipPos.xy *= clipPos.w;"),a.push("    return clipPos;"),a.push("}"),a.push("void main(void) {"),a.push("vec4 localPosition = vec4(position, 1.0); "),s&&a.push("localPosition = positionsDecodeMatrix * localPosition;"),a.push("mat4 viewMatrix2 = viewMatrix;"),a.push("mat4 modelMatrix2 = modelMatrix;"),n&&a.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),(o==="spherical"||o==="cylindrical")&&(a.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),a.push("billboard(modelMatrix2);"),a.push("billboard(viewMatrix2);")),a.push("   vec4 worldPosition = modelMatrix2 * localPosition;"),a.push("   worldPosition.xyz = worldPosition.xyz + offset;"),a.push("   vec4 viewPosition = viewMatrix2 * worldPosition;"),i&&a.push("   vWorldPosition = worldPosition;"),a.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(a.push("vFragDepth = 1.0 + clipPos.w;"),a.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),a.push("gl_Position = remapClipPos(clipPos);"),a.push("}"),a}function fB(r){const e=r.scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Mesh picking fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("uniform vec4 pickColor;"),i){s.push("uniform bool clippable;"),s.push("in vec4 vWorldPosition;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("if (clippable) {"),s.push("  float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outColor = pickColor; "),s.push("}"),s}const gB=c.vec3(),ns=function(r,e){this._hash=r,this._shaderSource=new dB(e),this._scene=e.scene,this._useCount=0,this._allocate(e)},Ol={};ns.get=function(r){const e=[r.scene.canvas.canvas.id,r.scene._sectionPlanesState.getHash(),r._geometry._state.hash,r._state.hash].join(";");let t=Ol[e];if(!t){if(t=new ns(e,r),t.errors)return console.log(t.errors.join(`
`)),null;Ol[e]=t,vt.memory.programs++}return t._useCount++,t};ns.prototype.put=function(){--this._useCount===0&&(this._program&&this._program.destroy(),delete Ol[this._hash],vt.memory.programs--)};ns.prototype.webglContextRestored=function(){this._program=null};ns.prototype.drawMesh=function(r,e){this._program||this._allocate(e);const t=this._scene,i=t.canvas.gl,s=e._state,o=e._material._state,n=e._geometry._state,a=e.origin;if(r.lastProgramId!==this._program.id&&(r.lastProgramId=this._program.id,this._bindProgram(r)),i.uniformMatrix4fv(this._uViewMatrix,!1,a?r.getRTCPickViewMatrix(s.originHash,a):r.pickViewMatrix),s.clippable){const m=t._sectionPlanesState.getNumAllocatedSectionPlanes(),_=t._sectionPlanesState.sectionPlanes.length;if(m>0){const u=t._sectionPlanesState.sectionPlanes,B=e.renderFlags;for(let y=0;y<m;y++){const x=this._uSectionPlanes[y];if(x)if(y<_){const P=B.sectionPlanesActivePerLayer[y];if(i.uniform1i(x.active,P?1:0),P){const v=u[y];if(a){const b=Ot(v.dist,v.dir,a,gB);i.uniform3fv(x.pos,b)}else i.uniform3fv(x.pos,v.pos);i.uniform3fv(x.dir,v.dir)}}else i.uniform1i(x.active,0)}}}if(o.id!==this._lastMaterialId){const m=o.backfaces;r.backfaces!==m&&(m?i.disable(i.CULL_FACE):i.enable(i.CULL_FACE),r.backfaces=m);const _=o.frontface;r.frontface!==_&&(_?i.frontFace(i.CCW):i.frontFace(i.CW),r.frontface=_),this._lastMaterialId=o.id}i.uniformMatrix4fv(this._uProjMatrix,!1,r.pickProjMatrix),i.uniformMatrix4fv(this._uModelMatrix,!1,e.worldMatrix),this._uClippable&&i.uniform1i(this._uClippable,e._state.clippable),i.uniform3fv(this._uOffset,e._state.offset),n.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&i.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,n.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(n.positionsBuf,n.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT),r.bindArray++),n.indicesBuf&&(n.indicesBuf.bind(),r.bindArray++),this._lastGeometryId=n.id);var A=e._state.pickID;const l=A>>24&255,h=A>>16&255,d=A>>8&255,f=A&255;i.uniform4f(this._uPickColor,f/255,d/255,h/255,l/255),i.uniform2fv(this._uPickClipPos,r.pickClipPos),n.indicesBuf?(i.drawElements(n.primitive,n.indicesBuf.numItems,n.indicesBuf.itemType,0),r.drawElements++):n.positions&&i.drawArrays(i.TRIANGLES,0,n.positions.numItems)};ns.prototype._allocate=function(r){const e=r.scene,t=e.canvas.gl;if(this._program=new Ft(t,this._shaderSource),this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uModelMatrix=i.getLocation("modelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];const s=e._sectionPlanesState.sectionPlanes;for(let o=0,n=s.length;o<n;o++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+o),pos:i.getLocation("sectionPlanePos"+o),dir:i.getLocation("sectionPlaneDir"+o)});this._aPosition=i.getAttribute("position"),this._uClippable=i.getLocation("clippable"),this._uPickColor=i.getLocation("pickColor"),this._uPickClipPos=i.getLocation("pickClipPos"),this._uOffset=i.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastGeometryId=null};ns.prototype._bindProgram=function(r){const e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),r.useProgram++,e.logarithmicDepthBufferEnabled){const s=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,s)}this._lastMaterialId=null,this._lastGeometryId=null};class mB{constructor(e){this.vertex=_B(e),this.fragment=vB(e)}}function _B(r){const e=r.scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=!!r._geometry._state.compressGeometry,o=[];return o.push("#version 300 es"),o.push("// Surface picking vertex shader"),o.push("in vec3 position;"),o.push("in vec4 color;"),o.push("uniform mat4 modelMatrix;"),o.push("uniform mat4 viewMatrix;"),o.push("uniform mat4 projMatrix;"),o.push("uniform vec3 offset;"),i&&(o.push("uniform bool clippable;"),o.push("out vec4 vWorldPosition;")),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;"),o.push("bool isPerspectiveMatrix(mat4 m) {"),o.push("    return (m[2][3] == - 1.0);"),o.push("}"),o.push("out float isPerspective;")),o.push("uniform vec2 pickClipPos;"),o.push("vec4 remapClipPos(vec4 clipPos) {"),o.push("    clipPos.xy /= clipPos.w;"),o.push("    clipPos.xy -= pickClipPos;"),o.push("    clipPos.xy *= clipPos.w;"),o.push("    return clipPos;"),o.push("}"),o.push("out vec4 vColor;"),s&&o.push("uniform mat4 positionsDecodeMatrix;"),o.push("void main(void) {"),o.push("vec4 localPosition = vec4(position, 1.0); "),s&&o.push("localPosition = positionsDecodeMatrix * localPosition;"),o.push("   vec4 worldPosition = modelMatrix * localPosition; "),o.push("   worldPosition.xyz = worldPosition.xyz + offset;"),o.push("   vec4 viewPosition = viewMatrix * worldPosition;"),i&&o.push("   vWorldPosition = worldPosition;"),o.push("   vColor = color;"),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),o.push("gl_Position = remapClipPos(clipPos);"),o.push("}"),o}function vB(r){const e=r.scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Surface picking fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in vec4 vColor;"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("uniform bool clippable;"),s.push("in vec4 vWorldPosition;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outColor = vColor;"),s.push("}"),s}const BB=c.vec3(),Qs=function(r,e){this._hash=r,this._scene=e.scene,this._useCount=0,this._shaderSource=new mB(e),this._allocate(e)},kl={};Qs.get=function(r){const e=[r.scene.canvas.canvas.id,r.scene._sectionPlanesState.getHash(),r._geometry._state.compressGeometry?"cp":"",r._state.hash].join(";");let t=kl[e];if(!t){if(t=new Qs(e,r),t.errors)return console.log(t.errors.join(`
`)),null;kl[e]=t,vt.memory.programs++}return t._useCount++,t};Qs.prototype.put=function(){--this._useCount===0&&(this._program&&this._program.destroy(),delete kl[this._hash],vt.memory.programs--)};Qs.prototype.webglContextRestored=function(){this._program=null};Qs.prototype.drawMesh=function(r,e){this._program||this._allocate(e);const t=this._scene,i=t.canvas.gl,s=e._state,o=e._material._state,n=e._geometry,a=e._geometry._state,A=e.origin,l=o.backfaces,h=o.frontface,d=t.camera.project,f=n._getPickTrianglePositions(),m=n._getPickTriangleColors();if(this._program.bind(),r.useProgram++,t.logarithmicDepthBufferEnabled){const _=2/(Math.log(d.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,_)}if(i.uniformMatrix4fv(this._uViewMatrix,!1,A?r.getRTCPickViewMatrix(s.originHash,A):r.pickViewMatrix),s.clippable){const _=t._sectionPlanesState.getNumAllocatedSectionPlanes(),u=t._sectionPlanesState.sectionPlanes.length;if(_>0){const B=t._sectionPlanesState.sectionPlanes,y=e.renderFlags;for(let x=0;x<_;x++){const P=this._uSectionPlanes[x];if(P)if(x<u){const v=y.sectionPlanesActivePerLayer[x];if(i.uniform1i(P.active,v?1:0),v){const b=B[x];if(A){const C=Ot(b.dist,b.dir,A,BB);i.uniform3fv(P.pos,C)}else i.uniform3fv(P.pos,b.pos);i.uniform3fv(P.dir,b.dir)}}else i.uniform1i(P.active,0)}}}i.uniformMatrix4fv(this._uProjMatrix,!1,r.pickProjMatrix),t.logarithmicDepthBufferEnabled&&i.uniform1f(this._uZFar,t.camera.project.far),r.backfaces!==l&&(l?i.disable(i.CULL_FACE):i.enable(i.CULL_FACE),r.backfaces=l),r.frontface!==h&&(h?i.frontFace(i.CCW):i.frontFace(i.CW),r.frontface=h),i.uniformMatrix4fv(this._uModelMatrix,!1,e.worldMatrix),this._uClippable&&i.uniform1i(this._uClippable,e._state.clippable),i.uniform3fv(this._uOffset,e._state.offset),this._uPositionsDecodeMatrix?(i.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,a.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(f,a.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT)):this._aPosition.bindArrayBuffer(f),i.uniform2fv(this._uPickClipPos,r.pickClipPos),m.bind(),i.enableVertexAttribArray(this._aColor.location),i.vertexAttribPointer(this._aColor.location,m.itemSize,m.itemType,!0,0,0),i.drawArrays(a.primitive,0,f.numItems/3)};Qs.prototype._allocate=function(r){const e=r.scene,t=e.canvas.gl;if(this._program=new Ft(t,this._shaderSource),this._useCount=0,this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uModelMatrix=i.getLocation("modelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];const s=e._sectionPlanesState.sectionPlanes;for(let o=0,n=s.length;o<n;o++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+o),pos:i.getLocation("sectionPlanePos"+o),dir:i.getLocation("sectionPlaneDir"+o)});this._aPosition=i.getAttribute("position"),this._aColor=i.getAttribute("color"),this._uPickClipPos=i.getLocation("pickClipPos"),this._uClippable=i.getLocation("clippable"),this._uOffset=i.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))};class PB{constructor(e){this.vertex=yB(e),this.fragment=xB(e)}}function yB(r){const e=r.scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=!!r._geometry._state.compressGeometry,o=r._state.billboard,n=r._state.stationary,a=[];return a.push("#version 300 es"),a.push("// Mesh occlusion vertex shader"),a.push("in vec3 position;"),a.push("uniform mat4 modelMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("uniform vec3 offset;"),s&&a.push("uniform mat4 positionsDecodeMatrix;"),i&&a.push("out vec4 vWorldPosition;"),e.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),a.push("out float vFragDepth;"),a.push("bool isPerspectiveMatrix(mat4 m) {"),a.push("    return (m[2][3] == - 1.0);"),a.push("}"),a.push("out float isPerspective;")),(o==="spherical"||o==="cylindrical")&&(a.push("void billboard(inout mat4 mat) {"),a.push("   mat[0][0] = 1.0;"),a.push("   mat[0][1] = 0.0;"),a.push("   mat[0][2] = 0.0;"),o==="spherical"&&(a.push("   mat[1][0] = 0.0;"),a.push("   mat[1][1] = 1.0;"),a.push("   mat[1][2] = 0.0;")),a.push("   mat[2][0] = 0.0;"),a.push("   mat[2][1] = 0.0;"),a.push("   mat[2][2] =1.0;"),a.push("}")),a.push("void main(void) {"),a.push("vec4 localPosition = vec4(position, 1.0); "),a.push("vec4 worldPosition;"),s&&a.push("localPosition = positionsDecodeMatrix * localPosition;"),a.push("mat4 viewMatrix2 = viewMatrix;"),a.push("mat4 modelMatrix2 = modelMatrix;"),n&&a.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),o==="spherical"||o==="cylindrical"?(a.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),a.push("billboard(modelMatrix2);"),a.push("billboard(viewMatrix2);"),a.push("billboard(modelViewMatrix);"),a.push("worldPosition = modelMatrix2 * localPosition;"),a.push("worldPosition.xyz = worldPosition.xyz + offset;"),a.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(a.push("worldPosition = modelMatrix2 * localPosition;"),a.push("worldPosition.xyz = worldPosition.xyz + offset;"),a.push("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),i&&a.push("   vWorldPosition = worldPosition;"),a.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(a.push("vFragDepth = 1.0 + clipPos.w;"),a.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),a.push("gl_Position = clipPos;"),a.push("}"),a}function xB(r){const e=r.scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Mesh occlusion fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("uniform bool clippable;"),s.push("in vec4 vWorldPosition;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("if (clippable) {"),s.push("  float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}const wB=c.vec3(),as=function(r,e){this._hash=r,this._shaderSource=new PB(e),this._scene=e.scene,this._useCount=0,this._allocate(e)},Nl={};as.get=function(r){const e=[r.scene.canvas.canvas.id,r.scene._sectionPlanesState.getHash(),r._geometry._state.hash,r._state.occlusionHash].join(";");let t=Nl[e];if(!t){if(t=new as(e,r),t.errors)return console.log(t.errors.join(`
`)),null;Nl[e]=t,vt.memory.programs++}return t._useCount++,t};as.prototype.put=function(){--this._useCount===0&&(this._program&&this._program.destroy(),delete Nl[this._hash],vt.memory.programs--)};as.prototype.webglContextRestored=function(){this._program=null};as.prototype.drawMesh=function(r,e){this._program||this._allocate(e);const t=this._scene,i=t.canvas.gl,s=e._material._state,o=e._state,n=e._geometry._state,a=e.origin;if(s.alpha<1)return;if(r.lastProgramId!==this._program.id&&(r.lastProgramId=this._program.id,this._bindProgram(r)),s.id!==this._lastMaterialId){const l=s.backfaces;r.backfaces!==l&&(l?i.disable(i.CULL_FACE):i.enable(i.CULL_FACE),r.backfaces=l);const h=s.frontface;r.frontface!==h&&(h?i.frontFace(i.CCW):i.frontFace(i.CW),r.frontface=h),this._lastMaterialId=s.id}const A=t.camera;if(i.uniformMatrix4fv(this._uViewMatrix,!1,a?r.getRTCViewMatrix(o.originHash,a):A.viewMatrix),o.clippable){const l=t._sectionPlanesState.getNumAllocatedSectionPlanes(),h=t._sectionPlanesState.sectionPlanes.length;if(l>0){const d=t._sectionPlanesState.sectionPlanes,f=e.renderFlags;for(let m=0;m<l;m++){const _=this._uSectionPlanes[m];if(_)if(m<h){const u=f.sectionPlanesActivePerLayer[m];if(i.uniform1i(_.active,u?1:0),u){const B=d[m];if(a){const y=Ot(B.dist,B.dir,a,wB);i.uniform3fv(_.pos,y)}else i.uniform3fv(_.pos,B.pos);i.uniform3fv(_.dir,B.dir)}}else i.uniform1i(_.active,0)}}}i.uniformMatrix4fv(this._uProjMatrix,!1,A._project._state.matrix),i.uniformMatrix4fv(this._uModelMatrix,i.FALSE,e.worldMatrix),this._uClippable&&i.uniform1i(this._uClippable,e._state.clippable),i.uniform3fv(this._uOffset,e._state.offset),n.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&i.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,n.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(n.positionsBuf,n.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT),r.bindArray++),n.indicesBuf&&(n.indicesBuf.bind(),r.bindArray++),this._lastGeometryId=n.id),n.indicesBuf?(i.drawElements(n.primitive,n.indicesBuf.numItems,n.indicesBuf.itemType,0),r.drawElements++):n.positions&&i.drawArrays(i.TRIANGLES,0,n.positions.numItems)};as.prototype._allocate=function(r){const e=r.scene,t=e.canvas.gl;if(this._program=new Ft(t,this._shaderSource),this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uModelMatrix=i.getLocation("modelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];const s=e._sectionPlanesState.sectionPlanes;for(let o=0,n=s.length;o<n;o++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+o),pos:i.getLocation("sectionPlanePos"+o),dir:i.getLocation("sectionPlaneDir"+o)});this._aPosition=i.getAttribute("position"),this._uClippable=i.getLocation("clippable"),this._uOffset=i.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null};as.prototype._bindProgram=function(r){const e=this._scene,t=e.camera.project,i=e.canvas.gl;if(this._program.bind(),r.useProgram++,i.uniformMatrix4fv(this._uProjMatrix,!1,t.matrix),e.logarithmicDepthBufferEnabled){const s=2/(Math.log(t.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,s)}this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null};class bB{constructor(e){this.vertex=CB(e),this.fragment=EB(e)}}function CB(r){const t=r.scene._sectionPlanesState.sectionPlanes.length>0,i=!!r._geometry._state.compressGeometry,s=[];return s.push("// Mesh shadow vertex shader"),s.push("in vec3 position;"),s.push("uniform mat4 modelMatrix;"),s.push("uniform mat4 shadowViewMatrix;"),s.push("uniform mat4 shadowProjMatrix;"),s.push("uniform vec3 offset;"),i&&s.push("uniform mat4 positionsDecodeMatrix;"),t&&s.push("out vec4 vWorldPosition;"),s.push("void main(void) {"),s.push("vec4 localPosition = vec4(position, 1.0); "),s.push("vec4 worldPosition;"),i&&s.push("localPosition = positionsDecodeMatrix * localPosition;"),s.push("worldPosition = modelMatrix * localPosition;"),s.push("worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = shadowViewMatrix * worldPosition; "),t&&s.push("vWorldPosition = worldPosition;"),s.push("   gl_Position = shadowProjMatrix * viewPosition;"),s.push("}"),s}function EB(r){const e=r.scene;e.canvas.gl;const t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("// Mesh shadow fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),i){s.push("uniform bool clippable;"),s.push("in vec4 vWorldPosition;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("vec4 encodeFloat( const in float depth ) {"),s.push("  const vec4 bitShift = vec4(256 * 256 * 256, 256 * 256, 256, 1.0);"),s.push("  const vec4 bitMask = vec4(0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);"),s.push("  vec4 comp = fract(depth * bitShift);"),s.push("  comp -= comp.xxyz * bitMask;"),s.push("  return comp;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("if (clippable) {"),s.push("  float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return s.push("outColor = encodeFloat(gl_FragCoord.z);"),s.push("}"),s}const ys=function(r,e){this._hash=r,this._shaderSource=new bB(e),this._scene=e.scene,this._useCount=0,this._allocate(e)},Ql={};ys.get=function(r){const e=r.scene,t=[e.canvas.canvas.id,e._sectionPlanesState.getHash(),r._geometry._state.hash,r._state.hash].join(";");let i=Ql[t];if(!i){if(i=new ys(t,r),i.errors)return console.log(i.errors.join(`
`)),null;Ql[t]=i,vt.memory.programs++}return i._useCount++,i};ys.prototype.put=function(){--this._useCount===0&&(this._program&&this._program.destroy(),delete Ql[this._hash],vt.memory.programs--)};ys.prototype.webglContextRestored=function(){this._program=null};ys.prototype.drawMesh=function(r,e){this._program||this._allocate(e);const i=this._scene.canvas.gl,s=e._material._state,o=e._geometry._state;if(r.lastProgramId!==this._program.id&&(r.lastProgramId=this._program.id,this._bindProgram(r)),s.id!==this._lastMaterialId){const n=s.backfaces;r.backfaces!==n&&(n?i.disable(i.CULL_FACE):i.enable(i.CULL_FACE),r.backfaces=n);const a=s.frontface;r.frontface!==a&&(a?i.frontFace(i.CCW):i.frontFace(i.CW),r.frontface=a),r.lineWidth!==s.lineWidth&&(i.lineWidth(s.lineWidth),r.lineWidth=s.lineWidth),this._uPointSize&&i.uniform1i(this._uPointSize,s.pointSize),this._lastMaterialId=s.id}if(i.uniformMatrix4fv(this._uModelMatrix,i.FALSE,e.worldMatrix),o.combineGeometry){const n=e.vertexBufs;n.id!==this._lastVertexBufsId&&(n.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(n.positionsBuf,n.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT),r.bindArray++),this._lastVertexBufsId=n.id)}this._uClippable&&i.uniform1i(this._uClippable,e._state.clippable),i.uniform3fv(this._uOffset,e._state.offset),o.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&i.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,o.positionsDecodeMatrix),o.combineGeometry?o.indicesBufCombined&&(o.indicesBufCombined.bind(),r.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(o.positionsBuf,o.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT),r.bindArray++),o.indicesBuf&&(o.indicesBuf.bind(),r.bindArray++)),this._lastGeometryId=o.id),o.combineGeometry?o.indicesBufCombined&&(i.drawElements(o.primitive,o.indicesBufCombined.numItems,o.indicesBufCombined.itemType,0),r.drawElements++):o.indicesBuf?(i.drawElements(o.primitive,o.indicesBuf.numItems,o.indicesBuf.itemType,0),r.drawElements++):o.positions&&(i.drawArrays(i.TRIANGLES,0,o.positions.numItems),r.drawArrays++)};ys.prototype._allocate=function(r){const e=r.scene,t=e.canvas.gl;if(this._program=new Ft(t,this._shaderSource),this._scene=e,this._useCount=0,this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uModelMatrix=i.getLocation("modelMatrix"),this._uShadowViewMatrix=i.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=i.getLocation("shadowProjMatrix"),this._uSectionPlanes={};const s=e._sectionPlanesState.sectionPlanes;for(let o=0,n=s.length;o<n;o++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+o),pos:i.getLocation("sectionPlanePos"+o),dir:i.getLocation("sectionPlaneDir"+o)});this._aPosition=i.getAttribute("position"),this._uClippable=i.getLocation("clippable"),this._uOffset=i.getLocation("offset"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null};ys.prototype._bindProgram=function(r){this._program||this._allocate(mesh);const e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program.bind(),r.useProgram++,t.uniformMatrix4fv(this._uShadowViewMatrix,!1,r.shadowViewMatrix),t.uniformMatrix4fv(this._uShadowProjMatrix,!1,r.shadowProjMatrix),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,i.getNumAllocatedSectionPlanes()>0){let s,o,n,a,A;for(let l=0,h=this._uSectionPlanes.length;l<h;l++)s=this._uSectionPlanes[l],o=s.active,n=i.sectionPlanes[l],o&&t.uniform1i(o,n.active),a=s.pos,a&&t.uniform3fv(s.pos,n.pos),A=s.dir,A&&t.uniform3fv(s.dir,n.dir)}};class $f{constructor(){this.visibleLayers=[],this.sectionPlanesActivePerLayer=[],this.reset()}reset(){this.culled=!1,this.sectioned=!1,this.numLayers=0,this.numVisibleLayers=0,this.colorOpaque=!1,this.colorTransparent=!1,this.edgesOpaque=!1,this.edgesTransparent=!1,this.xrayedSilhouetteOpaque=!1,this.xrayedEdgesOpaque=!1,this.xrayedSilhouetteTransparent=!1,this.xrayedEdgesTransparent=!1,this.highlightedSilhouetteOpaque=!1,this.highlightedEdgesOpaque=!1,this.highlightedSilhouetteTransparent=!1,this.highlightedEdgesTransparent=!1,this.selectedSilhouetteOpaque=!1,this.selectedEdgesOpaque=!1,this.selectedSilhouetteTransparent=!1,this.selectedEdgesTransparent=!1}}const Jh=c.OBB3(),Ri=c.vec4(),Wr=c.vec4(),Zh=c.vec4(),qh=c.vec3([1,0,0]),$h=c.vec3([0,1,0]),eu=c.vec3([0,0,1]),tu=c.vec3(3),iu=c.vec3(3),IB=c.identityMat4();class FB extends It{constructor(e,t={}){super(e,t),this.originalSystemId=t.originalSystemId||this.id,this.renderFlags=new $f,this._state=new Mt({visible:!0,culled:!1,pickable:null,clippable:null,collidable:null,occluder:t.occluder!==!1,castsShadow:null,receivesShadow:null,xrayed:!1,highlighted:!1,selected:!1,edges:!1,stationary:!!t.stationary,background:!!t.background,billboard:this._checkBillboard(t.billboard),layer:null,colorize:null,pickID:this.scene._renderer.getPickID(this),drawHash:"",pickHash:"",offset:c.vec3(),origin:null,originHash:null}),this._drawRenderer=null,this._shadowRenderer=null,this._emphasisFillRenderer=null,this._emphasisEdgesRenderer=null,this._pickMeshRenderer=null,this._pickTriangleRenderer=null,this._occlusionRenderer=null,this._geometry=t.geometry?this._checkComponent2(["ReadableGeometry","VBOGeometry"],t.geometry):this.scene.geometry,this._material=t.material?this._checkComponent2(["PhongMaterial","MetallicMaterial","SpecularMaterial","LambertMaterial"],t.material):this.scene.material,this._xrayMaterial=t.xrayMaterial?this._checkComponent("EmphasisMaterial",t.xrayMaterial):this.scene.xrayMaterial,this._highlightMaterial=t.highlightMaterial?this._checkComponent("EmphasisMaterial",t.highlightMaterial):this.scene.highlightMaterial,this._selectedMaterial=t.selectedMaterial?this._checkComponent("EmphasisMaterial",t.selectedMaterial):this.scene.selectedMaterial,this._edgeMaterial=t.edgeMaterial?this._checkComponent("EdgeMaterial",t.edgeMaterial):this.scene.edgeMaterial,this._parentNode=null,this._aabb=null,this._aabbDirty=!0,this._numTriangles=this._geometry?this._geometry.numTriangles:0,this.scene._aabbDirty=!0,this._scale=c.vec3(),this._quaternion=c.identityQuaternion(),this._rotation=c.vec3(),this._position=c.vec3(),this._worldMatrix=c.identityMat4(),this._worldNormalMatrix=c.identityMat4(),this._localMatrixDirty=!0,this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0;const i=t.origin||t.rtcCenter;if(i&&(this._state.origin=c.vec3(i),this._state.originHash=i.join()),t.matrix?this.matrix=t.matrix:(this.scale=t.scale,this.position=t.position,t.quaternion||(this.rotation=t.rotation)),this._isObject=t.isObject,this._isObject&&this.scene._registerObject(this),this._isModel=t.isModel,this._isModel&&this.scene._registerModel(this),this.visible=t.visible,this.culled=t.culled,this.pickable=t.pickable,this.clippable=t.clippable,this.collidable=t.collidable,this.castsShadow=t.castsShadow,this.receivesShadow=t.receivesShadow,this.xrayed=t.xrayed,this.highlighted=t.highlighted,this.selected=t.selected,this.edges=t.edges,this.layer=t.layer,this.colorize=t.colorize,this.opacity=t.opacity,this.offset=t.offset,t.parentId){const s=this.scene.components[t.parentId];s?s.isNode?s.addChild(this):this.error("Parent is not a Node: '"+t.parentId+"'"):this.error("Parent not found: '"+t.parentId+"'"),this._parentNode=s}else t.parent&&(t.parent.isNode||this.error("Parent is not a Node"),t.parent.addChild(this),this._parentNode=t.parent);this.compile()}get type(){return"Mesh"}get isMesh(){return!0}get parent(){return this._parentNode}get geometry(){return this._geometry}get material(){return this._material}get position(){return this._position}set position(e){this._position.set(e||[0,0,0]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get rotation(){return this._rotation}set rotation(e){this._rotation.set(e||[0,0,0]),c.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get quaternion(){return this._quaternion}set quaternion(e){this._quaternion.set(e||[0,0,0,1]),c.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get scale(){return this._scale}set scale(e){this._scale.set(e||[1,1,1]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get matrix(){return this._localMatrixDirty&&(this.__localMatrix||(this.__localMatrix=c.identityMat4()),c.composeMat4(this._position,this._quaternion,this._scale,this.__localMatrix),this._localMatrixDirty=!1),this.__localMatrix}set matrix(e){this.__localMatrix||(this.__localMatrix=c.identityMat4()),this.__localMatrix.set(e||IB),c.decomposeMat4(this.__localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._setWorldMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get worldMatrix(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix}get worldNormalMatrix(){return this._worldNormalMatrixDirty&&this._buildWorldNormalMatrix(),this._worldNormalMatrix}get isEntity(){return!0}get isModel(){return this._isModel}get isObject(){return this._isObject}get aabb(){return this._aabbDirty&&this._updateAABB(),this._aabb}get origin(){return this._state.origin}set origin(e){e?(this._state.origin||(this._state.origin=c.vec3()),this._state.origin.set(e),this._state.originHash=e.join(),this._setAABBDirty(),this.scene._aabbDirty=!0):this._state.origin&&(this._state.origin=null,this._state.originHash=null,this._setAABBDirty(),this.scene._aabbDirty=!0)}get rtcCenter(){return this.origin}set rtcCenter(e){this.origin=e}get numTriangles(){return this._numTriangles}get visible(){return this._state.visible}set visible(e){e=e!==!1,this._state.visible=e,this._isObject&&this.scene._objectVisibilityUpdated(this,e),this.glRedraw()}get xrayed(){return this._state.xrayed}set xrayed(e){e=!!e,this._state.xrayed!==e&&(this._state.xrayed=e,this._isObject&&this.scene._objectXRayedUpdated(this,e),this.glRedraw())}get highlighted(){return this._state.highlighted}set highlighted(e){e=!!e,e!==this._state.highlighted&&(this._state.highlighted=e,this._isObject&&this.scene._objectHighlightedUpdated(this,e),this.glRedraw())}get selected(){return this._state.selected}set selected(e){e=!!e,e!==this._state.selected&&(this._state.selected=e,this._isObject&&this.scene._objectSelectedUpdated(this,e),this.glRedraw())}get edges(){return this._state.edges}set edges(e){e=!!e,e!==this._state.edges&&(this._state.edges=e,this.glRedraw())}get culled(){return this._state.culled}set culled(e){this._state.culled=!!e,this.glRedraw()}get clippable(){return this._state.clippable}set clippable(e){e=e!==!1,this._state.clippable!==e&&(this._state.clippable=e,this.glRedraw())}get collidable(){return this._state.collidable}set collidable(e){e=e!==!1,e!==this._state.collidable&&(this._state.collidable=e,this._setAABBDirty(),this.scene._aabbDirty=!0)}get pickable(){return this._state.pickable}set pickable(e){e=e!==!1,this._state.pickable!==e&&(this._state.pickable=e)}get castsShadow(){return this._state.castsShadow}set castsShadow(e){e=e!==!1,e!==this._state.castsShadow&&(this._state.castsShadow=e,this.glRedraw())}get receivesShadow(){return this._state.receivesShadow}set receivesShadow(e){e=e!==!1,e!==this._state.receivesShadow&&(this._state.receivesShadow=e,this._state.hash=e?"/mod/rs;":"/mod;",this.fire("dirty",this))}get saoEnabled(){return!1}get colorize(){return this._state.colorize}set colorize(e){let t=this._state.colorize;t||(t=this._state.colorize=new Float32Array(4),t[3]=1),e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1);const i=!!e;this.scene._objectColorizeUpdated(this,i),this.glRedraw()}get opacity(){return this._state.colorize[3]}set opacity(e){let t=this._state.colorize;t||(t=this._state.colorize=new Float32Array(4),t[0]=1,t[1]=1,t[2]=1);const i=e!=null;t[3]=i?e:1,this.scene._objectOpacityUpdated(this,i),this.glRedraw()}get transparent(){return this._material.alphaMode===2||this._state.colorize[3]<1}get layer(){return this._state.layer}set layer(e){e=e||0,e=Math.round(e),e!==this._state.layer&&(this._state.layer=e,this._renderer.needStateSort())}get stationary(){return this._state.stationary}get billboard(){return this._state.billboard}get offset(){return this._state.offset}set offset(e){this._state.offset.set(e||[0,0,0]),this._setAABBDirty(),this.glRedraw()}get isDrawable(){return!0}get isStateSortable(){return!0}get xrayMaterial(){return this._xrayMaterial}get highlightMaterial(){return this._highlightMaterial}get selectedMaterial(){return this._selectedMaterial}get edgeMaterial(){return this._edgeMaterial}_checkBillboard(e){return e=e||"none",e!=="spherical"&&e!=="cylindrical"&&e!=="none"&&(this.error("Unsupported value for 'billboard': "+e+" - accepted values are 'spherical', 'cylindrical' and 'none' - defaulting to 'none'."),e="none"),e}compile(){const e=this._makeDrawHash();this._state.drawHash!==e&&(this._state.drawHash=e,this._putDrawRenderers(),this._drawRenderer=Vi.get(this),this._emphasisFillRenderer=Mi.get(this),this._emphasisEdgesRenderer=fi.get(this));const t=this._makePickHash();if(this._state.pickHash!==t&&(this._state.pickHash=t,this._putPickRenderers(),this._pickMeshRenderer=ns.get(this)),this._state.occluder){const i=this._makeOcclusionHash();this._state.occlusionHash!==i&&(this._state.occlusionHash=i,this._putOcclusionRenderer(),this._occlusionRenderer=as.get(this))}}_setLocalMatrixDirty(){this._localMatrixDirty=!0,this._setWorldMatrixDirty()}_setWorldMatrixDirty(){this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0}_buildWorldMatrix(){const e=this.matrix;if(this._parentNode)c.mulMat4(this._parentNode.worldMatrix,e,this._worldMatrix);else for(let t=0,i=e.length;t<i;t++)this._worldMatrix[t]=e[t];this._worldMatrixDirty=!1}_buildWorldNormalMatrix(){this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldNormalMatrix||(this._worldNormalMatrix=c.mat4()),c.transposeMat4(this._worldMatrix,this._worldNormalMatrix),c.inverseMat4(this._worldNormalMatrix),this._worldNormalMatrixDirty=!1}_setAABBDirty(){if(this.collidable)for(let e=this;e;e=e._parentNode)e._aabbDirty=!0}_updateAABB(){this.scene._aabbDirty=!0,this._aabb||(this._aabb=c.AABB3()),this._buildAABB(this.worldMatrix,this._aabb),this._aabbDirty=!1}_webglContextRestored(){this._drawRenderer&&this._drawRenderer.webglContextRestored(),this._shadowRenderer&&this._shadowRenderer.webglContextRestored(),this._emphasisFillRenderer&&this._emphasisFillRenderer.webglContextRestored(),this._emphasisEdgesRenderer&&this._emphasisEdgesRenderer.webglContextRestored(),this._pickMeshRenderer&&this._pickMeshRenderer.webglContextRestored(),this._pickTriangleRenderer&&this._pickMeshRenderer.webglContextRestored(),this._occlusionRenderer&&this._occlusionRenderer.webglContextRestored()}_makeDrawHash(){const e=this.scene,t=[e.canvas.canvas.id,(e.gammaInput?"gi;":";")+(e.gammaOutput?"go":""),e._lightsState.getHash(),e._sectionPlanesState.getHash()],i=this._state;return i.stationary&&t.push("/s"),i.billboard==="none"?t.push("/n"):i.billboard==="spherical"?t.push("/s"):i.billboard==="cylindrical"&&t.push("/c"),i.receivesShadow&&t.push("/rs"),t.push(";"),t.join("")}_makePickHash(){const e=this.scene,t=[e.canvas.canvas.id,e._sectionPlanesState.getHash()],i=this._state;return i.stationary&&t.push("/s"),i.billboard==="none"?t.push("/n"):i.billboard==="spherical"?t.push("/s"):i.billboard==="cylindrical"&&t.push("/c"),t.push(";"),t.join("")}_makeOcclusionHash(){const e=this.scene,t=[e.canvas.canvas.id,e._sectionPlanesState.getHash()],i=this._state;return i.stationary&&t.push("/s"),i.billboard==="none"?t.push("/n"):i.billboard==="spherical"?t.push("/s"):i.billboard==="cylindrical"&&t.push("/c"),t.push(";"),t.join("")}_buildAABB(e,t){c.transformOBB3(e,this._geometry.obb,Jh),c.OBB3ToAABB3(Jh,t);const i=this._state.offset;if(t[0]+=i[0],t[1]+=i[1],t[2]+=i[2],t[3]+=i[0],t[4]+=i[1],t[5]+=i[2],this._state.origin){const s=this._state.origin;t[0]+=s[0],t[1]+=s[1],t[2]+=s[2],t[3]+=s[0],t[4]+=s[1],t[5]+=s[2]}}rotate(e,t){return Ri[0]=e[0],Ri[1]=e[1],Ri[2]=e[2],Ri[3]=t*c.DEGTORAD,c.angleAxisToQuaternion(Ri,Wr),c.mulQuaternions(this.quaternion,Wr,Zh),this.quaternion=Zh,this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}rotateOnWorldAxis(e,t){return Ri[0]=e[0],Ri[1]=e[1],Ri[2]=e[2],Ri[3]=t*c.DEGTORAD,c.angleAxisToQuaternion(Ri,Wr),c.mulQuaternions(Wr,this.quaternion,Wr),this}rotateX(e){return this.rotate(qh,e)}rotateY(e){return this.rotate($h,e)}rotateZ(e){return this.rotate(eu,e)}translate(e,t){return c.vec3ApplyQuaternion(this.quaternion,e,tu),c.mulVec3Scalar(tu,t,iu),c.addVec3(this.position,iu,this.position),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}translateX(e){return this.translate(qh,e)}translateY(e){return this.translate($h,e)}translateZ(e){return this.translate(eu,e)}_putDrawRenderers(){this._drawRenderer&&(this._drawRenderer.put(),this._drawRenderer=null),this._shadowRenderer&&(this._shadowRenderer.put(),this._shadowRenderer=null),this._emphasisFillRenderer&&(this._emphasisFillRenderer.put(),this._emphasisFillRenderer=null),this._emphasisEdgesRenderer&&(this._emphasisEdgesRenderer.put(),this._emphasisEdgesRenderer=null)}_putPickRenderers(){this._pickMeshRenderer&&(this._pickMeshRenderer.put(),this._pickMeshRenderer=null),this._pickTriangleRenderer&&(this._pickTriangleRenderer.put(),this._pickTriangleRenderer=null)}_putOcclusionRenderer(){this._occlusionRenderer&&(this._occlusionRenderer.put(),this._occlusionRenderer=null)}stateSortCompare(e,t){return e._state.layer-t._state.layer||e._drawRenderer.id-t._drawRenderer.id||e._material._state.id-t._material._state.id||e._geometry._state.id-t._geometry._state.id}rebuildRenderFlags(){if(this.renderFlags.reset(),!this._getActiveSectionPlanes()){this.renderFlags.culled=!0;return}this.renderFlags.numLayers=1,this.renderFlags.numVisibleLayers=1,this.renderFlags.visibleLayers[0]=0,this._updateRenderFlags()}_updateRenderFlags(){const e=this.renderFlags,t=this._state;if(t.xrayed){const i=this._xrayMaterial._state;i.fill&&(i.fillAlpha<1?e.xrayedSilhouetteTransparent=!0:e.xrayedSilhouetteOpaque=!0),i.edges&&(i.edgeAlpha<1?e.xrayedEdgesTransparent=!0:e.xrayedEdgesOpaque=!0)}else if(this._material._state.alpha<1||t.colorize[3]<1?e.colorTransparent=!0:e.colorOpaque=!0,t.edges&&(this._edgeMaterial._state.alpha<1?e.edgesTransparent=!0:e.edgesOpaque=!0),t.selected){const s=this._selectedMaterial._state;s.fill&&(s.fillAlpha<1?e.selectedSilhouetteTransparent=!0:e.selectedSilhouetteOpaque=!0),s.edges&&(s.edgeAlpha<1?e.selectedEdgesTransparent=!0:e.selectedEdgesOpaque=!0)}else if(t.highlighted){const s=this._highlightMaterial._state;s.fill&&(s.fillAlpha<1?e.highlightedSilhouetteTransparent=!0:e.highlightedSilhouetteOpaque=!0),s.edges&&(s.edgeAlpha<1?e.highlightedEdgesTransparent=!0:e.highlightedEdgesOpaque=!0)}}_getActiveSectionPlanes(){if(this._state.clippable){const e=this.scene._sectionPlanesState.sectionPlanes,t=e.length;if(t>0)for(let i=0;i<t;i++){const s=e[i],o=this.renderFlags;if(!s.active)o.sectionPlanesActivePerLayer[i]=!1;else if(this._state.origin){const n=c.planeAABB3Intersect(s.dir,s.dist,this.aabb);if(n===-1)return!1;const A=n===0;o.sectionPlanesActivePerLayer[i]=A}else o.sectionPlanesActivePerLayer[i]=!0}}return!0}drawColorOpaque(e){(this._drawRenderer||(this._drawRenderer=Vi.get(this)))&&this._drawRenderer.drawMesh(e,this)}drawColorTransparent(e){(this._drawRenderer||(this._drawRenderer=Vi.get(this)))&&this._drawRenderer.drawMesh(e,this)}drawSilhouetteXRayed(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=Mi.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,0)}drawSilhouetteHighlighted(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=Mi.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,1)}drawSilhouetteSelected(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=Mi.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,2)}drawEdgesColorOpaque(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=fi.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,3)}drawEdgesColorTransparent(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=fi.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,3)}drawEdgesXRayed(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=fi.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,0)}drawEdgesHighlighted(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=fi.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,1)}drawEdgesSelected(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=fi.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,2)}drawOcclusion(e){(this._state.occluder&&this._occlusionRenderer||(this._occlusionRenderer=as.get(this)))&&this._occlusionRenderer.drawMesh(e,this)}drawShadow(e){(this._shadowRenderer||(this._shadowRenderer=ys.get(this)))&&this._shadowRenderer.drawMesh(e,this)}drawPickMesh(e){(this._pickMeshRenderer||(this._pickMeshRenderer=ns.get(this)))&&this._pickMeshRenderer.drawMesh(e,this)}canPickTriangle(){return this._geometry.isReadableGeometry}drawPickTriangles(e){(this._pickTriangleRenderer||(this._pickTriangleRenderer=Qs.get(this)))&&this._pickTriangleRenderer.drawMesh(e,this)}pickTriangleSurface(e,t,i){MB(this,e,t,i)}drawPickVertices(e){}delegatePickedEntity(){return this}destroy(){super.destroy(),this._putDrawRenderers(),this._putPickRenderers(),this._putOcclusionRenderer(),this.scene._renderer.putPickID(this._state.pickID),this._isObject&&(this.scene._deregisterObject(this),this._visible&&this.scene._objectVisibilityUpdated(this,!1,!1),this._xrayed&&this.scene._objectXRayedUpdated(this,!1,!1),this._selected&&this.scene._objectSelectedUpdated(this,!1,!1),this._highlighted&&this.scene._objectHighlightedUpdated(this,!1,!1),this.scene._objectColorizeUpdated(this,!1),this.scene._objectOpacityUpdated(this,!1),this.offset.some(e=>e!==0)&&this.scene._objectOffsetUpdated(this,!1)),this._isModel&&this.scene._deregisterModel(this),this.glRedraw()}}const MB=function(){const r=c.vec3(),e=c.vec3(),t=c.vec3(),i=c.vec3(),s=c.vec3(),o=c.vec3(),n=c.vec4(),a=c.vec3(),A=c.vec3(),l=c.vec3(),h=c.vec3(),d=c.vec3(),f=c.vec3(),m=c.vec3(),_=c.vec3(),u=c.vec3(),B=c.vec4(),y=c.vec4(),x=c.vec4(),P=c.vec3(),v=c.vec3(),b=c.vec3(),C=c.vec3(),I=c.vec3(),E=c.vec3(),S=c.vec3(),R=c.vec3(),D=c.vec3(),K=c.vec3(),j=c.vec3();return function(z,le,ue,ae){var Be=ae.primIndex;if(Be!=null&&Be>-1){const Fe=z.geometry._state,Qe=z.scene,Ge=Qe.camera,V=Qe.canvas;if(Fe.primitiveName==="triangles"){ae.primitive="triangle";const Z=Be,L=Fe.indices,Q=Fe.positions;let O,W,X;if(L){var be=L[Z+0],xe=L[Z+1],Ie=L[Z+2];o[0]=be,o[1]=xe,o[2]=Ie,ae.indices=o,O=be*3,W=xe*3,X=Ie*3}else O=Z*3,W=O+3,X=W+3;if(t[0]=Q[O+0],t[1]=Q[O+1],t[2]=Q[O+2],i[0]=Q[W+0],i[1]=Q[W+1],i[2]=Q[W+2],s[0]=Q[X+0],s[1]=Q[X+1],s[2]=Q[X+2],Fe.compressGeometry){const ie=Fe.positionsDecodeMatrix;ie&&(st.decompressPosition(t,ie,t),st.decompressPosition(i,ie,i),st.decompressPosition(s,ie,s))}ae.canvasPos?c.canvasPosToLocalRay(V.canvas,z.origin?ft(le,z.origin):le,ue,z.worldMatrix,ae.canvasPos,r,e):ae.origin&&ae.direction&&c.worldRayToLocalRay(z.worldMatrix,ae.origin,ae.direction,r,e),c.normalizeVec3(e),c.rayPlaneIntersect(r,e,t,i,s,n),ae.localPos=n,ae.position=n,B[0]=n[0],B[1]=n[1],B[2]=n[2],B[3]=1,c.transformVec4(z.worldMatrix,B,y),a[0]=y[0],a[1]=y[1],a[2]=y[2],ae.canvasPos&&z.origin&&(a[0]+=z.origin[0],a[1]+=z.origin[1],a[2]+=z.origin[2]),ae.worldPos=a,c.transformVec4(Ge.matrix,y,x),A[0]=x[0],A[1]=x[1],A[2]=x[2],ae.viewPos=A,c.cartesianToBarycentric(n,t,i,s,l),ae.bary=l;const te=Fe.normals;if(te){if(Fe.compressGeometry){const oe=be*3,he=xe*3,ce=Ie*3;st.decompressNormal(te.subarray(oe,oe+2),h),st.decompressNormal(te.subarray(he,he+2),d),st.decompressNormal(te.subarray(ce,ce+2),f)}else h[0]=te[O],h[1]=te[O+1],h[2]=te[O+2],d[0]=te[W],d[1]=te[W+1],d[2]=te[W+2],f[0]=te[X],f[1]=te[X+1],f[2]=te[X+2];const ie=c.addVec3(c.addVec3(c.mulVec3Scalar(h,l[0],P),c.mulVec3Scalar(d,l[1],v),b),c.mulVec3Scalar(f,l[2],C),I);ae.worldNormal=c.normalizeVec3(c.transformVec3(z.worldNormalMatrix,ie,E))}const se=Fe.uv;if(se){if(m[0]=se[be*2],m[1]=se[be*2+1],_[0]=se[xe*2],_[1]=se[xe*2+1],u[0]=se[Ie*2],u[1]=se[Ie*2+1],Fe.compressGeometry){const ie=Fe.uvDecodeMatrix;ie&&(st.decompressUV(m,ie,m),st.decompressUV(_,ie,_),st.decompressUV(u,ie,u))}ae.uv=c.addVec3(c.addVec3(c.mulVec2Scalar(m,l[0],S),c.mulVec2Scalar(_,l[1],R),D),c.mulVec2Scalar(u,l[2],K),j)}}}}}();function SB(r={}){const e=r.lod||1,t=r.center?r.center[0]:0,i=r.center?r.center[1]:0,s=r.center?r.center[2]:0;let o=r.radius||1;o<0&&(console.error("negative radius not allowed - will invert"),o*=-1);let n=r.heightSegments||18;n<0&&(console.error("negative heightSegments not allowed - will invert"),n*=-1),n=Math.floor(e*n),n<18&&(n=18);let a=r.widthSegments||18;a<0&&(console.error("negative widthSegments not allowed - will invert"),a*=-1),a=Math.floor(e*a),a<18&&(a=18);const A=[],l=[],h=[],d=[];let f,m,_,u,B,y,x,P,v,b,C,I,E,S,R;for(f=0;f<=n;f++)for(_=f*Math.PI/n,u=Math.sin(_),B=Math.cos(_),m=0;m<=a;m++)y=m*2*Math.PI/a,x=Math.sin(y),P=Math.cos(y),v=P*u,b=B,C=x*u,I=1-m/a,E=f/n,l.push(v),l.push(b),l.push(C),h.push(I),h.push(E),A.push(t+o*v),A.push(i+o*b),A.push(s+o*C);for(f=0;f<n;f++)for(m=0;m<a;m++)S=f*(a+1)+m,R=S+a+1,d.push(S+1),d.push(R+1),d.push(R),d.push(S+1),d.push(R),d.push(S);return Se.apply(r,{positions:A,normals:l,uv:h,indices:d})}c.vec3();c.vec4(4);c.vec4();c.vec4();c.vec3([1,0,0]);c.vec3([0,1,0]);c.vec3([0,0,1]);c.vec3(3);c.vec3(3);c.identityMat4();function Xt(r,e,t=null){let i;const s=e;if(s===Kf)return r.UNSIGNED_BYTE;if(s===Lv)return r.UNSIGNED_SHORT_4_4_4_4;if(s===Uv)return r.UNSIGNED_SHORT_5_5_5_1;if(s===Iv)return r.BYTE;if(s===Fv)return r.SHORT;if(s===Mv)return r.UNSIGNED_SHORT;if(s===Sv)return r.INT;if(s===Tv)return r.UNSIGNED_INT;if(s===Dv)return r.FLOAT;if(s===Rv)return r.HALF_FLOAT;if(s===kv)return r.ALPHA;if(s===Aa)return r.RGBA;if(s===Qv)return r.LUMINANCE;if(s===Hv)return r.LUMINANCE_ALPHA;if(s===Vv)return r.DEPTH_COMPONENT;if(s===Gv)return r.DEPTH_STENCIL;if(s===jv)return r.RED;if(s===Nv)return r.RGBA;if(s===zv)return r.RED_INTEGER;if(s===Kv)return r.RG;if(s===Wv)return r.RG_INTEGER;if(s===Xv)return r.RGBA_INTEGER;if(s===Jn||s===lA||s===cA||s===Zn)if(t===wt){const o=li(r,"WEBGL_compressed_texture_s3tc_srgb");if(o!==null){if(s===Jn)return o.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(s===lA)return o.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(s===cA)return o.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(s===Zn)return o.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else return null}else if(i=li(r,"WEBGL_compressed_texture_s3tc"),i!==null){if(s===Jn)return i.COMPRESSED_RGB_S3TC_DXT1_EXT;if(s===lA)return i.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(s===cA)return i.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(s===Zn)return i.COMPRESSED_RGBA_S3TC_DXT5_EXT}else return null;if(s===Il||s===Lh||s===Fl||s===Uh){const o=li(r,"WEBGL_compressed_texture_pvrtc");if(o!==null){if(s===Il)return o.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(s===Lh)return o.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(s===Fl)return o.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(s===Uh)return o.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}else return null}if(s===Wf){const o=li(r,"WEBGL_compressed_texture_etc1");return o!==null?o.COMPRESSED_RGB_ETC1_WEBGL:null}if(s===Ml||s===Sl){const o=li(r,"WEBGL_compressed_texture_etc");if(o!==null){if(s===Ml)return t===wt?o.COMPRESSED_SRGB8_ETC2:o.COMPRESSED_RGB8_ETC2;if(s===Sl)return t===wt?o.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:o.COMPRESSED_RGBA8_ETC2_EAC}else return null}if(s===Tl||s===Oh||s===kh||s===Nh||s===Qh||s===Hh||s===Vh||s===Gh||s===jh||s===zh||s===Kh||s===Wh||s===Xh||s===Yh){const o=li(r,"WEBGL_compressed_texture_astc");if(o!==null){if(s===Tl)return t===wt?o.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:o.COMPRESSED_RGBA_ASTC_4x4_KHR;if(s===Oh)return t===wt?o.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:o.COMPRESSED_RGBA_ASTC_5x4_KHR;if(s===kh)return t===wt?o.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:o.COMPRESSED_RGBA_ASTC_5x5_KHR;if(s===Nh)return t===wt?o.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:o.COMPRESSED_RGBA_ASTC_6x5_KHR;if(s===Qh)return t===wt?o.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:o.COMPRESSED_RGBA_ASTC_6x6_KHR;if(s===Hh)return t===wt?o.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:o.COMPRESSED_RGBA_ASTC_8x5_KHR;if(s===Vh)return t===wt?o.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:o.COMPRESSED_RGBA_ASTC_8x6_KHR;if(s===Gh)return t===wt?o.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:o.COMPRESSED_RGBA_ASTC_8x8_KHR;if(s===jh)return t===wt?o.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:o.COMPRESSED_RGBA_ASTC_10x5_KHR;if(s===zh)return t===wt?o.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:o.COMPRESSED_RGBA_ASTC_10x6_KHR;if(s===Kh)return t===wt?o.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:o.COMPRESSED_RGBA_ASTC_10x8_KHR;if(s===Wh)return t===wt?o.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:o.COMPRESSED_RGBA_ASTC_10x10_KHR;if(s===Xh)return t===wt?o.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:o.COMPRESSED_RGBA_ASTC_12x10_KHR;if(s===Yh)return t===wt?o.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:o.COMPRESSED_RGBA_ASTC_12x12_KHR}else return null}if(s===Dl){const o=li(r,"EXT_texture_compression_bptc");if(o!==null){if(s===Dl)return t===wt?o.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:o.COMPRESSED_RGBA_BPTC_UNORM_EXT}else return null}return s===Ov?r.UNSIGNED_INT_24_8:s===Ht?r.REPEAT:s===Ls?r.CLAMP_TO_EDGE:s===Bc||s===aa?r.NEAREST_MIPMAP_LINEAR:s===Pc?r.LINEAR_MIPMAP_NEAREST:s===zf?r.LINEAR_MIPMAP_LINEAR:s===To?r.NEAREST:s===Qi?r.LINEAR:null}const Li=new Uint8Array([0,0,0,1]);class Xs{constructor({gl:e,target:t,format:i,type:s,wrapS:o,wrapT:n,wrapR:a,encoding:A,preloadColor:l,premultiplyAlpha:h,flipY:d}){this.gl=e,this.target=t||e.TEXTURE_2D,this.format=i||Aa,this.type=s||Kf,this.internalFormat=null,this.premultiplyAlpha=!!h,this.flipY=!!d,this.unpackAlignment=4,this.wrapS=o||Ht,this.wrapT=n||Ht,this.wrapR=a||Ht,this.encoding=A||wt,this.texture=e.createTexture(),l&&this.setPreloadColor(l),this.allocated=!0}setPreloadColor(e){e?(Li[0]=Math.floor(e[0]*255),Li[1]=Math.floor(e[1]*255),Li[2]=Math.floor(e[2]*255),Li[3]=Math.floor((e[3]!==void 0?e[3]:1)*255)):(Li[0]=0,Li[1]=0,Li[2]=0,Li[3]=255);const t=this.gl;if(t.bindTexture(this.target,this.texture),this.target===t.TEXTURE_CUBE_MAP){const i=[t.TEXTURE_CUBE_MAP_POSITIVE_X,t.TEXTURE_CUBE_MAP_NEGATIVE_X,t.TEXTURE_CUBE_MAP_POSITIVE_Y,t.TEXTURE_CUBE_MAP_NEGATIVE_Y,t.TEXTURE_CUBE_MAP_POSITIVE_Z,t.TEXTURE_CUBE_MAP_NEGATIVE_Z];for(let s=0,o=i.length;s<o;s++)t.texImage2D(i[s],0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,Li)}else t.texImage2D(this.target,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,Li);t.bindTexture(this.target,null)}setTarget(e){this.target=e||this.gl.TEXTURE_2D}setImage(e,t={}){const i=this.gl;t.format!==void 0&&(this.format=t.format),t.internalFormat!==void 0&&(this.internalFormat=t.internalFormat),t.encoding!==void 0&&(this.encoding=t.encoding),t.type!==void 0&&(this.type=t.type),t.flipY!==void 0&&(this.flipY=t.flipY),t.premultiplyAlpha!==void 0&&(this.premultiplyAlpha=t.premultiplyAlpha),t.unpackAlignment!==void 0&&(this.unpackAlignment=t.unpackAlignment),t.minFilter!==void 0&&(this.minFilter=t.minFilter),t.magFilter!==void 0&&(this.magFilter=t.magFilter),t.wrapS!==void 0&&(this.wrapS=t.wrapS),t.wrapT!==void 0&&(this.wrapT=t.wrapT),t.wrapR!==void 0&&(this.wrapR=t.wrapR);let s=!1;i.bindTexture(this.target,this.texture);const o=i.getParameter(i.UNPACK_FLIP_Y_WEBGL);i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,this.flipY);const n=i.getParameter(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL);i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha);const a=i.getParameter(i.UNPACK_ALIGNMENT);i.pixelStorei(i.UNPACK_ALIGNMENT,this.unpackAlignment);const A=i.getParameter(i.UNPACK_COLORSPACE_CONVERSION_WEBGL);i.pixelStorei(i.UNPACK_COLORSPACE_CONVERSION_WEBGL,i.NONE);const l=Xt(i,this.minFilter);i.texParameteri(this.target,i.TEXTURE_MIN_FILTER,l),(l===i.NEAREST_MIPMAP_NEAREST||l===i.LINEAR_MIPMAP_NEAREST||l===i.NEAREST_MIPMAP_LINEAR||l===i.LINEAR_MIPMAP_LINEAR)&&(s=!0);const h=Xt(i,this.magFilter);h&&i.texParameteri(this.target,i.TEXTURE_MAG_FILTER,h);const d=Xt(i,this.wrapS);d&&i.texParameteri(this.target,i.TEXTURE_WRAP_S,d);const f=Xt(i,this.wrapT);f&&i.texParameteri(this.target,i.TEXTURE_WRAP_T,f);const m=Xt(i,this.format,this.encoding),_=Xt(i,this.type),u=su(i,this.internalFormat,m,_,this.encoding,!1);if(this.target===i.TEXTURE_CUBE_MAP){if(Se.isArray(e)){const B=e,y=[i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y,i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z];for(let x=0,P=y.length;x<P;x++)i.texImage2D(y[x],0,u,m,_,B[x])}}else i.texImage2D(i.TEXTURE_2D,0,u,m,_,e);s&&i.generateMipmap(this.target),i.bindTexture(this.target,null),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,o),i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,n),i.pixelStorei(i.UNPACK_ALIGNMENT,a),i.pixelStorei(i.UNPACK_COLORSPACE_CONVERSION_WEBGL,A)}setCompressedData({mipmaps:e,props:t={}}){const i=this.gl,s=e.length;t.format!==void 0&&(this.format=t.format),t.internalFormat!==void 0&&(this.internalFormat=t.internalFormat),t.encoding!==void 0&&(this.encoding=t.encoding),t.type!==void 0&&(this.type=t.type),t.flipY!==void 0&&(this.flipY=t.flipY),t.premultiplyAlpha!==void 0&&(this.premultiplyAlpha=t.premultiplyAlpha),t.unpackAlignment!==void 0&&(this.unpackAlignment=t.unpackAlignment),t.minFilter!==void 0&&(this.minFilter=t.minFilter),t.magFilter!==void 0&&(this.magFilter=t.magFilter),t.wrapS!==void 0&&(this.wrapS=t.wrapS),t.wrapT!==void 0&&(this.wrapT=t.wrapT),t.wrapR!==void 0&&(this.wrapR=t.wrapR),i.activeTexture(i.TEXTURE0+0),i.bindTexture(this.target,this.texture);let o=e.length>1;i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,this.flipY),i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),i.pixelStorei(i.UNPACK_ALIGNMENT,this.unpackAlignment),i.pixelStorei(i.UNPACK_COLORSPACE_CONVERSION_WEBGL,i.NONE);const n=Xt(i,this.wrapS);n&&i.texParameteri(this.target,i.TEXTURE_WRAP_S,n);const a=Xt(i,this.wrapT);if(a&&i.texParameteri(this.target,i.TEXTURE_WRAP_T,a),this.type===i.TEXTURE_3D||this.type===i.TEXTURE_2D_ARRAY){const d=Xt(i,this.wrapR);d&&i.texParameteri(this.target,i.TEXTURE_WRAP_R,d),i.texParameteri(this.type,i.TEXTURE_WRAP_R,d)}o?(i.texParameteri(this.target,i.TEXTURE_MIN_FILTER,ru(i,this.minFilter)),i.texParameteri(this.target,i.TEXTURE_MAG_FILTER,ru(i,this.magFilter))):(i.texParameteri(this.target,i.TEXTURE_MIN_FILTER,Xt(i,this.minFilter)),i.texParameteri(this.target,i.TEXTURE_MAG_FILTER,Xt(i,this.magFilter)));const A=Xt(i,this.format,this.encoding),l=Xt(i,this.type),h=su(i,this.internalFormat,A,l,this.encoding,!1);i.texStorage2D(i.TEXTURE_2D,s,h,e[0].width,e[0].height);for(let d=0,f=e.length;d<f;d++){const m=e[d];this.format!==Aa?A!==null?i.compressedTexSubImage2D(i.TEXTURE_2D,d,0,0,m.width,m.height,A,m.data):console.warn("Attempt to load unsupported compressed texture format in .setCompressedData()"):i.texSubImage2D(i.TEXTURE_2D,d,0,0,m.width,m.height,A,l,m.data)}i.bindTexture(this.target,null)}setProps(e){const t=this.gl;t.bindTexture(this.target,this.texture),this._uploadProps(e),t.bindTexture(this.target,null)}_uploadProps(e){const t=this.gl;if(e.format!==void 0&&(this.format=e.format),e.internalFormat!==void 0&&(this.internalFormat=e.internalFormat),e.encoding!==void 0&&(this.encoding=e.encoding),e.type!==void 0&&(this.type=e.type),e.minFilter!==void 0){const i=Xt(t,e.minFilter);i&&(this.minFilter=e.minFilter,t.texParameteri(this.target,t.TEXTURE_MIN_FILTER,i),(i===t.NEAREST_MIPMAP_NEAREST||i===t.LINEAR_MIPMAP_NEAREST||i===t.NEAREST_MIPMAP_LINEAR||i===t.LINEAR_MIPMAP_LINEAR)&&t.generateMipmap(this.target))}if(e.magFilter!==void 0){const i=Xt(t,e.magFilter);i&&(this.magFilter=e.magFilter,t.texParameteri(this.target,t.TEXTURE_MAG_FILTER,i))}if(e.wrapS!==void 0){const i=Xt(t,e.wrapS);i&&(this.wrapS=e.wrapS,t.texParameteri(this.target,t.TEXTURE_WRAP_S,i))}if(e.wrapT!==void 0){const i=Xt(t,e.wrapT);i&&(this.wrapT=e.wrapT,t.texParameteri(this.target,t.TEXTURE_WRAP_T,i))}}bind(e){if(this.allocated){if(this.texture){const t=this.gl;return t.activeTexture(t["TEXTURE"+e]),t.bindTexture(this.target,this.texture),!0}return!1}}unbind(e){if(this.allocated&&this.texture){const t=this.gl;t.activeTexture(t["TEXTURE"+e]),t.bindTexture(this.target,null)}}destroy(){this.allocated&&this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null)}}function su(r,e,t,i,s,o=!1){if(e!==null){if(r[e]!==void 0)return r[e];console.warn("Attempt to use non-existing WebGL internal format '"+e+"'")}let n=t;return t===r.RED&&(i===r.FLOAT&&(n=r.R32F),i===r.HALF_FLOAT&&(n=r.R16F),i===r.UNSIGNED_BYTE&&(n=r.R8)),t===r.RG&&(i===r.FLOAT&&(n=r.RG32F),i===r.HALF_FLOAT&&(n=r.RG16F),i===r.UNSIGNED_BYTE&&(n=r.RG8)),t===r.RGBA&&(i===r.FLOAT&&(n=r.RGBA32F),i===r.HALF_FLOAT&&(n=r.RGBA16F),i===r.UNSIGNED_BYTE&&(n=s===wt&&o===!1?r.SRGB8_ALPHA8:r.RGBA8),i===r.UNSIGNED_SHORT_4_4_4_4&&(n=r.RGBA4),i===r.UNSIGNED_SHORT_5_5_5_1&&(n=r.RGB5_A1)),(n===r.R16F||n===r.R32F||n===r.RG16F||n===r.RG32F||n===r.RGBA16F||n===r.RGBA32F)&&li(r,"EXT_color_buffer_float"),n}function ru(r,e){return e===To||e===Cv||e===Ev?r.NEAREST:r.LINEAR}const Es=vt.memory,ou=c.AABB3();class TB extends Gf{get type(){return"VBOGeometry"}get isVBOGeometry(){return!0}constructor(e,t={}){super(e,t),this._state=new Mt({compressGeometry:!0,primitive:null,primitiveName:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,positionsBuf:null,normalsBuf:null,colorsbuf:null,uvBuf:null,indicesBuf:null,hash:""}),this._numTriangles=0,this._edgeThreshold=t.edgeThreshold||10,this._aabb=null,this._obb=c.OBB3();const i=this._state,s=this.scene.canvas.gl;switch(t.primitive=t.primitive||"triangles",t.primitive){case"points":i.primitive=s.POINTS,i.primitiveName=t.primitive;break;case"lines":i.primitive=s.LINES,i.primitiveName=t.primitive;break;case"line-loop":i.primitive=s.LINE_LOOP,i.primitiveName=t.primitive;break;case"line-strip":i.primitive=s.LINE_STRIP,i.primitiveName=t.primitive;break;case"triangles":i.primitive=s.TRIANGLES,i.primitiveName=t.primitive;break;case"triangle-strip":i.primitive=s.TRIANGLE_STRIP,i.primitiveName=t.primitive;break;case"triangle-fan":i.primitive=s.TRIANGLE_FAN,i.primitiveName=t.primitive;break;default:this.error("Unsupported value for 'primitive': '"+t.primitive+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),i.primitive=s.TRIANGLES,i.primitiveName=t.primitive}if(!t.positions){this.error("Config expected: positions");return}if(!t.indices){this.error("Config expected: indices");return}var o;if(!t.positionsDecodeMatrix){const a=st.getPositionsBounds(t.positions),A=st.compressPositions(t.positions,a.min,a.max);o=A.quantized,i.positionsDecodeMatrix=A.decodeMatrix,i.positionsBuf=new Ee(s,s.ARRAY_BUFFER,o,o.length,3,s.STATIC_DRAW),Es.positions+=i.positionsBuf.numItems,c.positions3ToAABB3(t.positions,this._aabb),c.positions3ToAABB3(o,ou,i.positionsDecodeMatrix),c.AABB3ToOBB3(ou,this._obb)}if(t.colors){const n=t.colors.constructor===Float32Array?t.colors:new Float32Array(t.colors);i.colorsBuf=new Ee(s,s.ARRAY_BUFFER,n,n.length,4,s.STATIC_DRAW),Es.colors+=i.colorsBuf.numItems}if(t.uv){const n=st.getUVBounds(t.uv),a=st.compressUVs(t.uv,n.min,n.max),A=a.quantized;i.uvDecodeMatrix=a.decodeMatrix,i.uvBuf=new Ee(s,s.ARRAY_BUFFER,A,A.length,2,s.STATIC_DRAW),Es.uvs+=i.uvBuf.numItems}if(t.normals){const n=st.compressNormals(t.normals);let a=i.compressGeometry;i.normalsBuf=new Ee(s,s.ARRAY_BUFFER,n,n.length,3,s.STATIC_DRAW,a),Es.normals+=i.normalsBuf.numItems}{const n=t.indices.constructor===Uint32Array||t.indices.constructor===Uint16Array?t.indices:new Uint32Array(t.indices);i.indicesBuf=new Ee(s,s.ELEMENT_ARRAY_BUFFER,n,n.length,1,s.STATIC_DRAW),Es.indices+=i.indicesBuf.numItems;const a=us(o,n,i.positionsDecodeMatrix,this._edgeThreshold);this._edgeIndicesBuf=new Ee(s,s.ELEMENT_ARRAY_BUFFER,a,a.length,1,s.STATIC_DRAW),this._state.primitiveName==="triangles"&&(this._numTriangles=t.indices.length/3)}this._buildHash(),Es.meshes++}_buildHash(){const e=this._state,t=["/g"];t.push("/"+e.primitive+";"),e.positionsBuf&&t.push("p"),e.colorsBuf&&t.push("c"),(e.normalsBuf||e.autoVertexNormals)&&t.push("n"),e.uvBuf&&t.push("u"),t.push("cp"),t.push(";"),e.hash=t.join("")}_getEdgeIndices(){return this._edgeIndicesBuf}get primitive(){return this._state.primitiveName}get aabb(){return this._aabb}get obb(){return this._obb}get numTriangles(){return this._numTriangles}_getState(){return this._state}destroy(){super.destroy();const e=this._state;e.indicesBuf&&e.indicesBuf.destroy(),e.positionsBuf&&e.positionsBuf.destroy(),e.normalsBuf&&e.normalsBuf.destroy(),e.uvBuf&&e.uvBuf.destroy(),e.colorsBuf&&e.colorsBuf.destroy(),this._edgeIndicesBuf&&this._edgeIndicesBuf.destroy(),e.destroy(),Es.meshes--}}var G={};G.load=function(r,e){var t=new XMLHttpRequest;t.open("GET",r,!0),t.responseType="arraybuffer",t.onload=function(i){e(i.target.response)},t.send()};G.save=function(r,e){var t="data:application/octet-stream;base64,"+btoa(G.parse._buffToStr(r));window.location.href=t};G.clone=function(r){return JSON.parse(JSON.stringify(r))};G.bin={};G.bin.f=new Float32Array(1);G.bin.fb=new Uint8Array(G.bin.f.buffer);G.bin.rf=function(r,e){for(var t=G.bin.f,i=G.bin.fb,s=0;s<4;s++)i[s]=r[e+s];return t[0]};G.bin.rsl=function(r,e){return r[e]|r[e+1]<<8};G.bin.ril=function(r,e){return r[e]|r[e+1]<<8|r[e+2]<<16|r[e+3]<<24};G.bin.rASCII0=function(r,e){for(var t="";r[e]!=0;)t+=String.fromCharCode(r[e++]);return t};G.bin.wf=function(r,e,t){var i=new Float32Array(r.buffer,e,1);i[0]=t};G.bin.wsl=function(r,e,t){r[e]=t,r[e+1]=t>>8};G.bin.wil=function(r,e,t){r[e]=t,r[e+1]=t>>8,r[e+2]=t>>16,r[e+3]>>24};G.parse={};G.parse._buffToStr=function(r){for(var e=new Uint8Array(r),t="",i=0;i<e.length;i++)t=t.concat(String.fromCharCode(e[i]));return t};G.parse._strToBuff=function(r){for(var e=new ArrayBuffer(r.length),t=new Uint8Array(e),i=0;i<r.length;i++)t[i]=r.charCodeAt(i);return e};G.parse._readLine=function(r,e){for(var t="";r[e]!=10;)t+=String.fromCharCode(r[e++]);return t};G.parse.fromJSON=function(r){var e=JSON.parse(G.parse._buffToStr(r));return e};G.parse.toJSON=function(r){var e=JSON.stringify(r);return G.parse._strToBuff(e)};G.parse.fromOBJ=function(r){var e={};e.groups={},e.c_verts=[],e.c_uvt=[],e.c_norms=[],e.i_verts=[],e.i_uvt=[],e.i_norms=[];for(var t={from:0,to:0},i=0,s=new Uint8Array(r);i<s.length;){var o=G.parse._readLine(s,i);i+=o.length+1,o=o.replace(/ +(?= )/g,""),o=o.replace(/(^\s+|\s+$)/g,"");var n=o.split(" ");if(n[0]=="g"&&(t.to=e.i_verts.length,e.groups[n[1]]==null&&(e.groups[n[1]]={from:e.i_verts.length,to:0}),t=e.groups[n[1]]),n[0]=="v"){var a=parseFloat(n[1]),A=parseFloat(n[2]),l=parseFloat(n[3]);e.c_verts.push(a,A,l)}if(n[0]=="vt"){var a=parseFloat(n[1]),A=1-parseFloat(n[2]);e.c_uvt.push(a,A)}if(n[0]=="vn"){var a=parseFloat(n[1]),A=parseFloat(n[2]),l=parseFloat(n[3]);e.c_norms.push(a,A,l)}if(n[0]=="f"){var h=n[1].split("/"),d=n[2].split("/"),f=n[3].split("/"),m=parseInt(h[0])-1,_=parseInt(d[0])-1,u=parseInt(f[0])-1,B=parseInt(h[1])-1,y=parseInt(d[1])-1,x=parseInt(f[1])-1,P=parseInt(h[2])-1,v=parseInt(d[2])-1,b=parseInt(f[2])-1,C=e.c_verts.length/3,I=e.c_uvt.length/2,E=e.c_norms.length/3;if(m<0&&(m=C+m+1),_<0&&(_=C+_+1),u<0&&(u=C+u+1),B<0&&(B=I+B+1),y<0&&(y=I+y+1),x<0&&(x=I+x+1),P<0&&(P=E+P+1),v<0&&(v=E+v+1),b<0&&(b=E+b+1),e.i_verts.push(m,_,u),e.i_uvt.push(B,y,x),e.i_norms.push(P,v,b),n.length==5){var S=n[4].split("/"),R=parseInt(S[0])-1,D=parseInt(S[1])-1,K=parseInt(S[2])-1;R<0&&(R=C+R+1),D<0&&(D=I+D+1),K<0&&(K=E+K+1),e.i_verts.push(m,u,R),e.i_uvt.push(B,x,D),e.i_norms.push(P,b,K)}}}return t.to=e.i_verts.length,e};G.parse.fromMD2=function(r){r=new Uint8Array(r);var e={},t={};t.ident=G.bin.ril(r,0),t.version=G.bin.ril(r,4),t.skinwidth=G.bin.ril(r,8),t.skinheight=G.bin.ril(r,12),t.framesize=G.bin.ril(r,16),t.num_skins=G.bin.ril(r,20),t.num_vertices=G.bin.ril(r,24),t.num_st=G.bin.ril(r,28),t.num_tris=G.bin.ril(r,32),t.num_glcmds=G.bin.ril(r,36),t.num_frames=G.bin.ril(r,40),t.offset_skins=G.bin.ril(r,44),t.offset_st=G.bin.ril(r,48),t.offset_tris=G.bin.ril(r,52),t.offset_frames=G.bin.ril(r,56),t.offset_glcmds=G.bin.ril(r,60),t.offset_end=G.bin.ril(r,64);var A=t.offset_st;e.c_uvt=[];for(var i=0;i<t.num_st;i++){var s=G.bin.rsl(r,A)/t.skinwidth,o=G.bin.rsl(r,A+2)/t.skinheight;e.c_uvt.push(s,o),A+=4}var A=t.offset_tris,n=[],a=[];e.i_verts=n,e.i_uvt=a;for(var i=0;i<t.num_tris;i++)n.push(G.bin.rsl(r,A),G.bin.rsl(r,A+2),G.bin.rsl(r,A+4)),a.push(G.bin.rsl(r,A+6),G.bin.rsl(r,A+8),G.bin.rsl(r,A+10)),A+=12;var A=t.offset_skins;e.skins=[];for(var i=0;i<t.num_skins;i++)e.skins.push(G.bin.rASCII0(r,A)),A+=64;var A=t.offset_frames;e.frames=[];for(var l=G.parse.fromMD2._normals,i=0;i<t.num_frames;i++){var h={},d=G.bin.rf(r,A),f=G.bin.rf(r,A+4),m=G.bin.rf(r,A+8);A+=12;var _=G.bin.rf(r,A),u=G.bin.rf(r,A+4),B=G.bin.rf(r,A+8);A+=12,h.name=G.bin.rASCII0(r,A),A+=16,h.verts=[],h.norms=[];for(var y=0;y<t.num_vertices;y++)h.verts.push(r[A]*d+_,r[A+1]*f+u,r[A+2]*m+B),h.norms.push(l[3*r[A+3]],l[3*r[A+3]+1],l[3*r[A+3]+2]),A+=4;e.frames.push(h)}return e};G.parse.fromMD2._normals=[-.525731,0,.850651,-.442863,.238856,.864188,-.295242,0,.955423,-.309017,.5,.809017,-.16246,.262866,.951056,0,0,1,0,.850651,.525731,-.147621,.716567,.681718,.147621,.716567,.681718,0,.525731,.850651,.309017,.5,.809017,.525731,0,.850651,.295242,0,.955423,.442863,.238856,.864188,.16246,.262866,.951056,-.681718,.147621,.716567,-.809017,.309017,.5,-.587785,.425325,.688191,-.850651,.525731,0,-.864188,.442863,.238856,-.716567,.681718,.147621,-.688191,.587785,.425325,-.5,.809017,.309017,-.238856,.864188,.442863,-.425325,.688191,.587785,-.716567,.681718,-.147621,-.5,.809017,-.309017,-.525731,.850651,0,0,.850651,-.525731,-.238856,.864188,-.442863,0,.955423,-.295242,-.262866,.951056,-.16246,0,1,0,0,.955423,.295242,-.262866,.951056,.16246,.238856,.864188,.442863,.262866,.951056,.16246,.5,.809017,.309017,.238856,.864188,-.442863,.262866,.951056,-.16246,.5,.809017,-.309017,.850651,.525731,0,.716567,.681718,.147621,.716567,.681718,-.147621,.525731,.850651,0,.425325,.688191,.587785,.864188,.442863,.238856,.688191,.587785,.425325,.809017,.309017,.5,.681718,.147621,.716567,.587785,.425325,.688191,.955423,.295242,0,1,0,0,.951056,.16246,.262866,.850651,-.525731,0,.955423,-.295242,0,.864188,-.442863,.238856,.951056,-.16246,.262866,.809017,-.309017,.5,.681718,-.147621,.716567,.850651,0,.525731,.864188,.442863,-.238856,.809017,.309017,-.5,.951056,.16246,-.262866,.525731,0,-.850651,.681718,.147621,-.716567,.681718,-.147621,-.716567,.850651,0,-.525731,.809017,-.309017,-.5,.864188,-.442863,-.238856,.951056,-.16246,-.262866,.147621,.716567,-.681718,.309017,.5,-.809017,.425325,.688191,-.587785,.442863,.238856,-.864188,.587785,.425325,-.688191,.688191,.587785,-.425325,-.147621,.716567,-.681718,-.309017,.5,-.809017,0,.525731,-.850651,-.525731,0,-.850651,-.442863,.238856,-.864188,-.295242,0,-.955423,-.16246,.262866,-.951056,0,0,-1,.295242,0,-.955423,.16246,.262866,-.951056,-.442863,-.238856,-.864188,-.309017,-.5,-.809017,-.16246,-.262866,-.951056,0,-.850651,-.525731,-.147621,-.716567,-.681718,.147621,-.716567,-.681718,0,-.525731,-.850651,.309017,-.5,-.809017,.442863,-.238856,-.864188,.16246,-.262866,-.951056,.238856,-.864188,-.442863,.5,-.809017,-.309017,.425325,-.688191,-.587785,.716567,-.681718,-.147621,.688191,-.587785,-.425325,.587785,-.425325,-.688191,0,-.955423,-.295242,0,-1,0,.262866,-.951056,-.16246,0,-.850651,.525731,0,-.955423,.295242,.238856,-.864188,.442863,.262866,-.951056,.16246,.5,-.809017,.309017,.716567,-.681718,.147621,.525731,-.850651,0,-.238856,-.864188,-.442863,-.5,-.809017,-.309017,-.262866,-.951056,-.16246,-.850651,-.525731,0,-.716567,-.681718,-.147621,-.716567,-.681718,.147621,-.525731,-.850651,0,-.5,-.809017,.309017,-.238856,-.864188,.442863,-.262866,-.951056,.16246,-.864188,-.442863,.238856,-.809017,-.309017,.5,-.688191,-.587785,.425325,-.681718,-.147621,.716567,-.442863,-.238856,.864188,-.587785,-.425325,.688191,-.309017,-.5,.809017,-.147621,-.716567,.681718,-.425325,-.688191,.587785,-.16246,-.262866,.951056,.442863,-.238856,.864188,.16246,-.262866,.951056,.309017,-.5,.809017,.147621,-.716567,.681718,0,-.525731,.850651,.425325,-.688191,.587785,.587785,-.425325,.688191,.688191,-.587785,.425325,-.955423,.295242,0,-.951056,.16246,.262866,-1,0,0,-.850651,0,.525731,-.955423,-.295242,0,-.951056,-.16246,.262866,-.864188,.442863,-.238856,-.951056,.16246,-.262866,-.809017,.309017,-.5,-.864188,-.442863,-.238856,-.951056,-.16246,-.262866,-.809017,-.309017,-.5,-.681718,.147621,-.716567,-.681718,-.147621,-.716567,-.850651,0,-.525731,-.688191,.587785,-.425325,-.587785,.425325,-.688191,-.425325,.688191,-.587785,-.425325,-.688191,-.587785,-.587785,-.425325,-.688191,-.688191,-.587785,-.425325];G.parse.fromCollada=function(r){var e=G.parse._buffToStr(r),t=new DOMParser().parseFromString(e,"text/xml");t=t.childNodes[0];var i={},s=t.getElementsByTagName("asset")[0],o=t.getElementsByTagName("library_geometries")[0],n=t.getElementsByTagName("library_images")[0],a=t.getElementsByTagName("library_materials")[0],A=t.getElementsByTagName("library_effects")[0];return s&&(i.asset=G.parse.fromCollada._asset(s)),o&&(i.geometries=G.parse.fromCollada._libGeometries(o)),n&&(i.images=G.parse.fromCollada._libImages(n)),a&&(i.materials=G.parse.fromCollada._libMaterials(a)),A&&(i.effects=G.parse.fromCollada._libEffects(A)),i};G.parse.fromCollada._asset=function(r){return{created:r.getElementsByTagName("created")[0].textContent,modified:r.getElementsByTagName("modified")[0].textContent,up_axis:r.getElementsByTagName("up_axis")[0].textContent}};G.parse.fromCollada._libGeometries=function(r){r=r.getElementsByTagName("geometry");for(var e=[],t=0;t<r.length;t++){var i=r[t],s=G.parse.fromCollada._getMesh(i.getElementsByTagName("mesh")[0]);e.push(s)}return e};G.parse.fromCollada._getMesh=function(r){for(var e={},t=r.getElementsByTagName("source"),i=e.sources={},s=0;s<t.length;s++){for(var o=t[s].getElementsByTagName("float_array")[0].textContent.split(" "),n=o.length-(o[o.length-1]==""?1:0),a=new Array(n),A=0;A<n;A++)a[A]=parseFloat(o[A]);i[t[s].getAttribute("id")]=a}e.triangles=[];var l=r.getElementsByTagName("triangles");if(l==null)return e;for(var s=0;s<l.length;s++){var h={},d=l[s];h.material=d.getAttribute("material");for(var f=d.getElementsByTagName("input"),m=[],A=0;A<f.length;A++){var _=f[A],a=[];m[parseInt(_.getAttribute("offset"))]=a;var u=_.getAttribute("semantic");h["s_"+u]=u=="VERTEX"?r.getElementsByTagName("vertices")[0].getElementsByTagName("input")[0].getAttribute("source").substring(1):_.getAttribute("source").substring(1),h["i_"+u]=a,i[h["s_"+u]]}for(var B=d.getElementsByTagName("p")[0].textContent.split(" "),y=3*Math.floor(B.length/3),A=0;A<y;A++)m[A%f.length].push(parseInt(B[A]));e.triangles.push(h)}return e};G.parse.fromCollada._libImages=function(r){r=r.getElementsByTagName("image");for(var e={},t=0;t<r.length;t++)e[r[t].getAttribute("id")]=r[t].getElementsByTagName("init_from")[0].textContent;return e};G.parse.fromCollada._libMaterials=function(r){r=r.getElementsByTagName("material");for(var e={},t=0;t<r.length;t++)e[r[t].getAttribute("name")]=r[t].getElementsByTagName("instance_effect")[0].getAttribute("url").substring(1);return e};G.parse.fromCollada._libEffects=function(r){r=r.getElementsByTagName("effect");for(var e={},t=0;t<r.length;t++){for(var i={},s=r[t].getElementsByTagName("newparam"),o=0;o<s.length;o++){var n=s[o].getElementsByTagName("surface")[0];n&&(i.surface=n.getElementsByTagName("init_from")[0].textContent)}e[r[t].getAttribute("id")]=i}return e};G.parse.from3DS=function(r){r=new Uint8Array(r);var e={};if(G.bin.rsl(r,0)!=19789)return null;for(var t=G.bin.ril(r,2),i=6;i<t;){var s=G.bin.rsl(r,i),o=G.bin.ril(r,i+2);s==15677&&(e.edit=G.parse.from3DS._edit3ds(r,i,o)),s==45056&&(e.keyf=G.parse.from3DS._keyf3ds(r,i,o)),i+=o}return e};G.parse.from3DS._edit3ds=function(r,e,t){for(var i={},s=e+6;s<e+t;){var o=G.bin.rsl(r,s),n=G.bin.ril(r,s+2);o==16384&&(i.objects==null&&(i.objects=[]),i.objects.push(G.parse.from3DS._edit_object(r,s,n))),s+=n}return i};G.parse.from3DS._keyf3ds=function(r,e,t){for(var i={},s=e+6;s<e+t;){var o=G.bin.rsl(r,s),n=G.bin.ril(r,s+2);o==45058&&(i.desc==null&&(i.desc=[]),i.desc.push(G.parse.from3DS._keyf_objdes(r,s,n))),s+=n}return i};G.parse.from3DS._keyf_objdes=function(r,e,t){for(var i={},s=e+6;s<e+t;){var o=G.bin.rsl(r,s),n=G.bin.ril(r,s+2);o==45072&&(i.hierarchy=G.parse.from3DS._keyf_objhierarch(r,s,n)),o==45073&&(i.dummy_name=G.bin.rASCII0(r,s+6)),s+=n}return i};G.parse.from3DS._keyf_objhierarch=function(r,e,t){var i={},s=e+6;return i.name=G.bin.rASCII0(r,s),s+=i.name.length+1,i.hierarchy=G.bin.rsl(r,s+4),i};G.parse.from3DS._edit_object=function(r,e,t){var i={},s=e+6;for(i.name=G.bin.rASCII0(r,s),s+=i.name.length+1;s<e+t;){var o=G.bin.rsl(r,s),n=G.bin.ril(r,s+2);o==16640&&(i.mesh=G.parse.from3DS._obj_trimesh(r,s,n)),s+=n}return i};G.parse.from3DS._obj_trimesh=function(r,e,t){for(var i={},s=e+6;s<e+t;){var o=G.bin.rsl(r,s),n=G.bin.ril(r,s+2);o==16656&&(i.vertices=G.parse.from3DS._tri_vertexl(r,s,n)),o==16672&&(i.indices=G.parse.from3DS._tri_facel1(r,s,n)),o==16704&&(i.uvt=G.parse.from3DS._tri_mappingcoors(r,s,n)),o==16736&&(i.local=G.parse.from3DS._tri_local(r,s,n)),s+=n}return i};G.parse.from3DS._tri_vertexl=function(r,e,t){var i=[],s=e+6,o=G.bin.rsl(r,s);s+=2;for(var n=0;n<o;n++)i.push(G.bin.rf(r,s)),i.push(G.bin.rf(r,s+4)),i.push(G.bin.rf(r,s+8)),s+=12;return i};G.parse.from3DS._tri_facel1=function(r,e,t){var i=[],s=e+6,o=G.bin.rsl(r,s);s+=2;for(var n=0;n<o;n++)i.push(G.bin.rsl(r,s)),i.push(G.bin.rsl(r,s+2)),i.push(G.bin.rsl(r,s+4)),s+=8;return i};G.parse.from3DS._tri_mappingcoors=function(r,e,t){var i=[],s=e+6,o=G.bin.rsl(r,s);s+=2;for(var n=0;n<o;n++)i.push(G.bin.rf(r,s)),i.push(1-G.bin.rf(r,s+4)),s+=8;return i};G.parse.from3DS._tri_local=function(r,e,t){var i={},s=e+6;return i.X=[G.bin.rf(r,s),G.bin.rf(r,s+4),G.bin.rf(r,s+8)],s+=12,i.Y=[G.bin.rf(r,s),G.bin.rf(r,s+4),G.bin.rf(r,s+8)],s+=12,i.Z=[G.bin.rf(r,s),G.bin.rf(r,s+4),G.bin.rf(r,s+8)],s+=12,i.C=[G.bin.rf(r,s),G.bin.rf(r,s+4),G.bin.rf(r,s+8)],s+=12,i};G.parse.fromBIV=function(r){r=new Uint8Array(r);var e={},t={};return t.id=G.bin.ril(r,0),t.verS=G.bin.ril(r,4),t.texS=G.bin.ril(r,8),t.indS=G.bin.ril(r,12),t.verO=G.bin.ril(r,16),t.verL=G.bin.ril(r,20),t.texO=G.bin.ril(r,24),t.texL=G.bin.ril(r,28),t.indO=G.bin.ril(r,32),t.indL=G.bin.ril(r,36),t.verO!=0&&(e.vertices=G.parse.fromBIV._readFloats(r,t.verO,t.verL)),t.texO!=0&&(e.uvt=G.parse.fromBIV._readFloats(r,t.texO,t.texL)),t.indO!=0&&(e.indices=G.parse.fromBIV._readInts(r,t.indO,t.indL,t.indS)),e};G.parse.toBIV=function(r){for(var e=0,t=0;t<r.indices.length;t++)e=Math.max(e,r.indices[t]);var i=32;e<=65535&&(i=16);var s=40;r.vertices&&(s+=r.vertices.length*4),r.uvt&&(s+=r.uvt.length*4),r.indices&&(s+=r.indices.length*i/8);var o=new Uint8Array(s);G.bin.wil(o,0,1769365870),G.bin.wil(o,4,32),G.bin.wil(o,8,32),G.bin.wil(o,12,i);var n=40;return r.vertices&&(G.bin.wil(o,16,n),G.bin.wil(o,20,4*r.vertices.length),G.parse.fromBIV._writeFloats(o,n,r.vertices),n+=4*r.vertices.length),r.uvt&&(G.bin.wil(o,24,n),G.bin.wil(o,28,4*r.uvt.length),G.parse.fromBIV._writeFloats(o,n,r.uvt),n+=4*r.uvt.length),r.indices&&(G.bin.wil(o,32,n),G.bin.wil(o,36,4*r.indices.length),G.parse.fromBIV._writeInts(o,n,r.indices,i)),o.buffer};G.parse.fromBIV._readFloats=function(r,e,t){for(var i=[],s=0;s<t/4;s++)i.push(G.bin.rf(r,e+4*s));return i};G.parse.fromBIV._writeFloats=function(r,e,t){for(var i=0;i<t.length;i++)G.bin.wf(r,e+4*i,t[i])};G.parse.fromBIV._readInts=function(r,e,t,i){for(var s=[],o=0;o<t/4;o++)i==16&&s.push(G.bin.rsl(r,e+2*o)),i==32&&s.push(G.bin.ril(r,e+4*o));return s};G.parse.fromBIV._writeInts=function(r,e,t,i){for(var s=0;s<t.length;s++)i==16&&G.bin.wsl(r,e+2*s,t[s]),i==32&&G.bin.wil(r,e+4*s,t[s])};G.gen={};G.gen.Plane=function(r,e,t,i){t||(t=1),i||(i=1);for(var s={verts:[],inds:[],uvt:[]},o=r+1,n=e+1,a=0;a<n;a++)for(var A=0;A<o;A++){var l=-1+A*(2/r),h=-1+a*(2/e);s.verts.push(l,h,0),s.uvt.push(t*A/r,i*a/e),a<e&&A<r&&s.inds.push(a*o+A,a*o+A+1,(a+1)*o+A,a*o+A+1,(a+1)*o+A,(a+1)*o+A+1)}return s};G.gen.Cube=function(){var r={verts:[-1,1,-1,1,1,-1,-1,-1,-1,1,-1,-1,-1,1,1,1,1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,-1,1,1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,-1,1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,-1,-1,1,1,-1,1],inds:[0,1,2,1,2,3,4,5,6,5,6,7,8,9,10,9,10,11,12,13,14,13,14,15,16,17,18,17,18,19,20,21,22,21,22,23],uvt:[.25,.25,.5,.25,.25,.5,.5,.5,1,.25,.75,.25,1,.5,.75,.5,0,.25,.25,.25,0,.5,.25,.5,.75,.25,.5,.25,.75,.5,.5,.5,.25,.25,.5,.25,.25,0,.5,0,.25,.5,.5,.5,.25,.75,.5,.75]};return r};G.gen.Sphere=function(r,e){for(var t={verts:[],inds:[],uvt:[]},i=r+1,s=e+1,o=0;o<s;o++)for(var n=0;n<i;n++){var a=-Math.PI/2+o*Math.PI/e,A=n*2*Math.PI/r,l=Math.cos(a)*Math.cos(A),h=Math.sin(a),d=Math.cos(a)*Math.sin(A);t.verts.push(l,h,d),t.uvt.push(n/r,o/e),o<e&&n<r&&t.inds.push(i*o+n,i*o+n+1,i*(o+1)+n,i*o+n+1,i*(o+1)+n,i*(o+1)+n+1)}return t};G.mat={};G.mat.scale=function(r,e,t){return[r,0,0,0,0,e,0,0,0,0,t,0,0,0,0,1]};G.mat.translate=function(r,e,t){return[1,0,0,0,0,1,0,0,0,0,1,0,r,e,t,1]};G.mat.rotateDeg=function(r,e,t){var i=Math.PI/180;return G.mat.rotate(r*i,e*i,t*i)};G.mat.rotate=function(r,e,t){var i=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],s=r,o=e,n=t,a=Math.cos(s),A=Math.cos(o),l=Math.cos(n),h=Math.sin(s),d=Math.sin(o),f=Math.sin(n);return i[0]=A*l,i[1]=-A*f,i[2]=d,i[4]=a*f+h*d*l,i[5]=a*l-h*d*f,i[6]=-h*A,i[8]=h*f-a*d*l,i[9]=h*l+a*d*f,i[10]=a*A,i};G.edit={};G.edit.interpolate=function(r,e,t,i){for(var s=0;s<r.length;s++)t[s]=r[s]+i*(e[s]-r[s])};G.edit.transform=function(r,e){for(var t=0;t<r.length;t+=3){var i=r[t],s=r[t+1],o=r[t+2];r[t+0]=e[0]*i+e[4]*s+e[8]*o+e[12],r[t+1]=e[1]*i+e[5]*s+e[9]*o+e[13],r[t+2]=e[2]*i+e[6]*s+e[10]*o+e[14]}};G.edit.unwrap=function(r,e,t){for(var i=new Array(Math.floor(r.length/3)*t),s=0;s<r.length;s++)for(var o=0;o<t;o++)i[s*t+o]=e[r[s]*t+o];return i};G.edit.remap=function(r,e,t,i){for(var s=new Array(t.length),o=0;o<r.length;o++)for(var n=0;n<i;n++)s[e[o]*i+n]=t[r[o]*i+n];return s};G.utils={};G.utils.getAABB=function(r){var e,t,i,s,o,n;e=t=i=999999999,s=o=n=-e;for(var a=0;a<r.length;a+=3){var A=r[a+0],l=r[a+1],h=r[a+2];A<e&&(e=A),A>s&&(s=A),l<t&&(t=l),l>o&&(o=l),h<i&&(i=h),l>n&&(n=h)}return{min:{x:e,y:t,z:i},max:{x:s,y:o,z:n}}};const hA=c.OBB3(),un=c.OBB3(),nu=c.OBB3();class DB{constructor(e,t,i,s,o,n,a=null,A=0){this.model=e,this.object=null,this.parent=null,this.transform=o,this.textureSet=n,this._matrixDirty=!1,this._matrixUpdateScheduled=!1,this.id=t,this.obb=null,this._aabbLocal=null,this._aabbWorld=c.AABB3(),this._aabbWorldDirty=!1,this.layer=a,this.portionId=A,this._color=new Uint8Array([i[0],i[1],i[2],s]),this._colorize=new Uint8Array([i[0],i[1],i[2],s]),this._colorizing=!1,this._transparent=s<255,this.numTriangles=0,this.origin=null,this.entity=null,o&&o._addMesh(this)}_sceneModelDirty(){this._aabbWorldDirty=!0,this.layer.aabbDirty=!0}_transformDirty(){!this._matrixDirty&&!this._matrixUpdateScheduled&&(this.model._meshMatrixDirty(this),this._matrixDirty=!0,this._matrixUpdateScheduled=!0),this._aabbWorldDirty=!0,this.layer.aabbDirty=!0,this.entity&&this.entity._transformDirty()}_updateMatrix(){this.transform&&this._matrixDirty&&this.layer.setMatrix(this.portionId,this.transform.worldMatrix),this._matrixDirty=!1,this._matrixUpdateScheduled=!1}_finalize(e){this.layer.initFlags(this.portionId,e,this._transparent)}_finalize2(){this.layer.flushInitFlags&&this.layer.flushInitFlags()}_setVisible(e){this.layer.setVisible(this.portionId,e,this._transparent)}_setColor(e){this._color[0]=e[0],this._color[1]=e[1],this._color[2]=e[2],this._colorizing||this.layer.setColor(this.portionId,this._color,!1)}_setColorize(e){e?(this._colorize[0]=e[0],this._colorize[1]=e[1],this._colorize[2]=e[2],this.layer.setColor(this.portionId,this._colorize,!1),this._colorizing=!0):(this.layer.setColor(this.portionId,this._color,!1),this._colorizing=!1)}_setOpacity(e,t){const i=e<255,o=this._transparent!==i;this._color[3]=e,this._colorize[3]=e,this._transparent=i,this._colorizing?this.layer.setColor(this.portionId,this._colorize):this.layer.setColor(this.portionId,this._color),o&&this.layer.setTransparent(this.portionId,t,i)}_setOffset(e){this.layer.setOffset(this.portionId,e)}_setHighlighted(e){this.layer.setHighlighted(this.portionId,e,this._transparent)}_setXRayed(e){this.layer.setXRayed(this.portionId,e,this._transparent)}_setSelected(e){this.layer.setSelected(this.portionId,e,this._transparent)}_setEdges(e){this.layer.setEdges(this.portionId,e,this._transparent)}_setClippable(e){this.layer.setClippable(this.portionId,e,this._transparent)}_setCollidable(e){this.layer.setCollidable(this.portionId,e)}_setPickable(e){this.layer.setPickable(this.portionId,e,this._transparent)}_setCulled(e){this.layer.setCulled(this.portionId,e,this._transparent)}canPickTriangle(){return!1}drawPickTriangles(e,t){}pickTriangleSurface(e){}precisionRayPickSurface(e,t,i,s){return this.layer.precisionRayPickSurface?this.layer.precisionRayPickSurface(this.portionId,e,t,i,s):!1}canPickWorldPos(){return!0}drawPickDepths(e){this.model.drawPickDepths(e)}drawPickNormals(e){this.model.drawPickNormals(e)}delegatePickedEntity(){return this.parent}getEachVertex(e){this.layer.getEachVertex(this.portionId,e)}set aabb(e){this._aabbLocal=e}get aabb(){if(this._aabbWorldDirty){if(c.AABB3ToOBB3(this._aabbLocal,hA),this.transform?(c.transformOBB3(this.transform.worldMatrix,hA,un),c.transformOBB3(this.model.worldMatrix,un,nu),c.OBB3ToAABB3(nu,this._aabbWorld)):(c.transformOBB3(this.model.worldMatrix,hA,un),c.OBB3ToAABB3(un,this._aabbWorld)),this.origin){const e=this.origin;this._aabbWorld[0]+=e[0],this._aabbWorld[1]+=e[1],this._aabbWorld[2]+=e[2],this._aabbWorld[3]+=e[0],this._aabbWorld[4]+=e[1],this._aabbWorld[5]+=e[2]}this._aabbWorldDirty=!1}return this._aabbWorld}_destroy(){this.model.scene._renderer.putPickID(this.pickId)}}class RB{constructor(){this._uint8Arrays={},this._float32Arrays={}}_clear(){this._uint8Arrays={},this._float32Arrays={}}getUInt8Array(e){let t=this._uint8Arrays[e];return t||(t=new Uint8Array(e),this._uint8Arrays[e]=t),t}getFloat32Array(e){let t=this._float32Arrays[e];return t||(t=new Float32Array(e),this._float32Arrays[e]=t),t}}const eg=new RB;let qn=0;function LB(){return qn++,eg}function UB(){qn!==0&&(qn--,qn===0&&eg._clear())}const U={NOT_RENDERED:0,COLOR_OPAQUE:1,COLOR_TRANSPARENT:2,SILHOUETTE_HIGHLIGHTED:3,SILHOUETTE_SELECTED:4,SILHOUETTE_XRAYED:5,EDGES_COLOR_OPAQUE:6,EDGES_COLOR_TRANSPARENT:7,EDGES_HIGHLIGHTED:8,EDGES_SELECTED:9,EDGES_XRAYED:10,PICK:11},OB=new Float32Array([1,1,1,1]),kB=new Float32Array([0,0,0,1]),Xr=c.vec4(),au=c.vec3(),NB=c.vec3(),QB=c.mat4();class Wt{constructor(e,t=!1,{instancing:i=!1,edges:s=!1}={}){this._scene=e,this._withSAO=t,this._instancing=i,this._edges=s,this._hash=this._getHash(),this._matricesUniformBlockBufferBindingPoint=0,this._matricesUniformBlockBuffer=this._scene.canvas.gl.createBuffer(),this._matricesUniformBlockBufferData=new Float32Array(4*4*6),this._vaoCache=new WeakMap,this._allocate()}_getHash(){return this._scene._sectionPlanesState.getHash()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){return[""]}_buildFragmentShader(){return[""]}_addMatricesUniformBlockLines(e,t=!1){return e.push("uniform Matrices {"),e.push("    mat4 worldMatrix;"),e.push("    mat4 viewMatrix;"),e.push("    mat4 projMatrix;"),e.push("    mat4 positionsDecodeMatrix;"),t&&(e.push("    mat4 worldNormalMatrix;"),e.push("    mat4 viewNormalMatrix;")),e.push("};"),e}_addRemapClipPosLines(e,t=1){return e.push("uniform vec2 drawingBufferSize;"),e.push("uniform vec2 pickClipPos;"),e.push("vec4 remapClipPos(vec4 clipPos) {"),e.push("    clipPos.xy /= clipPos.w;"),t===1?e.push("    clipPos.xy = (clipPos.xy - pickClipPos) * drawingBufferSize;"):e.push(`    clipPos.xy = (clipPos.xy - pickClipPos) * (drawingBufferSize / float(${t}));`),e.push("    clipPos.xy *= clipPos.w;"),e.push("    return clipPos;"),e.push("}"),e}getValid(){return this._hash===this._getHash()}setSectionPlanesStateUniforms(e){const t=this._scene,{gl:i}=t.canvas,{model:s,layerIndex:o}=e,n=t._sectionPlanesState.getNumAllocatedSectionPlanes(),a=t._sectionPlanesState.sectionPlanes.length;if(n>0){const A=t._sectionPlanesState.sectionPlanes,l=o*a,h=s.renderFlags;t.crossSections&&(i.uniform4fv(this._uSliceColor,t.crossSections.sliceColor),i.uniform1f(this._uSliceThickness,t.crossSections.sliceThickness));for(let d=0;d<n;d++){const f=this._uSectionPlanes[d];if(f)if(d<a){const m=h.sectionPlanesActivePerLayer[l+d];if(i.uniform1i(f.active,m?1:0),m){const _=A[d],u=e._state.origin;if(u){const B=Ot(_.dist,_.dir,u,au);i.uniform3fv(f.pos,B)}else i.uniform3fv(f.pos,_.pos);i.uniform3fv(f.dir,_.dir)}}else i.uniform1i(f.active,0)}}}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._lightsState;if(this._program=new Ft(t,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uColor=s.getLocation("color"),this._uColor||(this._uColor=s.getLocation("silhouetteColor")),this._uUVDecodeMatrix=s.getLocation("uvDecodeMatrix"),this._uPickInvisible=s.getLocation("pickInvisible"),this._uGammaFactor=s.getLocation("gammaFactor"),t.uniformBlockBinding(s.handle,t.getUniformBlockIndex(s.handle,"Matrices"),this._matricesUniformBlockBufferBindingPoint),this._uShadowViewMatrix=s.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=s.getLocation("shadowProjMatrix"),e.logarithmicDepthBufferEnabled&&(this._uZFar=s.getLocation("zFar")),this._uLightAmbient=s.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const o=i.lights;let n;for(let a=0,A=o.length;a<A;a++)switch(n=o[a],n.type){case"dir":this._uLightColor[a]=s.getLocation("lightColor"+a),this._uLightPos[a]=null,this._uLightDir[a]=s.getLocation("lightDir"+a);break;case"point":this._uLightColor[a]=s.getLocation("lightColor"+a),this._uLightPos[a]=s.getLocation("lightPos"+a),this._uLightDir[a]=null,this._uLightAttenuation[a]=s.getLocation("lightAttenuation"+a);break;case"spot":this._uLightColor[a]=s.getLocation("lightColor"+a),this._uLightPos[a]=s.getLocation("lightPos"+a),this._uLightDir[a]=s.getLocation("lightDir"+a),this._uLightAttenuation[a]=s.getLocation("lightAttenuation"+a);break}i.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),i.lightMaps.length>0&&(this._uLightMap="lightMap"),this._uSectionPlanes=[];for(let a=0,A=e._sectionPlanesState.getNumAllocatedSectionPlanes();a<A;a++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+a),pos:s.getLocation("sectionPlanePos"+a),dir:s.getLocation("sectionPlaneDir"+a)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aNormal=s.getAttribute("normal"),this._aUV=s.getAttribute("uv"),this._aColor=s.getAttribute("color"),this._aMetallicRoughness=s.getAttribute("metallicRoughness"),this._aFlags=s.getAttribute("flags"),this._aPickColor=s.getAttribute("pickColor"),this._uPickZNear=s.getLocation("pickZNear"),this._uPickZFar=s.getLocation("pickZFar"),this._uPickClipPos=s.getLocation("pickClipPos"),this._uDrawingBufferSize=s.getLocation("drawingBufferSize"),this._uColorMap="uColorMap",this._uMetallicRoughMap="uMetallicRoughMap",this._uEmissiveMap="uEmissiveMap",this._uNormalMap="uNormalMap",this._uAOMap="uAOMap",this._instancing&&(this._aModelMatrix=s.getAttribute("modelMatrix"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._aModelNormalMatrixCol0=s.getAttribute("modelNormalMatrixCol0"),this._aModelNormalMatrixCol1=s.getAttribute("modelNormalMatrixCol1"),this._aModelNormalMatrixCol2=s.getAttribute("modelNormalMatrixCol2")),this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=s.getLocation("uSAOParams")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),e.pointsMaterial._state.filterIntensity&&(this._uIntensityRange=s.getLocation("intensityRange")),this._uPointSize=s.getLocation("pointSize"),this._uNearPlaneHeight=s.getLocation("nearPlaneHeight"),e.crossSections&&(this._uSliceColor=s.getLocation("sliceColor"),this._uSliceThickness=s.getLocation("sliceThickness"))}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=this._program,o=t._lightsState,n=o.lights;s.bind(),e.textureUnit=0,this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,o.getAmbientColorAndIntensity()),this._uGammaFactor&&i.uniform1f(this._uGammaFactor,t.gammaFactor);for(let a=0,A=n.length;a<A;a++){const l=n[a];this._uLightColor[a]&&i.uniform4f(this._uLightColor[a],l.color[0],l.color[1],l.color[2],l.intensity),this._uLightPos[a]&&(i.uniform3fv(this._uLightPos[a],l.pos),this._uLightAttenuation[a]&&i.uniform1f(this._uLightAttenuation[a],l.attenuation)),this._uLightDir[a]&&i.uniform3fv(this._uLightDir[a],l.dir)}}_makeVAO(e){const t=this._scene.canvas.gl,i=t.createVertexArray();return t.bindVertexArray(i),this._instancing&&(this._aModelMatrixCol0.bindArrayBuffer(e.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(e.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(e.modelMatrixCol2Buf),t.vertexAttribDivisor(this._aModelMatrixCol0.location,1),t.vertexAttribDivisor(this._aModelMatrixCol1.location,1),t.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aModelNormalMatrixCol0&&(this._aModelNormalMatrixCol0.bindArrayBuffer(e.modelNormalMatrixCol0Buf),t.vertexAttribDivisor(this._aModelNormalMatrixCol0.location,1)),this._aModelNormalMatrixCol1&&(this._aModelNormalMatrixCol1.bindArrayBuffer(e.modelNormalMatrixCol1Buf),t.vertexAttribDivisor(this._aModelNormalMatrixCol1.location,1)),this._aModelNormalMatrixCol2&&(this._aModelNormalMatrixCol2.bindArrayBuffer(e.modelNormalMatrixCol2Buf),t.vertexAttribDivisor(this._aModelNormalMatrixCol2.location,1))),this._aPosition.bindArrayBuffer(e.positionsBuf),this._aUV&&this._aUV.bindArrayBuffer(e.uvBuf),this._aNormal&&this._aNormal.bindArrayBuffer(e.normalsBuf),this._aMetallicRoughness&&(this._aMetallicRoughness.bindArrayBuffer(e.metallicRoughnessBuf),this._instancing&&t.vertexAttribDivisor(this._aMetallicRoughness.location,1)),this._aColor&&(this._aColor.bindArrayBuffer(e.colorsBuf),this._instancing&&e.colorsBuf&&t.vertexAttribDivisor(this._aColor.location,1)),this._aFlags&&(this._aFlags.bindArrayBuffer(e.flagsBuf),this._instancing&&t.vertexAttribDivisor(this._aFlags.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(e.offsetsBuf),this._instancing&&t.vertexAttribDivisor(this._aOffset.location,1)),this._aPickColor&&(this._aPickColor.bindArrayBuffer(e.pickColorsBuf),this._instancing&&t.vertexAttribDivisor(this._aPickColor.location,1)),this._instancing?this._edges?e.edgeIndicesBuf.bind():e.indicesBuf&&e.indicesBuf.bind():this._edges?e.edgeIndicesBuf.bind():e.indicesBuf&&e.indicesBuf.bind(),i}drawLayer(e,t,i,{colorUniform:s=!1,incrementDrawState:o=!1}={}){const n=_t.MAX_TEXTURE_IMAGE_UNITS,a=this._scene,A=a.canvas.gl,{_state:l,model:h}=t,{textureSet:d,origin:f,positionsDecodeMatrix:m}=l,_=a._lightsState,u=a.pointsMaterial,{camera:B}=h.scene,{viewNormalMatrix:y,project:x}=B,P=e.pickViewMatrix||B.viewMatrix,{position:v,rotationMatrix:b,rotationMatrixConjugate:C,worldNormalMatrix:I}=h;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),this._vaoCache.has(t)?A.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(l));let E=0;const S=4*4;this._matricesUniformBlockBufferData.set(C,0);const R=f[0]!==0||f[1]!==0||f[2]!==0,D=v[0]!==0||v[1]!==0||v[2]!==0;if(R||D){const K=au;if(R){const j=c.transformPoint3(b,f,NB);K[0]=j[0],K[1]=j[1],K[2]=j[2]}else K[0]=0,K[1]=0,K[2]=0;K[0]+=v[0],K[1]+=v[1],K[2]+=v[2],this._matricesUniformBlockBufferData.set(ft(P,K,QB),E+=S)}else this._matricesUniformBlockBufferData.set(P,E+=S);if(this._matricesUniformBlockBufferData.set(e.pickProjMatrix||x.matrix,E+=S),this._matricesUniformBlockBufferData.set(m,E+=S),this._matricesUniformBlockBufferData.set(I,E+=S),this._matricesUniformBlockBufferData.set(y,E+=S),A.bindBuffer(A.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),A.bufferData(A.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,A.DYNAMIC_DRAW),A.bindBufferBase(A.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer),A.uniform1i(this._uRenderPass,i),this.setSectionPlanesStateUniforms(t),a.logarithmicDepthBufferEnabled){if(this._uLogDepthBufFC){const K=2/(Math.log(e.pickZFar+1)/Math.LN2);A.uniform1f(this._uLogDepthBufFC,K)}this._uZFar&&A.uniform1f(this._uZFar,a.camera.project.far)}if(this._uPickInvisible&&A.uniform1i(this._uPickInvisible,e.pickInvisible),this._uPickZNear&&A.uniform1f(this._uPickZNear,e.pickZNear),this._uPickZFar&&A.uniform1f(this._uPickZFar,e.pickZFar),this._uPickClipPos&&A.uniform2fv(this._uPickClipPos,e.pickClipPos),this._uDrawingBufferSize&&A.uniform2f(this._uDrawingBufferSize,A.drawingBufferWidth,A.drawingBufferHeight),this._uUVDecodeMatrix&&A.uniformMatrix3fv(this._uUVDecodeMatrix,!1,l.uvDecodeMatrix),this._uIntensityRange&&u.filterIntensity&&A.uniform2f(this._uIntensityRange,u.minIntensity,u.maxIntensity),this._uPointSize&&A.uniform1f(this._uPointSize,u.pointSize),this._uNearPlaneHeight){const K=a.camera.projection==="ortho"?1:A.drawingBufferHeight/(2*Math.tan(.5*a.camera.perspective.fov*Math.PI/180));A.uniform1f(this._uNearPlaneHeight,K)}if(d){const{colorTexture:K,metallicRoughnessTexture:j,emissiveTexture:z,normalsTexture:le,occlusionTexture:ue}=d;this._uColorMap&&K&&(this._program.bindTexture(this._uColorMap,K.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%n),this._uMetallicRoughMap&&j&&(this._program.bindTexture(this._uMetallicRoughMap,j.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%n),this._uEmissiveMap&&z&&(this._program.bindTexture(this._uEmissiveMap,z.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%n),this._uNormalMap&&le&&(this._program.bindTexture(this._uNormalMap,le.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%n),this._uAOMap&&ue&&(this._program.bindTexture(this._uAOMap,ue.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%n)}if(_.reflectionMaps.length>0&&_.reflectionMaps[0].texture&&this._uReflectionMap&&(this._program.bindTexture(this._uReflectionMap,_.reflectionMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%n,e.bindTexture++),_.lightMaps.length>0&&_.lightMaps[0].texture&&this._uLightMap&&(this._program.bindTexture(this._uLightMap,_.lightMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%n,e.bindTexture++),this._withSAO){const K=a.sao;if(K.possible){const z=A.drawingBufferWidth,le=A.drawingBufferHeight;Xr[0]=z,Xr[1]=le,Xr[2]=K.blendCutoff,Xr[3]=K.blendFactor,A.uniform4fv(this._uSAOParams,Xr),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%n,e.bindTexture++}}if(s){const K=this._edges?"edgeColor":"fillColor",j=this._edges?"edgeAlpha":"fillAlpha";if(i===U[`${this._edges?"EDGES":"SILHOUETTE"}_XRAYED`]){const z=a.xrayMaterial._state,le=z[K],ue=z[j];A.uniform4f(this._uColor,le[0],le[1],le[2],ue)}else if(i===U[`${this._edges?"EDGES":"SILHOUETTE"}_HIGHLIGHTED`]){const z=a.highlightMaterial._state,le=z[K],ue=z[j];A.uniform4f(this._uColor,le[0],le[1],le[2],ue)}else if(i===U[`${this._edges?"EDGES":"SILHOUETTE"}_SELECTED`]){const z=a.selectedMaterial._state,le=z[K],ue=z[j];A.uniform4f(this._uColor,le[0],le[1],le[2],ue)}else A.uniform4fv(this._uColor,this._edges?kB:OB)}this._draw({state:l,frameCtx:e,incrementDrawState:o}),A.bindVertexArray(null)}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null,vt.memory.programs--}}class hi extends Wt{constructor(e,t,{edges:i=!1}={}){super(e,t,{instancing:!1,edges:i})}_draw(e){const{gl:t}=this._scene.canvas,{state:i,frameCtx:s,incrementDrawState:o}=e;if(this._edges)t.drawElements(t.LINES,i.edgeIndicesBuf.numItems,i.edgeIndicesBuf.itemType,0);else{const n=s.pickElementsCount||i.indicesBuf.numItems,a=s.pickElementsOffset?s.pickElementsOffset*i.indicesBuf.itemByteSize:0;t.drawElements(t.TRIANGLES,n,i.indicesBuf.itemType,a),o&&s.drawElements++}}}class Au extends hi{_getHash(){const e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState,i=e._lightsState,s=t.getNumAllocatedSectionPlanes()>0;let o;const n=[];n.push("#version 300 es"),n.push("// Triangles batching draw vertex shader"),n.push("uniform int renderPass;"),n.push("in vec3 position;"),n.push("in vec3 normal;"),n.push("in vec4 color;"),n.push("in float flags;"),e.entityOffsetsEnabled&&n.push("in vec3 offset;"),this._addMatricesUniformBlockLines(n,!0),e.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),n.push("out float vFragDepth;"),n.push("bool isPerspectiveMatrix(mat4 m) {"),n.push("    return (m[2][3] == - 1.0);"),n.push("}"),n.push("out float isPerspective;")),n.push("uniform vec4 lightAmbient;");for(let a=0,A=i.lights.length;a<A;a++)o=i.lights[a],o.type!=="ambient"&&(n.push("uniform vec4 lightColor"+a+";"),o.type==="dir"&&n.push("uniform vec3 lightDir"+a+";"),o.type==="point"&&n.push("uniform vec3 lightPos"+a+";"),o.type==="spot"&&(n.push("uniform vec3 lightPos"+a+";"),n.push("uniform vec3 lightDir"+a+";")));n.push("vec3 octDecode(vec2 oct) {"),n.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),n.push("    if (v.z < 0.0) {"),n.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),n.push("    }"),n.push("    return normalize(v);"),n.push("}"),s&&(n.push("out vec4 vWorldPosition;"),n.push("out float vFlags;")),n.push("out vec4 vColor;"),n.push("void main(void) {"),n.push("int colorFlag = int(flags) & 0xF;"),n.push("if (colorFlag != renderPass) {"),n.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),n.push("} else {"),n.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&n.push("worldPosition.xyz = worldPosition.xyz + offset;"),n.push("vec4 viewPosition  = viewMatrix * worldPosition; "),n.push("vec4 worldNormal =  worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),n.push("vec3 viewNormal = normalize((viewNormalMatrix * worldNormal).xyz);"),n.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),n.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),n.push("float lambertian = 1.0;");for(let a=0,A=i.lights.length;a<A;a++)if(o=i.lights[a],o.type!=="ambient"){if(o.type==="dir")o.space==="view"?n.push("viewLightDir = normalize(lightDir"+a+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+a+", 0.0)).xyz);");else if(o.type==="point")o.space==="view"?n.push("viewLightDir = -normalize(lightPos"+a+" - viewPosition.xyz);"):n.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+a+", 0.0)).xyz);");else if(o.type==="spot")o.space==="view"?n.push("viewLightDir = normalize(lightDir"+a+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+a+", 0.0)).xyz);");else continue;n.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),n.push("reflectedColor += lambertian * (lightColor"+a+".rgb * lightColor"+a+".a);")}return n.push("vec3 rgb = (vec3(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0));"),n.push("vColor =  vec4((lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedColor * rgb), float(color.a) / 255.0);"),n.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(n.push("vFragDepth = 1.0 + clipPos.w;"),n.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s&&(n.push("vWorldPosition = worldPosition;"),n.push("vFlags = flags;")),n.push("gl_Position = clipPos;"),n.push("}"),n.push("}"),n}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles batching draw fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),this._withSAO&&(s.push("uniform sampler2D uOcclusionTexture;"),s.push("uniform vec4      uSAOParams;"),s.push("const float       packUpscale = 256. / 255.;"),s.push("const float       unpackDownScale = 255. / 256.;"),s.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),s.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),s.push("float unpackRGBToFloat( const in vec4 v ) {"),s.push("    return dot( v, unPackFactors );"),s.push("}")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";");s.push("uniform float sliceThickness;"),s.push("uniform vec4 sliceColor;")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),s.push("  vec4 newColor;"),s.push("  newColor = vColor;"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > sliceThickness) { "),s.push("      discard;"),s.push("  }"),s.push("  if (dist > 0.0) { "),s.push("      newColor = sliceColor;"),s.push("  }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),this._withSAO?(s.push("   float viewportWidth     = uSAOParams[0];"),s.push("   float viewportHeight    = uSAOParams[1];"),s.push("   float blendCutoff       = uSAOParams[2];"),s.push("   float blendFactor       = uSAOParams[3];"),s.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),s.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),s.push("   outColor            = vec4(newColor.rgb * ambient, 1.0);")):s.push("   outColor            = newColor;"),s.push("}"),s}}class lu extends hi{_getHash(){const e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Triangles batching flat-shading draw vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec4 color;"),s.push("in float flags;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),this._addMatricesUniformBlockLines(s),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vViewPosition;"),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vViewPosition = viewPosition;"),s.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._lightsState,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,o=[];if(o.push("#version 300 es"),o.push("// Triangles batching flat-shading draw fragment shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&(o.push("in float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),this._withSAO&&(o.push("uniform sampler2D uOcclusionTexture;"),o.push("uniform vec4      uSAOParams;"),o.push("const float       packUpscale = 256. / 255.;"),o.push("const float       unpackDownScale = 255. / 256.;"),o.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),o.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),o.push("float unpackRGBToFloat( const in vec4 v ) {"),o.push("    return dot( v, unPackFactors );"),o.push("}")),s){o.push("in vec4 vWorldPosition;"),o.push("in float vFlags;");for(let n=0,a=i.getNumAllocatedSectionPlanes();n<a;n++)o.push("uniform bool sectionPlaneActive"+n+";"),o.push("uniform vec3 sectionPlanePos"+n+";"),o.push("uniform vec3 sectionPlaneDir"+n+";");o.push("uniform float sliceThickness;"),o.push("uniform vec4 sliceColor;")}this._addMatricesUniformBlockLines(o),o.push("uniform vec4 lightAmbient;");for(let n=0,a=t.lights.length;n<a;n++){const A=t.lights[n];A.type!=="ambient"&&(o.push("uniform vec4 lightColor"+n+";"),A.type==="dir"&&o.push("uniform vec3 lightDir"+n+";"),A.type==="point"&&o.push("uniform vec3 lightPos"+n+";"),A.type==="spot"&&(o.push("uniform vec3 lightPos"+n+";"),o.push("uniform vec3 lightDir"+n+";")))}if(o.push("in vec4 vViewPosition;"),o.push("in vec4 vColor;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),o.push("  vec4 newColor;"),o.push("  newColor = vColor;"),s){o.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;");for(let n=0,a=i.getNumAllocatedSectionPlanes();n<a;n++)o.push("if (sectionPlaneActive"+n+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > sliceThickness) { "),o.push("      discard;"),o.push("  }"),o.push("  if (dist > 0.0) { "),o.push("      newColor = sliceColor;"),o.push("  }"),o.push("}")}o.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),o.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),o.push("float lambertian = 1.0;"),o.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),o.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),o.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );");for(let n=0,a=t.lights.length;n<a;n++){const A=t.lights[n];if(A.type!=="ambient"){if(A.type==="dir")A.space==="view"?o.push("viewLightDir = normalize(lightDir"+n+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+n+", 0.0)).xyz);");else if(A.type==="point")A.space==="view"?o.push("viewLightDir = -normalize(lightPos"+n+" - viewPosition.xyz);"):o.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+n+", 0.0)).xyz);");else if(A.type==="spot")A.space==="view"?o.push("viewLightDir = normalize(lightDir"+n+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+n+", 0.0)).xyz);");else continue;o.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),o.push("reflectedColor += lambertian * (lightColor"+n+".rgb * lightColor"+n+".a);")}}return o.push("vec4 fragColor =  vec4((lightAmbient.rgb * lightAmbient.a * newColor.rgb) + (reflectedColor * newColor.rgb), newColor.a);"),this._withSAO?(o.push("   float viewportWidth     = uSAOParams[0];"),o.push("   float viewportHeight    = uSAOParams[1];"),o.push("   float blendCutoff       = uSAOParams[2];"),o.push("   float blendFactor       = uSAOParams[3];"),o.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),o.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),o.push("   outColor            = vec4(fragColor.rgb * ambient, 1.0);")):o.push("   outColor            = fragColor;"),e.logarithmicDepthBufferEnabled&&o.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("}"),o}}class cu extends hi{drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Triangles batching silhouette vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 color;"),this._addMatricesUniformBlockLines(s),s.push("uniform vec4 silhouetteColor;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),s.push("if (silhouetteFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("vColor = vec4(silhouetteColor.r, silhouetteColor.g, silhouetteColor.b, min(silhouetteColor.a, color.a ));"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState;let i,s;const o=t.getNumAllocatedSectionPlanes()>0,n=[];if(n.push("#version 300 es"),n.push("// Triangles batching silhouette fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),o){for(n.push("in vec4 vWorldPosition;"),n.push("in float vFlags;"),i=0,s=t.getNumAllocatedSectionPlanes();i<s;i++)n.push("uniform bool sectionPlaneActive"+i+";"),n.push("uniform vec3 sectionPlanePos"+i+";"),n.push("uniform vec3 sectionPlaneDir"+i+";");n.push("uniform float sliceThickness;"),n.push("uniform vec4 sliceColor;")}if(n.push("in vec4 vColor;"),n.push("out vec4 outColor;"),n.push("void main(void) {"),n.push("  vec4 newColor;"),n.push("  newColor = vColor;"),o){n.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;");for(let a=0,A=t.getNumAllocatedSectionPlanes();a<A;a++)n.push("if (sectionPlaneActive"+a+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > sliceThickness) { "),n.push("      discard;"),n.push("  }"),n.push("  if (dist > 0.0) { "),n.push("      newColor = sliceColor;"),n.push("  }"),n.push("}")}return e.logarithmicDepthBufferEnabled&&n.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("outColor = newColor;"),n.push("}"),n}}class tg extends hi{constructor(e){super(e,!1,{instancing:!1,edges:!0})}}class HB extends tg{drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// EdgesEmphasisRenderer vertex shader"),s.push("uniform int renderPass;"),s.push("uniform vec4 color;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),this._addMatricesUniformBlockLines(s),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("int edgeFlag = int(flags) >> 8 & 0xF;"),s.push("if (edgeFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("  vWorldPosition = worldPosition;"),s.push("  vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("vColor = vec4(color.r, color.g, color.b, color.a);"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// EdgesEmphasisRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = vColor;"),s.push("}"),s}}class VB extends tg{drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!1})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Batched geometry edges drawing vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec4 color;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),this._addMatricesUniformBlockLines(s),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("int edgeFlag = int(flags) >> 8 & 0xF;"),s.push("if (edgeFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("  vWorldPosition = worldPosition;"),s.push("  vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("vColor = vec4(float(color.r*0.5) / 255.0, float(color.g*0.5) / 255.0, float(color.b*0.5) / 255.0, float(color.a) / 255.0);"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry edges drawing fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = vColor;"),s.push("}"),s}}class hu extends hi{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry picking vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 pickColor;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),this._addRemapClipPosLines(i),i.push("out vec4 vPickColor;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry picking fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vPickColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(let n=0;n<t.getNumAllocatedSectionPlanes();n++)s.push("      if (sectionPlaneActive"+n+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outColor = vPickColor; "),s.push("}"),s}}class uu extends hi{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching pick depth vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),this._addRemapClipPosLines(i),i.push("out vec4 vViewPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vViewPosition = viewPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles batching pick depth fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("uniform float pickZNear;"),s.push("uniform float pickZFar;"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(let n=0;n<t.getNumAllocatedSectionPlanes();n++)s.push("      if (sectionPlaneActive"+n+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),s.push("    outColor = packDepth(zNormalizedDepth); "),s.push("}"),s}}class GB extends hi{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching pick normals vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec3 normal;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),this._addRemapClipPosLines(i,3),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec3 vWorldNormal;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vec3 worldNormal =  octDecode(normal.xy); "),i.push("      vWorldNormal = worldNormal;"),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles batching pick normals fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec3 vWorldNormal;"),s.push("out highp ivec4 outNormal;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(let n=0;n<t.getNumAllocatedSectionPlanes();n++)s.push("      if (sectionPlaneActive"+n+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push(`    outNormal = ivec4(vWorldNormal * float(${c.MAX_INT}), 1.0);`),s.push("}"),s}}class jB extends hi{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching occlusion vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 color;"),i.push("in float flags;"),this._addMatricesUniformBlockLines(i),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles batching occlusion fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("      if (sectionPlaneActive"+o+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return s.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),s.push("}"),s}}class zB extends hi{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching depth vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec2 vHighPrecisionZW;"),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vHighPrecisionZW = gl_Position.zw;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles batching depth fragment shader"),s.push("precision highp float;"),s.push("precision highp int;"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let n=0;n<t.getNumAllocatedSectionPlanes();n++)s.push("uniform bool sectionPlaneActive"+n+";"),s.push("uniform vec3 sectionPlanePos"+n+";"),s.push("uniform vec3 sectionPlaneDir"+n+";")}if(s.push("const float   packUpScale = 256. / 255.;"),s.push("const float   unpackDownscale = 255. / 256.;"),s.push("const vec3    packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),s.push("const vec4    unpackFactors = unpackDownscale / vec4( packFactors, 1. );"),s.push("const float   shiftRight8 = 1.0 / 256.;"),s.push("vec4 packDepthToRGBA( const in float v ) {"),s.push("    vec4 r = vec4( fract( v * packFactors ), v );"),s.push("    r.yzw -= r.xyz * shiftRight8;"),s.push("    return r * packUpScale;"),s.push("}"),s.push("in vec2 vHighPrecisionZW;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("      if (sectionPlaneActive"+o+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;"),s.push("    outColor = vec4(vec3(1.0 - fragCoordZ), 1.0); "),s.push("}"),s}}class KB extends hi{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry normals vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec3 normal;"),i.push("in vec4 color;"),i.push("in float flags;"),this._addMatricesUniformBlockLines(i,!0),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec3 vViewNormal;"),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition   = viewMatrix * worldPosition; "),i.push("      vec4 worldNormal    = worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),i.push("      vec3 viewNormal     = normalize((viewNormalMatrix * worldNormal).xyz);"),t&&(i.push("      vWorldPosition  = worldPosition;"),i.push("      vFlags         = flags;")),i.push("      vViewNormal = viewNormal;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry normals fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let n=0;n<t.getNumAllocatedSectionPlanes();n++)s.push("uniform bool sectionPlaneActive"+n+";"),s.push("uniform vec3 sectionPlanePos"+n+";"),s.push("uniform vec3 sectionPlaneDir"+n+";")}if(s.push("in vec3 vViewNormal;"),s.push("vec3 packNormalToRGB( const in vec3 normal ) {"),s.push("    return normalize( normal ) * 0.5 + 0.5;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("      if (sectionPlaneActive"+o+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    outColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),s.push("}"),s}}class WB extends hi{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry shadow vertex shader"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 color;"),i.push("in float flags;"),i.push("uniform mat4 shadowViewMatrix;"),i.push("uniform mat4 shadowProjMatrix;"),this._addMatricesUniformBlockLines(i),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vViewPosition;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),i.push("  int colorFlag = int(flags) & 0xF;"),i.push("  bool visible        = (colorFlag > 0);"),i.push("  bool transparent    = ((float(color.a) / 255.0) < 1.0);"),i.push("  if (!visible || transparent) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = shadowViewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("      vViewPosition = viewPosition;"),i.push("      gl_Position = shadowProjMatrix * viewPosition;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry shadow fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let n=0;n<t.getNumAllocatedSectionPlanes();n++)s.push("uniform bool sectionPlaneActive"+n+";"),s.push("uniform vec3 sectionPlanePos"+n+";"),s.push("uniform vec3 sectionPlaneDir"+n+";")}if(s.push("in vec4 vViewPosition;"),s.push("vec4 encodeFloat( const in float v ) {"),s.push("  const vec4 bitShift = vec4(256 * 256 * 256, 256 * 256, 256, 1.0);"),s.push("  const vec4 bitMask = vec4(0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);"),s.push("  vec4 comp = fract(v * bitShift);"),s.push("  comp -= comp.xxyz * bitMask;"),s.push("  return comp;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("      if (sectionPlaneActive"+o+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return s.push("    outColor = encodeFloat( gl_FragCoord.z); "),s.push("}"),s}}class du extends hi{_getHash(){const e=this._scene;return[e.gammaOutput,e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState,i=e._lightsState,s=t.getNumAllocatedSectionPlanes()>0,o=t.clippingCaps,n=[];return n.push("#version 300 es"),n.push("// Triangles batching quality draw vertex shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("precision highp usampler2D;"),n.push("precision highp isampler2D;"),n.push("precision highp sampler2D;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("precision mediump usampler2D;"),n.push("precision mediump isampler2D;"),n.push("precision mediump sampler2D;"),n.push("#endif"),n.push("uniform int renderPass;"),n.push("in vec3 position;"),n.push("in vec3 normal;"),n.push("in vec4 color;"),n.push("in vec2 uv;"),n.push("in vec2 metallicRoughness;"),n.push("in float flags;"),e.entityOffsetsEnabled&&n.push("in vec3 offset;"),this._addMatricesUniformBlockLines(n,!0),n.push("uniform mat3 uvDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),n.push("out float vFragDepth;"),n.push("bool isPerspectiveMatrix(mat4 m) {"),n.push("    return (m[2][3] == - 1.0);"),n.push("}"),n.push("out float isPerspective;")),n.push("vec3 octDecode(vec2 oct) {"),n.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),n.push("    if (v.z < 0.0) {"),n.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),n.push("    }"),n.push("    return normalize(v);"),n.push("}"),n.push("out vec4 vViewPosition;"),n.push("out vec3 vViewNormal;"),n.push("out vec4 vColor;"),n.push("out vec2 vUV;"),n.push("out vec2 vMetallicRoughness;"),i.lightMaps.length>0&&n.push("out vec3 vWorldNormal;"),s&&(n.push("out vec4 vWorldPosition;"),n.push("out float vFlags;"),o&&n.push("out vec4 vClipPosition;")),n.push("void main(void) {"),n.push("int colorFlag = int(flags) & 0xF;"),n.push("if (colorFlag != renderPass) {"),n.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),n.push("} else {"),n.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&n.push("worldPosition.xyz = worldPosition.xyz + offset;"),n.push("vec4 viewPosition  = viewMatrix * worldPosition; "),n.push("vec4 worldNormal =  worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),n.push("vec3 viewNormal = normalize((viewNormalMatrix * worldNormal).xyz);"),n.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(n.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),n.push("vFragDepth = 1.0 + clipPos.w;")),s&&(n.push("vWorldPosition = worldPosition;"),n.push("vFlags = flags;"),o&&n.push("vClipPosition = clipPos;")),n.push("vViewPosition = viewPosition;"),n.push("vViewNormal = viewNormal;"),n.push("vColor = color;"),n.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"),n.push("vMetallicRoughness = metallicRoughness;"),i.lightMaps.length>0&&n.push("vWorldNormal = worldNormal.xyz;"),n.push("gl_Position = clipPos;"),n.push("}"),n.push("}"),n}_buildFragmentShader(){const e=this._scene,t=e.gammaOutput,i=e._sectionPlanesState,s=e._lightsState,o=i.getNumAllocatedSectionPlanes()>0,n=i.clippingCaps,a=[];a.push("#version 300 es"),a.push("// Triangles batching quality draw fragment shader"),a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),e.logarithmicDepthBufferEnabled&&(a.push("in float isPerspective;"),a.push("uniform float logDepthBufFC;"),a.push("in float vFragDepth;")),a.push("uniform sampler2D uColorMap;"),a.push("uniform sampler2D uMetallicRoughMap;"),a.push("uniform sampler2D uEmissiveMap;"),a.push("uniform sampler2D uNormalMap;"),a.push("uniform sampler2D uAOMap;"),a.push("in vec4 vViewPosition;"),a.push("in vec3 vViewNormal;"),a.push("in vec4 vColor;"),a.push("in vec2 vUV;"),a.push("in vec2 vMetallicRoughness;"),s.lightMaps.length>0&&a.push("in vec3 vWorldNormal;"),this._addMatricesUniformBlockLines(a,!0),s.reflectionMaps.length>0&&a.push("uniform samplerCube reflectionMap;"),s.lightMaps.length>0&&a.push("uniform samplerCube lightMap;"),a.push("uniform vec4 lightAmbient;");for(let A=0,l=s.lights.length;A<l;A++){const h=s.lights[A];h.type!=="ambient"&&(a.push("uniform vec4 lightColor"+A+";"),h.type==="dir"&&a.push("uniform vec3 lightDir"+A+";"),h.type==="point"&&a.push("uniform vec3 lightPos"+A+";"),h.type==="spot"&&(a.push("uniform vec3 lightPos"+A+";"),a.push("uniform vec3 lightDir"+A+";")))}if(this._withSAO&&(a.push("uniform sampler2D uOcclusionTexture;"),a.push("uniform vec4      uSAOParams;"),a.push("const float       packUpscale = 256. / 255.;"),a.push("const float       unpackDownScale = 255. / 256.;"),a.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),a.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),a.push("float unpackRGBToFloat( const in vec4 v ) {"),a.push("    return dot( v, unPackFactors );"),a.push("}")),a.push("uniform float gammaFactor;"),a.push("vec4 linearToLinear( in vec4 value ) {"),a.push("  return value;"),a.push("}"),a.push("vec4 sRGBToLinear( in vec4 value ) {"),a.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),a.push("}"),a.push("vec4 gammaToLinear( in vec4 value) {"),a.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),a.push("}"),t&&(a.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),a.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),a.push("}")),o){a.push("in vec4 vWorldPosition;"),a.push("in float vFlags;"),n&&a.push("in vec4 vClipPosition;");for(let A=0,l=i.getNumAllocatedSectionPlanes();A<l;A++)a.push("uniform bool sectionPlaneActive"+A+";"),a.push("uniform vec3 sectionPlanePos"+A+";"),a.push("uniform vec3 sectionPlaneDir"+A+";")}if(a.push("#define PI 3.14159265359"),a.push("#define RECIPROCAL_PI 0.31830988618"),a.push("#define RECIPROCAL_PI2 0.15915494"),a.push("#define EPSILON 1e-6"),a.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),a.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),a.push("       vec3 texel = texture( uNormalMap, uv ).xyz;"),a.push("       if (texel.x == 0.0 && texel.y == 0.0 && texel.z == 0.0) {"),a.push("              return surf_norm;"),a.push("       }"),a.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),a.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),a.push("      vec2 st0 = dFdx( uv.st );"),a.push("      vec2 st1 = dFdy( uv.st );"),a.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),a.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),a.push("      vec3 N = normalize( surf_norm );"),a.push("      vec3 mapN = texel.xyz * 2.0 - 1.0;"),a.push("      mat3 tsn = mat3( S, T, N );"),a.push("      return normalize( tsn * mapN );"),a.push("}"),a.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),a.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),a.push("}"),a.push("struct IncidentLight {"),a.push("   vec3 color;"),a.push("   vec3 direction;"),a.push("};"),a.push("struct ReflectedLight {"),a.push("   vec3 diffuse;"),a.push("   vec3 specular;"),a.push("};"),a.push("struct Geometry {"),a.push("   vec3 position;"),a.push("   vec3 viewNormal;"),a.push("   vec3 worldNormal;"),a.push("   vec3 viewEyeDir;"),a.push("};"),a.push("struct Material {"),a.push("   vec3  diffuseColor;"),a.push("   float specularRoughness;"),a.push("   vec3  specularColor;"),a.push("   float shine;"),a.push("};"),a.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),a.push("   float r = ggxRoughness + 0.0001;"),a.push("   return (2.0 / (r * r) - 2.0);"),a.push("}"),a.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),a.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),a.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),a.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),a.push("}"),s.reflectionMaps.length>0&&(a.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),a.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),a.push("   vec3 envMapColor = sRGBToLinear(texture(reflectionMap, reflectVec, mipLevel)).rgb;"),a.push("  return envMapColor;"),a.push("}")),a.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),a.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),a.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),a.push("}"),a.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),a.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),a.push("   return 1.0 / ( gl * gv );"),a.push("}"),a.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),a.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),a.push("   return 0.5 / max( gv + gl, EPSILON );"),a.push("}"),a.push("float D_GGX(const in float alpha, const in float dotNH) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),a.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),a.push("}"),a.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),a.push("   float alpha = ( roughness * roughness );"),a.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),a.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),a.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),a.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),a.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),a.push("   vec3  F = F_Schlick( specularColor, dotLH );"),a.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),a.push("   float D = D_GGX( alpha, dotNH );"),a.push("   return F * (G * D);"),a.push("}"),a.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),a.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),a.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),a.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),a.push("   vec4 r = roughness * c0 + c1;"),a.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),a.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),a.push("   return specularColor * AB.x + AB.y;"),a.push("}"),(s.lightMaps.length>0||s.reflectionMaps.length>0)&&(a.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),s.lightMaps.length>0&&(a.push("   vec3 irradiance = sRGBToLinear(texture(lightMap, geometry.worldNormal)).rgb;"),a.push("   irradiance *= PI;"),a.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),a.push("   reflectedLight.diffuse +=  irradiance * diffuseBRDFContrib;")),s.reflectionMaps.length>0&&(a.push("   vec3 reflectVec             = reflect(geometry.viewEyeDir, geometry.viewNormal);"),a.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),a.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),a.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),a.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),a.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),a.push("}")),a.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),a.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),a.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),a.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),a.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),a.push("}"),a.push("out vec4 outColor;"),a.push("void main(void) {"),o){a.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;");for(let A=0,l=i.getNumAllocatedSectionPlanes();A<l;A++)a.push("if (sectionPlaneActive"+A+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+A+".xyz, vWorldPosition.xyz - sectionPlanePos"+A+".xyz), 0.0, 1000.0);"),a.push("}");n?(a.push("  if (dist > (0.002 * vClipPosition.w)) {"),a.push("      discard;"),a.push("  }"),a.push("  if (dist > 0.0) { "),a.push("      outColor=vec4(1.0, 0.0, 0.0, 1.0);"),e.logarithmicDepthBufferEnabled&&a.push("  gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("  return;"),a.push("}")):(a.push("  if (dist > 0.0) { "),a.push("      discard;"),a.push("  }")),a.push("}")}a.push("IncidentLight  light;"),a.push("Material       material;"),a.push("Geometry       geometry;"),a.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),a.push("vec3 rgb = (vec3(float(vColor.r) / 255.0, float(vColor.g) / 255.0, float(vColor.b) / 255.0));"),a.push("float opacity = float(vColor.a) / 255.0;"),a.push("vec3  baseColor = rgb;"),a.push("float specularF0 = 1.0;"),a.push("float metallic = float(vMetallicRoughness.r) / 255.0;"),a.push("float roughness = float(vMetallicRoughness.g) / 255.0;"),a.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),a.push("vec4 colorTexel = sRGBToLinear(texture(uColorMap, vUV));"),a.push("baseColor *= colorTexel.rgb;"),a.push("vec3 metalRoughTexel = texture(uMetallicRoughMap, vUV).rgb;"),a.push("metallic *= metalRoughTexel.b;"),a.push("roughness *= metalRoughTexel.g;"),a.push("vec3 viewNormal = perturbNormal2Arb(vViewPosition.xyz, normalize(vViewNormal), vUV );"),a.push("material.diffuseColor      = baseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),a.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),a.push("material.specularColor     = mix(vec3(dielectricSpecular), baseColor, metallic);"),a.push("geometry.position      = vViewPosition.xyz;"),a.push("geometry.viewNormal    = -normalize(viewNormal);"),a.push("geometry.viewEyeDir    = normalize(vViewPosition.xyz);"),s.lightMaps.length>0&&a.push("geometry.worldNormal   = normalize(vWorldNormal);"),(s.lightMaps.length>0||s.reflectionMaps.length>0)&&a.push("computePBRLightMapping(geometry, material, reflectedLight);");for(let A=0,l=s.lights.length;A<l;A++){const h=s.lights[A];if(h.type!=="ambient"){if(h.type==="dir")h.space==="view"?a.push("light.direction =  normalize(lightDir"+A+");"):a.push("light.direction =  normalize((viewMatrix * vec4(lightDir"+A+", 0.0)).xyz);");else if(h.type==="point")h.space==="view"?a.push("light.direction =  normalize(lightPos"+A+" - vViewPosition.xyz);"):a.push("light.direction =  normalize((viewMatrix * vec4(lightPos"+A+", 0.0)).xyz);");else if(h.type==="spot")h.space==="view"?a.push("light.direction =  normalize(lightDir"+A+");"):a.push("light.direction =  normalize((viewMatrix * vec4(lightDir"+A+", 0.0)).xyz);");else continue;a.push("light.color =  lightColor"+A+".rgb * lightColor"+A+".a;"),a.push("computePBRLighting(light, geometry, material, reflectedLight);")}}return a.push("vec3 emissiveColor = sRGBToLinear(texture(uEmissiveMap, vUV)).rgb;"),a.push("float aoFactor = texture(uAOMap, vUV).r;"),a.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * baseColor * opacity * rgb) + (reflectedLight.diffuse) + (reflectedLight.specular) + emissiveColor;"),a.push("vec4 fragColor;"),this._withSAO?(a.push("   float viewportWidth     = uSAOParams[0];"),a.push("   float viewportHeight    = uSAOParams[1];"),a.push("   float blendCutoff       = uSAOParams[2];"),a.push("   float blendFactor       = uSAOParams[3];"),a.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),a.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),a.push("   fragColor               = vec4(outgoingLight.rgb * ambient * aoFactor, opacity);")):a.push("   fragColor            = vec4(outgoingLight.rgb * aoFactor, opacity);"),t&&a.push("fragColor = linearToGamma(fragColor, gammaFactor);"),a.push("outColor = fragColor;"),e.logarithmicDepthBufferEnabled&&a.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("}"),a}}class XB extends hi{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching pick flat normals vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),this._addRemapClipPosLines(i,3),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),i.push("out vec4 vWorldPosition;"),t&&i.push("out float vFlags;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vWorldPosition = worldPosition;"),t&&i.push("      vFlags = flags;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles batching pick flat normals fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("in vec4 vWorldPosition;"),i){s.push("in float vFlags;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("out highp ivec4 outNormal;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(let n=0;n<t.getNumAllocatedSectionPlanes();n++)s.push("      if (sectionPlaneActive"+n+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("  vec3 xTangent = dFdx( vWorldPosition.xyz );"),s.push("  vec3 yTangent = dFdy( vWorldPosition.xyz );"),s.push("  vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),s.push(`  outNormal = ivec4(worldNormal * float(${c.MAX_INT}), 1.0);`),s.push("}"),s}}class pu extends hi{_getHash(){const e=this._scene;return[e.gammaOutput,e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Triangles batching color texture vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec4 color;"),s.push("in vec2 uv;"),s.push("in float flags;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),this._addMatricesUniformBlockLines(s),s.push("uniform mat3 uvDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vViewPosition;"),s.push("out vec4 vColor;"),s.push("out vec2 vUV;"),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vViewPosition = viewPosition;"),s.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),s.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e.gammaOutput,i=e._lightsState,s=e._sectionPlanesState,o=s.getNumAllocatedSectionPlanes()>0,n=[];if(n.push("#version 300 es"),n.push("// Triangles batching color texture fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),n.push("uniform sampler2D uColorMap;"),this._withSAO&&(n.push("uniform sampler2D uOcclusionTexture;"),n.push("uniform vec4      uSAOParams;"),n.push("const float       packUpscale = 256. / 255.;"),n.push("const float       unpackDownScale = 255. / 256.;"),n.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),n.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),n.push("float unpackRGBToFloat( const in vec4 v ) {"),n.push("    return dot( v, unPackFactors );"),n.push("}")),n.push("uniform float gammaFactor;"),n.push("vec4 linearToLinear( in vec4 value ) {"),n.push("  return value;"),n.push("}"),n.push("vec4 sRGBToLinear( in vec4 value ) {"),n.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),n.push("}"),n.push("vec4 gammaToLinear( in vec4 value) {"),n.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),n.push("}"),t&&(n.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),n.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),n.push("}")),o){n.push("in vec4 vWorldPosition;"),n.push("in float vFlags;");for(let a=0,A=s.getNumAllocatedSectionPlanes();a<A;a++)n.push("uniform bool sectionPlaneActive"+a+";"),n.push("uniform vec3 sectionPlanePos"+a+";"),n.push("uniform vec3 sectionPlaneDir"+a+";");n.push("uniform float sliceThickness;"),n.push("uniform vec4 sliceColor;")}this._addMatricesUniformBlockLines(n),n.push("uniform vec4 lightAmbient;");for(let a=0,A=i.lights.length;a<A;a++){const l=i.lights[a];l.type!=="ambient"&&(n.push("uniform vec4 lightColor"+a+";"),l.type==="dir"&&n.push("uniform vec3 lightDir"+a+";"),l.type==="point"&&n.push("uniform vec3 lightPos"+a+";"),l.type==="spot"&&(n.push("uniform vec3 lightPos"+a+";"),n.push("uniform vec3 lightDir"+a+";")))}if(n.push("in vec4 vViewPosition;"),n.push("in vec4 vColor;"),n.push("in vec2 vUV;"),n.push("out vec4 outColor;"),n.push("void main(void) {"),n.push("  vec4 newColor;"),n.push("  newColor = vColor;"),o){n.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;");for(let a=0,A=s.getNumAllocatedSectionPlanes();a<A;a++)n.push("if (sectionPlaneActive"+a+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > sliceThickness) { "),n.push("      discard;"),n.push("  }"),n.push("  if (dist > 0.0) { "),n.push("      newColor = sliceColor;"),n.push("  }"),n.push("}")}n.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),n.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),n.push("float lambertian = 1.0;"),n.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),n.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),n.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );");for(let a=0,A=i.lights.length;a<A;a++){const l=i.lights[a];if(l.type!=="ambient"){if(l.type==="dir")l.space==="view"?n.push("viewLightDir = normalize(lightDir"+a+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+a+", 0.0)).xyz);");else if(l.type==="point")l.space==="view"?n.push("viewLightDir = -normalize(lightPos"+a+" - viewPosition.xyz);"):n.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+a+", 0.0)).xyz);");else if(l.type==="spot")l.space==="view"?n.push("viewLightDir = normalize(lightDir"+a+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+a+", 0.0)).xyz);");else continue;n.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),n.push("reflectedColor += lambertian * (lightColor"+a+".rgb * lightColor"+a+".a);")}}return n.push("vec4 color =  vec4((lightAmbient.rgb * lightAmbient.a * newColor.rgb) + (reflectedColor * newColor.rgb), newColor.a);"),t?n.push("vec4 colorTexel = color * sRGBToLinear(texture(uColorMap, vUV));"):n.push("vec4 colorTexel = color * texture(uColorMap, vUV);"),n.push("float opacity = color.a;"),this._withSAO?(n.push("   float viewportWidth     = uSAOParams[0];"),n.push("   float viewportHeight    = uSAOParams[1];"),n.push("   float blendCutoff       = uSAOParams[2];"),n.push("   float blendFactor       = uSAOParams[3];"),n.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),n.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),n.push("   outColor                = vec4(colorTexel.rgb * ambient, opacity);")):n.push("   outColor                = vec4(colorTexel.rgb, opacity);"),t&&n.push("outColor = linearToGamma(outColor, gammaFactor);"),e.logarithmicDepthBufferEnabled&&n.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("}"),n}}const YB=c.vec3(),JB=c.vec3(),ZB=c.vec3(),qB=c.vec3(),$B=c.mat4();class fu extends Wt{drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,o=s.scene,n=o.camera,a=o.canvas.gl,A=t._state,l=t._state.origin,{position:h,rotationMatrix:d,rotationMatrixConjugate:f}=s,m=t.aabb,_=e.pickViewMatrix||n.viewMatrix;this._vaoCache.has(t)?a.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(A));const u=YB;u[0]=c.safeInv(m[3]-m[0])*c.MAX_INT,u[1]=c.safeInv(m[4]-m[1])*c.MAX_INT,u[2]=c.safeInv(m[5]-m[2])*c.MAX_INT,e.snapPickCoordinateScale[0]=c.safeInv(u[0]),e.snapPickCoordinateScale[1]=c.safeInv(u[1]),e.snapPickCoordinateScale[2]=c.safeInv(u[2]);let B,y;if(l||h[0]!==0||h[1]!==0||h[2]!==0){const v=JB;if(l){const b=ZB;c.transformPoint3(d,l,b),v[0]=b[0],v[1]=b[1],v[2]=b[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=h[0],v[1]+=h[1],v[2]+=h[2],B=ft(_,v,$B),y=qB,y[0]=n.eye[0]-v[0],y[1]=n.eye[1]-v[1],y[2]=n.eye[2]-v[2],e.snapPickOrigin[0]=v[0],e.snapPickOrigin[1]=v[1],e.snapPickOrigin[2]=v[2]}else B=_,y=n.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;a.uniform3fv(this._uCameraEyeRtc,y),a.uniform2fv(this.uVectorA,e.snapVectorA),a.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),a.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),a.uniform3fv(this._uCoordinateScaler,u),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,e.pickInvisible);let x=0;const P=4*4;this._matricesUniformBlockBufferData.set(f,0),this._matricesUniformBlockBufferData.set(B,x+=P),this._matricesUniformBlockBufferData.set(n.projMatrix,x+=P),this._matricesUniformBlockBufferData.set(A.positionsDecodeMatrix,x+=P),a.bindBuffer(a.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),a.bufferData(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,a.DYNAMIC_DRAW),a.bindBufferBase(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const v=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,v)}this.setSectionPlanesStateUniforms(t),A.indicesBuf.bind(),a.drawElements(a.TRIANGLES,A.indicesBuf.numItems,A.indicesBuf.itemType,0),A.indicesBuf.unbind()}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// VBO SnapBatchingDepthBufInitRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec4 pickColor;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),i.push("flat out vec4 vPickColor;"),i.push("out vec4 vWorldPosition;"),t&&i.push("out float vFlags;"),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      relativeToOriginPosition = worldPosition.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vWorldPosition = worldPosition;"),t&&i.push("      vFlags = flags;"),i.push("vPickColor = pickColor;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// VBO SnapBatchingDepthBufInitRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;"),s.push("uniform int layerNumber;"),s.push("uniform vec3 coordinateScaler;"),s.push("in vec4 vWorldPosition;"),s.push("flat in vec4 vPickColor;"),i){s.push("in float vFlags;");for(let n=0;n<t.getNumAllocatedSectionPlanes();n++)s.push("uniform bool sectionPlaneActive"+n+";"),s.push("uniform vec3 sectionPlanePos"+n+";"),s.push("uniform vec3 sectionPlaneDir"+n+";")}if(s.push("in highp vec3 relativeToOriginPosition;"),s.push("layout(location = 0) out highp ivec4 outCoords;"),s.push("layout(location = 1) out highp ivec4 outNormal;"),s.push("layout(location = 2) out lowp uvec4 outPickColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("      if (sectionPlaneActive"+o+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return s.push("    float dx = dFdx(vFragDepth);"),s.push("    float dy = dFdy(vFragDepth);"),s.push("    float diff = sqrt(dx*dx+dy*dy);"),s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),s.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),s.push("vec3 xTangent = dFdx( vWorldPosition.xyz );"),s.push("vec3 yTangent = dFdy( vWorldPosition.xyz );"),s.push("vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),s.push(`outNormal = ivec4(worldNormal * float(${c.MAX_INT}), 1.0);`),s.push("outPickColor = uvec4(vPickColor);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const eP=c.vec3(),tP=c.vec3(),iP=c.vec3(),sP=c.vec3(),rP=c.mat4();class gu extends Wt{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,o=s.scene,n=o.camera,a=o.canvas.gl,A=t._state,l=t._state.origin,{position:h,rotationMatrix:d,rotationMatrixConjugate:f}=s,m=t.aabb,_=e.pickViewMatrix||n.viewMatrix;this._vaoCache.has(t)?a.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(A));const u=eP;u[0]=c.safeInv(m[3]-m[0])*c.MAX_INT,u[1]=c.safeInv(m[4]-m[1])*c.MAX_INT,u[2]=c.safeInv(m[5]-m[2])*c.MAX_INT,e.snapPickCoordinateScale[0]=c.safeInv(u[0]),e.snapPickCoordinateScale[1]=c.safeInv(u[1]),e.snapPickCoordinateScale[2]=c.safeInv(u[2]);let B,y;if(l||h[0]!==0||h[1]!==0||h[2]!==0){const v=tP;if(l){const b=iP;c.transformPoint3(d,l,b),v[0]=b[0],v[1]=b[1],v[2]=b[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=h[0],v[1]+=h[1],v[2]+=h[2],B=ft(_,v,rP),y=sP,y[0]=n.eye[0]-v[0],y[1]=n.eye[1]-v[1],y[2]=n.eye[2]-v[2],e.snapPickOrigin[0]=v[0],e.snapPickOrigin[1]=v[1],e.snapPickOrigin[2]=v[2]}else B=_,y=n.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;a.uniform3fv(this._uCameraEyeRtc,y),a.uniform2fv(this.uVectorA,e.snapVectorA),a.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),a.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),a.uniform3fv(this._uCoordinateScaler,u),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,e.pickInvisible);let x=0;const P=4*4;this._matricesUniformBlockBufferData.set(f,0),this._matricesUniformBlockBufferData.set(B,x+=P),this._matricesUniformBlockBufferData.set(n.projMatrix,x+=P),this._matricesUniformBlockBufferData.set(A.positionsDecodeMatrix,x+=P),a.bindBuffer(a.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),a.bufferData(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,a.DYNAMIC_DRAW),a.bindBufferBase(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const v=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,v)}this.setSectionPlanesStateUniforms(t),e.snapMode==="edge"?(A.edgeIndicesBuf.bind(),a.drawElements(a.LINES,A.edgeIndicesBuf.numItems,A.edgeIndicesBuf.itemType,0),A.edgeIndicesBuf.unbind()):a.drawArrays(a.POINTS,0,A.positionsBuf.numItems)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0;e.pointsMaterial._state;const i=[];return i.push("#version 300 es"),i.push("// SnapBatchingDepthRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("gl_PointSize = 1.0;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// SnapBatchingDepthRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;"),s.push("uniform int layerNumber;"),s.push("uniform vec3 coordinateScaler;"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let n=0;n<t.getNumAllocatedSectionPlanes();n++)s.push("uniform bool sectionPlaneActive"+n+";"),s.push("uniform vec3 sectionPlanePos"+n+";"),s.push("uniform vec3 sectionPlaneDir"+n+";")}if(s.push("in highp vec3 relativeToOriginPosition;"),s.push("out highp ivec4 outCoords;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("      if (sectionPlaneActive"+o+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class oP{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._colorRendererWithSAO&&!this._colorRendererWithSAO.getValid()&&(this._colorRendererWithSAO.destroy(),this._colorRendererWithSAO=null),this._flatColorRenderer&&!this._flatColorRenderer.getValid()&&(this._flatColorRenderer.destroy(),this._flatColorRenderer=null),this._flatColorRendererWithSAO&&!this._flatColorRendererWithSAO.getValid()&&(this._flatColorRendererWithSAO.destroy(),this._flatColorRendererWithSAO=null),this._colorTextureRenderer&&!this._colorTextureRenderer.getValid()&&(this._colorTextureRenderer.destroy(),this._colorTextureRenderer=null),this._colorTextureRendererWithSAO&&!this._colorTextureRendererWithSAO.getValid()&&(this._colorTextureRendererWithSAO.destroy(),this._colorTextureRendererWithSAO=null),this._pbrRenderer&&!this._pbrRenderer.getValid()&&(this._pbrRenderer.destroy(),this._pbrRenderer=null),this._pbrRendererWithSAO&&!this._pbrRendererWithSAO.getValid()&&(this._pbrRendererWithSAO.destroy(),this._pbrRendererWithSAO=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._normalsRenderer&&!this._normalsRenderer.getValid()&&(this._normalsRenderer.destroy(),this._normalsRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._edgesRenderer&&!this._edgesRenderer.getValid()&&(this._edgesRenderer.destroy(),this._edgesRenderer=null),this._edgesColorRenderer&&!this._edgesColorRenderer.getValid()&&(this._edgesColorRenderer.destroy(),this._edgesColorRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&this._pickNormalsRenderer.getValid()===!1&&(this._pickNormalsRenderer.destroy(),this._pickNormalsRenderer=null),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.getValid()===!1&&(this._pickNormalsFlatRenderer.destroy(),this._pickNormalsFlatRenderer=null),this._occlusionRenderer&&this._occlusionRenderer.getValid()===!1&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}eagerCreateRenders(){this._silhouetteRenderer||(this._silhouetteRenderer=new cu(this._scene)),this._pickMeshRenderer||(this._pickMeshRenderer=new hu(this._scene)),this._pickDepthRenderer||(this._pickDepthRenderer=new uu(this._scene)),this._snapInitRenderer||(this._snapInitRenderer=new fu(this._scene,!1)),this._snapRenderer||(this._snapRenderer=new gu(this._scene))}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new Au(this._scene,!1)),this._colorRenderer}get colorRendererWithSAO(){return this._colorRendererWithSAO||(this._colorRendererWithSAO=new Au(this._scene,!0)),this._colorRendererWithSAO}get flatColorRenderer(){return this._flatColorRenderer||(this._flatColorRenderer=new lu(this._scene,!1)),this._flatColorRenderer}get flatColorRendererWithSAO(){return this._flatColorRendererWithSAO||(this._flatColorRendererWithSAO=new lu(this._scene,!0)),this._flatColorRendererWithSAO}get colorTextureRenderer(){return this._colorTextureRenderer||(this._colorTextureRenderer=new pu(this._scene,!1)),this._colorTextureRenderer}get colorTextureRendererWithSAO(){return this._colorTextureRendererWithSAO||(this._colorTextureRendererWithSAO=new pu(this._scene,!0)),this._colorTextureRendererWithSAO}get pbrRenderer(){return this._pbrRenderer||(this._pbrRenderer=new du(this._scene,!1)),this._pbrRenderer}get pbrRendererWithSAO(){return this._pbrRendererWithSAO||(this._pbrRendererWithSAO=new du(this._scene,!0)),this._pbrRendererWithSAO}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new cu(this._scene)),this._silhouetteRenderer}get depthRenderer(){return this._depthRenderer||(this._depthRenderer=new zB(this._scene)),this._depthRenderer}get normalsRenderer(){return this._normalsRenderer||(this._normalsRenderer=new KB(this._scene)),this._normalsRenderer}get edgesRenderer(){return this._edgesRenderer||(this._edgesRenderer=new HB(this._scene)),this._edgesRenderer}get edgesColorRenderer(){return this._edgesColorRenderer||(this._edgesColorRenderer=new VB(this._scene)),this._edgesColorRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new hu(this._scene)),this._pickMeshRenderer}get pickNormalsRenderer(){return this._pickNormalsRenderer||(this._pickNormalsRenderer=new GB(this._scene)),this._pickNormalsRenderer}get pickNormalsFlatRenderer(){return this._pickNormalsFlatRenderer||(this._pickNormalsFlatRenderer=new XB(this._scene)),this._pickNormalsFlatRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new uu(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new jB(this._scene)),this._occlusionRenderer}get shadowRenderer(){return this._shadowRenderer||(this._shadowRenderer=new WB(this._scene)),this._shadowRenderer}get snapRenderer(){return this._snapRenderer||(this._snapRenderer=new gu(this._scene)),this._snapRenderer}get snapInitRenderer(){return this._snapInitRenderer||(this._snapInitRenderer=new fu(this._scene)),this._snapInitRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._colorRendererWithSAO&&this._colorRendererWithSAO.destroy(),this._flatColorRenderer&&this._flatColorRenderer.destroy(),this._flatColorRendererWithSAO&&this._flatColorRendererWithSAO.destroy(),this._colorTextureRenderer&&this._colorTextureRenderer.destroy(),this._colorTextureRendererWithSAO&&this._colorTextureRendererWithSAO.destroy(),this._pbrRenderer&&this._pbrRenderer.destroy(),this._pbrRendererWithSAO&&this._pbrRendererWithSAO.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._normalsRenderer&&this._normalsRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._edgesRenderer&&this._edgesRenderer.destroy(),this._edgesColorRenderer&&this._edgesColorRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._pickNormalsRenderer&&this._pickNormalsRenderer.destroy(),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}const uA={};function nP(r){const e=r.id;let t=uA[e];return t||(t=new oP(r),uA[e]=t,t._compile(),t.eagerCreateRenders(),r.on("compile",()=>{t._compile(),t.eagerCreateRenders()}),r.on("destroyed",()=>{delete uA[e],t._destroy()})),t}let mu=65536,_u=5e6;class yc{constructor(){}set doublePrecisionEnabled(e){c.setDoublePrecisionEnabled(e)}get doublePrecisionEnabled(){return c.getDoublePrecisionEnabled()}set maxDataTextureHeight(e){e=Math.ceil(e/1024)*1024,e>4096?e=4096:e<1024&&(e=1024),mu=e}get maxDataTextureHeight(){return mu}set maxGeometryBatchSize(e){e<1e5?e=1e5:e>5e6&&(e=5e6),_u=e}get maxGeometryBatchSize(){return _u}}const vu=new yc;class aP{constructor(){this.maxVerts=vu.maxGeometryBatchSize,this.maxIndices=vu.maxGeometryBatchSize*3,this.positions=[],this.colors=[],this.uv=[],this.metallicRoughness=[],this.normals=[],this.pickColors=[],this.offsets=[],this.indices=[],this.edgeIndices=[]}}const xr=c.mat4(),wr=c.mat4();function Do(r,e,t){const i=r.length,s=new Uint16Array(i),o=e[0],n=e[1],a=e[2],A=e[3]-o,l=e[4]-n,h=e[5]-a,d=65525,f=d/A,m=d/l,_=d/h,u=B=>B>=0?B:0;for(let B=0;B<i;B+=3)s[B+0]=Math.floor(u(r[B+0]-o)*f),s[B+1]=Math.floor(u(r[B+1]-n)*m),s[B+2]=Math.floor(u(r[B+2]-a)*_);return c.identityMat4(xr),c.translationMat4v(e,xr),c.identityMat4(wr),c.scalingMat4v([A/d,l/d,h/d],wr),c.mulMat4(xr,wr,t),s}function dA(r,e){const t=r[0],i=r[1],s=r[2],o=r[3]-t,n=r[4]-i,a=r[5]-s,A=65525;return c.identityMat4(xr),c.translationMat4v(r,xr),c.identityMat4(wr),c.scalingMat4v([o/A,n/A,a/A],wr),c.mulMat4(xr,wr,e),e}function AP(r,e,t,i,s){function o(_,u){return _[0]*u[0]+_[1]*u[1]+_[2]*u[2]}let n,a,A,l,h,d,f=new Float32Array([0,0,0,0]),m=new Float32Array([0,0,0,0]);for(d=0;d<t;d+=3)f[0]=e[d],f[1]=e[d+1],f[2]=e[d+2],c.transformVec3(r,f,m),c.normalizeVec3(m,m),A=n=dn(m,"floor","floor"),a=pn(n),l=h=o(m,a),n=dn(m,"ceil","floor"),a=pn(n),l=o(m,a),l>h&&(A=n,h=l),n=dn(m,"floor","ceil"),a=pn(n),l=o(m,a),l>h&&(A=n,h=l),n=dn(m,"ceil","ceil"),a=pn(n),l=o(m,a),l>h&&(A=n,h=l),i[s+d+0]=A[0],i[s+d+1]=A[1],i[s+d+2]=0;return s+=t,s}function dn(r,e,t){let i=r[0]/(Math.abs(r[0])+Math.abs(r[1])+Math.abs(r[2])),s=r[1]/(Math.abs(r[0])+Math.abs(r[1])+Math.abs(r[2]));if(r[2]<0){let o=i,n=s;o=(1-Math.abs(s))*(i>=0?1:-1),n=(1-Math.abs(i))*(s>=0?1:-1),i=o,s=n}return new Int8Array([Math[e](i*127.5+(i<0?-1:0)),Math[t](s*127.5+(s<0?-1:0))])}function pn(r){let e=r[0],t=r[1];e/=e<0?127:128,t/=t<0?127:128;const i=1-Math.abs(e)-Math.abs(t);i<0&&(e=(1-Math.abs(t))*(e>=0?1:-1),t=(1-Math.abs(e))*(t>=0?1:-1));const s=Math.sqrt(e*e+t*t+i*i);return[e/s,t/s,i/s]}const lP=c.mat4(),cP=c.mat4(),hP=c.vec4([0,0,0,1]),uP=c.vec3(),dP=c.vec3(),pP=c.vec3(),fP=c.vec3(),gP=c.vec3(),mP=c.vec3(),_P=c.vec3();class pA{constructor(e){console.info("Creating VBOBatchingTrianglesLayer"),this.model=e.model,this.sortId="TrianglesBatchingLayer"+(e.solid?"-solid":"-surface")+(e.autoNormals?"-autonormals":"-normals")+(e.textureSet&&e.textureSet.colorTexture?"-colorTexture":"")+(e.textureSet&&e.textureSet.metallicRoughnessTexture?"-metallicRoughnessTexture":""),this.layerIndex=e.layerIndex,this._renderers=nP(e.model.scene),this._buffer=new aP(e.maxGeometryBatchSize),this._scratchMemory=e.scratchMemory,this._state=new Mt({origin:c.vec3(),positionsBuf:null,offsetsBuf:null,normalsBuf:null,colorsBuf:null,uvBuf:null,metallicRoughnessBuf:null,flagsBuf:null,indicesBuf:null,edgeIndicesBuf:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,textureSet:e.textureSet,pbrSupported:!1}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=c.collapseAABB3(),this._portions=[],this._meshes=[],this._numVerts=0,this._aabb=c.collapseAABB3(),this.aabbDirty=!0,this._finalized=!1,e.positionsDecodeMatrix&&(this._state.positionsDecodeMatrix=c.mat4(e.positionsDecodeMatrix)),e.uvDecodeMatrix?(this._state.uvDecodeMatrix=c.mat3(e.uvDecodeMatrix),this._preCompressedUVsExpected=!0):this._preCompressedUVsExpected=!1,e.origin&&this._state.origin.set(e.origin),this.solid=!!e.solid}get aabb(){if(this.aabbDirty){c.collapseAABB3(this._aabb);for(let e=0,t=this._meshes.length;e<t;e++)c.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}canCreatePortion(e,t){if(this._finalized)throw"Already finalized";return this._buffer.positions.length+e<this._buffer.maxVerts*3&&this._buffer.indices.length+t<this._buffer.maxIndices}createPortion(e,t){if(this._finalized)throw"Already finalized";const i=t.positions,s=t.positionsCompressed,o=t.normals,n=t.normalsCompressed,a=t.uv,A=t.uvCompressed,l=t.colors,h=t.colorsCompressed,d=t.indices,f=t.edgeIndices,m=t.color,_=t.metallic,u=t.roughness,B=t.opacity,y=t.meshMatrix,x=t.pickColor,P=this.model.scene,v=this._buffer,b=v.positions.length/3;let C;if(c.expandAABB3(this._modelAABB,t.aabb),this._state.positionsDecodeMatrix){if(!s)throw"positionsCompressed expected";C=s.length/3;for(let D=0,K=s.length;D<K;D++)v.positions.push(s[D])}else{if(!i)throw"positions expected";C=i.length/3;for(let D=0,K=i.length;D<K;D++)v.positions.push(i[D])}if(n&&n.length>0)for(let D=0,K=n.length;D<K;D++)v.normals.push(n[D]);else if(o&&o.length>0){const D=lP;y?c.inverseMat4(c.transposeMat4(y,cP),D):c.identityMat4(D,D),AP(D,o,o.length,v.normals,v.normals.length)}if(l)for(let D=0,K=l.length;D<K;D+=3)v.colors.push(l[D]*255),v.colors.push(l[D+1]*255),v.colors.push(l[D+2]*255),v.colors.push(255);else if(h)for(let D=0,K=l.length;D<K;D+=3)v.colors.push(l[D]),v.colors.push(l[D+1]),v.colors.push(l[D+2]),v.colors.push(255);else if(m){const D=m[0],K=m[1],j=m[2],z=B;for(let le=0;le<C;le++)v.colors.push(D),v.colors.push(K),v.colors.push(j),v.colors.push(z)}const I=_??0,E=u??255;for(let D=0;D<C;D++)v.metallicRoughness.push(I),v.metallicRoughness.push(E);if(a&&a.length>0)for(let D=0,K=a.length;D<K;D++)v.uv.push(a[D]);else if(A&&A.length>0)for(let D=0,K=A.length;D<K;D++)v.uv.push(A[D]);for(let D=0,K=d.length;D<K;D++)v.indices.push(b+d[D]);if(f)for(let D=0,K=f.length;D<K;D++)v.edgeIndices.push(b+f[D]);{const D=v.pickColors.length,K=C*4;for(let j=D,z=D+K;j<z;j+=4)v.pickColors.push(x[0]),v.pickColors.push(x[1]),v.pickColors.push(x[2]),v.pickColors.push(x[3])}if(P.entityOffsetsEnabled)for(let D=0;D<C;D++)v.offsets.push(0),v.offsets.push(0),v.offsets.push(0);const S=this._portions.length,R={vertsBaseIndex:b,numVerts:C,indicesBaseIndex:v.indices.length-d.length,numIndices:d.length};return P.pickSurfacePrecisionEnabled&&(R.indices=d,P.entityOffsetsEnabled&&(R.offset=new Float32Array(3))),this._portions.push(R),this._numPortions++,this.model.numPortions++,this._numVerts+=R.numVerts,this._meshes.push(e),S}finalize(){if(this._finalized)return;const e=this._state,t=this.model.scene.canvas.gl,i=this._buffer;if(i.positions.length>0){const s=this._state.positionsDecodeMatrix?new Uint16Array(i.positions):Do(i.positions,this._modelAABB,this._state.positionsDecodeMatrix=c.mat4());if(e.positionsBuf=new Ee(t,t.ARRAY_BUFFER,s,s.length,3,t.STATIC_DRAW),this.model.scene.pickSurfacePrecisionEnabled)for(let o=0,n=this._portions.length;o<n;o++){const a=this._portions[o],A=a.vertsBaseIndex*3,l=A+a.numVerts*3;a.quantizedPositions=s.slice(A,l)}}if(i.normals.length>0){const s=new Int8Array(i.normals);let o=!0;e.normalsBuf=new Ee(t,t.ARRAY_BUFFER,s,i.normals.length,3,t.STATIC_DRAW,o)}if(i.colors.length>0){const s=new Uint8Array(i.colors);let o=!1;e.colorsBuf=new Ee(t,t.ARRAY_BUFFER,s,i.colors.length,4,t.DYNAMIC_DRAW,o)}if(i.uv.length>0)if(e.uvDecodeMatrix){let s=!1;e.uvBuf=new Ee(t,t.ARRAY_BUFFER,i.uv,i.uv.length,2,t.STATIC_DRAW,s)}else{const s=st.getUVBounds(i.uv),o=st.compressUVs(i.uv,s.min,s.max),n=o.quantized;let a=!1;e.uvDecodeMatrix=c.mat3(o.decodeMatrix),e.uvBuf=new Ee(t,t.ARRAY_BUFFER,n,n.length,2,t.STATIC_DRAW,a)}if(i.metallicRoughness.length>0){const s=new Uint8Array(i.metallicRoughness);let o=!1;e.metallicRoughnessBuf=new Ee(t,t.ARRAY_BUFFER,s,i.metallicRoughness.length,2,t.STATIC_DRAW,o)}if(i.positions.length>0){const s=i.positions.length/3,o=new Float32Array(s),n=!1;e.flagsBuf=new Ee(t,t.ARRAY_BUFFER,o,o.length,1,t.DYNAMIC_DRAW,n)}if(i.pickColors.length>0){const s=new Uint8Array(i.pickColors);let o=!1;e.pickColorsBuf=new Ee(t,t.ARRAY_BUFFER,s,i.pickColors.length,4,t.STATIC_DRAW,o)}if(this.model.scene.entityOffsetsEnabled&&i.offsets.length>0){const s=new Float32Array(i.offsets);e.offsetsBuf=new Ee(t,t.ARRAY_BUFFER,s,i.offsets.length,3,t.DYNAMIC_DRAW)}if(i.indices.length>0){const s=new Uint32Array(i.indices);e.indicesBuf=new Ee(t,t.ELEMENT_ARRAY_BUFFER,s,i.indices.length,1,t.STATIC_DRAW)}if(i.edgeIndices.length>0){const s=new Uint32Array(i.edgeIndices);e.edgeIndicesBuf=new Ee(t,t.ELEMENT_ARRAY_BUFFER,s,i.edgeIndices.length,1,t.STATIC_DRAW)}this._state.pbrSupported=!!e.metallicRoughnessBuf&&!!e.uvBuf&&!!e.normalsBuf&&!!e.textureSet&&!!e.textureSet.colorTexture&&!!e.textureSet.metallicRoughnessTexture,this._state.colorTextureSupported=!!e.uvBuf&&!!e.textureSet&&!!e.textureSet.colorTexture,this._buffer=null,this._finalized=!0}isEmpty(){return!this._state.indicesBuf}initFlags(e,t,i){t&k.VISIBLE&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&k.HIGHLIGHTED&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&k.XRAYED&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&k.SELECTED&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&k.CLIPPABLE&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&k.EDGES&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&k.PICKABLE&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&k.CULLED&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i,!0)}flushInitFlags(){this._setDeferredFlags()}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&k.VISIBLE?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&k.HIGHLIGHTED?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&k.XRAYED?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&k.SELECTED?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){if(!this._finalized)throw"Not finalized";t&k.EDGES?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&k.CLIPPABLE?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,t)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&k.CULLED?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&k.PICKABLE?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){if(!this._finalized)throw"Not finalized";const i=e,s=this._portions[i],o=s.vertsBaseIndex,n=s.numVerts,a=o*4,A=n*4,l=this._scratchMemory.getUInt8Array(A),h=t[0],d=t[1],f=t[2],m=t[3];for(let _=0;_<A;_+=4)l[_+0]=h,l[_+1]=d,l[_+2]=f,l[_+3]=m;this._state.colorsBuf&&this._state.colorsBuf.setData(l,a,A)}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i,s=!1){if(!this._finalized)throw"Not finalized";const o=e,n=this._portions[o],a=n.vertsBaseIndex,A=n.numVerts,l=a,h=A,d=!!(t&k.VISIBLE),f=!!(t&k.XRAYED),m=!!(t&k.HIGHLIGHTED),_=!!(t&k.SELECTED),u=!!(t&k.EDGES),B=!!(t&k.PICKABLE),y=!!(t&k.CULLED);let x;!d||y||f||m&&!this.model.scene.highlightMaterial.glowThrough||_&&!this.model.scene.selectedMaterial.glowThrough?x=U.NOT_RENDERED:i?x=U.COLOR_TRANSPARENT:x=U.COLOR_OPAQUE;let P;!d||y?P=U.NOT_RENDERED:_?P=U.SILHOUETTE_SELECTED:m?P=U.SILHOUETTE_HIGHLIGHTED:f?P=U.SILHOUETTE_XRAYED:P=U.NOT_RENDERED;let v=0;!d||y?v=U.NOT_RENDERED:_?v=U.EDGES_SELECTED:m?v=U.EDGES_HIGHLIGHTED:f?v=U.EDGES_XRAYED:u?i?v=U.EDGES_COLOR_TRANSPARENT:v=U.EDGES_COLOR_OPAQUE:v=U.NOT_RENDERED;let b=d&&!y&&B?U.PICK:U.NOT_RENDERED;const C=t&k.CLIPPABLE?1:0;if(s){this._deferredFlagValues||(this._deferredFlagValues=new Float32Array(this._numVerts));for(let I=l,E=l+h;I<E;I++){let S=0;S|=x,S|=P<<4,S|=v<<8,S|=b<<12,S|=C<<16,this._deferredFlagValues[I]=S}}else if(this._state.flagsBuf){const I=this._scratchMemory.getFloat32Array(h);for(let E=0;E<h;E++){let S=0;S|=x,S|=P<<4,S|=v<<8,S|=b<<12,S|=C<<16,I[E]=S}this._state.flagsBuf.setData(I,l,h)}}_setDeferredFlags(){this._deferredFlagValues&&(this._state.flagsBuf.setData(this._deferredFlagValues),this._deferredFlagValues=null)}setOffset(e,t){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled){this.model.error("Entity#offset not enabled for this Viewer");return}const i=e,s=this._portions[i],o=s.vertsBaseIndex,n=s.numVerts,a=o*3,A=n*3,l=this._scratchMemory.getFloat32Array(A),h=t[0],d=t[1],f=t[2];for(let m=0;m<A;m+=3)l[m+0]=h,l[m+1]=d,l[m+2]=f;this._state.offsetsBuf&&this._state.offsetsBuf.setData(l,a,A),this.model.scene.pickSurfacePrecisionEnabled&&(s.offset[0]=t[0],s.offset[1]=t[1],s.offset[2]=t[2])}getEachVertex(e,t){if(!this.model.scene.pickSurfacePrecisionEnabled)return;const i=this._state,s=this._portions[e];if(!s){this.model.error("portion not found: "+e);return}const o=s.quantizedPositions,n=i.origin,a=s.offset,A=n[0]+a[0],l=n[1]+a[1],h=n[2]+a[2],d=hP;for(let f=0,m=o.length;f<m;f+=3)d[0]=o[f],d[1]=o[f+1],d[2]=o[f+2],d[3]=1,c.decompressPosition(d,i.positionsDecodeMatrix),c.transformPoint4(this.model.worldMatrix,d),d[0]+=A,d[1]+=l,d[2]+=h,t(d)}getElementsCountAndOffset(e){let t=null,i=null;const s=this._portions[e];return s&&(t=s.numIndices,i=s.indicesBaseIndex),{count:t,offset:i}}drawColorOpaque(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,t),t.withSAO&&this.model.saoEnabled?t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._renderers.pbrRendererWithSAO&&this._renderers.pbrRendererWithSAO.drawLayer(t,this,U.COLOR_OPAQUE):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?this._renderers.colorTextureRendererWithSAO&&this._renderers.colorTextureRendererWithSAO.drawLayer(t,this,U.COLOR_OPAQUE):this._state.normalsBuf?this._renderers.colorRendererWithSAO&&this._renderers.colorRendererWithSAO.drawLayer(t,this,U.COLOR_OPAQUE):this._renderers.flatColorRendererWithSAO&&this._renderers.flatColorRendererWithSAO.drawLayer(t,this,U.COLOR_OPAQUE):t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._renderers.pbrRenderer&&this._renderers.pbrRenderer.drawLayer(t,this,U.COLOR_OPAQUE):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?this._renderers.colorTextureRenderer&&this._renderers.colorTextureRenderer.drawLayer(t,this,U.COLOR_OPAQUE):this._state.normalsBuf?this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,U.COLOR_OPAQUE):this._renderers.flatColorRenderer&&this._renderers.flatColorRenderer.drawLayer(t,this,U.COLOR_OPAQUE))}_updateBackfaceCull(e,t){const i=this.model.backfaces||!this.solid||e.sectioned;if(t.backfaces!==i){const s=t.gl;i?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),t.backfaces=i}}drawColorTransparent(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===0||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,t),t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._renderers.pbrRenderer&&this._renderers.pbrRenderer.drawLayer(t,this,U.COLOR_TRANSPARENT):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?this._renderers.colorTextureRenderer&&this._renderers.colorTextureRenderer.drawLayer(t,this,U.COLOR_TRANSPARENT):this._state.normalsBuf?this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,U.COLOR_TRANSPARENT):this._renderers.flatColorRenderer&&this._renderers.flatColorRenderer.drawLayer(t,this,U.COLOR_TRANSPARENT))}drawDepth(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,t),this._renderers.depthRenderer&&this._renderers.depthRenderer.drawLayer(t,this,U.COLOR_OPAQUE))}drawNormals(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,t),this._renderers.normalsRenderer&&this._renderers.normalsRenderer.drawLayer(t,this,U.COLOR_OPAQUE))}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,U.SILHOUETTE_XRAYED))}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,U.SILHOUETTE_HIGHLIGHTED))}drawSilhouetteSelected(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,U.SILHOUETTE_SELECTED))}drawEdgesColorOpaque(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numEdgesLayerPortions===0||this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(t,this,U.EDGES_COLOR_OPAQUE)}drawEdgesColorTransparent(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numEdgesLayerPortions===0||this._numTransparentLayerPortions===0||this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(t,this,U.EDGES_COLOR_TRANSPARENT)}drawEdgesHighlighted(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,U.EDGES_HIGHLIGHTED)}drawEdgesSelected(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,U.EDGES_SELECTED)}drawEdgesXRayed(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,U.EDGES_XRAYED)}drawOcclusion(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.occlusionRenderer&&this._renderers.occlusionRenderer.drawLayer(t,this,U.COLOR_OPAQUE))}drawShadow(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.shadowRenderer&&this._renderers.shadowRenderer.drawLayer(t,this,U.COLOR_OPAQUE))}drawPickMesh(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.pickMeshRenderer&&this._renderers.pickMeshRenderer.drawLayer(t,this,U.PICK))}drawPickDepths(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.pickDepthRenderer&&this._renderers.pickDepthRenderer.drawLayer(t,this,U.PICK))}drawPickNormals(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.pickNormalsFlatRenderer&&this._renderers.pickNormalsFlatRenderer.drawLayer(t,this,U.PICK))}drawSnapInit(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(t,this,U.PICK))}drawSnap(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(t,this,U.PICK))}precisionRayPickSurface(e,t,i,s,o){if(!this.model.scene.pickSurfacePrecisionEnabled)return!1;const n=this._state,a=this._portions[e];if(!a)return this.model.error("portion not found: "+e),!1;const A=a.quantizedPositions,l=a.indices,h=n.origin,d=a.offset,f=uP,m=dP;f.set(h?c.subVec3(t,h,pP):t),m.set(i),d&&c.subVec3(f,d),c.transformRay(this.model.worldNormalMatrix,f,m,f,m);const _=fP,u=gP,B=mP;let y=!1,x=0;const P=_P;for(let v=0,b=l.length;v<b;v+=3){const C=l[v]*3,I=l[v+1]*3,E=l[v+2]*3;if(_[0]=A[C],_[1]=A[C+1],_[2]=A[C+2],u[0]=A[I],u[1]=A[I+1],u[2]=A[I+2],B[0]=A[E],B[1]=A[E+1],B[2]=A[E+2],c.decompressPosition(_,n.positionsDecodeMatrix),c.decompressPosition(u,n.positionsDecodeMatrix),c.decompressPosition(B,n.positionsDecodeMatrix),c.rayTriangleIntersect(f,m,_,u,B,P)){c.transformPoint3(this.model.worldMatrix,P,P),d&&c.addVec3(P,d),h&&c.addVec3(P,h);const S=Math.abs(c.lenVec3(c.subVec3(P,t,[])));(!y||S>x)&&(x=S,s.set(P),o&&c.triangleNormal(_,u,B,o),y=!0)}}return y&&o&&(c.transformVec3(this.model.worldNormalMatrix,o,o),c.normalizeVec3(o)),y}destroy(){const e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.normalsBuf&&(e.normalsBuf.destroy(),e.normalsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.metallicRoughnessBuf&&(e.metallicRoughnessBuf.destroy(),e.metallicRoughnessBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.indicesBuf&&(e.indicesBuf.destroy(),e.indicessBuf=null),e.edgeIndicesBuf&&(e.edgeIndicesBuf.destroy(),e.edgeIndicessBuf=null),e.destroy()}}class ui extends Wt{constructor(e,t,{edges:i=!1}={}){super(e,t,{instancing:!0,edges:i})}_draw(e){const{gl:t}=this._scene.canvas,{state:i,frameCtx:s,incrementDrawState:o}=e;this._edges?t.drawElementsInstanced(t.LINES,i.edgeIndicesBuf.numItems,i.edgeIndicesBuf.itemType,0,i.numInstances):(t.drawElementsInstanced(t.TRIANGLES,i.indicesBuf.numItems,i.indicesBuf.itemType,0,i.numInstances),o&&s.drawElements++)}}class Bu extends ui{_getHash(){const e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState,i=e._lightsState,s=t.getNumAllocatedSectionPlanes()>0;let o,n,a;const A=[];for(A.push("#version 300 es"),A.push("// Instancing geometry drawing vertex shader"),A.push("uniform int renderPass;"),A.push("in vec3 position;"),A.push("in vec2 normal;"),A.push("in vec4 color;"),A.push("in float flags;"),e.entityOffsetsEnabled&&A.push("in vec3 offset;"),A.push("in vec4 modelMatrixCol0;"),A.push("in vec4 modelMatrixCol1;"),A.push("in vec4 modelMatrixCol2;"),A.push("in vec4 modelNormalMatrixCol0;"),A.push("in vec4 modelNormalMatrixCol1;"),A.push("in vec4 modelNormalMatrixCol2;"),this._addMatricesUniformBlockLines(A,!0),e.logarithmicDepthBufferEnabled&&(A.push("uniform float logDepthBufFC;"),A.push("out float vFragDepth;"),A.push("bool isPerspectiveMatrix(mat4 m) {"),A.push("    return (m[2][3] == - 1.0);"),A.push("}"),A.push("out float isPerspective;")),A.push("uniform vec4 lightAmbient;"),o=0,n=i.lights.length;o<n;o++)a=i.lights[o],a.type!=="ambient"&&(A.push("uniform vec4 lightColor"+o+";"),a.type==="dir"&&A.push("uniform vec3 lightDir"+o+";"),a.type==="point"&&A.push("uniform vec3 lightPos"+o+";"),a.type==="spot"&&(A.push("uniform vec3 lightPos"+o+";"),A.push("uniform vec3 lightDir"+o+";")));for(A.push("vec3 octDecode(vec2 oct) {"),A.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),A.push("    if (v.z < 0.0) {"),A.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),A.push("    }"),A.push("    return normalize(v);"),A.push("}"),s&&(A.push("out vec4 vWorldPosition;"),A.push("out float vFlags;")),A.push("out vec4 vColor;"),A.push("void main(void) {"),A.push("int colorFlag = int(flags) & 0xF;"),A.push("if (colorFlag != renderPass) {"),A.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),A.push("} else {"),A.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),A.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&A.push("worldPosition.xyz = worldPosition.xyz + offset;"),A.push("vec4 viewPosition  = viewMatrix * worldPosition; "),A.push("vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),A.push("vec4 worldNormal = worldNormalMatrix * vec4(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2), 0.0);"),A.push("vec3 viewNormal = normalize(vec4(viewNormalMatrix * worldNormal).xyz);"),A.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),A.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),A.push("float lambertian = 1.0;"),o=0,n=i.lights.length;o<n;o++)if(a=i.lights[o],a.type!=="ambient"){if(a.type==="dir")a.space==="view"?A.push("viewLightDir = normalize(lightDir"+o+");"):A.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+o+", 0.0)).xyz);");else if(a.type==="point")a.space==="view"?A.push("viewLightDir = -normalize(lightPos"+o+" - viewPosition.xyz);"):A.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+o+", 0.0)).xyz);");else if(a.type==="spot")a.space==="view"?A.push("viewLightDir = normalize(lightDir"+o+");"):A.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+o+", 0.0)).xyz);");else continue;A.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),A.push("reflectedColor += lambertian * (lightColor"+o+".rgb * lightColor"+o+".a);")}return A.push("vec3 rgb = (vec3(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0));"),A.push("vColor =  vec4((lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedColor * rgb), float(color.a) / 255.0);"),A.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(A.push("vFragDepth = 1.0 + clipPos.w;"),A.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s&&(A.push("vWorldPosition = worldPosition;"),A.push("vFlags = flags;")),A.push("gl_Position = clipPos;"),A.push("}"),A.push("}"),A}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Instancing geometry drawing fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),this._withSAO&&(s.push("uniform sampler2D uOcclusionTexture;"),s.push("uniform vec4      uSAOParams;"),s.push("const float       packUpscale = 256. / 255.;"),s.push("const float       unpackDownScale = 255. / 256.;"),s.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),s.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),s.push("float unpackRGBToFloat( const in vec4 v ) {"),s.push("    return dot( v, unPackFactors );"),s.push("}")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";");s.push("uniform float sliceThickness;"),s.push("uniform vec4 sliceColor;")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),s.push("  vec4 newColor;"),s.push("  newColor = vColor;"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > sliceThickness) { "),s.push("      discard;"),s.push("  }"),s.push("  if (dist > 0.0) { "),s.push("      newColor = sliceColor;"),s.push("  }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),this._withSAO?(s.push("   float viewportWidth     = uSAOParams[0];"),s.push("   float viewportHeight    = uSAOParams[1];"),s.push("   float blendCutoff       = uSAOParams[2];"),s.push("   float blendFactor       = uSAOParams[3];"),s.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),s.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),s.push("   outColor                = vec4(newColor.rgb * ambient, 1.0);")):s.push("    outColor           = newColor;"),s.push("}"),s}}class Pu extends ui{_getHash(){const e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry flat-shading drawing vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec4 color;"),s.push("in float flags;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(s),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vViewPosition;"),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vViewPosition = viewPosition;"),s.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=e._lightsState;let s,o;const n=t.getNumAllocatedSectionPlanes()>0,a=[];if(a.push("#version 300 es"),a.push("// Instancing geometry flat-shading drawing fragment shader"),a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),e.logarithmicDepthBufferEnabled&&(a.push("in float isPerspective;"),a.push("uniform float logDepthBufFC;"),a.push("in float vFragDepth;")),this._withSAO&&(a.push("uniform sampler2D uOcclusionTexture;"),a.push("uniform vec4      uSAOParams;"),a.push("const float       packUpscale = 256. / 255.;"),a.push("const float       unpackDownScale = 255. / 256.;"),a.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),a.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),a.push("float unpackRGBToFloat( const in vec4 v ) {"),a.push("    return dot( v, unPackFactors );"),a.push("}")),n){a.push("in vec4 vWorldPosition;"),a.push("in float vFlags;");for(let A=0,l=t.getNumAllocatedSectionPlanes();A<l;A++)a.push("uniform bool sectionPlaneActive"+A+";"),a.push("uniform vec3 sectionPlanePos"+A+";"),a.push("uniform vec3 sectionPlaneDir"+A+";");a.push("uniform float sliceThickness;"),a.push("uniform vec4 sliceColor;")}for(this._addMatricesUniformBlockLines(a),a.push("uniform vec4 lightAmbient;"),s=0,o=i.lights.length;s<o;s++){const A=i.lights[s];A.type!=="ambient"&&(a.push("uniform vec4 lightColor"+s+";"),A.type==="dir"&&a.push("uniform vec3 lightDir"+s+";"),A.type==="point"&&a.push("uniform vec3 lightPos"+s+";"),A.type==="spot"&&(a.push("uniform vec3 lightPos"+s+";"),a.push("uniform vec3 lightDir"+s+";")))}if(a.push("in vec4 vViewPosition;"),a.push("in vec4 vColor;"),a.push("out vec4 outColor;"),a.push("void main(void) {"),a.push("  vec4 newColor;"),a.push("  newColor = vColor;"),n){a.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;");for(let A=0,l=t.getNumAllocatedSectionPlanes();A<l;A++)a.push("if (sectionPlaneActive"+A+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+A+".xyz, vWorldPosition.xyz - sectionPlanePos"+A+".xyz), 0.0, 1000.0);"),a.push("}");a.push("  if (dist > sliceThickness) { "),a.push("      discard;"),a.push("  }"),a.push("  if (dist > 0.0) { "),a.push("      newColor = sliceColor;"),a.push("  }"),a.push("}")}for(a.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),a.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),a.push("float lambertian = 1.0;"),a.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),a.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),a.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );"),s=0,o=i.lights.length;s<o;s++){const A=i.lights[s];if(A.type!=="ambient"){if(A.type==="dir")A.space==="view"?a.push("viewLightDir = normalize(lightDir"+s+");"):a.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+s+", 0.0)).xyz);");else if(A.type==="point")A.space==="view"?a.push("viewLightDir = -normalize(lightPos"+s+" - viewPosition.xyz);"):a.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+s+", 0.0)).xyz);");else if(A.type==="spot")A.space==="view"?a.push("viewLightDir = normalize(lightDir"+s+");"):a.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+s+", 0.0)).xyz);");else continue;a.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),a.push("reflectedColor += lambertian * (lightColor"+s+".rgb * lightColor"+s+".a);")}}return a.push("vec4 fragColor = vec4((lightAmbient.rgb * lightAmbient.a * newColor.rgb) + (reflectedColor * newColor.rgb), newColor.a);"),this._withSAO?(a.push("   float viewportWidth     = uSAOParams[0];"),a.push("   float viewportHeight    = uSAOParams[1];"),a.push("   float blendCutoff       = uSAOParams[2];"),a.push("   float blendFactor       = uSAOParams[3];"),a.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),a.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),a.push("   outColor            = vec4(fragColor.rgb * ambient, 1.0);")):a.push("    outColor           = fragColor;"),e.logarithmicDepthBufferEnabled&&a.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("}"),a}}class yu extends ui{drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Instancing silhouette vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 color;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(s),s.push("uniform vec4 silhouetteColor;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),s.push("if (silhouetteFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("vColor = vec4(silhouetteColor.r, silhouetteColor.g, silhouetteColor.b, min(silhouetteColor.a, float(color.a) / 255.0));"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Instancing fill fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";");s.push("uniform float sliceThickness;"),s.push("uniform vec4 sliceColor;")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),s.push("  vec4 newColor;"),s.push("  newColor = vColor;"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > sliceThickness) { "),s.push("      discard;"),s.push("  }"),s.push("  if (dist > 0.0) { "),s.push("      newColor = sliceColor;"),s.push("  }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = newColor;"),s.push("}"),s}}class ig extends ui{constructor(e,t){super(e,t,{instancing:!0,edges:!0})}}class vP extends ig{drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// EdgesEmphasisRenderer vertex shader"),s.push("uniform int renderPass;"),s.push("uniform vec4 color;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(s),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("int edgeFlag = int(flags) >> 8 & 0xF;"),s.push("if (edgeFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition = worldMatrix * positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("vColor = vec4(color.r, color.g, color.b, color.a);"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// EdgesEmphasisRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = vColor;"),s.push("}"),s}}class BP extends ig{drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!1})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// EdgesColorRenderer vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec4 color;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(s),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("int edgeFlag = int(flags) >> 8 & 0xF;"),s.push("if (edgeFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("vColor = vec4(float(color.r*0.5) / 255.0, float(color.g*0.5) / 255.0, float(color.b*0.5) / 255.0, float(color.a) / 255.0);"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// EdgesColorRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = vColor;"),s.push("}"),s}}class xu extends ui{_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry picking vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 pickColor;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),this._addRemapClipPosLines(s),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vPickColor;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("  vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),i&&(s.push("  vWorldPosition = worldPosition;"),s.push("  vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = remapClipPos(clipPos);"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry picking fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vPickColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = vPickColor; "),s.push("}"),s}}class wu extends ui{_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry depth vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),this._addRemapClipPosLines(s),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vViewPosition;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("  vWorldPosition = worldPosition;"),s.push("  vFlags = flags;")),s.push("  vViewPosition = viewPosition;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = remapClipPos(clipPos);"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry depth fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("uniform float pickZNear;"),s.push("uniform float pickZFar;"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),s.push("    outColor = packDepth(zNormalizedDepth); "),s.push("}"),s}}class PP extends ui{_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry normals vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec2 normal;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("in vec4 modelNormalMatrixCol0;"),s.push("in vec4 modelNormalMatrixCol1;"),s.push("in vec4 modelNormalMatrixCol2;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),this._addRemapClipPosLines(s,3),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),s.push("vec3 octDecode(vec2 oct) {"),s.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),s.push("    if (v.z < 0.0) {"),s.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),s.push("    }"),s.push("    return normalize(v);"),s.push("}"),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec3 vWorldNormal;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("  vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),s.push("  vec3 worldNormal = vec3(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2));"),s.push("  vWorldNormal = worldNormal;"),i&&(s.push("  vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = remapClipPos(clipPos);"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry normals fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let n=0;n<t.getNumAllocatedSectionPlanes();n++)s.push("uniform bool sectionPlaneActive"+n+";"),s.push("uniform vec3 sectionPlanePos"+n+";"),s.push("uniform vec3 sectionPlaneDir"+n+";")}if(s.push("in vec3 vWorldNormal;"),s.push("out highp ivec4 outNormal;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push(`    outNormal = ivec4(vWorldNormal * float(${c.MAX_INT}), 1.0);`),s.push("}"),s}}class yP extends ui{_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// TrianglesInstancingOcclusionRenderer vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 color;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(s),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("  vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// TrianglesInstancingOcclusionRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),s.push("}"),s}}class xP extends ui{_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry depth drawing vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(s),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec2 vHighPrecisionZW;"),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("vHighPrecisionZW = gl_Position.zw;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState;let i,s;const o=t.getNumAllocatedSectionPlanes()>0,n=[];if(n.push("#version 300 es"),n.push("// Instancing geometry depth drawing fragment shader"),n.push("precision highp float;"),n.push("precision highp int;"),e.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),o)for(n.push("in vec4 vWorldPosition;"),n.push("in float vFlags;"),i=0,s=t.getNumAllocatedSectionPlanes();i<s;i++)n.push("uniform bool sectionPlaneActive"+i+";"),n.push("uniform vec3 sectionPlanePos"+i+";"),n.push("uniform vec3 sectionPlaneDir"+i+";");if(n.push("in vec2 vHighPrecisionZW;"),n.push("out vec4 outColor;"),n.push("void main(void) {"),o){for(n.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;"),i=0,s=t.getNumAllocatedSectionPlanes();i<s;i++)n.push("if (sectionPlaneActive"+i+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),n.push("}");n.push("if (dist > 0.0) { discard; }"),n.push("}")}return e.logarithmicDepthBufferEnabled&&n.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;"),n.push("    outColor = vec4(vec3(1.0 - fragCoordZ), 1.0); "),n.push("}"),n}}class wP extends ui{_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry normals drawing vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec3 normal;"),s.push("in vec4 color;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(s,!0),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),s.push("vec3 octDecode(vec2 oct) {"),s.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),s.push("    if (v.z < 0.0) {"),s.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),s.push("    }"),s.push("    return normalize(v);"),s.push("}"),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec3 vViewNormal;"),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("  vec4 worldNormal    = worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),s.push("  vec3 viewNormal     = normalize((viewNormalMatrix * worldNormal).xyz);"),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("  vViewNormal = viewNormal;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Instancing geometry depth drawing fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec3 vViewNormal;"),s.push("vec3 packNormalToRGB( const in vec3 normal ) {"),s.push("    return normalize( normal ) * 0.5 + 0.5;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    outColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),s.push("}"),s}}class bP extends ui{_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry shadow drawing vertex shader"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 color;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform mat4 shadowViewMatrix;"),s.push("uniform mat4 shadowProjMatrix;"),this._addMatricesUniformBlockLines(s),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("bool visible = (colorFlag > 0);"),s.push("bool transparent  = ((float(color.a) / 255.0) < 1.0);"),s.push("if (!visible || transparent) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = shadowViewMatrix * worldPosition; "),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("  gl_Position = shadowProjMatrix * viewPosition;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Instancing geometry depth drawing fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec3 vViewNormal;"),s.push("vec3 packNormalToRGB( const in vec3 normal ) {"),s.push("    return normalize( normal ) * 0.5 + 0.5;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    outColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),s.push("}"),s}}const la={};la[yr]="linearToLinear";la[wt]="sRGBToLinear";class bu extends ui{_getHash(){const e=this._scene;return[e.gammaOutput,e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState,i=e._lightsState,s=t.getNumAllocatedSectionPlanes()>0,o=t.clippingCaps,n=[];return n.push("#version 300 es"),n.push("// Instancing geometry quality drawing vertex shader"),n.push("uniform int renderPass;"),n.push("in vec3 position;"),n.push("in vec3 normal;"),n.push("in vec4 color;"),n.push("in vec2 uv;"),n.push("in vec2 metallicRoughness;"),n.push("in float flags;"),e.entityOffsetsEnabled&&n.push("in vec3 offset;"),n.push("in vec4 modelMatrixCol0;"),n.push("in vec4 modelMatrixCol1;"),n.push("in vec4 modelMatrixCol2;"),n.push("in vec4 modelNormalMatrixCol0;"),n.push("in vec4 modelNormalMatrixCol1;"),n.push("in vec4 modelNormalMatrixCol2;"),this._addMatricesUniformBlockLines(n,!0),n.push("uniform mat3 uvDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),n.push("out float vFragDepth;"),n.push("bool isPerspectiveMatrix(mat4 m) {"),n.push("    return (m[2][3] == - 1.0);"),n.push("}"),n.push("out float isPerspective;")),n.push("vec3 octDecode(vec2 oct) {"),n.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),n.push("    if (v.z < 0.0) {"),n.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),n.push("    }"),n.push("    return normalize(v);"),n.push("}"),n.push("out vec4 vViewPosition;"),n.push("out vec3 vViewNormal;"),n.push("out vec4 vColor;"),n.push("out vec2 vUV;"),n.push("out vec2 vMetallicRoughness;"),i.lightMaps.length>0&&n.push("out vec3 vWorldNormal;"),s&&(n.push("out vec4 vWorldPosition;"),n.push("out float vFlags;"),o&&n.push("out vec4 vClipPosition;")),n.push("void main(void) {"),n.push("int colorFlag = int(flags) & 0xF;"),n.push("if (colorFlag != renderPass) {"),n.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),n.push("} else {"),n.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),n.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&n.push("      worldPosition.xyz = worldPosition.xyz + offset;"),n.push("vec4 viewPosition  = viewMatrix * worldPosition; "),n.push("vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),n.push("vec4 worldNormal = worldNormalMatrix * vec4(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2), 1.0);"),n.push("vec3 viewNormal = vec4(viewNormalMatrix * worldNormal).xyz;"),n.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(n.push("vFragDepth = 1.0 + clipPos.w;"),n.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s&&(n.push("vWorldPosition = worldPosition;"),n.push("vFlags = flags;"),o&&n.push("vClipPosition = clipPos;")),n.push("vViewPosition = viewPosition;"),n.push("vViewNormal = viewNormal;"),n.push("vColor = color;"),n.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"),n.push("vMetallicRoughness = metallicRoughness;"),i.lightMaps.length>0&&n.push("vWorldNormal = worldNormal.xyz;"),n.push("gl_Position = clipPos;"),n.push("}"),n.push("}"),n}_buildFragmentShader(){const e=this._scene,t=e.gammaOutput,i=e._sectionPlanesState,s=e._lightsState,o=i.getNumAllocatedSectionPlanes()>0,n=i.clippingCaps,a=[];a.push("#version 300 es"),a.push("// Instancing geometry quality drawing fragment shader"),a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),e.logarithmicDepthBufferEnabled&&(a.push("in float isPerspective;"),a.push("uniform float logDepthBufFC;"),a.push("in float vFragDepth;")),a.push("uniform sampler2D uColorMap;"),a.push("uniform sampler2D uMetallicRoughMap;"),a.push("uniform sampler2D uEmissiveMap;"),a.push("uniform sampler2D uNormalMap;"),this._withSAO&&(a.push("uniform sampler2D uOcclusionTexture;"),a.push("uniform vec4      uSAOParams;"),a.push("const float       packUpscale = 256. / 255.;"),a.push("const float       unpackDownScale = 255. / 256.;"),a.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),a.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),a.push("float unpackRGBToFloat( const in vec4 v ) {"),a.push("    return dot( v, unPackFactors );"),a.push("}")),s.reflectionMaps.length>0&&a.push("uniform samplerCube reflectionMap;"),s.lightMaps.length>0&&a.push("uniform samplerCube lightMap;"),a.push("uniform vec4 lightAmbient;");for(let A=0,l=s.lights.length;A<l;A++){const h=s.lights[A];h.type!=="ambient"&&(a.push("uniform vec4 lightColor"+A+";"),h.type==="dir"&&a.push("uniform vec3 lightDir"+A+";"),h.type==="point"&&a.push("uniform vec3 lightPos"+A+";"),h.type==="spot"&&(a.push("uniform vec3 lightPos"+A+";"),a.push("uniform vec3 lightDir"+A+";")))}if(a.push("uniform float gammaFactor;"),a.push("vec4 linearToLinear( in vec4 value ) {"),a.push("  return value;"),a.push("}"),a.push("vec4 sRGBToLinear( in vec4 value ) {"),a.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),a.push("}"),a.push("vec4 gammaToLinear( in vec4 value) {"),a.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),a.push("}"),t&&(a.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),a.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),a.push("}")),o){a.push("in vec4 vWorldPosition;"),a.push("in float vFlags;"),n&&a.push("in vec4 vClipPosition;");for(let A=0,l=i.getNumAllocatedSectionPlanes();A<l;A++)a.push("uniform bool sectionPlaneActive"+A+";"),a.push("uniform vec3 sectionPlanePos"+A+";"),a.push("uniform vec3 sectionPlaneDir"+A+";")}if(a.push("in vec4 vViewPosition;"),a.push("in vec3 vViewNormal;"),a.push("in vec4 vColor;"),a.push("in vec2 vUV;"),a.push("in vec2 vMetallicRoughness;"),s.lightMaps.length>0&&a.push("in vec3 vWorldNormal;"),this._addMatricesUniformBlockLines(a,!0),a.push("#define PI 3.14159265359"),a.push("#define RECIPROCAL_PI 0.31830988618"),a.push("#define RECIPROCAL_PI2 0.15915494"),a.push("#define EPSILON 1e-6"),a.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),a.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),a.push("       vec3 texel = texture( uNormalMap, uv ).xyz;"),a.push("       if (texel.r == 0.0 && texel.g == 0.0 && texel.b == 0.0) {"),a.push("              return normalize(surf_norm );"),a.push("       }"),a.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),a.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),a.push("      vec2 st0 = dFdx( uv.st );"),a.push("      vec2 st1 = dFdy( uv.st );"),a.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),a.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),a.push("      vec3 N = normalize( surf_norm );"),a.push("      vec3 mapN = texel.xyz * 2.0 - 1.0;"),a.push("      mat3 tsn = mat3( S, T, N );"),a.push("      return normalize( tsn * mapN );"),a.push("}"),a.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),a.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),a.push("}"),a.push("struct IncidentLight {"),a.push("   vec3 color;"),a.push("   vec3 direction;"),a.push("};"),a.push("struct ReflectedLight {"),a.push("   vec3 diffuse;"),a.push("   vec3 specular;"),a.push("};"),a.push("struct Geometry {"),a.push("   vec3 position;"),a.push("   vec3 viewNormal;"),a.push("   vec3 worldNormal;"),a.push("   vec3 viewEyeDir;"),a.push("};"),a.push("struct Material {"),a.push("   vec3    diffuseColor;"),a.push("   float   specularRoughness;"),a.push("   vec3    specularColor;"),a.push("   float   shine;"),a.push("};"),a.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),a.push("   float r = ggxRoughness + 0.0001;"),a.push("   return (2.0 / (r * r) - 2.0);"),a.push("}"),a.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),a.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),a.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),a.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),a.push("}"),s.reflectionMaps.length>0&&(a.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),a.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),a.push("   vec3 envMapColor = "+la[s.reflectionMaps[0].encoding]+"(texture(reflectionMap, reflectVec, mipLevel)).rgb;"),a.push("  return envMapColor;"),a.push("}")),a.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),a.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),a.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),a.push("}"),a.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),a.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),a.push("   return 1.0 / ( gl * gv );"),a.push("}"),a.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),a.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),a.push("   return 0.5 / max( gv + gl, EPSILON );"),a.push("}"),a.push("float D_GGX(const in float alpha, const in float dotNH) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),a.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),a.push("}"),a.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),a.push("   float alpha = ( roughness * roughness );"),a.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),a.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),a.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),a.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),a.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),a.push("   vec3  F = F_Schlick( specularColor, dotLH );"),a.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),a.push("   float D = D_GGX( alpha, dotNH );"),a.push("   return F * (G * D);"),a.push("}"),a.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),a.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),a.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),a.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),a.push("   vec4 r = roughness * c0 + c1;"),a.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),a.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),a.push("   return specularColor * AB.x + AB.y;"),a.push("}"),(s.lightMaps.length>0||s.reflectionMaps.length>0)&&(a.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),s.lightMaps.length>0&&(a.push("   vec3 irradiance = "+la[s.lightMaps[0].encoding]+"(texture(lightMap, geometry.worldNormal)).rgb;"),a.push("   irradiance *= PI;"),a.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),a.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),s.reflectionMaps.length>0&&(a.push("   vec3 reflectVec             = reflect(geometry.viewEyeDir, geometry.viewNormal);"),a.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),a.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),a.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),a.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),a.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),a.push("}")),a.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),a.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),a.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),a.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),a.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),a.push("}"),a.push("out vec4 outColor;"),a.push("void main(void) {"),o){a.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;");for(let A=0,l=i.getNumAllocatedSectionPlanes();A<l;A++)a.push("if (sectionPlaneActive"+A+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+A+".xyz, vWorldPosition.xyz - sectionPlanePos"+A+".xyz), 0.0, 1000.0);"),a.push("}");n?(a.push("  if (dist > (0.002 * vClipPosition.w)) {"),a.push("      discard;"),a.push("  }"),a.push("  if (dist > 0.0) { "),a.push("      outColor=vec4(1.0, 0.0, 0.0, 1.0);"),e.logarithmicDepthBufferEnabled&&a.push("  gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("  return;"),a.push("}")):(a.push("  if (dist > 0.0) { "),a.push("      discard;"),a.push("  }")),a.push("}")}a.push("IncidentLight  light;"),a.push("Material       material;"),a.push("Geometry       geometry;"),a.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),a.push("vec3 rgb = (vec3(float(vColor.r) / 255.0, float(vColor.g) / 255.0, float(vColor.b) / 255.0));"),a.push("float opacity = float(vColor.a) / 255.0;"),a.push("vec3  baseColor = rgb;"),a.push("float specularF0 = 1.0;"),a.push("float metallic = float(vMetallicRoughness.r) / 255.0;"),a.push("float roughness = float(vMetallicRoughness.g) / 255.0;"),a.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),a.push("vec4 colorTexel = sRGBToLinear(texture(uColorMap, vUV));"),a.push("baseColor *= colorTexel.rgb;"),a.push("vec3 metalRoughTexel = texture(uMetallicRoughMap, vUV).rgb;"),a.push("metallic *= metalRoughTexel.b;"),a.push("roughness *= metalRoughTexel.g;"),a.push("vec3 viewNormal = perturbNormal2Arb( vViewPosition.xyz, normalize(vViewNormal), vUV );"),a.push("material.diffuseColor      = baseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),a.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),a.push("material.specularColor     = mix(vec3(dielectricSpecular), baseColor, metallic);"),a.push("geometry.position      = vViewPosition.xyz;"),a.push("geometry.viewNormal    = -normalize(viewNormal);"),a.push("geometry.viewEyeDir    = normalize(vViewPosition.xyz);"),s.lightMaps.length>0&&a.push("geometry.worldNormal   = normalize(vWorldNormal);"),(s.lightMaps.length>0||s.reflectionMaps.length>0)&&a.push("computePBRLightMapping(geometry, material, reflectedLight);");for(let A=0,l=s.lights.length;A<l;A++){const h=s.lights[A];if(h.type!=="ambient"){if(h.type==="dir")h.space==="view"?a.push("light.direction = normalize(lightDir"+A+");"):a.push("light.direction = normalize((viewMatrix * vec4(lightDir"+A+", 0.0)).xyz);");else if(h.type==="point")h.space==="view"?a.push("light.direction = normalize(lightPos"+A+" - vViewPosition.xyz);"):a.push("light.direction = normalize((viewMatrix * vec4(lightPos"+A+", 0.0)).xyz);");else if(h.type==="spot")h.space==="view"?a.push("light.direction = normalize(lightDir"+A+");"):a.push("light.direction = normalize((viewMatrix * vec4(lightDir"+A+", 0.0)).xyz);");else continue;a.push("light.color =  lightColor"+A+".rgb * lightColor"+A+".a;"),a.push("computePBRLighting(light, geometry, material, reflectedLight);")}}return a.push("vec3 emissiveColor = sRGBToLinear(texture(uEmissiveMap, vUV)).rgb;"),a.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * baseColor * opacity * rgb) + (reflectedLight.diffuse) + (reflectedLight.specular) + emissiveColor;"),a.push("vec4 fragColor;"),this._withSAO?(a.push("   float viewportWidth     = uSAOParams[0];"),a.push("   float viewportHeight    = uSAOParams[1];"),a.push("   float blendCutoff       = uSAOParams[2];"),a.push("   float blendFactor       = uSAOParams[3];"),a.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),a.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),a.push("   fragColor            = vec4(outgoingLight.rgb * ambient, opacity);")):a.push("   fragColor            = vec4(outgoingLight.rgb, opacity);"),t&&a.push("fragColor = linearToGamma(fragColor, gammaFactor);"),a.push("outColor = fragColor;"),e.logarithmicDepthBufferEnabled&&a.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("}"),a}}class CP extends ui{_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry normals vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),this._addRemapClipPosLines(s,3),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&s.push("out float vFlags;"),s.push("out vec4 vWorldPosition;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("  vWorldPosition = worldPosition;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i&&s.push("vFlags = flags;"),s.push("gl_Position = remapClipPos(clipPos);"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry normals fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("in vec4 vWorldPosition;"),i){s.push("in float vFlags;");for(let n=0;n<t.getNumAllocatedSectionPlanes();n++)s.push("uniform bool sectionPlaneActive"+n+";"),s.push("uniform vec3 sectionPlanePos"+n+";"),s.push("uniform vec3 sectionPlaneDir"+n+";")}if(s.push("out highp ivec4 outNormal;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("  vec3 xTangent = dFdx( vWorldPosition.xyz );"),s.push("  vec3 yTangent = dFdy( vWorldPosition.xyz );"),s.push("  vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),s.push(`  outNormal = ivec4(worldNormal * float(${c.MAX_INT}), 1.0);`),s.push("}"),s}}class Cu extends ui{_getHash(){const e=this._scene;return[e.gammaOutput,e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry drawing vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec4 color;"),s.push("in vec2 uv;"),s.push("in float flags;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(s),s.push("uniform mat3 uvDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vViewPosition;"),s.push("out vec4 vColor;"),s.push("out vec2 vUV;"),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vViewPosition = viewPosition;"),s.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),s.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e.gammaOutput,i=e._sectionPlanesState,s=e._lightsState;let o,n;const a=i.getNumAllocatedSectionPlanes()>0,A=[];if(A.push("#version 300 es"),A.push("// Instancing geometry drawing fragment shader"),A.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),A.push("precision highp float;"),A.push("precision highp int;"),A.push("#else"),A.push("precision mediump float;"),A.push("precision mediump int;"),A.push("#endif"),e.logarithmicDepthBufferEnabled&&(A.push("in float isPerspective;"),A.push("uniform float logDepthBufFC;"),A.push("in float vFragDepth;")),A.push("uniform sampler2D uColorMap;"),this._withSAO&&(A.push("uniform sampler2D uOcclusionTexture;"),A.push("uniform vec4      uSAOParams;"),A.push("const float       packUpscale = 256. / 255.;"),A.push("const float       unpackDownScale = 255. / 256.;"),A.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),A.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),A.push("float unpackRGBToFloat( const in vec4 v ) {"),A.push("    return dot( v, unPackFactors );"),A.push("}")),A.push("uniform float gammaFactor;"),A.push("vec4 linearToLinear( in vec4 value ) {"),A.push("  return value;"),A.push("}"),A.push("vec4 sRGBToLinear( in vec4 value ) {"),A.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),A.push("}"),A.push("vec4 gammaToLinear( in vec4 value) {"),A.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),A.push("}"),t&&(A.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),A.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),A.push("}")),a){A.push("in vec4 vWorldPosition;"),A.push("in float vFlags;");for(let l=0,h=i.getNumAllocatedSectionPlanes();l<h;l++)A.push("uniform bool sectionPlaneActive"+l+";"),A.push("uniform vec3 sectionPlanePos"+l+";"),A.push("uniform vec3 sectionPlaneDir"+l+";");A.push("uniform float sliceThickness;"),A.push("uniform vec4 sliceColor;")}for(this._addMatricesUniformBlockLines(A),A.push("uniform vec4 lightAmbient;"),o=0,n=s.lights.length;o<n;o++){const l=s.lights[o];l.type!=="ambient"&&(A.push("uniform vec4 lightColor"+o+";"),l.type==="dir"&&A.push("uniform vec3 lightDir"+o+";"),l.type==="point"&&A.push("uniform vec3 lightPos"+o+";"),l.type==="spot"&&(A.push("uniform vec3 lightPos"+o+";"),A.push("uniform vec3 lightDir"+o+";")))}if(A.push("in vec4 vViewPosition;"),A.push("in vec4 vColor;"),A.push("in vec2 vUV;"),A.push("out vec4 outColor;"),A.push("void main(void) {"),A.push("  vec4 newColor;"),A.push("  newColor = vColor;"),a){A.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),A.push("  if (clippable) {"),A.push("  float dist = 0.0;");for(let l=0,h=i.getNumAllocatedSectionPlanes();l<h;l++)A.push("if (sectionPlaneActive"+l+") {"),A.push("   dist += clamp(dot(-sectionPlaneDir"+l+".xyz, vWorldPosition.xyz - sectionPlanePos"+l+".xyz), 0.0, 1000.0);"),A.push("}");A.push("  if (dist > sliceThickness) { "),A.push("      discard;"),A.push("  }"),A.push("  if (dist > 0.0) { "),A.push("      newColor = sliceColor;"),A.push("  }"),A.push("}")}for(A.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),A.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),A.push("float lambertian = 1.0;"),A.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),A.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),A.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );"),o=0,n=s.lights.length;o<n;o++){const l=s.lights[o];if(l.type!=="ambient"){if(l.type==="dir")l.space==="view"?A.push("viewLightDir = normalize(lightDir"+o+");"):A.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+o+", 0.0)).xyz);");else if(l.type==="point")l.space==="view"?A.push("viewLightDir = -normalize(lightPos"+o+" - viewPosition.xyz);"):A.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+o+", 0.0)).xyz);");else if(l.type==="spot")l.space==="view"?A.push("viewLightDir = normalize(lightDir"+o+");"):A.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+o+", 0.0)).xyz);");else continue;A.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),A.push("reflectedColor += lambertian * (lightColor"+o+".rgb * lightColor"+o+".a);")}}return A.push("vec4 color =  vec4((lightAmbient.rgb * lightAmbient.a * newColor.rgb) + (reflectedColor * newColor.rgb), newColor.a);"),t?A.push("vec4 colorTexel = color * sRGBToLinear(texture(uColorMap, vUV));"):A.push("vec4 colorTexel = color * texture(uColorMap, vUV);"),A.push("float opacity = color.a;"),this._withSAO?(A.push("   float viewportWidth     = uSAOParams[0];"),A.push("   float viewportHeight    = uSAOParams[1];"),A.push("   float blendCutoff       = uSAOParams[2];"),A.push("   float blendFactor       = uSAOParams[3];"),A.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),A.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),A.push("   outColor                = vec4(newColor.rgb * colorTexel.rgb * ambient, opacity);")):A.push("   outColor                = vec4(newColor.rgb * colorTexel.rgb, opacity);"),t&&A.push("outColor = linearToGamma(outColor, gammaFactor);"),e.logarithmicDepthBufferEnabled&&A.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),A.push("}"),A}}const EP=c.vec3(),IP=c.vec3(),FP=c.vec3(),MP=c.vec3(),SP=c.mat4();class Eu extends Wt{constructor(e){super(e,!1,{instancing:!0})}drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,o=s.scene,n=o.canvas.gl,a=o.camera,A=t._state,l=t._state.origin,{position:h,rotationMatrix:d,rotationMatrixConjugate:f}=s,m=t.aabb,_=e.pickViewMatrix||a.viewMatrix;this._vaoCache.has(t)?n.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(A));const u=EP;u[0]=c.safeInv(m[3]-m[0])*c.MAX_INT,u[1]=c.safeInv(m[4]-m[1])*c.MAX_INT,u[2]=c.safeInv(m[5]-m[2])*c.MAX_INT,e.snapPickCoordinateScale[0]=c.safeInv(u[0]),e.snapPickCoordinateScale[1]=c.safeInv(u[1]),e.snapPickCoordinateScale[2]=c.safeInv(u[2]);let B,y;if(l||h[0]!==0||h[1]!==0||h[2]!==0){const v=IP;if(l){const b=c.transformPoint3(d,l,FP);v[0]=b[0],v[1]=b[1],v[2]=b[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=h[0],v[1]+=h[1],v[2]+=h[2],B=ft(_,v,SP),y=MP,y[0]=a.eye[0]-v[0],y[1]=a.eye[1]-v[1],y[2]=a.eye[2]-v[2],e.snapPickOrigin[0]=v[0],e.snapPickOrigin[1]=v[1],e.snapPickOrigin[2]=v[2]}else B=_,y=a.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;n.uniform3fv(this._uCameraEyeRtc,y),n.uniform2fv(this.uVectorA,e.snapVectorA),n.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),n.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),n.uniform3fv(this._uCoordinateScaler,u),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible);let x=0;const P=4*4;this._matricesUniformBlockBufferData.set(f,0),this._matricesUniformBlockBufferData.set(B,x+=P),this._matricesUniformBlockBufferData.set(a.projMatrix,x+=P),this._matricesUniformBlockBufferData.set(A.positionsDecodeMatrix,x+=P),n.bindBuffer(n.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),n.bufferData(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,n.DYNAMIC_DRAW),n.bindBufferBase(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const v=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,v)}this.setSectionPlanesStateUniforms(t),this._aModelMatrixCol0.bindArrayBuffer(A.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(A.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(A.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aFlags&&(this._aFlags.bindArrayBuffer(A.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1)),A.indicesBuf.bind(),n.drawElementsInstanced(n.TRIANGLES,A.indicesBuf.numItems,A.indicesBuf.itemType,0,A.numInstances),A.indicesBuf.unbind(),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),this._aFlags&&n.vertexAttribDivisor(this._aFlags.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// SnapInstancingDepthBufInitRenderer vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),s.push("in vec4 pickColor;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),s.push("uniform vec3 uCameraEyeRtc;"),s.push("uniform vec2 snapVectorA;"),s.push("uniform vec2 snapInvVectorAB;"),s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;"),s.push("vec2 remapClipPos(vec2 clipPos) {"),s.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),s.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),s.push("    return vec2(x, y);"),s.push("}"),s.push("flat out vec4 vPickColor;"),s.push("out vec4 vWorldPosition;"),i&&s.push("out float vFlags;"),s.push("out highp vec3 relativeToOriginPosition;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("relativeToOriginPosition = worldPosition.xyz;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("  vWorldPosition = worldPosition;"),i&&s.push("  vFlags = flags;"),s.push("vPickColor = pickColor;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),s.push("float tmp = clipPos.w;"),s.push("clipPos.xyzw /= tmp;"),s.push("clipPos.xy = remapClipPos(clipPos.xy);"),s.push("clipPos.xyzw *= tmp;"),s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points instancing pick depth fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;"),s.push("uniform int layerNumber;"),s.push("uniform vec3 coordinateScaler;"),s.push("in vec4 vWorldPosition;"),s.push("flat in vec4 vPickColor;"),i){s.push("in float vFlags;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in highp vec3 relativeToOriginPosition;"),s.push("layout(location = 0) out highp ivec4 outCoords;"),s.push("layout(location = 1) out highp ivec4 outNormal;"),s.push("layout(location = 2) out lowp uvec4 outPickColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("    float dx = dFdx(vFragDepth);"),s.push("    float dy = dFdy(vFragDepth);"),s.push("    float diff = sqrt(dx*dx+dy*dy);"),s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),s.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),s.push("vec3 xTangent = dFdx( vWorldPosition.xyz );"),s.push("vec3 yTangent = dFdy( vWorldPosition.xyz );"),s.push("vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),s.push(`outNormal = ivec4(worldNormal * float(${c.MAX_INT}), 1.0);`),s.push("outPickColor = uvec4(vPickColor);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const TP=c.vec3(),DP=c.vec3(),RP=c.vec3(),LP=c.vec3(),UP=c.mat4();class Iu extends Wt{constructor(e){super(e,!1,{instancing:!0})}drawLayer(e,t,i){if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,o=s.scene,n=o.camera,a=o.canvas.gl,A=t._state,l=t._state.origin,{position:h,rotationMatrix:d,rotationMatrixConjugate:f}=s,m=t.aabb,_=e.pickViewMatrix||n.viewMatrix;this._vaoCache.has(t)?a.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(A));const u=TP;u[0]=c.safeInv(m[3]-m[0])*c.MAX_INT,u[1]=c.safeInv(m[4]-m[1])*c.MAX_INT,u[2]=c.safeInv(m[5]-m[2])*c.MAX_INT,e.snapPickCoordinateScale[0]=c.safeInv(u[0]),e.snapPickCoordinateScale[1]=c.safeInv(u[1]),e.snapPickCoordinateScale[2]=c.safeInv(u[2]);let B,y;if(l||h[0]!==0||h[1]!==0||h[2]!==0){const v=DP;if(l){const b=c.transformPoint3(d,l,RP);v[0]=b[0],v[1]=b[1],v[2]=b[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=h[0],v[1]+=h[1],v[2]+=h[2],B=ft(_,v,UP),y=LP,y[0]=n.eye[0]-v[0],y[1]=n.eye[1]-v[1],y[2]=n.eye[2]-v[2],e.snapPickOrigin[0]=v[0],e.snapPickOrigin[1]=v[1],e.snapPickOrigin[2]=v[2]}else B=_,y=n.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;a.uniform3fv(this._uCameraEyeRtc,y),a.uniform2fv(this.uVectorA,e.snapVectorA),a.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),a.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),a.uniform3fv(this._uCoordinateScaler,u),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,e.pickInvisible);let x=0;const P=4*4;this._matricesUniformBlockBufferData.set(f,0),this._matricesUniformBlockBufferData.set(B,x+=P),this._matricesUniformBlockBufferData.set(n.projMatrix,x+=P),this._matricesUniformBlockBufferData.set(A.positionsDecodeMatrix,x+=P),a.bindBuffer(a.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),a.bufferData(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,a.DYNAMIC_DRAW),a.bindBufferBase(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const v=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,v)}this.setSectionPlanesStateUniforms(t),this._aModelMatrixCol0.bindArrayBuffer(A.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(A.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(A.modelMatrixCol2Buf),a.vertexAttribDivisor(this._aModelMatrixCol0.location,1),a.vertexAttribDivisor(this._aModelMatrixCol1.location,1),a.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aFlags.bindArrayBuffer(A.flagsBuf),a.vertexAttribDivisor(this._aFlags.location,1),e.snapMode==="edge"?(A.edgeIndicesBuf.bind(),a.drawElementsInstanced(a.LINES,A.edgeIndicesBuf.numItems,A.edgeIndicesBuf.itemType,0,A.numInstances),A.edgeIndicesBuf.unbind()):a.drawArraysInstanced(a.POINTS,0,A.positionsBuf.numItems,A.numInstances),a.vertexAttribDivisor(this._aModelMatrixCol0.location,0),a.vertexAttribDivisor(this._aModelMatrixCol1.location,0),a.vertexAttribDivisor(this._aModelMatrixCol2.location,0),a.vertexAttribDivisor(this._aFlags.location,0),this._aOffset&&a.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// SnapInstancingDepthRenderer vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),s.push("uniform vec3 uCameraEyeRtc;"),s.push("uniform vec2 snapVectorA;"),s.push("uniform vec2 snapInvVectorAB;"),s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;"),s.push("vec2 remapClipPos(vec2 clipPos) {"),s.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),s.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),s.push("    return vec2(x, y);"),s.push("}"),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out highp vec3 relativeToOriginPosition;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("relativeToOriginPosition = worldPosition.xyz;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("  vWorldPosition = worldPosition;"),s.push("  vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),s.push("float tmp = clipPos.w;"),s.push("clipPos.xyzw /= tmp;"),s.push("clipPos.xy = remapClipPos(clipPos.xy);"),s.push("clipPos.xyzw *= tmp;"),s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),s.push("gl_Position = clipPos;"),s.push("gl_PointSize = 1.0;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// SnapInstancingDepthRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;"),s.push("uniform int layerNumber;"),s.push("uniform vec3 coordinateScaler;"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in highp vec3 relativeToOriginPosition;"),s.push("out highp ivec4 outCoords;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class OP{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._colorRendererWithSAO&&!this._colorRendererWithSAO.getValid()&&(this._colorRendererWithSAO.destroy(),this._colorRendererWithSAO=null),this._flatColorRenderer&&!this._flatColorRenderer.getValid()&&(this._flatColorRenderer.destroy(),this._flatColorRenderer=null),this._flatColorRendererWithSAO&&!this._flatColorRendererWithSAO.getValid()&&(this._flatColorRendererWithSAO.destroy(),this._flatColorRendererWithSAO=null),this._pbrRenderer&&!this._pbrRenderer.getValid()&&(this._pbrRenderer.destroy(),this._pbrRenderer=null),this._pbrRendererWithSAO&&!this._pbrRendererWithSAO.getValid()&&(this._pbrRendererWithSAO.destroy(),this._pbrRendererWithSAO=null),this._colorTextureRenderer&&!this._colorTextureRenderer.getValid()&&(this._colorTextureRenderer.destroy(),this._colorTextureRenderer=null),this._colorTextureRendererWithSAO&&!this._colorTextureRendererWithSAO.getValid()&&(this._colorTextureRendererWithSAO.destroy(),this._colorTextureRendererWithSAO=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._normalsRenderer&&!this._normalsRenderer.getValid()&&(this._normalsRenderer.destroy(),this._normalsRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._edgesRenderer&&!this._edgesRenderer.getValid()&&(this._edgesRenderer.destroy(),this._edgesRenderer=null),this._edgesColorRenderer&&!this._edgesColorRenderer.getValid()&&(this._edgesColorRenderer.destroy(),this._edgesColorRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&this._pickNormalsRenderer.getValid()===!1&&(this._pickNormalsRenderer.destroy(),this._pickNormalsRenderer=null),this._pickNormalsFlatRenderer&&!this._pickNormalsFlatRenderer.getValid()&&(this._pickNormalsFlatRenderer.destroy(),this._pickNormalsFlatRenderer=null),this._occlusionRenderer&&this._occlusionRenderer.getValid()===!1&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}eagerCreateRenders(){this._silhouetteRenderer||(this._silhouetteRenderer=new yu(this._scene)),this._pickMeshRenderer||(this._pickMeshRenderer=new xu(this._scene)),this._pickDepthRenderer||(this._pickDepthRenderer=new wu(this._scene)),this._snapInitRenderer||(this._snapInitRenderer=new Eu(this._scene,!1)),this._snapRenderer||(this._snapRenderer=new Iu(this._scene))}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new Bu(this._scene,!1)),this._colorRenderer}get colorRendererWithSAO(){return this._colorRendererWithSAO||(this._colorRendererWithSAO=new Bu(this._scene,!0)),this._colorRendererWithSAO}get flatColorRenderer(){return this._flatColorRenderer||(this._flatColorRenderer=new Pu(this._scene,!1)),this._flatColorRenderer}get flatColorRendererWithSAO(){return this._flatColorRendererWithSAO||(this._flatColorRendererWithSAO=new Pu(this._scene,!0)),this._flatColorRendererWithSAO}get pbrRenderer(){return this._pbrRenderer||(this._pbrRenderer=new bu(this._scene,!1)),this._pbrRenderer}get pbrRendererWithSAO(){return this._pbrRendererWithSAO||(this._pbrRendererWithSAO=new bu(this._scene,!0)),this._pbrRendererWithSAO}get colorTextureRenderer(){return this._colorTextureRenderer||(this._colorTextureRenderer=new Cu(this._scene,!1)),this._colorTextureRenderer}get colorTextureRendererWithSAO(){return this._colorTextureRendererWithSAO||(this._colorTextureRendererWithSAO=new Cu(this._scene,!0)),this._colorTextureRendererWithSAO}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new yu(this._scene)),this._silhouetteRenderer}get depthRenderer(){return this._depthRenderer||(this._depthRenderer=new xP(this._scene)),this._depthRenderer}get normalsRenderer(){return this._normalsRenderer||(this._normalsRenderer=new wP(this._scene)),this._normalsRenderer}get edgesRenderer(){return this._edgesRenderer||(this._edgesRenderer=new vP(this._scene)),this._edgesRenderer}get edgesColorRenderer(){return this._edgesColorRenderer||(this._edgesColorRenderer=new BP(this._scene)),this._edgesColorRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new xu(this._scene)),this._pickMeshRenderer}get pickNormalsRenderer(){return this._pickNormalsRenderer||(this._pickNormalsRenderer=new PP(this._scene)),this._pickNormalsRenderer}get pickNormalsFlatRenderer(){return this._pickNormalsFlatRenderer||(this._pickNormalsFlatRenderer=new CP(this._scene)),this._pickNormalsFlatRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new wu(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new yP(this._scene)),this._occlusionRenderer}get shadowRenderer(){return this._shadowRenderer||(this._shadowRenderer=new bP(this._scene)),this._shadowRenderer}get snapInitRenderer(){return this._snapInitRenderer||(this._snapInitRenderer=new Eu(this._scene,!1)),this._snapInitRenderer}get snapRenderer(){return this._snapRenderer||(this._snapRenderer=new Iu(this._scene)),this._snapRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._colorRendererWithSAO&&this._colorRendererWithSAO.destroy(),this._flatColorRenderer&&this._flatColorRenderer.destroy(),this._flatColorRendererWithSAO&&this._flatColorRendererWithSAO.destroy(),this._pbrRenderer&&this._pbrRenderer.destroy(),this._pbrRendererWithSAO&&this._pbrRendererWithSAO.destroy(),this._colorTextureRenderer&&this._colorTextureRenderer.destroy(),this._colorTextureRendererWithSAO&&this._colorTextureRendererWithSAO.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._normalsRenderer&&this._normalsRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._edgesRenderer&&this._edgesRenderer.destroy(),this._edgesColorRenderer&&this._edgesColorRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._pickNormalsRenderer&&this._pickNormalsRenderer.destroy(),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}const fA={};function kP(r){const e=r.id;let t=fA[e];return t||(t=new OP(r),fA[e]=t,t._compile(),t.eagerCreateRenders(),r.on("compile",()=>{t._compile(),t.eagerCreateRenders()}),r.on("destroyed",()=>{delete fA[e],t._destroy()})),t}const Yr=new Uint8Array(4),Fu=new Float32Array(1),NP=c.vec4([0,0,0,1]),fn=new Float32Array(3),QP=c.vec3(),HP=c.vec3(),VP=c.vec3(),GP=c.vec3(),jP=c.vec3(),zP=c.vec3(),KP=c.vec3(),si=new Float32Array(4);class gA{constructor(e){console.info("Creating VBOInstancingTrianglesLayer"),this.model=e.model,this.sortId="TrianglesInstancingLayer"+(e.solid?"-solid":"-surface")+(e.normals?"-normals":"-autoNormals"),this.layerIndex=e.layerIndex,this._renderers=kP(e.model.scene),this._aabb=c.collapseAABB3(),this._state=new Mt({numInstances:0,obb:c.OBB3(),origin:c.vec3(),geometry:e.geometry,textureSet:e.textureSet,pbrSupported:!1,positionsDecodeMatrix:e.geometry.positionsDecodeMatrix,colorsBuf:null,metallicRoughnessBuf:null,flagsBuf:null,offsetsBuf:null,modelMatrixBuf:null,modelMatrixCol0Buf:null,modelMatrixCol1Buf:null,modelMatrixCol2Buf:null,modelNormalMatrixCol0Buf:null,modelNormalMatrixCol1Buf:null,modelNormalMatrixCol2Buf:null,pickColorsBuf:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this.numIndices=e.geometry.numIndices,this._colors=[],this._metallicRoughness=[],this._pickColors=[],this._offsets=[],this._modelMatrix=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._modelNormalMatrixCol0=[],this._modelNormalMatrixCol1=[],this._modelNormalMatrixCol2=[],this._portions=[],this._meshes=[],this._aabb=c.collapseAABB3(),this.aabbDirty=!0,e.origin&&this._state.origin.set(e.origin),this._finalized=!1,this.solid=!!e.solid,this.numIndices=e.geometry.numIndices}get aabb(){if(this.aabbDirty){c.collapseAABB3(this._aabb);for(let e=0,t=this._meshes.length;e<t;e++)c.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}createPortion(e,t){const i=t.color,s=t.metallic,o=t.roughness,n=t.opacity!==null&&t.opacity!==void 0?t.opacity:255,a=t.meshMatrix,A=t.pickColor;if(this._finalized)throw"Already finalized";const l=i[0],h=i[1],d=i[2];if(this._colors.push(l),this._colors.push(h),this._colors.push(d),this._colors.push(n),this._metallicRoughness.push(s??0),this._metallicRoughness.push(o??255),this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(a[0]),this._modelMatrixCol0.push(a[4]),this._modelMatrixCol0.push(a[8]),this._modelMatrixCol0.push(a[12]),this._modelMatrixCol1.push(a[1]),this._modelMatrixCol1.push(a[5]),this._modelMatrixCol1.push(a[9]),this._modelMatrixCol1.push(a[13]),this._modelMatrixCol2.push(a[2]),this._modelMatrixCol2.push(a[6]),this._modelMatrixCol2.push(a[10]),this._modelMatrixCol2.push(a[14]),this._state.geometry.normals){let _=c.transposeMat4(a,c.mat4()),u=c.inverseMat4(_);this._modelNormalMatrixCol0.push(u[0]),this._modelNormalMatrixCol0.push(u[4]),this._modelNormalMatrixCol0.push(u[8]),this._modelNormalMatrixCol0.push(u[12]),this._modelNormalMatrixCol1.push(u[1]),this._modelNormalMatrixCol1.push(u[5]),this._modelNormalMatrixCol1.push(u[9]),this._modelNormalMatrixCol1.push(u[13]),this._modelNormalMatrixCol2.push(u[2]),this._modelNormalMatrixCol2.push(u[6]),this._modelNormalMatrixCol2.push(u[10]),this._modelNormalMatrixCol2.push(u[14])}this._pickColors.push(A[0]),this._pickColors.push(A[1]),this._pickColors.push(A[2]),this._pickColors.push(A[3]),this._state.numInstances++;const f=this._portions.length,m={};return this.model.scene.pickSurfacePrecisionEnabled&&(m.matrix=a.slice(),m.inverseMatrix=null,m.normalMatrix=null),this._portions.push(m),this._numPortions++,this.model.numPortions++,this._meshes.push(e),f}finalize(){if(this._finalized)return;const e=this._state,t=e.geometry,i=e.textureSet,s=this.model.scene.canvas.gl,o=this._colors.length,n=o/4;if(o>0){let a=!1;e.colorsBuf=new Ee(s,s.ARRAY_BUFFER,new Uint8Array(this._colors),this._colors.length,4,s.DYNAMIC_DRAW,a),this._colors=[]}if(this._metallicRoughness.length>0){const a=new Uint8Array(this._metallicRoughness);let A=!1;e.metallicRoughnessBuf=new Ee(s,s.ARRAY_BUFFER,a,this._metallicRoughness.length,2,s.STATIC_DRAW,A)}if(n>0){let a=!1;e.flagsBuf=new Ee(s,s.ARRAY_BUFFER,new Float32Array(n),n,1,s.DYNAMIC_DRAW,a)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0&&(e.offsetsBuf=new Ee(s,s.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,s.DYNAMIC_DRAW,!1),this._offsets=[]),t.positionsCompressed&&t.positionsCompressed.length>0&&(e.positionsBuf=new Ee(s,s.ARRAY_BUFFER,t.positionsCompressed,t.positionsCompressed.length,3,s.STATIC_DRAW,!1),e.positionsDecodeMatrix=c.mat4(t.positionsDecodeMatrix)),t.colorsCompressed&&t.colorsCompressed.length>0){const a=new Uint8Array(t.colorsCompressed),A=!1;e.colorsBuf=new Ee(s,s.ARRAY_BUFFER,a,a.length,4,s.STATIC_DRAW,A)}if(t.uvCompressed&&t.uvCompressed.length>0){const a=t.uvCompressed;e.uvDecodeMatrix=t.uvDecodeMatrix,e.uvBuf=new Ee(s,s.ARRAY_BUFFER,a,a.length,2,s.STATIC_DRAW,!1)}t.indices&&t.indices.length>0&&(e.indicesBuf=new Ee(s,s.ELEMENT_ARRAY_BUFFER,new Uint32Array(t.indices),t.indices.length,1,s.STATIC_DRAW),e.numIndices=t.indices.length),(t.primitive==="triangles"||t.primitive==="solid"||t.primitive==="surface")&&(e.edgeIndicesBuf=new Ee(s,s.ELEMENT_ARRAY_BUFFER,new Uint32Array(t.edgeIndices),t.edgeIndices.length,1,s.STATIC_DRAW)),this._modelMatrixCol0.length>0&&(e.modelMatrixCol0Buf=new Ee(s,s.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,s.STATIC_DRAW,!1),e.modelMatrixCol1Buf=new Ee(s,s.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,s.STATIC_DRAW,!1),e.modelMatrixCol2Buf=new Ee(s,s.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,s.STATIC_DRAW,!1),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],e.normalsBuf&&(e.modelNormalMatrixCol0Buf=new Ee(s,s.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol0),this._modelNormalMatrixCol0.length,4,s.STATIC_DRAW,!1),e.modelNormalMatrixCol1Buf=new Ee(s,s.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol1),this._modelNormalMatrixCol1.length,4,s.STATIC_DRAW,!1),e.modelNormalMatrixCol2Buf=new Ee(s,s.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol2),this._modelNormalMatrixCol2.length,4,s.STATIC_DRAW,!1),this._modelNormalMatrixCol0=[],this._modelNormalMatrixCol1=[],this._modelNormalMatrixCol2=[])),this._pickColors.length>0&&(e.pickColorsBuf=new Ee(s,s.ARRAY_BUFFER,new Uint8Array(this._pickColors),this._pickColors.length,4,s.STATIC_DRAW,!1),this._pickColors=[]),e.pbrSupported=!!e.metallicRoughnessBuf&&!!e.uvBuf&&!!e.normalsBuf&&!!i&&!!i.colorTexture&&!!i.metallicRoughnessTexture,e.colorTextureSupported=!!e.uvBuf&&!!i&&!!i.colorTexture,this._state.geometry=null,this._finalized=!0}initFlags(e,t,i){t&k.VISIBLE&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&k.HIGHLIGHTED&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&k.XRAYED&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&k.SELECTED&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&k.CLIPPABLE&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&k.EDGES&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&k.PICKABLE&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&k.CULLED&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i)}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&k.VISIBLE?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&k.HIGHLIGHTED?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&k.XRAYED?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&k.SELECTED?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){if(!this._finalized)throw"Not finalized";t&k.EDGES?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&k.CLIPPABLE?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,t)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&k.PICKABLE?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&k.CULLED?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){if(!this._finalized)throw"Not finalized";Yr[0]=t[0],Yr[1]=t[1],Yr[2]=t[2],Yr[3]=t[3],this._state.colorsBuf&&this._state.colorsBuf.setData(Yr,e*4)}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i){if(!this._finalized)throw"Not finalized";const s=!!(t&k.VISIBLE),o=!!(t&k.XRAYED),n=!!(t&k.HIGHLIGHTED),a=!!(t&k.SELECTED),A=!!(t&k.EDGES),l=!!(t&k.PICKABLE),h=!!(t&k.CULLED);let d;!s||h||o||n&&!this.model.scene.highlightMaterial.glowThrough||a&&!this.model.scene.selectedMaterial.glowThrough?d=U.NOT_RENDERED:i?d=U.COLOR_TRANSPARENT:d=U.COLOR_OPAQUE;let f;!s||h?f=U.NOT_RENDERED:a?f=U.SILHOUETTE_SELECTED:n?f=U.SILHOUETTE_HIGHLIGHTED:o?f=U.SILHOUETTE_XRAYED:f=U.NOT_RENDERED;let m=0;!s||h?m=U.NOT_RENDERED:a?m=U.EDGES_SELECTED:n?m=U.EDGES_HIGHLIGHTED:o?m=U.EDGES_XRAYED:A?i?m=U.EDGES_COLOR_TRANSPARENT:m=U.EDGES_COLOR_OPAQUE:m=U.NOT_RENDERED;const _=s&&!h&&l?U.PICK:U.NOT_RENDERED,u=t&k.CLIPPABLE?1:0;let B=0;B|=d,B|=f<<4,B|=m<<8,B|=_<<12,B|=u<<16,Fu[0]=B,this._state.flagsBuf&&this._state.flagsBuf.setData(Fu,e)}setOffset(e,t){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled){this.model.error("Entity#offset not enabled for this Viewer");return}fn[0]=t[0],fn[1]=t[1],fn[2]=t[2],this._state.offsetsBuf&&this._state.offsetsBuf.setData(fn,e*3)}getEachVertex(e,t){if(!this.model.scene.pickSurfacePrecisionEnabled)return!1;const i=this._state,s=i.geometry,o=this._portions[e];if(!o){this.model.error("portion not found: "+e);return}const n=s.quantizedPositions,a=i.origin,A=o.offset,l=a[0]+A[0],h=a[1]+A[1],d=a[2]+A[2],f=NP,m=o.matrix,_=this.model.sceneModelMatrix,u=i.positionsDecodeMatrix;for(let B=0,y=n.length;B<y;B+=3)f[0]=n[B],f[1]=n[B+1],f[2]=n[B+2],c.decompressPosition(f,u),c.transformPoint3(m,f),c.transformPoint3(_,f),f[0]+=l,f[1]+=h,f[2]+=d,t(f)}setMatrix(e,t){if(!this._finalized)throw"Not finalized";var i=e*4;si[0]=t[0],si[1]=t[4],si[2]=t[8],si[3]=t[12],this._state.modelMatrixCol0Buf.setData(si,i),si[0]=t[1],si[1]=t[5],si[2]=t[9],si[3]=t[13],this._state.modelMatrixCol1Buf.setData(si,i),si[0]=t[2],si[1]=t[6],si[2]=t[10],si[3]=t[14],this._state.modelMatrixCol2Buf.setData(si,i)}drawColorOpaque(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,t),t.withSAO&&this.model.saoEnabled?t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._renderers.pbrRendererWithSAO&&this._renderers.pbrRendererWithSAO.drawLayer(t,this,U.COLOR_OPAQUE):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?this._renderers.colorTextureRendererWithSAO&&this._renderers.colorTextureRendererWithSAO.drawLayer(t,this,U.COLOR_OPAQUE):this._state.normalsBuf?this._renderers.colorRendererWithSAO&&this._renderers.colorRendererWithSAO.drawLayer(t,this,U.COLOR_OPAQUE):this._renderers.flatColorRendererWithSAO&&this._renderers.flatColorRendererWithSAO.drawLayer(t,this,U.COLOR_OPAQUE):t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._renderers.pbrRenderer&&this._renderers.pbrRenderer.drawLayer(t,this,U.COLOR_OPAQUE):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?this._renderers.colorTextureRenderer&&this._renderers.colorTextureRenderer.drawLayer(t,this,U.COLOR_OPAQUE):this._state.normalsBuf?this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,U.COLOR_OPAQUE):this._renderers.flatColorRenderer&&this._renderers.flatColorRenderer.drawLayer(t,this,U.COLOR_OPAQUE))}_updateBackfaceCull(e,t){const i=this.model.backfaces||!this.solid||e.sectioned;if(t.backfaces!==i){const s=t.gl;i?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),t.backfaces=i}}drawColorTransparent(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===0||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,t),t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._renderers.pbrRenderer&&this._renderers.pbrRenderer.drawLayer(t,this,U.COLOR_TRANSPARENT):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?this._renderers.colorTextureRenderer&&this._renderers.colorTextureRenderer.drawLayer(t,this,U.COLOR_TRANSPARENT):this._state.normalsBuf?this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,U.COLOR_TRANSPARENT):this._renderers.flatColorRenderer&&this._renderers.flatColorRenderer.drawLayer(t,this,U.COLOR_TRANSPARENT))}drawDepth(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,t),this._renderers.depthRenderer&&this._renderers.depthRenderer.drawLayer(t,this,U.COLOR_OPAQUE))}drawNormals(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,t),this._renderers.normalsRenderer&&this._renderers.normalsRenderer.drawLayer(t,this,U.COLOR_OPAQUE))}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,U.SILHOUETTE_XRAYED))}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,U.SILHOUETTE_HIGHLIGHTED))}drawSilhouetteSelected(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,U.SILHOUETTE_SELECTED))}drawEdgesColorOpaque(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numEdgesLayerPortions===0||this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(t,this,U.EDGES_COLOR_OPAQUE)}drawEdgesColorTransparent(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numEdgesLayerPortions===0||this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(t,this,U.EDGES_COLOR_TRANSPARENT)}drawEdgesXRayed(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,U.EDGES_XRAYED)}drawEdgesHighlighted(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,U.EDGES_HIGHLIGHTED)}drawEdgesSelected(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,U.EDGES_SELECTED)}drawOcclusion(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.occlusionRenderer&&this._renderers.occlusionRenderer.drawLayer(t,this,U.COLOR_OPAQUE))}drawShadow(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.shadowRenderer&&this._renderers.shadowRenderer.drawLayer(t,this,U.COLOR_OPAQUE))}drawPickMesh(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.pickMeshRenderer&&this._renderers.pickMeshRenderer.drawLayer(t,this,U.PICK))}drawPickDepths(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.pickDepthRenderer&&this._renderers.pickDepthRenderer.drawLayer(t,this,U.PICK))}drawPickNormals(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.pickNormalsFlatRenderer&&this._renderers.pickNormalsFlatRenderer.drawLayer(t,this,U.PICK))}drawSnapInit(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(t,this,U.PICK))}drawSnap(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(t,this,U.PICK))}precisionRayPickSurface(e,t,i,s,o){if(!this.model.scene.pickSurfacePrecisionEnabled)return!1;const n=this._state.geometry,a=this._state,A=this._portions[e];if(!A)return this.model.error("portion not found: "+e),!1;A.inverseMatrix||(A.inverseMatrix=c.inverseMat4(A.matrix,c.mat4())),o&&!A.normalMatrix&&(A.normalMatrix=c.transposeMat4(A.inverseMatrix,c.mat4()));const l=n.quantizedPositions,h=n.indices,d=a.origin,f=A.offset,m=QP,_=HP;m.set(d?c.subVec3(t,d,VP):t),_.set(i),f&&c.subVec3(m,f),c.transformRay(this.model.worldNormalMatrix,m,_,m,_),c.transformRay(A.inverseMatrix,m,_,m,_);const u=GP,B=jP,y=zP;let x=!1,P=0;const v=KP;for(let b=0,C=h.length;b<C;b+=3){const I=h[b+0]*3,E=h[b+1]*3,S=h[b+2]*3;u[0]=l[I],u[1]=l[I+1],u[2]=l[I+2],B[0]=l[E],B[1]=l[E+1],B[2]=l[E+2],y[0]=l[S],y[1]=l[S+1],y[2]=l[S+2];const{positionsDecodeMatrix:R}=a.geometry;if(c.decompressPosition(u,R),c.decompressPosition(B,R),c.decompressPosition(y,R),c.rayTriangleIntersect(m,_,u,B,y,v)){c.transformPoint3(A.matrix,v,v),c.transformPoint3(this.model.worldMatrix,v,v),f&&c.addVec3(v,f),d&&c.addVec3(v,d);const D=Math.abs(c.lenVec3(c.subVec3(v,t,[])));(!x||D>P)&&(P=D,s.set(v),o&&c.triangleNormal(u,B,y,o),x=!0)}}return x&&o&&(c.transformVec3(A.normalMatrix,o,o),c.transformVec3(this.model.worldNormalMatrix,o,o),c.normalizeVec3(o)),x}destroy(){const e=this._state;e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.metallicRoughnessBuf&&(e.metallicRoughnessBuf.destroy(),e.metallicRoughnessBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.modelMatrixCol0Buf&&(e.modelMatrixCol0Buf.destroy(),e.modelMatrixCol0Buf=null),e.modelMatrixCol1Buf&&(e.modelMatrixCol1Buf.destroy(),e.modelMatrixCol1Buf=null),e.modelMatrixCol2Buf&&(e.modelMatrixCol2Buf.destroy(),e.modelMatrixCol2Buf=null),e.modelNormalMatrixCol0Buf&&(e.modelNormalMatrixCol0Buf.destroy(),e.modelNormalMatrixCol0Buf=null),e.modelNormalMatrixCol1Buf&&(e.modelNormalMatrixCol1Buf.destroy(),e.modelNormalMatrixCol1Buf=null),e.modelNormalMatrixCol2Buf&&(e.modelNormalMatrixCol2Buf.destroy(),e.modelNormalMatrixCol2Buf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.destroy(),this._state=null}}class sg extends Wt{_draw(e){const{gl:t}=this._scene.canvas,{state:i,frameCtx:s,incrementDrawState:o}=e;t.drawElements(t.LINES,i.indicesBuf.numItems,i.indicesBuf.itemType,0),o&&s.drawElements++}}class WP extends sg{drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Lines batching color vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec4 color;"),s.push("in float flags;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),this._addMatricesUniformBlockLines(s),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Lines batching color fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   outColor            = vColor;"),e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}}class XP extends sg{drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Lines batching silhouette vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),this._addMatricesUniformBlockLines(s),s.push("uniform vec4 color;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("void main(void) {"),s.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),s.push("if (silhouetteFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Lines batching silhouette fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("uniform vec4 color;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = color;"),s.push("}"),s}}const YP=c.vec3(),JP=c.vec3(),ZP=c.vec3(),qP=c.vec3(),$P=c.mat4();class ey extends Wt{drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,o=s.scene,n=o.camera,a=o.canvas.gl,A=t._state,l=t._state.origin,{position:h,rotationMatrix:d,rotationMatrixConjugate:f}=s,m=t.aabb,_=e.pickViewMatrix||n.viewMatrix;this._vaoCache.has(t)?a.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(A));const u=YP;u[0]=c.safeInv(m[3]-m[0])*c.MAX_INT,u[1]=c.safeInv(m[4]-m[1])*c.MAX_INT,u[2]=c.safeInv(m[5]-m[2])*c.MAX_INT,e.snapPickCoordinateScale[0]=c.safeInv(u[0]),e.snapPickCoordinateScale[1]=c.safeInv(u[1]),e.snapPickCoordinateScale[2]=c.safeInv(u[2]);let B,y;if(l||h[0]!==0||h[1]!==0||h[2]!==0){const v=JP;if(l){const b=ZP;c.transformPoint3(d,l,b),v[0]=b[0],v[1]=b[1],v[2]=b[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=h[0],v[1]+=h[1],v[2]+=h[2],B=ft(_,v,$P),y=qP,y[0]=n.eye[0]-v[0],y[1]=n.eye[1]-v[1],y[2]=n.eye[2]-v[2],e.snapPickOrigin[0]=v[0],e.snapPickOrigin[1]=v[1],e.snapPickOrigin[2]=v[2]}else B=_,y=n.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;a.uniform3fv(this._uCameraEyeRtc,y),a.uniform2fv(this.uVectorA,e.snapVectorA),a.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),a.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),a.uniform3fv(this._uCoordinateScaler,u),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,e.pickInvisible);let x=0;const P=4*4;this._matricesUniformBlockBufferData.set(f,0),this._matricesUniformBlockBufferData.set(B,x+=P),this._matricesUniformBlockBufferData.set(n.projMatrix,x+=P),this._matricesUniformBlockBufferData.set(A.positionsDecodeMatrix,x+=P),a.bindBuffer(a.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),a.bufferData(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,a.DYNAMIC_DRAW),a.bindBufferBase(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const v=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,v)}this.setSectionPlanesStateUniforms(t),A.indicesBuf.bind(),a.drawElements(a.LINES,A.indicesBuf.numItems,A.indicesBuf.itemType,0),A.indicesBuf.unbind()}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// VBO SnapBatchingDepthBufInitRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec4 pickColor;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),i.push("flat out vec4 vPickColor;"),i.push("out vec4 vWorldPosition;"),t&&i.push("out float vFlags;"),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      relativeToOriginPosition = worldPosition.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vWorldPosition = worldPosition;"),t&&i.push("      vFlags = flags;"),i.push("vPickColor = pickColor;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// VBO SnapBatchingDepthBufInitRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;"),s.push("uniform int layerNumber;"),s.push("uniform vec3 coordinateScaler;"),s.push("in vec4 vWorldPosition;"),s.push("flat in vec4 vPickColor;"),i){s.push("in float vFlags;");for(let n=0;n<t.getNumAllocatedSectionPlanes();n++)s.push("uniform bool sectionPlaneActive"+n+";"),s.push("uniform vec3 sectionPlanePos"+n+";"),s.push("uniform vec3 sectionPlaneDir"+n+";")}if(s.push("in highp vec3 relativeToOriginPosition;"),s.push("layout(location = 0) out highp ivec4 outCoords;"),s.push("layout(location = 1) out highp ivec4 outNormal;"),s.push("layout(location = 2) out lowp uvec4 outPickColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("      if (sectionPlaneActive"+o+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return s.push("    float dx = dFdx(vFragDepth);"),s.push("    float dy = dFdy(vFragDepth);"),s.push("    float diff = sqrt(dx*dx+dy*dy);"),s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),s.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),s.push("vec3 xTangent = dFdx( vWorldPosition.xyz );"),s.push("vec3 yTangent = dFdy( vWorldPosition.xyz );"),s.push("vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),s.push(`outNormal = ivec4(worldNormal * float(${c.MAX_INT}), 1.0);`),s.push("outPickColor = uvec4(vPickColor);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const ty=c.vec3(),iy=c.vec3(),sy=c.vec3(),ry=c.vec3(),oy=c.mat4();class ny extends Wt{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,o=s.scene,n=o.camera,a=o.canvas.gl,A=t._state,l=t._state.origin,{position:h,rotationMatrix:d,rotationMatrixConjugate:f}=s,m=t.aabb,_=e.pickViewMatrix||n.viewMatrix;this._vaoCache.has(t)?a.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(A));const u=ty;u[0]=c.safeInv(m[3]-m[0])*c.MAX_INT,u[1]=c.safeInv(m[4]-m[1])*c.MAX_INT,u[2]=c.safeInv(m[5]-m[2])*c.MAX_INT,e.snapPickCoordinateScale[0]=c.safeInv(u[0]),e.snapPickCoordinateScale[1]=c.safeInv(u[1]),e.snapPickCoordinateScale[2]=c.safeInv(u[2]);let B,y;if(l||h[0]!==0||h[1]!==0||h[2]!==0){const v=iy;if(l){const b=sy;c.transformPoint3(d,l,b),v[0]=b[0],v[1]=b[1],v[2]=b[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=h[0],v[1]+=h[1],v[2]+=h[2],B=ft(_,v,oy),y=ry,y[0]=n.eye[0]-v[0],y[1]=n.eye[1]-v[1],y[2]=n.eye[2]-v[2],e.snapPickOrigin[0]=v[0],e.snapPickOrigin[1]=v[1],e.snapPickOrigin[2]=v[2]}else B=_,y=n.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;a.uniform3fv(this._uCameraEyeRtc,y),a.uniform2fv(this.uVectorA,e.snapVectorA),a.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),a.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),a.uniform3fv(this._uCoordinateScaler,u),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,e.pickInvisible);let x=0;const P=4*4;this._matricesUniformBlockBufferData.set(f,0),this._matricesUniformBlockBufferData.set(B,x+=P),this._matricesUniformBlockBufferData.set(n.projMatrix,x+=P),this._matricesUniformBlockBufferData.set(A.positionsDecodeMatrix,x+=P),a.bindBuffer(a.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),a.bufferData(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,a.DYNAMIC_DRAW),a.bindBufferBase(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const v=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,v)}this.setSectionPlanesStateUniforms(t),e.snapMode==="edge"?(A.indicesBuf.bind(),a.drawElements(a.LINES,A.indicesBuf.numItems,A.indicesBuf.itemType,0),A.indicesBuf.unbind()):a.drawArrays(a.POINTS,0,A.positionsBuf.numItems)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0;e.pointsMaterial._state;const i=[];return i.push("#version 300 es"),i.push("// SnapBatchingDepthRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("gl_PointSize = 1.0;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// SnapBatchingDepthRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;"),s.push("uniform int layerNumber;"),s.push("uniform vec3 coordinateScaler;"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let n=0;n<t.getNumAllocatedSectionPlanes();n++)s.push("uniform bool sectionPlaneActive"+n+";"),s.push("uniform vec3 sectionPlanePos"+n+";"),s.push("uniform vec3 sectionPlaneDir"+n+";")}if(s.push("in highp vec3 relativeToOriginPosition;"),s.push("out highp ivec4 outCoords;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("      if (sectionPlaneActive"+o+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class ay{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new WP(this._scene,!1)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new XP(this._scene)),this._silhouetteRenderer}get snapInitRenderer(){return this._snapInitRenderer||(this._snapInitRenderer=new ey(this._scene,!1)),this._snapInitRenderer}get snapRenderer(){return this._snapRenderer||(this._snapRenderer=new ny(this._scene)),this._snapRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}const mA={};function Ay(r){const e=r.id;let t=mA[e];return t||(t=new ay(r),mA[e]=t,t._compile(),r.on("compile",()=>{t._compile()}),r.on("destroyed",()=>{delete mA[e],t._destroy()})),t}class ly{constructor(e=5e6){e>5e6&&(e=5e6),this.maxVerts=e,this.maxIndices=e*3,this.positions=[],this.colors=[],this.offsets=[],this.indices=[]}}class cy{constructor(e){console.info("Creating VBOBatchingLinesLayer"),this.layerIndex=e.layerIndex,this._renderers=Ay(e.model.scene),this.model=e.model,this._buffer=new ly(e.maxGeometryBatchSize),this._scratchMemory=e.scratchMemory,this._state=new Mt({positionsBuf:null,offsetsBuf:null,colorsBuf:null,flagsBuf:null,indicesBuf:null,positionsDecodeMatrix:c.mat4(),origin:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=c.collapseAABB3(),this._portions=[],this._meshes=[],this._numVerts=0,this._aabb=c.collapseAABB3(),this.aabbDirty=!0,this._finalized=!1,e.positionsDecodeMatrix?(this._state.positionsDecodeMatrix.set(e.positionsDecodeMatrix),this._preCompressedPositionsExpected=!0):this._preCompressedPositionsExpected=!1,e.origin&&(this._state.origin=c.vec3(e.origin))}get aabb(){if(this.aabbDirty){c.collapseAABB3(this._aabb);for(let e=0,t=this._meshes.length;e<t;e++)c.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}canCreatePortion(e,t){if(this._finalized)throw"Already finalized";return this._buffer.positions.length+e<this._buffer.maxVerts*3&&this._buffer.indices.length+t<this._buffer.maxIndices}createPortion(e,t){if(this._finalized)throw"Already finalized";const i=t.positions,s=t.positionsCompressed,o=t.indices,n=t.color,a=t.opacity,A=this._buffer,h=A.positions.length/3;let d;if(c.expandAABB3(this._modelAABB,t.aabb),this._preCompressedPositionsExpected){if(!s)throw"positionsCompressed expected";d=s.length/3;for(let m=0,_=s.length;m<_;m++)A.positions.push(s[m])}else{if(!i)throw"positions expected";d=i.length/3;for(let m=0,_=i.length;m<_;m++)A.positions.push(i[m])}if(n){const m=n[0],_=n[1],u=n[2],B=a;for(let y=0;y<d;y++)A.colors.push(m),A.colors.push(_),A.colors.push(u),A.colors.push(B)}if(o)for(let m=0,_=o.length;m<_;m++)A.indices.push(o[m]+h);if(this.model.scene.entityOffsetsEnabled)for(let m=0;m<d;m++)A.offsets.push(0),A.offsets.push(0),A.offsets.push(0);const f=this._portions.length/2;return this._portions.push(h),this._portions.push(d),this._numPortions++,this.model.numPortions++,this._numVerts+=d,this._meshes.push(e),f}finalize(){if(this._finalized)return;const e=this._state,t=this.model.scene.canvas.gl,i=this._buffer;if(i.positions.length>0)if(this._preCompressedPositionsExpected){const s=new Uint16Array(i.positions);e.positionsBuf=new Ee(t,t.ARRAY_BUFFER,s,i.positions.length,3,t.STATIC_DRAW)}else{const s=new Float32Array(i.positions),o=Do(s,this._modelAABB,e.positionsDecodeMatrix);e.positionsBuf=new Ee(t,t.ARRAY_BUFFER,o,i.positions.length,3,t.STATIC_DRAW)}if(i.colors.length>0){const s=new Uint8Array(i.colors);let o=!1;e.colorsBuf=new Ee(t,t.ARRAY_BUFFER,s,i.colors.length,4,t.DYNAMIC_DRAW,o)}if(i.colors.length>0){const s=i.colors.length/4,o=new Float32Array(s);let n=!1;e.flagsBuf=new Ee(t,t.ARRAY_BUFFER,o,o.length,1,t.DYNAMIC_DRAW,n)}if(this.model.scene.entityOffsetsEnabled&&i.offsets.length>0){const s=new Float32Array(i.offsets);e.offsetsBuf=new Ee(t,t.ARRAY_BUFFER,s,i.offsets.length,3,t.DYNAMIC_DRAW)}if(i.indices.length>0){const s=new Uint32Array(i.indices);e.indicesBuf=new Ee(t,t.ELEMENT_ARRAY_BUFFER,s,i.indices.length,1,t.STATIC_DRAW)}this._buffer=null,this._finalized=!0}initFlags(e,t,i){t&k.VISIBLE&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&k.HIGHLIGHTED&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&k.XRAYED&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&k.SELECTED&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&k.CLIPPABLE&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&k.EDGES&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&k.PICKABLE&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&k.CULLED&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i,!0)}flushInitFlags(){this._setDeferredFlags()}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&k.VISIBLE?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&k.HIGHLIGHTED?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&k.XRAYED?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&k.SELECTED?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){if(!this._finalized)throw"Not finalized";t&k.EDGES?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&k.CLIPPABLE?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,t)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&k.CULLED?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&k.PICKABLE?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){if(!this._finalized)throw"Not finalized";const i=e*2,s=this._portions[i],o=this._portions[i+1],n=s*4,a=o*4,A=this._scratchMemory.getUInt8Array(a),l=t[0],h=t[1],d=t[2],f=t[3];for(let m=0;m<a;m+=4)A[m+0]=l,A[m+1]=h,A[m+2]=d,A[m+3]=f;this._state.colorsBuf.setData(A,n,a)}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i,s=!1){if(!this._finalized)throw"Not finalized";const o=e*2,n=this._portions[o],a=this._portions[o+1],A=n,l=a,h=!!(t&k.VISIBLE),d=!!(t&k.XRAYED),f=!!(t&k.HIGHLIGHTED),m=!!(t&k.SELECTED),_=!!(t&k.PICKABLE),u=!!(t&k.CULLED);let B;!h||u||d||f&&!this.model.scene.highlightMaterial.glowThrough||m&&!this.model.scene.selectedMaterial.glowThrough?B=U.NOT_RENDERED:i?B=U.COLOR_TRANSPARENT:B=U.COLOR_OPAQUE;let y;!h||u?y=U.NOT_RENDERED:m?y=U.SILHOUETTE_SELECTED:f?y=U.SILHOUETTE_HIGHLIGHTED:d?y=U.SILHOUETTE_XRAYED:y=U.NOT_RENDERED;let x=h&&!u&&_?U.PICK:U.NOT_RENDERED;const P=t&k.CLIPPABLE?1:0;if(s){this._deferredFlagValues||(this._deferredFlagValues=new Float32Array(this._numVerts));for(let v=A,b=A+l;v<b;v++){let C=0;C|=B,C|=y<<4,C|=x<<12,C|=P<<16,this._deferredFlagValues[v]=C}}else if(this._state.flagsBuf){const v=this._scratchMemory.getFloat32Array(l);for(let b=0;b<l;b++){let C=0;C|=B,C|=y<<4,C|=x<<12,C|=P<<16,v[b]=C}this._state.flagsBuf.setData(v,A,l)}}_setDeferredFlags(){this._deferredFlagValues&&(this._state.flagsBuf.setData(this._deferredFlagValues),this._deferredFlagValues=null)}setOffset(e,t){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled){this.model.error("Entity#offset not enabled for this Viewer");return}const i=e*2,s=this._portions[i],o=this._portions[i+1],n=s*3,a=o*3,A=this._scratchMemory.getFloat32Array(a),l=t[0],h=t[1],d=t[2];for(let f=0;f<a;f+=3)A[f+0]=l,A[f+1]=h,A[f+2]=d;this._state.offsetsBuf.setData(A,n,a)}drawColorOpaque(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,U.COLOR_OPAQUE)}drawColorTransparent(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===0||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,U.COLOR_TRANSPARENT)}drawDepth(e,t){}drawNormals(e,t){}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,U.SILHOUETTE_XRAYED)}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,U.SILHOUETTE_HIGHLIGHTED)}drawSilhouetteSelected(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,U.SILHOUETTE_SELECTED)}drawEdgesColorOpaque(e,t){}drawEdgesColorTransparent(e,t){}drawEdgesHighlighted(e,t){}drawEdgesSelected(e,t){}drawEdgesXRayed(e,t){}drawPickMesh(e){}drawPickDepths(e){}drawPickNormals(e){}drawSnapInit(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(t,this,U.PICK)}drawSnap(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(t,this,U.PICK)}drawOcclusion(e){}drawShadow(e){}destroy(){const e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.indicesBuf&&(e.indicesBuf.destroy(),e.indicesBuf=null),e.destroy()}}class rg extends Wt{constructor(e,t){super(e,t,{instancing:!0})}_draw(e){const{gl:t}=this._scene.canvas,{state:i,frameCtx:s,incrementDrawState:o}=e;t.drawElementsInstanced(t.LINES,i.indicesBuf.numItems,i.indicesBuf.itemType,0,i.numInstances),o&&s.drawElements++}}class hy extends rg{drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Lines instancing color vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec4 color;"),s.push("in float flags;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(s),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),s.push("uniform vec4 lightAmbient;"),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0,  float(color.a) / 255.0);"),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState;let i,s;const o=t.getNumAllocatedSectionPlanes()>0,n=[];if(n.push("#version 300 es"),n.push("// Lines instancing color fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),o)for(n.push("in vec4 vWorldPosition;"),n.push("in float vFlags;"),i=0,s=t.getNumAllocatedSectionPlanes();i<s;i++)n.push("uniform bool sectionPlaneActive"+i+";"),n.push("uniform vec3 sectionPlanePos"+i+";"),n.push("uniform vec3 sectionPlaneDir"+i+";");if(n.push("in vec4 vColor;"),n.push("out vec4 outColor;"),n.push("void main(void) {"),o){for(n.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;"),i=0,s=t.getNumAllocatedSectionPlanes();i<s;i++)n.push("if (sectionPlaneActive"+i+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),n.push("}");n.push("if (dist > 0.0) { discard; }"),n.push("}")}return this._withSAO?(n.push("   float viewportWidth     = uSAOParams[0];"),n.push("   float viewportHeight    = uSAOParams[1];"),n.push("   float blendCutoff       = uSAOParams[2];"),n.push("   float blendFactor       = uSAOParams[3];"),n.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),n.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBAToDepth(texture(uOcclusionTexture, uv))) * blendFactor;"),n.push("   outColor            = vec4(vColor.rgb * ambient, vColor.a);")):n.push("    outColor           = vColor;"),e.logarithmicDepthBufferEnabled&&n.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("}"),n}}class uy extends rg{drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Lines instancing silhouette vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(s),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),s.push("uniform vec4 color;"),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("void main(void) {"),s.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),s.push("if (silhouetteFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Lines instancing silhouette fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("uniform vec4 color;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = color;"),s.push("}"),s}}const dy=c.vec3(),py=c.vec3(),fy=c.vec3();c.vec3();const gy=c.mat4();class Mu extends Wt{constructor(e){super(e,!1,{instancing:!0})}drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,o=s.scene,n=o.canvas.gl,a=o.camera,A=t._state,l=t._state.origin,{position:h,rotationMatrix:d,rotationMatrixConjugate:f}=s,m=t.aabb,_=e.pickViewMatrix||a.viewMatrix;this._vaoCache.has(t)?n.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(A));const u=dy;u[0]=c.safeInv(m[3]-m[0])*c.MAX_INT,u[1]=c.safeInv(m[4]-m[1])*c.MAX_INT,u[2]=c.safeInv(m[5]-m[2])*c.MAX_INT,e.snapPickCoordinateScale[0]=c.safeInv(u[0]),e.snapPickCoordinateScale[1]=c.safeInv(u[1]),e.snapPickCoordinateScale[2]=c.safeInv(u[2]);let B;if(l||h[0]!==0||h[1]!==0||h[2]!==0){const P=py;if(l){const v=c.transformPoint3(d,l,fy);P[0]=v[0],P[1]=v[1],P[2]=v[2]}else P[0]=0,P[1]=0,P[2]=0;P[0]+=h[0],P[1]+=h[1],P[2]+=h[2],B=ft(_,P,gy),e.snapPickOrigin[0]=P[0],e.snapPickOrigin[1]=P[1],e.snapPickOrigin[2]=P[2]}else B=_,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;n.uniform2fv(this.uVectorA,e.snapVectorA),n.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),n.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),n.uniform3fv(this._uCoordinateScaler,u),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible);let y=0;const x=4*4;this._matricesUniformBlockBufferData.set(f,0),this._matricesUniformBlockBufferData.set(B,y+=x),this._matricesUniformBlockBufferData.set(a.projMatrix,y+=x),this._matricesUniformBlockBufferData.set(A.positionsDecodeMatrix,y+=x),n.bindBuffer(n.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),n.bufferData(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,n.DYNAMIC_DRAW),n.bindBufferBase(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const P=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,P)}this.setSectionPlanesStateUniforms(t),this._aModelMatrixCol0.bindArrayBuffer(A.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(A.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(A.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aFlags&&(this._aFlags.bindArrayBuffer(A.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1)),A.indicesBuf.bind(),n.drawElementsInstanced(n.LINES,A.indicesBuf.numItems,A.indicesBuf.itemType,0,A.numInstances),A.indicesBuf.unbind(),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),this._aFlags&&n.vertexAttribDivisor(this._aFlags.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// SnapInstancingDepthBufInitRenderer vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),s.push("in vec4 pickColor;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),s.push("uniform vec2 snapVectorA;"),s.push("uniform vec2 snapInvVectorAB;"),s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;"),s.push("vec2 remapClipPos(vec2 clipPos) {"),s.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),s.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),s.push("    return vec2(x, y);"),s.push("}"),s.push("flat out vec4 vPickColor;"),s.push("out vec4 vWorldPosition;"),i&&s.push("out float vFlags;"),s.push("out highp vec3 relativeToOriginPosition;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("relativeToOriginPosition = worldPosition.xyz;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("  vWorldPosition = worldPosition;"),i&&s.push("  vFlags = flags;"),s.push("vPickColor = pickColor;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),s.push("float tmp = clipPos.w;"),s.push("clipPos.xyzw /= tmp;"),s.push("clipPos.xy = remapClipPos(clipPos.xy);"),s.push("clipPos.xyzw *= tmp;"),s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points instancing pick depth fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;"),s.push("uniform int layerNumber;"),s.push("uniform vec3 coordinateScaler;"),s.push("in vec4 vWorldPosition;"),s.push("flat in vec4 vPickColor;"),i){s.push("in float vFlags;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in highp vec3 relativeToOriginPosition;"),s.push("layout(location = 0) out highp ivec4 outCoords;"),s.push("layout(location = 2) out lowp uvec4 outPickColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("    float dx = dFdx(vFragDepth);"),s.push("    float dy = dFdy(vFragDepth);"),s.push("    float diff = sqrt(dx*dx+dy*dy);"),s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),s.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),s.push("outPickColor = uvec4(vPickColor);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const my=c.vec3(),_y=c.vec3(),vy=c.vec3();c.vec3();const By=c.mat4();class Su extends Wt{constructor(e){super(e,!1,{instancing:!0})}drawLayer(e,t,i){if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,o=s.scene,n=o.camera,a=o.canvas.gl,A=t._state,l=t._state.origin,{position:h,rotationMatrix:d,rotationMatrixConjugate:f}=s,m=t.aabb,_=e.pickViewMatrix||n.viewMatrix;this._vaoCache.has(t)?a.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(A));const u=my;u[0]=c.safeInv(m[3]-m[0])*c.MAX_INT,u[1]=c.safeInv(m[4]-m[1])*c.MAX_INT,u[2]=c.safeInv(m[5]-m[2])*c.MAX_INT,e.snapPickCoordinateScale[0]=c.safeInv(u[0]),e.snapPickCoordinateScale[1]=c.safeInv(u[1]),e.snapPickCoordinateScale[2]=c.safeInv(u[2]);let B;if(l||h[0]!==0||h[1]!==0||h[2]!==0){const P=_y;if(l){const v=c.transformPoint3(d,l,vy);P[0]=v[0],P[1]=v[1],P[2]=v[2]}else P[0]=0,P[1]=0,P[2]=0;P[0]+=h[0],P[1]+=h[1],P[2]+=h[2],B=ft(_,P,By),e.snapPickOrigin[0]=P[0],e.snapPickOrigin[1]=P[1],e.snapPickOrigin[2]=P[2]}else B=_,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;a.uniform2fv(this.uVectorA,e.snapVectorA),a.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),a.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),a.uniform3fv(this._uCoordinateScaler,u),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,e.pickInvisible);let y=0;const x=4*4;this._matricesUniformBlockBufferData.set(f,0),this._matricesUniformBlockBufferData.set(B,y+=x),this._matricesUniformBlockBufferData.set(n.projMatrix,y+=x),this._matricesUniformBlockBufferData.set(A.positionsDecodeMatrix,y+=x),a.bindBuffer(a.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),a.bufferData(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,a.DYNAMIC_DRAW),a.bindBufferBase(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const P=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,P)}this.setSectionPlanesStateUniforms(t),this._aModelMatrixCol0.bindArrayBuffer(A.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(A.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(A.modelMatrixCol2Buf),a.vertexAttribDivisor(this._aModelMatrixCol0.location,1),a.vertexAttribDivisor(this._aModelMatrixCol1.location,1),a.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aFlags.bindArrayBuffer(A.flagsBuf),a.vertexAttribDivisor(this._aFlags.location,1),e.snapMode==="edge"?(A.indicesBuf.bind(),a.drawElementsInstanced(a.LINES,A.indicesBuf.numItems,A.indicesBuf.itemType,0,A.numInstances),A.indicesBuf.unbind()):a.drawArraysInstanced(a.POINTS,0,A.positionsBuf.numItems,A.numInstances),a.vertexAttribDivisor(this._aModelMatrixCol0.location,0),a.vertexAttribDivisor(this._aModelMatrixCol1.location,0),a.vertexAttribDivisor(this._aModelMatrixCol2.location,0),a.vertexAttribDivisor(this._aFlags.location,0),this._aOffset&&a.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// SnapInstancingDepthRenderer vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),s.push("uniform vec2 snapVectorA;"),s.push("uniform vec2 snapInvVectorAB;"),s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;"),s.push("vec2 remapClipPos(vec2 clipPos) {"),s.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),s.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),s.push("    return vec2(x, y);"),s.push("}"),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out highp vec3 relativeToOriginPosition;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("relativeToOriginPosition = worldPosition.xyz;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("  vWorldPosition = worldPosition;"),s.push("  vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),s.push("float tmp = clipPos.w;"),s.push("clipPos.xyzw /= tmp;"),s.push("clipPos.xy = remapClipPos(clipPos.xy);"),s.push("clipPos.xyzw *= tmp;"),s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),s.push("gl_Position = clipPos;"),s.push("gl_PointSize = 1.0;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// SnapInstancingDepthRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;"),s.push("uniform int layerNumber;"),s.push("uniform vec3 coordinateScaler;"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in highp vec3 relativeToOriginPosition;"),s.push("out highp ivec4 outCoords;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class Py{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}eagerCreateRenders(){this._snapInitRenderer||(this._snapInitRenderer=new Mu(this._scene,!1)),this._snapRenderer||(this._snapRenderer=new Su(this._scene))}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new hy(this._scene)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new uy(this._scene)),this._silhouetteRenderer}get snapInitRenderer(){return this._snapInitRenderer||(this._snapInitRenderer=new Mu(this._scene,!1)),this._snapInitRenderer}get snapRenderer(){return this._snapRenderer||(this._snapRenderer=new Su(this._scene)),this._snapRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}const _A={};function yy(r){const e=r.id;let t=_A[e];return t||(t=new Py(r),_A[e]=t,t._compile(),r.on("compile",()=>{t._compile()}),r.on("destroyed",()=>{delete _A[e],t._destroy()})),t}const Jr=new Uint8Array(4),Tu=new Float32Array(1),gn=new Float32Array(3),ri=new Float32Array(4);class xy{constructor(e){console.info("VBOInstancingLinesLayer"),this.model=e.model,this.material=e.material,this.sortId="LinesInstancingLayer",this.layerIndex=e.layerIndex,this._renderers=yy(e.model.scene),this._aabb=c.collapseAABB3(),this._state=new Mt({obb:c.OBB3(),numInstances:0,origin:null,geometry:e.geometry,positionsDecodeMatrix:e.geometry.positionsDecodeMatrix,positionsBuf:null,colorsBuf:null,flagsBuf:null,offsetsBuf:null,modelMatrixCol0Buf:null,modelMatrixCol1Buf:null,modelMatrixCol2Buf:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this.numIndices=e.geometry.numIndices,this._colors=[],this._offsets=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._portions=[],this._meshes=[],this._aabb=c.collapseAABB3(),this.aabbDirty=!0,e.origin&&(this._state.origin=c.vec3(e.origin)),this._finalized=!1}get aabb(){if(this.aabbDirty){c.collapseAABB3(this._aabb);for(let e=0,t=this._meshes.length;e<t;e++)c.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}createPortion(e,t){const i=t.color,s=t.opacity,o=t.meshMatrix;if(this._finalized)throw"Already finalized";const n=i[0],a=i[1],A=i[2];i[3],this._colors.push(n),this._colors.push(a),this._colors.push(A),this._colors.push(s),this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(o[0]),this._modelMatrixCol0.push(o[4]),this._modelMatrixCol0.push(o[8]),this._modelMatrixCol0.push(o[12]),this._modelMatrixCol1.push(o[1]),this._modelMatrixCol1.push(o[5]),this._modelMatrixCol1.push(o[9]),this._modelMatrixCol1.push(o[13]),this._modelMatrixCol2.push(o[2]),this._modelMatrixCol2.push(o[6]),this._modelMatrixCol2.push(o[10]),this._modelMatrixCol2.push(o[14]),this._state.numInstances++;const l=this._portions.length;return this._portions.push({}),this._numPortions++,this.model.numPortions++,this._meshes.push(e),l}finalize(){if(this._finalized)throw"Already finalized";const e=this.model.scene.canvas.gl,t=this._state,i=t.geometry,s=this._colors.length,o=s/4;if(s>0){let n=!1;this._state.colorsBuf=new Ee(e,e.ARRAY_BUFFER,new Uint8Array(this._colors),this._colors.length,4,e.DYNAMIC_DRAW,n),this._colors=[]}if(o>0){let n=!1;this._state.flagsBuf=new Ee(e,e.ARRAY_BUFFER,new Float32Array(o),o,1,e.DYNAMIC_DRAW,n)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0&&(this._state.offsetsBuf=new Ee(e,e.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,e.DYNAMIC_DRAW,!1),this._offsets=[]),i.colorsCompressed&&i.colorsCompressed.length>0){const n=new Uint8Array(i.colorsCompressed),a=!1;t.colorsBuf=new Ee(e,e.ARRAY_BUFFER,n,n.length,4,e.STATIC_DRAW,a)}i.positionsCompressed&&i.positionsCompressed.length>0&&(t.positionsBuf=new Ee(e,e.ARRAY_BUFFER,i.positionsCompressed,i.positionsCompressed.length,3,e.STATIC_DRAW,!1),t.positionsDecodeMatrix=c.mat4(i.positionsDecodeMatrix)),i.indices&&i.indices.length>0&&(t.indicesBuf=new Ee(e,e.ELEMENT_ARRAY_BUFFER,new Uint32Array(i.indices),i.indices.length,1,e.STATIC_DRAW),t.numIndices=i.indices.length),this._modelMatrixCol0.length>0&&(this._state.modelMatrixCol0Buf=new Ee(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,e.STATIC_DRAW,!1),this._state.modelMatrixCol1Buf=new Ee(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,e.STATIC_DRAW,!1),this._state.modelMatrixCol2Buf=new Ee(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,e.STATIC_DRAW,!1),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[]),this._state.geometry=null,this._finalized=!0}initFlags(e,t,i){t&k.VISIBLE&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&k.HIGHLIGHTED&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&k.XRAYED&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&k.SELECTED&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&k.CLIPPABLE&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&k.EDGES&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&k.PICKABLE&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&k.CULLED&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i)}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&k.VISIBLE?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&k.HIGHLIGHTED?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&k.XRAYED?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&k.SELECTED?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){if(!this._finalized)throw"Not finalized";t&k.EDGES?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&k.CLIPPABLE?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,t)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&k.PICKABLE?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&k.CULLED?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){if(!this._finalized)throw"Not finalized";Jr[0]=t[0],Jr[1]=t[1],Jr[2]=t[2],Jr[3]=t[3],this._state.colorsBuf.setData(Jr,e*4,4)}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i){if(!this._finalized)throw"Not finalized";const s=!!(t&k.VISIBLE),o=!!(t&k.XRAYED),n=!!(t&k.HIGHLIGHTED),a=!!(t&k.SELECTED),A=!!(t&k.EDGES),l=!!(t&k.PICKABLE),h=!!(t&k.CULLED);let d;!s||h||o||n&&!this.model.scene.highlightMaterial.glowThrough||a&&!this.model.scene.selectedMaterial.glowThrough?d=U.NOT_RENDERED:i?d=U.COLOR_TRANSPARENT:d=U.COLOR_OPAQUE;let f;!s||h?f=U.NOT_RENDERED:a?f=U.SILHOUETTE_SELECTED:n?f=U.SILHOUETTE_HIGHLIGHTED:o?f=U.SILHOUETTE_XRAYED:f=U.NOT_RENDERED;let m=0;!s||h?m=U.NOT_RENDERED:a?m=U.EDGES_SELECTED:n?m=U.EDGES_HIGHLIGHTED:o?m=U.EDGES_XRAYED:A?i?m=U.EDGES_COLOR_TRANSPARENT:m=U.EDGES_COLOR_OPAQUE:m=U.NOT_RENDERED;let _=s&&!h&&l?U.PICK:U.NOT_RENDERED;const u=t&k.CLIPPABLE?255:0;let B=0;B|=d,B|=f<<4,B|=m<<8,B|=_<<12,B|=u<<16,Tu[0]=B,this._state.flagsBuf.setData(Tu,e)}setOffset(e,t){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled){this.model.error("Entity#offset not enabled for this Viewer");return}gn[0]=t[0],gn[1]=t[1],gn[2]=t[2],this._state.offsetsBuf.setData(gn,e*3,3)}setMatrix(e,t){if(!this._finalized)throw"Not finalized";const i=e*4;ri[0]=t[0],ri[1]=t[4],ri[2]=t[8],ri[3]=t[12],this._state.modelMatrixCol0Buf.setData(ri,i),ri[0]=t[1],ri[1]=t[5],ri[2]=t[9],ri[3]=t[13],this._state.modelMatrixCol1Buf.setData(ri,i),ri[0]=t[2],ri[1]=t[6],ri[2]=t[10],ri[3]=t[14],this._state.modelMatrixCol2Buf.setData(ri,i)}drawColorOpaque(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,U.COLOR_OPAQUE)}drawColorTransparent(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===0||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,U.COLOR_TRANSPARENT)}drawDepth(e,t){}drawNormals(e,t){}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,U.SILHOUETTE_XRAYED)}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,U.SILHOUETTE_HIGHLIGHTED)}drawSilhouetteSelected(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,U.SILHOUETTE_SELECTED)}drawEdgesColorOpaque(e,t){}drawEdgesColorTransparent(e,t){}drawEdgesXRayed(e,t){}drawEdgesHighlighted(e,t){}drawEdgesSelected(e,t){}drawSnapInit(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(t,this,U.PICK)}drawSnap(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(t,this,U.PICK)}drawOcclusion(e,t){}drawShadow(e,t){}drawPickMesh(e,t){}drawPickDepths(e,t){}drawPickNormals(e,t){}destroy(){const e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.modelMatrixCol0Buf&&(e.modelMatrixCol0Buf.destroy(),e.modelMatrixCol0Buf=null),e.modelMatrixCol1Buf&&(e.modelMatrixCol1Buf.destroy(),e.modelMatrixCol1Buf=null),e.modelMatrixCol2Buf&&(e.modelMatrixCol2Buf.destroy(),e.modelMatrixCol2Buf=null),e.destroy()}}class No extends Wt{_draw(e){const{gl:t}=this._scene.canvas,{state:i,frameCtx:s,incrementDrawState:o}=e;t.drawArrays(t.POINTS,0,i.positionsBuf.numItems),o&&s.drawArrays++}}class wy extends No{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=e.pointsMaterial,o=[];return o.push("#version 300 es"),o.push("// Points batching color vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),o.push("in vec4 color;"),o.push("in float flags;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),this._addMatricesUniformBlockLines(o),o.push("uniform float pointSize;"),s.perspectivePoints&&o.push("uniform float nearPlaneHeight;"),s.filterIntensity&&o.push("uniform vec2 intensityRange;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;")),i&&(o.push("out vec4 vWorldPosition;"),o.push("out float vFlags;")),o.push("out vec4 vColor;"),o.push("void main(void) {"),o.push("int colorFlag = int(flags) & 0xF;"),o.push("if (colorFlag != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),s.filterIntensity&&(o.push("float intensity = float(color.a) / 255.0;"),o.push("if (intensity < intensityRange[0] || intensity > intensityRange[1]) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {")),o.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&o.push("worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),o.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, 1.0);"),i&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags = flags;")),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("gl_Position = clipPos;"),s.perspectivePoints?(o.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),o.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),o.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):o.push("gl_PointSize = pointSize;"),o.push("}"),s.filterIntensity&&o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points batching color fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   outColor = vColor;"),e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}}class by extends No{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=e.pointsMaterial._state,o=[];return o.push("#version 300 es"),o.push("// Points batching silhouette vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),o.push("in float flags;"),this._addMatricesUniformBlockLines(o),o.push("uniform vec4 color;"),o.push("uniform float pointSize;"),s.perspectivePoints&&o.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;")),i&&(o.push("out vec4 vWorldPosition;"),o.push("out float vFlags;")),o.push("void main(void) {"),o.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),o.push("if (silhouetteFlag != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&o.push("      worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags = flags;")),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("gl_Position = clipPos;"),s.perspectivePoints?(o.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),o.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),o.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):o.push("gl_PointSize = pointSize;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState;let i,s;const o=t.getNumAllocatedSectionPlanes()>0,n=[];if(n.push("#version 300 es"),n.push("// Points batching silhouette vertex shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),o)for(n.push("in vec4 vWorldPosition;"),n.push("in float vFlags;"),i=0,s=t.getNumAllocatedSectionPlanes();i<s;i++)n.push("uniform bool sectionPlaneActive"+i+";"),n.push("uniform vec3 sectionPlanePos"+i+";"),n.push("uniform vec3 sectionPlaneDir"+i+";");if(n.push("uniform vec4 color;"),n.push("out vec4 outColor;"),n.push("void main(void) {"),e.pointsMaterial.roundPoints&&(n.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),n.push("  float r = dot(cxy, cxy);"),n.push("  if (r > 1.0) {"),n.push("       discard;"),n.push("  }")),o){for(n.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;"),i=0,s=t.getNumAllocatedSectionPlanes();i<s;i++)n.push("if (sectionPlaneActive"+i+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > 0.0) { discard; }"),n.push("}")}return e.logarithmicDepthBufferEnabled&&n.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("outColor = color;"),n.push("}"),n}}class Cy extends No{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=e.pointsMaterial._state,s=[];return s.push("#version 300 es"),s.push("// Points batching pick mesh vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 pickColor;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),this._addRemapClipPosLines(s),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vPickColor;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("      vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),t&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = remapClipPos(clipPos);"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("gl_PointSize += 10.0;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points batching pick mesh vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vPickColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(let n=0;n<t.getNumAllocatedSectionPlanes();n++)s.push("      if (sectionPlaneActive"+n+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outColor = vPickColor; "),s.push("}"),s}}class Ey extends No{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=e.pointsMaterial._state,s=[];return s.push("#version 300 es"),s.push("// Points batched pick depth vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),this._addRemapClipPosLines(s),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vViewPosition;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags = flags;")),s.push("vViewPosition = viewPosition;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = remapClipPos(clipPos);"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("gl_PointSize += 10.0;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points batched pick depth fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("uniform float pickZNear;"),s.push("uniform float pickZFar;"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let n=0;n<t.getNumAllocatedSectionPlanes();n++)s.push("uniform bool sectionPlaneActive"+n+";"),s.push("uniform vec3 sectionPlanePos"+n+";"),s.push("uniform vec3 sectionPlaneDir"+n+";")}if(s.push("in vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("      if (sectionPlaneActive"+o+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),s.push("    outColor = packDepth(zNormalizedDepth); "),s.push("}"),s}}class Iy extends No{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=e.pointsMaterial._state,s=[];return s.push("#version 300 es"),s.push("// Points batching occlusion vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),this._addMatricesUniformBlockLines(s),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("  gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points batching occlusion fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("      if (sectionPlaneActive"+o+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),s.push("}"),s}}const Fy=c.vec3(),My=c.vec3(),Sy=c.vec3(),Ty=c.vec3(),Dy=c.mat4();class Ry extends Wt{drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,o=s.scene,n=o.camera,a=o.canvas.gl,A=t._state,l=t._state.origin,{position:h,rotationMatrix:d,rotationMatrixConjugate:f}=s,m=t.aabb,_=e.pickViewMatrix||n.viewMatrix;this._vaoCache.has(t)?a.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(A));const u=Fy;u[0]=c.safeInv(m[3]-m[0])*c.MAX_INT,u[1]=c.safeInv(m[4]-m[1])*c.MAX_INT,u[2]=c.safeInv(m[5]-m[2])*c.MAX_INT,e.snapPickCoordinateScale[0]=c.safeInv(u[0]),e.snapPickCoordinateScale[1]=c.safeInv(u[1]),e.snapPickCoordinateScale[2]=c.safeInv(u[2]);let B,y;if(l||h[0]!==0||h[1]!==0||h[2]!==0){const v=My;if(l){const b=Sy;c.transformPoint3(d,l,b),v[0]=b[0],v[1]=b[1],v[2]=b[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=h[0],v[1]+=h[1],v[2]+=h[2],B=ft(_,v,Dy),y=Ty,y[0]=n.eye[0]-v[0],y[1]=n.eye[1]-v[1],y[2]=n.eye[2]-v[2],e.snapPickOrigin[0]=v[0],e.snapPickOrigin[1]=v[1],e.snapPickOrigin[2]=v[2]}else B=_,y=n.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;a.uniform3fv(this._uCameraEyeRtc,y),a.uniform2fv(this.uVectorA,e.snapVectorA),a.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),a.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),a.uniform3fv(this._uCoordinateScaler,u),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,e.pickInvisible);let x=0;const P=4*4;this._matricesUniformBlockBufferData.set(f,0),this._matricesUniformBlockBufferData.set(B,x+=P),this._matricesUniformBlockBufferData.set(n.projMatrix,x+=P),this._matricesUniformBlockBufferData.set(A.positionsDecodeMatrix,x+=P),a.bindBuffer(a.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),a.bufferData(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,a.DYNAMIC_DRAW),a.bindBufferBase(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const v=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,v)}this.setSectionPlanesStateUniforms(t),a.drawArrays(a.POINTS,0,A.positionsBuf.numItems)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// VBOBatchingPointsSnapInitRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec4 pickColor;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),i.push("flat out vec4 vPickColor;"),i.push("out vec4 vWorldPosition;"),t&&i.push("out float vFlags;"),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      relativeToOriginPosition = worldPosition.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vWorldPosition = worldPosition;"),t&&i.push("      vFlags = flags;"),i.push("vPickColor = pickColor;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// VBOBatchingPointsSnapInitRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;"),s.push("uniform int layerNumber;"),s.push("uniform vec3 coordinateScaler;"),s.push("in vec4 vWorldPosition;"),s.push("flat in vec4 vPickColor;"),i){s.push("in float vFlags;");for(let n=0;n<t.getNumAllocatedSectionPlanes();n++)s.push("uniform bool sectionPlaneActive"+n+";"),s.push("uniform vec3 sectionPlanePos"+n+";"),s.push("uniform vec3 sectionPlaneDir"+n+";")}if(s.push("in highp vec3 relativeToOriginPosition;"),s.push("layout(location = 0) out highp ivec4 outCoords;"),s.push("layout(location = 1) out highp ivec4 outNormal;"),s.push("layout(location = 2) out lowp uvec4 outPickColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("      if (sectionPlaneActive"+o+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return s.push("    float dx = dFdx(vFragDepth);"),s.push("    float dy = dFdy(vFragDepth);"),s.push("    float diff = sqrt(dx*dx+dy*dy);"),s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),s.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),s.push("outNormal = ivec4(1.0, 1.0, 1.0, 1.0);"),s.push("outPickColor = uvec4(vPickColor);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Ly=c.vec3(),Uy=c.vec3(),Oy=c.vec3(),ky=c.vec3(),Ny=c.mat4();class Qy extends Wt{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,o=s.scene,n=o.camera,a=o.canvas.gl,A=t._state,l=t._state.origin,{position:h,rotationMatrix:d,rotationMatrixConjugate:f}=s,m=t.aabb,_=e.pickViewMatrix||n.viewMatrix;this._vaoCache.has(t)?a.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(A));const u=Ly;u[0]=c.safeInv(m[3]-m[0])*c.MAX_INT,u[1]=c.safeInv(m[4]-m[1])*c.MAX_INT,u[2]=c.safeInv(m[5]-m[2])*c.MAX_INT,e.snapPickCoordinateScale[0]=c.safeInv(u[0]),e.snapPickCoordinateScale[1]=c.safeInv(u[1]),e.snapPickCoordinateScale[2]=c.safeInv(u[2]);let B,y;if(l||h[0]!==0||h[1]!==0||h[2]!==0){const v=Uy;if(l){const b=Oy;c.transformPoint3(d,l,b),v[0]=b[0],v[1]=b[1],v[2]=b[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=h[0],v[1]+=h[1],v[2]+=h[2],B=ft(_,v,Ny),y=ky,y[0]=n.eye[0]-v[0],y[1]=n.eye[1]-v[1],y[2]=n.eye[2]-v[2],e.snapPickOrigin[0]=v[0],e.snapPickOrigin[1]=v[1],e.snapPickOrigin[2]=v[2]}else B=_,y=n.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;a.uniform3fv(this._uCameraEyeRtc,y),a.uniform2fv(this.uVectorA,e.snapVectorA),a.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),a.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),a.uniform3fv(this._uCoordinateScaler,u),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,e.pickInvisible);let x=0;const P=4*4;this._matricesUniformBlockBufferData.set(f,0),this._matricesUniformBlockBufferData.set(B,x+=P),this._matricesUniformBlockBufferData.set(n.projMatrix,x+=P),this._matricesUniformBlockBufferData.set(A.positionsDecodeMatrix,x+=P),a.bindBuffer(a.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),a.bufferData(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,a.DYNAMIC_DRAW),a.bindBufferBase(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const v=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,v)}this.setSectionPlanesStateUniforms(t),a.drawArrays(a.POINTS,0,A.positionsBuf.numItems)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0;e.pointsMaterial._state;const i=[];return i.push("#version 300 es"),i.push("// VBOBatchingPointsSnapRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("gl_PointSize = 1.0;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// VBOBatchingPointsSnapRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;"),s.push("uniform int layerNumber;"),s.push("uniform vec3 coordinateScaler;"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let n=0;n<t.getNumAllocatedSectionPlanes();n++)s.push("uniform bool sectionPlaneActive"+n+";"),s.push("uniform vec3 sectionPlanePos"+n+";"),s.push("uniform vec3 sectionPlaneDir"+n+";")}if(s.push("in highp vec3 relativeToOriginPosition;"),s.push("out highp ivec4 outCoords;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("      if (sectionPlaneActive"+o+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class Hy{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._occlusionRenderer&&this._occlusionRenderer.getValid()===!1&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new wy(this._scene)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new by(this._scene)),this._silhouetteRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new Cy(this._scene)),this._pickMeshRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new Ey(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new Iy(this._scene)),this._occlusionRenderer}get snapInitRenderer(){return this._snapInitRenderer||(this._snapInitRenderer=new Ry(this._scene,!1)),this._snapInitRenderer}get snapRenderer(){return this._snapRenderer||(this._snapRenderer=new Qy(this._scene)),this._snapRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}const vA={};function Vy(r){const e=r.id;let t=vA[e];return t||(t=new Hy(r),vA[e]=t,t._compile(),r.on("compile",()=>{t._compile()}),r.on("destroyed",()=>{delete vA[e],t._destroy()})),t}class Gy{constructor(e=5e6){e>5e6&&(e=5e6),this.maxVerts=e,this.maxIndices=e*3,this.positions=[],this.colors=[],this.intensities=[],this.pickColors=[],this.offsets=[]}}class jy{constructor(e){console.info("Creating VBOBatchingPointsLayer"),this.model=e.model,this.sortId="PointsBatchingLayer",this.layerIndex=e.layerIndex,this._renderers=Vy(e.model.scene),this._buffer=new Gy(e.maxGeometryBatchSize),this._scratchMemory=e.scratchMemory,this._state=new Mt({positionsBuf:null,offsetsBuf:null,colorsBuf:null,flagsBuf:null,positionsDecodeMatrix:c.mat4(),origin:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=c.collapseAABB3(),this._portions=[],this._meshes=[],this._aabb=c.collapseAABB3(),this.aabbDirty=!0,this._finalized=!1,e.positionsDecodeMatrix?(this._state.positionsDecodeMatrix.set(e.positionsDecodeMatrix),this._preCompressedPositionsExpected=!0):this._preCompressedPositionsExpected=!1,e.origin&&(this._state.origin=c.vec3(e.origin))}get aabb(){if(this.aabbDirty){c.collapseAABB3(this._aabb);for(let e=0,t=this._meshes.length;e<t;e++)c.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}canCreatePortion(e){if(this._finalized)throw"Already finalized";return this._buffer.positions.length+e<this._buffer.maxVerts*3}createPortion(e,t){if(this._finalized)throw"Already finalized";const i=t.positions,s=t.positionsCompressed,o=t.color,n=t.colorsCompressed,a=t.colors,A=t.pickColor,l=this._buffer,d=l.positions.length/3;let f;if(c.expandAABB3(this._modelAABB,t.aabb),this._preCompressedPositionsExpected){if(!s)throw"positionsCompressed expected";for(let _=0,u=s.length;_<u;_++)l.positions.push(s[_]);f=s.length/3}else{if(!i)throw"positions expected";f=i.length/3,i.length,l.positions.length;for(let _=0,u=i.length;_<u;_++)l.positions.push(i[_])}if(n)for(let _=0,u=n.length;_<u;_++)l.colors.push(n[_]);else if(a)for(let _=0,u=a.length;_<u;_++)l.colors.push(a[_]*255);else if(o){const _=o[0],u=o[1],B=o[2],y=1;for(let x=0;x<f;x++)l.colors.push(_),l.colors.push(u),l.colors.push(B),l.colors.push(y)}{const _=l.pickColors.length,u=f*4;for(let B=_,y=_+u;B<y;B+=4)l.pickColors.push(A[0]),l.pickColors.push(A[1]),l.pickColors.push(A[2]),l.pickColors.push(A[3])}if(this.model.scene.entityOffsetsEnabled)for(let _=0;_<f;_++)l.offsets.push(0),l.offsets.push(0),l.offsets.push(0);const m=this._portions.length/2;return this._portions.push(d),this._portions.push(f),this._numPortions++,this.model.numPortions++,this._meshes.push(e),m}finalize(){if(this._finalized)return;const e=this._state,t=this.model.scene.canvas.gl,i=this._buffer;if(i.positions.length>0)if(this._preCompressedPositionsExpected){const s=new Uint16Array(i.positions);e.positionsBuf=new Ee(t,t.ARRAY_BUFFER,s,i.positions.length,3,t.STATIC_DRAW)}else{const s=new Float32Array(i.positions),o=Do(s,this._modelAABB,e.positionsDecodeMatrix);e.positionsBuf=new Ee(t,t.ARRAY_BUFFER,o,i.positions.length,3,t.STATIC_DRAW)}if(i.colors.length>0){const s=new Uint8Array(i.colors);let o=!1;e.colorsBuf=new Ee(t,t.ARRAY_BUFFER,s,i.colors.length,4,t.STATIC_DRAW,o)}if(i.positions.length>0){const s=i.positions.length/3,o=new Float32Array(s);let n=!1;e.flagsBuf=new Ee(t,t.ARRAY_BUFFER,o,o.length,1,t.DYNAMIC_DRAW,n)}if(i.pickColors.length>0){const s=new Uint8Array(i.pickColors);let o=!1;e.pickColorsBuf=new Ee(t,t.ARRAY_BUFFER,s,i.pickColors.length,4,t.STATIC_DRAW,o)}if(this.model.scene.entityOffsetsEnabled&&i.offsets.length>0){const s=new Float32Array(i.offsets);e.offsetsBuf=new Ee(t,t.ARRAY_BUFFER,s,i.offsets.length,3,t.DYNAMIC_DRAW)}this._buffer=null,this._finalized=!0}initFlags(e,t,i){t&k.VISIBLE&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&k.HIGHLIGHTED&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&k.XRAYED&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&k.SELECTED&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&k.CLIPPABLE&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&k.PICKABLE&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&k.CULLED&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i)}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&k.VISIBLE?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&k.HIGHLIGHTED?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&k.XRAYED?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&k.SELECTED?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){if(!this._finalized)throw"Not finalized"}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&k.CLIPPABLE?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,t)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&k.CULLED?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&k.PICKABLE?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){if(!this._finalized)throw"Not finalized";const i=e*2,s=this._portions[i],o=this._portions[i+1],n=s*4,a=o*4,A=this._scratchMemory.getUInt8Array(a),l=t[0],h=t[1],d=t[2];for(let f=0;f<a;f+=4)A[f+0]=l,A[f+1]=h,A[f+2]=d;this._state.colorsBuf.setData(A,n,a)}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i){if(!this._finalized)throw"Not finalized";const s=e*2,o=this._portions[s],n=this._portions[s+1],a=o,A=n,l=this._scratchMemory.getFloat32Array(A),h=!!(t&k.VISIBLE),d=!!(t&k.XRAYED),f=!!(t&k.HIGHLIGHTED),m=!!(t&k.SELECTED),_=!!(t&k.PICKABLE),u=!!(t&k.CULLED);let B;!h||u||d||f&&!this.model.scene.highlightMaterial.glowThrough||m&&!this.model.scene.selectedMaterial.glowThrough?B=U.NOT_RENDERED:i?B=U.COLOR_TRANSPARENT:B=U.COLOR_OPAQUE;let y;!h||u?y=U.NOT_RENDERED:m?y=U.SILHOUETTE_SELECTED:f?y=U.SILHOUETTE_HIGHLIGHTED:d?y=U.SILHOUETTE_XRAYED:y=U.NOT_RENDERED;let x=h&&!u&&_?U.PICK:U.NOT_RENDERED;const P=t&k.CLIPPABLE?1:0;for(let v=0;v<A;v++){let b=0;b|=B,b|=y<<4,b|=x<<12,b|=P<<16,l[v]=b}this._state.flagsBuf.setData(l,a)}setOffset(e,t){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled){this.model.error("Entity#offset not enabled for this Viewer");return}const i=e*2,s=this._portions[i],o=this._portions[i+1],n=s*3,a=o*3,A=this._scratchMemory.getFloat32Array(a),l=t[0],h=t[1],d=t[2];for(let f=0;f<a;f+=3)A[f+0]=l,A[f+1]=h,A[f+2]=d;this._state.offsetsBuf.setData(A,n,a)}drawColorOpaque(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,U.COLOR_OPAQUE)}drawColorTransparent(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===0||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,U.COLOR_TRANSPARENT)}drawDepth(e,t){}drawNormals(e,t){}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,U.SILHOUETTE_XRAYED)}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,U.SILHOUETTE_HIGHLIGHTED)}drawSilhouetteSelected(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,U.SILHOUETTE_SELECTED)}drawEdgesColorOpaque(e,t){}drawEdgesColorTransparent(e,t){}drawEdgesHighlighted(e,t){}drawEdgesSelected(e,t){}drawEdgesXRayed(e,t){}drawPickMesh(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.pickMeshRenderer&&this._renderers.pickMeshRenderer.drawLayer(t,this,U.PICK)}drawPickDepths(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.pickDepthRenderer&&this._renderers.pickDepthRenderer.drawLayer(t,this,U.PICK)}drawPickNormals(e,t){}drawSnapInit(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(t,this,U.PICK)}drawSnap(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(t,this,U.PICK)}drawOcclusion(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.occlusionRenderer&&this._renderers.occlusionRenderer.drawLayer(t,this,U.COLOR_OPAQUE)}drawShadow(e,t){}destroy(){const e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.destroy()}}class Hs extends Wt{constructor(e,t){super(e,t,{instancing:!0})}_draw(e){const{gl:t}=this._scene.canvas,{state:i,frameCtx:s,incrementDrawState:o}=e;t.drawArraysInstanced(t.POINTS,0,i.positionsBuf.numItems,i.numInstances),o&&s.drawArrays++}}class zy extends Hs{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=e.pointsMaterial._state,o=[];return o.push("#version 300 es"),o.push("// Points instancing color vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),o.push("in vec4 color;"),o.push("in float flags;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),o.push("in vec4 modelMatrixCol0;"),o.push("in vec4 modelMatrixCol1;"),o.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(o),o.push("uniform float pointSize;"),s.perspectivePoints&&o.push("uniform float nearPlaneHeight;"),s.filterIntensity&&o.push("uniform vec2 intensityRange;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;")),i&&(o.push("out vec4 vWorldPosition;"),o.push("out float vFlags;")),o.push("out vec4 vColor;"),o.push("void main(void) {"),o.push("int colorFlag = int(flags) & 0xF;"),o.push("if (colorFlag != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),s.filterIntensity&&(o.push("float intensity = float(color.a) / 255.0;"),o.push("if (intensity < intensityRange[0] || intensity > intensityRange[1]) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {")),o.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),o.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&o.push("      worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),o.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, 1.0);"),i&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags = flags;")),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("gl_Position = clipPos;"),s.perspectivePoints?(o.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),o.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),o.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):o.push("gl_PointSize = pointSize;"),o.push("}"),s.filterIntensity&&o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points instancing color fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   outColor = vColor;"),e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}}class Ky extends Hs{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=e.pointsMaterial._state,o=[];return o.push("#version 300 es"),o.push("// Points instancing silhouette vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),o.push("in float flags;"),o.push("in vec4 color;"),o.push("in vec4 modelMatrixCol0;"),o.push("in vec4 modelMatrixCol1;"),o.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(o),o.push("uniform float pointSize;"),s.perspectivePoints&&o.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;")),o.push("uniform vec4 silhouetteColor;"),i&&(o.push("out vec4 vWorldPosition;"),o.push("out float vFlags;")),o.push("out vec4 vColor;"),o.push("void main(void) {"),o.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),o.push("if (silhouetteFlag != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),o.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&o.push("      worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags = flags;")),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("vColor = vec4(float(silhouetteColor.r) / 255.0, float(silhouetteColor.g) / 255.0, float(silhouetteColor.b) / 255.0, float(color.a) / 255.0);"),o.push("gl_Position = clipPos;"),s.perspectivePoints?(o.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),o.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),o.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):o.push("gl_PointSize = pointSize;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points instancing silhouette fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = vColor;"),s.push("}"),s}}class Wy extends Hs{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=e.pointsMaterial._state,o=[];return o.push("#version 300 es"),o.push("// Points instancing pick mesh vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),o.push("in float flags;"),o.push("in vec4 pickColor;"),o.push("in vec4 modelMatrixCol0;"),o.push("in vec4 modelMatrixCol1;"),o.push("in vec4 modelMatrixCol2;"),o.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(o),this._addRemapClipPosLines(o),o.push("uniform float pointSize;"),s.perspectivePoints&&o.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;")),i&&(o.push("out vec4 vWorldPosition;"),o.push("out float vFlags;")),o.push("out vec4 vPickColor;"),o.push("void main(void) {"),o.push("int pickFlag = int(flags) >> 12 & 0xF;"),o.push("if (pickFlag != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),o.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&o.push("      worldPosition.xyz = worldPosition.xyz + offset;"),o.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),o.push("  vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),i&&(o.push("  vWorldPosition = worldPosition;"),o.push("  vFlags = flags;")),o.push("vec4 clipPos = projMatrix * viewPosition;"),o.push("gl_Position = remapClipPos(clipPos);"),e.logarithmicDepthBufferEnabled&&o.push("vFragDepth = 1.0 + clipPos.w;"),s.perspectivePoints?(o.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),o.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),o.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):o.push("gl_PointSize = pointSize;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points instancing pick mesh fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vPickColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = vPickColor; "),s.push("}"),s}}class Xy extends Hs{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=e.pointsMaterial._state,o=[];return o.push("#version 300 es"),o.push("// Points instancing pick depth vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),o.push("in float flags;"),o.push("in vec4 modelMatrixCol0;"),o.push("in vec4 modelMatrixCol1;"),o.push("in vec4 modelMatrixCol2;"),o.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(o),this._addRemapClipPosLines(o),o.push("uniform float pointSize;"),s.perspectivePoints&&o.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;")),i&&(o.push("out vec4 vWorldPosition;"),o.push("out float vFlags;")),o.push("out vec4 vViewPosition;"),o.push("void main(void) {"),o.push("int pickFlag = int(flags) >> 12 & 0xF;"),o.push("if (pickFlag != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),o.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&o.push("      worldPosition.xyz = worldPosition.xyz + offset;"),o.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(o.push("  vWorldPosition = worldPosition;"),o.push("  vFlags = flags;")),o.push("  vViewPosition = viewPosition;"),o.push("vec4 clipPos = projMatrix * viewPosition;"),o.push("gl_Position = remapClipPos(clipPos);"),e.logarithmicDepthBufferEnabled&&o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("gl_Position = remapClipPos(clipPos);"),s.perspectivePoints?(o.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),o.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),o.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):o.push("gl_PointSize = pointSize;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points instancing pick depth fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("uniform float pickZNear;"),s.push("uniform float pickZFar;"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),s.push("    outColor = packDepth(zNormalizedDepth); "),s.push("}"),s}}class Yy extends Hs{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=e.pointsMaterial._state,o=[];return o.push("#version 300 es"),o.push("// Points instancing occlusion vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),o.push("in vec4 color;"),o.push("in float flags;"),o.push("in vec4 modelMatrixCol0;"),o.push("in vec4 modelMatrixCol1;"),o.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(o),o.push("uniform float pointSize;"),s.perspectivePoints&&o.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;")),i&&(o.push("out vec4 vWorldPosition;"),o.push("out float vFlags;")),o.push("void main(void) {"),o.push("int colorFlag = int(flags) & 0xF;"),o.push("if (colorFlag != renderPass) {"),o.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),o.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&o.push("      worldPosition.xyz = worldPosition.xyz + offset;"),o.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(o.push("  vWorldPosition = worldPosition;"),o.push("vFlags = flags;")),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("gl_Position = clipPos;"),s.perspectivePoints?(o.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),o.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),o.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):o.push("gl_PointSize = pointSize;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points instancing occlusion vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}}class Jy extends Hs{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=e.pointsMaterial._state,o=[];return o.push("#version 300 es"),o.push("// Points instancing depth vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),o.push("in float flags;"),o.push("in vec4 modelMatrixCol0;"),o.push("in vec4 modelMatrixCol1;"),o.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(o),o.push("uniform float pointSize;"),s.perspectivePoints&&o.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;")),i&&(o.push("out vec4 vWorldPosition;"),o.push("out float vFlags;")),o.push("void main(void) {"),o.push("int colorFlag = int(flags) & 0xF;"),o.push("if (colorFlag != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),o.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&o.push("      worldPosition.xyz = worldPosition.xyz + offset;"),o.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags = flags;")),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("gl_Position = clipPos;"),s.perspectivePoints?(o.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),o.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),o.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):o.push("gl_PointSize = pointSize;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState;let i,s;const o=t.getNumAllocatedSectionPlanes()>0,n=[];if(n.push("#version 300 es"),n.push("// Points instancing depth vertex shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),o)for(n.push("in vec4 vWorldPosition;"),n.push("in float vFlags;"),i=0,s=t.getNumAllocatedSectionPlanes();i<s;i++)n.push("uniform bool sectionPlaneActive"+i+";"),n.push("uniform vec3 sectionPlanePos"+i+";"),n.push("uniform vec3 sectionPlaneDir"+i+";");if(n.push("const float   packUpScale = 256. / 255.;"),n.push("const float   unpackDownscale = 255. / 256.;"),n.push("const vec3    packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),n.push("const vec4    unpackFactors = unpackDownscale / vec4( packFactors, 1. );"),n.push("const float   shiftRight8 = 1.0 / 256.;"),n.push("vec4 packDepthToRGBA( const in float v ) {"),n.push("    vec4 r = vec4( fract( v * packFactors ), v );"),n.push("    r.yzw -= r.xyz * shiftRight8;"),n.push("    return r * packUpScale;"),n.push("}"),n.push("out vec4 outColor;"),n.push("void main(void) {"),e.pointsMaterial.roundPoints&&(n.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),n.push("  float r = dot(cxy, cxy);"),n.push("  if (r > 1.0) {"),n.push("       discard;"),n.push("  }")),o){for(n.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;"),i=0,s=t.getNumAllocatedSectionPlanes();i<s;i++)n.push("if (sectionPlaneActive"+i+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),n.push("}");n.push("if (dist > 0.0) { discard; }"),n.push("}")}return n.push("    outColor = packDepthToRGBA( gl_FragCoord.z); "),e.logarithmicDepthBufferEnabled&&n.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("}"),n}}class Zy extends Hs{_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry shadow drawing vertex shader"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 color;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform mat4 shadowViewMatrix;"),s.push("uniform mat4 shadowProjMatrix;"),this._addMatricesUniformBlockLines(s),s.push("uniform float pointSize;"),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("void main(void) {"),s.push("int colorFlag     = int(flags) & 0xF;"),s.push("bool visible      = (colorFlag > 0);"),s.push("bool transparent  = ((float(color.a) / 255.0) < 1.0);"),s.push("if (!visible || transparent) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = shadowViewMatrix * worldPosition; "),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("  gl_Position = shadowProjMatrix * viewPosition;"),s.push("}"),s.push("gl_PointSize = pointSize;"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Instancing geometry depth drawing fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec3 vViewNormal;"),s.push("vec3 packNormalToRGB( const in vec3 normal ) {"),s.push("    return normalize( normal ) * 0.5 + 0.5;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    outColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),s.push("}"),s}}const qy=c.vec3(),$y=c.vec3(),ex=c.vec3();c.vec3();const tx=c.mat4();class ix extends Wt{constructor(e){super(e,!1,{instancing:!0})}drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,o=s.scene,n=o.canvas.gl,a=o.camera,A=t._state,l=t._state.origin,{position:h,rotationMatrix:d,rotationMatrixConjugate:f}=s,m=t.aabb,_=e.pickViewMatrix||a.viewMatrix;this._vaoCache.has(t)?n.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(A));const u=qy;u[0]=c.safeInv(m[3]-m[0])*c.MAX_INT,u[1]=c.safeInv(m[4]-m[1])*c.MAX_INT,u[2]=c.safeInv(m[5]-m[2])*c.MAX_INT,e.snapPickCoordinateScale[0]=c.safeInv(u[0]),e.snapPickCoordinateScale[1]=c.safeInv(u[1]),e.snapPickCoordinateScale[2]=c.safeInv(u[2]);let B;if(l||h[0]!==0||h[1]!==0||h[2]!==0){const P=$y;if(l){const v=c.transformPoint3(d,l,ex);P[0]=v[0],P[1]=v[1],P[2]=v[2]}else P[0]=0,P[1]=0,P[2]=0;P[0]+=h[0],P[1]+=h[1],P[2]+=h[2],B=ft(_,P,tx),e.snapPickOrigin[0]=P[0],e.snapPickOrigin[1]=P[1],e.snapPickOrigin[2]=P[2]}else B=_,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;n.uniform2fv(this.uVectorA,e.snapVectorA),n.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),n.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),n.uniform3fv(this._uCoordinateScaler,u),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible);let y=0;const x=4*4;this._matricesUniformBlockBufferData.set(f,0),this._matricesUniformBlockBufferData.set(B,y+=x),this._matricesUniformBlockBufferData.set(a.projMatrix,y+=x),this._matricesUniformBlockBufferData.set(A.positionsDecodeMatrix,y+=x),n.bindBuffer(n.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),n.bufferData(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,n.DYNAMIC_DRAW),n.bindBufferBase(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const P=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,P)}this.setSectionPlanesStateUniforms(t),this._aModelMatrixCol0.bindArrayBuffer(A.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(A.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(A.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aFlags&&(this._aFlags.bindArrayBuffer(A.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1)),n.drawArraysInstanced(n.POINTS,0,A.positionsBuf.numItems,A.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),this._aFlags&&n.vertexAttribDivisor(this._aFlags.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// SnapInstancingDepthBufInitRenderer vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),s.push("in vec4 pickColor;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),s.push("uniform vec2 snapVectorA;"),s.push("uniform vec2 snapInvVectorAB;"),s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;"),s.push("vec2 remapClipPos(vec2 clipPos) {"),s.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),s.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),s.push("    return vec2(x, y);"),s.push("}"),s.push("flat out vec4 vPickColor;"),s.push("out vec4 vWorldPosition;"),i&&s.push("out float vFlags;"),s.push("out highp vec3 relativeToOriginPosition;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("relativeToOriginPosition = worldPosition.xyz;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("  vWorldPosition = worldPosition;"),i&&s.push("  vFlags = flags;"),s.push("vPickColor = pickColor;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),s.push("float tmp = clipPos.w;"),s.push("clipPos.xyzw /= tmp;"),s.push("clipPos.xy = remapClipPos(clipPos.xy);"),s.push("clipPos.xyzw *= tmp;"),s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points instancing pick depth fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;"),s.push("uniform int layerNumber;"),s.push("uniform vec3 coordinateScaler;"),s.push("in vec4 vWorldPosition;"),s.push("flat in vec4 vPickColor;"),i){s.push("in float vFlags;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in highp vec3 relativeToOriginPosition;"),s.push("layout(location = 0) out highp ivec4 outCoords;"),s.push("layout(location = 1) out highp ivec4 outNormal;"),s.push("layout(location = 2) out lowp uvec4 outPickColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("    float dx = dFdx(vFragDepth);"),s.push("    float dy = dFdy(vFragDepth);"),s.push("    float diff = sqrt(dx*dx+dy*dy);"),s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),s.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),s.push("outNormal = ivec4(1.0, 1.0, 1.0, 1.0);"),s.push("outPickColor = uvec4(vPickColor);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const sx=c.vec3(),rx=c.vec3(),ox=c.vec3();c.vec3();const nx=c.mat4();class ax extends Wt{constructor(e){super(e,!1,{instancing:!0})}drawLayer(e,t,i){if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,o=s.scene,n=o.camera,a=o.canvas.gl,A=t._state,l=t._state.origin,{position:h,rotationMatrix:d,rotationMatrixConjugate:f}=s,m=t.aabb,_=e.pickViewMatrix||n.viewMatrix;this._vaoCache.has(t)?a.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(A));const u=sx;u[0]=c.safeInv(m[3]-m[0])*c.MAX_INT,u[1]=c.safeInv(m[4]-m[1])*c.MAX_INT,u[2]=c.safeInv(m[5]-m[2])*c.MAX_INT,e.snapPickCoordinateScale[0]=c.safeInv(u[0]),e.snapPickCoordinateScale[1]=c.safeInv(u[1]),e.snapPickCoordinateScale[2]=c.safeInv(u[2]);let B;if(l||h[0]!==0||h[1]!==0||h[2]!==0){const P=rx;if(l){const v=c.transformPoint3(d,l,ox);P[0]=v[0],P[1]=v[1],P[2]=v[2]}else P[0]=0,P[1]=0,P[2]=0;P[0]+=h[0],P[1]+=h[1],P[2]+=h[2],B=ft(_,P,nx),e.snapPickOrigin[0]=P[0],e.snapPickOrigin[1]=P[1],e.snapPickOrigin[2]=P[2]}else B=_,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;a.uniform2fv(this.uVectorA,e.snapVectorA),a.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),a.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),a.uniform3fv(this._uCoordinateScaler,u),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,e.pickInvisible);let y=0;const x=4*4;this._matricesUniformBlockBufferData.set(f,0),this._matricesUniformBlockBufferData.set(B,y+=x),this._matricesUniformBlockBufferData.set(n.projMatrix,y+=x),this._matricesUniformBlockBufferData.set(A.positionsDecodeMatrix,y+=x),a.bindBuffer(a.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),a.bufferData(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,a.DYNAMIC_DRAW),a.bindBufferBase(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const P=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,P)}this.setSectionPlanesStateUniforms(t),this._aModelMatrixCol0.bindArrayBuffer(A.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(A.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(A.modelMatrixCol2Buf),a.vertexAttribDivisor(this._aModelMatrixCol0.location,1),a.vertexAttribDivisor(this._aModelMatrixCol1.location,1),a.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aFlags.bindArrayBuffer(A.flagsBuf),a.vertexAttribDivisor(this._aFlags.location,1),a.drawArraysInstanced(a.POINTS,0,A.positionsBuf.numItems,A.numInstances),a.vertexAttribDivisor(this._aModelMatrixCol0.location,0),a.vertexAttribDivisor(this._aModelMatrixCol1.location,0),a.vertexAttribDivisor(this._aModelMatrixCol2.location,0),a.vertexAttribDivisor(this._aFlags.location,0),this._aOffset&&a.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// SnapInstancingDepthRenderer vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),s.push("uniform vec2 snapVectorA;"),s.push("uniform vec2 snapInvVectorAB;"),s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;"),s.push("vec2 remapClipPos(vec2 clipPos) {"),s.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),s.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),s.push("    return vec2(x, y);"),s.push("}"),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out highp vec3 relativeToOriginPosition;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("relativeToOriginPosition = worldPosition.xyz;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("  vWorldPosition = worldPosition;"),s.push("  vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),s.push("float tmp = clipPos.w;"),s.push("clipPos.xyzw /= tmp;"),s.push("clipPos.xy = remapClipPos(clipPos.xy);"),s.push("clipPos.xyzw *= tmp;"),s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),s.push("gl_Position = clipPos;"),s.push("gl_PointSize = 1.0;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// SnapInstancingDepthRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;"),s.push("uniform int layerNumber;"),s.push("uniform vec3 coordinateScaler;"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in highp vec3 relativeToOriginPosition;"),s.push("out highp ivec4 outCoords;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class Ax{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._occlusionRenderer&&this._occlusionRenderer.getValid()===!1&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new zy(this._scene,!1)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Ky(this._scene)),this._silhouetteRenderer}get depthRenderer(){return this._depthRenderer||(this._depthRenderer=new Jy(this._scene)),this._depthRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new Wy(this._scene)),this._pickMeshRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new Xy(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new Yy(this._scene)),this._occlusionRenderer}get shadowRenderer(){return this._shadowRenderer||(this._shadowRenderer=new Zy(this._scene)),this._shadowRenderer}get snapInitRenderer(){return this._snapInitRenderer||(this._snapInitRenderer=new ix(this._scene,!1)),this._snapInitRenderer}get snapRenderer(){return this._snapRenderer||(this._snapRenderer=new ax(this._scene)),this._snapRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}const BA={};function lx(r){const e=r.id;let t=BA[e];return t||(t=new Ax(r),BA[e]=t,t._compile(),r.on("compile",()=>{t._compile()}),r.on("destroyed",()=>{delete BA[e],t._destroy()})),t}const mn=new Uint8Array(4),Du=new Float32Array(1),_n=new Float32Array(3),oi=new Float32Array(4);class cx{constructor(e){console.info("VBOInstancingPointsLayer"),this.model=e.model,this.material=e.material,this.sortId="PointsInstancingLayer",this.layerIndex=e.layerIndex,this._renderers=lx(e.model.scene),this._aabb=c.collapseAABB3(),this._state=new Mt({obb:c.OBB3(),numInstances:0,origin:e.origin?c.vec3(e.origin):null,geometry:e.geometry,positionsDecodeMatrix:e.geometry.positionsDecodeMatrix,colorsBuf:null,flagsBuf:null,offsetsBuf:null,modelMatrixCol0Buf:null,modelMatrixCol1Buf:null,modelMatrixCol2Buf:null,pickColorsBuf:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this.numIndices=e.geometry.numIndices,this._pickColors=[],this._offsets=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._portions=[],this._meshes=[],this._aabb=c.collapseAABB3(),this.aabbDirty=!0,this._finalized=!1}get aabb(){if(this.aabbDirty){c.collapseAABB3(this._aabb);for(let e=0,t=this._meshes.length;e<t;e++)c.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}createPortion(e,t){const i=t.meshMatrix,s=t.pickColor;if(this._finalized)throw"Already finalized";this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(i[0]),this._modelMatrixCol0.push(i[4]),this._modelMatrixCol0.push(i[8]),this._modelMatrixCol0.push(i[12]),this._modelMatrixCol1.push(i[1]),this._modelMatrixCol1.push(i[5]),this._modelMatrixCol1.push(i[9]),this._modelMatrixCol1.push(i[13]),this._modelMatrixCol2.push(i[2]),this._modelMatrixCol2.push(i[6]),this._modelMatrixCol2.push(i[10]),this._modelMatrixCol2.push(i[14]),this._pickColors.push(s[0]),this._pickColors.push(s[1]),this._pickColors.push(s[2]),this._pickColors.push(s[3]),this._state.numInstances++;const o=this._portions.length;return this._portions.push({}),this._numPortions++,this.model.numPortions++,this._meshes.push(e),o}finalize(){if(this._finalized)throw"Already finalized";const e=this.model.scene.canvas.gl,t=this._pickColors.length/4,i=this._state,s=i.geometry;if(t>0){let o=!1;i.flagsBuf=new Ee(e,e.ARRAY_BUFFER,new Float32Array(t),t,1,e.DYNAMIC_DRAW,o)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0&&(i.offsetsBuf=new Ee(e,e.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,e.DYNAMIC_DRAW,!1),this._offsets=[]),s.positionsCompressed&&s.positionsCompressed.length>0&&(i.positionsBuf=new Ee(e,e.ARRAY_BUFFER,s.positionsCompressed,s.positionsCompressed.length,3,e.STATIC_DRAW,!1),i.positionsDecodeMatrix=c.mat4(s.positionsDecodeMatrix)),s.colorsCompressed&&s.colorsCompressed.length>0){const o=new Uint8Array(s.colorsCompressed),n=!1;i.colorsBuf=new Ee(e,e.ARRAY_BUFFER,o,o.length,4,e.STATIC_DRAW,n)}this._modelMatrixCol0.length>0&&(i.modelMatrixCol0Buf=new Ee(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,e.STATIC_DRAW,!1),i.modelMatrixCol1Buf=new Ee(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,e.STATIC_DRAW,!1),i.modelMatrixCol2Buf=new Ee(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,e.STATIC_DRAW,!1),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[]),this._pickColors.length>0&&(i.pickColorsBuf=new Ee(e,e.ARRAY_BUFFER,new Uint8Array(this._pickColors),this._pickColors.length,4,e.STATIC_DRAW,!1),this._pickColors=[]),i.geometry=null,this._finalized=!0}initFlags(e,t,i){t&k.VISIBLE&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&k.HIGHLIGHTED&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&k.XRAYED&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&k.SELECTED&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&k.CLIPPABLE&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&k.EDGES&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&k.PICKABLE&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&k.CULLED&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i)}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&k.VISIBLE?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&k.HIGHLIGHTED?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&k.XRAYED?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&k.SELECTED?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){if(!this._finalized)throw"Not finalized";t&k.EDGES?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&k.CLIPPABLE?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,t)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&k.PICKABLE?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&k.CULLED?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){if(!this._finalized)throw"Not finalized";mn[0]=t[0],mn[1]=t[1],mn[2]=t[2],this._state.colorsBuf.setData(mn,e*3)}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i){if(!this._finalized)throw"Not finalized";const s=!!(t&k.VISIBLE),o=!!(t&k.XRAYED),n=!!(t&k.HIGHLIGHTED),a=!!(t&k.SELECTED),A=!!(t&k.EDGES),l=!!(t&k.PICKABLE),h=!!(t&k.CULLED);let d;!s||h||o||n&&!this.model.scene.highlightMaterial.glowThrough||a&&!this.model.scene.selectedMaterial.glowThrough?d=U.NOT_RENDERED:i?d=U.COLOR_TRANSPARENT:d=U.COLOR_OPAQUE;let f;!s||h?f=U.NOT_RENDERED:a?f=U.SILHOUETTE_SELECTED:n?f=U.SILHOUETTE_HIGHLIGHTED:o?f=U.SILHOUETTE_XRAYED:f=U.NOT_RENDERED;let m=0;!s||h?m=U.NOT_RENDERED:a?m=U.EDGES_SELECTED:n?m=U.EDGES_HIGHLIGHTED:o?m=U.EDGES_XRAYED:A?i?m=U.EDGES_COLOR_TRANSPARENT:m=U.EDGES_COLOR_OPAQUE:m=U.NOT_RENDERED;let _=s&&!h&&l?U.PICK:U.NOT_RENDERED;const u=t&k.CLIPPABLE?255:0;let B=0;B|=d,B|=f<<4,B|=m<<8,B|=_<<12,B|=u<<16,Du[0]=B,this._state.flagsBuf.setData(Du,e)}setOffset(e,t){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled){this.model.error("Entity#offset not enabled for this Viewer");return}_n[0]=t[0],_n[1]=t[1],_n[2]=t[2],this._state.offsetsBuf.setData(_n,e*3)}setMatrix(e,t){if(!this._finalized)throw"Not finalized";const i=e*4;oi[0]=t[0],oi[1]=t[4],oi[2]=t[8],oi[3]=t[12],this._state.modelMatrixCol0Buf.setData(oi,i),oi[0]=t[1],oi[1]=t[5],oi[2]=t[9],oi[3]=t[13],this._state.modelMatrixCol1Buf.setData(oi,i),oi[0]=t[2],oi[1]=t[6],oi[2]=t[10],oi[3]=t[14],this._state.modelMatrixCol2Buf.setData(oi,i)}drawColorOpaque(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,U.COLOR_OPAQUE)}drawColorTransparent(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===0||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,U.COLOR_TRANSPARENT)}drawDepth(e,t){}drawNormals(e,t){}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,U.SILHOUETTE_XRAYED)}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,U.SILHOUETTE_HIGHLIGHTED)}drawSilhouetteSelected(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,U.SILHOUETTE_SELECTED)}drawEdgesColorOpaque(e,t){}drawEdgesColorTransparent(e,t){}drawEdgesHighlighted(e,t){}drawEdgesSelected(e,t){}drawEdgesXRayed(e,t){}drawOcclusion(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.occlusionRenderer&&this._renderers.occlusionRenderer.drawLayer(t,this,U.COLOR_OPAQUE)}drawShadow(e,t){}drawPickMesh(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.pickMeshRenderer&&this._renderers.pickMeshRenderer.drawLayer(t,this,U.PICK)}drawPickDepths(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.pickDepthRenderer&&this._renderers.pickDepthRenderer.drawLayer(t,this,U.PICK)}drawPickNormals(e,t){}drawSnapInit(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(t,this,U.PICK)}drawSnap(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(t,this,U.PICK)}destroy(){const e=this._state;e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.modelMatrixCol0Buf&&(e.modelMatrixCol0Buf.destroy(),e.modelMatrixCol0Buf=null),e.modelMatrixCol1Buf&&(e.modelMatrixCol1Buf.destroy(),e.modelMatrixCol1Buf=null),e.modelMatrixCol2Buf&&(e.modelMatrixCol2Buf.destroy(),e.modelMatrixCol2Buf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.destroy()}}const Ru=c.vec3(),hx=c.vec3(),ux=c.mat4();class dx{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=this._scene,o=s.camera,n=t.model,a=s.canvas.gl,A=t._state,l=A.textureState,h=t._state.origin,{position:d,rotationMatrix:f,rotationMatrixConjugate:m}=n,_=o.viewMatrix;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,A)),l.bindCommonTextures(this._program,this.uPerObjectDecodeMatrix,this._uPerVertexPosition,this.uPerObjectColorAndFlags,this._uPerObjectMatrix);let u;const B=h[0]!==0||h[1]!==0||h[2]!==0,y=d[0]!==0||d[1]!==0||d[2]!==0;if(B||y){const v=Ru;if(B){const b=c.transformPoint3(f,h,hx);v[0]=b[0],v[1]=b[1],v[2]=b[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=d[0],v[1]+=d[1],v[2]+=d[2],u=ft(_,v,ux)}else u=_;if(a.uniformMatrix4fv(this._uSceneModelMatrix,!1,m),a.uniformMatrix4fv(this._uViewMatrix,!1,u),a.uniformMatrix4fv(this._uProjMatrix,!1,o.projMatrix),a.uniform1i(this._uRenderPass,i),s.logarithmicDepthBufferEnabled){const v=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,v)}const x=s._sectionPlanesState.getNumAllocatedSectionPlanes(),P=s._sectionPlanesState.sectionPlanes.length;if(x>0){const v=s._sectionPlanesState.sectionPlanes,b=t.layerIndex*P,C=n.renderFlags;for(let I=0;I<x;I++){const E=this._uSectionPlanes[I];if(E)if(I<P){const S=C.sectionPlanesActivePerLayer[b+I];if(a.uniform1i(E.active,S?1:0),S){const R=v[I];if(h){const D=Ot(R.dist,R.dir,h,Ru);a.uniform3fv(E.pos,D)}else a.uniform3fv(E.pos,R.pos);a.uniform3fv(E.dir,R.dir)}}else a.uniform1i(E.active,0)}}A.numIndices8Bits>0&&(l.bindLineIndicesTextures(this._program,this._uPerLineObject,this._uPerLineIndices,8),a.drawArrays(a.LINES,0,A.numIndices8Bits)),A.numIndices16Bits>0&&(l.bindLineIndicesTextures(this._program,this._uPerLineObject,this._uPerLineIndices,16),a.drawArrays(a.LINES,0,A.numIndices16Bits)),A.numIndices32Bits>0&&(l.bindLineIndicesTextures(this._program,this._uPerLineObject,this._uPerLineIndices,32),a.drawArrays(a.LINES,0,A.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Ft(t,this._buildShader()),this._program.errors){this.errors=this._program.errors,console.error(this.errors);return}const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+s),pos:i.getLocation("sectionPlanePos"+s),dir:i.getLocation("sectionPlaneDir"+s)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uPerObjectDecodeMatrix="uPerObjectDecodeMatrix",this.uPerObjectColorAndFlags="uPerObjectColorAndFlags",this._uPerVertexPosition="uPerVertexPosition",this._uPerLineIndices="uPerLineIndices",this._uPerLineObject="uPerLineObject",this._uPerObjectMatrix="uPerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=this._program,o=t.camera.project;if(s.bind(),t.logarithmicDepthBufferEnabled){const n=2/(Math.log(o.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,n)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// LinesDataTextureColorRenderer"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled,i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uPerObjectDecodeMatrix;"),i.push("uniform highp sampler2D uPerObjectMatrix;"),i.push("uniform lowp usampler2D uPerObjectColorAndFlags;"),i.push("uniform mediump usampler2D uPerVertexPosition;"),i.push("uniform highp usampler2D uPerLineIndices;"),i.push("uniform mediump usampler2D uPerLineObject;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("  int lineIndex = gl_VertexID / 2;"),i.push("  int h_packed_object_id_index = (lineIndex >> 3) & 4095;"),i.push("  int v_packed_object_id_index = (lineIndex >> 3) >> 12;"),i.push("  int objectIndex = int(texelFetch(uPerLineObject, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("  ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("  uvec4 flags = texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("  uvec4 flags2 = texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("  if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("      return;"),i.push("  } else {"),i.push("      ivec4 packedVertexBase = ivec4(texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("      ivec4 packedLineIndexBaseOffset = ivec4(texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0));"),i.push("      int lineIndexBaseOffset = (packedLineIndexBaseOffset.r << 24) + (packedLineIndexBaseOffset.g << 16) + (packedLineIndexBaseOffset.b << 8) + packedLineIndexBaseOffset.a;"),i.push("      int h_index = (lineIndex - lineIndexBaseOffset) & 4095;"),i.push("      int v_index = (lineIndex - lineIndexBaseOffset) >> 12;"),i.push("      ivec3 vertexIndices = ivec3(texelFetch(uPerLineIndices, ivec2(h_index, v_index), 0));"),i.push("      ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("      int indexPositionH = uniqueVertexIndexes[gl_VertexID % 2] & 4095;"),i.push("      int indexPositionV = uniqueVertexIndexes[gl_VertexID % 2] >> 12;"),i.push("      mat4 objectInstanceMatrix = mat4 (texelFetch (uPerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uPerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uPerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uPerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("      mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uPerObjectDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uPerObjectDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uPerObjectDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uPerObjectDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("      uvec4 flags = texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("      uvec4 flags2 = texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("      vec3 position = vec3(texelFetch(uPerVertexPosition, ivec2(indexPositionH, indexPositionV), 0));"),i.push("      uvec4 color = texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("      if (color.a == 0u) {"),i.push("          gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("          return;"),i.push("      };"),i.push("      vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2.r;")),i.push("      vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("      vFragDepth = 1.0 + clipPos.w;"),i.push("      isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("      gl_Position = clipPos;"),i.push("      vec4 rgb = vec4(color.rgba);"),i.push("      vColor = vec4(float(rgb.r*0.5) / 255.0, float(rgb.g*0.5) / 255.0, float(rgb.b*0.5) / 255.0, float(rgb.a) / 255.0);"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// LinesDataTextureColorRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("flat in uint vFlags2;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = vFlags2 > 0u;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { "),s.push("      discard;"),s.push("  }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outColor            = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class px{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null)}eagerCreateRenders(){}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new dx(this._scene,!1)),this._colorRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy()}}const PA={};function fx(r){const e=r.id;let t=PA[e];return t||(t=new px(r),PA[e]=t,t._compile(),t.eagerCreateRenders(),r.on("compile",()=>{t._compile(),t.eagerCreateRenders()}),r.on("destroyed",()=>{delete PA[e],t._destroy()})),t}class gx{constructor(){this.positionsCompressed=[],this.lenPositionsCompressed=0,this.indices8Bits=[],this.lenIndices8Bits=0,this.indices16Bits=[],this.lenIndices16Bits=0,this.indices32Bits=[],this.lenIndices32Bits=0,this.perObjectColors=[],this.perObjectPickColors=[],this.perObjectSolid=[],this.perObjectOffsets=[],this.perObjectPositionsDecodeMatrices=[],this.perObjectInstancePositioningMatrices=[],this.perObjectVertexBases=[],this.perObjectIndexBaseOffsets=[],this.perLineNumberPortionId8Bits=[],this.perLineNumberPortionId16Bits=[],this.perLineNumberPortionId32Bits=[]}}class mx{constructor(){this.texturePerObjectColorsAndFlags=null,this.texturePerObjectOffsets=null,this.texturePerObjectInstanceMatrices=null,this.texturePerObjectPositionsDecodeMatrix=null,this.texturePerVertexIdCoordinates=null,this.texturePerLineIdPortionIds8Bits=null,this.texturePerLineIdPortionIds16Bits=null,this.texturePerLineIdPortionIds32Bits=null,this.texturePerLineIdIndices8Bits=null,this.texturePerLineIdIndices16Bits=null,this.texturePerLineIdIndices32Bits=null,this.textureModelMatrices=null}finalize(){this.indicesPerBitnessTextures={8:this.texturePerLineIdIndices8Bits,16:this.texturePerLineIdIndices16Bits,32:this.texturePerLineIdIndices32Bits},this.indicesPortionIdsPerBitnessTextures={8:this.texturePerLineIdPortionIds8Bits,16:this.texturePerLineIdPortionIds16Bits,32:this.texturePerLineIdPortionIds32Bits}}bindCommonTextures(e,t,i,s,o){this.texturePerObjectPositionsDecodeMatrix.bindTexture(e,t,1),this.texturePerVertexIdCoordinates.bindTexture(e,i,2),this.texturePerObjectColorsAndFlags.bindTexture(e,s,3),this.texturePerObjectInstanceMatrices.bindTexture(e,o,4)}bindLineIndicesTextures(e,t,i,s){this.indicesPortionIdsPerBitnessTextures[s].bindTexture(e,t,5),this.indicesPerBitnessTextures[s].bindTexture(e,i,6)}}class Ut{constructor(e,t,i,s,o=null){this._gl=e,this._texture=t,this._textureWidth=i,this._textureHeight=s,this._textureData=o}bindTexture(e,t,i){return e.bindTexture(t,this,i)}bind(e){return this._gl.activeTexture(this._gl["TEXTURE"+e]),this._gl.bindTexture(this._gl.TEXTURE_2D,this._texture),!0}unbind(e){}}const ct={sizeDataColorsAndFlags:0,sizeDataPositionDecodeMatrices:0,sizeDataTextureOffsets:0,sizeDataTexturePositions:0,sizeDataTextureIndices:0,sizeDataTexturePortionIds:0,numberOfGeometries:0,numberOfPortions:0,numberOfLayers:0,numberOfTextures:0,totalLines:0,totalLines8Bits:0,totalLines16Bits:0,totalLines32Bits:0,cannotCreatePortion:{because10BitsObjectId:0,becauseTextureSize:0},overheadSizeAlignementIndices:0,overheadSizeAlignementEdgeIndices:0};window.printDataTextureRamStats=function(){console.log(JSON.stringify(ct,null,4));let r=0;Object.keys(ct).forEach(t=>{t.startsWith("size")&&(r+=ct[t])}),console.log(`Total size ${r} bytes (${(r/1e3/1e3).toFixed(2)} MB)`),console.log(`Avg bytes / triangle: ${(r/ct.totalLines).toFixed(2)}`);let e={};Object.keys(ct).forEach(t=>{t.startsWith("size")&&(e[t]=`${(ct[t]/r*100).toFixed(2)} % of total`)}),console.log(JSON.stringify({percentualRamUsage:e},null,4))};class _x{disableBindedTextureFiltering(e){e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)}generateTextureForColorsAndFlags(e,t,i,s,o){const n=t.length;this.numPortions=n;const a=512*8,A=Math.ceil(n/(a/8));if(A===0)throw"texture height===0";const l=new Uint8Array(4*a*A);ct.sizeDataColorsAndFlags+=l.byteLength,ct.numberOfTextures++;for(let d=0;d<n;d++)l.set(t[d],d*32+0),l.set(i[d],d*32+4),l.set([0,0,0,0],d*32+8),l.set([0,0,0,0],d*32+12),l.set([s[d]>>24&255,s[d]>>16&255,s[d]>>8&255,s[d]&255],d*32+16),l.set([o[d]>>24&255,o[d]>>16&255,o[d]>>8&255,o[d]&255],d*32+20);const h=e.createTexture();return e.bindTexture(e.TEXTURE_2D,h),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA8UI,a,A),e.texSubImage2D(e.TEXTURE_2D,0,0,0,a,A,e.RGBA_INTEGER,e.UNSIGNED_BYTE,l,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Ut(e,h,a,A,l)}generateTextureForObjectOffsets(e,t){const s=Math.ceil(t/512);if(s===0)throw"texture height===0";const o=new Float32Array(3*512*s).fill(0);ct.sizeDataTextureOffsets+=o.byteLength,ct.numberOfTextures++;const n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RGB32F,512,s),e.texSubImage2D(e.TEXTURE_2D,0,0,0,512,s,e.RGB,e.FLOAT,o,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Ut(e,n,512,s,o)}generateTextureForInstancingMatrices(e,t){const i=t.length;if(i===0)throw"num instance matrices===0";const s=512*4,o=Math.ceil(i/(s/4)),n=new Float32Array(4*s*o);ct.numberOfTextures++;for(let A=0;A<t.length;A++)n.set(t[A],A*16);const a=e.createTexture();return e.bindTexture(e.TEXTURE_2D,a),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA32F,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RGBA,e.FLOAT,n,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Ut(e,a,s,o,n)}generateTextureForPositionsDecodeMatrices(e,t){const i=t.length;if(i===0)throw"num decode+entity matrices===0";const s=512*4,o=Math.ceil(i/(s/4)),n=new Float32Array(4*s*o);ct.sizeDataPositionDecodeMatrices+=n.byteLength,ct.numberOfTextures++;for(let A=0;A<t.length;A++)n.set(t[A],A*16);const a=e.createTexture();return e.bindTexture(e.TEXTURE_2D,a),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA32F,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RGBA,e.FLOAT,n,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Ut(e,a,s,o)}generateTextureFor8BitIndices(e,t,i){if(i===0)return{texture:null,textureHeight:0};const s=4096,o=Math.ceil(i/3/s);if(o===0)throw"texture height===0";const n=s*o*3,a=new Uint8Array(n);ct.sizeDataTextureIndices+=a.byteLength,ct.numberOfTextures++;for(let l=0,h=0,d=t.length;l<d;l++){const f=t[l];a.set(f,h),h+=f.length}const A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.RGB8UI,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RGB_INTEGER,e.UNSIGNED_BYTE,a,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Ut(e,A,s,o)}generateTextureFor16BitIndices(e,t,i){if(i===0)return{texture:null,textureHeight:0};const s=4096,o=Math.ceil(i/3/s);if(o===0)throw"texture height===0";const n=s*o*3,a=new Uint16Array(n);ct.sizeDataTextureIndices+=a.byteLength,ct.numberOfTextures++;for(let l=0,h=0,d=t.length;l<d;l++){const f=t[l];a.set(f,h),h+=f.length}const A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.RGB16UI,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RGB_INTEGER,e.UNSIGNED_SHORT,a,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Ut(e,A,s,o)}generateTextureFor32BitIndices(e,t,i){if(i===0)return{texture:null,textureHeight:0};const s=4096,o=Math.ceil(i/3/s);if(o===0)throw"texture height===0";const n=s*o*3,a=new Uint32Array(n);ct.sizeDataTextureIndices+=a.byteLength,ct.numberOfTextures++;for(let l=0,h=0,d=t.length;l<d;l++){const f=t[l];a.set(f,h),h+=f.length}const A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.RGB32UI,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RGB_INTEGER,e.UNSIGNED_INT,a,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Ut(e,A,s,o)}generateTextureForPositions(e,t,i){const s=i/3,o=4096,n=Math.ceil(s/o);if(n===0)throw"texture height===0";const a=o*n*3,A=new Uint16Array(a);ct.sizeDataTexturePositions+=A.byteLength,ct.numberOfTextures++;for(let h=0,d=0,f=t.length;h<f;h++){const m=t[h];A.set(m,d),d+=m.length}const l=e.createTexture();return e.bindTexture(e.TEXTURE_2D,l),e.texStorage2D(e.TEXTURE_2D,1,e.RGB16UI,o,n),e.texSubImage2D(e.TEXTURE_2D,0,0,0,o,n,e.RGB_INTEGER,e.UNSIGNED_SHORT,A,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Ut(e,l,o,n)}generateTextureForPackedPortionIds(e,t){if(t.length===0)return{texture:null,textureHeight:0};const i=t.length,s=4096,o=Math.ceil(i/s);if(o===0)throw"texture height===0";const n=s*o,a=new Uint16Array(n);a.set(t,0),ct.sizeDataTexturePortionIds+=a.byteLength,ct.numberOfTextures++;const A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.R16UI,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RED_INTEGER,e.UNSIGNED_SHORT,a,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Ut(e,A,s,o)}}const vx=new yc,Lu=65536,vn=vx.maxDataTextureHeight,yA=8,Zr=10,xA=new Float32Array(16),Yt=new Uint8Array(4),qr=new Float32Array(3);let Bx=0;const Px=c.identityMat4();class yx{constructor(e,t){console.info("Creating DTXLinesLayer"),ct.numberOfLayers++,this._layerNumber=Bx++,this.sortId=`TriDTX-${this._layerNumber}`,this.layerIndex=t.layerIndex,this._renderers=fx(e.scene),this.model=e,this._buffer=new gx,this._dataTextureState=new mx,this._dataTextureGenerator=new _x,this._state=new Mt({origin:c.vec3(t.origin),textureState:this._dataTextureState,numIndices8Bits:0,numIndices16Bits:0,numIndices32Bits:0,numVertices:0}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._subPortions=[],this._portionToSubPortionsMap=[],this._bucketGeometries={},this._meshes=[],this._aabb=c.collapseAABB3(),this.aabbDirty=!0,this._numUpdatesInFrame=0,this._finalized=!1}get aabb(){if(this.aabbDirty){c.collapseAABB3(this._aabb);for(let e=0,t=this._meshes.length;e<t;e++)c.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}canCreatePortion(e){if(this._finalized)throw"Already finalized";const t=e.buckets.length;this._numPortions+t>Lu&&ct.cannotCreatePortion.because10BitsObjectId++;let i=this._numPortions+t<=Lu;const s=0,o=e.geometryId!==void 0&&e.geometryId!==null?`${e.geometryId}#${s}`:`${e.id}#${s}`;if(!this._bucketGeometries[o]){const a=Math.max(this._state.numIndices8Bits,this._state.numIndices16Bits,this._state.numIndices32Bits);let A=0,l=0;e.buckets.forEach(h=>{A+=h.positionsCompressed.length/3,l+=h.indices.length/2}),(this._state.numVertices+A>vn*4096||a+l>vn*4096)&&ct.cannotCreatePortion.becauseTextureSize++,i&&(i=this._state.numVertices+A<=vn*4096&&a+l<=vn*4096)}return i}createPortion(e,t){if(this._finalized)throw"Already finalized";const i=[];t.buckets.forEach((o,n)=>{const a=t.geometryId!==void 0&&t.geometryId!==null?`${t.geometryId}#${n}`:`${t.id}#${n}`;let A=this._bucketGeometries[a];A||(A=this._createBucketGeometry(t,o),this._bucketGeometries[a]=A);const l=this._createSubPortion(t,A,o);i.push(l)});const s=this._portionToSubPortionsMap.length;return this._portionToSubPortionsMap.push(i),this.model.numPortions++,this._meshes.push(e),s}_createBucketGeometry(e,t){if(t.indices){const d=Math.ceil(t.indices.length/2/yA)*yA*2;ct.overheadSizeAlignementIndices+=2*(d-t.indices.length);const f=new Uint32Array(d);f.fill(0),f.set(t.indices),t.indices=f}const i=t.positionsCompressed,s=t.indices,o=this._buffer;o.positionsCompressed.push(i);const n=o.lenPositionsCompressed/3,a=i.length/3;o.lenPositionsCompressed+=i.length;let A,l=0;if(s){l=s.length/2;let d;a<=256?(d=o.indices8Bits,A=o.lenIndices8Bits/2,o.lenIndices8Bits+=s.length):a<=65536?(d=o.indices16Bits,A=o.lenIndices16Bits/2,o.lenIndices16Bits+=s.length):(d=o.indices32Bits,A=o.lenIndices32Bits/2,o.lenIndices32Bits+=s.length),d.push(s)}return this._state.numVertices+=a,ct.numberOfGeometries++,{vertexBase:n,numVertices:a,numLines:l,indicesBase:A}}_createSubPortion(e,t){const i=e.color,s=e.colors,o=e.opacity,n=e.meshMatrix,a=e.pickColor,A=this._buffer,l=this._state;A.perObjectPositionsDecodeMatrices.push(e.positionsDecodeMatrix),A.perObjectInstancePositioningMatrices.push(n||Px),A.perObjectSolid.push(!!e.solid),s?A.perObjectColors.push([s[0]*255,s[1]*255,s[2]*255,255]):i&&A.perObjectColors.push([i[0],i[1],i[2],o]),A.perObjectPickColors.push(a),A.perObjectVertexBases.push(t.vertexBase);{let d;t.numVertices<=256?d=l.numIndices8Bits:t.numVertices<=65536?d=l.numIndices16Bits:d=l.numIndices32Bits,A.perObjectIndexBaseOffsets.push(d/2-t.indicesBase)}const h=this._subPortions.length;if(t.numLines>0){let d=t.numLines*2,f;t.numVertices<=256?(f=A.perLineNumberPortionId8Bits,l.numIndices8Bits+=d,ct.totalLines8Bits+=t.numLines):t.numVertices<=65536?(f=A.perLineNumberPortionId16Bits,l.numIndices16Bits+=d,ct.totalLines16Bits+=t.numLines):(f=A.perLineNumberPortionId32Bits,l.numIndices32Bits+=d,ct.totalLines32Bits+=t.numLines),ct.totalLines+=t.numLines;for(let m=0;m<t.numLines;m+=yA)f.push(h)}return this._subPortions.push({numVertices:t.numLines}),this._numPortions++,ct.numberOfPortions++,h}finalize(){if(this._finalized)return;const e=this._state,t=this._dataTextureState,i=this.model.scene.canvas.gl,s=this._buffer;e.gl=i,t.texturePerObjectColorsAndFlags=this._dataTextureGenerator.generateTextureForColorsAndFlags(i,s.perObjectColors,s.perObjectPickColors,s.perObjectVertexBases,s.perObjectIndexBaseOffsets,s.perObjectSolid),t.texturePerObjectInstanceMatrices=this._dataTextureGenerator.generateTextureForInstancingMatrices(i,s.perObjectInstancePositioningMatrices),t.texturePerObjectPositionsDecodeMatrix=this._dataTextureGenerator.generateTextureForPositionsDecodeMatrices(i,s.perObjectPositionsDecodeMatrices),t.texturePerVertexIdCoordinates=this._dataTextureGenerator.generateTextureForPositions(i,s.positionsCompressed,s.lenPositionsCompressed),t.texturePerLineIdPortionIds8Bits=this._dataTextureGenerator.generateTextureForPackedPortionIds(i,s.perLineNumberPortionId8Bits),t.texturePerLineIdPortionIds16Bits=this._dataTextureGenerator.generateTextureForPackedPortionIds(i,s.perLineNumberPortionId16Bits),t.texturePerLineIdPortionIds32Bits=this._dataTextureGenerator.generateTextureForPackedPortionIds(i,s.perLineNumberPortionId32Bits),s.lenIndices8Bits>0&&(t.texturePerLineIdIndices8Bits=this._dataTextureGenerator.generateTextureFor8BitIndices(i,s.indices8Bits,s.lenIndices8Bits)),s.lenIndices16Bits>0&&(t.texturePerLineIdIndices16Bits=this._dataTextureGenerator.generateTextureFor16BitIndices(i,s.indices16Bits,s.lenIndices16Bits)),s.lenIndices32Bits>0&&(t.texturePerLineIdIndices32Bits=this._dataTextureGenerator.generateTextureFor32BitIndices(i,s.indices32Bits,s.lenIndices32Bits)),t.finalize(),this._buffer=null,this._bucketGeometries={},this._finalized=!0,this._deferredSetFlagsDirty=!1,this._onSceneRendering=this.model.scene.on("rendering",()=>{this._deferredSetFlagsDirty&&this._uploadDeferredFlags(),this._numUpdatesInFrame=0})}initFlags(e,t,i){t&k.VISIBLE&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&k.HIGHLIGHTED&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&k.XRAYED&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&k.SELECTED&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&k.CLIPPABLE&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&k.PICKABLE&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&k.CULLED&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++);const s=!0;this._setFlags(e,t,i,s),this._setFlags2(e,t,s)}flushInitFlags(){this._setDeferredFlags(),this._setDeferredFlags2()}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&k.VISIBLE?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&k.HIGHLIGHTED?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&k.XRAYED?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&k.SELECTED?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&k.CLIPPABLE?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(e,t)}_beginDeferredFlags(){this._deferredSetFlagsActive=!0}_uploadDeferredFlags(){if(this._deferredSetFlagsActive=!1,!this._deferredSetFlagsDirty)return;this._deferredSetFlagsDirty=!1;const e=this.model.scene.canvas.gl,t=this._dataTextureState;e.bindTexture(e.TEXTURE_2D,t.texturePerObjectColorsAndFlags._texture),e.texSubImage2D(e.TEXTURE_2D,0,0,0,t.texturePerObjectColorsAndFlags._textureWidth,t.texturePerObjectColorsAndFlags._textureHeight,e.RGBA_INTEGER,e.UNSIGNED_BYTE,t.texturePerObjectColorsAndFlags._textureData)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&k.CULLED?(this._numCulledLayerPortions+=this._portionToSubPortionsMap[e].length,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions-=this._portionToSubPortionsMap[e].length,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&k.PICKABLE?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){const i=this._portionToSubPortionsMap[e];for(let s=0,o=i.length;s<o;s++)this._subPortionSetColor(i[s],t)}_subPortionSetColor(e,t){if(!this._finalized)throw"Not finalized";const i=this._dataTextureState,s=this.model.scene.canvas.gl;if(Yt[0]=t[0],Yt[1]=t[1],Yt[2]=t[2],Yt[3]=t[3],i.texturePerObjectColorsAndFlags._textureData.set(Yt,e*32),this._deferredSetFlagsActive){this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=Zr&&this._beginDeferredFlags(),s.bindTexture(s.TEXTURE_2D,i.texturePerObjectColorsAndFlags._texture),s.texSubImage2D(s.TEXTURE_2D,0,e%512*8,Math.floor(e/512),1,1,s.RGBA_INTEGER,s.UNSIGNED_BYTE,Yt)}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i,s=!1){const o=this._portionToSubPortionsMap[e];for(let n=0,a=o.length;n<a;n++)this._subPortionSetFlags(o[n],t,i,s)}_subPortionSetFlags(e,t,i,s=!1){if(!this._finalized)throw"Not finalized";const o=!!(t&k.VISIBLE),n=!!(t&k.XRAYED),a=!!(t&k.HIGHLIGHTED),A=!!(t&k.SELECTED),l=!!(t&k.PICKABLE),h=!!(t&k.CULLED);let d;!o||h||n?d=U.NOT_RENDERED:i?d=U.COLOR_TRANSPARENT:d=U.COLOR_OPAQUE;let f;!o||h?f=U.NOT_RENDERED:A?f=U.SILHOUETTE_SELECTED:a?f=U.SILHOUETTE_HIGHLIGHTED:n?f=U.SILHOUETTE_XRAYED:f=U.NOT_RENDERED;let m=o&&!h&&l?U.PICK:U.NOT_RENDERED;const _=this._dataTextureState,u=this.model.scene.canvas.gl;if(Yt[0]=d,Yt[1]=f,Yt[3]=m,_.texturePerObjectColorsAndFlags._textureData.set(Yt,e*32+8),this._deferredSetFlagsActive||s){this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=Zr&&this._beginDeferredFlags(),u.bindTexture(u.TEXTURE_2D,_.texturePerObjectColorsAndFlags._texture),u.texSubImage2D(u.TEXTURE_2D,0,e%512*8+2,Math.floor(e/512),1,1,u.RGBA_INTEGER,u.UNSIGNED_BYTE,Yt)}_setDeferredFlags(){}_setFlags2(e,t,i=!1){const s=this._portionToSubPortionsMap[e];for(let o=0,n=s.length;o<n;o++)this._subPortionSetFlags2(s[o],t,i)}_subPortionSetFlags2(e,t,i=!1){if(!this._finalized)throw"Not finalized";const s=t&k.CLIPPABLE?255:0,o=this._dataTextureState,n=this.model.scene.canvas.gl;if(Yt[0]=s,Yt[1]=0,Yt[2]=1,Yt[3]=2,o.texturePerObjectColorsAndFlags._textureData.set(Yt,e*32+12),this._deferredSetFlagsActive||i){this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=Zr&&this._beginDeferredFlags(),n.bindTexture(n.TEXTURE_2D,o.texturePerObjectColorsAndFlags._texture),n.texSubImage2D(n.TEXTURE_2D,0,e%512*8+3,Math.floor(e/512),1,1,n.RGBA_INTEGER,n.UNSIGNED_BYTE,Yt)}_setDeferredFlags2(){}setOffset(e,t){const i=this._portionToSubPortionsMap[e];for(let s=0,o=i.length;s<o;s++)this._subPortionSetOffset(i[s],t)}_subPortionSetOffset(e,t){if(!this._finalized)throw"Not finalized";const i=this._dataTextureState,s=this.model.scene.canvas.gl;if(qr[0]=t[0],qr[1]=t[1],qr[2]=t[2],i.texturePerObjectOffsets._textureData.set(qr,e*3),this._deferredSetFlagsActive){this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=Zr&&this._beginDeferredFlags(),s.bindTexture(s.TEXTURE_2D,i.texturePerObjectOffsets._texture),s.texSubImage2D(s.TEXTURE_2D,0,0,e,1,1,s.RGB,s.FLOAT,qr)}setMatrix(e,t){const i=this._portionToSubPortionsMap[e];for(let s=0,o=i.length;s<o;s++)this._subPortionSetMatrix(i[s],t)}_subPortionSetMatrix(e,t){if(!this._finalized)throw"Not finalized";const i=this._dataTextureState,s=this.model.scene.canvas.gl;if(xA.set(t),i.texturePerObjectInstanceMatrices._textureData.set(xA,e*16),this._deferredSetFlagsActive){this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=Zr&&this._beginDeferredFlags(),s.bindTexture(s.TEXTURE_2D,i.texturePerObjectInstanceMatrices._texture),s.texSubImage2D(s.TEXTURE_2D,0,e%512*4,Math.floor(e/512),4,1,s.RGBA,s.FLOAT,xA)}drawColorOpaque(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,U.COLOR_OPAQUE)}drawColorTransparent(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===0||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,U.COLOR_TRANSPARENT)}drawDepth(e,t){}drawNormals(e,t){}drawSilhouetteXRayed(e,t){}drawSilhouetteHighlighted(e,t){}drawSilhouetteSelected(e,t){}drawEdgesColorOpaque(e,t){}drawEdgesColorTransparent(e,t){}drawEdgesHighlighted(e,t){}drawEdgesSelected(e,t){}drawEdgesXRayed(e,t){}drawOcclusion(e,t){}drawShadow(e,t){}setPickMatrices(e,t){}drawPickMesh(e,t){}drawPickDepths(e,t){}drawSnapInit(e,t){}drawSnap(e,t){}drawPickNormals(e,t){}destroy(){if(this._destroyed)return;const e=this._state;this.model.scene.off(this._onSceneRendering),e.destroy(),this._destroyed=!0}}const Uu=c.vec3(),xx=c.vec3(),wx=c.vec3();c.vec3();const $r=c.vec4(),bx=c.mat4();class Ou{constructor(e,t){this._scene=e,this._withSAO=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){const e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){const s=this._scene,o=s.camera,n=t.model,a=s.canvas.gl,A=t._state,l=A.textureState,h=t._state.origin,{position:d,rotationMatrix:f,rotationMatrixConjugate:m}=n;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,A)),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let _,u;const B=h[0]!==0||h[1]!==0||h[2]!==0,y=d[0]!==0||d[1]!==0||d[2]!==0;if(B||y){const v=Uu;if(B){const b=c.transformPoint3(f,h,xx);v[0]=b[0],v[1]=b[1],v[2]=b[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=d[0],v[1]+=d[1],v[2]+=d[2],_=ft(o.viewMatrix,v,bx),u=wx,u[0]=o.eye[0]-v[0],u[1]=o.eye[1]-v[1],u[2]=o.eye[2]-v[2]}else _=o.viewMatrix,u=o.eye;if(a.uniformMatrix4fv(this._uSceneModelMatrix,!1,m),a.uniformMatrix4fv(this._uViewMatrix,!1,_),a.uniformMatrix4fv(this._uProjMatrix,!1,o.projMatrix),a.uniform3fv(this._uCameraEyeRtc,u),a.uniform1i(this._uRenderPass,i),s.logarithmicDepthBufferEnabled){const v=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,v)}const x=s._sectionPlanesState.getNumAllocatedSectionPlanes(),P=s._sectionPlanesState.sectionPlanes.length;if(x>0){const v=s._sectionPlanesState.sectionPlanes,b=t.layerIndex*P,C=n.renderFlags;for(let I=0;I<x;I++){const E=this._uSectionPlanes[I];if(E)if(I<P){const S=C.sectionPlanesActivePerLayer[b+I];if(a.uniform1i(E.active,S?1:0),S){const R=v[I];if(h){const D=Ot(R.dist,R.dir,h,Uu);a.uniform3fv(E.pos,D)}else a.uniform3fv(E.pos,R.pos);a.uniform3fv(E.dir,R.dir)}}else a.uniform1i(E.active,0)}}A.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),a.drawArrays(a.TRIANGLES,0,A.numIndices8Bits)),A.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),a.drawArrays(a.TRIANGLES,0,A.numIndices16Bits)),A.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),a.drawArrays(a.TRIANGLES,0,A.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._lightsState;if(this._program=new Ft(t,this._buildShader()),this._program.errors){this.errors=this._program.errors,console.error(this.errors);return}const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uLightAmbient=s.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const o=i.lights;let n;for(let a=0,A=o.length;a<A;a++)switch(n=o[a],n.type){case"dir":this._uLightColor[a]=s.getLocation("lightColor"+a),this._uLightPos[a]=null,this._uLightDir[a]=s.getLocation("lightDir"+a);break;case"point":this._uLightColor[a]=s.getLocation("lightColor"+a),this._uLightPos[a]=s.getLocation("lightPos"+a),this._uLightDir[a]=null,this._uLightAttenuation[a]=s.getLocation("lightAttenuation"+a);break;case"spot":this._uLightColor[a]=s.getLocation("lightColor"+a),this._uLightPos[a]=s.getLocation("lightPos"+a),this._uLightDir[a]=s.getLocation("lightDir"+a),this._uLightAttenuation[a]=s.getLocation("lightAttenuation"+a);break}this._uSceneModelMatrix=s.getLocation("sceneModelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let a=0,A=e._sectionPlanesState.getNumAllocatedSectionPlanes();a<A;a++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+a),pos:s.getLocation("sectionPlanePos"+a),dir:s.getLocation("sectionPlaneDir"+a)});this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=s.getLocation("uSAOParams")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=s.getLocation("uCameraEyeRtc")}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=this._program,o=t._lightsState.lights,n=t.camera.project;s.bind(),this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,t._lightsState.getAmbientColorAndIntensity());for(let a=0,A=o.length;a<A;a++){const l=o[a];this._uLightColor[a]&&i.uniform4f(this._uLightColor[a],l.color[0],l.color[1],l.color[2],l.intensity),this._uLightPos[a]&&(i.uniform3fv(this._uLightPos[a],l.pos),this._uLightAttenuation[a]&&i.uniform1f(this._uLightAttenuation[a],l.attenuation)),this._uLightDir[a]&&i.uniform3fv(this._uLightDir[a],l.dir)}if(this._withSAO){const a=t.sao;if(a.possible){const l=i.drawingBufferWidth,h=i.drawingBufferHeight;$r[0]=l,$r[1]=h,$r[2]=a.blendCutoff,$r[3]=a.blendFactor,i.uniform4fv(this._uSAOParams,$r),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,10)}}if(t.logarithmicDepthBufferEnabled){const a=2/(Math.log(n.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,a)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState,i=e._lightsState,s=t.getNumAllocatedSectionPlanes()>0;let o;const n=[];n.push("#version 300 es"),n.push("// TrianglesDataTextureColorRenderer vertex shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("precision highp usampler2D;"),n.push("precision highp isampler2D;"),n.push("precision highp sampler2D;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("precision mediump usampler2D;"),n.push("precision mediump isampler2D;"),n.push("precision mediump sampler2D;"),n.push("#endif"),n.push("uniform int renderPass;"),n.push("uniform mat4 sceneModelMatrix;"),n.push("uniform mat4 viewMatrix;"),n.push("uniform mat4 projMatrix;"),n.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),n.push("uniform highp sampler2D uTexturePerObjectMatrix;"),n.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),n.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),n.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),n.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),n.push("uniform vec3 uCameraEyeRtc;"),n.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),n.push("out float vFragDepth;"),n.push("out float isPerspective;")),n.push("bool isPerspectiveMatrix(mat4 m) {"),n.push("    return (m[2][3] == - 1.0);"),n.push("}"),n.push("uniform vec4 lightAmbient;");for(let a=0,A=i.lights.length;a<A;a++)o=i.lights[a],o.type!=="ambient"&&(n.push("uniform vec4 lightColor"+a+";"),o.type==="dir"&&n.push("uniform vec3 lightDir"+a+";"),o.type==="point"&&n.push("uniform vec3 lightPos"+a+";"),o.type==="spot"&&(n.push("uniform vec3 lightPos"+a+";"),n.push("uniform vec3 lightDir"+a+";")));s&&(n.push("out vec4 vWorldPosition;"),n.push("flat out uint vFlags2;")),n.push("out vec4 vColor;"),n.push("void main(void) {"),n.push("int polygonIndex = gl_VertexID / 3;"),n.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),n.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),n.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),n.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),n.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),n.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),n.push("if (int(flags.x) != renderPass) {"),n.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),n.push("   return;"),n.push("} else {"),n.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),n.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),n.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),n.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),n.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),n.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),n.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),n.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),n.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),n.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),n.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),n.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),n.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),n.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),n.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),n.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),n.push("if (color.a == 0u) {"),n.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),n.push("   return;"),n.push("};"),n.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),n.push("vec3 position;"),n.push("position = positions[gl_VertexID % 3];"),n.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),n.push("if (solid != 1u) {"),n.push("if (isPerspectiveMatrix(projMatrix)) {"),n.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),n.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),n.push("position = positions[2 - (gl_VertexID % 3)];"),n.push("viewNormal = -viewNormal;"),n.push("}"),n.push("} else {"),n.push("if (viewNormal.z < 0.0) {"),n.push("position = positions[2 - (gl_VertexID % 3)];"),n.push("viewNormal = -viewNormal;"),n.push("}"),n.push("}"),n.push("}"),n.push("vec4 worldPosition = sceneModelMatrix * ((objectDecodeAndInstanceMatrix * vec4(position, 1.0))); "),n.push("vec4 viewPosition = viewMatrix * worldPosition; "),n.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),n.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),n.push("float lambertian = 1.0;");for(let a=0,A=i.lights.length;a<A;a++)if(o=i.lights[a],o.type!=="ambient"){if(o.type==="dir")o.space==="view"?n.push("viewLightDir = normalize(lightDir"+a+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+a+", 0.0)).xyz);");else if(o.type==="point")o.space==="view"?n.push("viewLightDir = -normalize(lightPos"+a+" - viewPosition.xyz);"):n.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+a+", 0.0)).xyz);");else if(o.type==="spot")o.space==="view"?n.push("viewLightDir = normalize(lightDir"+a+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+a+", 0.0)).xyz);");else continue;n.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),n.push("reflectedColor += lambertian * (lightColor"+a+".rgb * lightColor"+a+".a);")}return n.push("vec3 rgb = vec3(color.rgb) / 255.0;"),n.push("vColor =  vec4((lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedColor * rgb), float(color.a) / 255.0);"),n.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(n.push("vFragDepth = 1.0 + clipPos.w;"),n.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s&&(n.push("vWorldPosition = worldPosition;"),n.push("vFlags2 = flags2.r;")),n.push("gl_Position = clipPos;"),n.push("}"),n.push("}"),n}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// TrianglesDataTextureColorRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),this._withSAO&&(s.push("uniform sampler2D uOcclusionTexture;"),s.push("uniform vec4      uSAOParams;"),s.push("const float       packUpscale = 256. / 255.;"),s.push("const float       unpackDownScale = 255. / 256.;"),s.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),s.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),s.push("float unpackRGBToFloat( const in vec4 v ) {"),s.push("    return dot( v, unPackFactors );"),s.push("}")),i){s.push("in vec4 vWorldPosition;"),s.push("flat in uint vFlags2;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = vFlags2 > 0u;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,n=t.getNumAllocatedSectionPlanes();o<n;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { "),s.push("      discard;"),s.push("  }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),this._withSAO?(s.push("   float viewportWidth     = uSAOParams[0];"),s.push("   float viewportHeight    = uSAOParams[1];"),s.push("   float blendCutoff       = uSAOParams[2];"),s.push("   float blendFactor       = uSAOParams[3];"),s.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),s.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),s.push("   outColor            = vec4(vColor.rgb * ambient, 1.0);")):s.push("   outColor            = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Cx=new Float32Array([1,1,1]),ku=c.vec3(),Ex=c.vec3(),Ix=c.vec3();c.vec3();const Fx=c.mat4();class Nu{constructor(e,t){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=this._scene,o=s.camera,n=t.model,a=s.canvas.gl,A=t._state,l=A.textureState,h=t._state.origin,{position:d,rotationMatrix:f,rotationMatrixConjugate:m}=n,_=o.viewMatrix;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,A)),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let u,B;if(h||d[0]!==0||d[1]!==0||d[2]!==0){const P=ku;if(h){const v=Ex;c.transformPoint3(f,h,v),P[0]=v[0],P[1]=v[1],P[2]=v[2]}else P[0]=0,P[1]=0,P[2]=0;P[0]+=d[0],P[1]+=d[1],P[2]+=d[2],u=ft(_,P,Fx),B=Ix,B[0]=o.eye[0]-P[0],B[1]=o.eye[1]-P[1],B[2]=o.eye[2]-P[2]}else u=_,B=o.eye;if(a.uniform3fv(this._uCameraEyeRtc,B),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uWorldMatrix,!1,m),a.uniformMatrix4fv(this._uViewMatrix,!1,u),a.uniformMatrix4fv(this._uProjMatrix,!1,o.projMatrix),i===U.SILHOUETTE_XRAYED){const P=s.xrayMaterial._state,v=P.fillColor,b=P.fillAlpha;a.uniform4f(this._uColor,v[0],v[1],v[2],b)}else if(i===U.SILHOUETTE_HIGHLIGHTED){const P=s.highlightMaterial._state,v=P.fillColor,b=P.fillAlpha;a.uniform4f(this._uColor,v[0],v[1],v[2],b)}else if(i===U.SILHOUETTE_SELECTED){const P=s.selectedMaterial._state,v=P.fillColor,b=P.fillAlpha;a.uniform4f(this._uColor,v[0],v[1],v[2],b)}else a.uniform4fv(this._uColor,Cx);if(s.logarithmicDepthBufferEnabled){const P=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,P)}const y=s._sectionPlanesState.getNumAllocatedSectionPlanes(),x=s._sectionPlanesState.sectionPlanes.length;if(y>0){const P=s._sectionPlanesState.sectionPlanes,v=t.layerIndex*x,b=n.renderFlags;for(let C=0;C<y;C++){const I=this._uSectionPlanes[C];if(I)if(C<x){const E=b.sectionPlanesActivePerLayer[v+C];if(a.uniform1i(I.active,E?1:0),E){const S=P[C];if(h){const R=Ot(S.dist,S.dir,h,ku);a.uniform3fv(I.pos,R)}else a.uniform3fv(I.pos,S.pos);a.uniform3fv(I.dir,S.dir)}}else a.uniform1i(I.active,0)}}A.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),a.drawArrays(a.TRIANGLES,0,A.numIndices8Bits)),A.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),a.drawArrays(a.TRIANGLES,0,A.numIndices16Bits)),A.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),a.drawArrays(a.TRIANGLES,0,A.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Ft(t,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uColor=i.getLocation("color"),this._uWorldMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+s),pos:i.getLocation("sectionPlanePos"+s),dir:i.getLocation("sectionPlaneDir"+s)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=t.camera.project;if(this._program.bind(),t.logarithmicDepthBufferEnabled){const o=2/(Math.log(s.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,o)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles dataTexture silhouette vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;")),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("void main(void) {"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.y) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("if (solid != 1u) {"),i.push("if (isPerspectiveMatrix(projMatrix)) {"),i.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("viewNormal = -viewNormal;"),i.push("}"),i.push("} else {"),i.push("if (viewNormal.z < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("viewNormal = -viewNormal;"),i.push("}"),i.push("}"),i.push("}"),i.push("vec4 worldPosition = sceneModelMatrix *  (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition = viewMatrix * worldPosition; "),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2.r;")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Triangles dataTexture draw fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uint vFlags2;");for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)i.push("uniform bool sectionPlaneActive"+s+";"),i.push("uniform vec3 sectionPlanePos"+s+";"),i.push("uniform vec3 sectionPlaneDir"+s+";")}if(i.push("uniform vec4 color;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)i.push("if (sectionPlaneActive"+s+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > 0.0) { "),i.push("      discard;"),i.push("  }"),i.push("}")}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("    outColor = color;"),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Mx=new Float32Array([0,0,0,1]),Qu=c.vec3(),Sx=c.vec3();c.vec3();const Tx=c.mat4();class Dx{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,o=s.scene,n=o.camera,a=o.canvas.gl,A=t._state,l=A.textureState,h=t._state.origin,{position:d,rotationMatrix:f,rotationMatrixConjugate:m}=s,_=n.viewMatrix;if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let u;const B=h[0]!==0||h[1]!==0||h[2]!==0,y=d[0]!==0||d[1]!==0||d[2]!==0;if(B||y){const v=Qu;if(B){const b=c.transformPoint3(f,h,Sx);v[0]=b[0],v[1]=b[1],v[2]=b[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=d[0],v[1]+=d[1],v[2]+=d[2],u=ft(_,v,Tx)}else u=_;if(a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uSceneModelMatrix,!1,m),a.uniformMatrix4fv(this._uViewMatrix,!1,u),a.uniformMatrix4fv(this._uProjMatrix,!1,n.projMatrix),i===U.EDGES_XRAYED){const v=o.xrayMaterial._state,b=v.edgeColor,C=v.edgeAlpha;a.uniform4f(this._uColor,b[0],b[1],b[2],C)}else if(i===U.EDGES_HIGHLIGHTED){const v=o.highlightMaterial._state,b=v.edgeColor,C=v.edgeAlpha;a.uniform4f(this._uColor,b[0],b[1],b[2],C)}else if(i===U.EDGES_SELECTED){const v=o.selectedMaterial._state,b=v.edgeColor,C=v.edgeAlpha;a.uniform4f(this._uColor,b[0],b[1],b[2],C)}else a.uniform4fv(this._uColor,Mx);const x=o._sectionPlanesState.getNumAllocatedSectionPlanes(),P=o._sectionPlanesState.sectionPlanes.length;if(x>0){const v=o._sectionPlanesState.sectionPlanes,b=t.layerIndex*P,C=s.renderFlags;for(let I=0;I<x;I++){const E=this._uSectionPlanes[I];if(E)if(I<P){const S=C.sectionPlanesActivePerLayer[b+I];if(a.uniform1i(E.active,S?1:0),S){const R=v[I];if(h){const D=Ot(R.dist,R.dir,h,Qu);a.uniform3fv(E.pos,D)}else a.uniform3fv(E.pos,R.pos);a.uniform3fv(E.dir,R.dir)}}else a.uniform1i(E.active,0)}}A.numEdgeIndices8Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,8),a.drawArrays(a.LINES,0,A.numEdgeIndices8Bits)),A.numEdgeIndices16Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,16),a.drawArrays(a.LINES,0,A.numEdgeIndices16Bits)),A.numEdgeIndices32Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,32),a.drawArrays(a.LINES,0,A.numEdgeIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Ft(t,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uColor=i.getLocation("color"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+s),pos:i.getLocation("sectionPlanePos"+s),dir:i.getLocation("sectionPlaneDir"+s)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdEdgeIndices="uTexturePerPolygonIdEdgeIndices",this._uTexturePerEdgeIdPortionIds="uTexturePerEdgeIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix"}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=this._program,s=e.camera.project;if(i.bind(),e.logarithmicDepthBufferEnabled){const o=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,o)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// DTXTrianglesEdgesRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdEdgeIndices;"),i.push("uniform mediump usampler2D uTexturePerEdgeIdPortionIds;"),i.push("uniform vec4 color;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("int edgeIndex = gl_VertexID / 2;"),i.push("int h_packed_object_id_index = (edgeIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (edgeIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerEdgeIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedEdgeIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0));"),i.push("int edgeIndexBaseOffset = (packedEdgeIndexBaseOffset.r << 24) + (packedEdgeIndexBaseOffset.g << 16) + (packedEdgeIndexBaseOffset.b << 8) + packedEdgeIndexBaseOffset.a;"),i.push("int h_index = (edgeIndex - edgeIndexBaseOffset) & 4095;"),i.push("int v_index = (edgeIndex - edgeIndexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdEdgeIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("int indexPositionH = uniqueVertexIndexes[gl_VertexID % 2] & 4095;"),i.push("int indexPositionV = uniqueVertexIndexes[gl_VertexID % 2] >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("vec3 position = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH, indexPositionV), 0));"),i.push("mat4 matrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2.r;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(color.r, color.g, color.b, color.a);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// DTXTrianglesEdgesRenderer fragment shader"),e.logarithmicDepthBufferEnabled&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uint vFlags2;");for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)i.push("uniform bool sectionPlaneActive"+s+";"),i.push("uniform vec3 sectionPlanePos"+s+";"),i.push("uniform vec3 sectionPlaneDir"+s+";")}if(i.push("in vec4 vColor;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)i.push("if (sectionPlaneActive"+s+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > 0.0) { discard; }"),i.push("}")}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("   outColor            = vColor;"),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Hu=c.vec3(),Rx=c.vec3(),Lx=c.mat4();class Ux{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,o=s.scene,n=o.camera,a=o.canvas.gl,A=t._state,l=A.textureState,h=t._state.origin,{position:d,rotationMatrix:f,rotationMatrixConjugate:m}=s,_=n.viewMatrix;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let u;const B=h[0]!==0||h[1]!==0||h[2]!==0,y=d[0]!==0||d[1]!==0||d[2]!==0;if(B||y){const v=Hu;if(B){const b=c.transformPoint3(f,h,Rx);v[0]=b[0],v[1]=b[1],v[2]=b[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=d[0],v[1]+=d[1],v[2]+=d[2],u=ft(_,v,Lx)}else u=_;a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uSceneModelMatrix,!1,m),a.uniformMatrix4fv(this._uViewMatrix,!1,u),a.uniformMatrix4fv(this._uProjMatrix,!1,n.projMatrix);const x=o._sectionPlanesState.getNumAllocatedSectionPlanes(),P=o._sectionPlanesState.sectionPlanes.length;if(x>0){const v=o._sectionPlanesState.sectionPlanes,b=t.layerIndex*P,C=s.renderFlags;for(let I=0;I<x;I++){const E=this._uSectionPlanes[I];if(E)if(I<P){const S=C.sectionPlanesActivePerLayer[b+I];if(a.uniform1i(E.active,S?1:0),S){const R=v[I];if(h){const D=Ot(R.dist,R.dir,h,Hu);a.uniform3fv(E.pos,D)}else a.uniform3fv(E.pos,R.pos);a.uniform3fv(E.dir,R.dir)}}else a.uniform1i(E.active,0)}}A.numEdgeIndices8Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,8),a.drawArrays(a.LINES,0,A.numEdgeIndices8Bits)),A.numEdgeIndices16Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,16),a.drawArrays(a.LINES,0,A.numEdgeIndices16Bits)),A.numEdgeIndices32Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,32),a.drawArrays(a.LINES,0,A.numEdgeIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Ft(t,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+s),pos:i.getLocation("sectionPlanePos"+s),dir:i.getLocation("sectionPlaneDir"+s)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdEdgeIndices="uTexturePerPolygonIdEdgeIndices",this._uTexturePerEdgeIdPortionIds="uTexturePerEdgeIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix"}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=this._program,s=e.camera.project;if(i.bind(),e.logarithmicDepthBufferEnabled){const o=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,o)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// TrianglesDataTextureEdgesColorRenderer"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled,i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform highp sampler2D uObjectPerObjectOffsets;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdEdgeIndices;"),i.push("uniform mediump usampler2D uTexturePerEdgeIdPortionIds;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("int edgeIndex = gl_VertexID / 2;"),i.push("int h_packed_object_id_index = (edgeIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (edgeIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerEdgeIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedEdgeIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0));"),i.push("int edgeIndexBaseOffset = (packedEdgeIndexBaseOffset.r << 24) + (packedEdgeIndexBaseOffset.g << 16) + (packedEdgeIndexBaseOffset.b << 8) + packedEdgeIndexBaseOffset.a;"),i.push("int h_index = (edgeIndex - edgeIndexBaseOffset) & 4095;"),i.push("int v_index = (edgeIndex - edgeIndexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdEdgeIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("int indexPositionH = uniqueVertexIndexes[gl_VertexID % 2] & 4095;"),i.push("int indexPositionV = uniqueVertexIndexes[gl_VertexID % 2] >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("vec3 position = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH, indexPositionV), 0));"),i.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("if (color.a == 0u) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("};"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2.r;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vec4 rgb = vec4(color.rgba);"),i.push("vColor = vec4(float(rgb.r*0.5) / 255.0, float(rgb.g*0.5) / 255.0, float(rgb.b*0.5) / 255.0, float(rgb.a) / 255.0);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// TrianglesDataTextureEdgesColorRenderer"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uint vFlags2;");for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)i.push("uniform bool sectionPlaneActive"+s+";"),i.push("uniform vec3 sectionPlanePos"+s+";"),i.push("uniform vec3 sectionPlaneDir"+s+";")}if(i.push("in vec4 vColor;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)i.push("if (sectionPlaneActive"+s+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > 0.0) { discard; }"),i.push("}")}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("   outColor            = vColor;"),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Vu=c.vec3(),Ox=c.vec3(),kx=c.vec3(),Nx=c.mat4();class Gu{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e));const s=t.model,o=s.scene,n=o.camera,a=o.canvas.gl,A=t._state,l=A.textureState,h=t._state.origin,{position:d,rotationMatrix:f,rotationMatrixConjugate:m}=s;l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let _,u;const B=h[0]!==0||h[1]!==0||h[2]!==0,y=d[0]!==0||d[1]!==0||d[2]!==0;if(B||y){const v=Vu;if(B){const b=c.transformPoint3(f,h,Ox);v[0]=b[0],v[1]=b[1],v[2]=b[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=d[0],v[1]+=d[1],v[2]+=d[2],_=ft(n.viewMatrix,v,Nx),u=kx,u[0]=n.eye[0]-v[0],u[1]=n.eye[1]-v[1],u[2]=n.eye[2]-v[2]}else _=n.viewMatrix,u=n.eye;if(a.uniform2fv(this._uPickClipPos,e.pickClipPos),a.uniform2f(this._uDrawingBufferSize,a.drawingBufferWidth,a.drawingBufferHeight),a.uniformMatrix4fv(this._uSceneModelMatrix,!1,m),a.uniformMatrix4fv(this._uViewMatrix,!1,_),a.uniformMatrix4fv(this._uProjMatrix,!1,n.projMatrix),a.uniform3fv(this._uCameraEyeRtc,u),a.uniform1i(this._uRenderPass,i),o.logarithmicDepthBufferEnabled){const v=2/(Math.log(n.project.far+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,v)}const x=o._sectionPlanesState.getNumAllocatedSectionPlanes(),P=o._sectionPlanesState.sectionPlanes.length;if(x>0){const v=o._sectionPlanesState.sectionPlanes,b=t.layerIndex*P,C=s.renderFlags;for(let I=0;I<x;I++){const E=this._uSectionPlanes[I];if(E)if(I<P){const S=C.sectionPlanesActivePerLayer[b+I];if(a.uniform1i(E.active,S?1:0),S){const R=v[I];if(h){const D=Ot(R.dist,R.dir,h,Vu);a.uniform3fv(E.pos,D)}else a.uniform3fv(E.pos,R.pos);a.uniform3fv(E.dir,R.dir)}}else a.uniform1i(E.active,0)}}A.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),a.drawArrays(a.TRIANGLES,0,A.numIndices8Bits)),A.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),a.drawArrays(a.TRIANGLES,0,A.numIndices16Bits)),A.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),a.drawArrays(a.TRIANGLES,0,A.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Ft(t,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPickClipPos=i.getLocation("pickClipPos"),this._uDrawingBufferSize=i.getLocation("drawingBufferSize"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+s),pos:i.getLocation("sectionPlanePos"+s),dir:i.getLocation("sectionPlaneDir"+s)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}_bindProgram(e){const i=this._scene.canvas.gl;this._program.bind(),i.uniform1i(this._uPickInvisible,e.pickInvisible)}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry picking vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform bool pickInvisible;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;")),i.push("uniform vec2 pickClipPos;"),i.push("uniform vec2 drawingBufferSize;"),i.push("vec4 remapClipPos(vec4 clipPos) {"),i.push("    clipPos.xy /= clipPos.w;"),i.push("    clipPos.xy = (clipPos.xy - pickClipPos) * drawingBufferSize;"),i.push("    clipPos.xy *= clipPos.w;"),i.push("    return clipPos;"),i.push("}"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),t&&(i.push("smooth out vec4 vWorldPosition;"),i.push("flat out uvec4 vFlags2;")),i.push("out vec4 vPickColor;"),i.push("void main(void) {"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("vPickColor = vec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+1, objectIndexCoords.y), 0)) / 255.0;"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("if (solid != 1u) {"),i.push("if (isPerspectiveMatrix(projMatrix)) {"),i.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("}"),i.push("} else {"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("if (viewNormal.z < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("}"),i.push("}"),i.push("}"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Batched geometry picking fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uvec4 vFlags2;");for(var s=0;s<e._sectionPlanesState.getNumAllocatedSectionPlanes();s++)i.push("uniform bool sectionPlaneActive"+s+";"),i.push("uniform vec3 sectionPlanePos"+s+";"),i.push("uniform vec3 sectionPlaneDir"+s+";")}if(i.push("in vec4 vPickColor;"),i.push("out vec4 outPickColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var s=0;s<e._sectionPlanesState.getNumAllocatedSectionPlanes();s++)i.push("      if (sectionPlaneActive"+s+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("   outPickColor = vPickColor; "),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const ju=c.vec3(),Qx=c.vec3(),Hx=c.vec3();c.vec3();const Vx=c.mat4();class zu{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,o=s.scene,n=o.camera,a=o.canvas.gl,A=t._state,l=A.textureState,h=t._state.origin,{position:d,rotationMatrix:f,rotationMatrixConjugate:m}=s,_=e.pickViewMatrix||n.viewMatrix;this._program||this._allocate(),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let u,B;if(h||d[0]!==0||d[1]!==0||d[2]!==0){const P=ju;if(h){const v=Qx;c.transformPoint3(f,h,v),P[0]=v[0],P[1]=v[1],P[2]=v[2]}else P[0]=0,P[1]=0,P[2]=0;P[0]+=d[0],P[1]+=d[1],P[2]+=d[2],u=ft(_,P,Vx),B=Hx,B[0]=n.eye[0]-P[0],B[1]=n.eye[1]-P[1],B[2]=n.eye[2]-P[2],e.snapPickOrigin[0]=P[0],e.snapPickOrigin[1]=P[1],e.snapPickOrigin[2]=P[2]}else u=_,B=n.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;if(a.uniform3fv(this._uCameraEyeRtc,B),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,e.pickInvisible),a.uniform2fv(this._uPickClipPos,e.pickClipPos),a.uniform2f(this._uDrawingBufferSize,a.drawingBufferWidth,a.drawingBufferHeight),a.uniform1f(this._uPickZNear,e.pickZNear),a.uniform1f(this._uPickZFar,e.pickZFar),a.uniformMatrix4fv(this._uSceneModelMatrix,!1,m),a.uniformMatrix4fv(this._uViewMatrix,!1,u),a.uniformMatrix4fv(this._uProjMatrix,!1,n.projMatrix),o.logarithmicDepthBufferEnabled){const P=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,P)}const y=o._sectionPlanesState.getNumAllocatedSectionPlanes(),x=o._sectionPlanesState.sectionPlanes.length;if(y>0){const P=o._sectionPlanesState.sectionPlanes,v=t.layerIndex*x,b=s.renderFlags;for(let C=0;C<y;C++){const I=this._uSectionPlanes[C];if(I)if(C<x){const E=b.sectionPlanesActivePerLayer[v+C];if(a.uniform1i(I.active,E?1:0),E){const S=P[C];if(h){const R=Ot(S.dist,S.dir,h,ju);a.uniform3fv(I.pos,R)}else a.uniform3fv(I.pos,S.pos);a.uniform3fv(I.dir,S.dir)}}else a.uniform1i(I.active,0)}}A.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),a.drawArrays(a.TRIANGLES,0,A.numIndices8Bits)),A.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),a.drawArrays(a.TRIANGLES,0,A.numIndices16Bits)),A.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),a.drawArrays(a.TRIANGLES,0,A.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Ft(t,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPickClipPos=i.getLocation("pickClipPos"),this._uDrawingBufferSize=i.getLocation("drawingBufferSize"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+s),pos:i.getLocation("sectionPlanePos"+s),dir:i.getLocation("sectionPlaneDir"+s)});this._uPickZNear=i.getLocation("pickZNear"),this._uPickZFar=i.getLocation("pickZFar"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles dataTexture pick depth vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform bool pickInvisible;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;")),i.push("uniform vec2 pickClipPos;"),i.push("uniform vec2 drawingBufferSize;"),i.push("vec4 remapClipPos(vec4 clipPos) {"),i.push("    clipPos.xy /= clipPos.w;"),i.push("    clipPos.xy = (clipPos.xy - pickClipPos) * drawingBufferSize;"),i.push("    clipPos.xy *= clipPos.w;"),i.push("    return clipPos;"),i.push("}"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("out vec4 vViewPosition;"),i.push("void main(void) {"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("if (color.a == 0u) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("};"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("if (solid != 1u) {"),i.push("if (isPerspectiveMatrix(projMatrix)) {"),i.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("}"),i.push("} else {"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("if (viewNormal.z < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("}"),i.push("}"),i.push("}"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2.r;")),i.push("vViewPosition = viewPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Triangles dataTexture pick depth fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),i.push("uniform float pickZNear;"),i.push("uniform float pickZFar;"),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uint vFlags2;");for(var s=0;s<e._sectionPlanesState.getNumAllocatedSectionPlanes();s++)i.push("uniform bool sectionPlaneActive"+s+";"),i.push("uniform vec3 sectionPlanePos"+s+";"),i.push("uniform vec3 sectionPlaneDir"+s+";")}if(i.push("in vec4 vViewPosition;"),i.push("vec4 packDepth(const in float depth) {"),i.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),i.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),i.push("  vec4 res = fract(depth * bitShift);"),i.push("  res -= res.xxyz * bitMask;"),i.push("  return res;"),i.push("}"),i.push("out vec4 outPackedDepth;"),i.push("void main(void) {"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var s=0;s<e._sectionPlanesState.getNumAllocatedSectionPlanes();s++)i.push("      if (sectionPlaneActive"+s+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),i.push("    outPackedDepth = packDepth(zNormalizedDepth); "),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Ku=c.vec3(),Gx=c.vec3(),jx=c.vec3(),zx=c.vec3();c.vec3();const Kx=c.mat4();class wA{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,o=s.scene,n=o.camera,a=o.canvas.gl,A=t._state,l=A.textureState,h=t._state.origin,{position:d,rotationMatrix:f,rotationMatrixConjugate:m}=s,_=t.aabb,u=e.pickViewMatrix||n.viewMatrix,B=Ku;B[0]=c.safeInv(_[3]-_[0])*c.MAX_INT,B[1]=c.safeInv(_[4]-_[1])*c.MAX_INT,B[2]=c.safeInv(_[5]-_[2])*c.MAX_INT,e.snapPickCoordinateScale[0]=c.safeInv(B[0]),e.snapPickCoordinateScale[1]=c.safeInv(B[1]),e.snapPickCoordinateScale[2]=c.safeInv(B[2]),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let y,x;const P=h[0]!==0||h[1]!==0||h[2]!==0,v=d[0]!==0||d[1]!==0||d[2]!==0;if(P||v){const E=Gx;if(P){const S=c.transformPoint3(f,h,jx);E[0]=S[0],E[1]=S[1],E[2]=S[2]}else E[0]=0,E[1]=0,E[2]=0;E[0]+=d[0],E[1]+=d[1],E[2]+=d[2],y=ft(u,E,Kx),x=zx,x[0]=n.eye[0]-E[0],x[1]=n.eye[1]-E[1],x[2]=n.eye[2]-E[2],e.snapPickOrigin[0]=E[0],e.snapPickOrigin[1]=E[1],e.snapPickOrigin[2]=E[2]}else y=u,x=n.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;a.uniform3fv(this._uCameraEyeRtc,x),a.uniform2fv(this.uVectorA,e.snapVectorA),a.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),a.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),a.uniform3fv(this._uCoordinateScaler,B),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,e.pickInvisible),a.uniformMatrix4fv(this._uSceneModelMatrix,!1,m),a.uniformMatrix4fv(this._uViewMatrix,!1,y),a.uniformMatrix4fv(this._uProjMatrix,!1,n.projMatrix);{const E=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,E)}const b=o._sectionPlanesState.getNumAllocatedSectionPlanes(),C=o._sectionPlanesState.sectionPlanes.length;if(b>0){const E=o._sectionPlanesState.sectionPlanes,S=t.layerIndex*C,R=s.renderFlags;for(let D=0;D<b;D++){const K=this._uSectionPlanes[D];if(K)if(D<C){const j=R.sectionPlanesActivePerLayer[S+D];if(a.uniform1i(K.active,j?1:0),j){const z=E[D];if(h){const le=Ot(z.dist,z.dir,h,Ku);a.uniform3fv(K.pos,le)}else a.uniform3fv(K.pos,z.pos);a.uniform3fv(K.dir,z.dir)}}else a.uniform1i(K.active,0)}}const I=e.snapMode==="edge"?a.LINES:a.POINTS;A.numEdgeIndices8Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,8),a.drawArrays(I,0,A.numEdgeIndices8Bits)),A.numEdgeIndices16Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,16),a.drawArrays(I,0,A.numEdgeIndices16Bits)),A.numEdgeIndices32Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,32),a.drawArrays(I,0,A.numEdgeIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Ft(t,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+s),pos:i.getLocation("sectionPlanePos"+s),dir:i.getLocation("sectionPlaneDir"+s)});this._uLogDepthBufFC=i.getLocation("logDepthBufFC"),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdEdgeIndices="uTexturePerPolygonIdEdgeIndices",this._uTexturePerEdgeIdPortionIds="uTexturePerEdgeIdPortionIds",this._uTextureModelMatrices="uTextureModelMatrices",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc"),this.uVectorA=i.getLocation("uSnapVectorA"),this.uInverseVectorAB=i.getLocation("uSnapInvVectorAB"),this._uLayerNumber=i.getLocation("uLayerNumber"),this._uCoordinateScaler=i.getLocation("uCoordinateScaler")}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry edges drawing vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdEdgeIndices;"),i.push("uniform mediump usampler2D uTexturePerEdgeIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 uSnapVectorA;"),i.push("uniform vec2 uSnapInvVectorAB;"),i.push("vec3 positions[3];"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - uSnapVectorA.x) * uSnapInvVectorAB.x;"),i.push("    float y = (clipPos.y - uSnapVectorA.y) * uSnapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("out vec4 vViewPosition;"),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int edgeIndex = gl_VertexID / 2;"),i.push("int h_packed_object_id_index = (edgeIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (edgeIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerEdgeIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("{"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedEdgeIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0));"),i.push("int edgeIndexBaseOffset = (packedEdgeIndexBaseOffset.r << 24) + (packedEdgeIndexBaseOffset.g << 16) + (packedEdgeIndexBaseOffset.b << 8) + packedEdgeIndexBaseOffset.a;"),i.push("int h_index = (edgeIndex - edgeIndexBaseOffset) & 4095;"),i.push("int v_index = (edgeIndex - edgeIndexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdEdgeIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("int indexPositionH = uniqueVertexIndexes[gl_VertexID % 2] & 4095;"),i.push("int indexPositionV = uniqueVertexIndexes[gl_VertexID % 2] >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("vec3 position = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH, indexPositionV), 0));"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2.r;")),i.push("vViewPosition = viewPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vViewPosition = clipPos;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("gl_PointSize = 1.0;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Triangles dataTexture pick depth fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int uLayerNumber;"),i.push("uniform vec3 uCoordinateScaler;"),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uint vFlags2;");for(let o=0,n=e._sectionPlanesState.getNumAllocatedSectionPlanes();o<n;o++)i.push("uniform bool sectionPlaneActive"+o+";"),i.push("uniform vec3 sectionPlanePos"+o+";"),i.push("uniform vec3 sectionPlaneDir"+o+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("out highp ivec4 outCoords;"),i.push("void main(void) {"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var s=0;s<e._sectionPlanesState.getNumAllocatedSectionPlanes();s++)i.push("      if (sectionPlaneActive"+s+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz * uCoordinateScaler.xyz, uLayerNumber);"),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Wu=c.vec3(),Wx=c.vec3(),Xx=c.vec3(),Yx=c.vec3();c.vec3();const Jx=c.mat4();class Xu{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){this._program||this._allocate(),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,o=s.scene,n=o.camera,a=o.canvas.gl,A=t._state,l=A.textureState,h=t._state.origin,{position:d,rotationMatrix:f,rotationMatrixConjugate:m}=s,_=t.aabb,u=e.pickViewMatrix||n.viewMatrix,B=Wu;B[0]=c.safeInv(_[3]-_[0])*c.MAX_INT,B[1]=c.safeInv(_[4]-_[1])*c.MAX_INT,B[2]=c.safeInv(_[5]-_[2])*c.MAX_INT,e.snapPickCoordinateScale[0]=c.safeInv(B[0]),e.snapPickCoordinateScale[1]=c.safeInv(B[1]),e.snapPickCoordinateScale[2]=c.safeInv(B[2]),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let y,x;const P=h[0]!==0||h[1]!==0||h[2]!==0,v=d[0]!==0||d[1]!==0||d[2]!==0;if(P||v){const I=Wx;if(P){const E=Xx;c.transformPoint3(f,h,E),I[0]=E[0],I[1]=E[1],I[2]=E[2]}else I[0]=0,I[1]=0,I[2]=0;I[0]+=d[0],I[1]+=d[1],I[2]+=d[2],y=ft(u,I,Jx),x=Yx,x[0]=n.eye[0]-I[0],x[1]=n.eye[1]-I[1],x[2]=n.eye[2]-I[2],e.snapPickOrigin[0]=I[0],e.snapPickOrigin[1]=I[1],e.snapPickOrigin[2]=I[2]}else y=u,x=n.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;a.uniform3fv(this._uCameraEyeRtc,x),a.uniform2fv(this._uVectorA,e.snapVectorA),a.uniform2fv(this._uInverseVectorAB,e.snapInvVectorAB),a.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),a.uniform3fv(this._uCoordinateScaler,B),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,e.pickInvisible),a.uniformMatrix4fv(this._uSceneWorldModelMatrix,!1,m),a.uniformMatrix4fv(this._uViewMatrix,!1,y),a.uniformMatrix4fv(this._uProjMatrix,!1,n.projMatrix);{const I=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,I)}const b=o._sectionPlanesState.getNumAllocatedSectionPlanes(),C=o._sectionPlanesState.sectionPlanes.length;if(b>0){const I=o._sectionPlanesState.sectionPlanes,E=t.layerIndex*C,S=s.renderFlags;for(let R=0;R<b;R++){const D=this._uSectionPlanes[R];if(D)if(R<C){const K=S.sectionPlanesActivePerLayer[E+R];if(a.uniform1i(D.active,K?1:0),K){const j=I[R];if(h){const z=Ot(j.dist,j.dir,h,Wu);a.uniform3fv(D.pos,z)}else a.uniform3fv(D.pos,j.pos);a.uniform3fv(D.dir,j.dir)}}else a.uniform1i(D.active,0)}}A.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),a.drawArrays(a.TRIANGLES,0,A.numIndices8Bits)),A.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),a.drawArrays(a.TRIANGLES,0,A.numIndices16Bits)),A.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),a.drawArrays(a.TRIANGLES,0,A.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Ft(t,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uSceneWorldModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+s),pos:i.getLocation("sectionPlanePos"+s),dir:i.getLocation("sectionPlaneDir"+s)});this._uLogDepthBufFC=i.getLocation("logDepthBufFC"),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc"),this._uVectorA=i.getLocation("uVectorAB"),this._uInverseVectorAB=i.getLocation("uInverseVectorAB"),this._uLayerNumber=i.getLocation("uLayerNumber"),this._uCoordinateScaler=i.getLocation("uCoordinateScaler")}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// DTXTrianglesSnapInitRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 uVectorAB;"),i.push("uniform vec2 uInverseVectorAB;"),i.push("vec3 positions[3];"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - uVectorAB.x) * uInverseVectorAB.x;"),i.push("    float y = (clipPos.y - uVectorAB.y) * uInverseVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),i.push("flat out vec4 vPickColor;"),i.push("out vec4 vWorldPosition;"),t&&i.push("flat out uint vFlags2;"),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("{"),i.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("if (color.a == 0u) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("};"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("if (solid != 1u) {"),i.push("  if (isPerspectiveMatrix(projMatrix)) {"),i.push("      vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("      if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("          position = positions[2 - (gl_VertexID % 3)];"),i.push("          viewNormal = -viewNormal;"),i.push("      }"),i.push("  } else {"),i.push("      if (viewNormal.z < 0.0) {"),i.push("          position = positions[2 - (gl_VertexID % 3)];"),i.push("          viewNormal = -viewNormal;"),i.push("      }"),i.push("  }"),i.push("}"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vWorldPosition = worldPosition;"),t&&i.push("vFlags2 = flags2.r;"),i.push("vPickColor = vec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+1, objectIndexCoords.y), 0));"),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// DTXTrianglesSnapInitRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int uLayerNumber;"),i.push("uniform vec3 uCoordinateScaler;"),i.push("in vec4 vWorldPosition;"),i.push("flat in vec4 vPickColor;"),t){i.push("flat in uint vFlags2;");for(let o=0,n=e._sectionPlanesState.getNumAllocatedSectionPlanes();o<n;o++)i.push("uniform bool sectionPlaneActive"+o+";"),i.push("uniform vec3 sectionPlanePos"+o+";"),i.push("uniform vec3 sectionPlaneDir"+o+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("layout(location = 0) out highp ivec4 outCoords;"),i.push("layout(location = 1) out highp ivec4 outNormal;"),i.push("layout(location = 2) out lowp uvec4 outPickColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var s=0;s<e._sectionPlanesState.getNumAllocatedSectionPlanes();s++)i.push("      if (sectionPlaneActive"+s+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("    float dx = dFdx(vFragDepth);"),i.push("    float dy = dFdy(vFragDepth);"),i.push("    float diff = sqrt(dx*dx+dy*dy);"),i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz * uCoordinateScaler.xyz, - uLayerNumber);"),i.push("vec3 xTangent = dFdx( vWorldPosition.xyz );"),i.push("vec3 yTangent = dFdy( vWorldPosition.xyz );"),i.push("vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),i.push(`outNormal = ivec4(worldNormal * float(${c.MAX_INT}), 1.0);`),i.push("outPickColor = uvec4(vPickColor);"),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Yu=c.vec3(),Zx=c.vec3(),qx=c.vec3();c.vec3();const $x=c.mat4();class ew{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,o=s.scene,n=o.camera,a=o.canvas.gl,A=t._state,l=A.textureState,h=t._state.origin,{position:d,rotationMatrix:f,rotationMatrixConjugate:m}=s,_=e.pickViewMatrix||n.viewMatrix;if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let u,B;if(h||d[0]!==0||d[1]!==0||d[2]!==0){const P=Yu;if(h){const v=Zx;c.transformPoint3(f,h,v),P[0]=v[0],P[1]=v[1],P[2]=v[2]}else P[0]=0,P[1]=0,P[2]=0;P[0]+=d[0],P[1]+=d[1],P[2]+=d[2],u=ft(_,P,$x),B=qx,B[0]=n.eye[0]-P[0],B[1]=n.eye[1]-P[1],B[2]=n.eye[2]-P[2]}else u=_,B=n.eye;a.uniform3fv(this._uCameraEyeRtc,B),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uWorldMatrix,!1,m),a.uniformMatrix4fv(this._uViewMatrix,!1,u),a.uniformMatrix4fv(this._uProjMatrix,!1,n.projMatrix);const y=o._sectionPlanesState.getNumAllocatedSectionPlanes(),x=o._sectionPlanesState.sectionPlanes.length;if(y>0){const P=o._sectionPlanesState.sectionPlanes,v=t.layerIndex*x,b=s.renderFlags;for(let C=0;C<y;C++){const I=this._uSectionPlanes[C];if(I)if(C<x){const E=b.sectionPlanesActivePerLayer[v+C];if(a.uniform1i(I.active,E?1:0),E){const S=P[C];if(h){const R=Ot(S.dist,S.dir,h,Yu);a.uniform3fv(I.pos,R)}else a.uniform3fv(I.pos,S.pos);a.uniform3fv(I.dir,S.dir)}}else a.uniform1i(I.active,0)}}A.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),a.drawArrays(a.TRIANGLES,0,A.numIndices8Bits)),A.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),a.drawArrays(a.TRIANGLES,0,A.numIndices16Bits)),A.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),a.drawArrays(a.TRIANGLES,0,A.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Ft(t,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uWorldMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+s),pos:i.getLocation("sectionPlanePos"+s),dir:i.getLocation("sectionPlaneDir"+s)});this._uPickZNear=i.getLocation("pickZNear"),this._uPickZFar=i.getLocation("pickZFar"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}_bindProgram(){const e=this._scene;e.canvas.gl,e.camera.project,this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// TrianglesDataTextureOcclusionRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("vec3 positions[3];"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("void main(void) {"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("if (color.a == 0u) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("};"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("if (solid != 1u) {"),i.push("  if (isPerspectiveMatrix(projMatrix)) {"),i.push("      vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("      if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("          position = positions[2 - (gl_VertexID % 3)];"),i.push("      }"),i.push("  } else {"),i.push("      vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("      if (viewNormal.z < 0.0) {"),i.push("          position = positions[2 - (gl_VertexID % 3)];"),i.push("      }"),i.push("  }"),i.push("}"),i.push("vec4 worldPosition = sceneModelMatrix *  (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition = viewMatrix * worldPosition; "),i.push("vec4 clipPos = projMatrix * viewPosition;"),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2.r;")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// TrianglesDataTextureColorRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),i){s.push("in vec4 vWorldPosition;"),s.push("flat in uint vFlags2;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("      if (sectionPlaneActive"+o+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return s.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Ju=c.vec3(),tw=c.vec3(),iw=c.vec3();c.vec3();const sw=c.mat4();class rw{constructor(e){this._scene=e,this._allocate(),this._hash=this._getHash()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=this._scene,o=s.camera,n=t.model,a=s.canvas.gl,A=t._state,l=A.textureState,h=t._state.origin,{position:d,rotationMatrix:f,rotationMatrixConjugate:m}=n;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,A)),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let _,u;const B=h[0]!==0||h[1]!==0||h[2]!==0,y=d[0]!==0||d[1]!==0||d[2]!==0;if(B||y){const v=Ju;if(B){const b=c.transformPoint3(f,h,tw);v[0]=b[0],v[1]=b[1],v[2]=b[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=d[0],v[1]+=d[1],v[2]+=d[2],_=ft(o.viewMatrix,v,sw),u=iw,u[0]=o.eye[0]-v[0],u[1]=o.eye[1]-v[1],u[2]=o.eye[2]-v[2]}else _=o.viewMatrix,u=o.eye;if(a.uniformMatrix4fv(this._uSceneModelMatrix,!1,m),a.uniformMatrix4fv(this._uViewMatrix,!1,_),a.uniformMatrix4fv(this._uProjMatrix,!1,o.projMatrix),a.uniform3fv(this._uCameraEyeRtc,u),a.uniform1i(this._uRenderPass,i),s.logarithmicDepthBufferEnabled){const v=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,v)}const x=s._sectionPlanesState.getNumAllocatedSectionPlanes(),P=s._sectionPlanesState.sectionPlanes.length;if(x>0){const v=s._sectionPlanesState.sectionPlanes,b=t.layerIndex*P,C=n.renderFlags;for(let I=0;I<x;I++){const E=this._uSectionPlanes[I];if(E)if(I<P){const S=C.sectionPlanesActivePerLayer[b+I];if(a.uniform1i(E.active,S?1:0),S){const R=v[I];if(h){const D=Ot(R.dist,R.dir,h,Ju);a.uniform3fv(E.pos,D)}else a.uniform3fv(E.pos,R.pos);a.uniform3fv(E.dir,R.dir)}}else a.uniform1i(E.active,0)}}A.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),a.drawArrays(a.TRIANGLES,0,A.numIndices8Bits)),A.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),a.drawArrays(a.TRIANGLES,0,A.numIndices16Bits)),A.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),a.drawArrays(a.TRIANGLES,0,A.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Ft(t,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("objectDecodeAndInstanceMatrix"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+s),pos:i.getLocation("sectionPlanePos"+s),dir:i.getLocation("sectionPlaneDir"+s)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=this._program,o=t.camera.project;if(s.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),t.logarithmicDepthBufferEnabled){const n=2/(Math.log(o.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,n)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles dataTexture draw vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;")),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out highp vec2 vHighPrecisionZW;"),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("void main(void) {"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("if (color.a == 0u) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("};"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("if (solid != 1u) {"),i.push("if (isPerspectiveMatrix(projMatrix)) {"),i.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("viewNormal = -viewNormal;"),i.push("}"),i.push("} else {"),i.push("if (viewNormal.z < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("viewNormal = -viewNormal;"),i.push("}"),i.push("}"),i.push("}"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition = viewMatrix * worldPosition; "),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2.r;")),i.push("gl_Position = clipPos;"),i.push("vHighPrecisionZW = gl_Position.zw;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Triangles dataTexture draw fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in highp vec2 vHighPrecisionZW;"),i.push("out vec4 outColor;"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uint vFlags2;");for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)i.push("uniform bool sectionPlaneActive"+s+";"),i.push("uniform vec3 sectionPlanePos"+s+";"),i.push("uniform vec3 sectionPlaneDir"+s+";")}if(i.push("void main(void) {"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)i.push("if (sectionPlaneActive"+s+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > 0.0) { "),i.push("      discard;"),i.push("  }"),i.push("}")}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;"),i.push("    outColor = vec4(vec3(1.0 - fragCoordZ), 1.0); "),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Zu=c.vec3(),ow=c.vec3(),nw=c.vec3();c.vec3();const aw=c.mat4();class Aw{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,o=s.scene,n=o.camera,a=o.canvas.gl,A=t._state,l=t._state.origin,{position:h,rotationMatrix:d,rotationMatrixConjugate:f}=s,m=n.viewMatrix;if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(t));let _,u;const B=l[0]!==0||l[1]!==0||l[2]!==0,y=h[0]!==0||h[1]!==0||h[2]!==0;if(B||y){const v=Zu;if(B){const b=ow;c.transformPoint3(d,l,b),v[0]=b[0],v[1]=b[1],v[2]=b[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=h[0],v[1]+=h[1],v[2]+=h[2],_=ft(m,v,aw),u=nw,u[0]=n.eye[0]-v[0],u[1]=n.eye[1]-v[1],u[2]=n.eye[2]-v[2]}else _=m,u=n.eye;a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uWorldMatrix,!1,f),a.uniformMatrix4fv(this._uViewMatrix,!1,_),a.uniformMatrix4fv(this._uProjMatrix,!1,n.projMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,n.viewNormalMatrix),a.uniformMatrix4fv(this._uWorldNormalMatrix,!1,s.worldNormalMatrix);const x=o._sectionPlanesState.getNumAllocatedSectionPlanes(),P=o._sectionPlanesState.sectionPlanes.length;if(x>0){const v=o._sectionPlanesState.sectionPlanes,b=t.layerIndex*P,C=s.renderFlags;for(let I=0;I<x;I++){const E=this._uSectionPlanes[I];if(E)if(I<P){const S=C.sectionPlanesActivePerLayer[b+I];if(a.uniform1i(E.active,S?1:0),S){const R=v[I];if(l){const D=Ot(R.dist,R.dir,l,Zu);a.uniform3fv(E.pos,D)}else a.uniform3fv(E.pos,R.pos);a.uniform3fv(E.dir,R.dir)}}else a.uniform1i(E.active,0)}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.objectDecodeAndInstanceMatrix),this._aPosition.bindArrayBuffer(A.positionsBuf),this._aOffset.bindArrayBuffer(A.offsetsBuf),this._aNormal.bindArrayBuffer(A.normalsBuf),this._aColor.bindArrayBuffer(A.colorsBuf),this._aFlags.bindArrayBuffer(A.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(A.flags2Buf),A.indicesBuf.bind(),a.drawElements(a.TRIANGLES,A.indicesBuf.numItems,A.indicesBuf.itemType,0)}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Ft(t,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("objectDecodeAndInstanceMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uWorldNormalMatrix=i.getLocation("worldNormalMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uViewNormalMatrix=i.getLocation("viewNormalMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+s),pos:i.getLocation("sectionPlanePos"+s),dir:i.getLocation("sectionPlaneDir"+s)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aNormal=i.getAttribute("normal"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2&&(this._aFlags2=i.getAttribute("flags2")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const s=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,s)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("// Batched geometry normals vertex shader"),e.logarithmicDepthBufferEnabled&&_t.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec3 normal;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 worldNormalMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 viewNormalMatrix;"),i.push("uniform mat4 objectDecodeAndInstanceMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),_t.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec3 vViewNormal;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition   = viewMatrix * worldPosition; "),i.push("      vec4 worldNormal    = worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),i.push("      vec3 viewNormal     = normalize((viewNormalMatrix * worldNormal).xyz);"),t&&(i.push("      vWorldPosition  = worldPosition;"),i.push("      vFlags2         = flags2;")),i.push("      vViewNormal = viewNormal;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(_t.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Batched geometry normals fragment shader"),e.logarithmicDepthBufferEnabled&&_t.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&_t.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),t){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let o=0;o<e._sectionPlanesState.getNumAllocatedSectionPlanes();o++)i.push("uniform bool sectionPlaneActive"+o+";"),i.push("uniform vec3 sectionPlanePos"+o+";"),i.push("uniform vec3 sectionPlaneDir"+o+";")}if(i.push("in vec3 vViewNormal;"),i.push("vec3 packNormalToRGB( const in vec3 normal ) {"),i.push("    return normalize( normal ) * 0.5 + 0.5;"),i.push("}"),i.push("void main(void) {"),t){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var s=0;s<e._sectionPlanesState.getNumAllocatedSectionPlanes();s++)i.push("      if (sectionPlaneActive"+s+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return e.logarithmicDepthBufferEnabled&&_t.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("    gl_FragColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const qu=c.vec3(),lw=c.vec3(),cw=c.vec3();c.vec3();c.vec4();const hw=c.mat4();class bA{constructor(e,t){this._scene=e,this._withSAO=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){const e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){const s=this._scene,o=s.camera,n=t.model,a=s.canvas.gl,A=t._state,l=A.textureState,h=t._state.origin,{position:d,rotationMatrix:f,rotationMatrixConjugate:m}=n;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,A)),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let _,u;const B=h[0]!==0||h[1]!==0||h[2]!==0,y=d[0]!==0||d[1]!==0||d[2]!==0;if(B||y){const v=qu;if(B){const b=c.transformPoint3(f,h,lw);v[0]=b[0],v[1]=b[1],v[2]=b[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=d[0],v[1]+=d[1],v[2]+=d[2],_=ft(o.viewMatrix,v,hw),u=cw,u[0]=o.eye[0]-v[0],u[1]=o.eye[1]-v[1],u[2]=o.eye[2]-v[2]}else _=o.viewMatrix,u=o.eye;if(a.uniform2fv(this._uPickClipPos,e.pickClipPos),a.uniform2f(this._uDrawingBufferSize,a.drawingBufferWidth,a.drawingBufferHeight),a.uniformMatrix4fv(this._uSceneModelMatrix,!1,m),a.uniformMatrix4fv(this._uViewMatrix,!1,_),a.uniformMatrix4fv(this._uProjMatrix,!1,o.projMatrix),a.uniform3fv(this._uCameraEyeRtc,u),a.uniform1i(this._uRenderPass,i),s.logarithmicDepthBufferEnabled){const v=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,v)}const x=s._sectionPlanesState.getNumAllocatedSectionPlanes(),P=s._sectionPlanesState.sectionPlanes.length;if(x>0){const v=s._sectionPlanesState.sectionPlanes,b=t.layerIndex*P,C=n.renderFlags;for(let I=0;I<x;I++){const E=this._uSectionPlanes[I];if(E)if(I<P){const S=C.sectionPlanesActivePerLayer[b+I];if(a.uniform1i(E.active,S?1:0),S){const R=v[I];if(h){const D=Ot(R.dist,R.dir,h,qu);a.uniform3fv(E.pos,D)}else a.uniform3fv(E.pos,R.pos);a.uniform3fv(E.dir,R.dir)}}else a.uniform1i(E.active,0)}}A.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),a.drawArrays(a.TRIANGLES,0,A.numIndices8Bits)),A.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),a.drawArrays(a.TRIANGLES,0,A.numIndices16Bits)),A.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),a.drawArrays(a.TRIANGLES,0,A.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Ft(t,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPickClipPos=i.getLocation("pickClipPos"),this._uDrawingBufferSize=i.getLocation("drawingBufferSize"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+s),pos:i.getLocation("sectionPlanePos"+s),dir:i.getLocation("sectionPlaneDir"+s)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=this._program,o=t.camera.project;if(s.bind(),t.logarithmicDepthBufferEnabled){const n=2/(Math.log(o.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,n)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// trianglesDatatextureNormalsRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;")),i.push("uniform vec2 pickClipPos;"),i.push("uniform vec2 drawingBufferSize;"),i.push("vec4 remapClipPos(vec4 clipPos) {"),i.push("    clipPos.xy /= clipPos.w;"),i.push("    clipPos.xy = (clipPos.xy - pickClipPos) * drawingBufferSize;"),i.push("    clipPos.xy *= clipPos.w;"),i.push("    return clipPos;"),i.push("}"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out vec4 vWorldPosition;"),t&&i.push("flat out uint vFlags2;"),i.push("void main(void) {"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("if (color.a == 0u) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("};"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("if (solid != 1u) {"),i.push("if (isPerspectiveMatrix(projMatrix)) {"),i.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("viewNormal = -viewNormal;"),i.push("}"),i.push("} else {"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("if (viewNormal.z < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("}"),i.push("}"),i.push("}"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition = viewMatrix * worldPosition; "),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("vWorldPosition = worldPosition;"),t&&i.push("vFlags2 = flags2.r;"),i.push("gl_Position = remapClipPos(clipPos);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// TrianglesDataTexturePickNormalsRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),i.push("in vec4 vWorldPosition;"),t){i.push("flat in uint vFlags2;");for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)i.push("uniform bool sectionPlaneActive"+s+";"),i.push("uniform vec3 sectionPlanePos"+s+";"),i.push("uniform vec3 sectionPlaneDir"+s+";")}if(i.push("out highp ivec4 outNormal;"),i.push("void main(void) {"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)i.push("if (sectionPlaneActive"+s+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > 0.0) { "),i.push("      discard;"),i.push("  }"),i.push("}")}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("  vec3 xTangent = dFdx( vWorldPosition.xyz );"),i.push("  vec3 yTangent = dFdy( vWorldPosition.xyz );"),i.push("  vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),i.push(`  outNormal = ivec4(worldNormal * float(${c.MAX_INT}), 1.0);`),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class uw{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._colorRendererWithSAO&&!this._colorRendererWithSAO.getValid()&&(this._colorRendererWithSAO.destroy(),this._colorRendererWithSAO=null),this._flatColorRenderer&&!this._flatColorRenderer.getValid()&&(this._flatColorRenderer.destroy(),this._flatColorRenderer=null),this._flatColorRendererWithSAO&&!this._flatColorRendererWithSAO.getValid()&&(this._flatColorRendererWithSAO.destroy(),this._flatColorRendererWithSAO=null),this._colorQualityRendererWithSAO&&!this._colorQualityRendererWithSAO.getValid()&&(this._colorQualityRendererWithSAO.destroy(),this._colorQualityRendererWithSAO=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._normalsRenderer&&!this._normalsRenderer.getValid()&&(this._normalsRenderer.destroy(),this._normalsRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._edgesRenderer&&!this._edgesRenderer.getValid()&&(this._edgesRenderer.destroy(),this._edgesRenderer=null),this._edgesColorRenderer&&!this._edgesColorRenderer.getValid()&&(this._edgesColorRenderer.destroy(),this._edgesColorRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._pickNormalsRenderer&&this._pickNormalsRenderer.getValid()===!1&&(this._pickNormalsRenderer.destroy(),this._pickNormalsRenderer=null),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.getValid()===!1&&(this._pickNormalsFlatRenderer.destroy(),this._pickNormalsFlatRenderer=null),this._occlusionRenderer&&this._occlusionRenderer.getValid()===!1&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null)}eagerCreateRenders(){this._silhouetteRenderer||(this._silhouetteRenderer=new Nu(this._scene)),this._pickMeshRenderer||(this._pickMeshRenderer=new Gu(this._scene)),this._pickDepthRenderer||(this._pickDepthRenderer=new zu(this._scene)),this._pickNormalsRenderer||(this._pickNormalsRenderer=new bA(this._scene)),this._snapRenderer||(this._snapRenderer=new wA(this._scene)),this._snapInitRenderer||(this._snapInitRenderer=new Xu(this._scene)),this._snapRenderer||(this._snapRenderer=new wA(this._scene))}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new Ou(this._scene,!1)),this._colorRenderer}get colorRendererWithSAO(){return this._colorRendererWithSAO||(this._colorRendererWithSAO=new Ou(this._scene,!0)),this._colorRendererWithSAO}get colorQualityRendererWithSAO(){return this._colorQualityRendererWithSAO}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Nu(this._scene)),this._silhouetteRenderer}get depthRenderer(){return this._depthRenderer||(this._depthRenderer=new rw(this._scene)),this._depthRenderer}get normalsRenderer(){return this._normalsRenderer||(this._normalsRenderer=new Aw(this._scene)),this._normalsRenderer}get edgesRenderer(){return this._edgesRenderer||(this._edgesRenderer=new Dx(this._scene)),this._edgesRenderer}get edgesColorRenderer(){return this._edgesColorRenderer||(this._edgesColorRenderer=new Ux(this._scene)),this._edgesColorRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new Gu(this._scene)),this._pickMeshRenderer}get pickNormalsRenderer(){return this._pickNormalsRenderer||(this._pickNormalsRenderer=new bA(this._scene)),this._pickNormalsRenderer}get pickNormalsFlatRenderer(){return this._pickNormalsFlatRenderer||(this._pickNormalsFlatRenderer=new bA(this._scene)),this._pickNormalsFlatRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new zu(this._scene)),this._pickDepthRenderer}get snapRenderer(){return this._snapRenderer||(this._snapRenderer=new wA(this._scene)),this._snapRenderer}get snapInitRenderer(){return this._snapInitRenderer||(this._snapInitRenderer=new Xu(this._scene)),this._snapInitRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new ew(this._scene)),this._occlusionRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._colorRendererWithSAO&&this._colorRendererWithSAO.destroy(),this._flatColorRenderer&&this._flatColorRenderer.destroy(),this._flatColorRendererWithSAO&&this._flatColorRendererWithSAO.destroy(),this._colorQualityRendererWithSAO&&this._colorQualityRendererWithSAO.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._normalsRenderer&&this._normalsRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._edgesRenderer&&this._edgesRenderer.destroy(),this._edgesColorRenderer&&this._edgesColorRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._pickNormalsRenderer&&this._pickNormalsRenderer.destroy(),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy()}}const CA={};function dw(r){const e=r.id;let t=CA[e];return t||(t=new uw(r),CA[e]=t,t._compile(),t.eagerCreateRenders(),r.on("compile",()=>{t._compile(),t.eagerCreateRenders()}),r.on("destroyed",()=>{delete CA[e],t._destroy()})),t}class pw{constructor(){this.positionsCompressed=[],this.lenPositionsCompressed=0,this.metallicRoughness=[],this.indices8Bits=[],this.lenIndices8Bits=0,this.indices16Bits=[],this.lenIndices16Bits=0,this.indices32Bits=[],this.lenIndices32Bits=0,this.edgeIndices8Bits=[],this.lenEdgeIndices8Bits=0,this.edgeIndices16Bits=[],this.lenEdgeIndices16Bits=0,this.edgeIndices32Bits=[],this.lenEdgeIndices32Bits=0,this.perObjectColors=[],this.perObjectPickColors=[],this.perObjectSolid=[],this.perObjectOffsets=[],this.perObjectPositionsDecodeMatrices=[],this.perObjectInstancePositioningMatrices=[],this.perObjectVertexBases=[],this.perObjectIndexBaseOffsets=[],this.perObjectEdgeIndexBaseOffsets=[],this.perTriangleNumberPortionId8Bits=[],this.perTriangleNumberPortionId16Bits=[],this.perTriangleNumberPortionId32Bits=[],this.perEdgeNumberPortionId8Bits=[],this.perEdgeNumberPortionId16Bits=[],this.perEdgeNumberPortionId32Bits=[]}}class fw{constructor(){this.texturePerObjectColorsAndFlags=null,this.texturePerObjectOffsets=null,this.texturePerObjectInstanceMatrices=null,this.texturePerObjectPositionsDecodeMatrix=null,this.texturePerVertexIdCoordinates=null,this.texturePerPolygonIdPortionIds8Bits=null,this.texturePerPolygonIdPortionIds16Bits=null,this.texturePerPolygonIdPortionIds32Bits=null,this.texturePerEdgeIdPortionIds8Bits=null,this.texturePerEdgeIdPortionIds16Bits=null,this.texturePerEdgeIdPortionIds32Bits=null,this.texturePerPolygonIdIndices8Bits=null,this.texturePerPolygonIdIndices16Bits=null,this.texturePerPolygonIdIndices32Bits=null,this.texturePerPolygonIdEdgeIndices8Bits=null,this.texturePerPolygonIdEdgeIndices16Bits=null,this.texturePerPolygonIdEdgeIndices32Bits=null,this.textureModelMatrices=null}finalize(){this.indicesPerBitnessTextures={8:this.texturePerPolygonIdIndices8Bits,16:this.texturePerPolygonIdIndices16Bits,32:this.texturePerPolygonIdIndices32Bits},this.indicesPortionIdsPerBitnessTextures={8:this.texturePerPolygonIdPortionIds8Bits,16:this.texturePerPolygonIdPortionIds16Bits,32:this.texturePerPolygonIdPortionIds32Bits},this.edgeIndicesPerBitnessTextures={8:this.texturePerPolygonIdEdgeIndices8Bits,16:this.texturePerPolygonIdEdgeIndices16Bits,32:this.texturePerPolygonIdEdgeIndices32Bits},this.edgeIndicesPortionIdsPerBitnessTextures={8:this.texturePerEdgeIdPortionIds8Bits,16:this.texturePerEdgeIdPortionIds16Bits,32:this.texturePerEdgeIdPortionIds32Bits}}bindCommonTextures(e,t,i,s,o){this.texturePerObjectPositionsDecodeMatrix.bindTexture(e,t,1),this.texturePerVertexIdCoordinates.bindTexture(e,i,2),this.texturePerObjectColorsAndFlags.bindTexture(e,s,3),this.texturePerObjectInstanceMatrices.bindTexture(e,o,4)}bindTriangleIndicesTextures(e,t,i,s){this.indicesPortionIdsPerBitnessTextures[s].bindTexture(e,t,5),this.indicesPerBitnessTextures[s].bindTexture(e,i,6)}bindEdgeIndicesTextures(e,t,i,s){this.edgeIndicesPortionIdsPerBitnessTextures[s].bindTexture(e,t,5),this.edgeIndicesPerBitnessTextures[s].bindTexture(e,i,6)}}const tt={sizeDataColorsAndFlags:0,sizeDataPositionDecodeMatrices:0,sizeDataTextureOffsets:0,sizeDataTexturePositions:0,sizeDataTextureIndices:0,sizeDataTextureEdgeIndices:0,sizeDataTexturePortionIds:0,numberOfGeometries:0,numberOfPortions:0,numberOfLayers:0,numberOfTextures:0,totalPolygons:0,totalPolygons8Bits:0,totalPolygons16Bits:0,totalPolygons32Bits:0,totalEdges:0,totalEdges8Bits:0,totalEdges16Bits:0,totalEdges32Bits:0,cannotCreatePortion:{because10BitsObjectId:0,becauseTextureSize:0},overheadSizeAlignementIndices:0,overheadSizeAlignementEdgeIndices:0};window.printDataTextureRamStats=function(){console.log(JSON.stringify(tt,null,4));let r=0;Object.keys(tt).forEach(t=>{t.startsWith("size")&&(r+=tt[t])}),console.log(`Total size ${r} bytes (${(r/1e3/1e3).toFixed(2)} MB)`),console.log(`Avg bytes / triangle: ${(r/tt.totalPolygons).toFixed(2)}`);let e={};Object.keys(tt).forEach(t=>{t.startsWith("size")&&(e[t]=`${(tt[t]/r*100).toFixed(2)} % of total`)}),console.log(JSON.stringify({percentualRamUsage:e},null,4))};class gw{constructor(){}disableBindedTextureFiltering(e){e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)}createTextureForColorsAndFlags(e,t,i,s,o,n,a){const A=t.length;this.numPortions=A;const l=512*8,h=Math.ceil(A/(l/8));if(h===0)throw"texture height===0";const d=new Uint8Array(4*l*h);tt.sizeDataColorsAndFlags+=d.byteLength,tt.numberOfTextures++;for(let m=0;m<A;m++)d.set(t[m],m*32+0),d.set(i[m],m*32+4),d.set([0,0,0,0],m*32+8),d.set([0,0,0,0],m*32+12),d.set([s[m]>>24&255,s[m]>>16&255,s[m]>>8&255,s[m]&255],m*32+16),d.set([o[m]>>24&255,o[m]>>16&255,o[m]>>8&255,o[m]&255],m*32+20),d.set([n[m]>>24&255,n[m]>>16&255,n[m]>>8&255,n[m]&255],m*32+24),d.set([a[m]?1:0,0,0,0],m*32+28);const f=e.createTexture();return e.bindTexture(e.TEXTURE_2D,f),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA8UI,l,h),e.texSubImage2D(e.TEXTURE_2D,0,0,0,l,h,e.RGBA_INTEGER,e.UNSIGNED_BYTE,d,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Ut(e,f,l,h,d)}createTextureForObjectOffsets(e,t){const s=Math.ceil(t/512);if(s===0)throw"texture height===0";const o=new Float32Array(3*512*s).fill(0);tt.sizeDataTextureOffsets+=o.byteLength,tt.numberOfTextures++;const n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RGB32F,512,s),e.texSubImage2D(e.TEXTURE_2D,0,0,0,512,s,e.RGB,e.FLOAT,o,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Ut(e,n,512,s,o)}createTextureForInstancingMatrices(e,t){const i=t.length;if(i===0)throw"num instance matrices===0";const s=512*4,o=Math.ceil(i/(s/4)),n=new Float32Array(4*s*o);tt.numberOfTextures++;for(let A=0;A<t.length;A++)n.set(t[A],A*16);const a=e.createTexture();return e.bindTexture(e.TEXTURE_2D,a),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA32F,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RGBA,e.FLOAT,n,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Ut(e,a,s,o,n)}createTextureForPositionsDecodeMatrices(e,t){const i=t.length;if(i===0)throw"num decode+entity matrices===0";const s=512*4,o=Math.ceil(i/(s/4)),n=new Float32Array(4*s*o);tt.sizeDataPositionDecodeMatrices+=n.byteLength,tt.numberOfTextures++;for(let A=0;A<t.length;A++)n.set(t[A],A*16);const a=e.createTexture();return e.bindTexture(e.TEXTURE_2D,a),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA32F,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RGBA,e.FLOAT,n,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Ut(e,a,s,o)}createTextureFor8BitIndices(e,t,i){if(i===0)return{texture:null,textureHeight:0};const s=4096,o=Math.ceil(i/3/s);if(o===0)throw"texture height===0";const n=s*o*3,a=new Uint8Array(n);tt.sizeDataTextureIndices+=a.byteLength,tt.numberOfTextures++;for(let l=0,h=0,d=t.length;l<d;l++){const f=t[l];a.set(f,h),h+=f.length}const A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.RGB8UI,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RGB_INTEGER,e.UNSIGNED_BYTE,a,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Ut(e,A,s,o)}createTextureFor16BitIndices(e,t,i){if(i===0)return{texture:null,textureHeight:0};const s=4096,o=Math.ceil(i/3/s);if(o===0)throw"texture height===0";const n=s*o*3,a=new Uint16Array(n);tt.sizeDataTextureIndices+=a.byteLength,tt.numberOfTextures++;for(let l=0,h=0,d=t.length;l<d;l++){const f=t[l];a.set(f,h),h+=f.length}const A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.RGB16UI,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RGB_INTEGER,e.UNSIGNED_SHORT,a,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Ut(e,A,s,o)}createTextureFor32BitIndices(e,t,i){if(i===0)return{texture:null,textureHeight:0};const s=4096,o=Math.ceil(i/3/s);if(o===0)throw"texture height===0";const n=s*o*3,a=new Uint32Array(n);tt.sizeDataTextureIndices+=a.byteLength,tt.numberOfTextures++;for(let l=0,h=0,d=t.length;l<d;l++){const f=t[l];a.set(f,h),h+=f.length}const A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.RGB32UI,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RGB_INTEGER,e.UNSIGNED_INT,a,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Ut(e,A,s,o)}createTextureFor8BitsEdgeIndices(e,t,i){if(i===0)return{texture:null,textureHeight:0};const s=4096,o=Math.ceil(i/2/s);if(o===0)throw"texture height===0";const n=s*o*2,a=new Uint8Array(n);tt.sizeDataTextureEdgeIndices+=a.byteLength,tt.numberOfTextures++;for(let l=0,h=0,d=t.length;l<d;l++){const f=t[l];a.set(f,h),h+=f.length}const A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.RG8UI,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RG_INTEGER,e.UNSIGNED_BYTE,a,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Ut(e,A,s,o)}createTextureFor16BitsEdgeIndices(e,t,i){if(i===0)return{texture:null,textureHeight:0};const s=4096,o=Math.ceil(i/2/s);if(o===0)throw"texture height===0";const n=s*o*2,a=new Uint16Array(n);tt.sizeDataTextureEdgeIndices+=a.byteLength,tt.numberOfTextures++;for(let l=0,h=0,d=t.length;l<d;l++){const f=t[l];a.set(f,h),h+=f.length}const A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.RG16UI,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RG_INTEGER,e.UNSIGNED_SHORT,a,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Ut(e,A,s,o)}createTextureFor32BitsEdgeIndices(e,t,i){if(i===0)return{texture:null,textureHeight:0};const s=4096,o=Math.ceil(i/2/s);if(o===0)throw"texture height===0";const n=s*o*2,a=new Uint32Array(n);tt.sizeDataTextureEdgeIndices+=a.byteLength,tt.numberOfTextures++;for(let l=0,h=0,d=t.length;l<d;l++){const f=t[l];a.set(f,h),h+=f.length}const A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.RG32UI,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RG_INTEGER,e.UNSIGNED_INT,a,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Ut(e,A,s,o)}createTextureForPositions(e,t,i){const s=i/3,o=4096,n=Math.ceil(s/o);if(n===0)throw"texture height===0";const a=o*n*3,A=new Uint16Array(a);tt.sizeDataTexturePositions+=A.byteLength,tt.numberOfTextures++;for(let h=0,d=0,f=t.length;h<f;h++){const m=t[h];A.set(m,d),d+=m.length}const l=e.createTexture();return e.bindTexture(e.TEXTURE_2D,l),e.texStorage2D(e.TEXTURE_2D,1,e.RGB16UI,o,n),e.texSubImage2D(e.TEXTURE_2D,0,0,0,o,n,e.RGB_INTEGER,e.UNSIGNED_SHORT,A,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Ut(e,l,o,n)}createTextureForPackedPortionIds(e,t){if(t.length===0)return{texture:null,textureHeight:0};const i=t.length,s=4096,o=Math.ceil(i/s);if(o===0)throw"texture height===0";const n=s*o,a=new Uint16Array(n);a.set(t,0),tt.sizeDataTexturePortionIds+=a.byteLength,tt.numberOfTextures++;const A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.R16UI,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RED_INTEGER,e.UNSIGNED_SHORT,a,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Ut(e,A,s,o)}}const mw=new yc,$u=65536,Bn=mw.maxDataTextureHeight,Ys=8,eo=10,EA=new Float32Array(16),Gt=new Uint8Array(4),to=new Float32Array(3);let _w=0;const vw=c.identityMat4();class Bw{constructor(e,t){console.info("Creating DTXTrianglesLayer"),tt.numberOfLayers++,this._layerNumber=_w++,this.sortId=`TriDTX-${this._layerNumber}`,this.layerIndex=t.layerIndex,this._renderers=dw(e.scene),this.model=e,this._buffer=new pw,this._dtxState=new fw,this._dtxTextureFactory=new gw,this._state=new Mt({origin:c.vec3(t.origin),metallicRoughnessBuf:null,textureState:this._dtxState,numIndices8Bits:0,numIndices16Bits:0,numIndices32Bits:0,numEdgeIndices8Bits:0,numEdgeIndices16Bits:0,numEdgeIndices32Bits:0,numVertices:0}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._subPortions=[],this._portionToSubPortionsMap=[],this._bucketGeometries={},this._meshes=[],this._aabb=c.collapseAABB3(),this.aabbDirty=!0,this._numUpdatesInFrame=0,this._finalized=!1}get aabb(){if(this.aabbDirty){c.collapseAABB3(this._aabb);for(let e=0,t=this._meshes.length;e<t;e++)c.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}canCreatePortion(e){if(this._finalized)throw"Already finalized";const t=e.buckets.length;this._numPortions+t>$u&&tt.cannotCreatePortion.because10BitsObjectId++;let i=this._numPortions+t<=$u;const s=0,o=e.geometryId!==void 0&&e.geometryId!==null?`${e.geometryId}#${s}`:`${e.id}#${s}`;if(!this._bucketGeometries[o]){const a=Math.max(this._state.numIndices8Bits,this._state.numIndices16Bits,this._state.numIndices32Bits);let A=0,l=0;e.buckets.forEach(h=>{A+=h.positionsCompressed.length/3,l+=h.indices.length/3}),(this._state.numVertices+A>Bn*4096||a+l>Bn*4096)&&tt.cannotCreatePortion.becauseTextureSize++,i&&(i=this._state.numVertices+A<=Bn*4096&&a+l<=Bn*4096)}return i}createPortion(e,t){if(this._finalized)throw"Already finalized";const i=[];t.buckets.forEach((o,n)=>{const a=t.geometryId!==void 0&&t.geometryId!==null?`${t.geometryId}#${n}`:`${t.id}#${n}`;let A=this._bucketGeometries[a];A||(A=this._createBucketGeometry(t,o),this._bucketGeometries[a]=A);const l=this._createSubPortion(t,A,o);i.push(l)});const s=this._portionToSubPortionsMap.length;return this._portionToSubPortionsMap.push(i),this.model.numPortions++,this._meshes.push(e),s}_createBucketGeometry(e,t){if(t.indices){const _=Math.ceil(t.indices.length/3/Ys)*Ys*3;tt.overheadSizeAlignementIndices+=2*(_-t.indices.length);const u=new Uint32Array(_);u.fill(0),u.set(t.indices),t.indices=u}if(t.edgeIndices){const _=Math.ceil(t.edgeIndices.length/2/Ys)*Ys*2;tt.overheadSizeAlignementEdgeIndices+=2*(_-t.edgeIndices.length);const u=new Uint32Array(_);u.fill(0),u.set(t.edgeIndices),t.edgeIndices=u}const i=t.positionsCompressed,s=t.indices,o=t.edgeIndices,n=this._buffer;n.positionsCompressed.push(i);const a=n.lenPositionsCompressed/3,A=i.length/3;n.lenPositionsCompressed+=i.length;let l,h=0;if(s){h=s.length/3;let _;A<=256?(_=n.indices8Bits,l=n.lenIndices8Bits/3,n.lenIndices8Bits+=s.length):A<=65536?(_=n.indices16Bits,l=n.lenIndices16Bits/3,n.lenIndices16Bits+=s.length):(_=n.indices32Bits,l=n.lenIndices32Bits/3,n.lenIndices32Bits+=s.length),_.push(s)}let d,f=0;if(o){f=o.length/2;let _;A<=256?(_=n.edgeIndices8Bits,d=n.lenEdgeIndices8Bits/2,n.lenEdgeIndices8Bits+=o.length):A<=65536?(_=n.edgeIndices16Bits,d=n.lenEdgeIndices16Bits/2,n.lenEdgeIndices16Bits+=o.length):(_=n.edgeIndices32Bits,d=n.lenEdgeIndices32Bits/2,n.lenEdgeIndices32Bits+=o.length),_.push(o)}return this._state.numVertices+=A,tt.numberOfGeometries++,{vertexBase:a,numVertices:A,numTriangles:h,numEdges:f,indicesBase:l,edgeIndicesBase:d}}_createSubPortion(e,t,i,s){const o=e.color;e.metallic,e.roughness;const n=e.colors,a=e.opacity,A=e.meshMatrix,l=e.pickColor,h=this._buffer,d=this._state;h.perObjectPositionsDecodeMatrices.push(e.positionsDecodeMatrix),h.perObjectInstancePositioningMatrices.push(A||vw),h.perObjectSolid.push(!!e.solid),n?h.perObjectColors.push([n[0]*255,n[1]*255,n[2]*255,255]):o&&h.perObjectColors.push([o[0],o[1],o[2],a]),h.perObjectPickColors.push(l),h.perObjectVertexBases.push(t.vertexBase);{let m;t.numVertices<=256?m=d.numIndices8Bits:t.numVertices<=65536?m=d.numIndices16Bits:m=d.numIndices32Bits,h.perObjectIndexBaseOffsets.push(m/3-t.indicesBase)}{let m;t.numVertices<=256?m=d.numEdgeIndices8Bits:t.numVertices<=65536?m=d.numEdgeIndices16Bits:m=d.numEdgeIndices32Bits,h.perObjectEdgeIndexBaseOffsets.push(m/2-t.edgeIndicesBase)}const f=this._subPortions.length;if(t.numTriangles>0){let m=t.numTriangles*3,_;t.numVertices<=256?(_=h.perTriangleNumberPortionId8Bits,d.numIndices8Bits+=m,tt.totalPolygons8Bits+=t.numTriangles):t.numVertices<=65536?(_=h.perTriangleNumberPortionId16Bits,d.numIndices16Bits+=m,tt.totalPolygons16Bits+=t.numTriangles):(_=h.perTriangleNumberPortionId32Bits,d.numIndices32Bits+=m,tt.totalPolygons32Bits+=t.numTriangles),tt.totalPolygons+=t.numTriangles;for(let u=0;u<t.numTriangles;u+=Ys)_.push(f)}if(t.numEdges>0){let m=t.numEdges*2,_;t.numVertices<=256?(_=h.perEdgeNumberPortionId8Bits,d.numEdgeIndices8Bits+=m,tt.totalEdges8Bits+=t.numEdges):t.numVertices<=65536?(_=h.perEdgeNumberPortionId16Bits,d.numEdgeIndices16Bits+=m,tt.totalEdges16Bits+=t.numEdges):(_=h.perEdgeNumberPortionId32Bits,d.numEdgeIndices32Bits+=m,tt.totalEdges32Bits+=t.numEdges),tt.totalEdges+=t.numEdges;for(let u=0;u<t.numEdges;u+=Ys)_.push(f)}return this._subPortions.push({numVertices:t.numTriangles}),this._numPortions++,tt.numberOfPortions++,f}finalize(){if(this._finalized)return;const e=this._state,t=this._dtxState,i=this.model.scene.canvas.gl,s=this._buffer;e.gl=i,t.texturePerObjectColorsAndFlags=this._dtxTextureFactory.createTextureForColorsAndFlags(i,s.perObjectColors,s.perObjectPickColors,s.perObjectVertexBases,s.perObjectIndexBaseOffsets,s.perObjectEdgeIndexBaseOffsets,s.perObjectSolid),t.texturePerObjectInstanceMatrices=this._dtxTextureFactory.createTextureForInstancingMatrices(i,s.perObjectInstancePositioningMatrices),t.texturePerObjectPositionsDecodeMatrix=this._dtxTextureFactory.createTextureForPositionsDecodeMatrices(i,s.perObjectPositionsDecodeMatrices),t.texturePerVertexIdCoordinates=this._dtxTextureFactory.createTextureForPositions(i,s.positionsCompressed,s.lenPositionsCompressed),t.texturePerPolygonIdPortionIds8Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(i,s.perTriangleNumberPortionId8Bits),t.texturePerPolygonIdPortionIds16Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(i,s.perTriangleNumberPortionId16Bits),t.texturePerPolygonIdPortionIds32Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(i,s.perTriangleNumberPortionId32Bits),s.perEdgeNumberPortionId8Bits.length>0&&(t.texturePerEdgeIdPortionIds8Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(i,s.perEdgeNumberPortionId8Bits)),s.perEdgeNumberPortionId16Bits.length>0&&(t.texturePerEdgeIdPortionIds16Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(i,s.perEdgeNumberPortionId16Bits)),s.perEdgeNumberPortionId32Bits.length>0&&(t.texturePerEdgeIdPortionIds32Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(i,s.perEdgeNumberPortionId32Bits)),s.lenIndices8Bits>0&&(t.texturePerPolygonIdIndices8Bits=this._dtxTextureFactory.createTextureFor8BitIndices(i,s.indices8Bits,s.lenIndices8Bits)),s.lenIndices16Bits>0&&(t.texturePerPolygonIdIndices16Bits=this._dtxTextureFactory.createTextureFor16BitIndices(i,s.indices16Bits,s.lenIndices16Bits)),s.lenIndices32Bits>0&&(t.texturePerPolygonIdIndices32Bits=this._dtxTextureFactory.createTextureFor32BitIndices(i,s.indices32Bits,s.lenIndices32Bits)),s.lenEdgeIndices8Bits>0&&(t.texturePerPolygonIdEdgeIndices8Bits=this._dtxTextureFactory.createTextureFor8BitsEdgeIndices(i,s.edgeIndices8Bits,s.lenEdgeIndices8Bits)),s.lenEdgeIndices16Bits>0&&(t.texturePerPolygonIdEdgeIndices16Bits=this._dtxTextureFactory.createTextureFor16BitsEdgeIndices(i,s.edgeIndices16Bits,s.lenEdgeIndices16Bits)),s.lenEdgeIndices32Bits>0&&(t.texturePerPolygonIdEdgeIndices32Bits=this._dtxTextureFactory.createTextureFor32BitsEdgeIndices(i,s.edgeIndices32Bits,s.lenEdgeIndices32Bits)),t.finalize(),this._buffer=null,this._bucketGeometries={},this._finalized=!0,this._deferredSetFlagsDirty=!1,this._onSceneRendering=this.model.scene.on("rendering",()=>{this._deferredSetFlagsDirty&&this._uploadDeferredFlags(),this._numUpdatesInFrame=0})}isEmpty(){return this._numPortions===0}initFlags(e,t,i){t&k.VISIBLE&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&k.HIGHLIGHTED&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&k.XRAYED&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&k.SELECTED&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&k.CLIPPABLE&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&k.EDGES&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&k.PICKABLE&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&k.CULLED&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++);const s=!0;this._setFlags(e,t,i,s),this._setFlags2(e,t,s)}flushInitFlags(){this._setDeferredFlags(),this._setDeferredFlags2()}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&k.VISIBLE?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&k.HIGHLIGHTED?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&k.XRAYED?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&k.SELECTED?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){if(!this._finalized)throw"Not finalized";t&k.EDGES?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&k.CLIPPABLE?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(e,t)}_beginDeferredFlags(){this._deferredSetFlagsActive=!0}_uploadDeferredFlags(){if(this._deferredSetFlagsActive=!1,!this._deferredSetFlagsDirty)return;this._deferredSetFlagsDirty=!1;const e=this.model.scene.canvas.gl,t=this._dtxState;e.bindTexture(e.TEXTURE_2D,t.texturePerObjectColorsAndFlags._texture),e.texSubImage2D(e.TEXTURE_2D,0,0,0,t.texturePerObjectColorsAndFlags._textureWidth,t.texturePerObjectColorsAndFlags._textureHeight,e.RGBA_INTEGER,e.UNSIGNED_BYTE,t.texturePerObjectColorsAndFlags._textureData)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&k.CULLED?(this._numCulledLayerPortions+=this._portionToSubPortionsMap[e].length,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions-=this._portionToSubPortionsMap[e].length,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&k.PICKABLE?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){const i=this._portionToSubPortionsMap[e];for(let s=0,o=i.length;s<o;s++)this._subPortionSetColor(i[s],t)}_subPortionSetColor(e,t){if(!this._finalized)throw"Not finalized";const i=this._dtxState,s=this.model.scene.canvas.gl;if(Gt[0]=t[0],Gt[1]=t[1],Gt[2]=t[2],Gt[3]=t[3],i.texturePerObjectColorsAndFlags._textureData.set(Gt,e*32),this._deferredSetFlagsActive){console.info("_subPortionSetColor defer"),this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=eo&&this._beginDeferredFlags(),console.info("_subPortionSetColor write through"),s.bindTexture(s.TEXTURE_2D,i.texturePerObjectColorsAndFlags._texture),s.texSubImage2D(s.TEXTURE_2D,0,e%512*8,Math.floor(e/512),1,1,s.RGBA_INTEGER,s.UNSIGNED_BYTE,Gt)}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i,s=!1){const o=this._portionToSubPortionsMap[e];for(let n=0,a=o.length;n<a;n++)this._subPortionSetFlags(o[n],t,i,s)}_subPortionSetFlags(e,t,i,s=!1){if(!this._finalized)throw"Not finalized";const o=!!(t&k.VISIBLE),n=!!(t&k.XRAYED),a=!!(t&k.HIGHLIGHTED),A=!!(t&k.SELECTED),l=!!(t&k.EDGES),h=!!(t&k.PICKABLE),d=!!(t&k.CULLED);let f;!o||d||n||a&&!this.model.scene.highlightMaterial.glowThrough||A&&!this.model.scene.selectedMaterial.glowThrough?f=U.NOT_RENDERED:i?f=U.COLOR_TRANSPARENT:f=U.COLOR_OPAQUE;let m;!o||d?m=U.NOT_RENDERED:A?m=U.SILHOUETTE_SELECTED:a?m=U.SILHOUETTE_HIGHLIGHTED:n?m=U.SILHOUETTE_XRAYED:m=U.NOT_RENDERED;let _=0;!o||d?_=U.NOT_RENDERED:A?_=U.EDGES_SELECTED:a?_=U.EDGES_HIGHLIGHTED:n?_=U.EDGES_XRAYED:l?i?_=U.EDGES_COLOR_TRANSPARENT:_=U.EDGES_COLOR_OPAQUE:_=U.NOT_RENDERED;let u=o&&!d&&h?U.PICK:U.NOT_RENDERED;const B=this._dtxState,y=this.model.scene.canvas.gl;if(Gt[0]=f,Gt[1]=m,Gt[2]=_,Gt[3]=u,B.texturePerObjectColorsAndFlags._textureData.set(Gt,e*32+8),this._deferredSetFlagsActive||s){this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=eo&&this._beginDeferredFlags(),y.bindTexture(y.TEXTURE_2D,B.texturePerObjectColorsAndFlags._texture),y.texSubImage2D(y.TEXTURE_2D,0,e%512*8+2,Math.floor(e/512),1,1,y.RGBA_INTEGER,y.UNSIGNED_BYTE,Gt)}_setDeferredFlags(){}_setFlags2(e,t,i=!1){const s=this._portionToSubPortionsMap[e];for(let o=0,n=s.length;o<n;o++)this._subPortionSetFlags2(s[o],t,i)}_subPortionSetFlags2(e,t,i=!1){if(!this._finalized)throw"Not finalized";const s=t&k.CLIPPABLE?255:0,o=this._dtxState,n=this.model.scene.canvas.gl;if(Gt[0]=s,Gt[1]=0,Gt[2]=1,Gt[3]=2,o.texturePerObjectColorsAndFlags._textureData.set(Gt,e*32+12),this._deferredSetFlagsActive||i){this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=eo&&this._beginDeferredFlags(),n.bindTexture(n.TEXTURE_2D,o.texturePerObjectColorsAndFlags._texture),n.texSubImage2D(n.TEXTURE_2D,0,e%512*8+3,Math.floor(e/512),1,1,n.RGBA_INTEGER,n.UNSIGNED_BYTE,Gt)}_setDeferredFlags2(){}setOffset(e,t){const i=this._portionToSubPortionsMap[e];for(let s=0,o=i.length;s<o;s++)this._subPortionSetOffset(i[s],t)}_subPortionSetOffset(e,t){if(!this._finalized)throw"Not finalized";const i=this._dtxState,s=this.model.scene.canvas.gl;if(to[0]=t[0],to[1]=t[1],to[2]=t[2],i.texturePerObjectOffsets._textureData.set(to,e*3),this._deferredSetFlagsActive){this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=eo&&this._beginDeferredFlags(),s.bindTexture(s.TEXTURE_2D,i.texturePerObjectOffsets._texture),s.texSubImage2D(s.TEXTURE_2D,0,0,e,1,1,s.RGB,s.FLOAT,to)}setMatrix(e,t){const i=this._portionToSubPortionsMap[e];for(let s=0,o=i.length;s<o;s++)this._subPortionSetMatrix(i[s],t)}_subPortionSetMatrix(e,t){if(!this._finalized)throw"Not finalized";const i=this._dtxState,s=this.model.scene.canvas.gl;if(EA.set(t),i.texturePerObjectInstanceMatrices._textureData.set(EA,e*16),this._deferredSetFlagsActive){this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=eo&&this._beginDeferredFlags(),s.bindTexture(s.TEXTURE_2D,i.texturePerObjectInstanceMatrices._texture),s.texSubImage2D(s.TEXTURE_2D,0,e%512*4,Math.floor(e/512),4,1,s.RGBA,s.FLOAT,EA)}drawColorOpaque(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,t),t.withSAO&&this.model.saoEnabled?this._renderers.colorRendererWithSAO&&this._renderers.colorRendererWithSAO.drawLayer(t,this,U.COLOR_OPAQUE):this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,U.COLOR_OPAQUE))}_updateBackfaceCull(e,t){const i=this.model.backfaces||e.sectioned;if(t.backfaces!==i){const s=t.gl;i?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),t.backfaces=i}}drawColorTransparent(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===0||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,t),this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,U.COLOR_TRANSPARENT))}drawDepth(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,t),this._renderers.depthRenderer&&this._renderers.depthRenderer.drawLayer(t,this,U.COLOR_OPAQUE))}drawNormals(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,t),this._renderers.normalsRenderer&&this._renderers.normalsRenderer.drawLayer(t,this,U.COLOR_OPAQUE))}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,U.SILHOUETTE_XRAYED))}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,U.SILHOUETTE_HIGHLIGHTED))}drawSilhouetteSelected(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,U.SILHOUETTE_SELECTED))}drawEdgesColorOpaque(e,t){if(this.model.scene.logarithmicDepthBufferEnabled){this.model.scene._loggedWarning||(console.log("Edge enhancement for SceneModel data texture layers currently disabled with logarithmic depth buffer"),this.model.scene._loggedWarning=!0);return}this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numEdgesLayerPortions===0||this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(t,this,U.EDGES_COLOR_OPAQUE)}drawEdgesColorTransparent(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numEdgesLayerPortions===0||this._numTransparentLayerPortions===0||this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(t,this,U.EDGES_COLOR_TRANSPARENT)}drawEdgesHighlighted(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,U.EDGES_HIGHLIGHTED)}drawEdgesSelected(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,U.EDGES_SELECTED)}drawEdgesXRayed(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,U.EDGES_XRAYED)}drawOcclusion(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.occlusionRenderer&&this._renderers.occlusionRenderer.drawLayer(t,this,U.COLOR_OPAQUE))}drawShadow(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.shadowRenderer&&this._renderers.shadowRenderer.drawLayer(t,this,U.COLOR_OPAQUE))}setPickMatrices(e,t){}drawPickMesh(e,t){this._numVisibleLayerPortions!==0&&(this._updateBackfaceCull(e,t),this._renderers.pickMeshRenderer&&this._renderers.pickMeshRenderer.drawLayer(t,this,U.PICK))}drawPickDepths(e,t){this._numVisibleLayerPortions!==0&&(this._updateBackfaceCull(e,t),this._renderers.pickDepthRenderer&&this._renderers.pickDepthRenderer.drawLayer(t,this,U.PICK))}drawSnapInit(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(t,this,U.PICK))}drawSnap(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(t,this,U.PICK))}drawPickNormals(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.pickNormalsRenderer&&this._renderers.pickNormalsRenderer.drawLayer(t,this,U.PICK))}destroy(){if(this._destroyed)return;const e=this._state;e.metallicRoughnessBuf&&(e.metallicRoughnessBuf.destroy(),e.metallicRoughnessBuf=null),this.model.scene.off(this._onSceneRendering),e.destroy(),this._destroyed=!0}}class ed{constructor(e){this.id=e.id,this.colorTexture=e.colorTexture,this.metallicRoughnessTexture=e.metallicRoughnessTexture,this.normalsTexture=e.normalsTexture,this.emissiveTexture=e.emissiveTexture,this.occlusionTexture=e.occlusionTexture}destroy(){}}class Js{constructor(e){this.id=e.id,this.texture=e.texture}destroy(){this.texture&&(this.texture.destroy(),this.texture=null)}}const td={enabled:!1,files:{},add:function(r,e){this.enabled!==!1&&(this.files[r]=e)},get:function(r){if(this.enabled!==!1)return this.files[r]},remove:function(r){delete this.files[r]},clear:function(){this.files={}}};class Pw{constructor(e,t,i){this.isLoading=!1,this.itemsLoaded=0,this.itemsTotal=0,this.urlModifier=void 0,this.handlers=[],this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=i}itemStart(e){this.itemsTotal++,this.isLoading===!1&&this.onStart!==void 0&&this.onStart(e,this.itemsLoaded,this.itemsTotal),this.isLoading=!0}itemEnd(e){this.itemsLoaded++,this.onProgress!==void 0&&this.onProgress(e,this.itemsLoaded,this.itemsTotal),this.itemsLoaded===this.itemsTotal&&(this.isLoading=!1,this.onLoad!==void 0&&this.onLoad())}itemError(e){this.onError!==void 0&&this.onError(e)}resolveURL(e){return this.urlModifier?this.urlModifier(e):e}setURLModifier(e){return this.urlModifier=e,this}addHandler(e,t){return this.handlers.push(e,t),this}removeHandler(e){const t=this.handlers.indexOf(e);return t!==-1&&this.handlers.splice(t,2),this}getHandler(e){for(let t=0,i=this.handlers.length;t<i;t+=2){const s=this.handlers[t],o=this.handlers[t+1];if(s.global&&(s.lastIndex=0),s.test(e))return o}return null}}const yw=new Pw;class xw{constructor(e){this.manager=e!==void 0?e:yw,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(e,t){const i=this;return new Promise(function(s,o){i.load(e,s,t,o)})}parse(){}setCrossOrigin(e){return this.crossOrigin=e,this}setWithCredentials(e){return this.withCredentials=e,this}setPath(e){return this.path=e,this}setResourcePath(e){return this.resourcePath=e,this}setRequestHeader(e){return this.requestHeader=e,this}}const Zi={};class id extends xw{constructor(e){super(e)}load(e,t,i,s){e===void 0&&(e=""),this.path!==void 0&&(e=this.path+e),e=this.manager.resolveURL(e);const o=td.get(e);if(o!==void 0)return this.manager.itemStart(e),Bt.scheduleTask(()=>{t&&t(o),this.manager.itemEnd(e)},0),o;if(Zi[e]!==void 0){Zi[e].push({onLoad:t,onProgress:i,onError:s});return}Zi[e]=[],Zi[e].push({onLoad:t,onProgress:i,onError:s});const n=new Request(e,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin"}),a=this.mimeType,A=this.responseType;fetch(n).then(l=>{if(l.status===200||l.status===0){if(l.status===0&&console.warn("FileLoader: HTTP Status 0 received."),typeof ReadableStream>"u"||l.body.getReader===void 0)return l;const h=Zi[e],d=l.body.getReader(),f=l.headers.get("Content-Length"),m=f?parseInt(f):0,_=m!==0;let u=0;const B=new ReadableStream({start(y){x();function x(){d.read().then(({done:P,value:v})=>{if(P)y.close();else{u+=v.byteLength;const b=new ProgressEvent("progress",{lengthComputable:_,loaded:u,total:m});for(let C=0,I=h.length;C<I;C++){const E=h[C];E.onProgress&&E.onProgress(b)}y.enqueue(v),x()}})}}});return new Response(B)}else throw Error(`fetch for "${l.url}" responded with ${l.status}: ${l.statusText}`)}).then(l=>{switch(A){case"arraybuffer":return l.arrayBuffer();case"blob":return l.blob();case"document":return l.text().then(h=>new DOMParser().parseFromString(h,a));case"json":return l.json();default:if(a===void 0)return l.text();{const d=/charset="?([^;"\s]*)"?/i.exec(a),f=d&&d[1]?d[1].toLowerCase():void 0,m=new TextDecoder(f);return l.arrayBuffer().then(_=>m.decode(_))}}}).then(l=>{td.add(e,l);const h=Zi[e];delete Zi[e];for(let d=0,f=h.length;d<f;d++){const m=h[d];m.onLoad&&m.onLoad(l)}}).catch(l=>{const h=Zi[e];if(h===void 0)throw this.manager.itemError(e),l;delete Zi[e];for(let d=0,f=h.length;d<f;d++){const m=h[d];m.onError&&m.onError(l)}this.manager.itemError(e)}).finally(()=>{this.manager.itemEnd(e)}),this.manager.itemStart(e)}setResponseType(e){return this.responseType=e,this}setMimeType(e){return this.mimeType=e,this}}class ww{constructor(e=4){this.pool=e,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0}_initWorker(e){if(!this.workers[e]){const t=this.workerCreator();t.addEventListener("message",this._onMessage.bind(this,e)),this.workers[e]=t}}_getIdleWorker(){for(let e=0;e<this.pool;e++)if(!(this.workerStatus&1<<e))return e;return-1}_onMessage(e,t){const i=this.workersResolve[e];if(i&&i(t),this.queue.length){const{resolve:s,msg:o,transfer:n}=this.queue.shift();this.workersResolve[e]=s,this.workers[e].postMessage(o,n)}else this.workerStatus^=1<<e}setWorkerCreator(e){this.workerCreator=e}setWorkerLimit(e){this.pool=e}postMessage(e,t){return new Promise(i=>{const s=this._getIdleWorker();s!==-1?(this._initWorker(s),this.workerStatus|=1<<s,this.workersResolve[s]=i,this.workers[s].postMessage(e,t)):this.queue.push({resolve:i,msg:e,transfer:t})})}destroy(){this.workers.forEach(e=>e.terminate()),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}}const bw=2,Cw=1;let IA=0;class Hi{constructor({viewer:e,transcoderPath:t,workerLimit:i}){this._transcoderPath=t||"https://cdn.jsdelivr.net/npm/@xeokit/xeokit-sdk/dist/basis/",this._transcoderBinary=null,this._transcoderPending=null,this._workerPool=new ww,this._workerSourceURL="",i&&this._workerPool.setWorkerLimit(i);const s=e.capabilities;this._workerConfig={astcSupported:s.astcSupported,etc1Supported:s.etc1Supported,etc2Supported:s.etc2Supported,dxtSupported:s.dxtSupported,bptcSupported:s.bptcSupported,pvrtcSupported:s.pvrtcSupported},this._supportedFileTypes=["xkt2"]}_init(){if(!this._transcoderPending){const e=new id;e.setPath(this._transcoderPath),e.setWithCredentials(this.withCredentials);const t=e.loadAsync("basis_transcoder.js"),i=new id;i.setPath(this._transcoderPath),i.setResponseType("arraybuffer"),i.setWithCredentials(this.withCredentials);const s=i.loadAsync("basis_transcoder.wasm");this._transcoderPending=Promise.all([t,s]).then(([o,n])=>{const a=Hi.BasisWorker.toString(),A=["/* constants */","let _EngineFormat = "+JSON.stringify(Hi.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(Hi.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(Hi.BasisFormat),"/* basis_transcoder.js */",o,"/* worker */",a.substring(a.indexOf("{")+1,a.lastIndexOf("}"))].join(`
`);this._workerSourceURL=URL.createObjectURL(new Blob([A])),this._transcoderBinary=n,this._workerPool.setWorkerCreator(()=>{const l=new Worker(this._workerSourceURL),h=this._transcoderBinary.slice(0);return l.postMessage({type:"init",config:this._workerConfig,transcoderBinary:h},[h]),l})}),IA>0&&console.warn("KTX2TextureTranscoder: Multiple active KTX2TextureTranscoder may cause performance issues. Use a single KTX2TextureTranscoder instance, or call .dispose() on old instances."),IA++}return this._transcoderPending}transcode(e,t,i={}){return new Promise((s,o)=>{const n=i;this._init().then(()=>this._workerPool.postMessage({type:"transcode",buffers:e,taskConfig:n},e)).then(a=>{const A=a.data,{mipmaps:l,width:h,height:d,format:f,type:m,error:_,dfdTransferFn:u,dfdFlags:B}=A;if(m==="error")return o(_);t.setCompressedData({mipmaps:l,props:{format:f,minFilter:l.length===1?Qi:yo,magFilter:l.length===1?Qi:yo,encoding:u===bw?wt:yr,premultiplyAlpha:!!(B&Cw)}}),s()})})}destroy(){URL.revokeObjectURL(this._workerSourceURL),this._workerPool.destroy(),IA--}}Hi.BasisFormat={ETC1S:0,UASTC_4x4:1};Hi.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16};Hi.EngineFormat={RGBAFormat:Aa,RGBA_ASTC_4x4_Format:Tl,RGBA_BPTC_Format:Dl,RGBA_ETC2_EAC_Format:Sl,RGBA_PVRTC_4BPPV1_Format:Fl,RGBA_S3TC_DXT5_Format:Zn,RGB_ETC1_Format:Wf,RGB_ETC2_Format:Ml,RGB_PVRTC_4BPPV1_Format:Il,RGB_S3TC_DXT1_Format:Jn};Hi.BasisWorker=function(){let r,e,t;const i=_EngineFormat,s=_TranscoderFormat,o=_BasisFormat;self.addEventListener("message",function(m){const _=m.data;switch(_.type){case"init":r=_.config,n(_.transcoderBinary);break;case"transcode":e.then(()=>{try{const{width:u,height:B,hasAlpha:y,mipmaps:x,format:P,dfdTransferFn:v,dfdFlags:b}=a(_.buffers[0]),C=[];for(let I=0;I<x.length;++I)C.push(x[I].data.buffer);self.postMessage({type:"transcode",id:_.id,width:u,height:B,hasAlpha:y,mipmaps:x,format:P,dfdTransferFn:v,dfdFlags:b},C)}catch(u){console.error(`[KTX2TextureTranscoder.BasisWorker]: ${u}`),self.postMessage({type:"error",id:_.id,error:u.message})}});break}});function n(m){e=new Promise(_=>{t={wasmBinary:m,onRuntimeInitialized:_},BASIS(t)}).then(()=>{t.initializeBasis(),t.KTX2File===void 0&&console.warn("KTX2TextureTranscoder: Please update Basis Universal transcoder.")})}function a(m){const _=new t.KTX2File(new Uint8Array(m));function u(){_.close(),_.delete()}if(!_.isValid())throw u(),new Error("KTX2TextureTranscoder: Invalid or unsupported .ktx2 file");const B=_.isUASTC()?o.UASTC_4x4:o.ETC1S,y=_.getWidth(),x=_.getHeight(),P=_.getLevels(),v=_.getHasAlpha(),b=_.getDFDTransferFunc(),C=_.getDFDFlags(),{transcoderFormat:I,engineFormat:E}=d(B,y,x,v);if(!y||!x||!P)throw u(),new Error("KTX2TextureTranscoder: Invalid texture");if(!_.startTranscoding())throw u(),new Error("KTX2TextureTranscoder: .startTranscoding failed");const S=[];for(let R=0;R<P;R++){const D=_.getImageLevelInfo(R,0,0),K=D.origWidth,j=D.origHeight,z=new Uint8Array(_.getImageTranscodedSizeInBytes(R,0,0,I));if(!_.transcodeImage(z,R,0,0,I,0,-1,-1))throw u(),new Error("KTX2TextureTranscoder: .transcodeImage failed.");S.push({data:z,width:K,height:j})}return u(),{width:y,height:x,hasAlpha:v,mipmaps:S,format:E,dfdTransferFn:b,dfdFlags:C}}const A=[{if:"astcSupported",basisFormat:[o.UASTC_4x4],transcoderFormat:[s.ASTC_4x4,s.ASTC_4x4],engineFormat:[i.RGBA_ASTC_4x4_Format,i.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[s.BC7_M5,s.BC7_M5],engineFormat:[i.RGBA_BPTC_Format,i.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[s.BC1,s.BC3],engineFormat:[i.RGB_S3TC_DXT1_Format,i.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[s.ETC1,s.ETC2],engineFormat:[i.RGB_ETC2_Format,i.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[s.ETC1],engineFormat:[i.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[s.PVRTC1_4_RGB,s.PVRTC1_4_RGBA],engineFormat:[i.RGB_PVRTC_4BPPV1_Format,i.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],l=A.sort(function(m,_){return m.priorityETC1S-_.priorityETC1S}),h=A.sort(function(m,_){return m.priorityUASTC-_.priorityUASTC});function d(m,_,u,B){let y,x;const P=m===o.ETC1S?l:h;for(let v=0;v<P.length;v++){const b=P[v];if(r[b.if]&&b.basisFormat.includes(m)&&!(B&&b.transcoderFormat.length<2)&&!(b.needsPowerOfTwo&&!(f(_)&&f(u))))return y=b.transcoderFormat[B?1:0],x=b.engineFormat[B?1:0],{transcoderFormat:y,engineFormat:x}}return console.warn("KTX2TextureTranscoder: No suitable compressed texture format found. Decoding to RGBA32."),y=s.RGBA32,x=i.RGBAFormat,{transcoderFormat:y,engineFormat:x}}function f(m){return m<=2?!0:(m&m-1)===0&&m!==0}};const FA={};function Ew(r){const e=r.scene.id;let t=FA[e];return t||(t=new Hi({viewer:r}),FA[e]=t,r.scene.on("destroyed",()=>{delete FA[e],t.destroy()})),t}/**
 * @author https://github.com/tmarti, with support from https://tribia.com/
 * @license MIT
 *
 * This file takes a geometry given by { positionsCompressed, indices }, and returns
 * equivalent { positionsCompressed, indices } arrays but which only contain unique
 * positionsCompressed.
 *
 * The time is O(N logN) with the number of positionsCompressed due to a pre-sorting
 * step, but is much more GC-friendly and actually faster than the classic O(N)
 * approach based in keeping a hash-based LUT to identify unique positionsCompressed.
 */let ca=null;function MA(r,e){let t;for(let i=0;i<3;i++)if((t=ca[r*3+i]-ca[e*3+i])!==0)return t;return 0}let gr=null;function Iw(r){if(!(gr!==null&&gr.length>=r)){gr=new Uint32Array(r);for(let e=0;e<r;e++)gr[e]=e}}function Fw(r){const e=r.positionsCompressed,t=r.indices,i=r.edgeIndices;Iw(e.length/3);const s=gr.slice(0,e.length/3),o=gr.slice(0,e.length/3);ca=e,s.sort(MA);let n=0;o[s[0]]=0;for(let d=1,f=s.length;d<f;d++)MA(s[d],s[d-1])!==0&&n++,o[s[d]]=n;const a=n+1,A=new Uint16Array(a*3);n=0,A[n*3+0]=e[s[0]*3+0],A[n*3+1]=e[s[0]*3+1],A[n*3+2]=e[s[0]*3+2];for(let d=1,f=s.length;d<f;d++)MA(s[d],s[d-1])!==0&&(n++,A[n*3+0]=e[s[d]*3+0],A[n*3+1]=e[s[d]*3+1],A[n*3+2]=e[s[d]*3+2]),o[s[d]]=n;ca=null;const l=new Uint32Array(t.length);for(let d=0,f=t.length;d<f;d++)l[d]=o[t[d]];const h=new Uint32Array(i.length);for(let d=0,f=i.length;d<f;d++)h[d]=o[i[d]];return[A,l,h]}/**
 * @author https://github.com/tmarti, with support from https://tribia.com/
 * @license MIT
 **/const sd=8;let ps=null;function Mw(r,e){const t=r*3,i=e*3;let s,o,n,a,A,l;const h=Math.min(s=ps[t],o=ps[t+1],n=ps[t+2]),d=Math.min(a=ps[i],A=ps[i+1],l=ps[i+2]);if(h!==d)return h-d;const f=Math.max(s,o,n),m=Math.max(a,A,l);return f!==m?f-m:0}function Sw(r,e){const t=new Int32Array(r.length/3);for(let s=0,o=t.length;s<o;s++)t[s]=s;ps=new Int32Array(r.length);for(let s=0,o=r.length;s<o;s++)ps[s]=r[s]>>e;t.sort(Mw);const i=new Int32Array(r.length);for(let s=0,o=t.length;s<o;s++)i[s*3+0]=r[t[s]*3+0],i[s*3+1]=r[t[s]*3+1],i[s*3+2]=r[t[s]*3+2];return i}let ho=null;function Tw(r,e){let t=ho[r*2]-ho[e*2];return t!==0?t:ho[r*2+1]-ho[e*2+1]}function Dw(r){if((r||[]).length===0)return[];let e=new Int32Array(r.length/2);for(let i=0,s=e.length;i<s;i++)e[i]=i;for(let i=0,s=r.length;i<s;i+=2)if(r[i]>r[i+1]){let o=r[i];r[i]=r[i+1],r[i+1]=o}ho=new Int32Array(r),e.sort(Tw);const t=new Int32Array(r.length);for(let i=0,s=e.length;i<s;i++)t[i*2+0]=r[e[i]*2+0],t[i*2+1]=r[e[i]*2+1];return t}function Rw(r,e,t=!1){const i=r.positionsCompressed||[],s=Sw(r.indices||[],e),o=Dw(r.edgeIndices||[]);function n(x,P){if(x>P){let I=x;x=P,P=I}function v(I,E){return I!==x?x-I:E!==P?P-E:0}let b=0,C=(o.length>>1)-1;for(;b<=C;){const I=C+b>>1,E=v(o[I*2],o[I*2+1]);if(E>0)b=I+1;else if(E<0)C=I-1;else return I}return-b-1}const a=new Int32Array(o.length/2);a.fill(0);const A=i.length/3;if(A>(1<<e)*sd)return[r];const l=new Int32Array(A);l.fill(-1);const h=[];function d(){l.fill(-1);const x={positionsCompressed:[],indices:[],edgeIndices:[],maxNumPositions:(1<<e)-e,numPositions:0,bucketNumber:h.length};return h.push(x),x}let f=d();for(let x=0,P=s.length;x<P;x+=3){let v=0;const b=s[x],C=s[x+1],I=s[x+2];if(l[b]===-1&&v++,l[C]===-1&&v++,l[I]===-1&&v++,v+f.numPositions>f.maxNumPositions&&(f=d()),f.bucketNumber>sd)return[r];l[b]===-1&&(l[b]=f.numPositions++,f.positionsCompressed.push(i[b*3]),f.positionsCompressed.push(i[b*3+1]),f.positionsCompressed.push(i[b*3+2])),l[C]===-1&&(l[C]=f.numPositions++,f.positionsCompressed.push(i[C*3]),f.positionsCompressed.push(i[C*3+1]),f.positionsCompressed.push(i[C*3+2])),l[I]===-1&&(l[I]=f.numPositions++,f.positionsCompressed.push(i[I*3]),f.positionsCompressed.push(i[I*3+1]),f.positionsCompressed.push(i[I*3+2])),f.indices.push(l[b]),f.indices.push(l[C]),f.indices.push(l[I]);let E;(E=n(b,C))>=0&&a[E]===0&&(a[E]=1,f.edgeIndices.push(l[o[E*2]]),f.edgeIndices.push(l[o[E*2+1]])),(E=n(b,I))>=0&&a[E]===0&&(a[E]=1,f.edgeIndices.push(l[o[E*2]]),f.edgeIndices.push(l[o[E*2+1]])),(E=n(C,I))>=0&&a[E]===0&&(a[E]=1,f.edgeIndices.push(l[o[E*2]]),f.edgeIndices.push(l[o[E*2+1]]))}const m=e/8*2,_=e/8,u=i.length*2+(s.length+o.length)*m;let B=0,y=-i.length/3;return h.forEach(x=>{B+=x.positionsCompressed.length*2+(x.indices.length+x.edgeIndices.length)*_,y+=x.positionsCompressed.length/3}),B>u?[r]:(t&&Lw(h,r),h)}function Lw(r,e){const t={};let i=0;r.forEach(s=>{const o=s.indices,n=s.edgeIndices,a=s.positionsCompressed;for(let A=0,l=o.length;A<l;A+=3){const h=a[o[A]*3]+"_"+a[o[A]*3+1]+"_"+a[o[A]*3+2]+"/"+a[o[A+1]*3]+"_"+a[o[A+1]*3+1]+"_"+a[o[A+1]*3+2]+"/"+a[o[A+2]*3]+"_"+a[o[A+2]*3+1]+"_"+a[o[A+2]*3+2];t[h]=!0}i+=s.edgeIndices.length/2;for(let A=0,l=n.length;A<l;A+=2)a[n[A]*3]+""+a[n[A]*3+1]+a[n[A]*3+2]+a[n[A+1]*3]+a[n[A+1]*3+1]+a[n[A+1]*3+2]});{const s=e.indices;e.edgeIndices;const o=e.positionsCompressed;for(let n=0,a=s.length;n<a;n+=3){const A=o[s[n]*3]+"_"+o[s[n]*3+1]+"_"+o[s[n]*3+2]+"/"+o[s[n+1]*3]+"_"+o[s[n+1]*3+1]+"_"+o[s[n+1]*3+2]+"/"+o[s[n+2]*3]+"_"+o[s[n+2]*3+1]+"_"+o[s[n+2]*3+2];if(!(A in t))throw console.log("Not found "+A),"Ohhhh!"}}}const Ui=c.vec4(4),io=c.vec4(),rd=c.vec4(),Uw=c.vec3([1,0,0]),Ow=c.vec3([0,1,0]),kw=c.vec3([0,0,1]);c.vec3(3);c.vec3(3);const Nw=c.identityMat4();class Qw{constructor(e){this._model=e.model,this.id=e.id,this._parentTransform=e.parent,this._childTransforms=[],this._meshes=[],this._scale=new Float32Array([1,1,1]),this._quaternion=c.identityQuaternion(new Float32Array(4)),this._rotation=new Float32Array(3),this._position=new Float32Array(3),this._localMatrix=c.identityMat4(new Float32Array(16)),this._worldMatrix=c.identityMat4(new Float32Array(16)),this._localMatrixDirty=!0,this._worldMatrixDirty=!0,e.matrix?this.matrix=e.matrix:(this.scale=e.scale,this.position=e.position,e.quaternion||(this.rotation=e.rotation)),e.parent&&e.parent._addChildTransform(this)}_addChildTransform(e){this._childTransforms.push(e),e._parentTransform=this,e._transformDirty(),e._setSubtreeAABBsDirty(this)}_addMesh(e){this._meshes.push(e),e.transform=this}get parentTransform(){return this._parentTransform}get meshes(){return this._meshes}set position(e){this._position.set(e||[0,0,0]),this._setLocalMatrixDirty(),this._model.glRedraw()}get position(){return this._position}set rotation(e){this._rotation.set(e||[0,0,0]),c.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._model.glRedraw()}get rotation(){return this._rotation}set quaternion(e){this._quaternion.set(e||[0,0,0,1]),c.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._model.glRedraw()}get quaternion(){return this._quaternion}set scale(e){this._scale.set(e||[1,1,1]),this._setLocalMatrixDirty(),this._model.glRedraw()}get scale(){return this._scale}set matrix(e){this._localMatrix||(this._localMatrix=c.identityMat4()),this._localMatrix.set(e||Nw),c.decomposeMat4(this._localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._transformDirty(),this._model.glRedraw()}get matrix(){return this._localMatrixDirty&&(this._localMatrix||(this._localMatrix=c.identityMat4()),c.composeMat4(this._position,this._quaternion,this._scale,this._localMatrix),this._localMatrixDirty=!1),this._localMatrix}get worldMatrix(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix}rotate(e,t){return Ui[0]=e[0],Ui[1]=e[1],Ui[2]=e[2],Ui[3]=t*c.DEGTORAD,c.angleAxisToQuaternion(Ui,io),c.mulQuaternions(this.quaternion,io,rd),this.quaternion=rd,this._setLocalMatrixDirty(),this._model.glRedraw(),this}rotateOnWorldAxis(e,t){return Ui[0]=e[0],Ui[1]=e[1],Ui[2]=e[2],Ui[3]=t*c.DEGTORAD,c.angleAxisToQuaternion(Ui,io),c.mulQuaternions(io,this.quaternion,io),this}rotateX(e){return this.rotate(Uw,e)}rotateY(e){return this.rotate(Ow,e)}rotateZ(e){return this.rotate(kw,e)}translate(e){return this._position[0]+=e[0],this._position[1]+=e[1],this._position[2]+=e[2],this._setLocalMatrixDirty(),this._model.glRedraw(),this}translateX(e){return this._position[0]+=e,this._setLocalMatrixDirty(),this._model.glRedraw(),this}translateY(e){return this._position[1]+=e,this._setLocalMatrixDirty(),this._model.glRedraw(),this}translateZ(e){return this._position[2]+=e,this._setLocalMatrixDirty(),this._model.glRedraw(),this}_setLocalMatrixDirty(){this._localMatrixDirty=!0,this._transformDirty()}_transformDirty(){this._worldMatrixDirty=!0;for(let e=0,t=this._childTransforms.length;e<t;e++){const i=this._childTransforms[e];if(i._transformDirty(),i._meshes&&i._meshes.length>0){const s=i._meshes;for(let o=0,n=s.length;o<n;o++)s[o]._transformDirty()}}if(this._meshes&&this._meshes.length>0){const e=this._meshes;for(let t=0,i=e.length;t<i;t++)e[t]._transformDirty()}}_buildWorldMatrix(){const e=this.matrix;if(this._parentTransform)c.mulMat4(this._parentTransform.worldMatrix,e,this._worldMatrix);else for(let t=0,i=e.length;t<i;t++)this._worldMatrix[t]=e[t];this._worldMatrixDirty=!1}_setSubtreeAABBsDirty(e){if(e._aabbDirty=!0,e._childTransforms)for(let t=0,i=e._childTransforms.length;t<i;t++)this._setSubtreeAABBsDirty(e._childTransforms[t])}}const od=c.vec3(),qi=c.OBB3(),Pn=c.vec4(),nd=c.vec3([1,1,1]),ad=c.vec3([0,0,0]);c.vec3([0,0,0]);const Ad=c.identityQuaternion(),Hw=c.identityMat4(),SA="defaultColorTexture",TA="defaultMetalRoughTexture",DA="defaultNormalsTexture",RA="defaultEmissiveTexture",LA="defaultOcclusionTexture",ld="defaultTextureSet",UA=new Uint8Array([255,255,255]),so=0,ro=1,Zs=2;class Vw extends It{constructor(e,t={}){super(e,t),this._dtxEnabled=this.scene.dtxEnabled&&t.dtxEnabled!==!1,this._enableVertexWelding=!1,this._enableIndexBucketing=!1,this._vboBatchingLayerScratchMemory=LB(),this._textureTranscoder=t.textureTranscoder||Ew(this.scene.viewer),this._maxGeometryBatchSize=t.maxGeometryBatchSize,this._aabb=c.collapseAABB3(),this._aabbDirty=!0,this._quantizationRanges={},this._vboInstancingLayers={},this._vboBatchingLayers={},this._dtxLayers={},this._meshList=[],this.layerList=[],this._entityList=[],this._geometries={},this._dtxBuckets={},this._textures={},this._textureSets={},this._transforms={},this._meshes={},this._unusedMeshes={},this._entities={},this.renderFlags=new $f,this.numGeometries=0,this.numPortions=0,this.numVisibleLayerPortions=0,this.numTransparentLayerPortions=0,this.numXRayedLayerPortions=0,this.numHighlightedLayerPortions=0,this.numSelectedLayerPortions=0,this.numEdgesLayerPortions=0,this.numPickableLayerPortions=0,this.numClippableLayerPortions=0,this.numCulledLayerPortions=0,this.numEntities=0,this._numTriangles=0,this._numLines=0,this._numPoints=0,this._edgeThreshold=t.edgeThreshold||10,this._origin=c.vec3(t.origin||[0,0,0]),this._position=c.vec3(t.position||[0,0,0]),this._rotation=c.vec3(t.rotation||[0,0,0]),this._quaternion=c.vec4(t.quaternion||[0,0,0,1]),this._conjugateQuaternion=c.vec4(t.quaternion||[0,0,0,1]),t.rotation&&c.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._scale=c.vec3(t.scale||[1,1,1]),this._worldRotationMatrix=c.mat4(),this._worldRotationMatrixConjugate=c.mat4(),this._matrix=c.mat4(),this._matrixDirty=!0,this._rebuildMatrices(),this._worldNormalMatrix=c.mat4(),c.inverseMat4(this._matrix,this._worldNormalMatrix),c.transposeMat4(this._worldNormalMatrix),(t.matrix||t.position||t.rotation||t.scale||t.quaternion)&&(this._viewMatrix=c.mat4(),this._viewNormalMatrix=c.mat4(),this._viewMatrixDirty=!0,this._matrixNonIdentity=!0),this._opacity=1,this._colorize=[1,1,1],this._saoEnabled=t.saoEnabled!==!1,this._pbrEnabled=t.pbrEnabled!==!1,this._colorTextureEnabled=t.colorTextureEnabled!==!1,this._isModel=t.isModel,this._isModel&&this.scene._registerModel(this),this._onCameraViewMatrix=this.scene.camera.on("matrix",()=>{this._viewMatrixDirty=!0}),this._meshesWithDirtyMatrices=[],this._numMeshesWithDirtyMatrices=0,this._onTick=this.scene.on("tick",()=>{for(;this._numMeshesWithDirtyMatrices>0;)this._meshesWithDirtyMatrices[--this._numMeshesWithDirtyMatrices]._updateMatrix()}),this._createDefaultTextureSet(),this.visible=t.visible,this.culled=t.culled,this.pickable=t.pickable,this.clippable=t.clippable,this.collidable=t.collidable,this.castsShadow=t.castsShadow,this.receivesShadow=t.receivesShadow,this.xrayed=t.xrayed,this.highlighted=t.highlighted,this.selected=t.selected,this.edges=t.edges,this.colorize=t.colorize,this.opacity=t.opacity,this.backfaces=t.backfaces}_meshMatrixDirty(e){this._meshesWithDirtyMatrices[this._numMeshesWithDirtyMatrices++]=e}_createDefaultTextureSet(){const e=new Js({id:SA,texture:new Xs({gl:this.scene.canvas.gl,preloadColor:[1,1,1,1]})}),t=new Js({id:TA,texture:new Xs({gl:this.scene.canvas.gl,preloadColor:[0,1,1,1]})}),i=new Js({id:DA,texture:new Xs({gl:this.scene.canvas.gl,preloadColor:[0,0,0,0]})}),s=new Js({id:RA,texture:new Xs({gl:this.scene.canvas.gl,preloadColor:[0,0,0,1]})}),o=new Js({id:LA,texture:new Xs({gl:this.scene.canvas.gl,preloadColor:[1,1,1,1]})});this._textures[SA]=e,this._textures[TA]=t,this._textures[DA]=i,this._textures[RA]=s,this._textures[LA]=o,this._textureSets[ld]=new ed({id:ld,model:this,colorTexture:e,metallicRoughnessTexture:t,normalsTexture:i,emissiveTexture:s,occlusionTexture:o})}get isPerformanceModel(){return!0}get transforms(){return this._transforms}get textures(){return this._textures}get textureSets(){return this._textureSets}get meshes(){return this._meshes}get objects(){return this._entities}get origin(){return this._origin}set position(e){this._position.set(e||[0,0,0]),this._setWorldMatrixDirty(),this._sceneModelDirty(),this.glRedraw()}get position(){return this._position}set rotation(e){this._rotation.set(e||[0,0,0]),c.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setWorldMatrixDirty(),this._sceneModelDirty(),this.glRedraw()}get rotation(){return this._rotation}set quaternion(e){this._quaternion.set(e||[0,0,0,1]),c.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setWorldMatrixDirty(),this._sceneModelDirty(),this.glRedraw()}get quaternion(){return this._quaternion}set scale(e){}get scale(){return this._scale}set matrix(e){this._matrix.set(e||Hw),c.quaternionToRotationMat4(this._quaternion,this._worldRotationMatrix),c.conjugateQuaternion(this._quaternion,this._conjugateQuaternion),c.quaternionToRotationMat4(this._quaternion,this._worldRotationMatrixConjugate),this._matrix.set(this._worldRotationMatrix),c.translateMat4v(this._position,this._matrix),this._matrixDirty=!1,this._setWorldMatrixDirty(),this._sceneModelDirty(),this.glRedraw()}get matrix(){return this._matrixDirty&&this._rebuildMatrices(),this._matrix}get rotationMatrix(){return this._matrixDirty&&this._rebuildMatrices(),this._worldRotationMatrix}_rebuildMatrices(){this._matrixDirty&&(c.quaternionToRotationMat4(this._quaternion,this._worldRotationMatrix),c.conjugateQuaternion(this._quaternion,this._conjugateQuaternion),c.quaternionToRotationMat4(this._quaternion,this._worldRotationMatrixConjugate),this._matrix.set(this._worldRotationMatrix),c.translateMat4v(this._position,this._matrix),this._matrixDirty=!1)}get rotationMatrixConjugate(){return this._matrixDirty&&this._rebuildMatrices(),this._worldRotationMatrixConjugate}_setWorldMatrixDirty(){this._matrixDirty=!0,this._aabbDirty=!0}_transformDirty(){this._matrixDirty=!0,this._aabbDirty=!0,this.scene._aabbDirty=!0}_sceneModelDirty(){this.scene._aabbDirty=!0,this._aabbDirty=!0,this.scene._aabbDirty=!0,this._matrixDirty=!0;for(let e=0,t=this._entityList.length;e<t;e++)this._entityList[e]._sceneModelDirty()}get worldMatrix(){return this.matrix}get worldNormalMatrix(){return this._worldNormalMatrix}get viewMatrix(){return this._viewMatrix?(this._matrixDirty&&(this._rebuildMatrices(),this._viewMatrixDirty=!0),this._viewMatrixDirty&&(c.mulMat4(this.scene.camera.viewMatrix,this._matrix,this._viewMatrix),c.inverseMat4(this._viewMatrix,this._viewNormalMatrix),c.transposeMat4(this._viewNormalMatrix),this._viewMatrixDirty=!1),this._viewMatrix):this.scene.camera.viewMatrix}get viewNormalMatrix(){return this._viewNormalMatrix?(this._matrixDirty&&(this._rebuildMatrices(),this._viewMatrixDirty=!0),this._viewMatrixDirty&&(c.mulMat4(this.scene.camera.viewMatrix,this._matrix,this._viewMatrix),c.inverseMat4(this._viewMatrix,this._viewNormalMatrix),c.transposeMat4(this._viewNormalMatrix),this._viewMatrixDirty=!1),c.inverseMat4(this._viewMatrix,this._viewNormalMatrix),c.transposeMat4(this._viewNormalMatrix),this._viewNormalMatrix):this.scene.camera.viewNormalMatrix}get backfaces(){return this._backfaces}set backfaces(e){e=!!e,this._backfaces=e,this.glRedraw()}get entityList(){return this._entityList}get isEntity(){return!0}get isModel(){return this._isModel}get isObject(){return!1}get aabb(){if(this._aabbDirty){c.collapseAABB3(this._aabb);for(let e=0,t=this._entityList.length;e<t;e++)c.expandAABB3(this._aabb,this._entityList[e].aabb);this._aabbDirty=!1}return this._aabb}get numTriangles(){return this._numTriangles}get numLines(){return this._numLines}get numPoints(){return this._numPoints}get visible(){return this.numVisibleLayerPortions>0}set visible(e){e=e!==!1,this._visible=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].visible=e;this.glRedraw()}get xrayed(){return this.numXRayedLayerPortions>0}set xrayed(e){e=!!e,this._xrayed=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].xrayed=e;this.glRedraw()}get highlighted(){return this.numHighlightedLayerPortions>0}set highlighted(e){e=!!e,this._highlighted=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].highlighted=e;this.glRedraw()}get selected(){return this.numSelectedLayerPortions>0}set selected(e){e=!!e,this._selected=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].selected=e;this.glRedraw()}get edges(){return this.numEdgesLayerPortions>0}set edges(e){e=!!e,this._edges=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].edges=e;this.glRedraw()}get culled(){return this._culled}set culled(e){e=!!e,this._culled=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].culled=e;this.glRedraw()}get clippable(){return this._clippable}set clippable(e){e=e!==!1,this._clippable=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].clippable=e;this.glRedraw()}get collidable(){return this._collidable}set collidable(e){e=e!==!1,this._collidable=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].collidable=e}get pickable(){return this.numPickableLayerPortions>0}set pickable(e){e=e!==!1,this._pickable=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].pickable=e}get colorize(){return this._colorize}set colorize(e){this._colorize=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].colorize=e}get opacity(){return this._opacity}set opacity(e){this._opacity=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].opacity=e}get castsShadow(){return this._castsShadow}set castsShadow(e){e=e!==!1,e!==this._castsShadow&&(this._castsShadow=e,this.glRedraw())}get receivesShadow(){return this._receivesShadow}set receivesShadow(e){e=e!==!1,e!==this._receivesShadow&&(this._receivesShadow=e,this.glRedraw())}get saoEnabled(){return this._saoEnabled}get pbrEnabled(){return this._pbrEnabled}get colorTextureEnabled(){return this._colorTextureEnabled}get isDrawable(){return!0}get isStateSortable(){return!1}get xrayMaterial(){return this.scene.xrayMaterial}get highlightMaterial(){return this.scene.highlightMaterial}get selectedMaterial(){return this.scene.selectedMaterial}get edgeMaterial(){return this.scene.edgeMaterial}getPickViewMatrix(e){return this._viewMatrix?this._viewMatrix:e}createQuantizationRange(e){if(e.id===void 0||e.id===null){this.error("[createQuantizationRange] Config missing: id");return}if(e.aabb){this.error("[createQuantizationRange] Config missing: aabb");return}if(this._quantizationRanges[e.id]){this.error("[createQuantizationRange] QuantizationRange already created: "+e.id);return}this._quantizationRanges[e.id]={id:e.id,aabb:e.aabb,matrix:dA(e.aabb,c.mat4())}}createGeometry(e){if(e.id===void 0||e.id===null){this.error("[createGeometry] Config missing: id");return}if(this._geometries[e.id]){this.error("[createGeometry] Geometry already created: "+e.id);return}if((e.primitive===void 0||e.primitive===null)&&(e.primitive="triangles"),e.primitive!=="points"&&e.primitive!=="lines"&&e.primitive!=="triangles"&&e.primitive!=="solid"&&e.primitive!=="surface"){this.error(`[createGeometry] Unsupported value for 'primitive': '${e.primitive}' - supported values are 'points', 'lines', 'triangles', 'solid' and 'surface'. Defaulting to 'triangles'.`);return}if(!e.positions&&!e.positionsCompressed&&!e.buckets)return this.error("[createGeometry] Param expected: `positions`,  `positionsCompressed' or 'buckets"),null;if(e.positionsCompressed&&!e.positionsDecodeMatrix&&!e.positionsDecodeBoundary)return this.error("[createGeometry] Param expected: `positionsDecodeMatrix` or 'positionsDecodeBoundary' (required for `positionsCompressed')"),null;if(e.positionsDecodeMatrix&&e.positionsDecodeBoundary)return this.error("[createGeometry] Only one of these params expected: `positionsDecodeMatrix` or 'positionsDecodeBoundary' (required for `positionsCompressed')"),null;if(e.uvCompressed&&!e.uvDecodeMatrix)return this.error("[createGeometry] Param expected: `uvDecodeMatrix` (required for `uvCompressed')"),null;if(!e.buckets&&!e.indices&&(e.primitive==="triangles"||e.primitive==="solid"||e.primitive==="surface")){const t=(e.positions||e.positionsCompressed).length/3;e.indices=this._createDefaultIndices(t)}if(!e.buckets&&!e.indices&&e.primitive!=="points")return this.error(`[createGeometry] Param expected: indices (required for '${e.primitive}' primitive type)`),null;if(e.positionsDecodeBoundary&&(e.positionsDecodeMatrix=dA(e.positionsDecodeBoundary,c.mat4())),e.positions){const t=c.collapseAABB3();e.positionsDecodeMatrix=c.mat4(),c.expandAABB3Points3(t,e.positions),e.positionsCompressed=Do(e.positions,t,e.positionsDecodeMatrix),e.aabb=t}else if(e.positionsCompressed){const t=c.collapseAABB3();e.positionsDecodeMatrix=new Float64Array(e.positionsDecodeMatrix),e.positionsCompressed=new Uint16Array(e.positionsCompressed),c.expandAABB3Points3(t,e.positionsCompressed),st.decompressAABB(t,e.positionsDecodeMatrix),e.aabb=t}else if(e.buckets){const t=c.collapseAABB3();this._dtxBuckets[e.id]=e.buckets;for(let i=0,s=e.buckets.length;i<s;i++){const o=e.buckets[i];o.positions?c.expandAABB3Points3(t,o.positions):o.positionsCompressed&&c.expandAABB3Points3(t,o.positionsCompressed)}e.positionsDecodeMatrix&&st.decompressAABB(t,e.positionsDecodeMatrix),e.aabb=t}if(e.colorsCompressed&&e.colorsCompressed.length>0)e.colorsCompressed=new Uint8Array(e.colorsCompressed);else if(e.colors&&e.colors.length>0){const t=e.colors,i=new Uint8Array(t.length);for(let s=0,o=t.length;s<o;s++)i[s]=t[s]*255;e.colorsCompressed=i}if(!e.buckets&&!e.edgeIndices&&(e.primitive==="triangles"||e.primitive==="solid"||e.primitive==="surface")&&(e.positions?e.edgeIndices=us(e.positions,e.indices,null,5):e.edgeIndices=us(e.positionsCompressed,e.indices,e.positionsDecodeMatrix,2)),e.uv){const t=st.getUVBounds(e.uv),i=st.compressUVs(e.uv,t.min,t.max);e.uvCompressed=i.quantized,e.uvDecodeMatrix=i.decodeMatrix}else e.uvCompressed&&(e.uvCompressed=new Uint16Array(e.uvCompressed),e.uvDecodeMatrix=new Float64Array(e.uvDecodeMatrix));e.normals&&(e.normals=null),this._geometries[e.id]=e,this._numTriangles+=e.indices?Math.round(e.indices.length/3):0,this.numGeometries++}createTexture(e){const t=e.id;if(t==null){this.error("[createTexture] Config missing: id");return}if(this._textures[t]){this.error("[createTexture] Texture already created: "+t);return}if(!e.src&&!e.image&&!e.buffers)return this.error("[createTexture] Param expected: `src`, `image' or 'buffers'"),null;let i=e.minFilter||yo;i!==Qi&&i!==Pc&&i!==yo&&i!==aa&&i!==Bc&&(this.error(`[createTexture] Unsupported value for 'minFilter' - 
            supported values are LinearFilter, LinearMipMapNearestFilter, NearestMipMapNearestFilter, 
            NearestMipMapLinearFilter and LinearMipmapLinearFilter. Defaulting to LinearMipmapLinearFilter.`),i=yo);let s=e.magFilter||Qi;s!==Qi&&s!==To&&(this.error("[createTexture] Unsupported value for 'magFilter' - supported values are LinearFilter and NearestFilter. Defaulting to LinearFilter."),s=Qi);let o=e.wrapS||Ht;o!==Ls&&o!==Pr&&o!==Ht&&(this.error("[createTexture] Unsupported value for 'wrapS' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),o=Ht);let n=e.wrapT||Ht;n!==Ls&&n!==Pr&&n!==Ht&&(this.error("[createTexture] Unsupported value for 'wrapT' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),n=Ht);let a=e.wrapR||Ht;a!==Ls&&a!==Pr&&a!==Ht&&(this.error("[createTexture] Unsupported value for 'wrapR' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),a=Ht);let A=e.encoding||yr;A!==yr&&A!==wt&&(this.error("[createTexture] Unsupported value for 'encoding' - supported values are LinearEncoding and sRGBEncoding. Defaulting to LinearEncoding."),A=yr);const l=new Xs({gl:this.scene.canvas.gl,minFilter:i,magFilter:s,wrapS:o,wrapT:n,wrapR:a,encoding:A});if(e.preloadColor&&l.setPreloadColor(e.preloadColor),e.image){const h=e.image;h.crossOrigin="Anonymous",l.setImage(h,{minFilter:i,magFilter:s,wrapS:o,wrapT:n,wrapR:a,flipY:e.flipY,encoding:A})}else if(e.src){const h=e.src.split(".").pop();switch(h){case"jpeg":case"jpg":case"png":case"gif":const d=new Image;d.onload=()=>{l.setImage(d,{minFilter:i,magFilter:s,wrapS:o,wrapT:n,wrapR:a,flipY:e.flipY,encoding:A}),this.glRedraw()},d.src=e.src;break;default:this._textureTranscoder?Se.loadArraybuffer(e.src,f=>{if(!f.byteLength){this.error("[createTexture] Can't create texture from 'src': file data is zero length");return}this._textureTranscoder.transcode([f],l).then(()=>{this.glRedraw()})},function(f){this.error(`[createTexture] Can't create texture from 'src': ${f}`)}):this.error(`[createTexture] Can't create texture from 'src' - SceneModel needs to be configured with a TextureTranscoder for this file type ('${h}')`);break}}else e.buffers&&(this._textureTranscoder?this._textureTranscoder.transcode(e.buffers,l).then(()=>{this.glRedraw()}):this.error("[createTexture] Can't create texture from 'buffers' - SceneModel needs to be configured with a TextureTranscoder for this option"));this._textures[t]=new Js({id:t,texture:l})}createTextureSet(e){const t=e.id;if(t==null){this.error("[createTextureSet] Config missing: id");return}if(this._textureSets[t]){this.error(`[createTextureSet] Texture set already created: ${t}`);return}let i;if(e.colorTextureId!==void 0&&e.colorTextureId!==null){if(i=this._textures[e.colorTextureId],!i){this.error(`[createTextureSet] Texture not found: ${e.colorTextureId} - ensure that you create it first with createTexture()`);return}}else i=this._textures[SA];let s;if(e.metallicRoughnessTextureId!==void 0&&e.metallicRoughnessTextureId!==null){if(s=this._textures[e.metallicRoughnessTextureId],!s){this.error(`[createTextureSet] Texture not found: ${e.metallicRoughnessTextureId} - ensure that you create it first with createTexture()`);return}}else s=this._textures[TA];let o;if(e.normalsTextureId!==void 0&&e.normalsTextureId!==null){if(o=this._textures[e.normalsTextureId],!o){this.error(`[createTextureSet] Texture not found: ${e.normalsTextureId} - ensure that you create it first with createTexture()`);return}}else o=this._textures[DA];let n;if(e.emissiveTextureId!==void 0&&e.emissiveTextureId!==null){if(n=this._textures[e.emissiveTextureId],!n){this.error(`[createTextureSet] Texture not found: ${e.emissiveTextureId} - ensure that you create it first with createTexture()`);return}}else n=this._textures[RA];let a;if(e.occlusionTextureId!==void 0&&e.occlusionTextureId!==null){if(a=this._textures[e.occlusionTextureId],!a){this.error(`[createTextureSet] Texture not found: ${e.occlusionTextureId} - ensure that you create it first with createTexture()`);return}}else a=this._textures[LA];const A=new ed({id:t,model:this,colorTexture:i,metallicRoughnessTexture:s,normalsTexture:o,emissiveTexture:n,occlusionTexture:a});return this._textureSets[t]=A,A}createTransform(e){if(e.id===void 0||e.id===null){this.error("[createTransform] SceneModel.createTransform() config missing: id");return}if(this._transforms[e.id]){this.error(`[createTransform] SceneModel already has a transform with this ID: ${e.id}`);return}let t;if(e.parentTransformId&&(t=this._transforms[e.parentTransformId],!t)){this.error("[createTransform] SceneModel.createTransform() config missing: id");return}const i=new Qw({id:e.id,model:this,parent:t,matrix:e.matrix,position:e.position,scale:e.scale,rotation:e.rotation,quaternion:e.quaternion});return this._transforms[i.id]=i,i}createMesh(e){if(e.id===void 0||e.id===null)return this.error("[createMesh] SceneModel.createMesh() config missing: id"),!1;if(this._meshes[e.id])return this.error(`[createMesh] SceneModel already has a mesh with this ID: ${e.id}`),!1;if(!(e.geometryId!==void 0)){if((e.primitive===void 0||e.primitive===null)&&(e.primitive="triangles"),e.primitive!=="points"&&e.primitive!=="lines"&&e.primitive!=="triangles"&&e.primitive!=="solid"&&e.primitive!=="surface")return this.error(`Unsupported value for 'primitive': '${primitive}'  ('geometryId' is absent) - supported values are 'points', 'lines', 'triangles', 'solid' and 'surface'.`),!1;if(!e.positions&&!e.positionsCompressed&&!e.buckets)return this.error("Param expected: 'positions',  'positionsCompressed' or `buckets`  ('geometryId' is absent)"),!1;if(e.positions&&(e.positionsDecodeMatrix||e.positionsDecodeBoundary))return this.error("Illegal params: 'positions' not expected with 'positionsDecodeMatrix'/'positionsDecodeBoundary' ('geometryId' is absent)"),!1;if(e.positionsCompressed&&!e.positionsDecodeMatrix&&!e.positionsDecodeBoundary)return this.error("Param expected: 'positionsCompressed' should be accompanied by 'positionsDecodeMatrix'/'positionsDecodeBoundary' ('geometryId' is absent)"),!1;if(e.uvCompressed&&!e.uvDecodeMatrix)return this.error("Param expected: 'uvCompressed' should be accompanied by `uvDecodeMatrix` ('geometryId' is absent)"),!1;if(!e.buckets&&!e.indices&&(e.primitive==="triangles"||e.primitive==="solid"||e.primitive==="surface")){const o=(e.positions||e.positionsCompressed).length/3;e.indices=this._createDefaultIndices(o)}if(!e.buckets&&!e.indices&&e.primitive!=="points")return e.indices=this._createDefaultIndices(numIndices),this.error(`Param expected: indices (required for '${e.primitive}' primitive type)`),!1;if((e.matrix||e.position||e.rotation||e.scale)&&(e.positionsCompressed||e.positionsDecodeBoundary))return this.error("Unexpected params: 'matrix', 'rotation', 'scale', 'position' not allowed with 'positionsCompressed'"),!1;const s=!!this._dtxEnabled&&(e.primitive==="triangles"||e.primitive==="solid"||e.primitive==="surface")&&!e.textureSetId;if(e.origin=e.origin?c.addVec3(this._origin,e.origin,c.vec3()):this._origin,e.matrix)e.meshMatrix=e.matrix;else if(e.scale||e.rotation||e.position||e.quaternion){const o=e.scale||nd,n=e.position||ad;e.rotation?(c.eulerToQuaternion(e.rotation,"XYZ",Pn),e.meshMatrix=c.composeMat4(n,Pn,o,c.mat4())):e.meshMatrix=c.composeMat4(n,e.quaternion||Ad,o,c.mat4())}if(e.positionsDecodeBoundary&&(e.positionsDecodeMatrix=dA(e.positionsDecodeBoundary,c.mat4())),s){if(e.type=Zs,e.color=e.color?new Uint8Array([Math.floor(e.color[0]*255),Math.floor(e.color[1]*255),Math.floor(e.color[2]*255)]):UA,e.opacity=e.opacity!==void 0&&e.opacity!==null?Math.floor(e.opacity*255):255,e.positions){const o=c.vec3(),n=[];Cl(e.positions,n,o)&&(e.positions=n,e.origin=c.addVec3(e.origin,o,o))}if(e.positions){const o=c.collapseAABB3();e.positionsDecodeMatrix=c.mat4(),c.expandAABB3Points3(o,e.positions),e.positionsCompressed=Do(e.positions,o,e.positionsDecodeMatrix),e.aabb=o}else if(e.positionsCompressed){const o=c.collapseAABB3();c.expandAABB3Points3(o,e.positionsCompressed),st.decompressAABB(o,e.positionsDecodeMatrix),e.aabb=o}if(e.buckets){const o=c.collapseAABB3();for(let n=0,a=e.buckets.length;n<a;n++){const A=e.buckets[n];A.positions?c.expandAABB3Points3(o,A.positions):A.positionsCompressed&&c.expandAABB3Points3(o,A.positionsCompressed)}e.positionsDecodeMatrix&&st.decompressAABB(o,e.positionsDecodeMatrix),e.aabb=o}e.meshMatrix&&(c.AABB3ToOBB3(e.aabb,qi),c.transformOBB3(e.meshMatrix,qi),c.OBB3ToAABB3(qi,e.aabb)),!e.buckets&&!e.edgeIndices&&(e.primitive==="triangles"||e.primitive==="solid"||e.primitive==="surface")&&(e.positions?e.edgeIndices=us(e.positions,e.indices,null,2):e.edgeIndices=us(e.positionsCompressed,e.indices,e.positionsDecodeMatrix,2)),e.buckets||(e.buckets=cd(e,this._enableVertexWelding&&this._enableIndexBucketing))}else{if(e.type=ro,e.color=e.color?new Uint8Array([Math.floor(e.color[0]*255),Math.floor(e.color[1]*255),Math.floor(e.color[2]*255)]):[255,255,255],e.opacity=e.opacity!==void 0&&e.opacity!==null?Math.floor(e.opacity*255):255,e.metallic=e.metallic!==void 0&&e.metallic!==null?Math.floor(e.metallic*255):0,e.roughness=e.roughness!==void 0&&e.roughness!==null?Math.floor(e.roughness*255):255,e.positions){const o=[];Cl(e.positions,o,od)&&(e.positions=o,e.origin=c.addVec3(e.origin,od,c.vec3()))}if(e.positions){const o=c.collapseAABB3();e.meshMatrix&&(c.transformPositions3(e.meshMatrix,e.positions,e.positions),e.meshMatrix=null),c.expandAABB3Points3(o,e.positions),e.aabb=o}else{const o=c.collapseAABB3();c.expandAABB3Points3(o,e.positionsCompressed),st.decompressAABB(o,e.positionsDecodeMatrix),e.aabb=o}if(e.meshMatrix&&(c.AABB3ToOBB3(e.aabb,qi),c.transformOBB3(e.meshMatrix,qi),c.OBB3ToAABB3(qi,e.aabb)),!e.buckets&&!e.edgeIndices&&(e.primitive==="triangles"||e.primitive==="solid"||e.primitive==="surface")&&(e.positions?e.edgeIndices=us(e.positions,e.indices,null,2):e.edgeIndices=us(e.positionsCompressed,e.indices,e.positionsDecodeMatrix,2)),e.textureSetId&&(e.textureSet=this._textureSets[e.textureSetId],!e.textureSet))return this.error(`[createMesh] Texture set not found: ${e.textureSetId} - ensure that you create it first with createTextureSet()`),!1}}else{if(e.positions||e.positionsCompressed||e.indices||e.edgeIndices||e.normals||e.normalsCompressed||e.uv||e.uvCompressed||e.positionsDecodeMatrix)return this.error("Mesh geometry parameters not expected when instancing a geometry (not expected: positions, positionsCompressed, indices, edgeIndices, normals, normalsCompressed, uv, uvCompressed, positionsDecodeMatrix)"),!1;if(e.geometry=this._geometries[e.geometryId],!e.geometry)return this.error(`[createMesh] Geometry not found: ${e.geometryId} - ensure that you create it first with createGeometry()`),!1;if(e.origin=e.origin?c.addVec3(this._origin,e.origin,c.vec3()):this._origin,e.positionsDecodeMatrix=e.geometry.positionsDecodeMatrix,e.transformId){if(e.transform=this._transforms[e.transformId],!e.transform)return this.error(`[createMesh] Transform not found: ${e.transformId} - ensure that you create it first with createTransform()`),!1;e.aabb=e.geometry.aabb}else{if(e.matrix)e.meshMatrix=e.matrix;else if(e.scale||e.rotation||e.position||e.quaternion){const o=e.scale||nd,n=e.position||ad;e.rotation?(c.eulerToQuaternion(e.rotation,"XYZ",Pn),e.meshMatrix=c.composeMat4(n,Pn,o,c.mat4())):e.meshMatrix=c.composeMat4(n,e.quaternion||Ad,o,c.mat4())}c.AABB3ToOBB3(e.geometry.aabb,qi),c.transformOBB3(e.meshMatrix,qi),e.aabb=c.OBB3ToAABB3(qi,c.AABB3())}if(!!this._dtxEnabled&&(e.geometry.primitive==="triangles"||e.geometry.primitive==="solid"||e.geometry.primitive==="surface")&&!e.textureSetId){e.type=Zs,e.color=e.color?new Uint8Array([Math.floor(e.color[0]*255),Math.floor(e.color[1]*255),Math.floor(e.color[2]*255)]):UA,e.opacity=e.opacity!==void 0&&e.opacity!==null?Math.floor(e.opacity*255):255;let o=this._dtxBuckets[e.geometryId];o||(o=cd(e.geometry,this._enableVertexWelding,this._enableIndexBucketing),this._dtxBuckets[e.geometryId]=o),e.buckets=o}else e.type=so,e.color=e.color?new Uint8Array([Math.floor(e.color[0]*255),Math.floor(e.color[1]*255),Math.floor(e.color[2]*255)]):UA,e.opacity=e.opacity!==void 0&&e.opacity!==null?Math.floor(e.opacity*255):255,e.metallic=e.metallic!==void 0&&e.metallic!==null?Math.floor(e.metallic*255):0,e.roughness=e.roughness!==void 0&&e.roughness!==null?Math.floor(e.roughness*255):255,e.textureSetId&&(e.textureSet=this._textureSets[e.textureSetId])}return e.numPrimitives=this._getNumPrimitives(e),this._createMesh(e)}_createMesh(e){const t=new DB(this,e.id,e.color,e.opacity,e.transform,e.textureSet);t.pickId=this.scene._renderer.getPickID(t);const i=t.pickId,s=i>>24&255,o=i>>16&255,n=i>>8&255,a=i&255;switch(e.pickColor=new Uint8Array([a,n,o,s]),e.solid=e.primitive==="solid",t.origin=c.vec3(e.origin),e.type){case Zs:t.layer=this._getDTXLayer(e),t.aabb=e.aabb;break;case ro:t.layer=this._getVBOBatchingLayer(e),t.aabb=e.aabb;break;case so:t.layer=this._getVBOInstancingLayer(e),t.aabb=e.aabb;break}return e.transform&&(e.meshMatrix=e.transform.worldMatrix),t.portionId=t.layer.createPortion(t,e),this._meshes[e.id]=t,this._unusedMeshes[e.id]=t,this._meshList.push(t),t}_getNumPrimitives(e){let t=0;switch(e.geometry?e.geometry.primitive:e.primitive){case"triangles":case"solid":case"surface":switch(e.type){case Zs:for(let s=0,o=e.buckets.length;s<o;s++)t+=e.buckets[s].indices.length;break;case ro:t+=e.indices.length;break;case so:t+=e.geometry.indices.length;break}return Math.round(t/3);case"points":switch(e.type){case Zs:for(let o=0,n=e.buckets.length;o<n;o++)t+=e.buckets[o].positionsCompressed.length;break;case ro:t+=e.positions?e.positions.length:e.positionsCompressed.length;break;case so:const s=e.geometry;t+=s.positions?s.positions.length:s.positionsCompressed.length;break}return Math.round(t);case"lines":case"line-strip":switch(e.type){case Zs:for(let s=0,o=e.buckets.length;s<o;s++)t+=e.buckets[s].indices.length;break;case ro:t+=e.indices.length;break;case so:t+=e.geometry.indices.length;break}return Math.round(t/2)}return 0}_getDTXLayer(e){const t=e.origin,i=e.geometry?e.geometry.primitive:e.primitive,s=`.${i}.${Math.round(t[0])}.${Math.round(t[1])}.${Math.round(t[2])}`;let o=this._dtxLayers[s];if(o)if(!o.canCreatePortion(e))o.finalize(),delete this._dtxLayers[s],o=null;else return o;switch(i){case"triangles":case"solid":case"surface":o=new Bw(this,{layerIndex:0,origin:t});break;case"lines":o=new yx(this,{layerIndex:0,origin:t});break;default:return}return this._dtxLayers[s]=o,this.layerList.push(o),o}_getVBOBatchingLayer(e){const t=this,i=e.origin,s=e.positionsDecodeMatrix||e.positionsDecodeBoundary?this._createHashStringFromMatrix(e.positionsDecodeMatrix||e.positionsDecodeBoundary):"-",o=e.textureSetId||"-",n=`${Math.round(i[0])}.${Math.round(i[1])}.${Math.round(i[2])}.${e.primitive}.${s}.${o}`;let a=this._vboBatchingLayers[n];if(a)return a;let A=e.textureSet;for(;!a;){switch(e.primitive){case"triangles":a=new pA({model:t,textureSet:A,layerIndex:0,scratchMemory:this._vboBatchingLayerScratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,uvDecodeMatrix:e.uvDecodeMatrix,origin:i,maxGeometryBatchSize:this._maxGeometryBatchSize,solid:e.primitive==="solid",autoNormals:!0});break;case"solid":a=new pA({model:t,textureSet:A,layerIndex:0,scratchMemory:this._vboBatchingLayerScratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,uvDecodeMatrix:e.uvDecodeMatrix,origin:i,maxGeometryBatchSize:this._maxGeometryBatchSize,solid:e.primitive==="solid",autoNormals:!0});break;case"surface":a=new pA({model:t,textureSet:A,layerIndex:0,scratchMemory:this._vboBatchingLayerScratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,uvDecodeMatrix:e.uvDecodeMatrix,origin:i,maxGeometryBatchSize:this._maxGeometryBatchSize,solid:e.primitive==="solid",autoNormals:!0});break;case"lines":a=new cy({model:t,layerIndex:0,scratchMemory:this._vboBatchingLayerScratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,uvDecodeMatrix:e.uvDecodeMatrix,origin:i,maxGeometryBatchSize:this._maxGeometryBatchSize});break;case"points":a=new jy({model:t,layerIndex:0,scratchMemory:this._vboBatchingLayerScratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,uvDecodeMatrix:e.uvDecodeMatrix,origin:i,maxGeometryBatchSize:this._maxGeometryBatchSize});break}const l=e.positionsCompressed?e.positionsCompressed.length:e.positions.length;(e.primitive==="points"?a.canCreatePortion(l):a.canCreatePortion(l,e.indices.length))||(a.finalize(),delete this._vboBatchingLayers[n],a=null)}return this._vboBatchingLayers[n]=a,this.layerList.push(a),a}_createHashStringFromMatrix(e){const t=e.join("");let i=0;for(let o=0;o<t.length;o++){const n=t.charCodeAt(o);i=(i<<5)-i+n,i|=0}return(i>>>0).toString(16)}_getVBOInstancingLayer(e){const t=this,i=e.origin,s=e.textureSetId||"-",o=e.geometryId,n=`${Math.round(i[0])}.${Math.round(i[1])}.${Math.round(i[2])}.${s}.${o}`;let a=this._vboInstancingLayers[n];if(a)return a;let A=e.textureSet;const l=e.geometry;for(;!a;)switch(l.primitive){case"triangles":a=new gA({model:t,textureSet:A,geometry:l,origin:i,layerIndex:0,solid:!1});break;case"solid":a=new gA({model:t,textureSet:A,geometry:l,origin:i,layerIndex:0,solid:!0});break;case"surface":a=new gA({model:t,textureSet:A,geometry:l,origin:i,layerIndex:0,solid:!1});break;case"lines":a=new xy({model:t,textureSet:A,geometry:l,origin:i,layerIndex:0});break;case"points":a=new cx({model:t,textureSet:A,geometry:l,origin:i,layerIndex:0});break}return this._vboInstancingLayers[n]=a,this.layerList.push(a),a}createEntity(e){if(e.id===void 0?e.id=c.createUUID():this.scene.components[e.id]&&(this.error(`Scene already has a Component with this ID: ${e.id} - will assign random ID`),e.id=c.createUUID()),e.meshIds===void 0){this.error("Config missing: meshIds");return}let t=0;this._visible&&e.visible!==!1&&(t=t|k.VISIBLE),this._pickable&&e.pickable!==!1&&(t=t|k.PICKABLE),this._culled&&e.culled!==!1&&(t=t|k.CULLED),this._clippable&&e.clippable!==!1&&(t=t|k.CLIPPABLE),this._collidable&&e.collidable!==!1&&(t=t|k.COLLIDABLE),this._edges&&e.edges!==!1&&(t=t|k.EDGES),this._xrayed&&e.xrayed!==!1&&(t=t|k.XRAYED),this._highlighted&&e.highlighted!==!1&&(t=t|k.HIGHLIGHTED),this._selected&&e.selected!==!1&&(t=t|k.SELECTED),e.flags=t,this._createEntity(e)}_createEntity(e){let t=[];for(let o=0,n=e.meshIds.length;o<n;o++){const a=e.meshIds[o];let A=this._meshes[a];if(!A){this.error(`Mesh with this ID not found: "${a}" - ignoring this mesh`);continue}if(A.parent){this.error(`Mesh with ID "${a}" already belongs to object with ID "${A.parent.id}" - ignoring this mesh`);continue}t.push(A),delete this._unusedMeshes[a]}const i=!0,s=new x0(this,e.isObject,e.id,t,e.flags,i);this._entityList.push(s),this._entities[e.id]=s,this.numEntities++}finalize(){if(!this.destroyed){this._createDummyEntityForUnusedMeshes();for(let e=0,t=this.layerList.length;e<t;e++)this.layerList[e].finalize();this._geometries={},this._dtxBuckets={},this._textures={},this._textureSets={},this._dtxLayers={},this._vboInstancingLayers={},this._vboBatchingLayers={};for(let e=0,t=this._entityList.length;e<t;e++)this._entityList[e]._finalize();for(let e=0,t=this._entityList.length;e<t;e++)this._entityList[e]._finalize2();this.layerList.sort((e,t)=>e.sortId<t.sortId?-1:e.sortId>t.sortId?1:0);for(let e=0,t=this.layerList.length;e<t;e++){const i=this.layerList[e];i.layerIndex=e}this.glRedraw(),this.scene._aabbDirty=!0,this._viewMatrixDirty=!0,this._matrixDirty=!0,this._aabbDirty=!0,this._setWorldMatrixDirty(),this._sceneModelDirty(),this.position=this._position}}stateSortCompare(e,t){}rebuildRenderFlags(){if(this.renderFlags.reset(),this._updateRenderFlagsVisibleLayers(),this.renderFlags.numLayers>0&&this.renderFlags.numVisibleLayers===0){this.renderFlags.culled=!0;return}this._updateRenderFlags()}_updateRenderFlagsVisibleLayers(){const e=this.renderFlags;e.numLayers=this.layerList.length,e.numVisibleLayers=0;for(let t=0,i=this.layerList.length;t<i;t++){const s=this.layerList[t];this._getActiveSectionPlanesForLayer(s)&&(e.visibleLayers[e.numVisibleLayers++]=t)}}_createDummyEntityForUnusedMeshes(){const e=Object.keys(this._unusedMeshes);if(e.length>0){const t=`${this.id}-dummyEntityForUnusedMeshes`;this.warn(`Creating dummy SceneModelEntity "${t}" for unused SceneMeshes: [${e.join(",")}]`),this.createEntity({id:t,meshIds:e,isObject:!0})}this._unusedMeshes={}}_getActiveSectionPlanesForLayer(e){const t=this.renderFlags,i=this.scene._sectionPlanesState.sectionPlanes,s=i.length,o=e.layerIndex*s;if(s>0)for(let n=0;n<s;n++)i[n].active?(t.sectionPlanesActivePerLayer[o+n]=!0,t.sectioned=!0):t.sectionPlanesActivePerLayer[o+n]=!1;return!0}_updateRenderFlags(){if(this.numVisibleLayerPortions===0||this.numCulledLayerPortions===this.numPortions)return;const e=this.renderFlags;if(e.colorOpaque=this.numTransparentLayerPortions<this.numPortions,this.numTransparentLayerPortions>0&&(e.colorTransparent=!0),this.numXRayedLayerPortions>0){const t=this.scene.xrayMaterial._state;t.fill&&(t.fillAlpha<1?e.xrayedSilhouetteTransparent=!0:e.xrayedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.xrayedEdgesTransparent=!0:e.xrayedEdgesOpaque=!0)}if(this.numEdgesLayerPortions>0&&this.scene.edgeMaterial._state.edges&&(e.edgesOpaque=this.numTransparentLayerPortions<this.numPortions,this.numTransparentLayerPortions>0&&(e.edgesTransparent=!0)),this.numSelectedLayerPortions>0){const t=this.scene.selectedMaterial._state;t.fill&&(t.fillAlpha<1?e.selectedSilhouetteTransparent=!0:e.selectedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.selectedEdgesTransparent=!0:e.selectedEdgesOpaque=!0)}if(this.numHighlightedLayerPortions>0){const t=this.scene.highlightMaterial._state;t.fill&&(t.fillAlpha<1?e.highlightedSilhouetteTransparent=!0:e.highlightedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.highlightedEdgesTransparent=!0:e.highlightedEdgesOpaque=!0)}}drawColorOpaque(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawColorOpaque(t,e)}}drawColorTransparent(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawColorTransparent(t,e)}}drawDepth(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawDepth(t,e)}}drawNormals(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawNormals(t,e)}}drawSilhouetteXRayed(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawSilhouetteXRayed(t,e)}}drawSilhouetteHighlighted(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawSilhouetteHighlighted(t,e)}}drawSilhouetteSelected(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawSilhouetteSelected(t,e)}}drawEdgesColorOpaque(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawEdgesColorOpaque(t,e)}}drawEdgesColorTransparent(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawEdgesColorTransparent(t,e)}}drawEdgesXRayed(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawEdgesXRayed(t,e)}}drawEdgesHighlighted(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawEdgesHighlighted(t,e)}}drawEdgesSelected(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawEdgesSelected(t,e)}}drawOcclusion(e){if(this.numVisibleLayerPortions===0)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawOcclusion(t,e)}}drawShadow(e){if(this.numVisibleLayerPortions===0)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawShadow(t,e)}}setPickMatrices(e,t){if(this._numVisibleLayerPortions===0)return;const i=this.renderFlags;for(let s=0,o=i.visibleLayers.length;s<o;s++){const n=i.visibleLayers[s],a=this.layerList[n];a.setPickMatrices&&a.setPickMatrices(e,t)}}drawPickMesh(e){if(this.numVisibleLayerPortions===0)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawPickMesh(t,e)}}drawPickDepths(e){if(this.numVisibleLayerPortions===0)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawPickDepths(t,e)}}drawPickNormals(e){if(this.numVisibleLayerPortions===0)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawPickNormals(t,e)}}drawSnapInit(e){if(this.numVisibleLayerPortions===0)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i],n=this.layerList[o];n.drawSnapInit&&(e.snapPickOrigin=[0,0,0],e.snapPickCoordinateScale=[1,1,1],e.snapPickLayerNumber++,n.drawSnapInit(t,e),e.snapPickLayerParams[e.snapPickLayerNumber]={origin:e.snapPickOrigin.slice(),coordinateScale:e.snapPickCoordinateScale.slice()})}}drawSnap(e){if(this.numVisibleLayerPortions===0)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i],n=this.layerList[o];n.drawSnap&&(e.snapPickOrigin=[0,0,0],e.snapPickCoordinateScale=[1,1,1],e.snapPickLayerNumber++,n.drawSnap(t,e),e.snapPickLayerParams[e.snapPickLayerNumber]={origin:e.snapPickOrigin.slice(),coordinateScale:e.snapPickCoordinateScale.slice()})}}destroy(){for(let e in this._vboBatchingLayers)this._vboBatchingLayers.hasOwnProperty(e)&&this._vboBatchingLayers[e].destroy();this._vboBatchingLayers={};for(let e in this._vboInstancingLayers)this._vboInstancingLayers.hasOwnProperty(e)&&this._vboInstancingLayers[e].destroy();this._vboInstancingLayers={},this.scene.camera.off(this._onCameraViewMatrix),this.scene.off(this._onTick);for(let e=0,t=this.layerList.length;e<t;e++)this.layerList[e].destroy();this.layerList=[];for(let e=0,t=this._entityList.length;e<t;e++)this._entityList[e]._destroy();this._geometries={},this._dtxBuckets={},this._textures={},this._textureSets={},this._meshes={},this._entities={},this.scene._aabbDirty=!0,this._isModel&&this.scene._deregisterModel(this),UB(),super.destroy()}}function cd(r,e,t){let i,s,o;e||t?[i,s,o]=Fw({positionsCompressed:r.positionsCompressed,indices:r.indices,edgeIndices:r.edgeIndices}):(i=r.positionsCompressed,s=r.indices,o=r.edgeIndices);let n;if(t){let a=i.length/3;n=Rw({positionsCompressed:i,indices:s,edgeIndices:o},a>65536?16:8)}else n=[{positionsCompressed:i,indices:s,edgeIndices:o}];return n}c.vec3();c.vec3();c.vec3();c.vec3();c.vec3();class Gw{constructor(){}getMetaModel(e,t,i){Se.loadJSON(e,s=>{t(s)},function(s){i(s)})}getGLTF(e,t,i){Se.loadArraybuffer(e,s=>{t(s)},function(s){i(s)})}getGLB(e,t,i){Se.loadArraybuffer(e,s=>{t(s)},function(s){i(s)})}getArrayBuffer(e,t,i,s){jw(e,t,o=>{i(o)},function(o){s(o)})}}function jw(r,e,t,i){var s=()=>{};t=t||s,i=i||s;const o=/^data:(.*?)(;base64)?,(.*)$/,n=e.match(o);if(n){const l=!!n[2];var a=n[3];a=window.decodeURIComponent(a),l&&(a=window.atob(a));try{const h=new ArrayBuffer(a.length),d=new Uint8Array(h);for(var A=0;A<a.length;A++)d[A]=a.charCodeAt(A);Bt.scheduleTask(function(){t(h)})}catch(h){Bt.scheduleTask(function(){i(h)})}}else{const h=zw(r)+e,d=new XMLHttpRequest;d.open("GET",h,!0),d.responseType="arraybuffer",d.onreadystatechange=function(){d.readyState===4&&(d.status===200?t(d.response):i("loadArrayBuffer error : "+d.response))},d.send(null)}}function zw(r){var e=r.lastIndexOf("/");return e!==0?r.substring(0,e+1):""}class Kw{constructor(e={}){this._eventSubIDMap=null,this._eventSubEvents=null,this._eventSubs=null,this._events=null,this._locale="en",this._messages={},this._locales=[],this._locale="en",this.messages=e.messages,this.locale=e.locale}set messages(e){this._messages=e||{},this._locales=Object.keys(this._messages),this.fire("updated",this)}loadMessages(e={}){for(let t in e)this._messages[t]=e[t];this.messages=this._messages}clearMessages(){this.messages={}}get locales(){return this._locales}set locale(e){e=e||"de",this._locale!==e&&(this._locale=e,this.fire("updated",e))}get locale(){return this._locale}translate(e,t){const i=this._messages[this._locale];if(!i)return null;const s=hd(e,i);return s?t?OA(s,t):s:null}translatePlurals(e,t,i){const s=this._messages[this._locale];if(!s)return null;let o=hd(e,s);return t=parseInt(""+t,10),t===0?o=o.zero:o=t>1?o.other:o.one,o?(o=OA(o,[t]),i&&(o=OA(o,i)),o):null}fire(e,t,i){this._events||(this._events={}),this._eventSubs||(this._eventSubs={}),i!==!0&&(this._events[e]=t||!0);const s=this._eventSubs[e];if(s)for(const o in s)s.hasOwnProperty(o)&&s[o].callback(t)}on(e,t){this._events||(this._events={}),this._eventSubIDMap||(this._eventSubIDMap=new Si),this._eventSubEvents||(this._eventSubEvents={}),this._eventSubs||(this._eventSubs={});let i=this._eventSubs[e];i||(i={},this._eventSubs[e]=i);const s=this._eventSubIDMap.addItem();i[s]={callback:t},this._eventSubEvents[s]=e;const o=this._events[e];return o!==void 0&&t(o),s}off(e){if(e==null||!this._eventSubEvents)return;const t=this._eventSubEvents[e];if(t){delete this._eventSubEvents[e];const i=this._eventSubs[t];i&&delete i[e],this._eventSubIDMap.removeItem(e)}}}function hd(r,e){if(e[r])return e[r];const t=r.split(".");let i=e;for(let s=0,o=t.length;i&&s<o;s++){const n=t[s];i=i[n]}return i}function OA(r,e=[]){return r.replace(/\{\{|\}\}|\{(\d+)\}/g,function(t,i){return t==="{{"?"{":t==="}}"?"}":e[i]})}c.vec3();const kA=c.vec3(),NA=c.vec3(),QA=c.vec3(),ud=c.vec3(),Is=c.vec3();class Us extends It{get type(){return"CameraFlightAnimation"}constructor(e,t={}){super(e,t),this._look1=c.vec3(),this._eye1=c.vec3(),this._up1=c.vec3(),this._look2=c.vec3(),this._eye2=c.vec3(),this._up2=c.vec3(),this._orthoScale1=1,this._orthoScale2=1,this._flying=!1,this._flyEyeLookUp=!1,this._flyingEye=!1,this._flyingLook=!1,this._callback=null,this._callbackScope=null,this._time1=null,this._time2=null,this.easing=t.easing!==!1,this.duration=t.duration,this.fit=t.fit,this.fitFOV=t.fitFOV,this.trail=t.trail}flyTo(e,t,i){e=e||this.scene,this._flying&&this.stop(),this._flying=!1,this._flyingEye=!1,this._flyingLook=!1,this._flyingEyeLookUp=!1,this._callback=t,this._callbackScope=i;const s=this.scene.camera,o=!!e.projection&&e.projection!==s.projection;this._eye1[0]=s.eye[0],this._eye1[1]=s.eye[1],this._eye1[2]=s.eye[2],this._look1[0]=s.look[0],this._look1[1]=s.look[1],this._look1[2]=s.look[2],this._up1[0]=s.up[0],this._up1[1]=s.up[1],this._up1[2]=s.up[2],this._orthoScale1=s.ortho.scale,this._orthoScale2=e.orthoScale||this._orthoScale1;let n,a,A,l,h;if(e.aabb)n=e.aabb;else if(e.length===6)n=e;else if(e.eye&&e.look||e.up)a=e.eye,A=e.look,l=e.up;else if(e.eye)a=e.eye;else if(e.look)A=e.look;else{let f=e;if((Se.isNumeric(f)||Se.isString(f))&&(h=f,f=this.scene.components[h],!f)){this.error("Component not found: "+Se.inQuotes(h)),t&&(i?t.call(i):t());return}o||(n=f.aabb||this.scene.aabb)}const d=e.poi;if(n){if(n[3]<n[0]||n[4]<n[1]||n[5]<n[2]||n[3]===n[0]&&n[4]===n[1]&&n[5]===n[2])return;n=n.slice();const f=c.getAABB3Center(n);this._look2=d||f;const m=c.subVec3(this._eye1,this._look1,kA),_=c.normalizeVec3(m),u=d?c.getAABB3DiagPoint(n,d):c.getAABB3Diag(n),B=e.fitFOV||this._fitFOV,y=Math.abs(u/Math.tan(B*c.DEGTORAD));this._orthoScale2=u*1.1,this._eye2[0]=this._look2[0]+_[0]*y,this._eye2[1]=this._look2[1]+_[1]*y,this._eye2[2]=this._look2[2]+_[2]*y,this._up2[0]=this._up1[0],this._up2[1]=this._up1[1],this._up2[2]=this._up1[2],this._flyingEyeLookUp=!0}else(a||A||l)&&(this._flyingEyeLookUp=!!a&&!!A&&!!l,this._flyingEye=!!a&&!A,this._flyingLook=!!A&&!a,a&&(this._eye2[0]=a[0],this._eye2[1]=a[1],this._eye2[2]=a[2]),A&&(this._look2[0]=A[0],this._look2[1]=A[1],this._look2[2]=A[2]),l&&(this._up2[0]=l[0],this._up2[1]=l[1],this._up2[2]=l[2]));o?(e.projection==="ortho"&&s.projection!=="ortho"&&(this._projection2="ortho",this._projMatrix1=s.projMatrix.slice(),this._projMatrix2=s.ortho.matrix.slice(),s.projection="customProjection"),e.projection==="perspective"&&s.projection!=="perspective"&&(this._projection2="perspective",this._projMatrix1=s.projMatrix.slice(),this._projMatrix2=s.perspective.matrix.slice(),s.projection="customProjection")):this._projection2=null,this.fire("started",e,!0),this._time1=Date.now(),this._time2=this._time1+(e.duration?e.duration*1e3:this._duration),this._flying=!0,Bt.scheduleTask(this._update,this)}jumpTo(e){this._jumpTo(e)}_jumpTo(e){this._flying&&this.stop();const t=this.scene.camera;var i,s,o,n,a;if(e.aabb)i=e.aabb;else if(e.length===6)i=e;else if(e.eye||e.look||e.up)o=e.eye,n=e.look,a=e.up;else{let h=e;if((Se.isNumeric(h)||Se.isString(h))&&(s=h,h=this.scene.components[s],!h)){this.error("Component not found: "+Se.inQuotes(s));return}i=h.aabb||this.scene.aabb}const A=e.poi;if(i){if(i[3]<=i[0]||i[4]<=i[1]||i[5]<=i[2])return;var l=A?c.getAABB3DiagPoint(i,A):c.getAABB3Diag(i);n=A||c.getAABB3Center(i,n),this._trail?c.subVec3(t.look,n,Is):c.subVec3(t.eye,t.look,Is),c.normalizeVec3(Is);let h;(e.fit!==void 0?e.fit:this._fit)?h=Math.abs(l/Math.tan((e.fitFOV||this._fitFOV)*c.DEGTORAD)):h=c.lenVec3(c.subVec3(t.eye,t.look,kA)),c.mulVec3Scalar(Is,h),t.eye=c.addVec3(n,Is,kA),t.look=n,this.scene.camera.ortho.scale=l*1.1}else(o||n||a)&&(o&&(t.eye=o),n&&(t.look=n),a&&(t.up=a));e.projection&&(t.projection=e.projection)}_update(){if(!this._flying)return;let t=(Date.now()-this._time1)/(this._time2-this._time1);const i=t>=1;t>1&&(t=1);const s=this.easing?Us._ease(t,0,1,1):t,o=this.scene.camera;if(this._flyingEye||this._flyingLook?this._flyingEye?(c.subVec3(o.eye,o.look,Is),o.eye=c.lerpVec3(s,0,1,this._eye1,this._eye2,QA),o.look=c.subVec3(QA,Is,NA)):this._flyingLook&&(o.look=c.lerpVec3(s,0,1,this._look1,this._look2,NA),o.up=c.lerpVec3(s,0,1,this._up1,this._up2,ud)):this._flyingEyeLookUp&&(o.eye=c.lerpVec3(s,0,1,this._eye1,this._eye2,QA),o.look=c.lerpVec3(s,0,1,this._look1,this._look2,NA),o.up=c.lerpVec3(s,0,1,this._up1,this._up2,ud)),this._projection2){const n=this._projection2==="ortho"?Us._easeOutExpo(t,0,1,1):Us._easeInCubic(t,0,1,1);o.customProjection.matrix=c.lerpMat4(n,0,1,this._projMatrix1,this._projMatrix2)}else o.ortho.scale=this._orthoScale1+t*(this._orthoScale2-this._orthoScale1);if(i){o.ortho.scale=this._orthoScale2,this.stop();return}Bt.scheduleTask(this._update,this)}static _ease(e,t,i,s){return e/=s,-i*e*(e-2)+t}static _easeInCubic(e,t,i,s){return e/=s,i*e*e*e+t}static _easeOutExpo(e,t,i,s){return i*(-Math.pow(2,-10*e/s)+1)+t}stop(){if(!this._flying)return;this._flying=!1,this._time1=null,this._time2=null,this._projection2&&(this.scene.camera.projection=this._projection2);const e=this._callback;e&&(this._callback=null,this._callbackScope?e.call(this._callbackScope):e()),this.fire("stopped",!0,!0)}cancel(){this._flying&&(this._flying=!1,this._time1=null,this._time2=null,this._callback&&(this._callback=null),this.fire("canceled",!0,!0))}set duration(e){this._duration=e?e*1e3:500,this.stop()}get duration(){return this._duration/1e3}set fit(e){this._fit=e!==!1}get fit(){return this._fit}set fitFOV(e){this._fitFOV=e||45}get fitFOV(){return this._fitFOV}set trail(e){this._trail=!!e}get trail(){return this._trail}destroy(){this.stop(),super.destroy()}}class Jt extends It{get type(){return"CameraPathAnimation"}constructor(e,t={}){super(e,t),this._cameraFlightAnimation=new Us(this),this._t=0,this.state=Jt.SCRUBBING,this._playingFromT=0,this._playingToT=0,this._playingRate=t.playingRate||1,this._playingDir=1,this._lastTime=null,this.cameraPath=t.cameraPath,this._tick=this.scene.on("tick",this._updateT,this)}_updateT(){const e=this._cameraPath;if(!e)return;let t,i;const s=performance.now(),o=this._lastTime?(s-this._lastTime)*.001:0;if(this._lastTime=s,o!==0)switch(this.state){case Jt.SCRUBBING:return;case Jt.PLAYING:if(this._t+=this._playingRate*o,t=this._cameraPath.frames.length,t===0||this._playingDir<0&&this._t<=0||this._playingDir>0&&this._t>=this._cameraPath.frames[t-1].t){this.state=Jt.SCRUBBING,this._t=this._cameraPath.frames[t-1].t,this.fire("stopped");return}e.loadFrame(this._t);break;case Jt.PLAYING_TO:i=this._t+this._playingRate*o*this._playingDir,(this._playingDir<0&&i<=this._playingToT||this._playingDir>0&&i>=this._playingToT)&&(i=this._playingToT,this.state=Jt.SCRUBBING,this.fire("stopped")),this._t=i,e.loadFrame(this._t);break}}_ease(e,t,i,s){return e/=s,-i*e*(e-2)+t}set cameraPath(e){this._cameraPath=e}get cameraPath(){return this._cameraPath}set rate(e){this._playingRate=e}get rate(){return this._playingRate}play(){this._cameraPath&&(this._lastTime=null,this.state=Jt.PLAYING)}playToT(e){this._cameraPath&&(this._playingFromT=this._t,this._playingToT=e,this._playingDir=this._playingToT-this._playingFromT<0?-1:1,this._lastTime=null,this.state=Jt.PLAYING_TO)}playToFrame(e){const t=this._cameraPath;if(!t)return;const i=t.frames[e];if(!i){this.error("playToFrame - frame index out of range: "+e);return}this.playToT(i.t)}flyToFrame(e,t){const i=this._cameraPath;if(!i)return;const s=i.frames[e];if(!s){this.error("flyToFrame - frame index out of range: "+e);return}this.state=Jt.SCRUBBING,this._cameraFlightAnimation.flyTo(s,t)}scrubToT(e){const t=this._cameraPath;!t||!this.scene.camera||(this._t=e,t.loadFrame(this._t),this.state=Jt.SCRUBBING)}scrubToFrame(e){const t=this._cameraPath;if(!t||!this.scene.camera)return;if(!t.frames[e]){this.error("playToFrame - frame index out of range: "+e);return}t.loadFrame(this._t),this.state=Jt.SCRUBBING}stop(){this.state=Jt.SCRUBBING,this.fire("stopped")}destroy(){super.destroy(),this.scene.off(this._tick)}}Jt.STOPPED=0;Jt.SCRUBBING=1;Jt.PLAYING=2;Jt.PLAYING_TO=3;c.vec3();c.vec3();c.vec3();c.vec3([0,-1,0]);c.vec4([0,0,0,1]);c.vec3();c.vec3();const Ww=c.vec4(),Xw=c.vec4(),HA=c.vec3(),dd=c.vec3(),Yw=c.vec3(),pd=c.vec4(),Jw=c.vec4(),fd=c.vec4();class Zw{constructor(e){this._scene=e}dollyToCanvasPos(e,t,i){let s=!1;const o=this._scene.camera;if(e){const n=c.subVec3(e,o.eye,HA);s=c.lenVec3(n)<i}if(o.projection==="perspective"){o.ortho.scale=o.ortho.scale-i;const n=this._unproject(t,pd),a=c.subVec3(n,o.eye,fd),A=c.mulVec3Scalar(c.normalizeVec3(a),-i,[]);if(o.eye=[o.eye[0]-A[0],o.eye[1]-A[1],o.eye[2]-A[2]],o.look=[o.look[0]-A[0],o.look[1]-A[1],o.look[2]-A[2]],e){const l=c.subVec3(e,o.eye,HA),h=c.lenVec3(l),d=c.mulVec3Scalar(c.normalizeVec3(c.subVec3(o.look,o.eye,dd)),h);o.look=[o.eye[0]+d[0],o.eye[1]+d[1],o.eye[2]+d[2]]}}else if(o.projection==="ortho"){const n=this._unproject(t,pd);o.ortho.scale=o.ortho.scale-i,o.ortho._update();const a=this._unproject(t,Jw),A=c.subVec3(a,n,fd),l=c.mulVec3Scalar(c.normalizeVec3(c.subVec3(o.look,o.eye,HA)),-i,dd),h=c.addVec3(A,l,Yw);o.eye=[o.eye[0]-h[0],o.eye[1]-h[1],o.eye[2]-h[2]],o.look=[o.look[0]-h[0],o.look[1]-h[1],o.look[2]-h[2]]}return s}_unproject(e,t){const i=this._scene.camera,s=i.project.transposedMatrix,o=s.subarray(8,12),n=s.subarray(12),a=[0,0,-1,1],A=c.dotVec4(a,o)/c.dotVec4(a,n);return i.project.unproject(e,A,Ww,Xw,t),t}destroy(){}}const gd=c.vec3(),md=c.vec3(),qw=c.vec3(),$w=c.vec4(),eb=c.vec4(),tb=c.vec4();class ib{constructor(e,t){this._scene=e,this._configs=t,this._pivotWorldPos=c.vec3(),this._cameraOffset=c.vec3(),this._azimuth=0,this._polar=0,this._radius=0,this._pivotPosSet=!1,this._pivoting=!1,this._shown=!1,this._pivotSphereEnabled=!1,this._pivotSphere=null,this._pivotSphereSize=1,this._pivotSphereGeometry=null,this._pivotSphereMaterial=null,this._rtcCenter=c.vec3(),this._rtcPos=c.vec3(),this._pivotViewPos=c.vec4(),this._pivotProjPos=c.vec4(),this._pivotCanvasPos=c.vec2(),this._cameraDirty=!0,this._onViewMatrix=this._scene.camera.on("viewMatrix",()=>{this._cameraDirty=!0}),this._onProjMatrix=this._scene.camera.on("projMatrix",()=>{this._cameraDirty=!0}),this._onTick=this._scene.on("tick",()=>{this.updatePivotElement(),this.updatePivotSphere()})}createPivotSphere(){const e=this.getPivotPos(),t=c.vec3();c.decomposeMat4(c.inverseMat4(this._scene.viewer.camera.viewMatrix,c.mat4()),t,c.vec4(),c.vec3());const i=c.distVec3(t,e);let s=Math.tan(Math.PI/500)*i*this._pivotSphereSize;this._scene.camera.projection=="ortho"&&(s/=this._scene.camera.ortho.scale/2),_h(e,this._rtcCenter,this._rtcPos),this._pivotSphereGeometry=new TB(this._scene,SB({radius:s})),this._pivotSphere=new FB(this._scene,{geometry:this._pivotSphereGeometry,material:this._pivotSphereMaterial,pickable:!1,position:this._rtcPos,rtcCenter:this._rtcCenter})}destroyPivotSphere(){this._pivotSphere&&(this._pivotSphere.destroy(),this._pivotSphere=null),this._pivotSphereGeometry&&(this._pivotSphereGeometry.destroy(),this._pivotSphereGeometry=null)}updatePivotElement(){const e=this._scene.camera,t=this._scene.canvas;if(this._pivoting&&this._cameraDirty){c.transformPoint3(e.viewMatrix,this.getPivotPos(),this._pivotViewPos),this._pivotViewPos[3]=1,c.transformPoint4(e.projMatrix,this._pivotViewPos,this._pivotProjPos);const i=t.boundary,s=i[2],o=i[3];this._pivotCanvasPos[0]=Math.floor((1+this._pivotProjPos[0]/this._pivotProjPos[3])*s/2),this._pivotCanvasPos[1]=Math.floor((1-this._pivotProjPos[1]/this._pivotProjPos[3])*o/2);let n=t._lastBoundingClientRect;if(!n||t._canvasSizeChanged){const a=t.canvas;n=t._lastBoundingClientRect=a.getBoundingClientRect()}this._pivotElement&&(this._pivotElement.style.left=Math.floor(n.left+this._pivotCanvasPos[0])-this._pivotElement.clientWidth/2+window.scrollX+"px",this._pivotElement.style.top=Math.floor(n.top+this._pivotCanvasPos[1])-this._pivotElement.clientHeight/2+window.scrollY+"px"),this._cameraDirty=!1}}updatePivotSphere(){this._pivoting&&this._pivotSphere&&(_h(this.getPivotPos(),this._rtcCenter,this._rtcPos),c.compareVec3(this._rtcPos,this._pivotSphere.position)||(this.destroyPivotSphere(),this.createPivotSphere()))}setPivotElement(e){this._pivotElement=e}enablePivotSphere(e={}){this.destroyPivotSphere(),this._pivotSphereEnabled=!0,e.size&&(this._pivotSphereSize=e.size);const t=e.color||[1,0,0];this._pivotSphereMaterial=new jf(this._scene,{emissive:t,ambient:t,specular:[0,0,0],diffuse:[0,0,0]})}disablePivotSphere(){this.destroyPivotSphere(),this._pivotSphereEnabled=!1}startPivot(){if(this._cameraLookingDownwards())return this._pivoting=!1,!1;const e=this._scene.camera;let t=c.lookAtMat4v(e.eye,e.look,e.worldUp);c.transformPoint3(t,this.getPivotPos(),this._cameraOffset);const i=this.getPivotPos();this._cameraOffset[2]+=c.distVec3(e.eye,i),t=c.inverseMat4(t);const s=c.transformVec3(t,this._cameraOffset),o=c.vec3();if(c.subVec3(e.eye,i,o),c.addVec3(o,s),e.zUp){const n=o[1];o[1]=o[2],o[2]=n}this._radius=c.lenVec3(o),this._polar=Math.acos(o[1]/this._radius),this._azimuth=Math.atan2(o[0],o[2]),this._pivoting=!0}_cameraLookingDownwards(){const e=this._scene.camera,t=c.normalizeVec3(c.subVec3(e.look,e.eye,gd)),i=c.cross3Vec3(t,e.worldUp,md);return c.sqLenVec3(i)<=1e-4}getPivoting(){return this._pivoting}setPivotPos(e){this._pivotWorldPos.set(e),this._pivotPosSet=!0}setCanvasPivotPos(e){const t=this._scene.camera,i=Math.abs(c.distVec3(this._scene.center,t.eye)),s=t.project.transposedMatrix,o=s.subarray(8,12),n=s.subarray(12),a=[0,0,-1,1],A=c.dotVec4(a,o)/c.dotVec4(a,n),l=$w;t.project.unproject(e,A,eb,tb,l);const h=c.normalizeVec3(c.subVec3(l,t.eye,gd)),d=c.addVec3(t.eye,c.mulVec3Scalar(h,i,md),qw);this.setPivotPos(d)}getPivotPos(){return this._pivotPosSet?this._pivotWorldPos:this._scene.camera.look}continuePivot(e,t){if(!this._pivoting||e===0&&t===0)return;const i=this._scene.camera;var s=-e;const o=-t;i.worldUp[2]===1&&(s=-s),this._azimuth+=-s*.01,this._polar+=o*.01,this._polar=c.clamp(this._polar,.001,Math.PI-.001);const n=[this._radius*Math.sin(this._polar)*Math.sin(this._azimuth),this._radius*Math.cos(this._polar),this._radius*Math.sin(this._polar)*Math.cos(this._azimuth)];if(i.worldUp[2]===1){const f=n[1];n[1]=n[2],n[2]=f}const a=c.lenVec3(c.subVec3(i.look,i.eye,c.vec3())),A=this.getPivotPos();c.addVec3(n,A);let l=c.lookAtMat4v(n,A,i.worldUp);l=c.inverseMat4(l);const h=c.transformVec3(l,this._cameraOffset);l[12]-=h[0],l[13]-=h[1],l[14]-=h[2];const d=[l[8],l[9],l[10]];i.eye=[l[12],l[13],l[14]],c.subVec3(i.eye,c.mulVec3Scalar(d,a),i.look),i.up=[l[4],l[5],l[6]],this.showPivot()}showPivot(){this._shown||(this._pivotElement&&(this.updatePivotElement(),this._pivotElement.style.visibility="visible"),this._pivotSphereEnabled&&(this.destroyPivotSphere(),this.createPivotSphere()),this._shown=!0)}hidePivot(){this._shown&&(this._pivotElement&&(this._pivotElement.style.visibility="hidden"),this._pivotSphereEnabled&&this.destroyPivotSphere(),this._shown=!1)}endPivot(){this._pivoting=!1}destroy(){this.destroyPivotSphere(),this._scene.camera.off(this._onViewMatrix),this._scene.camera.off(this._onProjMatrix),this._scene.off(this._onTick)}}class sb{constructor(e,t){this._scene=e.scene,this._cameraControl=e,this._scene.canvas.canvas.oncontextmenu=function(i){i.preventDefault()},this._configs=t,this.schedulePickEntity=!1,this.schedulePickSurface=!1,this.scheduleSnapOrPick=!1,this.pickCursorPos=c.vec2(),this.picked=!1,this.pickedSurface=!1,this.pickResult=null,this._lastPickedEntityId=null,this._lastHash=null,this._needFireEvents=0}update(){if(!this._configs.pointerEnabled||!this.schedulePickEntity&&!this.schedulePickSurface)return;const e=`${~~this.pickCursorPos[0]}-${~~this.pickCursorPos[1]}-${this.scheduleSnapOrPick}-${this.schedulePickSurface}-${this.schedulePickEntity}`;if(this._lastHash===e)return;this.picked=!1,this.pickedSurface=!1,this.snappedOrPicked=!1,this.hoveredSnappedOrSurfaceOff=!1;const t=this._cameraControl.hasSubs("hoverSurface");if(this.scheduleSnapOrPick){const i=this._scene.pick({canvasPos:this.pickCursorPos,snapRadius:this._configs.snapRadius,snapToVertex:this._configs.snapToVertex,snapToEdge:this._configs.snapToEdge});i&&(i.snappedToEdge||i.snappedToVertex)?(this.snapPickResult=i,this.snappedOrPicked=!0,this._needFireEvents++):(this.schedulePickSurface=!0,this.snapPickResult=null)}if(this.schedulePickSurface&&this.pickResult&&this.pickResult.worldPos){const i=this.pickResult.canvasPos;if(i[0]===this.pickCursorPos[0]&&i[1]===this.pickCursorPos[1]){this.picked=!0,this.pickedSurface=!0,this._needFireEvents+=t?1:0,this.schedulePickEntity=!1,this.schedulePickSurface=!1,this.scheduleSnapOrPick?this.snappedOrPicked=!0:this.hoveredSnappedOrSurfaceOff=!0,this.scheduleSnapOrPick=!1;return}}if(this.schedulePickEntity&&this.pickResult&&(this.pickResult.canvasPos||this.pickResult.snappedCanvasPos)){const i=this.pickResult.canvasPos||this.pickResult.snappedCanvasPos;if(i[0]===this.pickCursorPos[0]&&i[1]===this.pickCursorPos[1]){this.picked=!0,this.pickedSurface=!1,this.schedulePickEntity=!1,this.schedulePickSurface=!1;return}}this.schedulePickSurface||this.scheduleSnapOrPick&&!this.snapPickResult?(this.pickResult=this._scene.pick({pickSurface:!0,pickSurfaceNormal:!1,canvasPos:this.pickCursorPos}),this.pickResult?(this.picked=!0,this.scheduleSnapOrPick?this.snappedOrPicked=!0:this.pickedSurface=!0,this._needFireEvents++):this.scheduleSnapOrPick&&(this.hoveredSnappedOrSurfaceOff=!0,this._needFireEvents++)):(this.pickResult=this._scene.pick({canvasPos:this.pickCursorPos}),this.pickResult&&(this.picked=!0,this.pickedSurface=!1,this._needFireEvents++)),this.scheduleSnapOrPick=!1,this.schedulePickEntity=!1,this.schedulePickSurface=!1}fireEvents(){if(this._needFireEvents!==0){if(this.hoveredSnappedOrSurfaceOff&&this._cameraControl.fire("hoverSnapOrSurfaceOff",{canvasPos:this.pickCursorPos,pointerPos:this.pickCursorPos},!0),this.snappedOrPicked)if(this.snapPickResult){const e=new El;e.entity=this.snapPickResult.entity,e.snappedToVertex=this.snapPickResult.snappedToVertex,e.snappedToEdge=this.snapPickResult.snappedToEdge,e.worldPos=this.snapPickResult.worldPos,e.canvasPos=this.pickCursorPos,e.snappedCanvasPos=this.snapPickResult.snappedCanvasPos,this._cameraControl.fire("hoverSnapOrSurface",e,!0),this.snapPickResult=null}else this._cameraControl.fire("hoverSnapOrSurface",this.pickResult,!0);if(this.picked&&this.pickResult&&(this.pickResult.entity||this.pickResult.worldPos)){if(this.pickResult.entity){const e=this.pickResult.entity.id;this._lastPickedEntityId!==e&&(this._lastPickedEntityId!==void 0&&this._cameraControl.fire("hoverOut",{entity:this._scene.objects[this._lastPickedEntityId]},!0),this._cameraControl.fire("hoverEnter",this.pickResult,!0),this._lastPickedEntityId=e)}this._cameraControl.fire("hover",this.pickResult,!0),this.pickResult.worldPos&&(this.pickedSurface=!0,this._cameraControl.fire("hoverSurface",this.pickResult,!0))}else this._lastPickedEntityId!==void 0&&(this._cameraControl.fire("hoverOut",{entity:this._scene.objects[this._lastPickedEntityId]},!0),this._lastPickedEntityId=void 0),this._cameraControl.fire("hoverOff",{canvasPos:this.pickCursorPos},!0);this.pickResult=null,this._needFireEvents=0}}}const yn=c.vec2(),rb=function(r,e){if(!r)r=window.event,e[0]=r.x,e[1]=r.y;else{let t=r.target,i=0,s=0,o=0,n=0;for(;t.offsetParent;)i+=t.offsetLeft,s+=t.offsetTop,o+=t.scrollLeft,n+=t.scrollTop,t=t.offsetParent;e[0]=r.pageX+o-i,e[1]=r.pageY+n-s}return e};class ob{constructor(e,t,i,s,o){this._scene=e;const n=t.pickController;let a=0,A=0,l=0,h=0,d,f,m,_=!1;const u=c.vec3();let B=!0;const y=this._scene.canvas.canvas,x=[];document.addEventListener("keydown",this._documentKeyDownHandler=S=>{if(!(i.active&&i.pointerEnabled)||!e.input.keyboardEnabled)return;const R=S.keyCode;x[R]=!0}),document.addEventListener("keyup",this._documentKeyUpHandler=S=>{if(!(i.active&&i.pointerEnabled)||!e.input.keyboardEnabled)return;const R=S.keyCode;x[R]=!1});function P(S=!0){y.style.cursor="move",v(),S&&b()}function v(){a=s.pointerCanvasPos[0],A=s.pointerCanvasPos[1],l=s.pointerCanvasPos[0],h=s.pointerCanvasPos[1]}function b(){n.pickCursorPos=s.pointerCanvasPos,n.schedulePickSurface=!0,n.update(),n.picked&&n.pickedSurface&&n.pickResult&&n.pickResult.worldPos?(_=!0,u.set(n.pickResult.worldPos)):_=!1}y.addEventListener("mousedown",this._mouseDownHandler=S=>{if(i.active&&i.pointerEnabled)switch(S.which){case 1:x[e.input.KEY_SHIFT]||i.planView?(d=!0,P()):(d=!0,P(!1));break;case 2:f=!0,P();break;case 3:m=!0,i.panRightClick&&P();break}}),document.addEventListener("mousemove",this._documentMouseMoveHandler=S=>{if(!(i.active&&i.pointerEnabled)||!d&&!f&&!m)return;const R=e.canvas.boundary,D=R[2],K=R[3],j=s.pointerCanvasPos[0],z=s.pointerCanvasPos[1],le=x[e.input.KEY_SHIFT]||i.planView||!i.panRightClick&&f||i.panRightClick&&m,ue=document.pointerLockElement?S.movementX:j-a,ae=document.pointerLockElement?S.movementY:z-A;if(le){const Be=e.camera;if(Be.projection==="perspective"){const xe=Math.abs(_?c.lenVec3(c.subVec3(u,e.camera.eye,[])):e.camera.eyeLookDist)*Math.tan(Be.perspective.fov/2*Math.PI/180);o.panDeltaX+=1.5*ue*xe/K,o.panDeltaY+=1.5*ae*xe/K}else o.panDeltaX+=.5*Be.ortho.scale*(ue/K),o.panDeltaY+=.5*Be.ortho.scale*(ae/K)}else d&&!f&&!m&&(i.planView||(i.firstPerson?(o.rotateDeltaY-=ue/D*i.dragRotationRate/2,o.rotateDeltaX+=ae/K*(i.dragRotationRate/4)):(o.rotateDeltaY-=ue/D*(i.dragRotationRate*1.5),o.rotateDeltaX+=ae/K*(i.dragRotationRate*1.5))));a=j,A=z}),y.addEventListener("mousemove",this._canvasMouseMoveHandler=S=>{i.active&&i.pointerEnabled&&s.mouseover&&(B=!0)}),document.addEventListener("mouseup",this._documentMouseUpHandler=S=>{if(i.active&&i.pointerEnabled)switch(S.which){case 1:d=!1,f=!1,m=!1;break;case 2:d=!1,f=!1,m=!1;break;case 3:d=!1,f=!1,m=!1;break}}),y.addEventListener("mouseup",this._mouseUpHandler=S=>{if(i.active&&i.pointerEnabled){switch(S.which){case 3:rb(S,yn);const R=yn[0],D=yn[1];Math.abs(R-l)<3&&Math.abs(D-h)<3&&t.cameraControl.fire("rightClick",{pagePos:[Math.round(S.pageX),Math.round(S.pageY)],canvasPos:yn,event:S},!0);break}y.style.removeProperty("cursor")}}),y.addEventListener("mouseenter",this._mouseEnterHandler=()=>{i.active&&i.pointerEnabled});const C=1/20,I=1/60;let E=null;y.addEventListener("wheel",this._mouseWheelHandler=S=>{if(!(i.active&&i.pointerEnabled))return;const R=performance.now()/1e3;var D=E!==null?R-E:0;E=R,D>C&&(D=C),D<I&&(D=I);const K=Math.max(-1,Math.min(1,-S.deltaY*40));if(K===0)return;const j=K/Math.abs(K);o.dollyDelta+=-j*D*i.mouseWheelDollyRate,B&&(s.followPointerDirty=!0,B=!1)},{passive:!0})}reset(){}destroy(){const e=this._scene.canvas.canvas;document.removeEventListener("keydown",this._documentKeyDownHandler),document.removeEventListener("keyup",this._documentKeyUpHandler),e.removeEventListener("mousedown",this._mouseDownHandler),document.removeEventListener("mousemove",this._documentMouseMoveHandler),e.removeEventListener("mousemove",this._canvasMouseMoveHandler),document.removeEventListener("mouseup",this._documentMouseUpHandler),e.removeEventListener("mouseup",this._mouseUpHandler),e.removeEventListener("mouseenter",this._mouseEnterHandler),e.removeEventListener("wheel",this._mouseWheelHandler)}}const Ai=c.vec3(),qs=c.vec3(),_d=c.vec3(),nb=c.vec3(),$s=c.vec3(),Dt={eye:c.vec3(),look:c.vec3(),up:c.vec3()};class ab{constructor(e,t,i,s){this._scene=e;const o=t.cameraControl,n=e.camera;this._onSceneKeyDown=e.input.on("keydown",()=>{if(!(i.active&&i.pointerEnabled)||!e.input.keyboardEnabled||!s.mouseover)return;const a=o._isKeyDownForAction(o.AXIS_VIEW_RIGHT),A=o._isKeyDownForAction(o.AXIS_VIEW_BACK),l=o._isKeyDownForAction(o.AXIS_VIEW_LEFT),h=o._isKeyDownForAction(o.AXIS_VIEW_FRONT),d=o._isKeyDownForAction(o.AXIS_VIEW_TOP),f=o._isKeyDownForAction(o.AXIS_VIEW_BOTTOM);if(!a&&!A&&!l&&!h&&!d&&!f)return;const m=e.aabb,_=c.getAABB3Diag(m);c.getAABB3Center(m,Ai);const u=Math.abs(_/Math.tan(t.cameraFlight.fitFOV*c.DEGTORAD)),B=_*1.1;Dt.orthoScale=B,a?(Dt.eye.set(c.addVec3(Ai,c.mulVec3Scalar(n.worldRight,u,qs),$s)),Dt.look.set(Ai),Dt.up.set(n.worldUp)):A?(Dt.eye.set(c.addVec3(Ai,c.mulVec3Scalar(n.worldForward,u,qs),$s)),Dt.look.set(Ai),Dt.up.set(n.worldUp)):l?(Dt.eye.set(c.addVec3(Ai,c.mulVec3Scalar(n.worldRight,-u,qs),$s)),Dt.look.set(Ai),Dt.up.set(n.worldUp)):h?(Dt.eye.set(c.addVec3(Ai,c.mulVec3Scalar(n.worldForward,-u,qs),$s)),Dt.look.set(Ai),Dt.up.set(n.worldUp)):d?(Dt.eye.set(c.addVec3(Ai,c.mulVec3Scalar(n.worldUp,u,qs),$s)),Dt.look.set(Ai),Dt.up.set(c.normalizeVec3(c.mulVec3Scalar(n.worldForward,1,_d),nb))):f&&(Dt.eye.set(c.addVec3(Ai,c.mulVec3Scalar(n.worldUp,-u,qs),$s)),Dt.look.set(Ai),Dt.up.set(c.normalizeVec3(c.mulVec3Scalar(n.worldForward,-1,_d)))),!i.firstPerson&&i.followPointer&&t.pivotController.setPivotPos(Ai),t.cameraFlight.duration>0?t.cameraFlight.flyTo(Dt,()=>{t.pivotController.getPivoting()&&i.followPointer&&t.pivotController.showPivot()}):(t.cameraFlight.jumpTo(Dt),t.pivotController.getPivoting()&&i.followPointer&&t.pivotController.showPivot())})}reset(){}destroy(){this._scene.input.off(this._onSceneKeyDown)}}class Ab{constructor(e,t,i,s,o){this._scene=e;const n=t.pickController,a=t.pivotController,A=t.cameraControl;this._clicks=0,this._timeout=null,this._lastPickedEntityId=null;let l=!1,h=!1;const d=this._scene.canvas.canvas,f=_=>{let u;_&&_.worldPos&&(u=_.worldPos);const B=_&&_.entity?_.entity.aabb:e.aabb;if(u){const y=e.camera;c.subVec3(y.eye,y.look,[]),t.cameraFlight.flyTo({aabb:B})}else t.cameraFlight.flyTo({aabb:B})},m=e.tickify(this._canvasMouseMoveHandler=_=>{if(!(i.active&&i.pointerEnabled)||l||h)return;const u=A.hasSubs("hover"),B=A.hasSubs("hoverEnter"),y=A.hasSubs("hoverOut"),x=A.hasSubs("hoverOff"),P=A.hasSubs("hoverSurface"),v=A.hasSubs("hoverSnapOrSurface");if(u||B||y||x||P||v)if(n.pickCursorPos=s.pointerCanvasPos,n.schedulePickEntity=!0,n.schedulePickSurface=P,n.scheduleSnapOrPick=v,n.update(),n.pickResult){if(n.pickResult.entity){const b=n.pickResult.entity.id;this._lastPickedEntityId!==b&&(this._lastPickedEntityId!==void 0&&A.fire("hoverOut",{entity:e.objects[this._lastPickedEntityId]},!0),A.fire("hoverEnter",n.pickResult,!0),this._lastPickedEntityId=b)}A.fire("hover",n.pickResult,!0),(n.pickResult.worldPos||n.pickResult.snappedWorldPos)&&A.fire("hoverSurface",n.pickResult,!0)}else this._lastPickedEntityId!==void 0&&(A.fire("hoverOut",{entity:e.objects[this._lastPickedEntityId]},!0),this._lastPickedEntityId=void 0),A.fire("hoverOff",{canvasPos:n.pickCursorPos},!0)});d.addEventListener("mousemove",m),d.addEventListener("mousedown",this._canvasMouseDownHandler=_=>{if(_.which===1&&(l=!0),_.which===3&&(h=!0),_.which===1&&i.active&&i.pointerEnabled&&(s.mouseDownClientX=_.clientX,s.mouseDownClientY=_.clientY,s.mouseDownCursorX=s.pointerCanvasPos[0],s.mouseDownCursorY=s.pointerCanvasPos[1],!i.firstPerson&&i.followPointer&&(n.pickCursorPos=s.pointerCanvasPos,n.schedulePickSurface=!0,n.update(),_.which===1))){const B=n.pickResult;B&&B.worldPos?(a.setPivotPos(B.worldPos),a.startPivot()):(i.smartPivot?a.setCanvasPivotPos(s.pointerCanvasPos):a.setPivotPos(e.camera.look),a.startPivot())}}),document.addEventListener("mouseup",this._documentMouseUpHandler=_=>{_.which===1&&(l=!1),_.which===3&&(h=!1),a.getPivoting()&&a.endPivot()}),d.addEventListener("mouseup",this._canvasMouseUpHandler=_=>{if(!(i.active&&i.pointerEnabled)||!(_.which===1)||(a.hidePivot(),Math.abs(_.clientX-s.mouseDownClientX)>3||Math.abs(_.clientY-s.mouseDownClientY)>3))return;const B=A.hasSubs("picked"),y=A.hasSubs("pickedNothing"),x=A.hasSubs("pickedSurface"),P=A.hasSubs("doublePicked"),v=A.hasSubs("doublePickedSurface"),b=A.hasSubs("doublePickedNothing");if(!i.doublePickFlyTo&&!P&&!v&&!b){(B||y||x)&&(n.pickCursorPos=s.pointerCanvasPos,n.schedulePickEntity=!0,n.schedulePickSurface=x,n.update(),n.pickResult?(A.fire("picked",n.pickResult,!0),n.pickedSurface&&A.fire("pickedSurface",n.pickResult,!0)):A.fire("pickedNothing",{canvasPos:s.pointerCanvasPos},!0)),this._clicks=0;return}if(this._clicks++,this._clicks===1){n.pickCursorPos=s.pointerCanvasPos,n.schedulePickEntity=i.doublePickFlyTo,n.schedulePickSurface=x,n.update();const C=n.pickResult,I=n.pickedSurface;this._timeout=setTimeout(()=>{C?(A.fire("picked",C,!0),I&&(A.fire("pickedSurface",C,!0),!i.firstPerson&&i.followPointer&&(t.pivotController.setPivotPos(C.worldPos),t.pivotController.startPivot()&&t.pivotController.showPivot()))):A.fire("pickedNothing",{canvasPos:s.pointerCanvasPos},!0),this._clicks=0},i.doubleClickTimeFrame)}else{if(this._timeout!==null&&(window.clearTimeout(this._timeout),this._timeout=null),n.pickCursorPos=s.pointerCanvasPos,n.schedulePickEntity=i.doublePickFlyTo||P||v,n.schedulePickSurface=n.schedulePickEntity&&v,n.update(),n.pickResult){if(A.fire("doublePicked",n.pickResult,!0),n.pickedSurface&&A.fire("doublePickedSurface",n.pickResult,!0),i.doublePickFlyTo&&(f(n.pickResult),!i.firstPerson&&i.followPointer)){const C=n.pickResult.entity.aabb,I=c.getAABB3Center(C);t.pivotController.setPivotPos(I),t.pivotController.startPivot()&&t.pivotController.showPivot()}}else if(A.fire("doublePickedNothing",{canvasPos:s.pointerCanvasPos},!0),i.doublePickFlyTo&&(f(),!i.firstPerson&&i.followPointer)){const C=e.aabb,I=c.getAABB3Center(C);t.pivotController.setPivotPos(I),t.pivotController.startPivot()&&t.pivotController.showPivot()}this._clicks=0}},!1)}reset(){this._clicks=0,this._lastPickedEntityId=null,this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null)}destroy(){const e=this._scene.canvas.canvas;e.removeEventListener("mousemove",this._canvasMouseMoveHandler),e.removeEventListener("mousedown",this._canvasMouseDownHandler),document.removeEventListener("mouseup",this._documentMouseUpHandler),e.removeEventListener("mouseup",this._canvasMouseUpHandler),this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null)}}class lb{constructor(e,t,i,s,o){this._scene=e;const n=e.input,a=[],A=e.canvas.canvas;let l=!0;this._onSceneMouseMove=n.on("mousemove",()=>{l=!0}),this._onSceneKeyDown=n.on("keydown",h=>{!(i.active&&i.pointerEnabled)||!e.input.keyboardEnabled||s.mouseover&&(a[h]=!0,h===n.KEY_SHIFT&&(A.style.cursor="move"))}),this._onSceneKeyUp=n.on("keyup",h=>{!(i.active&&i.pointerEnabled)||!e.input.keyboardEnabled||(a[h]=!1,h===n.KEY_SHIFT&&(A.style.cursor=null),t.pivotController.getPivoting()&&t.pivotController.endPivot())}),this._onTick=e.on("tick",h=>{if(!(i.active&&i.pointerEnabled)||!e.input.keyboardEnabled||!s.mouseover)return;const d=t.cameraControl,f=h.deltaTime/1e3;if(!i.planView){const v=d._isKeyDownForAction(d.ROTATE_Y_POS,a),b=d._isKeyDownForAction(d.ROTATE_Y_NEG,a),C=d._isKeyDownForAction(d.ROTATE_X_POS,a),I=d._isKeyDownForAction(d.ROTATE_X_NEG,a),E=f*i.keyboardRotationRate;(v||b||C||I)&&(!i.firstPerson&&i.followPointer&&t.pivotController.startPivot(),v?o.rotateDeltaY+=E:b&&(o.rotateDeltaY-=E),C?o.rotateDeltaX+=E:I&&(o.rotateDeltaX-=E),!i.firstPerson&&i.followPointer&&t.pivotController.startPivot())}if(!a[n.KEY_CTRL]&&!a[n.KEY_ALT]){const v=d._isKeyDownForAction(d.DOLLY_BACKWARDS,a),b=d._isKeyDownForAction(d.DOLLY_FORWARDS,a);if(v||b){const C=f*i.keyboardDollyRate;!i.firstPerson&&i.followPointer&&t.pivotController.startPivot(),b?o.dollyDelta-=C:v&&(o.dollyDelta+=C),l&&(s.followPointerDirty=!0,l=!1)}}const m=d._isKeyDownForAction(d.PAN_FORWARDS,a),_=d._isKeyDownForAction(d.PAN_BACKWARDS,a),u=d._isKeyDownForAction(d.PAN_LEFT,a),B=d._isKeyDownForAction(d.PAN_RIGHT,a),y=d._isKeyDownForAction(d.PAN_UP,a),x=d._isKeyDownForAction(d.PAN_DOWN,a),P=(a[n.KEY_ALT]?.3:1)*f*i.keyboardPanRate;(m||_||u||B||y||x)&&(!i.firstPerson&&i.followPointer&&t.pivotController.startPivot(),x?o.panDeltaY+=P:y&&(o.panDeltaY+=-P),B?o.panDeltaX+=-P:u&&(o.panDeltaX+=P),_?o.panDeltaZ+=P:m&&(o.panDeltaZ+=-P))})}reset(){}destroy(){this._scene.off(this._onTick),this._scene.input.off(this._onSceneMouseMove),this._scene.input.off(this._onSceneKeyDown),this._scene.input.off(this._onSceneKeyUp)}}const vd=1,er=.001,cb=c.vec3();class hb{constructor(e,t,i,s,o){this._scene=e;const n=e.camera,a=t.pickController,A=t.pivotController,l=t.panController;let h=vd,d=1,f=null;this._onTick=e.on("tick",()=>{if(!(i.active&&i.pointerEnabled))return;let m="default";Math.abs(o.dollyDelta)<er&&(o.dollyDelta=0),Math.abs(o.rotateDeltaX)<er&&(o.rotateDeltaX=0),Math.abs(o.rotateDeltaY)<er&&(o.rotateDeltaY=0),(o.rotateDeltaX!==0||o.rotateDeltaY!==0)&&(o.dollyDelta=0),i.followPointer?--h<=0&&(h=vd,o.dollyDelta!==0&&(o.rotateDeltaY===0&&o.rotateDeltaX===0&&i.followPointer&&s.followPointerDirty&&(a.pickCursorPos=s.pointerCanvasPos,a.schedulePickSurface=!0,a.update(),a.pickResult&&a.pickResult.worldPos?f=a.pickResult.worldPos:(d=1,f=null),s.followPointerDirty=!1),f&&(d=Math.abs(c.lenVec3(c.subVec3(f,e.camera.eye,cb)))/i.dollyProximityThreshold),d<i.dollyMinSpeed&&(d=i.dollyMinSpeed))):(d=1,f=null);const _=o.dollyDelta*d;if((o.rotateDeltaY!==0||o.rotateDeltaX!==0)&&(!i.firstPerson&&i.followPointer&&A.getPivoting()?(A.continuePivot(o.rotateDeltaY,o.rotateDeltaX),A.showPivot()):(o.rotateDeltaX!==0&&(i.firstPerson?n.pitch(-o.rotateDeltaX):n.orbitPitch(o.rotateDeltaX)),o.rotateDeltaY!==0&&(i.firstPerson?n.yaw(o.rotateDeltaY):n.orbitYaw(o.rotateDeltaY))),o.rotateDeltaX*=i.rotationInertia,o.rotateDeltaY*=i.rotationInertia,m="grabbing"),Math.abs(o.panDeltaX)<er&&(o.panDeltaX=0),Math.abs(o.panDeltaY)<er&&(o.panDeltaY=0),Math.abs(o.panDeltaZ)<er&&(o.panDeltaZ=0),o.panDeltaX!==0||o.panDeltaY!==0||o.panDeltaZ!==0){const u=c.vec3();u[0]=o.panDeltaX,u[1]=o.panDeltaY,u[2]=o.panDeltaZ;let B,y;if(i.constrainVertical){n.xUp?(B=n.eye[0],y=n.look[0]):n.yUp?(B=n.eye[1],y=n.look[1]):n.zUp&&(B=n.eye[2],y=n.look[2]),n.pan(u);const x=n.eye,P=n.look;n.xUp?(x[0]=B,P[0]=y):n.yUp?(x[1]=B,P[1]=y):n.zUp&&(x[2]=B,P[2]=y),n.eye=x,n.look=P}else n.pan(u);m="grabbing"}if(o.panDeltaX*=i.panInertia,o.panDeltaY*=i.panInertia,o.panDeltaZ*=i.panInertia,_!==0){if(_<0?m="zoom-in":m="zoom-out",i.firstPerson){let u,B;if(i.constrainVertical&&(n.xUp?(u=n.eye[0],B=n.look[0]):n.yUp?(u=n.eye[1],B=n.look[1]):n.zUp&&(u=n.eye[2],B=n.look[2])),i.followPointer?l.dollyToCanvasPos(f,s.pointerCanvasPos,-_)&&(s.followPointerDirty=!0):(n.pan([0,0,_]),n.ortho.scale=n.ortho.scale-_),i.constrainVertical){const y=n.eye,x=n.look;n.xUp?(y[0]=u,x[0]=B):n.yUp?(y[1]=u,x[1]=B):n.zUp&&(y[2]=u,x[2]=B),n.eye=y,n.look=x}}else i.planView,i.followPointer?l.dollyToCanvasPos(f,s.pointerCanvasPos,-_)&&(s.followPointerDirty=!0):(n.ortho.scale=n.ortho.scale+_,n.zoom(_));o.dollyDelta*=i.dollyInertia}a.fireEvents(),document.body.style.cursor=m})}destroy(){this._scene.off(this._onTick)}}class ub{constructor(e,t,i,s,o){this._scene=e;const n=this._scene.canvas.canvas;n.addEventListener("mouseenter",this._mouseEnterHandler=()=>{s.mouseover=!0}),n.addEventListener("mouseleave",this._mouseLeaveHandler=()=>{s.mouseover=!1,n.style.cursor=null}),document.addEventListener("mousemove",this._mouseMoveHandler=a=>{Bd(a,n,s.pointerCanvasPos)}),n.addEventListener("mousedown",this._mouseDownHandler=a=>{i.active&&i.pointerEnabled&&(Bd(a,n,s.pointerCanvasPos),s.mouseover=!0)}),n.addEventListener("mouseup",this._mouseUpHandler=a=>{i.active&&i.pointerEnabled})}reset(){}destroy(){const e=this._scene.canvas.canvas;document.removeEventListener("mousemove",this._mouseMoveHandler),e.removeEventListener("mouseenter",this._mouseEnterHandler),e.removeEventListener("mouseleave",this._mouseLeaveHandler),e.removeEventListener("mousedown",this._mouseDownHandler),e.removeEventListener("mouseup",this._mouseUpHandler)}}function Bd(r,e,t){if(!r)r=window.event,t[0]=r.x,t[1]=r.y;else{const{left:i,top:s}=e.getBoundingClientRect();t[0]=r.clientX-i,t[1]=r.clientY-s}return t}const tr=function(r,e){if(!r)r=window.event,e[0]=r.x,e[1]=r.y;else{let t=r.target,i=0,s=0;for(;t.offsetParent;)i+=t.offsetLeft,s+=t.offsetTop,t=t.offsetParent;e[0]=r.pageX-i,e[1]=r.pageY-s}return e};class db{constructor(e,t,i,s,o){this._scene=e;const n=t.pickController,a=t.pivotController,A=c.vec2(),l=c.vec2(),h=c.vec2(),d=c.vec2(),f=[],m=this._scene.canvas.canvas;let _=0,u=!1;this._onTick=e.on("tick",()=>{u=!1}),m.addEventListener("touchstart",this._canvasTouchStartHandler=B=>{if(!(i.active&&i.pointerEnabled))return;B.preventDefault();const y=B.touches,x=B.changedTouches;for(s.touchStartTime=Date.now(),y.length===1&&x.length===1&&(tr(y[0],A),i.followPointer&&(n.pickCursorPos=A,n.schedulePickSurface=!0,n.update(),i.planView||(n.picked&&n.pickedSurface&&n.pickResult&&n.pickResult.worldPos?(a.setPivotPos(n.pickResult.worldPos),!i.firstPerson&&a.startPivot()&&a.showPivot()):(i.smartPivot?a.setCanvasPivotPos(s.pointerCanvasPos):a.setPivotPos(e.camera.look),!i.firstPerson&&a.startPivot()&&a.showPivot()))));f.length<y.length;)f.push(c.vec2());for(let P=0,v=y.length;P<v;++P)tr(y[P],f[P]);_=y.length}),m.addEventListener("touchend",this._canvasTouchEndHandler=()=>{a.getPivoting()&&a.endPivot()}),m.addEventListener("touchmove",this._canvasTouchMoveHandler=B=>{if(!(i.active&&i.pointerEnabled)||(B.stopPropagation(),B.preventDefault(),u))return;u=!0;const y=e.canvas.boundary,x=y[2],P=y[3],v=B.touches;if(B.touches.length===_){if(_===1){tr(v[0],l),c.subVec2(l,f[0],d);const b=d[0],C=d[1];if(s.longTouchTimeout!==null&&(Math.abs(b)>i.longTapRadius||Math.abs(C)>i.longTapRadius)&&(clearTimeout(s.longTouchTimeout),s.longTouchTimeout=null),i.planView){const I=e.camera;if(I.projection==="perspective"){const S=Math.abs(e.camera.eyeLookDist)*Math.tan(I.perspective.fov/2*Math.PI/180);o.panDeltaX+=b*S/P*i.touchPanRate,o.panDeltaY+=C*S/P*i.touchPanRate}else o.panDeltaX+=.5*I.ortho.scale*(b/P)*i.touchPanRate,o.panDeltaY+=.5*I.ortho.scale*(C/P)*i.touchPanRate}else o.rotateDeltaY-=b/x*(i.dragRotationRate*1),o.rotateDeltaX+=C/P*(i.dragRotationRate*1.5)}else if(_===2){const b=v[0],C=v[1];tr(b,l),tr(C,h);const I=c.geometricMeanVec2(f[0],f[1]),E=c.geometricMeanVec2(l,h),S=c.vec2();c.subVec2(I,E,S);const R=S[0],D=S[1],K=e.camera,j=c.distVec2([b.pageX,b.pageY],[C.pageX,C.pageY]),le=(c.distVec2(f[0],f[1])-j)*i.touchDollyRate;if(o.dollyDelta=le,Math.abs(le)<1)if(K.projection==="perspective"){const ue=n.pickResult?n.pickResult.worldPos:e.center,Be=Math.abs(c.lenVec3(c.subVec3(ue,e.camera.eye,[])))*Math.tan(K.perspective.fov/2*Math.PI/180);o.panDeltaX-=R*Be/P*i.touchPanRate,o.panDeltaY-=D*Be/P*i.touchPanRate}else o.panDeltaX-=.5*K.ortho.scale*(R/P)*i.touchPanRate,o.panDeltaY-=.5*K.ortho.scale*(D/P)*i.touchPanRate;s.pointerCanvasPos=E}for(let b=0;b<_;++b)tr(v[b],f[b])}})}reset(){}destroy(){const e=this._scene.canvas.canvas;e.removeEventListener("touchstart",this._canvasTouchStartHandler),e.removeEventListener("touchend",this._canvasTouchEndHandler),e.removeEventListener("touchmove",this._canvasTouchMoveHandler),this._scene.off(this._onTick)}}const pb=150,fb=325,gb=4,xn=function(r,e){if(!r)r=window.event,e[0]=r.x,e[1]=r.y;else{let t=r.target,i=0,s=0;for(;t.offsetParent;)i+=t.offsetLeft,s+=t.offsetTop,t=t.offsetParent;e[0]=r.pageX-i,e[1]=r.pageY-s}return e};class mb{constructor(e,t,i,s,o){this._scene=e;const n=t.pickController,a=t.cameraControl;let A;const l=[],h=new Float32Array(2);let d=-1,f=-1;const m=this._scene.canvas.canvas,_=u=>{let B;u&&u.worldPos&&(B=u.worldPos);const y=u?u.entity.aabb:e.aabb;if(B){const x=e.camera;c.subVec3(x.eye,x.look,[]),t.cameraFlight.flyTo({aabb:y})}else t.cameraFlight.flyTo({aabb:y})};m.addEventListener("touchstart",this._canvasTouchStartHandler=u=>{if(!(i.active&&i.pointerEnabled))return;s.longTouchTimeout!==null&&(clearTimeout(s.longTouchTimeout),s.longTouchTimeout=null);const B=u.touches,y=u.changedTouches;if(A=Date.now(),B.length===1&&y.length===1){d=A,xn(B[0],h);const x=h[0],P=h[1],v=B[0].pageX,b=B[0].pageY;s.longTouchTimeout=setTimeout(()=>{t.cameraControl.fire("rightClick",{pagePos:[Math.round(v),Math.round(b)],canvasPos:[Math.round(x),Math.round(P)],event:u},!0),s.longTouchTimeout=null},i.longTapTimeout)}else d=-1;for(;l.length<B.length;)l.push(new Float32Array(2));for(let x=0,P=B.length;x<P;++x)xn(B[x],l[x]);l.length=B.length},{passive:!0}),m.addEventListener("touchend",this._canvasTouchEndHandler=u=>{if(!(i.active&&i.pointerEnabled))return;const B=Date.now(),y=u.touches,x=u.changedTouches,P=a.hasSubs("pickedSurface");s.longTouchTimeout!==null&&(clearTimeout(s.longTouchTimeout),s.longTouchTimeout=null),y.length===0&&x.length===1&&d>-1&&B-d<pb&&(f>-1&&d-f<fb?(xn(x[0],n.pickCursorPos),n.schedulePickEntity=!0,n.schedulePickSurface=P,n.update(),n.pickResult?(n.pickResult.touchInput=!0,a.fire("doublePicked",n.pickResult),n.pickedSurface&&a.fire("doublePickedSurface",n.pickResult),i.doublePickFlyTo&&_(n.pickResult)):(a.fire("doublePickedNothing"),i.doublePickFlyTo&&_()),f=-1):c.distVec2(l[0],h)<gb&&(xn(x[0],n.pickCursorPos),n.schedulePickEntity=!0,n.schedulePickSurface=P,n.update(),n.pickResult?(n.pickResult.touchInput=!0,a.fire("picked",n.pickResult),n.pickedSurface&&a.fire("pickedSurface",n.pickResult)):a.fire("pickedNothing"),f=B),d=-1),l.length=y.length;for(let v=0,b=y.length;v<b;++v)l[v][0]=y[v].pageX,l[v][1]=y[v].pageY},{passive:!0})}reset(){}destroy(){const e=this._scene.canvas.canvas;e.removeEventListener("touchstart",this._canvasTouchStartHandler),e.removeEventListener("touchend",this._canvasTouchEndHandler)}}const Pd=30,_b=!0,vb=!0;class Bb extends It{constructor(e,t={}){super(e,t),this.PAN_LEFT=0,this.PAN_RIGHT=1,this.PAN_UP=2,this.PAN_DOWN=3,this.PAN_FORWARDS=4,this.PAN_BACKWARDS=5,this.ROTATE_X_POS=6,this.ROTATE_X_NEG=7,this.ROTATE_Y_POS=8,this.ROTATE_Y_NEG=9,this.DOLLY_FORWARDS=10,this.DOLLY_BACKWARDS=11,this.AXIS_VIEW_RIGHT=12,this.AXIS_VIEW_BACK=13,this.AXIS_VIEW_LEFT=14,this.AXIS_VIEW_FRONT=15,this.AXIS_VIEW_TOP=16,this.AXIS_VIEW_BOTTOM=17,this._keyMap={},this.scene.canvas.canvas.oncontextmenu=s=>{s.preventDefault()},this._configs={longTapTimeout:600,longTapRadius:5,active:!0,keyboardLayout:"qwerty",navMode:"orbit",planView:!1,firstPerson:!1,followPointer:!0,doublePickFlyTo:!0,panRightClick:!0,showPivot:!1,pointerEnabled:!0,constrainVertical:!1,smartPivot:!1,doubleClickTimeFrame:250,snapToVertex:_b,snapToEdge:vb,snapRadius:Pd,dragRotationRate:360,keyboardRotationRate:90,rotationInertia:0,keyboardPanRate:1,touchPanRate:1,panInertia:.5,keyboardDollyRate:10,mouseWheelDollyRate:100,touchDollyRate:.2,dollyInertia:0,dollyProximityThreshold:30,dollyMinSpeed:.04},this._states={pointerCanvasPos:c.vec2(),mouseover:!1,followPointerDirty:!0,mouseDownClientX:0,mouseDownClientY:0,mouseDownCursorX:0,mouseDownCursorY:0,touchStartTime:null,activeTouches:[],tapStartPos:c.vec2(),tapStartTime:-1,lastTapTime:-1,longTouchTimeout:null},this._updates={rotateDeltaX:0,rotateDeltaY:0,panDeltaX:0,panDeltaY:0,panDeltaZ:0,dollyDelta:0};const i=this.scene;this._controllers={cameraControl:this,pickController:new sb(this,this._configs),pivotController:new ib(i,this._configs),panController:new Zw(i),cameraFlight:new Us(this,{duration:.5})},this._handlers=[new ub(this.scene,this._controllers,this._configs,this._states,this._updates),new db(this.scene,this._controllers,this._configs,this._states,this._updates),new ob(this.scene,this._controllers,this._configs,this._states,this._updates),new ab(this.scene,this._controllers,this._configs,this._states,this._updates),new Ab(this.scene,this._controllers,this._configs,this._states,this._updates),new mb(this.scene,this._controllers,this._configs,this._states,this._updates),new lb(this.scene,this._controllers,this._configs,this._states,this._updates)],this._cameraUpdater=new hb(this.scene,this._controllers,this._configs,this._states,this._updates),this.navMode=t.navMode,t.planView&&(this.planView=t.planView),this.constrainVertical=t.constrainVertical,t.keyboardLayout?this.keyboardLayout=t.keyboardLayout:this.keyMap=t.keyMap,this.doublePickFlyTo=t.doublePickFlyTo,this.panRightClick=t.panRightClick,this.active=t.active,this.followPointer=t.followPointer,this.rotationInertia=t.rotationInertia,this.keyboardPanRate=t.keyboardPanRate,this.touchPanRate=t.touchPanRate,this.keyboardRotationRate=t.keyboardRotationRate,this.dragRotationRate=t.dragRotationRate,this.touchDollyRate=t.touchDollyRate,this.dollyInertia=t.dollyInertia,this.dollyProximityThreshold=t.dollyProximityThreshold,this.dollyMinSpeed=t.dollyMinSpeed,this.panInertia=t.panInertia,this.pointerEnabled=!0,this.keyboardDollyRate=t.keyboardDollyRate,this.mouseWheelDollyRate=t.mouseWheelDollyRate}set keyMap(e){if(e=e||"qwerty",Se.isString(e)){const t=this.scene.input,i={};switch(e){default:this.error("Unsupported value for 'keyMap': "+e+" defaulting to 'qwerty'");case"qwerty":i[this.PAN_LEFT]=[t.KEY_A],i[this.PAN_RIGHT]=[t.KEY_D],i[this.PAN_UP]=[t.KEY_Z],i[this.PAN_DOWN]=[t.KEY_X],i[this.PAN_BACKWARDS]=[],i[this.PAN_FORWARDS]=[],i[this.DOLLY_FORWARDS]=[t.KEY_W,t.KEY_ADD],i[this.DOLLY_BACKWARDS]=[t.KEY_S,t.KEY_SUBTRACT],i[this.ROTATE_X_POS]=[t.KEY_DOWN_ARROW],i[this.ROTATE_X_NEG]=[t.KEY_UP_ARROW],i[this.ROTATE_Y_POS]=[t.KEY_Q,t.KEY_LEFT_ARROW],i[this.ROTATE_Y_NEG]=[t.KEY_E,t.KEY_RIGHT_ARROW],i[this.AXIS_VIEW_RIGHT]=[t.KEY_NUM_1],i[this.AXIS_VIEW_BACK]=[t.KEY_NUM_2],i[this.AXIS_VIEW_LEFT]=[t.KEY_NUM_3],i[this.AXIS_VIEW_FRONT]=[t.KEY_NUM_4],i[this.AXIS_VIEW_TOP]=[t.KEY_NUM_5],i[this.AXIS_VIEW_BOTTOM]=[t.KEY_NUM_6];break;case"azerty":i[this.PAN_LEFT]=[t.KEY_Q],i[this.PAN_RIGHT]=[t.KEY_D],i[this.PAN_UP]=[t.KEY_W],i[this.PAN_DOWN]=[t.KEY_X],i[this.PAN_BACKWARDS]=[],i[this.PAN_FORWARDS]=[],i[this.DOLLY_FORWARDS]=[t.KEY_Z,t.KEY_ADD],i[this.DOLLY_BACKWARDS]=[t.KEY_S,t.KEY_SUBTRACT],i[this.ROTATE_X_POS]=[t.KEY_DOWN_ARROW],i[this.ROTATE_X_NEG]=[t.KEY_UP_ARROW],i[this.ROTATE_Y_POS]=[t.KEY_A,t.KEY_LEFT_ARROW],i[this.ROTATE_Y_NEG]=[t.KEY_E,t.KEY_RIGHT_ARROW],i[this.AXIS_VIEW_RIGHT]=[t.KEY_NUM_1],i[this.AXIS_VIEW_BACK]=[t.KEY_NUM_2],i[this.AXIS_VIEW_LEFT]=[t.KEY_NUM_3],i[this.AXIS_VIEW_FRONT]=[t.KEY_NUM_4],i[this.AXIS_VIEW_TOP]=[t.KEY_NUM_5],i[this.AXIS_VIEW_BOTTOM]=[t.KEY_NUM_6];break}this._keyMap=i}else{const t=e;this._keyMap=t}}get keyMap(){return this._keyMap}_isKeyDownForAction(e,t){const i=this._keyMap[e];if(!i)return!1;t||(t=this.scene.input.keyDown);for(let s=0,o=i.length;s<o;s++){const n=i[s];if(t[n])return!0}return!1}set pivotElement(e){this._controllers.pivotController.setPivotElement(e)}set active(e){e=e!==!1,this._configs.active=e,this._handlers[1]._active=e,this._handlers[5]._active=e}get active(){return this._configs.active}set snapToVertex(e){this._configs.snapToVertex=!!e}get snapToVertex(){return this._configs.snapToVertex}set snapToEdge(e){this._configs.snapToEdge=!!e}get snapToEdge(){return this._configs.snapToEdge}set snapRadius(e){e=e||Pd,this._configs.snapRadius=e}get snapRadius(){return this._configs.snapRadius}set navMode(e){e=e||"orbit",e!=="firstPerson"&&e!=="orbit"&&e!=="planView"&&(this.error("Unsupported value for navMode: "+e+" - supported values are 'orbit', 'firstPerson' and 'planView' - defaulting to 'orbit'"),e="orbit"),this._configs.firstPerson=e==="firstPerson",this._configs.planView=e==="planView",(this._configs.firstPerson||this._configs.planView)&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot()),this._configs.navMode=e}get navMode(){return this._configs.navMode}set pointerEnabled(e){this._reset(),this._configs.pointerEnabled=!!e}_reset(){for(let e=0,t=this._handlers.length;e<t;e++){const i=this._handlers[e];i.reset&&i.reset()}this._updates.panDeltaX=0,this._updates.panDeltaY=0,this._updates.rotateDeltaX=0,this._updates.rotateDeltaY=0,this._updates.dolyDelta=0}get pointerEnabled(){return this._configs.pointerEnabled}set followPointer(e){this._configs.followPointer=e!==!1}get followPointer(){return this._configs.followPointer}set pivotPos(e){this._controllers.pivotController.setPivotPos(e)}get pivotPos(){return this._controllers.pivotController.getPivotPos()}set dollyToPointer(e){this.warn("dollyToPointer property is deprecated - replaced with followPointer"),this.followPointer=e}get dollyToPointer(){return this.warn("dollyToPointer property is deprecated - replaced with followPointer"),this.followPointer}set panToPointer(e){this.warn("panToPointer property is deprecated - replaced with followPointer")}get panToPointer(){return this.warn("panToPointer property is deprecated - replaced with followPointer"),!1}set planView(e){this._configs.planView=!!e,this._configs.firstPerson=!1,this._configs.planView&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot()),this.warn("planView property is deprecated - replaced with navMode")}get planView(){return this.warn("planView property is deprecated - replaced with navMode"),this._configs.planView}set firstPerson(e){this.warn("firstPerson property is deprecated - replaced with navMode"),this._configs.firstPerson=!!e,this._configs.planView=!1,this._configs.firstPerson&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot())}get firstPerson(){return this.warn("firstPerson property is deprecated - replaced with navMode"),this._configs.firstPerson}set constrainVertical(e){this._configs.constrainVertical=!!e}get constrainVertical(){return this._configs.constrainVertical}set doublePickFlyTo(e){this._configs.doublePickFlyTo=e!==!1}get doublePickFlyTo(){return this._configs.doublePickFlyTo}set panRightClick(e){this._configs.panRightClick=e!==!1}get panRightClick(){return this._configs.panRightClick}set rotationInertia(e){this._configs.rotationInertia=e??0}get rotationInertia(){return this._configs.rotationInertia}set keyboardPanRate(e){this._configs.keyboardPanRate=e??5}set touchPanRate(e){this._configs.touchPanRate=e??1}get touchPanRate(){return this._configs.touchPanRate}get keyboardPanRate(){return this._configs.keyboardPanRate}set keyboardRotationRate(e){this._configs.keyboardRotationRate=e??90}get keyboardRotationRate(){return this._configs.keyboardRotationRate}set dragRotationRate(e){this._configs.dragRotationRate=e??360}get dragRotationRate(){return this._configs.dragRotationRate}set keyboardDollyRate(e){this._configs.keyboardDollyRate=e??15}get keyboardDollyRate(){return this._configs.keyboardDollyRate}set touchDollyRate(e){this._configs.touchDollyRate=e??.2}get touchDollyRate(){return this._configs.touchDollyRate}set mouseWheelDollyRate(e){this._configs.mouseWheelDollyRate=e??100}get mouseWheelDollyRate(){return this._configs.mouseWheelDollyRate}set dollyInertia(e){this._configs.dollyInertia=e??0}get dollyInertia(){return this._configs.dollyInertia}set dollyProximityThreshold(e){this._configs.dollyProximityThreshold=e??35}get dollyProximityThreshold(){return this._configs.dollyProximityThreshold}set dollyMinSpeed(e){this._configs.dollyMinSpeed=e??.04}get dollyMinSpeed(){return this._configs.dollyMinSpeed}set panInertia(e){this._configs.panInertia=e??.5}get panInertia(){return this._configs.panInertia}set keyboardLayout(e){e=e||"qwerty",e!=="qwerty"&&e!=="azerty"&&(this.error("Unsupported value for keyboardLayout - defaulting to 'qwerty'"),e="qwerty"),this._configs.keyboardLayout=e,this.keyMap=this._configs.keyboardLayout}get keyboardLayout(){return this._configs.keyboardLayout}enablePivotSphere(e={}){this._controllers.pivotController.enablePivotSphere(e)}disablePivotSphere(){this._controllers.pivotController.disablePivotSphere()}set smartPivot(e){this._configs.smartPivot=e!==!1}get smartPivot(){return this._configs.smartPivot}set doubleClickTimeFrame(e){this._configs.doubleClickTimeFrame=e??250}get doubleClickTimeFrame(){return this._configs.doubleClickTimeFrame}destroy(){this._destroyHandlers(),this._destroyControllers(),this._cameraUpdater.destroy(),super.destroy()}_destroyHandlers(){for(let e=0,t=this._handlers.length;e<t;e++){const i=this._handlers[e];i.destroy&&i.destroy()}}_destroyControllers(){for(let e=0,t=this._controllers.length;e<t;e++){const i=this._controllers[e];i.destroy&&i.destroy()}}}class Pb{constructor(e,t,i,s,o){this.name=e,this.type=i,this.value=t,this.valueType=s,this.description=o}}class yb{constructor(e){if(this.id=e.id,this.originalSystemId=e.originalSystemId,this.metaModels=[],this.name=e.name,this.type=e.type,this.properties=[],e.properties){const t=e.properties;for(let i=0,s=t.length;i<s;i++){const o=t[i];this.properties.push(new Pb(o.name,o.value,o.type,o.valueType,o.description))}}}}class xb{constructor(e){this.metaModels=[],this.id=e.id,this.parentId=e.parentId,this.parent=null,this.originalSystemId=e.originalSystemId,this.name=e.name,this.type=e.type,this.propertySetIds=e.propertySetIds,this.propertySets=[],this.attributes=e.attributes||{},e.external!==void 0&&e.external!==null&&(this.external=e.external)}get metaModel(){return this.metaModels.length==1?this.metaModels[0]:null}getObjectIDsInSubtree(){const e=[];function t(i){if(!i)return;e.push(i.id);const s=i.children;if(s)for(var o=0,n=s.length;o<n;o++)t(s[o])}return t(this),e}withMetaObjectsInSubtree(e){function t(i){if(!i)return;e(i);const s=i.children;if(s)for(var o=0,n=s.length;o<n;o++)t(s[o])}t(this)}getObjectIDsInSubtreeByType(e){const t={};for(var i=0,s=e.length;i<s;i++)t[e[i]]=e[i];const o=[];function n(a){if(!a)return;t[a.type]&&o.push(a.id);const A=a.children;if(A)for(var l=0,h=A.length;l<h;l++)n(A[l])}return n(this),o}getJSON(){var e={id:this.id,type:this.type,name:this.name};return this.parent&&(e.parent=this.parent.id),e}}class wb{constructor(e){this.id=e.id,this.projectId=e.projectId,this.revisionId=e.revisionId,this.author=e.author,this.createdAt=e.createdAt,this.creatingApplication=e.creatingApplication,this.schema=e.schema,this.metaScene=e.metaScene,this.propertySets=[],this.rootMetaObjects=[],this.metaObjects=[],this.graph=e.graph||{},this.metaScene.metaModels[this.id]=this,this.finalized=!1}get rootMetaObject(){return this.rootMetaObjects.length==1?this.rootMetaObjects[0]:null}loadData(e,t={}){if(this.finalized)throw"MetaScene already finalized - can't add more data";this._globalizeIDs(e,t);const i=this.metaScene,s=e.properties;if(e.propertySets)for(let o=0,n=e.propertySets.length;o<n;o++){const a=e.propertySets[o];a.properties||(a.properties=[]);let A=i.propertySets[a.id];A||(s&&this._decompressProperties(s,a.properties),A=new yb({id:a.id,originalSystemId:a.originalSystemId||a.id,type:a.type,name:a.name,properties:a.properties}),i.propertySets[A.id]=A),A.metaModels.push(this),this.propertySets.push(A)}if(e.metaObjects)for(let o=0,n=e.metaObjects.length;o<n;o++){const a=e.metaObjects[o],A=a.id;let l=i.metaObjects[A];if(!l){const h=a.type,d=a.originalSystemId,f=a.propertySets||a.propertySetIds;l=new xb({id:A,originalSystemId:d,parentId:a.parent,type:h,name:a.name,attributes:a.attributes,propertySetIds:f,external:a.external}),this.metaScene.metaObjects[A]=l,l.metaModels=[]}this.metaObjects.push(l),a.parent||(this.rootMetaObjects.push(l),i.rootMetaObjects[A]=l)}}_decompressProperties(e,t){for(let i=0,s=t.length;i<s;i++){const o=t[i];if(Number.isInteger(o)){const n=e[o];n&&(t[i]=n)}}}finalize(){if(this.finalized)throw"MetaScene already finalized - can't re-finalize";const e=this.metaScene;for(let t in e.metaObjects){const i=e.metaObjects[t];if(i.children&&(i.children=[]),i.propertySets&&(i.propertySets=[]),i.propertySetIds)for(let s=0,o=i.propertySetIds.length;s<o;s++){const n=i.propertySetIds[s],a=e.propertySets[n];i.propertySets.push(a)}}for(let t in e.metaObjects){const i=e.metaObjects[t];if(i.parentId){const s=e.metaObjects[i.parentId];s&&(i.parent=s,(s.children||(s.children=[])).push(i))}}for(let t in e.metaObjects){const i=e.metaObjects[t];i.metaModels=[]}for(let t in e.metaModels){const i=e.metaModels[t];for(let s=0,o=i.metaObjects.length;s<o;s++)i.metaObjects[s].metaModels.push(i)}e.metaObjectsByType={};for(let t in e.metaObjects){const i=e.metaObjects[t],s=i.type;(e.metaObjectsByType[s]||(e.metaObjectsByType[s]={}))[t]=i}this.finalized=!0,this.metaScene.fire("metaModelCreated",this.id)}getJSON(){const e={id:this.id,projectId:this.projectId,author:this.author,createdAt:this.createdAt,schema:this.schema,creatingApplication:this.creatingApplication,metaObjects:[],propertySets:[]};for(let t=0,i=this.metaObjects.length;t<i;t++){const s=this.metaObjects[t],o={id:s.id,originalSystemId:s.originalSystemId,extId:s.extId,type:s.type,name:s.name};s.parent&&(o.parent=s.parent.id),s.attributes&&(o.attributes=s.attributes),s.propertySetIds&&(o.propertySetIds=s.propertySetIds),e.metaObjects.push(o)}for(let t=0,i=this.propertySets.length;t<i;t++){const s=this.propertySets[t],o={id:s.id,originalSystemId:s.originalSystemId,extId:s.extId,type:s.type,name:s.name,propertyies:[]};for(let n=0,a=s.properties.length;n<a;n++){const A=s.properties[n],l={id:A.id,description:A.description,type:A.type,name:A.name,value:A.value,valueType:A.valueType};o.properties.push(l)}e.propertySets.push(o)}return e}_globalizeIDs(e,t){const i=!!t.globalizeObjectIds;if(e.metaObjects)for(let s=0,o=e.metaObjects.length;s<o;s++){const n=e.metaObjects[s];if(n.originalSystemId=n.id,n.parent&&(n.originalParentSystemId=n.parent),i&&(n.id=c.globalizeObjectId(this.id,n.id),n.parent&&(n.parent=c.globalizeObjectId(this.id,n.parent))),i){const a=n.propertySetIds;if(a){const A=[];for(let l=0,h=a.length;l<h;l++)A.push(c.globalizeObjectId(this.id,a[l]));n.propertySetIds=A,n.originalSystemPropertySetIds=a}}else n.originalSystemPropertySetIds=n.propertySetIds}if(e.propertySets)for(let s=0,o=e.propertySets.length;s<o;s++){const n=e.propertySets[s];n.originalSystemId=n.id,i&&(n.id=c.globalizeObjectId(this.id,n.id))}}}class bb{constructor(e,t){this.viewer=e,this.scene=t,this.metaModels={},this.propertySets={},this.metaObjects={},this.metaObjectsByType={},this.rootMetaObjects={},this._eventSubs={}}on(e,t){let i=this._eventSubs[e];i||(i=[],this._eventSubs[e]=i),i.push(t)}fire(e,t){const i=this._eventSubs[e];if(i)for(let s=0,o=i.length;s<o;s++)i[s](t)}off(e){}createMetaModel(e,t,i={}){const s=new wb({metaScene:this,id:e,projectId:t.projectId||"none",revisionId:t.revisionId||"none",author:t.author||"none",createdAt:t.createdAt||"none",creatingApplication:t.creatingApplication||"none",schema:t.schema||"none",propertySets:[]});return s.loadData(t),s.finalize(),s}destroyMetaModel(e){const t=this.metaModels[e];if(t){if(t.propertySets)for(let i=0,s=t.propertySets.length;i<s;i++){const o=t.propertySets[i];if(o.metaModels.length===1&&o.metaModels[0].id===e)delete this.propertySets[o.id];else{const n=[];for(let a=0,A=o.metaModels.length;a<A;a++)o.metaModels[a].id!==e&&n.push(o.metaModels[a]);o.metaModels=n}}if(t.metaObjects)for(let i=0,s=t.metaObjects.length;i<s;i++){const o=t.metaObjects[i];o.type;const n=o.id;o.metaModels.length===1&&o.metaModels[0].id===e&&(delete this.metaObjects[n],o.parent||delete this.rootMetaObjects[n])}for(let i in this.metaObjects){const s=this.metaObjects[i];if(s.children&&(s.children=[]),s.propertySets&&(s.propertySets=[]),s.propertySetIds)for(let o=0,n=s.propertySetIds.length;o<n;o++){const a=s.propertySetIds[o],A=this.propertySets[a];s.propertySets.push(A)}}this.metaObjectsByType={};for(let i in this.metaObjects){const s=this.metaObjects[i],o=s.type;s.children&&(s.children=null),(this.metaObjectsByType[o]||(this.metaObjectsByType[o]={}))[i]=s}for(let i in this.metaObjects){const s=this.metaObjects[i];if(s.parentId){const o=this.metaObjects[s.parentId];o&&(s.parent=o,(o.children||(o.children=[])).push(s))}}delete this.metaModels[e];for(let i in this.metaObjects){const s=this.metaObjects[i];s.metaModels=[]}for(let i in this.metaModels){const s=this.metaModels[i];for(let o=0,n=s.metaObjects.length;o<n;o++)s.metaObjects[o].metaModels.push(s)}this.fire("metaModelDestroyed",e)}}getObjectIDsByType(e){const t=this.metaObjectsByType[e];return t?Object.keys(t):[]}getObjectIDsInSubtree(e,t,i){const s=[],o=this.metaObjects[e],n=t&&t.length>0?yd(t):null,a=i&&i.length>0?yd(i):null,A=l=>{if(!l)return;var h=!0;(a&&a[l.type]||n&&!n[l.type])&&(h=!1),h&&s.push(l.id);const d=l.children;if(d)for(var f=0,m=d.length;f<m;f++)A(d[f])};return A(o),s}withMetaObjectsInSubtree(e,t){const i=this.metaObjects[e];i&&i.withMetaObjectsInSubtree(t)}}function yd(r){const e={};for(var t=0,i=r.length;t<i;t++)e[r[t]]=!0;return e}/*!
 * html2canvas 1.4.1 <https://html2canvas.hertzen.com>
 * Copyright (c) 2022 Niklas von Hertzen <https://hertzen.com>
 * Released under MIT License
 *//*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var Hl=function(r,e){return Hl=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(t[s]=i[s])},Hl(r,e)};function Ti(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");Hl(r,e);function t(){this.constructor=r}r.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}var Vl=function(){return Vl=Object.assign||function(e){for(var t,i=1,s=arguments.length;i<s;i++){t=arguments[i];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e},Vl.apply(this,arguments)};function ai(r,e,t,i){function s(o){return o instanceof t?o:new t(function(n){n(o)})}return new(t||(t=Promise))(function(o,n){function a(h){try{l(i.next(h))}catch(d){n(d)}}function A(h){try{l(i.throw(h))}catch(d){n(d)}}function l(h){h.done?o(h.value):s(h.value).then(a,A)}l((i=i.apply(r,[])).next())})}function ei(r,e){var t={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},i,s,o,n;return n={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(n[Symbol.iterator]=function(){return this}),n;function a(l){return function(h){return A([l,h])}}function A(l){if(i)throw new TypeError("Generator is already executing.");for(;t;)try{if(i=1,s&&(o=l[0]&2?s.return:l[0]?s.throw||((o=s.return)&&o.call(s),0):s.next)&&!(o=o.call(s,l[1])).done)return o;switch(s=0,o&&(l=[l[0]&2,o.value]),l[0]){case 0:case 1:o=l;break;case 4:return t.label++,{value:l[1],done:!1};case 5:t.label++,s=l[1],l=[0];continue;case 7:l=t.ops.pop(),t.trys.pop();continue;default:if(o=t.trys,!(o=o.length>0&&o[o.length-1])&&(l[0]===6||l[0]===2)){t=0;continue}if(l[0]===3&&(!o||l[1]>o[0]&&l[1]<o[3])){t.label=l[1];break}if(l[0]===6&&t.label<o[1]){t.label=o[1],o=l;break}if(o&&t.label<o[2]){t.label=o[2],t.ops.push(l);break}o[2]&&t.ops.pop(),t.trys.pop();continue}l=e.call(r,t)}catch(h){l=[6,h],s=0}finally{i=o=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}function wn(r,e,t){if(arguments.length===2)for(var i=0,s=e.length,o;i<s;i++)(o||!(i in e))&&(o||(o=Array.prototype.slice.call(e,0,i)),o[i]=e[i]);return r.concat(o||e)}var As=function(){function r(e,t,i,s){this.left=e,this.top=t,this.width=i,this.height=s}return r.prototype.add=function(e,t,i,s){return new r(this.left+e,this.top+t,this.width+i,this.height+s)},r.fromClientRect=function(e,t){return new r(t.left+e.windowBounds.left,t.top+e.windowBounds.top,t.width,t.height)},r.fromDOMRectList=function(e,t){var i=Array.from(t).find(function(s){return s.width!==0});return i?new r(i.left+e.windowBounds.left,i.top+e.windowBounds.top,i.width,i.height):r.EMPTY},r.EMPTY=new r(0,0,0,0),r}(),Ia=function(r,e){return As.fromClientRect(r,e.getBoundingClientRect())},Cb=function(r){var e=r.body,t=r.documentElement;if(!e||!t)throw new Error("Unable to get document size");var i=Math.max(Math.max(e.scrollWidth,t.scrollWidth),Math.max(e.offsetWidth,t.offsetWidth),Math.max(e.clientWidth,t.clientWidth)),s=Math.max(Math.max(e.scrollHeight,t.scrollHeight),Math.max(e.offsetHeight,t.offsetHeight),Math.max(e.clientHeight,t.clientHeight));return new As(0,0,i,s)},Fa=function(r){for(var e=[],t=0,i=r.length;t<i;){var s=r.charCodeAt(t++);if(s>=55296&&s<=56319&&t<i){var o=r.charCodeAt(t++);(o&64512)===56320?e.push(((s&1023)<<10)+(o&1023)+65536):(e.push(s),t--)}else e.push(s)}return e},Lt=function(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];if(String.fromCodePoint)return String.fromCodePoint.apply(String,r);var t=r.length;if(!t)return"";for(var i=[],s=-1,o="";++s<t;){var n=r[s];n<=65535?i.push(n):(n-=65536,i.push((n>>10)+55296,n%1024+56320)),(s+1===t||i.length>16384)&&(o+=String.fromCharCode.apply(String,i),i.length=0)}return o},xd="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Eb=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var bn=0;bn<xd.length;bn++)Eb[xd.charCodeAt(bn)]=bn;var wd="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",uo=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var Cn=0;Cn<wd.length;Cn++)uo[wd.charCodeAt(Cn)]=Cn;var Ib=function(r){var e=r.length*.75,t=r.length,i,s=0,o,n,a,A;r[r.length-1]==="="&&(e--,r[r.length-2]==="="&&e--);var l=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u"&&typeof Uint8Array.prototype.slice<"u"?new ArrayBuffer(e):new Array(e),h=Array.isArray(l)?l:new Uint8Array(l);for(i=0;i<t;i+=4)o=uo[r.charCodeAt(i)],n=uo[r.charCodeAt(i+1)],a=uo[r.charCodeAt(i+2)],A=uo[r.charCodeAt(i+3)],h[s++]=o<<2|n>>4,h[s++]=(n&15)<<4|a>>2,h[s++]=(a&3)<<6|A&63;return l},Fb=function(r){for(var e=r.length,t=[],i=0;i<e;i+=2)t.push(r[i+1]<<8|r[i]);return t},Mb=function(r){for(var e=r.length,t=[],i=0;i<e;i+=4)t.push(r[i+3]<<24|r[i+2]<<16|r[i+1]<<8|r[i]);return t},Os=5,xc=11,VA=2,Sb=xc-Os,og=65536>>Os,Tb=1<<Os,GA=Tb-1,Db=1024>>Os,Rb=og+Db,Lb=Rb,Ub=32,Ob=Lb+Ub,kb=65536>>xc,Nb=1<<Sb,Qb=Nb-1,bd=function(r,e,t){return r.slice?r.slice(e,t):new Uint16Array(Array.prototype.slice.call(r,e,t))},Hb=function(r,e,t){return r.slice?r.slice(e,t):new Uint32Array(Array.prototype.slice.call(r,e,t))},Vb=function(r,e){var t=Ib(r),i=Array.isArray(t)?Mb(t):new Uint32Array(t),s=Array.isArray(t)?Fb(t):new Uint16Array(t),o=24,n=bd(s,o/2,i[4]/2),a=i[5]===2?bd(s,(o+i[4])/2):Hb(i,Math.ceil((o+i[4])/4));return new Gb(i[0],i[1],i[2],i[3],n,a)},Gb=function(){function r(e,t,i,s,o,n){this.initialValue=e,this.errorValue=t,this.highStart=i,this.highValueIndex=s,this.index=o,this.data=n}return r.prototype.get=function(e){var t;if(e>=0){if(e<55296||e>56319&&e<=65535)return t=this.index[e>>Os],t=(t<<VA)+(e&GA),this.data[t];if(e<=65535)return t=this.index[og+(e-55296>>Os)],t=(t<<VA)+(e&GA),this.data[t];if(e<this.highStart)return t=Ob-kb+(e>>xc),t=this.index[t],t+=e>>Os&Qb,t=this.index[t],t=(t<<VA)+(e&GA),this.data[t];if(e<=1114111)return this.data[this.highValueIndex]}return this.errorValue},r}(),Cd="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",jb=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var En=0;En<Cd.length;En++)jb[Cd.charCodeAt(En)]=En;var zb="KwAAAAAAAAAACA4AUD0AADAgAAACAAAAAAAIABAAGABAAEgAUABYAGAAaABgAGgAYgBqAF8AZwBgAGgAcQB5AHUAfQCFAI0AlQCdAKIAqgCyALoAYABoAGAAaABgAGgAwgDKAGAAaADGAM4A0wDbAOEA6QDxAPkAAQEJAQ8BFwF1AH0AHAEkASwBNAE6AUIBQQFJAVEBWQFhAWgBcAF4ATAAgAGGAY4BlQGXAZ8BpwGvAbUBvQHFAc0B0wHbAeMB6wHxAfkBAQIJAvEBEQIZAiECKQIxAjgCQAJGAk4CVgJeAmQCbAJ0AnwCgQKJApECmQKgAqgCsAK4ArwCxAIwAMwC0wLbAjAA4wLrAvMC+AIAAwcDDwMwABcDHQMlAy0DNQN1AD0DQQNJA0kDSQNRA1EDVwNZA1kDdQB1AGEDdQBpA20DdQN1AHsDdQCBA4kDkQN1AHUAmQOhA3UAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AKYDrgN1AHUAtgO+A8YDzgPWAxcD3gPjA+sD8wN1AHUA+wMDBAkEdQANBBUEHQQlBCoEFwMyBDgEYABABBcDSARQBFgEYARoBDAAcAQzAXgEgASIBJAEdQCXBHUAnwSnBK4EtgS6BMIEyAR1AHUAdQB1AHUAdQCVANAEYABgAGAAYABgAGAAYABgANgEYADcBOQEYADsBPQE/AQEBQwFFAUcBSQFLAU0BWQEPAVEBUsFUwVbBWAAYgVgAGoFcgV6BYIFigWRBWAAmQWfBaYFYABgAGAAYABgAKoFYACxBbAFuQW6BcEFwQXHBcEFwQXPBdMF2wXjBeoF8gX6BQIGCgYSBhoGIgYqBjIGOgZgAD4GRgZMBmAAUwZaBmAAYABgAGAAYABgAGAAYABgAGAAYABgAGIGYABpBnAGYABgAGAAYABgAGAAYABgAGAAYAB4Bn8GhQZgAGAAYAB1AHcDFQSLBmAAYABgAJMGdQA9A3UAmwajBqsGqwaVALMGuwbDBjAAywbSBtIG1QbSBtIG0gbSBtIG0gbdBuMG6wbzBvsGAwcLBxMHAwcbByMHJwcsBywHMQcsB9IGOAdAB0gHTgfSBkgHVgfSBtIG0gbSBtIG0gbSBtIG0gbSBiwHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAdgAGAALAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAdbB2MHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsB2kH0gZwB64EdQB1AHUAdQB1AHUAdQB1AHUHfQdgAIUHjQd1AHUAlQedB2AAYAClB6sHYACzB7YHvgfGB3UAzgfWBzMB3gfmB1EB7gf1B/0HlQENAQUIDQh1ABUIHQglCBcDLQg1CD0IRQhNCEEDUwh1AHUAdQBbCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIcAh3CHoIMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIgggwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAALAcsBywHLAcsBywHLAcsBywHLAcsB4oILAcsB44I0gaWCJ4Ipgh1AHUAqgiyCHUAdQB1AHUAdQB1AHUAdQB1AHUAtwh8AXUAvwh1AMUIyQjRCNkI4AjoCHUAdQB1AO4I9gj+CAYJDgkTCS0HGwkjCYIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiAAIAAAAFAAYABgAGIAXwBgAHEAdQBFAJUAogCyAKAAYABgAEIA4ABGANMA4QDxAMEBDwE1AFwBLAE6AQEBUQF4QkhCmEKoQrhCgAHIQsAB0MLAAcABwAHAAeDC6ABoAHDCwMMAAcABwAHAAdDDGMMAAcAB6MM4wwjDWMNow3jDaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAEjDqABWw6bDqABpg6gAaABoAHcDvwOPA+gAaABfA/8DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DpcPAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcAB9cPKwkyCToJMAB1AHUAdQBCCUoJTQl1AFUJXAljCWcJawkwADAAMAAwAHMJdQB2CX4JdQCECYoJjgmWCXUAngkwAGAAYABxAHUApgn3A64JtAl1ALkJdQDACTAAMAAwADAAdQB1AHUAdQB1AHUAdQB1AHUAowYNBMUIMAAwADAAMADICcsJ0wnZCRUE4QkwAOkJ8An4CTAAMAB1AAAKvwh1AAgKDwoXCh8KdQAwACcKLgp1ADYKqAmICT4KRgowADAAdQB1AE4KMAB1AFYKdQBeCnUAZQowADAAMAAwADAAMAAwADAAMAAVBHUAbQowADAAdQC5CXUKMAAwAHwBxAijBogEMgF9CoQKiASMCpQKmgqIBKIKqgquCogEDQG2Cr4KxgrLCjAAMADTCtsKCgHjCusK8Qr5CgELMAAwADAAMAB1AIsECQsRC3UANAEZCzAAMAAwADAAMAB1ACELKQswAHUANAExCzkLdQBBC0kLMABRC1kLMAAwADAAMAAwADAAdQBhCzAAMAAwAGAAYABpC3ELdwt/CzAAMACHC4sLkwubC58Lpwt1AK4Ltgt1APsDMAAwADAAMAAwADAAMAAwAL4LwwvLC9IL1wvdCzAAMADlC+kL8Qv5C/8LSQswADAAMAAwADAAMAAwADAAMAAHDDAAMAAwADAAMAAODBYMHgx1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1ACYMMAAwADAAdQB1AHUALgx1AHUAdQB1AHUAdQA2DDAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AD4MdQBGDHUAdQB1AHUAdQB1AEkMdQB1AHUAdQB1AFAMMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQBYDHUAdQB1AF8MMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUA+wMVBGcMMAAwAHwBbwx1AHcMfwyHDI8MMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAYABgAJcMMAAwADAAdQB1AJ8MlQClDDAAMACtDCwHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsB7UMLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AA0EMAC9DDAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAsBywHLAcsBywHLAcsBywHLQcwAMEMyAwsBywHLAcsBywHLAcsBywHLAcsBywHzAwwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAHUAdQB1ANQM2QzhDDAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMABgAGAAYABgAGAAYABgAOkMYADxDGAA+AwADQYNYABhCWAAYAAODTAAMAAwADAAFg1gAGAAHg37AzAAMAAwADAAYABgACYNYAAsDTQNPA1gAEMNPg1LDWAAYABgAGAAYABgAGAAYABgAGAAUg1aDYsGVglhDV0NcQBnDW0NdQ15DWAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAlQCBDZUAiA2PDZcNMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAnw2nDTAAMAAwADAAMAAwAHUArw23DTAAMAAwADAAMAAwADAAMAAwADAAMAB1AL8NMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAB1AHUAdQB1AHUAdQDHDTAAYABgAM8NMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAA1w11ANwNMAAwAD0B5A0wADAAMAAwADAAMADsDfQN/A0EDgwOFA4wABsOMAAwADAAMAAwADAAMAAwANIG0gbSBtIG0gbSBtIG0gYjDigOwQUuDsEFMw7SBjoO0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGQg5KDlIOVg7SBtIGXg5lDm0OdQ7SBtIGfQ6EDooOjQ6UDtIGmg6hDtIG0gaoDqwO0ga0DrwO0gZgAGAAYADEDmAAYAAkBtIGzA5gANIOYADaDokO0gbSBt8O5w7SBu8O0gb1DvwO0gZgAGAAxA7SBtIG0gbSBtIGYABgAGAAYAAED2AAsAUMD9IG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGFA8sBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAccD9IGLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHJA8sBywHLAcsBywHLAccDywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywPLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAc0D9IG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAccD9IG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGFA8sBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHPA/SBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gYUD0QPlQCVAJUAMAAwADAAMACVAJUAlQCVAJUAlQCVAEwPMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAA//8EAAQABAAEAAQABAAEAAQABAANAAMAAQABAAIABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQACgATABcAHgAbABoAHgAXABYAEgAeABsAGAAPABgAHABLAEsASwBLAEsASwBLAEsASwBLABgAGAAeAB4AHgATAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQABYAGwASAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAWAA0AEQAeAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAFAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAJABYAGgAbABsAGwAeAB0AHQAeAE8AFwAeAA0AHgAeABoAGwBPAE8ADgBQAB0AHQAdAE8ATwAXAE8ATwBPABYAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAFAAUABQAFAAUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAB4AHgAeAFAATwBAAE8ATwBPAEAATwBQAFAATwBQAB4AHgAeAB4AHgAeAB0AHQAdAB0AHgAdAB4ADgBQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgBQAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAJAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAkACQAJAAkACQAJAAkABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgAeAFAAHgAeAB4AKwArAFAAUABQAFAAGABQACsAKwArACsAHgAeAFAAHgBQAFAAUAArAFAAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAAQABAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAUAAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAYAA0AKwArAB4AHgAbACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQADQAEAB4ABAAEAB4ABAAEABMABAArACsAKwArACsAKwArACsAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAKwArACsAKwBWAFYAVgBWAB4AHgArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AGgAaABoAGAAYAB4AHgAEAAQABAAEAAQABAAEAAQABAAEAAQAEwAEACsAEwATAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABLAEsASwBLAEsASwBLAEsASwBLABoAGQAZAB4AUABQAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQABMAUAAEAAQABAAEAAQABAAEAB4AHgAEAAQABAAEAAQABABQAFAABAAEAB4ABAAEAAQABABQAFAASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUAAeAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAFAABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQAUABQAB4AHgAYABMAUAArACsABAAbABsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAFAABAAEAAQABAAEAFAABAAEAAQAUAAEAAQABAAEAAQAKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAArACsAHgArAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAB4ABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAUAAEAAQABAAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAABAAEAA0ADQBLAEsASwBLAEsASwBLAEsASwBLAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAArAFAAUABQAFAAUABQAFAAUAArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUAArACsAKwBQAFAAUABQACsAKwAEAFAABAAEAAQABAAEAAQABAArACsABAAEACsAKwAEAAQABABQACsAKwArACsAKwArACsAKwAEACsAKwArACsAUABQACsAUABQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAFAAUAAaABoAUABQAFAAUABQAEwAHgAbAFAAHgAEACsAKwAEAAQABAArAFAAUABQAFAAUABQACsAKwArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQACsAUABQACsAKwAEACsABAAEAAQABAAEACsAKwArACsABAAEACsAKwAEAAQABAArACsAKwAEACsAKwArACsAKwArACsAUABQAFAAUAArAFAAKwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLAAQABABQAFAAUAAEAB4AKwArACsAKwArACsAKwArACsAKwAEAAQABAArAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQAFAAUABQACsAKwAEAFAABAAEAAQABAAEAAQABAAEACsABAAEAAQAKwAEAAQABAArACsAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAB4AGwArACsAKwArACsAKwArAFAABAAEAAQABAAEAAQAKwAEAAQABAArAFAAUABQAFAAUABQAFAAUAArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAArACsABAAEACsAKwAEAAQABAArACsAKwArACsAKwArAAQABAAEACsAKwArACsAUABQACsAUABQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAB4AUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArAAQAUAArAFAAUABQAFAAUABQACsAKwArAFAAUABQACsAUABQAFAAUAArACsAKwBQAFAAKwBQACsAUABQACsAKwArAFAAUAArACsAKwBQAFAAUAArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArAAQABAAEAAQABAArACsAKwAEAAQABAArAAQABAAEAAQAKwArAFAAKwArACsAKwArACsABAArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAHgAeAB4AHgAeAB4AGwAeACsAKwArACsAKwAEAAQABAAEAAQAUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAUAAEAAQABAAEAAQABAAEACsABAAEAAQAKwAEAAQABAAEACsAKwArACsAKwArACsABAAEACsAUABQAFAAKwArACsAKwArAFAAUAAEAAQAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAKwAOAFAAUABQAFAAUABQAFAAHgBQAAQABAAEAA4AUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAKwArAAQAUAAEAAQABAAEAAQABAAEACsABAAEAAQAKwAEAAQABAAEACsAKwArACsAKwArACsABAAEACsAKwArACsAKwArACsAUAArAFAAUAAEAAQAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwBQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAFAABAAEAAQABAAEAAQABAArAAQABAAEACsABAAEAAQABABQAB4AKwArACsAKwBQAFAAUAAEAFAAUABQAFAAUABQAFAAUABQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAFAAUABQAFAAUABQAFAAUABQABoAUABQAFAAUABQAFAAKwAEAAQABAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQACsAUAArACsAUABQAFAAUABQAFAAUAArACsAKwAEACsAKwArACsABAAEAAQABAAEAAQAKwAEACsABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArAAQABAAeACsAKwArACsAKwArACsAKwArACsAKwArAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAAqAFwAXAAqACoAKgAqACoAKgAqACsAKwArACsAGwBcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAeAEsASwBLAEsASwBLAEsASwBLAEsADQANACsAKwArACsAKwBcAFwAKwBcACsAXABcAFwAXABcACsAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACsAXAArAFwAXABcAFwAXABcAFwAXABcAFwAKgBcAFwAKgAqACoAKgAqACoAKgAqACoAXAArACsAXABcAFwAXABcACsAXAArACoAKgAqACoAKgAqACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwBcAFwAXABcAFAADgAOAA4ADgAeAA4ADgAJAA4ADgANAAkAEwATABMAEwATAAkAHgATAB4AHgAeAAQABAAeAB4AHgAeAB4AHgBLAEsASwBLAEsASwBLAEsASwBLAFAAUABQAFAAUABQAFAAUABQAFAADQAEAB4ABAAeAAQAFgARABYAEQAEAAQAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQADQAEAAQABAAEAAQADQAEAAQAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArAA0ADQAeAB4AHgAeAB4AHgAEAB4AHgAeAB4AHgAeACsAHgAeAA4ADgANAA4AHgAeAB4AHgAeAAkACQArACsAKwArACsAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgBcAEsASwBLAEsASwBLAEsASwBLAEsADQANAB4AHgAeAB4AXABcAFwAXABcAFwAKgAqACoAKgBcAFwAXABcACoAKgAqAFwAKgAqACoAXABcACoAKgAqACoAKgAqACoAXABcAFwAKgAqACoAKgBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAqACoAKgAqAFwAKgBLAEsASwBLAEsASwBLAEsASwBLACoAKgAqACoAKgAqAFAAUABQAFAAUABQACsAUAArACsAKwArACsAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgBQAFAAUABQAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUAArACsAUABQAFAAUABQAFAAUAArAFAAKwBQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAKwBQACsAUABQAFAAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsABAAEAAQAHgANAB4AHgAeAB4AHgAeAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUAArACsADQBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAANAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAWABEAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAA0ADQANAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAANAA0AKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUAArAAQABAArACsAKwArACsAKwArACsAKwArACsAKwBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqAA0ADQAVAFwADQAeAA0AGwBcACoAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwAeAB4AEwATAA0ADQAOAB4AEwATAB4ABAAEAAQACQArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUAAEAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAHgArACsAKwATABMASwBLAEsASwBLAEsASwBLAEsASwBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAArACsAXABcAFwAXABcACsAKwArACsAKwArACsAKwArACsAKwBcAFwAXABcAFwAXABcAFwAXABcAFwAXAArACsAKwArAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAXAArACsAKwAqACoAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAArACsAHgAeAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAqACoAKwAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKwArAAQASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArACoAKgAqACoAKgAqACoAXAAqACoAKgAqACoAKgArACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsABAAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABABQAFAAUABQAFAAUABQACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwANAA0AHgANAA0ADQANAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAAQABAAEAAQAHgAeAB4AHgAeAB4AHgAeAB4AKwArACsABAAEAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwAeAB4AHgAeAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArAA0ADQANAA0ADQBLAEsASwBLAEsASwBLAEsASwBLACsAKwArAFAAUABQAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAA0ADQBQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUAAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArAAQABAAEAB4ABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAAQAUABQAFAAUABQAFAABABQAFAABAAEAAQAUAArACsAKwArACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsABAAEAAQABAAEAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAKwBQACsAUAArAFAAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAB4AHgAeAB4AHgAeAB4AHgBQAB4AHgAeAFAAUABQACsAHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQACsAKwAeAB4AHgAeAB4AHgArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArAFAAUABQACsAHgAeAB4AHgAeAB4AHgAOAB4AKwANAA0ADQANAA0ADQANAAkADQANAA0ACAAEAAsABAAEAA0ACQANAA0ADAAdAB0AHgAXABcAFgAXABcAFwAWABcAHQAdAB4AHgAUABQAFAANAAEAAQAEAAQABAAEAAQACQAaABoAGgAaABoAGgAaABoAHgAXABcAHQAVABUAHgAeAB4AHgAeAB4AGAAWABEAFQAVABUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ADQAeAA0ADQANAA0AHgANAA0ADQAHAB4AHgAeAB4AKwAEAAQABAAEAAQABAAEAAQABAAEAFAAUAArACsATwBQAFAAUABQAFAAHgAeAB4AFgARAE8AUABPAE8ATwBPAFAAUABQAFAAUAAeAB4AHgAWABEAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArABsAGwAbABsAGwAbABsAGgAbABsAGwAbABsAGwAbABsAGwAbABsAGwAbABsAGgAbABsAGwAbABoAGwAbABoAGwAbABsAGwAbABsAGwAbABsAGwAbABsAGwAbABsAGwAbAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAHgAeAFAAGgAeAB0AHgBQAB4AGgAeAB4AHgAeAB4AHgAeAB4AHgBPAB4AUAAbAB4AHgBQAFAAUABQAFAAHgAeAB4AHQAdAB4AUAAeAFAAHgBQAB4AUABPAFAAUAAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAHgBQAFAAUABQAE8ATwBQAFAAUABQAFAATwBQAFAATwBQAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAFAAUABQAFAATwBPAE8ATwBPAE8ATwBPAE8ATwBQAFAAUABQAFAAUABQAFAAUAAeAB4AUABQAFAAUABPAB4AHgArACsAKwArAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB4AHQAdAB4AHgAeAB0AHQAeAB4AHQAeAB4AHgAdAB4AHQAbABsAHgAdAB4AHgAeAB4AHQAeAB4AHQAdAB0AHQAeAB4AHQAeAB0AHgAdAB0AHQAdAB0AHQAeAB0AHgAeAB4AHgAeAB0AHQAdAB0AHgAeAB4AHgAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB4AHgAeAB0AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHgAeAB0AHQAdAB0AHgAeAB0AHQAeAB4AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHQAeAB4AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAeAB4AHgAdAB4AHgAeAB4AHgAeAB4AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABYAEQAWABEAHgAeAB4AHgAeAB4AHQAeAB4AHgAeAB4AHgAeACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAWABEAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAFAAHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeAB4AHgAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAeAB4AHQAdAB0AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHQAeAB0AHQAdAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB0AHQAeAB4AHQAdAB4AHgAeAB4AHQAdAB4AHgAeAB4AHQAdAB0AHgAeAB0AHgAeAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlAB4AHQAdAB4AHgAdAB4AHgAeAB4AHQAdAB4AHgAeAB4AJQAlAB0AHQAlAB4AJQAlACUAIAAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAeAB4AHgAeAB0AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHgAdAB0AHQAeAB0AJQAdAB0AHgAdAB0AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAdAB0AHQAdACUAHgAlACUAJQAdACUAJQAdAB0AHQAlACUAHQAdACUAHQAdACUAJQAlAB4AHQAeAB4AHgAeAB0AHQAlAB0AHQAdAB0AHQAdACUAJQAlACUAJQAdACUAJQAgACUAHQAdACUAJQAlACUAJQAlACUAJQAeAB4AHgAlACUAIAAgACAAIAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AFwAXABcAFwAXABcAHgATABMAJQAeAB4AHgAWABEAFgARABYAEQAWABEAFgARABYAEQAWABEATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABYAEQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAWABEAFgARABYAEQAWABEAFgARAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFgARABYAEQAWABEAFgARABYAEQAWABEAFgARABYAEQAWABEAFgARABYAEQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAWABEAFgARAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFgARAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAEAAQABAAeAB4AKwArACsAKwArABMADQANAA0AUAATAA0AUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAUAANACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAA0ADQANAA0ADQANAA0ADQAeAA0AFgANAB4AHgAXABcAHgAeABcAFwAWABEAFgARABYAEQAWABEADQANAA0ADQATAFAADQANAB4ADQANAB4AHgAeAB4AHgAMAAwADQANAA0AHgANAA0AFgANAA0ADQANAA0ADQANAA0AHgANAB4ADQANAB4AHgAeACsAKwArACsAKwArACsAKwArACsAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAKwArACsAKwArACsAKwArACsAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArAA0AEQARACUAJQBHAFcAVwAWABEAFgARABYAEQAWABEAFgARACUAJQAWABEAFgARABYAEQAWABEAFQAWABEAEQAlAFcAVwBXAFcAVwBXAFcAVwBXAAQABAAEAAQABAAEACUAVwBXAFcAVwA2ACUAJQBXAFcAVwBHAEcAJQAlACUAKwBRAFcAUQBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFEAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBRAFcAUQBXAFEAVwBXAFcAVwBXAFcAUQBXAFcAVwBXAFcAVwBRAFEAKwArAAQABAAVABUARwBHAFcAFQBRAFcAUQBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBRAFcAVwBXAFcAVwBXAFEAUQBXAFcAVwBXABUAUQBHAEcAVwArACsAKwArACsAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwAlACUAVwBXAFcAVwAlACUAJQAlACUAJQAlACUAJQAlACsAKwArACsAKwArACsAKwArACsAKwArAFEAUQBRAFEAUQBRAFEAUQBRAFEAUQBRAFEAUQBRAFEAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQBPAE8ATwBPAE8ATwBPAE8AJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQAlAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAEcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAADQATAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABLAEsASwBLAEsASwBLAEsASwBLAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAABAAEAAQABAAeAAQABAAEAAQABAAEAAQABAAEAAQAHgBQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AUABQAAQABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAeAA0ADQANAA0ADQArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAB4AHgAeAB4AHgAeAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAHgAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAeAB4AUABQAFAAUABQAFAAUABQAFAAUABQAAQAUABQAFAABABQAFAAUABQAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAeAB4AHgAeAAQAKwArACsAUABQAFAAUABQAFAAHgAeABoAHgArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAADgAOABMAEwArACsAKwArACsAKwArACsABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwANAA0ASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAFAAUAAeAB4AHgBQAA4AUABQAAQAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAA0ADQBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArACsAKwArACsAKwArAB4AWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYACsAKwArAAQAHgAeAB4AHgAeAB4ADQANAA0AHgAeAB4AHgArAFAASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArAB4AHgBcAFwAXABcAFwAKgBcAFwAXABcAFwAXABcAFwAXABcAEsASwBLAEsASwBLAEsASwBLAEsAXABcAFwAXABcACsAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArAFAAUABQAAQAUABQAFAAUABQAFAAUABQAAQABAArACsASwBLAEsASwBLAEsASwBLAEsASwArACsAHgANAA0ADQBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKgAqACoAXAAqACoAKgBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAAqAFwAKgAqACoAXABcACoAKgBcAFwAXABcAFwAKgAqAFwAKgBcACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFwAXABcACoAKgBQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAA0ADQBQAFAAUAAEAAQAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUAArACsAUABQAFAAUABQAFAAKwArAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQADQAEAAQAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAVABVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBUAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVACsAKwArACsAKwArACsAKwArACsAKwArAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAKwArACsAKwBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAKwArACsAKwAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAKwArACsAKwArAFYABABWAFYAVgBWAFYAVgBWAFYAVgBWAB4AVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgArAFYAVgBWAFYAVgArAFYAKwBWAFYAKwBWAFYAKwBWAFYAVgBWAFYAVgBWAFYAVgBWAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAEQAWAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUAAaAB4AKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAGAARABEAGAAYABMAEwAWABEAFAArACsAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACUAJQAlACUAJQAWABEAFgARABYAEQAWABEAFgARABYAEQAlACUAFgARACUAJQAlACUAJQAlACUAEQAlABEAKwAVABUAEwATACUAFgARABYAEQAWABEAJQAlACUAJQAlACUAJQAlACsAJQAbABoAJQArACsAKwArAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAcAKwATACUAJQAbABoAJQAlABYAEQAlACUAEQAlABEAJQBXAFcAVwBXAFcAVwBXAFcAVwBXABUAFQAlACUAJQATACUAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXABYAJQARACUAJQAlAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwAWACUAEQAlABYAEQARABYAEQARABUAVwBRAFEAUQBRAFEAUQBRAFEAUQBRAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAEcARwArACsAVwBXAFcAVwBXAFcAKwArAFcAVwBXAFcAVwBXACsAKwBXAFcAVwBXAFcAVwArACsAVwBXAFcAKwArACsAGgAbACUAJQAlABsAGwArAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwAEAAQABAAQAB0AKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsADQANAA0AKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAB4AHgAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAAQAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAA0AUABQAFAAUAArACsAKwArAFAAUABQAFAAUABQAFAAUAANAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwAeACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAKwArAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUAArACsAKwBQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwANAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAB4AUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAUABQAFAAUABQAAQABAAEACsABAAEACsAKwArACsAKwAEAAQABAAEAFAAUABQAFAAKwBQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAQABAAEACsAKwArACsABABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAA0ADQANAA0ADQANAA0ADQAeACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAFAAUABQAFAAUABQAFAAUAAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAArACsAKwArAFAAUABQAFAAUAANAA0ADQANAA0ADQAUACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsADQANAA0ADQANAA0ADQBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAAQABAAEAAQAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUAArAAQABAANACsAKwBQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAB4AHgAeAB4AHgArACsAKwArACsAKwAEAAQABAAEAAQABAAEAA0ADQAeAB4AHgAeAB4AKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgANAA0ADQANACsAKwArACsAKwArACsAKwArACsAKwAeACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsASwBLAEsASwBLAEsASwBLAEsASwANAA0ADQANAFAABAAEAFAAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAeAA4AUAArACsAKwArACsAKwArACsAKwAEAFAAUABQAFAADQANAB4ADQAEAAQABAAEAB4ABAAEAEsASwBLAEsASwBLAEsASwBLAEsAUAAOAFAADQANAA0AKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAANAA0AHgANAA0AHgAEACsAUABQAFAAUABQAFAAUAArAFAAKwBQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAA0AKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsABAAEAAQABAArAFAAUABQAFAAUABQAFAAUAArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQAFAAUABQACsABAAEAFAABAAEAAQABAAEAAQABAArACsABAAEACsAKwAEAAQABAArACsAUAArACsAKwArACsAKwAEACsAKwArACsAKwBQAFAAUABQAFAABAAEACsAKwAEAAQABAAEAAQABAAEACsAKwArAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwArACsABAAEAAQABAAEAAQABABQAFAAUABQAA0ADQANAA0AHgBLAEsASwBLAEsASwBLAEsASwBLAA0ADQArAB4ABABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAAQABAAEAFAAUAAeAFAAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAArACsABAAEAAQABAAEAAQABAAEAAQADgANAA0AEwATAB4AHgAeAA0ADQANAA0ADQANAA0ADQANAA0ADQANAA0ADQANAFAAUABQAFAABAAEACsAKwAEAA0ADQAeAFAAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAFAAKwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKwArACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwBcAFwADQANAA0AKgBQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAKwArAFAAKwArAFAAUABQAFAAUABQAFAAUAArAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQAKwAEAAQAKwArAAQABAAEAAQAUAAEAFAABAAEAA0ADQANACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAArACsABAAEAAQABAAEAAQABABQAA4AUAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAFAABAAEAAQABAAOAB4ADQANAA0ADQAOAB4ABAArACsAKwArACsAKwArACsAUAAEAAQABAAEAAQABAAEAAQABAAEAAQAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAA0ADQANAFAADgAOAA4ADQANACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEACsABAAEAAQABAAEAAQABAAEAFAADQANAA0ADQANACsAKwArACsAKwArACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwAOABMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAArACsAKwAEACsABAAEACsABAAEAAQABAAEAAQABABQAAQAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAKwBQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQAKwAEAAQAKwAEAAQABAAEAAQAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAaABoAGgAaAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsADQANAA0ADQANACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAASABIAEgAQwBDAEMAUABQAFAAUABDAFAAUABQAEgAQwBIAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAASABDAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwAJAAkACQAJAAkACQAJABYAEQArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABIAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwANAA0AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAQABAAEAAQABAANACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAA0ADQANAB4AHgAeAB4AHgAeAFAAUABQAFAADQAeACsAKwArACsAKwArACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAANAA0AHgAeACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwAEAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArACsAKwAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAARwBHABUARwAJACsAKwArACsAKwArACsAKwArACsAKwAEAAQAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACsAKwArACsAKwArACsAKwBXAFcAVwBXAFcAVwBXAFcAVwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUQBRAFEAKwArACsAKwArACsAKwArACsAKwArACsAKwBRAFEAUQBRACsAKwArACsAKwArACsAKwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUAArACsAHgAEAAQADQAEAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArAB4AHgAeAB4AHgAeAB4AKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAAQABAAEAAQABAAeAB4AHgAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAB4AHgAEAAQABAAEAAQABAAEAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQAHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwBQAFAAKwArAFAAKwArAFAAUAArACsAUABQAFAAUAArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAUAArAFAAUABQAFAAUABQAFAAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwBQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAHgAeAFAAUABQAFAAUAArAFAAKwArACsAUABQAFAAUABQAFAAUAArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeACsAKwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgAeAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgAeAB4AHgAeAB4ABAAeAB4AHgAeAB4AHgAeAB4AHgAeAAQAHgAeAA0ADQANAA0AHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAAQABAAEAAQAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAEAAQAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArAAQABAAEAAQABAAEAAQAKwAEAAQAKwAEAAQABAAEAAQAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwAEAAQABAAEAAQABAAEAFAAUABQAFAAUABQAFAAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwBQAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArABsAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArAB4AHgAeAB4ABAAEAAQABAAEAAQABABQACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArABYAFgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAGgBQAFAAUAAaAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAKwBQACsAKwBQACsAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAKwBQACsAUAArACsAKwArACsAKwBQACsAKwArACsAUAArAFAAKwBQACsAUABQAFAAKwBQAFAAKwBQACsAKwBQACsAUAArAFAAKwBQACsAUAArAFAAUAArAFAAKwArAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQAFAAUAArAFAAUABQAFAAKwBQACsAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAUABQAFAAKwBQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8AJQAlACUAHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB4AHgAeACUAJQAlAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAJQAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlAB4AHgAlACUAJQAlACUAHgAlACUAJQAlACUAIAAgACAAJQAlACAAJQAlACAAIAAgACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACEAIQAhACEAIQAlACUAIAAgACUAJQAgACAAIAAgACAAIAAgACAAIAAgACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAJQAlACUAIAAlACUAJQAlACAAIAAgACUAIAAgACAAJQAlACUAJQAlACUAJQAgACUAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAlAB4AJQAeACUAJQAlACUAJQAgACUAJQAlACUAHgAlAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAJQAlACUAJQAgACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACAAIAAgACUAJQAlACAAIAAgACAAIAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABcAFwAXABUAFQAVAB4AHgAeAB4AJQAlACUAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAgACUAJQAlACUAJQAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAgACUAJQAgACUAJQAlACUAJQAlACUAJQAgACAAIAAgACAAIAAgACAAJQAlACUAJQAlACUAIAAlACUAJQAlACUAJQAlACUAJQAgACAAIAAgACAAIAAgACAAIAAgACUAJQAgACAAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAgACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAlACAAIAAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAgACAAIAAlACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAJQAlAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAKwArAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwAlACUAJQAlACUAJQAlACUAJQAlACUAVwBXACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAKwAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAA==",Ed=50,Kb=1,ng=2,ag=3,Wb=4,Xb=5,Id=7,Ag=8,Fd=9,ms=10,Gl=11,Md=12,jl=13,Yb=14,po=15,zl=16,In=17,oo=18,Jb=19,Sd=20,Kl=21,no=22,jA=23,ir=24,pi=25,fo=26,go=27,sr=28,Zb=29,Ms=30,qb=31,Fn=32,Mn=33,Wl=34,Xl=35,Yl=36,Ro=37,Jl=38,$n=39,ea=40,zA=41,lg=42,$b=43,eC=[9001,65288],cg="!",nt="",Sn="",Zl=Vb(zb),$i=[Ms,Yl],ql=[Kb,ng,ag,Xb],hg=[ms,Ag],Td=[go,fo],tC=ql.concat(hg),Dd=[Jl,$n,ea,Wl,Xl],iC=[po,jl],sC=function(r,e){e===void 0&&(e="strict");var t=[],i=[],s=[];return r.forEach(function(o,n){var a=Zl.get(o);if(a>Ed?(s.push(!0),a-=Ed):s.push(!1),["normal","auto","loose"].indexOf(e)!==-1&&[8208,8211,12316,12448].indexOf(o)!==-1)return i.push(n),t.push(zl);if(a===Wb||a===Gl){if(n===0)return i.push(n),t.push(Ms);var A=t[n-1];return tC.indexOf(A)===-1?(i.push(i[n-1]),t.push(A)):(i.push(n),t.push(Ms))}if(i.push(n),a===qb)return t.push(e==="strict"?Kl:Ro);if(a===lg||a===Zb)return t.push(Ms);if(a===$b)return o>=131072&&o<=196605||o>=196608&&o<=262141?t.push(Ro):t.push(Ms);t.push(a)}),[i,t,s]},KA=function(r,e,t,i){var s=i[t];if(Array.isArray(r)?r.indexOf(s)!==-1:r===s)for(var o=t;o<=i.length;){o++;var n=i[o];if(n===e)return!0;if(n!==ms)break}if(s===ms)for(var o=t;o>0;){o--;var a=i[o];if(Array.isArray(r)?r.indexOf(a)!==-1:r===a)for(var A=t;A<=i.length;){A++;var n=i[A];if(n===e)return!0;if(n!==ms)break}if(a!==ms)break}return!1},Rd=function(r,e){for(var t=r;t>=0;){var i=e[t];if(i===ms)t--;else return i}return 0},rC=function(r,e,t,i,s){if(t[i]===0)return nt;var o=i-1;if(Array.isArray(s)&&s[o]===!0)return nt;var n=o-1,a=o+1,A=e[o],l=n>=0?e[n]:0,h=e[a];if(A===ng&&h===ag)return nt;if(ql.indexOf(A)!==-1)return cg;if(ql.indexOf(h)!==-1||hg.indexOf(h)!==-1)return nt;if(Rd(o,e)===Ag)return Sn;if(Zl.get(r[o])===Gl||(A===Fn||A===Mn)&&Zl.get(r[a])===Gl||A===Id||h===Id||A===Fd||[ms,jl,po].indexOf(A)===-1&&h===Fd||[In,oo,Jb,ir,sr].indexOf(h)!==-1||Rd(o,e)===no||KA(jA,no,o,e)||KA([In,oo],Kl,o,e)||KA(Md,Md,o,e))return nt;if(A===ms)return Sn;if(A===jA||h===jA)return nt;if(h===zl||A===zl)return Sn;if([jl,po,Kl].indexOf(h)!==-1||A===Yb||l===Yl&&iC.indexOf(A)!==-1||A===sr&&h===Yl||h===Sd||$i.indexOf(h)!==-1&&A===pi||$i.indexOf(A)!==-1&&h===pi||A===go&&[Ro,Fn,Mn].indexOf(h)!==-1||[Ro,Fn,Mn].indexOf(A)!==-1&&h===fo||$i.indexOf(A)!==-1&&Td.indexOf(h)!==-1||Td.indexOf(A)!==-1&&$i.indexOf(h)!==-1||[go,fo].indexOf(A)!==-1&&(h===pi||[no,po].indexOf(h)!==-1&&e[a+1]===pi)||[no,po].indexOf(A)!==-1&&h===pi||A===pi&&[pi,sr,ir].indexOf(h)!==-1)return nt;if([pi,sr,ir,In,oo].indexOf(h)!==-1)for(var d=o;d>=0;){var f=e[d];if(f===pi)return nt;if([sr,ir].indexOf(f)!==-1)d--;else break}if([go,fo].indexOf(h)!==-1)for(var d=[In,oo].indexOf(A)!==-1?n:o;d>=0;){var f=e[d];if(f===pi)return nt;if([sr,ir].indexOf(f)!==-1)d--;else break}if(Jl===A&&[Jl,$n,Wl,Xl].indexOf(h)!==-1||[$n,Wl].indexOf(A)!==-1&&[$n,ea].indexOf(h)!==-1||[ea,Xl].indexOf(A)!==-1&&h===ea||Dd.indexOf(A)!==-1&&[Sd,fo].indexOf(h)!==-1||Dd.indexOf(h)!==-1&&A===go||$i.indexOf(A)!==-1&&$i.indexOf(h)!==-1||A===ir&&$i.indexOf(h)!==-1||$i.concat(pi).indexOf(A)!==-1&&h===no&&eC.indexOf(r[a])===-1||$i.concat(pi).indexOf(h)!==-1&&A===oo)return nt;if(A===zA&&h===zA){for(var m=t[o],_=1;m>0&&(m--,e[m]===zA);)_++;if(_%2!==0)return nt}return A===Fn&&h===Mn?nt:Sn},oC=function(r,e){e||(e={lineBreak:"normal",wordBreak:"normal"});var t=sC(r,e.lineBreak),i=t[0],s=t[1],o=t[2];(e.wordBreak==="break-all"||e.wordBreak==="break-word")&&(s=s.map(function(a){return[pi,Ms,lg].indexOf(a)!==-1?Ro:a}));var n=e.wordBreak==="keep-all"?o.map(function(a,A){return a&&r[A]>=19968&&r[A]<=40959}):void 0;return[i,s,n]},nC=function(){function r(e,t,i,s){this.codePoints=e,this.required=t===cg,this.start=i,this.end=s}return r.prototype.slice=function(){return Lt.apply(void 0,this.codePoints.slice(this.start,this.end))},r}(),aC=function(r,e){var t=Fa(r),i=oC(t,e),s=i[0],o=i[1],n=i[2],a=t.length,A=0,l=0;return{next:function(){if(l>=a)return{done:!0,value:null};for(var h=nt;l<a&&(h=rC(t,o,s,++l,n))===nt;);if(h!==nt||l===a){var d=new nC(t,h,A,l);return A=l,{value:d,done:!1}}return{done:!0,value:null}}}},AC=1,lC=2,Qo=4,Ld=8,ha=10,Ud=47,xo=92,cC=9,hC=32,Tn=34,ao=61,uC=35,dC=36,pC=37,Dn=39,Rn=40,Ao=41,fC=95,ci=45,gC=33,mC=60,_C=62,vC=64,BC=91,PC=93,yC=61,xC=123,Ln=63,wC=125,Od=124,bC=126,CC=128,kd=65533,WA=42,Ts=43,EC=44,IC=58,FC=59,Lo=46,MC=0,SC=8,TC=11,DC=14,RC=31,LC=127,Oi=-1,ug=48,dg=97,pg=101,UC=102,OC=117,kC=122,fg=65,gg=69,mg=70,NC=85,QC=90,ti=function(r){return r>=ug&&r<=57},HC=function(r){return r>=55296&&r<=57343},rr=function(r){return ti(r)||r>=fg&&r<=mg||r>=dg&&r<=UC},VC=function(r){return r>=dg&&r<=kC},GC=function(r){return r>=fg&&r<=QC},jC=function(r){return VC(r)||GC(r)},zC=function(r){return r>=CC},Un=function(r){return r===ha||r===cC||r===hC},ua=function(r){return jC(r)||zC(r)||r===fC},Nd=function(r){return ua(r)||ti(r)||r===ci},KC=function(r){return r>=MC&&r<=SC||r===TC||r>=DC&&r<=RC||r===LC},fs=function(r,e){return r!==xo?!1:e!==ha},On=function(r,e,t){return r===ci?ua(e)||fs(e,t):ua(r)?!0:!!(r===xo&&fs(r,e))},XA=function(r,e,t){return r===Ts||r===ci?ti(e)?!0:e===Lo&&ti(t):ti(r===Lo?e:r)},WC=function(r){var e=0,t=1;(r[e]===Ts||r[e]===ci)&&(r[e]===ci&&(t=-1),e++);for(var i=[];ti(r[e]);)i.push(r[e++]);var s=i.length?parseInt(Lt.apply(void 0,i),10):0;r[e]===Lo&&e++;for(var o=[];ti(r[e]);)o.push(r[e++]);var n=o.length,a=n?parseInt(Lt.apply(void 0,o),10):0;(r[e]===gg||r[e]===pg)&&e++;var A=1;(r[e]===Ts||r[e]===ci)&&(r[e]===ci&&(A=-1),e++);for(var l=[];ti(r[e]);)l.push(r[e++]);var h=l.length?parseInt(Lt.apply(void 0,l),10):0;return t*(s+a*Math.pow(10,-n))*Math.pow(10,A*h)},XC={type:2},YC={type:3},JC={type:4},ZC={type:13},qC={type:8},$C={type:21},eE={type:9},tE={type:10},iE={type:11},sE={type:12},rE={type:14},kn={type:23},oE={type:1},nE={type:25},aE={type:24},AE={type:26},lE={type:27},cE={type:28},hE={type:29},uE={type:31},$l={type:32},_g=function(){function r(){this._value=[]}return r.prototype.write=function(e){this._value=this._value.concat(Fa(e))},r.prototype.read=function(){for(var e=[],t=this.consumeToken();t!==$l;)e.push(t),t=this.consumeToken();return e},r.prototype.consumeToken=function(){var e=this.consumeCodePoint();switch(e){case Tn:return this.consumeStringToken(Tn);case uC:var t=this.peekCodePoint(0),i=this.peekCodePoint(1),s=this.peekCodePoint(2);if(Nd(t)||fs(i,s)){var o=On(t,i,s)?lC:AC,n=this.consumeName();return{type:5,value:n,flags:o}}break;case dC:if(this.peekCodePoint(0)===ao)return this.consumeCodePoint(),ZC;break;case Dn:return this.consumeStringToken(Dn);case Rn:return XC;case Ao:return YC;case WA:if(this.peekCodePoint(0)===ao)return this.consumeCodePoint(),rE;break;case Ts:if(XA(e,this.peekCodePoint(0),this.peekCodePoint(1)))return this.reconsumeCodePoint(e),this.consumeNumericToken();break;case EC:return JC;case ci:var a=e,A=this.peekCodePoint(0),l=this.peekCodePoint(1);if(XA(a,A,l))return this.reconsumeCodePoint(e),this.consumeNumericToken();if(On(a,A,l))return this.reconsumeCodePoint(e),this.consumeIdentLikeToken();if(A===ci&&l===_C)return this.consumeCodePoint(),this.consumeCodePoint(),aE;break;case Lo:if(XA(e,this.peekCodePoint(0),this.peekCodePoint(1)))return this.reconsumeCodePoint(e),this.consumeNumericToken();break;case Ud:if(this.peekCodePoint(0)===WA)for(this.consumeCodePoint();;){var h=this.consumeCodePoint();if(h===WA&&(h=this.consumeCodePoint(),h===Ud))return this.consumeToken();if(h===Oi)return this.consumeToken()}break;case IC:return AE;case FC:return lE;case mC:if(this.peekCodePoint(0)===gC&&this.peekCodePoint(1)===ci&&this.peekCodePoint(2)===ci)return this.consumeCodePoint(),this.consumeCodePoint(),nE;break;case vC:var d=this.peekCodePoint(0),f=this.peekCodePoint(1),m=this.peekCodePoint(2);if(On(d,f,m)){var n=this.consumeName();return{type:7,value:n}}break;case BC:return cE;case xo:if(fs(e,this.peekCodePoint(0)))return this.reconsumeCodePoint(e),this.consumeIdentLikeToken();break;case PC:return hE;case yC:if(this.peekCodePoint(0)===ao)return this.consumeCodePoint(),qC;break;case xC:return iE;case wC:return sE;case OC:case NC:var _=this.peekCodePoint(0),u=this.peekCodePoint(1);return _===Ts&&(rr(u)||u===Ln)&&(this.consumeCodePoint(),this.consumeUnicodeRangeToken()),this.reconsumeCodePoint(e),this.consumeIdentLikeToken();case Od:if(this.peekCodePoint(0)===ao)return this.consumeCodePoint(),eE;if(this.peekCodePoint(0)===Od)return this.consumeCodePoint(),$C;break;case bC:if(this.peekCodePoint(0)===ao)return this.consumeCodePoint(),tE;break;case Oi:return $l}return Un(e)?(this.consumeWhiteSpace(),uE):ti(e)?(this.reconsumeCodePoint(e),this.consumeNumericToken()):ua(e)?(this.reconsumeCodePoint(e),this.consumeIdentLikeToken()):{type:6,value:Lt(e)}},r.prototype.consumeCodePoint=function(){var e=this._value.shift();return typeof e>"u"?-1:e},r.prototype.reconsumeCodePoint=function(e){this._value.unshift(e)},r.prototype.peekCodePoint=function(e){return e>=this._value.length?-1:this._value[e]},r.prototype.consumeUnicodeRangeToken=function(){for(var e=[],t=this.consumeCodePoint();rr(t)&&e.length<6;)e.push(t),t=this.consumeCodePoint();for(var i=!1;t===Ln&&e.length<6;)e.push(t),t=this.consumeCodePoint(),i=!0;if(i){var s=parseInt(Lt.apply(void 0,e.map(function(A){return A===Ln?ug:A})),16),o=parseInt(Lt.apply(void 0,e.map(function(A){return A===Ln?mg:A})),16);return{type:30,start:s,end:o}}var n=parseInt(Lt.apply(void 0,e),16);if(this.peekCodePoint(0)===ci&&rr(this.peekCodePoint(1))){this.consumeCodePoint(),t=this.consumeCodePoint();for(var a=[];rr(t)&&a.length<6;)a.push(t),t=this.consumeCodePoint();var o=parseInt(Lt.apply(void 0,a),16);return{type:30,start:n,end:o}}else return{type:30,start:n,end:n}},r.prototype.consumeIdentLikeToken=function(){var e=this.consumeName();return e.toLowerCase()==="url"&&this.peekCodePoint(0)===Rn?(this.consumeCodePoint(),this.consumeUrlToken()):this.peekCodePoint(0)===Rn?(this.consumeCodePoint(),{type:19,value:e}):{type:20,value:e}},r.prototype.consumeUrlToken=function(){var e=[];if(this.consumeWhiteSpace(),this.peekCodePoint(0)===Oi)return{type:22,value:""};var t=this.peekCodePoint(0);if(t===Dn||t===Tn){var i=this.consumeStringToken(this.consumeCodePoint());return i.type===0&&(this.consumeWhiteSpace(),this.peekCodePoint(0)===Oi||this.peekCodePoint(0)===Ao)?(this.consumeCodePoint(),{type:22,value:i.value}):(this.consumeBadUrlRemnants(),kn)}for(;;){var s=this.consumeCodePoint();if(s===Oi||s===Ao)return{type:22,value:Lt.apply(void 0,e)};if(Un(s))return this.consumeWhiteSpace(),this.peekCodePoint(0)===Oi||this.peekCodePoint(0)===Ao?(this.consumeCodePoint(),{type:22,value:Lt.apply(void 0,e)}):(this.consumeBadUrlRemnants(),kn);if(s===Tn||s===Dn||s===Rn||KC(s))return this.consumeBadUrlRemnants(),kn;if(s===xo)if(fs(s,this.peekCodePoint(0)))e.push(this.consumeEscapedCodePoint());else return this.consumeBadUrlRemnants(),kn;else e.push(s)}},r.prototype.consumeWhiteSpace=function(){for(;Un(this.peekCodePoint(0));)this.consumeCodePoint()},r.prototype.consumeBadUrlRemnants=function(){for(;;){var e=this.consumeCodePoint();if(e===Ao||e===Oi)return;fs(e,this.peekCodePoint(0))&&this.consumeEscapedCodePoint()}},r.prototype.consumeStringSlice=function(e){for(var t=5e4,i="";e>0;){var s=Math.min(t,e);i+=Lt.apply(void 0,this._value.splice(0,s)),e-=s}return this._value.shift(),i},r.prototype.consumeStringToken=function(e){var t="",i=0;do{var s=this._value[i];if(s===Oi||s===void 0||s===e)return t+=this.consumeStringSlice(i),{type:0,value:t};if(s===ha)return this._value.splice(0,i),oE;if(s===xo){var o=this._value[i+1];o!==Oi&&o!==void 0&&(o===ha?(t+=this.consumeStringSlice(i),i=-1,this._value.shift()):fs(s,o)&&(t+=this.consumeStringSlice(i),t+=Lt(this.consumeEscapedCodePoint()),i=-1))}i++}while(!0)},r.prototype.consumeNumber=function(){var e=[],t=Qo,i=this.peekCodePoint(0);for((i===Ts||i===ci)&&e.push(this.consumeCodePoint());ti(this.peekCodePoint(0));)e.push(this.consumeCodePoint());i=this.peekCodePoint(0);var s=this.peekCodePoint(1);if(i===Lo&&ti(s))for(e.push(this.consumeCodePoint(),this.consumeCodePoint()),t=Ld;ti(this.peekCodePoint(0));)e.push(this.consumeCodePoint());i=this.peekCodePoint(0),s=this.peekCodePoint(1);var o=this.peekCodePoint(2);if((i===gg||i===pg)&&((s===Ts||s===ci)&&ti(o)||ti(s)))for(e.push(this.consumeCodePoint(),this.consumeCodePoint()),t=Ld;ti(this.peekCodePoint(0));)e.push(this.consumeCodePoint());return[WC(e),t]},r.prototype.consumeNumericToken=function(){var e=this.consumeNumber(),t=e[0],i=e[1],s=this.peekCodePoint(0),o=this.peekCodePoint(1),n=this.peekCodePoint(2);if(On(s,o,n)){var a=this.consumeName();return{type:15,number:t,flags:i,unit:a}}return s===pC?(this.consumeCodePoint(),{type:16,number:t,flags:i}):{type:17,number:t,flags:i}},r.prototype.consumeEscapedCodePoint=function(){var e=this.consumeCodePoint();if(rr(e)){for(var t=Lt(e);rr(this.peekCodePoint(0))&&t.length<6;)t+=Lt(this.consumeCodePoint());Un(this.peekCodePoint(0))&&this.consumeCodePoint();var i=parseInt(t,16);return i===0||HC(i)||i>1114111?kd:i}return e===Oi?kd:e},r.prototype.consumeName=function(){for(var e="";;){var t=this.consumeCodePoint();if(Nd(t))e+=Lt(t);else if(fs(t,this.peekCodePoint(0)))e+=Lt(this.consumeEscapedCodePoint());else return this.reconsumeCodePoint(t),e}},r}(),vg=function(){function r(e){this._tokens=e}return r.create=function(e){var t=new _g;return t.write(e),new r(t.read())},r.parseValue=function(e){return r.create(e).parseComponentValue()},r.parseValues=function(e){return r.create(e).parseComponentValues()},r.prototype.parseComponentValue=function(){for(var e=this.consumeToken();e.type===31;)e=this.consumeToken();if(e.type===32)throw new SyntaxError("Error parsing CSS component value, unexpected EOF");this.reconsumeToken(e);var t=this.consumeComponentValue();do e=this.consumeToken();while(e.type===31);if(e.type===32)return t;throw new SyntaxError("Error parsing CSS component value, multiple values found when expecting only one")},r.prototype.parseComponentValues=function(){for(var e=[];;){var t=this.consumeComponentValue();if(t.type===32)return e;e.push(t),e.push()}},r.prototype.consumeComponentValue=function(){var e=this.consumeToken();switch(e.type){case 11:case 28:case 2:return this.consumeSimpleBlock(e.type);case 19:return this.consumeFunction(e)}return e},r.prototype.consumeSimpleBlock=function(e){for(var t={type:e,values:[]},i=this.consumeToken();;){if(i.type===32||pE(i,e))return t;this.reconsumeToken(i),t.values.push(this.consumeComponentValue()),i=this.consumeToken()}},r.prototype.consumeFunction=function(e){for(var t={name:e.value,values:[],type:18};;){var i=this.consumeToken();if(i.type===32||i.type===3)return t;this.reconsumeToken(i),t.values.push(this.consumeComponentValue())}},r.prototype.consumeToken=function(){var e=this._tokens.shift();return typeof e>"u"?$l:e},r.prototype.reconsumeToken=function(e){this._tokens.unshift(e)},r}(),Ho=function(r){return r.type===15},Rr=function(r){return r.type===17},Pt=function(r){return r.type===20},dE=function(r){return r.type===0},ec=function(r,e){return Pt(r)&&r.value===e},Bg=function(r){return r.type!==31},Ir=function(r){return r.type!==31&&r.type!==4},ji=function(r){var e=[],t=[];return r.forEach(function(i){if(i.type===4){if(t.length===0)throw new Error("Error parsing function args, zero tokens for arg");e.push(t),t=[];return}i.type!==31&&t.push(i)}),t.length&&e.push(t),e},pE=function(r,e){return e===11&&r.type===12||e===28&&r.type===29?!0:e===2&&r.type===3},xs=function(r){return r.type===17||r.type===15},Nt=function(r){return r.type===16||xs(r)},Pg=function(r){return r.length>1?[r[0],r[1]]:[r[0]]},qt={type:17,number:0,flags:Qo},wc={type:16,number:50,flags:Qo},_s={type:16,number:100,flags:Qo},mo=function(r,e,t){var i=r[0],s=r[1];return[xt(i,e),xt(typeof s<"u"?s:i,t)]},xt=function(r,e){if(r.type===16)return r.number/100*e;if(Ho(r))switch(r.unit){case"rem":case"em":return 16*r.number;case"px":default:return r.number}return r.number},yg="deg",xg="grad",wg="rad",bg="turn",Ma={name:"angle",parse:function(r,e){if(e.type===15)switch(e.unit){case yg:return Math.PI*e.number/180;case xg:return Math.PI/200*e.number;case wg:return e.number;case bg:return Math.PI*2*e.number}throw new Error("Unsupported angle type")}},Cg=function(r){return r.type===15&&(r.unit===yg||r.unit===xg||r.unit===wg||r.unit===bg)},Eg=function(r){var e=r.filter(Pt).map(function(t){return t.value}).join(" ");switch(e){case"to bottom right":case"to right bottom":case"left top":case"top left":return[qt,qt];case"to top":case"bottom":return bi(0);case"to bottom left":case"to left bottom":case"right top":case"top right":return[qt,_s];case"to right":case"left":return bi(90);case"to top left":case"to left top":case"right bottom":case"bottom right":return[_s,_s];case"to bottom":case"top":return bi(180);case"to top right":case"to right top":case"left bottom":case"bottom left":return[_s,qt];case"to left":case"right":return bi(270)}return 0},bi=function(r){return Math.PI*r/180},Bs={name:"color",parse:function(r,e){if(e.type===18){var t=fE[e.name];if(typeof t>"u")throw new Error('Attempting to parse an unsupported color function "'+e.name+'"');return t(r,e.values)}if(e.type===5){if(e.value.length===3){var i=e.value.substring(0,1),s=e.value.substring(1,2),o=e.value.substring(2,3);return vs(parseInt(i+i,16),parseInt(s+s,16),parseInt(o+o,16),1)}if(e.value.length===4){var i=e.value.substring(0,1),s=e.value.substring(1,2),o=e.value.substring(2,3),n=e.value.substring(3,4);return vs(parseInt(i+i,16),parseInt(s+s,16),parseInt(o+o,16),parseInt(n+n,16)/255)}if(e.value.length===6){var i=e.value.substring(0,2),s=e.value.substring(2,4),o=e.value.substring(4,6);return vs(parseInt(i,16),parseInt(s,16),parseInt(o,16),1)}if(e.value.length===8){var i=e.value.substring(0,2),s=e.value.substring(2,4),o=e.value.substring(4,6),n=e.value.substring(6,8);return vs(parseInt(i,16),parseInt(s,16),parseInt(o,16),parseInt(n,16)/255)}}if(e.type===20){var a=os[e.value.toUpperCase()];if(typeof a<"u")return a}return os.TRANSPARENT}},Ps=function(r){return(255&r)===0},jt=function(r){var e=255&r,t=255&r>>8,i=255&r>>16,s=255&r>>24;return e<255?"rgba("+s+","+i+","+t+","+e/255+")":"rgb("+s+","+i+","+t+")"},vs=function(r,e,t,i){return(r<<24|e<<16|t<<8|Math.round(i*255)<<0)>>>0},Qd=function(r,e){if(r.type===17)return r.number;if(r.type===16){var t=e===3?1:255;return e===3?r.number/100*t:Math.round(r.number/100*t)}return 0},Hd=function(r,e){var t=e.filter(Ir);if(t.length===3){var i=t.map(Qd),s=i[0],o=i[1],n=i[2];return vs(s,o,n,1)}if(t.length===4){var a=t.map(Qd),s=a[0],o=a[1],n=a[2],A=a[3];return vs(s,o,n,A)}return 0};function YA(r,e,t){return t<0&&(t+=1),t>=1&&(t-=1),t<1/6?(e-r)*t*6+r:t<1/2?e:t<2/3?(e-r)*6*(2/3-t)+r:r}var Vd=function(r,e){var t=e.filter(Ir),i=t[0],s=t[1],o=t[2],n=t[3],a=(i.type===17?bi(i.number):Ma.parse(r,i))/(Math.PI*2),A=Nt(s)?s.number/100:0,l=Nt(o)?o.number/100:0,h=typeof n<"u"&&Nt(n)?xt(n,1):1;if(A===0)return vs(l*255,l*255,l*255,1);var d=l<=.5?l*(A+1):l+A-l*A,f=l*2-d,m=YA(f,d,a+1/3),_=YA(f,d,a),u=YA(f,d,a-1/3);return vs(m*255,_*255,u*255,h)},fE={hsl:Vd,hsla:Vd,rgb:Hd,rgba:Hd},wo=function(r,e){return Bs.parse(r,vg.create(e).parseComponentValue())},os={ALICEBLUE:4042850303,ANTIQUEWHITE:4209760255,AQUA:16777215,AQUAMARINE:2147472639,AZURE:4043309055,BEIGE:4126530815,BISQUE:4293182719,BLACK:255,BLANCHEDALMOND:4293643775,BLUE:65535,BLUEVIOLET:2318131967,BROWN:2771004159,BURLYWOOD:3736635391,CADETBLUE:1604231423,CHARTREUSE:2147418367,CHOCOLATE:3530104575,CORAL:4286533887,CORNFLOWERBLUE:1687547391,CORNSILK:4294499583,CRIMSON:3692313855,CYAN:16777215,DARKBLUE:35839,DARKCYAN:9145343,DARKGOLDENROD:3095837695,DARKGRAY:2846468607,DARKGREEN:6553855,DARKGREY:2846468607,DARKKHAKI:3182914559,DARKMAGENTA:2332068863,DARKOLIVEGREEN:1433087999,DARKORANGE:4287365375,DARKORCHID:2570243327,DARKRED:2332033279,DARKSALMON:3918953215,DARKSEAGREEN:2411499519,DARKSLATEBLUE:1211993087,DARKSLATEGRAY:793726975,DARKSLATEGREY:793726975,DARKTURQUOISE:13554175,DARKVIOLET:2483082239,DEEPPINK:4279538687,DEEPSKYBLUE:12582911,DIMGRAY:1768516095,DIMGREY:1768516095,DODGERBLUE:512819199,FIREBRICK:2988581631,FLORALWHITE:4294635775,FORESTGREEN:579543807,FUCHSIA:4278255615,GAINSBORO:3705462015,GHOSTWHITE:4177068031,GOLD:4292280575,GOLDENROD:3668254975,GRAY:2155905279,GREEN:8388863,GREENYELLOW:2919182335,GREY:2155905279,HONEYDEW:4043305215,HOTPINK:4285117695,INDIANRED:3445382399,INDIGO:1258324735,IVORY:4294963455,KHAKI:4041641215,LAVENDER:3873897215,LAVENDERBLUSH:4293981695,LAWNGREEN:2096890111,LEMONCHIFFON:4294626815,LIGHTBLUE:2916673279,LIGHTCORAL:4034953471,LIGHTCYAN:3774873599,LIGHTGOLDENRODYELLOW:4210742015,LIGHTGRAY:3553874943,LIGHTGREEN:2431553791,LIGHTGREY:3553874943,LIGHTPINK:4290167295,LIGHTSALMON:4288707327,LIGHTSEAGREEN:548580095,LIGHTSKYBLUE:2278488831,LIGHTSLATEGRAY:2005441023,LIGHTSLATEGREY:2005441023,LIGHTSTEELBLUE:2965692159,LIGHTYELLOW:4294959359,LIME:16711935,LIMEGREEN:852308735,LINEN:4210091775,MAGENTA:4278255615,MAROON:2147483903,MEDIUMAQUAMARINE:1724754687,MEDIUMBLUE:52735,MEDIUMORCHID:3126187007,MEDIUMPURPLE:2473647103,MEDIUMSEAGREEN:1018393087,MEDIUMSLATEBLUE:2070474495,MEDIUMSPRINGGREEN:16423679,MEDIUMTURQUOISE:1221709055,MEDIUMVIOLETRED:3340076543,MIDNIGHTBLUE:421097727,MINTCREAM:4127193855,MISTYROSE:4293190143,MOCCASIN:4293178879,NAVAJOWHITE:4292783615,NAVY:33023,OLDLACE:4260751103,OLIVE:2155872511,OLIVEDRAB:1804477439,ORANGE:4289003775,ORANGERED:4282712319,ORCHID:3664828159,PALEGOLDENROD:4008225535,PALEGREEN:2566625535,PALETURQUOISE:2951671551,PALEVIOLETRED:3681588223,PAPAYAWHIP:4293907967,PEACHPUFF:4292524543,PERU:3448061951,PINK:4290825215,PLUM:3718307327,POWDERBLUE:2967529215,PURPLE:2147516671,REBECCAPURPLE:1714657791,RED:4278190335,ROSYBROWN:3163525119,ROYALBLUE:1097458175,SADDLEBROWN:2336560127,SALMON:4202722047,SANDYBROWN:4104413439,SEAGREEN:780883967,SEASHELL:4294307583,SIENNA:2689740287,SILVER:3233857791,SKYBLUE:2278484991,SLATEBLUE:1784335871,SLATEGRAY:1887473919,SLATEGREY:1887473919,SNOW:4294638335,SPRINGGREEN:16744447,STEELBLUE:1182971135,TAN:3535047935,TEAL:8421631,THISTLE:3636451583,TOMATO:4284696575,TRANSPARENT:0,TURQUOISE:1088475391,VIOLET:4001558271,WHEAT:4125012991,WHITE:4294967295,WHITESMOKE:4126537215,YELLOW:4294902015,YELLOWGREEN:2597139199},gE={name:"background-clip",initialValue:"border-box",prefix:!1,type:1,parse:function(r,e){return e.map(function(t){if(Pt(t))switch(t.value){case"padding-box":return 1;case"content-box":return 2}return 0})}},mE={name:"background-color",initialValue:"transparent",prefix:!1,type:3,format:"color"},Sa=function(r,e){var t=Bs.parse(r,e[0]),i=e[1];return i&&Nt(i)?{color:t,stop:i}:{color:t,stop:null}},Gd=function(r,e){var t=r[0],i=r[r.length-1];t.stop===null&&(t.stop=qt),i.stop===null&&(i.stop=_s);for(var s=[],o=0,n=0;n<r.length;n++){var a=r[n].stop;if(a!==null){var A=xt(a,e);A>o?s.push(A):s.push(o),o=A}else s.push(null)}for(var l=null,n=0;n<s.length;n++){var h=s[n];if(h===null)l===null&&(l=n);else if(l!==null){for(var d=n-l,f=s[l-1],m=(h-f)/(d+1),_=1;_<=d;_++)s[l+_-1]=m*_;l=null}}return r.map(function(u,B){var y=u.color;return{color:y,stop:Math.max(Math.min(1,s[B]/e),0)}})},_E=function(r,e,t){var i=e/2,s=t/2,o=xt(r[0],e)-i,n=s-xt(r[1],t);return(Math.atan2(n,o)+Math.PI*2)%(Math.PI*2)},vE=function(r,e,t){var i=typeof r=="number"?r:_E(r,e,t),s=Math.abs(e*Math.sin(i))+Math.abs(t*Math.cos(i)),o=e/2,n=t/2,a=s/2,A=Math.sin(i-Math.PI/2)*a,l=Math.cos(i-Math.PI/2)*a;return[s,o-l,o+l,n-A,n+A]},Fi=function(r,e){return Math.sqrt(r*r+e*e)},jd=function(r,e,t,i,s){var o=[[0,0],[0,e],[r,0],[r,e]];return o.reduce(function(n,a){var A=a[0],l=a[1],h=Fi(t-A,i-l);return(s?h<n.optimumDistance:h>n.optimumDistance)?{optimumCorner:a,optimumDistance:h}:n},{optimumDistance:s?1/0:-1/0,optimumCorner:null}).optimumCorner},BE=function(r,e,t,i,s){var o=0,n=0;switch(r.size){case 0:r.shape===0?o=n=Math.min(Math.abs(e),Math.abs(e-i),Math.abs(t),Math.abs(t-s)):r.shape===1&&(o=Math.min(Math.abs(e),Math.abs(e-i)),n=Math.min(Math.abs(t),Math.abs(t-s)));break;case 2:if(r.shape===0)o=n=Math.min(Fi(e,t),Fi(e,t-s),Fi(e-i,t),Fi(e-i,t-s));else if(r.shape===1){var a=Math.min(Math.abs(t),Math.abs(t-s))/Math.min(Math.abs(e),Math.abs(e-i)),A=jd(i,s,e,t,!0),l=A[0],h=A[1];o=Fi(l-e,(h-t)/a),n=a*o}break;case 1:r.shape===0?o=n=Math.max(Math.abs(e),Math.abs(e-i),Math.abs(t),Math.abs(t-s)):r.shape===1&&(o=Math.max(Math.abs(e),Math.abs(e-i)),n=Math.max(Math.abs(t),Math.abs(t-s)));break;case 3:if(r.shape===0)o=n=Math.max(Fi(e,t),Fi(e,t-s),Fi(e-i,t),Fi(e-i,t-s));else if(r.shape===1){var a=Math.max(Math.abs(t),Math.abs(t-s))/Math.max(Math.abs(e),Math.abs(e-i)),d=jd(i,s,e,t,!1),l=d[0],h=d[1];o=Fi(l-e,(h-t)/a),n=a*o}break}return Array.isArray(r.size)&&(o=xt(r.size[0],i),n=r.size.length===2?xt(r.size[1],s):o),[o,n]},PE=function(r,e){var t=bi(180),i=[];return ji(e).forEach(function(s,o){if(o===0){var n=s[0];if(n.type===20&&n.value==="to"){t=Eg(s);return}else if(Cg(n)){t=Ma.parse(r,n);return}}var a=Sa(r,s);i.push(a)}),{angle:t,stops:i,type:1}},Nn=function(r,e){var t=bi(180),i=[];return ji(e).forEach(function(s,o){if(o===0){var n=s[0];if(n.type===20&&["top","left","right","bottom"].indexOf(n.value)!==-1){t=Eg(s);return}else if(Cg(n)){t=(Ma.parse(r,n)+bi(270))%bi(360);return}}var a=Sa(r,s);i.push(a)}),{angle:t,stops:i,type:1}},yE=function(r,e){var t=bi(180),i=[],s=1,o=0,n=3,a=[];return ji(e).forEach(function(A,l){var h=A[0];if(l===0){if(Pt(h)&&h.value==="linear"){s=1;return}else if(Pt(h)&&h.value==="radial"){s=2;return}}if(h.type===18){if(h.name==="from"){var d=Bs.parse(r,h.values[0]);i.push({stop:qt,color:d})}else if(h.name==="to"){var d=Bs.parse(r,h.values[0]);i.push({stop:_s,color:d})}else if(h.name==="color-stop"){var f=h.values.filter(Ir);if(f.length===2){var d=Bs.parse(r,f[1]),m=f[0];Rr(m)&&i.push({stop:{type:16,number:m.number*100,flags:m.flags},color:d})}}}}),s===1?{angle:(t+bi(180))%bi(360),stops:i,type:s}:{size:n,shape:o,stops:i,position:a,type:s}},Ig="closest-side",Fg="farthest-side",Mg="closest-corner",Sg="farthest-corner",Tg="circle",Dg="ellipse",Rg="cover",Lg="contain",xE=function(r,e){var t=0,i=3,s=[],o=[];return ji(e).forEach(function(n,a){var A=!0;if(a===0){var l=!1;A=n.reduce(function(d,f){if(l)if(Pt(f))switch(f.value){case"center":return o.push(wc),d;case"top":case"left":return o.push(qt),d;case"right":case"bottom":return o.push(_s),d}else(Nt(f)||xs(f))&&o.push(f);else if(Pt(f))switch(f.value){case Tg:return t=0,!1;case Dg:return t=1,!1;case"at":return l=!0,!1;case Ig:return i=0,!1;case Rg:case Fg:return i=1,!1;case Lg:case Mg:return i=2,!1;case Sg:return i=3,!1}else if(xs(f)||Nt(f))return Array.isArray(i)||(i=[]),i.push(f),!1;return d},A)}if(A){var h=Sa(r,n);s.push(h)}}),{size:i,shape:t,stops:s,position:o,type:2}},Qn=function(r,e){var t=0,i=3,s=[],o=[];return ji(e).forEach(function(n,a){var A=!0;if(a===0?A=n.reduce(function(h,d){if(Pt(d))switch(d.value){case"center":return o.push(wc),!1;case"top":case"left":return o.push(qt),!1;case"right":case"bottom":return o.push(_s),!1}else if(Nt(d)||xs(d))return o.push(d),!1;return h},A):a===1&&(A=n.reduce(function(h,d){if(Pt(d))switch(d.value){case Tg:return t=0,!1;case Dg:return t=1,!1;case Lg:case Ig:return i=0,!1;case Fg:return i=1,!1;case Mg:return i=2,!1;case Rg:case Sg:return i=3,!1}else if(xs(d)||Nt(d))return Array.isArray(i)||(i=[]),i.push(d),!1;return h},A)),A){var l=Sa(r,n);s.push(l)}}),{size:i,shape:t,stops:s,position:o,type:2}},wE=function(r){return r.type===1},bE=function(r){return r.type===2},bc={name:"image",parse:function(r,e){if(e.type===22){var t={url:e.value,type:0};return r.cache.addImage(e.value),t}if(e.type===18){var i=Ug[e.name];if(typeof i>"u")throw new Error('Attempting to parse an unsupported image function "'+e.name+'"');return i(r,e.values)}throw new Error("Unsupported image type "+e.type)}};function CE(r){return!(r.type===20&&r.value==="none")&&(r.type!==18||!!Ug[r.name])}var Ug={"linear-gradient":PE,"-moz-linear-gradient":Nn,"-ms-linear-gradient":Nn,"-o-linear-gradient":Nn,"-webkit-linear-gradient":Nn,"radial-gradient":xE,"-moz-radial-gradient":Qn,"-ms-radial-gradient":Qn,"-o-radial-gradient":Qn,"-webkit-radial-gradient":Qn,"-webkit-gradient":yE},EE={name:"background-image",initialValue:"none",type:1,prefix:!1,parse:function(r,e){if(e.length===0)return[];var t=e[0];return t.type===20&&t.value==="none"?[]:e.filter(function(i){return Ir(i)&&CE(i)}).map(function(i){return bc.parse(r,i)})}},IE={name:"background-origin",initialValue:"border-box",prefix:!1,type:1,parse:function(r,e){return e.map(function(t){if(Pt(t))switch(t.value){case"padding-box":return 1;case"content-box":return 2}return 0})}},FE={name:"background-position",initialValue:"0% 0%",type:1,prefix:!1,parse:function(r,e){return ji(e).map(function(t){return t.filter(Nt)}).map(Pg)}},ME={name:"background-repeat",initialValue:"repeat",prefix:!1,type:1,parse:function(r,e){return ji(e).map(function(t){return t.filter(Pt).map(function(i){return i.value}).join(" ")}).map(SE)}},SE=function(r){switch(r){case"no-repeat":return 1;case"repeat-x":case"repeat no-repeat":return 2;case"repeat-y":case"no-repeat repeat":return 3;case"repeat":default:return 0}},br;(function(r){r.AUTO="auto",r.CONTAIN="contain",r.COVER="cover"})(br||(br={}));var TE={name:"background-size",initialValue:"0",prefix:!1,type:1,parse:function(r,e){return ji(e).map(function(t){return t.filter(DE)})}},DE=function(r){return Pt(r)||Nt(r)},Ta=function(r){return{name:"border-"+r+"-color",initialValue:"transparent",prefix:!1,type:3,format:"color"}},RE=Ta("top"),LE=Ta("right"),UE=Ta("bottom"),OE=Ta("left"),Da=function(r){return{name:"border-radius-"+r,initialValue:"0 0",prefix:!1,type:1,parse:function(e,t){return Pg(t.filter(Nt))}}},kE=Da("top-left"),NE=Da("top-right"),QE=Da("bottom-right"),HE=Da("bottom-left"),Ra=function(r){return{name:"border-"+r+"-style",initialValue:"solid",prefix:!1,type:2,parse:function(e,t){switch(t){case"none":return 0;case"dashed":return 2;case"dotted":return 3;case"double":return 4}return 1}}},VE=Ra("top"),GE=Ra("right"),jE=Ra("bottom"),zE=Ra("left"),La=function(r){return{name:"border-"+r+"-width",initialValue:"0",type:0,prefix:!1,parse:function(e,t){return Ho(t)?t.number:0}}},KE=La("top"),WE=La("right"),XE=La("bottom"),YE=La("left"),JE={name:"color",initialValue:"transparent",prefix:!1,type:3,format:"color"},ZE={name:"direction",initialValue:"ltr",prefix:!1,type:2,parse:function(r,e){switch(e){case"rtl":return 1;case"ltr":default:return 0}}},qE={name:"display",initialValue:"inline-block",prefix:!1,type:1,parse:function(r,e){return e.filter(Pt).reduce(function(t,i){return t|$E(i.value)},0)}},$E=function(r){switch(r){case"block":case"-webkit-box":return 2;case"inline":return 4;case"run-in":return 8;case"flow":return 16;case"flow-root":return 32;case"table":return 64;case"flex":case"-webkit-flex":return 128;case"grid":case"-ms-grid":return 256;case"ruby":return 512;case"subgrid":return 1024;case"list-item":return 2048;case"table-row-group":return 4096;case"table-header-group":return 8192;case"table-footer-group":return 16384;case"table-row":return 32768;case"table-cell":return 65536;case"table-column-group":return 131072;case"table-column":return 262144;case"table-caption":return 524288;case"ruby-base":return 1048576;case"ruby-text":return 2097152;case"ruby-base-container":return 4194304;case"ruby-text-container":return 8388608;case"contents":return 16777216;case"inline-block":return 33554432;case"inline-list-item":return 67108864;case"inline-table":return 134217728;case"inline-flex":return 268435456;case"inline-grid":return 536870912}return 0},eI={name:"float",initialValue:"none",prefix:!1,type:2,parse:function(r,e){switch(e){case"left":return 1;case"right":return 2;case"inline-start":return 3;case"inline-end":return 4}return 0}},tI={name:"letter-spacing",initialValue:"0",prefix:!1,type:0,parse:function(r,e){return e.type===20&&e.value==="normal"?0:e.type===17||e.type===15?e.number:0}},da;(function(r){r.NORMAL="normal",r.STRICT="strict"})(da||(da={}));var iI={name:"line-break",initialValue:"normal",prefix:!1,type:2,parse:function(r,e){switch(e){case"strict":return da.STRICT;case"normal":default:return da.NORMAL}}},sI={name:"line-height",initialValue:"normal",prefix:!1,type:4},zd=function(r,e){return Pt(r)&&r.value==="normal"?1.2*e:r.type===17?e*r.number:Nt(r)?xt(r,e):e},rI={name:"list-style-image",initialValue:"none",type:0,prefix:!1,parse:function(r,e){return e.type===20&&e.value==="none"?null:bc.parse(r,e)}},oI={name:"list-style-position",initialValue:"outside",prefix:!1,type:2,parse:function(r,e){switch(e){case"inside":return 0;case"outside":default:return 1}}},tc={name:"list-style-type",initialValue:"none",prefix:!1,type:2,parse:function(r,e){switch(e){case"disc":return 0;case"circle":return 1;case"square":return 2;case"decimal":return 3;case"cjk-decimal":return 4;case"decimal-leading-zero":return 5;case"lower-roman":return 6;case"upper-roman":return 7;case"lower-greek":return 8;case"lower-alpha":return 9;case"upper-alpha":return 10;case"arabic-indic":return 11;case"armenian":return 12;case"bengali":return 13;case"cambodian":return 14;case"cjk-earthly-branch":return 15;case"cjk-heavenly-stem":return 16;case"cjk-ideographic":return 17;case"devanagari":return 18;case"ethiopic-numeric":return 19;case"georgian":return 20;case"gujarati":return 21;case"gurmukhi":return 22;case"hebrew":return 22;case"hiragana":return 23;case"hiragana-iroha":return 24;case"japanese-formal":return 25;case"japanese-informal":return 26;case"kannada":return 27;case"katakana":return 28;case"katakana-iroha":return 29;case"khmer":return 30;case"korean-hangul-formal":return 31;case"korean-hanja-formal":return 32;case"korean-hanja-informal":return 33;case"lao":return 34;case"lower-armenian":return 35;case"malayalam":return 36;case"mongolian":return 37;case"myanmar":return 38;case"oriya":return 39;case"persian":return 40;case"simp-chinese-formal":return 41;case"simp-chinese-informal":return 42;case"tamil":return 43;case"telugu":return 44;case"thai":return 45;case"tibetan":return 46;case"trad-chinese-formal":return 47;case"trad-chinese-informal":return 48;case"upper-armenian":return 49;case"disclosure-open":return 50;case"disclosure-closed":return 51;case"none":default:return-1}}},Ua=function(r){return{name:"margin-"+r,initialValue:"0",prefix:!1,type:4}},nI=Ua("top"),aI=Ua("right"),AI=Ua("bottom"),lI=Ua("left"),cI={name:"overflow",initialValue:"visible",prefix:!1,type:1,parse:function(r,e){return e.filter(Pt).map(function(t){switch(t.value){case"hidden":return 1;case"scroll":return 2;case"clip":return 3;case"auto":return 4;case"visible":default:return 0}})}},hI={name:"overflow-wrap",initialValue:"normal",prefix:!1,type:2,parse:function(r,e){switch(e){case"break-word":return"break-word";case"normal":default:return"normal"}}},Oa=function(r){return{name:"padding-"+r,initialValue:"0",prefix:!1,type:3,format:"length-percentage"}},uI=Oa("top"),dI=Oa("right"),pI=Oa("bottom"),fI=Oa("left"),gI={name:"text-align",initialValue:"left",prefix:!1,type:2,parse:function(r,e){switch(e){case"right":return 2;case"center":case"justify":return 1;case"left":default:return 0}}},mI={name:"position",initialValue:"static",prefix:!1,type:2,parse:function(r,e){switch(e){case"relative":return 1;case"absolute":return 2;case"fixed":return 3;case"sticky":return 4}return 0}},_I={name:"text-shadow",initialValue:"none",type:1,prefix:!1,parse:function(r,e){return e.length===1&&ec(e[0],"none")?[]:ji(e).map(function(t){for(var i={color:os.TRANSPARENT,offsetX:qt,offsetY:qt,blur:qt},s=0,o=0;o<t.length;o++){var n=t[o];xs(n)?(s===0?i.offsetX=n:s===1?i.offsetY=n:i.blur=n,s++):i.color=Bs.parse(r,n)}return i})}},vI={name:"text-transform",initialValue:"none",prefix:!1,type:2,parse:function(r,e){switch(e){case"uppercase":return 2;case"lowercase":return 1;case"capitalize":return 3}return 0}},BI={name:"transform",initialValue:"none",prefix:!0,type:0,parse:function(r,e){if(e.type===20&&e.value==="none")return null;if(e.type===18){var t=xI[e.name];if(typeof t>"u")throw new Error('Attempting to parse an unsupported transform function "'+e.name+'"');return t(e.values)}return null}},PI=function(r){var e=r.filter(function(t){return t.type===17}).map(function(t){return t.number});return e.length===6?e:null},yI=function(r){var e=r.filter(function(A){return A.type===17}).map(function(A){return A.number}),t=e[0],i=e[1];e[2],e[3];var s=e[4],o=e[5];e[6],e[7],e[8],e[9],e[10],e[11];var n=e[12],a=e[13];return e[14],e[15],e.length===16?[t,i,s,o,n,a]:null},xI={matrix:PI,matrix3d:yI},Kd={type:16,number:50,flags:Qo},wI=[Kd,Kd],bI={name:"transform-origin",initialValue:"50% 50%",prefix:!0,type:1,parse:function(r,e){var t=e.filter(Nt);return t.length!==2?wI:[t[0],t[1]]}},CI={name:"visible",initialValue:"none",prefix:!1,type:2,parse:function(r,e){switch(e){case"hidden":return 1;case"collapse":return 2;case"visible":default:return 0}}},bo;(function(r){r.NORMAL="normal",r.BREAK_ALL="break-all",r.KEEP_ALL="keep-all"})(bo||(bo={}));var EI={name:"word-break",initialValue:"normal",prefix:!1,type:2,parse:function(r,e){switch(e){case"break-all":return bo.BREAK_ALL;case"keep-all":return bo.KEEP_ALL;case"normal":default:return bo.NORMAL}}},II={name:"z-index",initialValue:"auto",prefix:!1,type:0,parse:function(r,e){if(e.type===20)return{auto:!0,order:0};if(Rr(e))return{auto:!1,order:e.number};throw new Error("Invalid z-index number parsed")}},Og={name:"time",parse:function(r,e){if(e.type===15)switch(e.unit.toLowerCase()){case"s":return 1e3*e.number;case"ms":return e.number}throw new Error("Unsupported time type")}},FI={name:"opacity",initialValue:"1",type:0,prefix:!1,parse:function(r,e){return Rr(e)?e.number:1}},MI={name:"text-decoration-color",initialValue:"transparent",prefix:!1,type:3,format:"color"},SI={name:"text-decoration-line",initialValue:"none",prefix:!1,type:1,parse:function(r,e){return e.filter(Pt).map(function(t){switch(t.value){case"underline":return 1;case"overline":return 2;case"line-through":return 3;case"none":return 4}return 0}).filter(function(t){return t!==0})}},TI={name:"font-family",initialValue:"",prefix:!1,type:1,parse:function(r,e){var t=[],i=[];return e.forEach(function(s){switch(s.type){case 20:case 0:t.push(s.value);break;case 17:t.push(s.number.toString());break;case 4:i.push(t.join(" ")),t.length=0;break}}),t.length&&i.push(t.join(" ")),i.map(function(s){return s.indexOf(" ")===-1?s:"'"+s+"'"})}},DI={name:"font-size",initialValue:"0",prefix:!1,type:3,format:"length"},RI={name:"font-weight",initialValue:"normal",type:0,prefix:!1,parse:function(r,e){if(Rr(e))return e.number;if(Pt(e))switch(e.value){case"bold":return 700;case"normal":default:return 400}return 400}},LI={name:"font-variant",initialValue:"none",type:1,prefix:!1,parse:function(r,e){return e.filter(Pt).map(function(t){return t.value})}},UI={name:"font-style",initialValue:"normal",prefix:!1,type:2,parse:function(r,e){switch(e){case"oblique":return"oblique";case"italic":return"italic";case"normal":default:return"normal"}}},Vt=function(r,e){return(r&e)!==0},OI={name:"content",initialValue:"none",type:1,prefix:!1,parse:function(r,e){if(e.length===0)return[];var t=e[0];return t.type===20&&t.value==="none"?[]:e}},kI={name:"counter-increment",initialValue:"none",prefix:!0,type:1,parse:function(r,e){if(e.length===0)return null;var t=e[0];if(t.type===20&&t.value==="none")return null;for(var i=[],s=e.filter(Bg),o=0;o<s.length;o++){var n=s[o],a=s[o+1];if(n.type===20){var A=a&&Rr(a)?a.number:1;i.push({counter:n.value,increment:A})}}return i}},NI={name:"counter-reset",initialValue:"none",prefix:!0,type:1,parse:function(r,e){if(e.length===0)return[];for(var t=[],i=e.filter(Bg),s=0;s<i.length;s++){var o=i[s],n=i[s+1];if(Pt(o)&&o.value!=="none"){var a=n&&Rr(n)?n.number:0;t.push({counter:o.value,reset:a})}}return t}},QI={name:"duration",initialValue:"0s",prefix:!1,type:1,parse:function(r,e){return e.filter(Ho).map(function(t){return Og.parse(r,t)})}},HI={name:"quotes",initialValue:"none",prefix:!0,type:1,parse:function(r,e){if(e.length===0)return null;var t=e[0];if(t.type===20&&t.value==="none")return null;var i=[],s=e.filter(dE);if(s.length%2!==0)return null;for(var o=0;o<s.length;o+=2){var n=s[o].value,a=s[o+1].value;i.push({open:n,close:a})}return i}},Wd=function(r,e,t){if(!r)return"";var i=r[Math.min(e,r.length-1)];return i?t?i.open:i.close:""},VI={name:"box-shadow",initialValue:"none",type:1,prefix:!1,parse:function(r,e){return e.length===1&&ec(e[0],"none")?[]:ji(e).map(function(t){for(var i={color:255,offsetX:qt,offsetY:qt,blur:qt,spread:qt,inset:!1},s=0,o=0;o<t.length;o++){var n=t[o];ec(n,"inset")?i.inset=!0:xs(n)?(s===0?i.offsetX=n:s===1?i.offsetY=n:s===2?i.blur=n:i.spread=n,s++):i.color=Bs.parse(r,n)}return i})}},GI={name:"paint-order",initialValue:"normal",prefix:!1,type:1,parse:function(r,e){var t=[0,1,2],i=[];return e.filter(Pt).forEach(function(s){switch(s.value){case"stroke":i.push(1);break;case"fill":i.push(0);break;case"markers":i.push(2);break}}),t.forEach(function(s){i.indexOf(s)===-1&&i.push(s)}),i}},jI={name:"-webkit-text-stroke-color",initialValue:"currentcolor",prefix:!1,type:3,format:"color"},zI={name:"-webkit-text-stroke-width",initialValue:"0",type:0,prefix:!1,parse:function(r,e){return Ho(e)?e.number:0}},KI=function(){function r(e,t){var i,s;this.animationDuration=Oe(e,QI,t.animationDuration),this.backgroundClip=Oe(e,gE,t.backgroundClip),this.backgroundColor=Oe(e,mE,t.backgroundColor),this.backgroundImage=Oe(e,EE,t.backgroundImage),this.backgroundOrigin=Oe(e,IE,t.backgroundOrigin),this.backgroundPosition=Oe(e,FE,t.backgroundPosition),this.backgroundRepeat=Oe(e,ME,t.backgroundRepeat),this.backgroundSize=Oe(e,TE,t.backgroundSize),this.borderTopColor=Oe(e,RE,t.borderTopColor),this.borderRightColor=Oe(e,LE,t.borderRightColor),this.borderBottomColor=Oe(e,UE,t.borderBottomColor),this.borderLeftColor=Oe(e,OE,t.borderLeftColor),this.borderTopLeftRadius=Oe(e,kE,t.borderTopLeftRadius),this.borderTopRightRadius=Oe(e,NE,t.borderTopRightRadius),this.borderBottomRightRadius=Oe(e,QE,t.borderBottomRightRadius),this.borderBottomLeftRadius=Oe(e,HE,t.borderBottomLeftRadius),this.borderTopStyle=Oe(e,VE,t.borderTopStyle),this.borderRightStyle=Oe(e,GE,t.borderRightStyle),this.borderBottomStyle=Oe(e,jE,t.borderBottomStyle),this.borderLeftStyle=Oe(e,zE,t.borderLeftStyle),this.borderTopWidth=Oe(e,KE,t.borderTopWidth),this.borderRightWidth=Oe(e,WE,t.borderRightWidth),this.borderBottomWidth=Oe(e,XE,t.borderBottomWidth),this.borderLeftWidth=Oe(e,YE,t.borderLeftWidth),this.boxShadow=Oe(e,VI,t.boxShadow),this.color=Oe(e,JE,t.color),this.direction=Oe(e,ZE,t.direction),this.display=Oe(e,qE,t.display),this.float=Oe(e,eI,t.cssFloat),this.fontFamily=Oe(e,TI,t.fontFamily),this.fontSize=Oe(e,DI,t.fontSize),this.fontStyle=Oe(e,UI,t.fontStyle),this.fontVariant=Oe(e,LI,t.fontVariant),this.fontWeight=Oe(e,RI,t.fontWeight),this.letterSpacing=Oe(e,tI,t.letterSpacing),this.lineBreak=Oe(e,iI,t.lineBreak),this.lineHeight=Oe(e,sI,t.lineHeight),this.listStyleImage=Oe(e,rI,t.listStyleImage),this.listStylePosition=Oe(e,oI,t.listStylePosition),this.listStyleType=Oe(e,tc,t.listStyleType),this.marginTop=Oe(e,nI,t.marginTop),this.marginRight=Oe(e,aI,t.marginRight),this.marginBottom=Oe(e,AI,t.marginBottom),this.marginLeft=Oe(e,lI,t.marginLeft),this.opacity=Oe(e,FI,t.opacity);var o=Oe(e,cI,t.overflow);this.overflowX=o[0],this.overflowY=o[o.length>1?1:0],this.overflowWrap=Oe(e,hI,t.overflowWrap),this.paddingTop=Oe(e,uI,t.paddingTop),this.paddingRight=Oe(e,dI,t.paddingRight),this.paddingBottom=Oe(e,pI,t.paddingBottom),this.paddingLeft=Oe(e,fI,t.paddingLeft),this.paintOrder=Oe(e,GI,t.paintOrder),this.position=Oe(e,mI,t.position),this.textAlign=Oe(e,gI,t.textAlign),this.textDecorationColor=Oe(e,MI,(i=t.textDecorationColor)!==null&&i!==void 0?i:t.color),this.textDecorationLine=Oe(e,SI,(s=t.textDecorationLine)!==null&&s!==void 0?s:t.textDecoration),this.textShadow=Oe(e,_I,t.textShadow),this.textTransform=Oe(e,vI,t.textTransform),this.transform=Oe(e,BI,t.transform),this.transformOrigin=Oe(e,bI,t.transformOrigin),this.visibility=Oe(e,CI,t.visibility),this.webkitTextStrokeColor=Oe(e,jI,t.webkitTextStrokeColor),this.webkitTextStrokeWidth=Oe(e,zI,t.webkitTextStrokeWidth),this.wordBreak=Oe(e,EI,t.wordBreak),this.zIndex=Oe(e,II,t.zIndex)}return r.prototype.isVisible=function(){return this.display>0&&this.opacity>0&&this.visibility===0},r.prototype.isTransparent=function(){return Ps(this.backgroundColor)},r.prototype.isTransformed=function(){return this.transform!==null},r.prototype.isPositioned=function(){return this.position!==0},r.prototype.isPositionedWithZIndex=function(){return this.isPositioned()&&!this.zIndex.auto},r.prototype.isFloating=function(){return this.float!==0},r.prototype.isInlineLevel=function(){return Vt(this.display,4)||Vt(this.display,33554432)||Vt(this.display,268435456)||Vt(this.display,536870912)||Vt(this.display,67108864)||Vt(this.display,134217728)},r}(),WI=function(){function r(e,t){this.content=Oe(e,OI,t.content),this.quotes=Oe(e,HI,t.quotes)}return r}(),Xd=function(){function r(e,t){this.counterIncrement=Oe(e,kI,t.counterIncrement),this.counterReset=Oe(e,NI,t.counterReset)}return r}(),Oe=function(r,e,t){var i=new _g,s=t!==null&&typeof t<"u"?t.toString():e.initialValue;i.write(s);var o=new vg(i.read());switch(e.type){case 2:var n=o.parseComponentValue();return e.parse(r,Pt(n)?n.value:e.initialValue);case 0:return e.parse(r,o.parseComponentValue());case 1:return e.parse(r,o.parseComponentValues());case 4:return o.parseComponentValue();case 3:switch(e.format){case"angle":return Ma.parse(r,o.parseComponentValue());case"color":return Bs.parse(r,o.parseComponentValue());case"image":return bc.parse(r,o.parseComponentValue());case"length":var a=o.parseComponentValue();return xs(a)?a:qt;case"length-percentage":var A=o.parseComponentValue();return Nt(A)?A:qt;case"time":return Og.parse(r,o.parseComponentValue())}break}},XI="data-html2canvas-debug",YI=function(r){var e=r.getAttribute(XI);switch(e){case"all":return 1;case"clone":return 2;case"parse":return 3;case"render":return 4;default:return 0}},ic=function(r,e){var t=YI(r);return t===1||e===t},zi=function(){function r(e,t){if(this.context=e,this.textNodes=[],this.elements=[],this.flags=0,ic(t,3))debugger;this.styles=new KI(e,window.getComputedStyle(t,null)),oc(t)&&(this.styles.animationDuration.some(function(i){return i>0})&&(t.style.animationDuration="0s"),this.styles.transform!==null&&(t.style.transform="none")),this.bounds=Ia(this.context,t),ic(t,4)&&(this.flags|=16)}return r}(),JI="AAAAAAAAAAAAEA4AGBkAAFAaAAACAAAAAAAIABAAGAAwADgACAAQAAgAEAAIABAACAAQAAgAEAAIABAACAAQAAgAEAAIABAAQABIAEQATAAIABAACAAQAAgAEAAIABAAVABcAAgAEAAIABAACAAQAGAAaABwAHgAgACIAI4AlgAIABAAmwCjAKgAsAC2AL4AvQDFAMoA0gBPAVYBWgEIAAgACACMANoAYgFkAWwBdAF8AX0BhQGNAZUBlgGeAaMBlQGWAasBswF8AbsBwwF0AcsBYwHTAQgA2wG/AOMBdAF8AekB8QF0AfkB+wHiAHQBfAEIAAMC5gQIAAsCEgIIAAgAFgIeAggAIgIpAggAMQI5AkACygEIAAgASAJQAlgCYAIIAAgACAAKBQoFCgUTBRMFGQUrBSsFCAAIAAgACAAIAAgACAAIAAgACABdAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABoAmgCrwGvAQgAbgJ2AggAHgEIAAgACADnAXsCCAAIAAgAgwIIAAgACAAIAAgACACKAggAkQKZAggAPADJAAgAoQKkAqwCsgK6AsICCADJAggA0AIIAAgACAAIANYC3gIIAAgACAAIAAgACABAAOYCCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAkASoB+QIEAAgACAA8AEMCCABCBQgACABJBVAFCAAIAAgACAAIAAgACAAIAAgACABTBVoFCAAIAFoFCABfBWUFCAAIAAgACAAIAAgAbQUIAAgACAAIAAgACABzBXsFfQWFBYoFigWKBZEFigWKBYoFmAWfBaYFrgWxBbkFCAAIAAgACAAIAAgACAAIAAgACAAIAMEFCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAMgFCADQBQgACAAIAAgACAAIAAgACAAIAAgACAAIAO4CCAAIAAgAiQAIAAgACABAAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAD0AggACAD8AggACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIANYFCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAMDvwAIAAgAJAIIAAgACAAIAAgACAAIAAgACwMTAwgACAB9BOsEGwMjAwgAKwMyAwsFYgE3A/MEPwMIAEUDTQNRAwgAWQOsAGEDCAAIAAgACAAIAAgACABpAzQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFIQUoBSwFCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABtAwgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABMAEwACAAIAAgACAAIABgACAAIAAgACAC/AAgACAAyAQgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACACAAIAAwAAgACAAIAAgACAAIAAgACAAIAAAARABIAAgACAAIABQASAAIAAgAIABwAEAAjgCIABsAqAC2AL0AigDQAtwC+IJIQqVAZUBWQqVAZUBlQGVAZUBlQGrC5UBlQGVAZUBlQGVAZUBlQGVAXsKlQGVAbAK6wsrDGUMpQzlDJUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAfAKAAuZA64AtwCJALoC6ADwAAgAuACgA/oEpgO6AqsD+AAIAAgAswMIAAgACAAIAIkAuwP5AfsBwwPLAwgACAAIAAgACADRA9kDCAAIAOED6QMIAAgACAAIAAgACADuA/YDCAAIAP4DyQAIAAgABgQIAAgAXQAOBAgACAAIAAgACAAIABMECAAIAAgACAAIAAgACAD8AAQBCAAIAAgAGgQiBCoECAExBAgAEAEIAAgACAAIAAgACAAIAAgACAAIAAgACAA4BAgACABABEYECAAIAAgATAQYAQgAVAQIAAgACAAIAAgACAAIAAgACAAIAFoECAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAOQEIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAB+BAcACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAEABhgSMBAgACAAIAAgAlAQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAwAEAAQABAADAAMAAwADAAQABAAEAAQABAAEAAQABHATAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAdQMIAAgACAAIAAgACAAIAMkACAAIAAgAfQMIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACACFA4kDCAAIAAgACAAIAOcBCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAIcDCAAIAAgACAAIAAgACAAIAAgACAAIAJEDCAAIAAgACADFAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABgBAgAZgQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAbAQCBXIECAAIAHkECAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABAAJwEQACjBKoEsgQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAC6BMIECAAIAAgACAAIAAgACABmBAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAxwQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAGYECAAIAAgAzgQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAigWKBYoFigWKBYoFigWKBd0FXwUIAOIF6gXxBYoF3gT5BQAGCAaKBYoFigWKBYoFigWKBYoFigWKBYoFigXWBIoFigWKBYoFigWKBYoFigWKBYsFEAaKBYoFigWKBYoFigWKBRQGCACKBYoFigWKBQgACAAIANEECAAIABgGigUgBggAJgYIAC4GMwaKBYoF0wQ3Bj4GigWKBYoFigWKBYoFigWKBYoFigWKBYoFigUIAAgACAAIAAgACAAIAAgAigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWLBf///////wQABAAEAAQABAAEAAQABAAEAAQAAwAEAAQAAgAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAQADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAUAAAAFAAUAAAAFAAUAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQABAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUAAQAAAAUABQAFAAUABQAFAAAAAAAFAAUAAAAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAFAAUAAQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABwAFAAUABQAFAAAABwAHAAcAAAAHAAcABwAFAAEAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAcABwAFAAUAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAAAAQABAAAAAAAAAAAAAAAFAAUABQAFAAAABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAcABwAHAAcAAAAHAAcAAAAAAAUABQAHAAUAAQAHAAEABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABwABAAUABQAFAAUAAAAAAAAAAAAAAAEAAQABAAEAAQABAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABwAFAAUAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUAAQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABQANAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAEAAQABAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQABAAEAAQABAAEAAQABAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAABQAHAAUABQAFAAAAAAAAAAcABQAFAAUABQAFAAQABAAEAAQABAAEAAQABAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUAAAAFAAUABQAFAAUAAAAFAAUABQAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAAAAAAAAAAAAUABQAFAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAUAAAAHAAcABwAFAAUABQAFAAUABQAFAAUABwAHAAcABwAFAAcABwAAAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAUABwAHAAUABQAFAAUAAAAAAAcABwAAAAAABwAHAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAABQAFAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAABwAHAAcABQAFAAAAAAAAAAAABQAFAAAAAAAFAAUABQAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAFAAUABQAFAAUAAAAFAAUABwAAAAcABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAFAAUABwAFAAUABQAFAAAAAAAHAAcAAAAAAAcABwAFAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAcABwAAAAAAAAAHAAcABwAAAAcABwAHAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAABQAHAAcABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAHAAcABwAAAAUABQAFAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAcABQAHAAcABQAHAAcAAAAFAAcABwAAAAcABwAFAAUAAAAAAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAUABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAFAAcABwAFAAUABQAAAAUAAAAHAAcABwAHAAcABwAHAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAHAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAABwAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAUAAAAFAAAAAAAAAAAABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABwAFAAUABQAFAAUAAAAFAAUAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABwAFAAUABQAFAAUABQAAAAUABQAHAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABQAFAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAcABQAFAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAHAAUABQAFAAUABQAFAAUABwAHAAcABwAHAAcABwAHAAUABwAHAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABwAHAAcABwAFAAUABwAHAAcAAAAAAAAAAAAHAAcABQAHAAcABwAHAAcABwAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAcABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAHAAUABQAFAAUABQAFAAUAAAAFAAAABQAAAAAABQAFAAUABQAFAAUABQAFAAcABwAHAAcABwAHAAUABQAFAAUABQAFAAUABQAFAAUAAAAAAAUABQAFAAUABQAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABwAFAAcABwAHAAcABwAFAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAUABQAFAAUABwAHAAUABQAHAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAcABQAFAAcABwAHAAUABwAFAAUABQAHAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABwAHAAcABwAHAAUABQAFAAUABQAFAAUABQAHAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAcABQAFAAUABQAFAAUABQAAAAAAAAAAAAUAAAAAAAAAAAAAAAAABQAAAAAABwAFAAUAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUAAAAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAABQAAAAAAAAAFAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAUABQAHAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAHAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAHAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAcABwAFAAUABQAFAAcABwAFAAUABwAHAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAcABwAFAAUABwAHAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAFAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAFAAUABQAAAAAABQAFAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAFAAcABwAAAAAAAAAAAAAABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAFAAcABwAFAAcABwAAAAcABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAFAAUABQAAAAUABQAAAAAAAAAAAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABwAFAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABQAFAAUABQAFAAUABQAFAAUABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAHAAcABQAHAAUABQAAAAAAAAAAAAAAAAAFAAAABwAHAAcABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAHAAcABwAAAAAABwAHAAAAAAAHAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAAAAAAFAAUABQAFAAUABQAFAAAAAAAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAUABQAFAAUABwAHAAUABQAFAAcABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAcABQAFAAUABQAFAAUABwAFAAcABwAFAAcABQAFAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAcABQAFAAUABQAAAAAABwAHAAcABwAFAAUABwAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAHAAUABQAFAAUABQAFAAUABQAHAAcABQAHAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAFAAcABwAFAAUABQAFAAUABQAHAAUAAAAAAAAAAAAAAAAAAAAAAAcABwAFAAUABQAFAAcABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAUABQAFAAUABQAHAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAAAAAAFAAUABwAHAAcABwAFAAAAAAAAAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABwAHAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAFAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAcABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAAAHAAUABQAFAAUABQAFAAUABwAFAAUABwAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUAAAAAAAAABQAAAAUABQAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAHAAcAAAAFAAUAAAAHAAcABQAHAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAAAAAAAAAAAAAAAAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAUABQAFAAAAAAAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAABQAFAAUABQAFAAUABQAAAAUABQAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAFAAUABQAFAAUADgAOAA4ADgAOAA4ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAAAAAAAAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAMAAwADAAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkAAAAAAAAAAAAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAAAAAAAAAAAAsADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwACwAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAADgAOAA4AAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAAAA4ADgAOAA4ADgAOAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAAAA4AAAAOAAAAAAAAAAAAAAAAAA4AAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAADgAAAAAAAAAAAA4AAAAOAAAAAAAAAAAADgAOAA4AAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4AAAAAAA4ADgAOAA4ADgAOAA4ADgAOAAAADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4AAAAAAAAAAAAAAAAAAAAAAA4ADgAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAOAA4ADgAOAA4ADgAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAAAAAAAAA=",Yd="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",_o=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var Hn=0;Hn<Yd.length;Hn++)_o[Yd.charCodeAt(Hn)]=Hn;var ZI=function(r){var e=r.length*.75,t=r.length,i,s=0,o,n,a,A;r[r.length-1]==="="&&(e--,r[r.length-2]==="="&&e--);var l=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u"&&typeof Uint8Array.prototype.slice<"u"?new ArrayBuffer(e):new Array(e),h=Array.isArray(l)?l:new Uint8Array(l);for(i=0;i<t;i+=4)o=_o[r.charCodeAt(i)],n=_o[r.charCodeAt(i+1)],a=_o[r.charCodeAt(i+2)],A=_o[r.charCodeAt(i+3)],h[s++]=o<<2|n>>4,h[s++]=(n&15)<<4|a>>2,h[s++]=(a&3)<<6|A&63;return l},qI=function(r){for(var e=r.length,t=[],i=0;i<e;i+=2)t.push(r[i+1]<<8|r[i]);return t},$I=function(r){for(var e=r.length,t=[],i=0;i<e;i+=4)t.push(r[i+3]<<24|r[i+2]<<16|r[i+1]<<8|r[i]);return t},ks=5,Cc=11,JA=2,eF=Cc-ks,kg=65536>>ks,tF=1<<ks,ZA=tF-1,iF=1024>>ks,sF=kg+iF,rF=sF,oF=32,nF=rF+oF,aF=65536>>Cc,AF=1<<eF,lF=AF-1,Jd=function(r,e,t){return r.slice?r.slice(e,t):new Uint16Array(Array.prototype.slice.call(r,e,t))},cF=function(r,e,t){return r.slice?r.slice(e,t):new Uint32Array(Array.prototype.slice.call(r,e,t))},hF=function(r,e){var t=ZI(r),i=Array.isArray(t)?$I(t):new Uint32Array(t),s=Array.isArray(t)?qI(t):new Uint16Array(t),o=24,n=Jd(s,o/2,i[4]/2),a=i[5]===2?Jd(s,(o+i[4])/2):cF(i,Math.ceil((o+i[4])/4));return new uF(i[0],i[1],i[2],i[3],n,a)},uF=function(){function r(e,t,i,s,o,n){this.initialValue=e,this.errorValue=t,this.highStart=i,this.highValueIndex=s,this.index=o,this.data=n}return r.prototype.get=function(e){var t;if(e>=0){if(e<55296||e>56319&&e<=65535)return t=this.index[e>>ks],t=(t<<JA)+(e&ZA),this.data[t];if(e<=65535)return t=this.index[kg+(e-55296>>ks)],t=(t<<JA)+(e&ZA),this.data[t];if(e<this.highStart)return t=nF-aF+(e>>Cc),t=this.index[t],t+=e>>ks&lF,t=this.index[t],t=(t<<JA)+(e&ZA),this.data[t];if(e<=1114111)return this.data[this.highValueIndex]}return this.errorValue},r}(),Zd="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",dF=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var Vn=0;Vn<Zd.length;Vn++)dF[Zd.charCodeAt(Vn)]=Vn;var pF=1,qA=2,$A=3,qd=4,$d=5,fF=7,ep=8,el=9,tl=10,tp=11,ip=12,sp=13,rp=14,il=15,gF=function(r){for(var e=[],t=0,i=r.length;t<i;){var s=r.charCodeAt(t++);if(s>=55296&&s<=56319&&t<i){var o=r.charCodeAt(t++);(o&64512)===56320?e.push(((s&1023)<<10)+(o&1023)+65536):(e.push(s),t--)}else e.push(s)}return e},mF=function(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];if(String.fromCodePoint)return String.fromCodePoint.apply(String,r);var t=r.length;if(!t)return"";for(var i=[],s=-1,o="";++s<t;){var n=r[s];n<=65535?i.push(n):(n-=65536,i.push((n>>10)+55296,n%1024+56320)),(s+1===t||i.length>16384)&&(o+=String.fromCharCode.apply(String,i),i.length=0)}return o},_F=hF(JI),vi="",sl="",vF=function(r){return _F.get(r)},BF=function(r,e,t){var i=t-2,s=e[i],o=e[t-1],n=e[t];if(o===qA&&n===$A)return vi;if(o===qA||o===$A||o===qd||n===qA||n===$A||n===qd)return sl;if(o===ep&&[ep,el,tp,ip].indexOf(n)!==-1||(o===tp||o===el)&&(n===el||n===tl)||(o===ip||o===tl)&&n===tl||n===sp||n===$d||n===fF||o===pF)return vi;if(o===sp&&n===rp){for(;s===$d;)s=e[--i];if(s===rp)return vi}if(o===il&&n===il){for(var a=0;s===il;)a++,s=e[--i];if(a%2===0)return vi}return sl},PF=function(r){var e=gF(r),t=e.length,i=0,s=0,o=e.map(vF);return{next:function(){if(i>=t)return{done:!0,value:null};for(var n=vi;i<t&&(n=BF(e,o,++i))===vi;);if(n!==vi||i===t){var a=mF.apply(null,e.slice(s,i));return s=i,{value:a,done:!1}}return{done:!0,value:null}}}},yF=function(r){for(var e=PF(r),t=[],i;!(i=e.next()).done;)i.value&&t.push(i.value.slice());return t},xF=function(r){var e=123;if(r.createRange){var t=r.createRange();if(t.getBoundingClientRect){var i=r.createElement("boundtest");i.style.height=e+"px",i.style.display="block",r.body.appendChild(i),t.selectNode(i);var s=t.getBoundingClientRect(),o=Math.round(s.height);if(r.body.removeChild(i),o===e)return!0}}return!1},wF=function(r){var e=r.createElement("boundtest");e.style.width="50px",e.style.display="block",e.style.fontSize="12px",e.style.letterSpacing="0px",e.style.wordSpacing="0px",r.body.appendChild(e);var t=r.createRange();e.innerHTML=typeof"".repeat=="function"?"&#128104;".repeat(10):"";var i=e.firstChild,s=Fa(i.data).map(function(A){return Lt(A)}),o=0,n={},a=s.every(function(A,l){t.setStart(i,o),t.setEnd(i,o+A.length);var h=t.getBoundingClientRect();o+=A.length;var d=h.x>n.x||h.y>n.y;return n=h,l===0?!0:d});return r.body.removeChild(e),a},bF=function(){return typeof new Image().crossOrigin<"u"},CF=function(){return typeof new XMLHttpRequest().responseType=="string"},EF=function(r){var e=new Image,t=r.createElement("canvas"),i=t.getContext("2d");if(!i)return!1;e.src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'></svg>";try{i.drawImage(e,0,0),t.toDataURL()}catch{return!1}return!0},op=function(r){return r[0]===0&&r[1]===255&&r[2]===0&&r[3]===255},IF=function(r){var e=r.createElement("canvas"),t=100;e.width=t,e.height=t;var i=e.getContext("2d");if(!i)return Promise.reject(!1);i.fillStyle="rgb(0, 255, 0)",i.fillRect(0,0,t,t);var s=new Image,o=e.toDataURL();s.src=o;var n=sc(t,t,0,0,s);return i.fillStyle="red",i.fillRect(0,0,t,t),np(n).then(function(a){i.drawImage(a,0,0);var A=i.getImageData(0,0,t,t).data;i.fillStyle="red",i.fillRect(0,0,t,t);var l=r.createElement("div");return l.style.backgroundImage="url("+o+")",l.style.height=t+"px",op(A)?np(sc(t,t,0,0,l)):Promise.reject(!1)}).then(function(a){return i.drawImage(a,0,0),op(i.getImageData(0,0,t,t).data)}).catch(function(){return!1})},sc=function(r,e,t,i,s){var o="http://www.w3.org/2000/svg",n=document.createElementNS(o,"svg"),a=document.createElementNS(o,"foreignObject");return n.setAttributeNS(null,"width",r.toString()),n.setAttributeNS(null,"height",e.toString()),a.setAttributeNS(null,"width","100%"),a.setAttributeNS(null,"height","100%"),a.setAttributeNS(null,"x",t.toString()),a.setAttributeNS(null,"y",i.toString()),a.setAttributeNS(null,"externalResourcesRequired","true"),n.appendChild(a),a.appendChild(s),n},np=function(r){return new Promise(function(e,t){var i=new Image;i.onload=function(){return e(i)},i.onerror=t,i.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(new XMLSerializer().serializeToString(r))})},Zt={get SUPPORT_RANGE_BOUNDS(){var r=xF(document);return Object.defineProperty(Zt,"SUPPORT_RANGE_BOUNDS",{value:r}),r},get SUPPORT_WORD_BREAKING(){var r=Zt.SUPPORT_RANGE_BOUNDS&&wF(document);return Object.defineProperty(Zt,"SUPPORT_WORD_BREAKING",{value:r}),r},get SUPPORT_SVG_DRAWING(){var r=EF(document);return Object.defineProperty(Zt,"SUPPORT_SVG_DRAWING",{value:r}),r},get SUPPORT_FOREIGNOBJECT_DRAWING(){var r=typeof Array.from=="function"&&typeof window.fetch=="function"?IF(document):Promise.resolve(!1);return Object.defineProperty(Zt,"SUPPORT_FOREIGNOBJECT_DRAWING",{value:r}),r},get SUPPORT_CORS_IMAGES(){var r=bF();return Object.defineProperty(Zt,"SUPPORT_CORS_IMAGES",{value:r}),r},get SUPPORT_RESPONSE_TYPE(){var r=CF();return Object.defineProperty(Zt,"SUPPORT_RESPONSE_TYPE",{value:r}),r},get SUPPORT_CORS_XHR(){var r="withCredentials"in new XMLHttpRequest;return Object.defineProperty(Zt,"SUPPORT_CORS_XHR",{value:r}),r},get SUPPORT_NATIVE_TEXT_SEGMENTATION(){var r=!!(typeof Intl<"u"&&Intl.Segmenter);return Object.defineProperty(Zt,"SUPPORT_NATIVE_TEXT_SEGMENTATION",{value:r}),r}},Co=function(){function r(e,t){this.text=e,this.bounds=t}return r}(),FF=function(r,e,t,i){var s=TF(e,t),o=[],n=0;return s.forEach(function(a){if(t.textDecorationLine.length||a.trim().length>0)if(Zt.SUPPORT_RANGE_BOUNDS){var A=ap(i,n,a.length).getClientRects();if(A.length>1){var l=Ec(a),h=0;l.forEach(function(f){o.push(new Co(f,As.fromDOMRectList(r,ap(i,h+n,f.length).getClientRects()))),h+=f.length})}else o.push(new Co(a,As.fromDOMRectList(r,A)))}else{var d=i.splitText(a.length);o.push(new Co(a,MF(r,i))),i=d}else Zt.SUPPORT_RANGE_BOUNDS||(i=i.splitText(a.length));n+=a.length}),o},MF=function(r,e){var t=e.ownerDocument;if(t){var i=t.createElement("html2canvaswrapper");i.appendChild(e.cloneNode(!0));var s=e.parentNode;if(s){s.replaceChild(i,e);var o=Ia(r,i);return i.firstChild&&s.replaceChild(i.firstChild,i),o}}return As.EMPTY},ap=function(r,e,t){var i=r.ownerDocument;if(!i)throw new Error("Node has no owner document");var s=i.createRange();return s.setStart(r,e),s.setEnd(r,e+t),s},Ec=function(r){if(Zt.SUPPORT_NATIVE_TEXT_SEGMENTATION){var e=new Intl.Segmenter(void 0,{granularity:"grapheme"});return Array.from(e.segment(r)).map(function(t){return t.segment})}return yF(r)},SF=function(r,e){if(Zt.SUPPORT_NATIVE_TEXT_SEGMENTATION){var t=new Intl.Segmenter(void 0,{granularity:"word"});return Array.from(t.segment(r)).map(function(i){return i.segment})}return RF(r,e)},TF=function(r,e){return e.letterSpacing!==0?Ec(r):SF(r,e)},DF=[32,160,4961,65792,65793,4153,4241],RF=function(r,e){for(var t=aC(r,{lineBreak:e.lineBreak,wordBreak:e.overflowWrap==="break-word"?"break-word":e.wordBreak}),i=[],s,o=function(){if(s.value){var n=s.value.slice(),a=Fa(n),A="";a.forEach(function(l){DF.indexOf(l)===-1?A+=Lt(l):(A.length&&i.push(A),i.push(Lt(l)),A="")}),A.length&&i.push(A)}};!(s=t.next()).done;)o();return i},LF=function(){function r(e,t,i){this.text=UF(t.data,i.textTransform),this.textBounds=FF(e,this.text,i,t)}return r}(),UF=function(r,e){switch(e){case 1:return r.toLowerCase();case 3:return r.replace(OF,kF);case 2:return r.toUpperCase();default:return r}},OF=/(^|\s|:|-|\(|\))([a-z])/g,kF=function(r,e,t){return r.length>0?e+t.toUpperCase():r},Ng=function(r){Ti(e,r);function e(t,i){var s=r.call(this,t,i)||this;return s.src=i.currentSrc||i.src,s.intrinsicWidth=i.naturalWidth,s.intrinsicHeight=i.naturalHeight,s.context.cache.addImage(s.src),s}return e}(zi),Qg=function(r){Ti(e,r);function e(t,i){var s=r.call(this,t,i)||this;return s.canvas=i,s.intrinsicWidth=i.width,s.intrinsicHeight=i.height,s}return e}(zi),Hg=function(r){Ti(e,r);function e(t,i){var s=r.call(this,t,i)||this,o=new XMLSerializer,n=Ia(t,i);return i.setAttribute("width",n.width+"px"),i.setAttribute("height",n.height+"px"),s.svg="data:image/svg+xml,"+encodeURIComponent(o.serializeToString(i)),s.intrinsicWidth=i.width.baseVal.value,s.intrinsicHeight=i.height.baseVal.value,s.context.cache.addImage(s.svg),s}return e}(zi),Vg=function(r){Ti(e,r);function e(t,i){var s=r.call(this,t,i)||this;return s.value=i.value,s}return e}(zi),rc=function(r){Ti(e,r);function e(t,i){var s=r.call(this,t,i)||this;return s.start=i.start,s.reversed=typeof i.reversed=="boolean"&&i.reversed===!0,s}return e}(zi),NF=[{type:15,flags:0,unit:"px",number:3}],QF=[{type:16,flags:0,number:50}],HF=function(r){return r.width>r.height?new As(r.left+(r.width-r.height)/2,r.top,r.height,r.height):r.width<r.height?new As(r.left,r.top+(r.height-r.width)/2,r.width,r.width):r},VF=function(r){var e=r.type===GF?new Array(r.value.length+1).join(""):r.value;return e.length===0?r.placeholder||"":e},pa="checkbox",fa="radio",GF="password",Ap=707406591,Ic=function(r){Ti(e,r);function e(t,i){var s=r.call(this,t,i)||this;switch(s.type=i.type.toLowerCase(),s.checked=i.checked,s.value=VF(i),(s.type===pa||s.type===fa)&&(s.styles.backgroundColor=3739148031,s.styles.borderTopColor=s.styles.borderRightColor=s.styles.borderBottomColor=s.styles.borderLeftColor=2779096575,s.styles.borderTopWidth=s.styles.borderRightWidth=s.styles.borderBottomWidth=s.styles.borderLeftWidth=1,s.styles.borderTopStyle=s.styles.borderRightStyle=s.styles.borderBottomStyle=s.styles.borderLeftStyle=1,s.styles.backgroundClip=[0],s.styles.backgroundOrigin=[0],s.bounds=HF(s.bounds)),s.type){case pa:s.styles.borderTopRightRadius=s.styles.borderTopLeftRadius=s.styles.borderBottomRightRadius=s.styles.borderBottomLeftRadius=NF;break;case fa:s.styles.borderTopRightRadius=s.styles.borderTopLeftRadius=s.styles.borderBottomRightRadius=s.styles.borderBottomLeftRadius=QF;break}return s}return e}(zi),Gg=function(r){Ti(e,r);function e(t,i){var s=r.call(this,t,i)||this,o=i.options[i.selectedIndex||0];return s.value=o&&o.text||"",s}return e}(zi),jg=function(r){Ti(e,r);function e(t,i){var s=r.call(this,t,i)||this;return s.value=i.value,s}return e}(zi),zg=function(r){Ti(e,r);function e(t,i){var s=r.call(this,t,i)||this;s.src=i.src,s.width=parseInt(i.width,10)||0,s.height=parseInt(i.height,10)||0,s.backgroundColor=s.styles.backgroundColor;try{if(i.contentWindow&&i.contentWindow.document&&i.contentWindow.document.documentElement){s.tree=Wg(t,i.contentWindow.document.documentElement);var o=i.contentWindow.document.documentElement?wo(t,getComputedStyle(i.contentWindow.document.documentElement).backgroundColor):os.TRANSPARENT,n=i.contentWindow.document.body?wo(t,getComputedStyle(i.contentWindow.document.body).backgroundColor):os.TRANSPARENT;s.backgroundColor=Ps(o)?Ps(n)?s.styles.backgroundColor:n:o}}catch{}return s}return e}(zi),jF=["OL","UL","MENU"],ta=function(r,e,t,i){for(var s=e.firstChild,o=void 0;s;s=o)if(o=s.nextSibling,Xg(s)&&s.data.trim().length>0)t.textNodes.push(new LF(r,s,t.styles));else if(mr(s))if(qg(s)&&s.assignedNodes)s.assignedNodes().forEach(function(a){return ta(r,a,t,i)});else{var n=Kg(r,s);n.styles.isVisible()&&(zF(s,n,i)?n.flags|=4:KF(n.styles)&&(n.flags|=2),jF.indexOf(s.tagName)!==-1&&(n.flags|=8),t.elements.push(n),s.slot,s.shadowRoot?ta(r,s.shadowRoot,n,i):!ga(s)&&!Yg(s)&&!ma(s)&&ta(r,s,n,i))}},Kg=function(r,e){return nc(e)?new Ng(r,e):Jg(e)?new Qg(r,e):Yg(e)?new Hg(r,e):WF(e)?new Vg(r,e):XF(e)?new rc(r,e):YF(e)?new Ic(r,e):ma(e)?new Gg(r,e):ga(e)?new jg(r,e):Zg(e)?new zg(r,e):new zi(r,e)},Wg=function(r,e){var t=Kg(r,e);return t.flags|=4,ta(r,e,t,t),t},zF=function(r,e,t){return e.styles.isPositionedWithZIndex()||e.styles.opacity<1||e.styles.isTransformed()||Fc(r)&&t.styles.isTransparent()},KF=function(r){return r.isPositioned()||r.isFloating()},Xg=function(r){return r.nodeType===Node.TEXT_NODE},mr=function(r){return r.nodeType===Node.ELEMENT_NODE},oc=function(r){return mr(r)&&typeof r.style<"u"&&!ia(r)},ia=function(r){return typeof r.className=="object"},WF=function(r){return r.tagName==="LI"},XF=function(r){return r.tagName==="OL"},YF=function(r){return r.tagName==="INPUT"},JF=function(r){return r.tagName==="HTML"},Yg=function(r){return r.tagName==="svg"},Fc=function(r){return r.tagName==="BODY"},Jg=function(r){return r.tagName==="CANVAS"},lp=function(r){return r.tagName==="VIDEO"},nc=function(r){return r.tagName==="IMG"},Zg=function(r){return r.tagName==="IFRAME"},cp=function(r){return r.tagName==="STYLE"},ZF=function(r){return r.tagName==="SCRIPT"},ga=function(r){return r.tagName==="TEXTAREA"},ma=function(r){return r.tagName==="SELECT"},qg=function(r){return r.tagName==="SLOT"},hp=function(r){return r.tagName.indexOf("-")>0},qF=function(){function r(){this.counters={}}return r.prototype.getCounterValue=function(e){var t=this.counters[e];return t&&t.length?t[t.length-1]:1},r.prototype.getCounterValues=function(e){var t=this.counters[e];return t||[]},r.prototype.pop=function(e){var t=this;e.forEach(function(i){return t.counters[i].pop()})},r.prototype.parse=function(e){var t=this,i=e.counterIncrement,s=e.counterReset,o=!0;i!==null&&i.forEach(function(a){var A=t.counters[a.counter];A&&a.increment!==0&&(o=!1,A.length||A.push(1),A[Math.max(0,A.length-1)]+=a.increment)});var n=[];return o&&s.forEach(function(a){var A=t.counters[a.counter];n.push(a.counter),A||(A=t.counters[a.counter]=[]),A.push(a.reset)}),n},r}(),up={integers:[1e3,900,500,400,100,90,50,40,10,9,5,4,1],values:["M","CM","D","CD","C","XC","L","XL","X","IX","V","IV","I"]},dp={integers:[9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,900,800,700,600,500,400,300,200,100,90,80,70,60,50,40,30,20,10,9,8,7,6,5,4,3,2,1],values:["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""]},$F={integers:[1e4,9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,400,300,200,100,90,80,70,60,50,40,30,20,19,18,17,16,15,10,9,8,7,6,5,4,3,2,1],values:["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""]},e1={integers:[1e4,9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,900,800,700,600,500,400,300,200,100,90,80,70,60,50,40,30,20,10,9,8,7,6,5,4,3,2,1],values:["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""]},or=function(r,e,t,i,s,o){return r<e||r>t?Uo(r,s,o.length>0):i.integers.reduce(function(n,a,A){for(;r>=a;)r-=a,n+=i.values[A];return n},"")+o},$g=function(r,e,t,i){var s="";do t||r--,s=i(r)+s,r/=e;while(r*e>=e);return s},Rt=function(r,e,t,i,s){var o=t-e+1;return(r<0?"-":"")+($g(Math.abs(r),o,i,function(n){return Lt(Math.floor(n%o)+e)})+s)},Fs=function(r,e,t){t===void 0&&(t=". ");var i=e.length;return $g(Math.abs(r),i,!1,function(s){return e[Math.floor(s%i)]})+t},dr=1,cs=2,hs=4,vo=8,es=function(r,e,t,i,s,o){if(r<-9999||r>9999)return Uo(r,4,s.length>0);var n=Math.abs(r),a=s;if(n===0)return e[0]+a;for(var A=0;n>0&&A<=4;A++){var l=n%10;l===0&&Vt(o,dr)&&a!==""?a=e[l]+a:l>1||l===1&&A===0||l===1&&A===1&&Vt(o,cs)||l===1&&A===1&&Vt(o,hs)&&r>100||l===1&&A>1&&Vt(o,vo)?a=e[l]+(A>0?t[A-1]:"")+a:l===1&&A>0&&(a=t[A-1]+a),n=Math.floor(n/10)}return(r<0?i:"")+a},pp="",fp="",gp="",rl="",Uo=function(r,e,t){var i=t?". ":"",s=t?"":"",o=t?", ":"",n=t?" ":"";switch(e){case 0:return""+n;case 1:return""+n;case 2:return""+n;case 5:var a=Rt(r,48,57,!0,i);return a.length<4?"0"+a:a;case 4:return Fs(r,"",s);case 6:return or(r,1,3999,up,3,i).toLowerCase();case 7:return or(r,1,3999,up,3,i);case 8:return Rt(r,945,969,!1,i);case 9:return Rt(r,97,122,!1,i);case 10:return Rt(r,65,90,!1,i);case 11:return Rt(r,1632,1641,!0,i);case 12:case 49:return or(r,1,9999,dp,3,i);case 35:return or(r,1,9999,dp,3,i).toLowerCase();case 13:return Rt(r,2534,2543,!0,i);case 14:case 30:return Rt(r,6112,6121,!0,i);case 15:return Fs(r,"",s);case 16:return Fs(r,"",s);case 17:case 48:return es(r,"",pp,"",s,cs|hs|vo);case 47:return es(r,"",fp,"",s,dr|cs|hs|vo);case 42:return es(r,"",pp,"",s,cs|hs|vo);case 41:return es(r,"",fp,"",s,dr|cs|hs|vo);case 26:return es(r,"","",gp,s,0);case 25:return es(r,"","",gp,s,dr|cs|hs);case 31:return es(r,"","",rl,o,dr|cs|hs);case 33:return es(r,"","",rl,o,0);case 32:return es(r,"","",rl,o,dr|cs|hs);case 18:return Rt(r,2406,2415,!0,i);case 20:return or(r,1,19999,e1,3,i);case 21:return Rt(r,2790,2799,!0,i);case 22:return Rt(r,2662,2671,!0,i);case 22:return or(r,1,10999,$F,3,i);case 23:return Fs(r,"");case 24:return Fs(r,"");case 27:return Rt(r,3302,3311,!0,i);case 28:return Fs(r,"",s);case 29:return Fs(r,"",s);case 34:return Rt(r,3792,3801,!0,i);case 37:return Rt(r,6160,6169,!0,i);case 38:return Rt(r,4160,4169,!0,i);case 39:return Rt(r,2918,2927,!0,i);case 40:return Rt(r,1776,1785,!0,i);case 43:return Rt(r,3046,3055,!0,i);case 44:return Rt(r,3174,3183,!0,i);case 45:return Rt(r,3664,3673,!0,i);case 46:return Rt(r,3872,3881,!0,i);case 3:default:return Rt(r,48,57,!0,i)}},em="data-html2canvas-ignore",mp=function(){function r(e,t,i){if(this.context=e,this.options=i,this.scrolledElements=[],this.referenceElement=t,this.counters=new qF,this.quoteDepth=0,!t.ownerDocument)throw new Error("Cloned element does not have an owner document");this.documentElement=this.cloneNode(t.ownerDocument.documentElement,!1)}return r.prototype.toIFrame=function(e,t){var i=this,s=t1(e,t);if(!s.contentWindow)return Promise.reject("Unable to find iframe window");var o=e.defaultView.pageXOffset,n=e.defaultView.pageYOffset,a=s.contentWindow,A=a.document,l=r1(s).then(function(){return ai(i,void 0,void 0,function(){var h,d;return ei(this,function(f){switch(f.label){case 0:return this.scrolledElements.forEach(A1),a&&(a.scrollTo(t.left,t.top),/(iPad|iPhone|iPod)/g.test(navigator.userAgent)&&(a.scrollY!==t.top||a.scrollX!==t.left)&&(this.context.logger.warn("Unable to restore scroll position for cloned document"),this.context.windowBounds=this.context.windowBounds.add(a.scrollX-t.left,a.scrollY-t.top,0,0))),h=this.options.onclone,d=this.clonedReferenceElement,typeof d>"u"?[2,Promise.reject("Error finding the "+this.referenceElement.nodeName+" in the cloned document")]:A.fonts&&A.fonts.ready?[4,A.fonts.ready]:[3,2];case 1:f.sent(),f.label=2;case 2:return/(AppleWebKit)/g.test(navigator.userAgent)?[4,s1(A)]:[3,4];case 3:f.sent(),f.label=4;case 4:return typeof h=="function"?[2,Promise.resolve().then(function(){return h(A,d)}).then(function(){return s})]:[2,s]}})})});return A.open(),A.write(n1(document.doctype)+"<html></html>"),a1(this.referenceElement.ownerDocument,o,n),A.replaceChild(A.adoptNode(this.documentElement),A.documentElement),A.close(),l},r.prototype.createElementClone=function(e){if(ic(e,2))debugger;if(Jg(e))return this.createCanvasClone(e);if(lp(e))return this.createVideoClone(e);if(cp(e))return this.createStyleClone(e);var t=e.cloneNode(!1);return nc(t)&&(nc(e)&&e.currentSrc&&e.currentSrc!==e.src&&(t.src=e.currentSrc,t.srcset=""),t.loading==="lazy"&&(t.loading="eager")),hp(t)?this.createCustomElementClone(t):t},r.prototype.createCustomElementClone=function(e){var t=document.createElement("html2canvascustomelement");return ol(e.style,t),t},r.prototype.createStyleClone=function(e){try{var t=e.sheet;if(t&&t.cssRules){var i=[].slice.call(t.cssRules,0).reduce(function(o,n){return n&&typeof n.cssText=="string"?o+n.cssText:o},""),s=e.cloneNode(!1);return s.textContent=i,s}}catch(o){if(this.context.logger.error("Unable to access cssRules property",o),o.name!=="SecurityError")throw o}return e.cloneNode(!1)},r.prototype.createCanvasClone=function(e){var t;if(this.options.inlineImages&&e.ownerDocument){var i=e.ownerDocument.createElement("img");try{return i.src=e.toDataURL(),i}catch{this.context.logger.info("Unable to inline canvas contents, canvas is tainted",e)}}var s=e.cloneNode(!1);try{s.width=e.width,s.height=e.height;var o=e.getContext("2d"),n=s.getContext("2d");if(n)if(!this.options.allowTaint&&o)n.putImageData(o.getImageData(0,0,e.width,e.height),0,0);else{var a=(t=e.getContext("webgl2"))!==null&&t!==void 0?t:e.getContext("webgl");if(a){var A=a.getContextAttributes();(A==null?void 0:A.preserveDrawingBuffer)===!1&&this.context.logger.warn("Unable to clone WebGL context as it has preserveDrawingBuffer=false",e)}n.drawImage(e,0,0)}return s}catch{this.context.logger.info("Unable to clone canvas as it is tainted",e)}return s},r.prototype.createVideoClone=function(e){var t=e.ownerDocument.createElement("canvas");t.width=e.offsetWidth,t.height=e.offsetHeight;var i=t.getContext("2d");try{return i&&(i.drawImage(e,0,0,t.width,t.height),this.options.allowTaint||i.getImageData(0,0,t.width,t.height)),t}catch{this.context.logger.info("Unable to clone video as it is tainted",e)}var s=e.ownerDocument.createElement("canvas");return s.width=e.offsetWidth,s.height=e.offsetHeight,s},r.prototype.appendChildNode=function(e,t,i){(!mr(t)||!ZF(t)&&!t.hasAttribute(em)&&(typeof this.options.ignoreElements!="function"||!this.options.ignoreElements(t)))&&(!this.options.copyStyles||!mr(t)||!cp(t))&&e.appendChild(this.cloneNode(t,i))},r.prototype.cloneChildNodes=function(e,t,i){for(var s=this,o=e.shadowRoot?e.shadowRoot.firstChild:e.firstChild;o;o=o.nextSibling)if(mr(o)&&qg(o)&&typeof o.assignedNodes=="function"){var n=o.assignedNodes();n.length&&n.forEach(function(a){return s.appendChildNode(t,a,i)})}else this.appendChildNode(t,o,i)},r.prototype.cloneNode=function(e,t){if(Xg(e))return document.createTextNode(e.data);if(!e.ownerDocument)return e.cloneNode(!1);var i=e.ownerDocument.defaultView;if(i&&mr(e)&&(oc(e)||ia(e))){var s=this.createElementClone(e);s.style.transitionProperty="none";var o=i.getComputedStyle(e),n=i.getComputedStyle(e,":before"),a=i.getComputedStyle(e,":after");this.referenceElement===e&&oc(s)&&(this.clonedReferenceElement=s),Fc(s)&&h1(s);var A=this.counters.parse(new Xd(this.context,o)),l=this.resolvePseudoContent(e,s,n,Eo.BEFORE);hp(e)&&(t=!0),lp(e)||this.cloneChildNodes(e,s,t),l&&s.insertBefore(l,s.firstChild);var h=this.resolvePseudoContent(e,s,a,Eo.AFTER);return h&&s.appendChild(h),this.counters.pop(A),(o&&(this.options.copyStyles||ia(e))&&!Zg(e)||t)&&ol(o,s),(e.scrollTop!==0||e.scrollLeft!==0)&&this.scrolledElements.push([s,e.scrollLeft,e.scrollTop]),(ga(e)||ma(e))&&(ga(s)||ma(s))&&(s.value=e.value),s}return e.cloneNode(!1)},r.prototype.resolvePseudoContent=function(e,t,i,s){var o=this;if(i){var n=i.content,a=t.ownerDocument;if(!(!a||!n||n==="none"||n==="-moz-alt-content"||i.display==="none")){this.counters.parse(new Xd(this.context,i));var A=new WI(this.context,i),l=a.createElement("html2canvaspseudoelement");ol(i,l),A.content.forEach(function(d){if(d.type===0)l.appendChild(a.createTextNode(d.value));else if(d.type===22){var f=a.createElement("img");f.src=d.value,f.style.opacity="1",l.appendChild(f)}else if(d.type===18){if(d.name==="attr"){var m=d.values.filter(Pt);m.length&&l.appendChild(a.createTextNode(e.getAttribute(m[0].value)||""))}else if(d.name==="counter"){var _=d.values.filter(Ir),u=_[0],B=_[1];if(u&&Pt(u)){var y=o.counters.getCounterValue(u.value),x=B&&Pt(B)?tc.parse(o.context,B.value):3;l.appendChild(a.createTextNode(Uo(y,x,!1)))}}else if(d.name==="counters"){var P=d.values.filter(Ir),u=P[0],v=P[1],B=P[2];if(u&&Pt(u)){var b=o.counters.getCounterValues(u.value),C=B&&Pt(B)?tc.parse(o.context,B.value):3,I=v&&v.type===0?v.value:"",E=b.map(function(D){return Uo(D,C,!1)}).join(I);l.appendChild(a.createTextNode(E))}}}else if(d.type===20)switch(d.value){case"open-quote":l.appendChild(a.createTextNode(Wd(A.quotes,o.quoteDepth++,!0)));break;case"close-quote":l.appendChild(a.createTextNode(Wd(A.quotes,--o.quoteDepth,!1)));break;default:l.appendChild(a.createTextNode(d.value))}}),l.className=ac+" "+Ac;var h=s===Eo.BEFORE?" "+ac:" "+Ac;return ia(t)?t.className.baseValue+=h:t.className+=h,l}}},r.destroy=function(e){return e.parentNode?(e.parentNode.removeChild(e),!0):!1},r}(),Eo;(function(r){r[r.BEFORE=0]="BEFORE",r[r.AFTER=1]="AFTER"})(Eo||(Eo={}));var t1=function(r,e){var t=r.createElement("iframe");return t.className="html2canvas-container",t.style.visibility="hidden",t.style.position="fixed",t.style.left="-10000px",t.style.top="0px",t.style.border="0",t.width=e.width.toString(),t.height=e.height.toString(),t.scrolling="no",t.setAttribute(em,"true"),r.body.appendChild(t),t},i1=function(r){return new Promise(function(e){if(r.complete){e();return}if(!r.src){e();return}r.onload=e,r.onerror=e})},s1=function(r){return Promise.all([].slice.call(r.images,0).map(i1))},r1=function(r){return new Promise(function(e,t){var i=r.contentWindow;if(!i)return t("No window assigned for iframe");var s=i.document;i.onload=r.onload=function(){i.onload=r.onload=null;var o=setInterval(function(){s.body.childNodes.length>0&&s.readyState==="complete"&&(clearInterval(o),e(r))},50)}})},o1=["all","d","content"],ol=function(r,e){for(var t=r.length-1;t>=0;t--){var i=r.item(t);o1.indexOf(i)===-1&&e.style.setProperty(i,r.getPropertyValue(i))}return e},n1=function(r){var e="";return r&&(e+="<!DOCTYPE ",r.name&&(e+=r.name),r.internalSubset&&(e+=r.internalSubset),r.publicId&&(e+='"'+r.publicId+'"'),r.systemId&&(e+='"'+r.systemId+'"'),e+=">"),e},a1=function(r,e,t){r&&r.defaultView&&(e!==r.defaultView.pageXOffset||t!==r.defaultView.pageYOffset)&&r.defaultView.scrollTo(e,t)},A1=function(r){var e=r[0],t=r[1],i=r[2];e.scrollLeft=t,e.scrollTop=i},l1=":before",c1=":after",ac="___html2canvas___pseudoelement_before",Ac="___html2canvas___pseudoelement_after",_p=`{
    content: "" !important;
    display: none !important;
}`,h1=function(r){u1(r,"."+ac+l1+_p+`
         .`+Ac+c1+_p)},u1=function(r,e){var t=r.ownerDocument;if(t){var i=t.createElement("style");i.textContent=e,r.appendChild(i)}},tm=function(){function r(){}return r.getOrigin=function(e){var t=r._link;return t?(t.href=e,t.href=t.href,t.protocol+t.hostname+t.port):"about:blank"},r.isSameOrigin=function(e){return r.getOrigin(e)===r._origin},r.setContext=function(e){r._link=e.document.createElement("a"),r._origin=r.getOrigin(e.location.href)},r._origin="about:blank",r}(),d1=function(){function r(e,t){this.context=e,this._options=t,this._cache={}}return r.prototype.addImage=function(e){var t=Promise.resolve();return this.has(e)||(al(e)||m1(e))&&(this._cache[e]=this.loadImage(e)).catch(function(){}),t},r.prototype.match=function(e){return this._cache[e]},r.prototype.loadImage=function(e){return ai(this,void 0,void 0,function(){var t,i,s,o,n=this;return ei(this,function(a){switch(a.label){case 0:return t=tm.isSameOrigin(e),i=!nl(e)&&this._options.useCORS===!0&&Zt.SUPPORT_CORS_IMAGES&&!t,s=!nl(e)&&!t&&!al(e)&&typeof this._options.proxy=="string"&&Zt.SUPPORT_CORS_XHR&&!i,!t&&this._options.allowTaint===!1&&!nl(e)&&!al(e)&&!s&&!i?[2]:(o=e,s?[4,this.proxy(o)]:[3,2]);case 1:o=a.sent(),a.label=2;case 2:return this.context.logger.debug("Added image "+e.substring(0,256)),[4,new Promise(function(A,l){var h=new Image;h.onload=function(){return A(h)},h.onerror=l,(_1(o)||i)&&(h.crossOrigin="anonymous"),h.src=o,h.complete===!0&&setTimeout(function(){return A(h)},500),n._options.imageTimeout>0&&setTimeout(function(){return l("Timed out ("+n._options.imageTimeout+"ms) loading image")},n._options.imageTimeout)})];case 3:return[2,a.sent()]}})})},r.prototype.has=function(e){return typeof this._cache[e]<"u"},r.prototype.keys=function(){return Promise.resolve(Object.keys(this._cache))},r.prototype.proxy=function(e){var t=this,i=this._options.proxy;if(!i)throw new Error("No proxy defined");var s=e.substring(0,256);return new Promise(function(o,n){var a=Zt.SUPPORT_RESPONSE_TYPE?"blob":"text",A=new XMLHttpRequest;A.onload=function(){if(A.status===200)if(a==="text")o(A.response);else{var d=new FileReader;d.addEventListener("load",function(){return o(d.result)},!1),d.addEventListener("error",function(f){return n(f)},!1),d.readAsDataURL(A.response)}else n("Failed to proxy resource "+s+" with status code "+A.status)},A.onerror=n;var l=i.indexOf("?")>-1?"&":"?";if(A.open("GET",""+i+l+"url="+encodeURIComponent(e)+"&responseType="+a),a!=="text"&&A instanceof XMLHttpRequest&&(A.responseType=a),t._options.imageTimeout){var h=t._options.imageTimeout;A.timeout=h,A.ontimeout=function(){return n("Timed out ("+h+"ms) proxying "+s)}}A.send()})},r}(),p1=/^data:image\/svg\+xml/i,f1=/^data:image\/.*;base64,/i,g1=/^data:image\/.*/i,m1=function(r){return Zt.SUPPORT_SVG_DRAWING||!v1(r)},nl=function(r){return g1.test(r)},_1=function(r){return f1.test(r)},al=function(r){return r.substr(0,4)==="blob"},v1=function(r){return r.substr(-3).toLowerCase()==="svg"||p1.test(r)},Le=function(){function r(e,t){this.type=0,this.x=e,this.y=t}return r.prototype.add=function(e,t){return new r(this.x+e,this.y+t)},r}(),nr=function(r,e,t){return new Le(r.x+(e.x-r.x)*t,r.y+(e.y-r.y)*t)},Gn=function(){function r(e,t,i,s){this.type=1,this.start=e,this.startControl=t,this.endControl=i,this.end=s}return r.prototype.subdivide=function(e,t){var i=nr(this.start,this.startControl,e),s=nr(this.startControl,this.endControl,e),o=nr(this.endControl,this.end,e),n=nr(i,s,e),a=nr(s,o,e),A=nr(n,a,e);return t?new r(this.start,i,n,A):new r(A,a,o,this.end)},r.prototype.add=function(e,t){return new r(this.start.add(e,t),this.startControl.add(e,t),this.endControl.add(e,t),this.end.add(e,t))},r.prototype.reverse=function(){return new r(this.end,this.endControl,this.startControl,this.start)},r}(),wi=function(r){return r.type===1},B1=function(){function r(e){var t=e.styles,i=e.bounds,s=mo(t.borderTopLeftRadius,i.width,i.height),o=s[0],n=s[1],a=mo(t.borderTopRightRadius,i.width,i.height),A=a[0],l=a[1],h=mo(t.borderBottomRightRadius,i.width,i.height),d=h[0],f=h[1],m=mo(t.borderBottomLeftRadius,i.width,i.height),_=m[0],u=m[1],B=[];B.push((o+A)/i.width),B.push((_+d)/i.width),B.push((n+u)/i.height),B.push((l+f)/i.height);var y=Math.max.apply(Math,B);y>1&&(o/=y,n/=y,A/=y,l/=y,d/=y,f/=y,_/=y,u/=y);var x=i.width-A,P=i.height-f,v=i.width-d,b=i.height-u,C=t.borderTopWidth,I=t.borderRightWidth,E=t.borderBottomWidth,S=t.borderLeftWidth,R=xt(t.paddingTop,e.bounds.width),D=xt(t.paddingRight,e.bounds.width),K=xt(t.paddingBottom,e.bounds.width),j=xt(t.paddingLeft,e.bounds.width);this.topLeftBorderDoubleOuterBox=o>0||n>0?Ct(i.left+S/3,i.top+C/3,o-S/3,n-C/3,mt.TOP_LEFT):new Le(i.left+S/3,i.top+C/3),this.topRightBorderDoubleOuterBox=o>0||n>0?Ct(i.left+x,i.top+C/3,A-I/3,l-C/3,mt.TOP_RIGHT):new Le(i.left+i.width-I/3,i.top+C/3),this.bottomRightBorderDoubleOuterBox=d>0||f>0?Ct(i.left+v,i.top+P,d-I/3,f-E/3,mt.BOTTOM_RIGHT):new Le(i.left+i.width-I/3,i.top+i.height-E/3),this.bottomLeftBorderDoubleOuterBox=_>0||u>0?Ct(i.left+S/3,i.top+b,_-S/3,u-E/3,mt.BOTTOM_LEFT):new Le(i.left+S/3,i.top+i.height-E/3),this.topLeftBorderDoubleInnerBox=o>0||n>0?Ct(i.left+S*2/3,i.top+C*2/3,o-S*2/3,n-C*2/3,mt.TOP_LEFT):new Le(i.left+S*2/3,i.top+C*2/3),this.topRightBorderDoubleInnerBox=o>0||n>0?Ct(i.left+x,i.top+C*2/3,A-I*2/3,l-C*2/3,mt.TOP_RIGHT):new Le(i.left+i.width-I*2/3,i.top+C*2/3),this.bottomRightBorderDoubleInnerBox=d>0||f>0?Ct(i.left+v,i.top+P,d-I*2/3,f-E*2/3,mt.BOTTOM_RIGHT):new Le(i.left+i.width-I*2/3,i.top+i.height-E*2/3),this.bottomLeftBorderDoubleInnerBox=_>0||u>0?Ct(i.left+S*2/3,i.top+b,_-S*2/3,u-E*2/3,mt.BOTTOM_LEFT):new Le(i.left+S*2/3,i.top+i.height-E*2/3),this.topLeftBorderStroke=o>0||n>0?Ct(i.left+S/2,i.top+C/2,o-S/2,n-C/2,mt.TOP_LEFT):new Le(i.left+S/2,i.top+C/2),this.topRightBorderStroke=o>0||n>0?Ct(i.left+x,i.top+C/2,A-I/2,l-C/2,mt.TOP_RIGHT):new Le(i.left+i.width-I/2,i.top+C/2),this.bottomRightBorderStroke=d>0||f>0?Ct(i.left+v,i.top+P,d-I/2,f-E/2,mt.BOTTOM_RIGHT):new Le(i.left+i.width-I/2,i.top+i.height-E/2),this.bottomLeftBorderStroke=_>0||u>0?Ct(i.left+S/2,i.top+b,_-S/2,u-E/2,mt.BOTTOM_LEFT):new Le(i.left+S/2,i.top+i.height-E/2),this.topLeftBorderBox=o>0||n>0?Ct(i.left,i.top,o,n,mt.TOP_LEFT):new Le(i.left,i.top),this.topRightBorderBox=A>0||l>0?Ct(i.left+x,i.top,A,l,mt.TOP_RIGHT):new Le(i.left+i.width,i.top),this.bottomRightBorderBox=d>0||f>0?Ct(i.left+v,i.top+P,d,f,mt.BOTTOM_RIGHT):new Le(i.left+i.width,i.top+i.height),this.bottomLeftBorderBox=_>0||u>0?Ct(i.left,i.top+b,_,u,mt.BOTTOM_LEFT):new Le(i.left,i.top+i.height),this.topLeftPaddingBox=o>0||n>0?Ct(i.left+S,i.top+C,Math.max(0,o-S),Math.max(0,n-C),mt.TOP_LEFT):new Le(i.left+S,i.top+C),this.topRightPaddingBox=A>0||l>0?Ct(i.left+Math.min(x,i.width-I),i.top+C,x>i.width+I?0:Math.max(0,A-I),Math.max(0,l-C),mt.TOP_RIGHT):new Le(i.left+i.width-I,i.top+C),this.bottomRightPaddingBox=d>0||f>0?Ct(i.left+Math.min(v,i.width-S),i.top+Math.min(P,i.height-E),Math.max(0,d-I),Math.max(0,f-E),mt.BOTTOM_RIGHT):new Le(i.left+i.width-I,i.top+i.height-E),this.bottomLeftPaddingBox=_>0||u>0?Ct(i.left+S,i.top+Math.min(b,i.height-E),Math.max(0,_-S),Math.max(0,u-E),mt.BOTTOM_LEFT):new Le(i.left+S,i.top+i.height-E),this.topLeftContentBox=o>0||n>0?Ct(i.left+S+j,i.top+C+R,Math.max(0,o-(S+j)),Math.max(0,n-(C+R)),mt.TOP_LEFT):new Le(i.left+S+j,i.top+C+R),this.topRightContentBox=A>0||l>0?Ct(i.left+Math.min(x,i.width+S+j),i.top+C+R,x>i.width+S+j?0:A-S+j,l-(C+R),mt.TOP_RIGHT):new Le(i.left+i.width-(I+D),i.top+C+R),this.bottomRightContentBox=d>0||f>0?Ct(i.left+Math.min(v,i.width-(S+j)),i.top+Math.min(P,i.height+C+R),Math.max(0,d-(I+D)),f-(E+K),mt.BOTTOM_RIGHT):new Le(i.left+i.width-(I+D),i.top+i.height-(E+K)),this.bottomLeftContentBox=_>0||u>0?Ct(i.left+S+j,i.top+b,Math.max(0,_-(S+j)),u-(E+K),mt.BOTTOM_LEFT):new Le(i.left+S+j,i.top+i.height-(E+K))}return r}(),mt;(function(r){r[r.TOP_LEFT=0]="TOP_LEFT",r[r.TOP_RIGHT=1]="TOP_RIGHT",r[r.BOTTOM_RIGHT=2]="BOTTOM_RIGHT",r[r.BOTTOM_LEFT=3]="BOTTOM_LEFT"})(mt||(mt={}));var Ct=function(r,e,t,i,s){var o=4*((Math.sqrt(2)-1)/3),n=t*o,a=i*o,A=r+t,l=e+i;switch(s){case mt.TOP_LEFT:return new Gn(new Le(r,l),new Le(r,l-a),new Le(A-n,e),new Le(A,e));case mt.TOP_RIGHT:return new Gn(new Le(r,e),new Le(r+n,e),new Le(A,l-a),new Le(A,l));case mt.BOTTOM_RIGHT:return new Gn(new Le(A,e),new Le(A,e+a),new Le(r+n,l),new Le(r,l));case mt.BOTTOM_LEFT:default:return new Gn(new Le(A,l),new Le(A-n,l),new Le(r,e+a),new Le(r,e))}},_a=function(r){return[r.topLeftBorderBox,r.topRightBorderBox,r.bottomRightBorderBox,r.bottomLeftBorderBox]},P1=function(r){return[r.topLeftContentBox,r.topRightContentBox,r.bottomRightContentBox,r.bottomLeftContentBox]},va=function(r){return[r.topLeftPaddingBox,r.topRightPaddingBox,r.bottomRightPaddingBox,r.bottomLeftPaddingBox]},y1=function(){function r(e,t,i){this.offsetX=e,this.offsetY=t,this.matrix=i,this.type=0,this.target=6}return r}(),jn=function(){function r(e,t){this.path=e,this.target=t,this.type=1}return r}(),x1=function(){function r(e){this.opacity=e,this.type=2,this.target=6}return r}(),w1=function(r){return r.type===0},im=function(r){return r.type===1},b1=function(r){return r.type===2},vp=function(r,e){return r.length===e.length?r.some(function(t,i){return t===e[i]}):!1},C1=function(r,e,t,i,s){return r.map(function(o,n){switch(n){case 0:return o.add(e,t);case 1:return o.add(e+i,t);case 2:return o.add(e+i,t+s);case 3:return o.add(e,t+s)}return o})},sm=function(){function r(e){this.element=e,this.inlineLevel=[],this.nonInlineLevel=[],this.negativeZIndex=[],this.zeroOrAutoZIndexOrTransformedOrOpacity=[],this.positiveZIndex=[],this.nonPositionedFloats=[],this.nonPositionedInlineLevel=[]}return r}(),rm=function(){function r(e,t){if(this.container=e,this.parent=t,this.effects=[],this.curves=new B1(this.container),this.container.styles.opacity<1&&this.effects.push(new x1(this.container.styles.opacity)),this.container.styles.transform!==null){var i=this.container.bounds.left+this.container.styles.transformOrigin[0].number,s=this.container.bounds.top+this.container.styles.transformOrigin[1].number,o=this.container.styles.transform;this.effects.push(new y1(i,s,o))}if(this.container.styles.overflowX!==0){var n=_a(this.curves),a=va(this.curves);vp(n,a)?this.effects.push(new jn(n,6)):(this.effects.push(new jn(n,2)),this.effects.push(new jn(a,4)))}}return r.prototype.getEffects=function(e){for(var t=[2,3].indexOf(this.container.styles.position)===-1,i=this.parent,s=this.effects.slice(0);i;){var o=i.effects.filter(function(A){return!im(A)});if(t||i.container.styles.position!==0||!i.parent){if(s.unshift.apply(s,o),t=[2,3].indexOf(i.container.styles.position)===-1,i.container.styles.overflowX!==0){var n=_a(i.curves),a=va(i.curves);vp(n,a)||s.unshift(new jn(a,6))}}else s.unshift.apply(s,o);i=i.parent}return s.filter(function(A){return Vt(A.target,e)})},r}(),lc=function(r,e,t,i){r.container.elements.forEach(function(s){var o=Vt(s.flags,4),n=Vt(s.flags,2),a=new rm(s,r);Vt(s.styles.display,2048)&&i.push(a);var A=Vt(s.flags,8)?[]:i;if(o||n){var l=o||s.styles.isPositioned()?t:e,h=new sm(a);if(s.styles.isPositioned()||s.styles.opacity<1||s.styles.isTransformed()){var d=s.styles.zIndex.order;if(d<0){var f=0;l.negativeZIndex.some(function(_,u){return d>_.element.container.styles.zIndex.order?(f=u,!1):f>0}),l.negativeZIndex.splice(f,0,h)}else if(d>0){var m=0;l.positiveZIndex.some(function(_,u){return d>=_.element.container.styles.zIndex.order?(m=u+1,!1):m>0}),l.positiveZIndex.splice(m,0,h)}else l.zeroOrAutoZIndexOrTransformedOrOpacity.push(h)}else s.styles.isFloating()?l.nonPositionedFloats.push(h):l.nonPositionedInlineLevel.push(h);lc(a,h,o?h:t,A)}else s.styles.isInlineLevel()?e.inlineLevel.push(a):e.nonInlineLevel.push(a),lc(a,e,t,A);Vt(s.flags,8)&&om(s,A)})},om=function(r,e){for(var t=r instanceof rc?r.start:1,i=r instanceof rc?r.reversed:!1,s=0;s<e.length;s++){var o=e[s];o.container instanceof Vg&&typeof o.container.value=="number"&&o.container.value!==0&&(t=o.container.value),o.listValue=Uo(t,o.container.styles.listStyleType,!0),t+=i?-1:1}},E1=function(r){var e=new rm(r,null),t=new sm(e),i=[];return lc(e,t,t,i),om(e.container,i),t},Bp=function(r,e){switch(e){case 0:return Ci(r.topLeftBorderBox,r.topLeftPaddingBox,r.topRightBorderBox,r.topRightPaddingBox);case 1:return Ci(r.topRightBorderBox,r.topRightPaddingBox,r.bottomRightBorderBox,r.bottomRightPaddingBox);case 2:return Ci(r.bottomRightBorderBox,r.bottomRightPaddingBox,r.bottomLeftBorderBox,r.bottomLeftPaddingBox);case 3:default:return Ci(r.bottomLeftBorderBox,r.bottomLeftPaddingBox,r.topLeftBorderBox,r.topLeftPaddingBox)}},I1=function(r,e){switch(e){case 0:return Ci(r.topLeftBorderBox,r.topLeftBorderDoubleOuterBox,r.topRightBorderBox,r.topRightBorderDoubleOuterBox);case 1:return Ci(r.topRightBorderBox,r.topRightBorderDoubleOuterBox,r.bottomRightBorderBox,r.bottomRightBorderDoubleOuterBox);case 2:return Ci(r.bottomRightBorderBox,r.bottomRightBorderDoubleOuterBox,r.bottomLeftBorderBox,r.bottomLeftBorderDoubleOuterBox);case 3:default:return Ci(r.bottomLeftBorderBox,r.bottomLeftBorderDoubleOuterBox,r.topLeftBorderBox,r.topLeftBorderDoubleOuterBox)}},F1=function(r,e){switch(e){case 0:return Ci(r.topLeftBorderDoubleInnerBox,r.topLeftPaddingBox,r.topRightBorderDoubleInnerBox,r.topRightPaddingBox);case 1:return Ci(r.topRightBorderDoubleInnerBox,r.topRightPaddingBox,r.bottomRightBorderDoubleInnerBox,r.bottomRightPaddingBox);case 2:return Ci(r.bottomRightBorderDoubleInnerBox,r.bottomRightPaddingBox,r.bottomLeftBorderDoubleInnerBox,r.bottomLeftPaddingBox);case 3:default:return Ci(r.bottomLeftBorderDoubleInnerBox,r.bottomLeftPaddingBox,r.topLeftBorderDoubleInnerBox,r.topLeftPaddingBox)}},M1=function(r,e){switch(e){case 0:return zn(r.topLeftBorderStroke,r.topRightBorderStroke);case 1:return zn(r.topRightBorderStroke,r.bottomRightBorderStroke);case 2:return zn(r.bottomRightBorderStroke,r.bottomLeftBorderStroke);case 3:default:return zn(r.bottomLeftBorderStroke,r.topLeftBorderStroke)}},zn=function(r,e){var t=[];return wi(r)?t.push(r.subdivide(.5,!1)):t.push(r),wi(e)?t.push(e.subdivide(.5,!0)):t.push(e),t},Ci=function(r,e,t,i){var s=[];return wi(r)?s.push(r.subdivide(.5,!1)):s.push(r),wi(t)?s.push(t.subdivide(.5,!0)):s.push(t),wi(i)?s.push(i.subdivide(.5,!0).reverse()):s.push(i),wi(e)?s.push(e.subdivide(.5,!1).reverse()):s.push(e),s},nm=function(r){var e=r.bounds,t=r.styles;return e.add(t.borderLeftWidth,t.borderTopWidth,-(t.borderRightWidth+t.borderLeftWidth),-(t.borderTopWidth+t.borderBottomWidth))},Ba=function(r){var e=r.styles,t=r.bounds,i=xt(e.paddingLeft,t.width),s=xt(e.paddingRight,t.width),o=xt(e.paddingTop,t.width),n=xt(e.paddingBottom,t.width);return t.add(i+e.borderLeftWidth,o+e.borderTopWidth,-(e.borderRightWidth+e.borderLeftWidth+i+s),-(e.borderTopWidth+e.borderBottomWidth+o+n))},S1=function(r,e){return r===0?e.bounds:r===2?Ba(e):nm(e)},T1=function(r,e){return r===0?e.bounds:r===2?Ba(e):nm(e)},Al=function(r,e,t){var i=S1(pr(r.styles.backgroundOrigin,e),r),s=T1(pr(r.styles.backgroundClip,e),r),o=D1(pr(r.styles.backgroundSize,e),t,i),n=o[0],a=o[1],A=mo(pr(r.styles.backgroundPosition,e),i.width-n,i.height-a),l=R1(pr(r.styles.backgroundRepeat,e),A,o,i,s),h=Math.round(i.left+A[0]),d=Math.round(i.top+A[1]);return[l,h,d,n,a]},ar=function(r){return Pt(r)&&r.value===br.AUTO},Kn=function(r){return typeof r=="number"},D1=function(r,e,t){var i=e[0],s=e[1],o=e[2],n=r[0],a=r[1];if(!n)return[0,0];if(Nt(n)&&a&&Nt(a))return[xt(n,t.width),xt(a,t.height)];var A=Kn(o);if(Pt(n)&&(n.value===br.CONTAIN||n.value===br.COVER)){if(Kn(o)){var l=t.width/t.height;return l<o!=(n.value===br.COVER)?[t.width,t.width/o]:[t.height*o,t.height]}return[t.width,t.height]}var h=Kn(i),d=Kn(s),f=h||d;if(ar(n)&&(!a||ar(a))){if(h&&d)return[i,s];if(!A&&!f)return[t.width,t.height];if(f&&A){var m=h?i:s*o,_=d?s:i/o;return[m,_]}var u=h?i:t.width,B=d?s:t.height;return[u,B]}if(A){var y=0,x=0;return Nt(n)?y=xt(n,t.width):Nt(a)&&(x=xt(a,t.height)),ar(n)?y=x*o:(!a||ar(a))&&(x=y/o),[y,x]}var P=null,v=null;if(Nt(n)?P=xt(n,t.width):a&&Nt(a)&&(v=xt(a,t.height)),P!==null&&(!a||ar(a))&&(v=h&&d?P/i*s:t.height),v!==null&&ar(n)&&(P=h&&d?v/s*i:t.width),P!==null&&v!==null)return[P,v];throw new Error("Unable to calculate background-size for element")},pr=function(r,e){var t=r[e];return typeof t>"u"?r[0]:t},R1=function(r,e,t,i,s){var o=e[0],n=e[1],a=t[0],A=t[1];switch(r){case 2:return[new Le(Math.round(i.left),Math.round(i.top+n)),new Le(Math.round(i.left+i.width),Math.round(i.top+n)),new Le(Math.round(i.left+i.width),Math.round(A+i.top+n)),new Le(Math.round(i.left),Math.round(A+i.top+n))];case 3:return[new Le(Math.round(i.left+o),Math.round(i.top)),new Le(Math.round(i.left+o+a),Math.round(i.top)),new Le(Math.round(i.left+o+a),Math.round(i.height+i.top)),new Le(Math.round(i.left+o),Math.round(i.height+i.top))];case 1:return[new Le(Math.round(i.left+o),Math.round(i.top+n)),new Le(Math.round(i.left+o+a),Math.round(i.top+n)),new Le(Math.round(i.left+o+a),Math.round(i.top+n+A)),new Le(Math.round(i.left+o),Math.round(i.top+n+A))];default:return[new Le(Math.round(s.left),Math.round(s.top)),new Le(Math.round(s.left+s.width),Math.round(s.top)),new Le(Math.round(s.left+s.width),Math.round(s.height+s.top)),new Le(Math.round(s.left),Math.round(s.height+s.top))]}},L1="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",Pp="Hidden Text",U1=function(){function r(e){this._data={},this._document=e}return r.prototype.parseMetrics=function(e,t){var i=this._document.createElement("div"),s=this._document.createElement("img"),o=this._document.createElement("span"),n=this._document.body;i.style.visibility="hidden",i.style.fontFamily=e,i.style.fontSize=t,i.style.margin="0",i.style.padding="0",i.style.whiteSpace="nowrap",n.appendChild(i),s.src=L1,s.width=1,s.height=1,s.style.margin="0",s.style.padding="0",s.style.verticalAlign="baseline",o.style.fontFamily=e,o.style.fontSize=t,o.style.margin="0",o.style.padding="0",o.appendChild(this._document.createTextNode(Pp)),i.appendChild(o),i.appendChild(s);var a=s.offsetTop-o.offsetTop+2;i.removeChild(o),i.appendChild(this._document.createTextNode(Pp)),i.style.lineHeight="normal",s.style.verticalAlign="super";var A=s.offsetTop-i.offsetTop+2;return n.removeChild(i),{baseline:a,middle:A}},r.prototype.getMetrics=function(e,t){var i=e+" "+t;return typeof this._data[i]>"u"&&(this._data[i]=this.parseMetrics(e,t)),this._data[i]},r}(),am=function(){function r(e,t){this.context=e,this.options=t}return r}(),O1=1e4,k1=function(r){Ti(e,r);function e(t,i){var s=r.call(this,t,i)||this;return s._activeEffects=[],s.canvas=i.canvas?i.canvas:document.createElement("canvas"),s.ctx=s.canvas.getContext("2d"),i.canvas||(s.canvas.width=Math.floor(i.width*i.scale),s.canvas.height=Math.floor(i.height*i.scale),s.canvas.style.width=i.width+"px",s.canvas.style.height=i.height+"px"),s.fontMetrics=new U1(document),s.ctx.scale(s.options.scale,s.options.scale),s.ctx.translate(-i.x,-i.y),s.ctx.textBaseline="bottom",s._activeEffects=[],s.context.logger.debug("Canvas renderer initialized ("+i.width+"x"+i.height+") with scale "+i.scale),s}return e.prototype.applyEffects=function(t){for(var i=this;this._activeEffects.length;)this.popEffect();t.forEach(function(s){return i.applyEffect(s)})},e.prototype.applyEffect=function(t){this.ctx.save(),b1(t)&&(this.ctx.globalAlpha=t.opacity),w1(t)&&(this.ctx.translate(t.offsetX,t.offsetY),this.ctx.transform(t.matrix[0],t.matrix[1],t.matrix[2],t.matrix[3],t.matrix[4],t.matrix[5]),this.ctx.translate(-t.offsetX,-t.offsetY)),im(t)&&(this.path(t.path),this.ctx.clip()),this._activeEffects.push(t)},e.prototype.popEffect=function(){this._activeEffects.pop(),this.ctx.restore()},e.prototype.renderStack=function(t){return ai(this,void 0,void 0,function(){var i;return ei(this,function(s){switch(s.label){case 0:return i=t.element.container.styles,i.isVisible()?[4,this.renderStackContent(t)]:[3,2];case 1:s.sent(),s.label=2;case 2:return[2]}})})},e.prototype.renderNode=function(t){return ai(this,void 0,void 0,function(){return ei(this,function(i){switch(i.label){case 0:if(Vt(t.container.flags,16))debugger;return t.container.styles.isVisible()?[4,this.renderNodeBackgroundAndBorders(t)]:[3,3];case 1:return i.sent(),[4,this.renderNodeContent(t)];case 2:i.sent(),i.label=3;case 3:return[2]}})})},e.prototype.renderTextWithLetterSpacing=function(t,i,s){var o=this;if(i===0)this.ctx.fillText(t.text,t.bounds.left,t.bounds.top+s);else{var n=Ec(t.text);n.reduce(function(a,A){return o.ctx.fillText(A,a,t.bounds.top+s),a+o.ctx.measureText(A).width},t.bounds.left)}},e.prototype.createFontStyle=function(t){var i=t.fontVariant.filter(function(n){return n==="normal"||n==="small-caps"}).join(""),s=G1(t.fontFamily).join(", "),o=Ho(t.fontSize)?""+t.fontSize.number+t.fontSize.unit:t.fontSize.number+"px";return[[t.fontStyle,i,t.fontWeight,o,s].join(" "),s,o]},e.prototype.renderTextNode=function(t,i){return ai(this,void 0,void 0,function(){var s,o,n,a,A,l,h,d,f=this;return ei(this,function(m){return s=this.createFontStyle(i),o=s[0],n=s[1],a=s[2],this.ctx.font=o,this.ctx.direction=i.direction===1?"rtl":"ltr",this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic",A=this.fontMetrics.getMetrics(n,a),l=A.baseline,h=A.middle,d=i.paintOrder,t.textBounds.forEach(function(_){d.forEach(function(u){switch(u){case 0:f.ctx.fillStyle=jt(i.color),f.renderTextWithLetterSpacing(_,i.letterSpacing,l);var B=i.textShadow;B.length&&_.text.trim().length&&(B.slice(0).reverse().forEach(function(y){f.ctx.shadowColor=jt(y.color),f.ctx.shadowOffsetX=y.offsetX.number*f.options.scale,f.ctx.shadowOffsetY=y.offsetY.number*f.options.scale,f.ctx.shadowBlur=y.blur.number,f.renderTextWithLetterSpacing(_,i.letterSpacing,l)}),f.ctx.shadowColor="",f.ctx.shadowOffsetX=0,f.ctx.shadowOffsetY=0,f.ctx.shadowBlur=0),i.textDecorationLine.length&&(f.ctx.fillStyle=jt(i.textDecorationColor||i.color),i.textDecorationLine.forEach(function(y){switch(y){case 1:f.ctx.fillRect(_.bounds.left,Math.round(_.bounds.top+l),_.bounds.width,1);break;case 2:f.ctx.fillRect(_.bounds.left,Math.round(_.bounds.top),_.bounds.width,1);break;case 3:f.ctx.fillRect(_.bounds.left,Math.ceil(_.bounds.top+h),_.bounds.width,1);break}}));break;case 1:i.webkitTextStrokeWidth&&_.text.trim().length&&(f.ctx.strokeStyle=jt(i.webkitTextStrokeColor),f.ctx.lineWidth=i.webkitTextStrokeWidth,f.ctx.lineJoin=window.chrome?"miter":"round",f.ctx.strokeText(_.text,_.bounds.left,_.bounds.top+l)),f.ctx.strokeStyle="",f.ctx.lineWidth=0,f.ctx.lineJoin="miter";break}})}),[2]})})},e.prototype.renderReplacedElement=function(t,i,s){if(s&&t.intrinsicWidth>0&&t.intrinsicHeight>0){var o=Ba(t),n=va(i);this.path(n),this.ctx.save(),this.ctx.clip(),this.ctx.drawImage(s,0,0,t.intrinsicWidth,t.intrinsicHeight,o.left,o.top,o.width,o.height),this.ctx.restore()}},e.prototype.renderNodeContent=function(t){return ai(this,void 0,void 0,function(){var i,s,o,n,a,A,x,x,l,h,d,f,v,m,_,b,u,B,y,x,P,v,b;return ei(this,function(C){switch(C.label){case 0:this.applyEffects(t.getEffects(4)),i=t.container,s=t.curves,o=i.styles,n=0,a=i.textNodes,C.label=1;case 1:return n<a.length?(A=a[n],[4,this.renderTextNode(A,o)]):[3,4];case 2:C.sent(),C.label=3;case 3:return n++,[3,1];case 4:if(!(i instanceof Ng))return[3,8];C.label=5;case 5:return C.trys.push([5,7,,8]),[4,this.context.cache.match(i.src)];case 6:return x=C.sent(),this.renderReplacedElement(i,s,x),[3,8];case 7:return C.sent(),this.context.logger.error("Error loading image "+i.src),[3,8];case 8:if(i instanceof Qg&&this.renderReplacedElement(i,s,i.canvas),!(i instanceof Hg))return[3,12];C.label=9;case 9:return C.trys.push([9,11,,12]),[4,this.context.cache.match(i.svg)];case 10:return x=C.sent(),this.renderReplacedElement(i,s,x),[3,12];case 11:return C.sent(),this.context.logger.error("Error loading svg "+i.svg.substring(0,255)),[3,12];case 12:return i instanceof zg&&i.tree?(l=new e(this.context,{scale:this.options.scale,backgroundColor:i.backgroundColor,x:0,y:0,width:i.width,height:i.height}),[4,l.render(i.tree)]):[3,14];case 13:h=C.sent(),i.width&&i.height&&this.ctx.drawImage(h,0,0,i.width,i.height,i.bounds.left,i.bounds.top,i.bounds.width,i.bounds.height),C.label=14;case 14:if(i instanceof Ic&&(d=Math.min(i.bounds.width,i.bounds.height),i.type===pa?i.checked&&(this.ctx.save(),this.path([new Le(i.bounds.left+d*.39363,i.bounds.top+d*.79),new Le(i.bounds.left+d*.16,i.bounds.top+d*.5549),new Le(i.bounds.left+d*.27347,i.bounds.top+d*.44071),new Le(i.bounds.left+d*.39694,i.bounds.top+d*.5649),new Le(i.bounds.left+d*.72983,i.bounds.top+d*.23),new Le(i.bounds.left+d*.84,i.bounds.top+d*.34085),new Le(i.bounds.left+d*.39363,i.bounds.top+d*.79)]),this.ctx.fillStyle=jt(Ap),this.ctx.fill(),this.ctx.restore()):i.type===fa&&i.checked&&(this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(i.bounds.left+d/2,i.bounds.top+d/2,d/4,0,Math.PI*2,!0),this.ctx.fillStyle=jt(Ap),this.ctx.fill(),this.ctx.restore())),N1(i)&&i.value.length){switch(f=this.createFontStyle(o),v=f[0],m=f[1],_=this.fontMetrics.getMetrics(v,m).baseline,this.ctx.font=v,this.ctx.fillStyle=jt(o.color),this.ctx.textBaseline="alphabetic",this.ctx.textAlign=H1(i.styles.textAlign),b=Ba(i),u=0,i.styles.textAlign){case 1:u+=b.width/2;break;case 2:u+=b.width;break}B=b.add(u,0,0,-b.height/2+1),this.ctx.save(),this.path([new Le(b.left,b.top),new Le(b.left+b.width,b.top),new Le(b.left+b.width,b.top+b.height),new Le(b.left,b.top+b.height)]),this.ctx.clip(),this.renderTextWithLetterSpacing(new Co(i.value,B),o.letterSpacing,_),this.ctx.restore(),this.ctx.textBaseline="alphabetic",this.ctx.textAlign="left"}if(!Vt(i.styles.display,2048))return[3,20];if(i.styles.listStyleImage===null)return[3,19];if(y=i.styles.listStyleImage,y.type!==0)return[3,18];x=void 0,P=y.url,C.label=15;case 15:return C.trys.push([15,17,,18]),[4,this.context.cache.match(P)];case 16:return x=C.sent(),this.ctx.drawImage(x,i.bounds.left-(x.width+10),i.bounds.top),[3,18];case 17:return C.sent(),this.context.logger.error("Error loading list-style-image "+P),[3,18];case 18:return[3,20];case 19:t.listValue&&i.styles.listStyleType!==-1&&(v=this.createFontStyle(o)[0],this.ctx.font=v,this.ctx.fillStyle=jt(o.color),this.ctx.textBaseline="middle",this.ctx.textAlign="right",b=new As(i.bounds.left,i.bounds.top+xt(i.styles.paddingTop,i.bounds.width),i.bounds.width,zd(o.lineHeight,o.fontSize.number)/2+1),this.renderTextWithLetterSpacing(new Co(t.listValue,b),o.letterSpacing,zd(o.lineHeight,o.fontSize.number)/2+2),this.ctx.textBaseline="bottom",this.ctx.textAlign="left"),C.label=20;case 20:return[2]}})})},e.prototype.renderStackContent=function(t){return ai(this,void 0,void 0,function(){var i,s,y,o,n,y,a,A,y,l,h,y,d,f,y,m,_,y,u,B,y;return ei(this,function(x){switch(x.label){case 0:if(Vt(t.element.container.flags,16))debugger;return[4,this.renderNodeBackgroundAndBorders(t.element)];case 1:x.sent(),i=0,s=t.negativeZIndex,x.label=2;case 2:return i<s.length?(y=s[i],[4,this.renderStack(y)]):[3,5];case 3:x.sent(),x.label=4;case 4:return i++,[3,2];case 5:return[4,this.renderNodeContent(t.element)];case 6:x.sent(),o=0,n=t.nonInlineLevel,x.label=7;case 7:return o<n.length?(y=n[o],[4,this.renderNode(y)]):[3,10];case 8:x.sent(),x.label=9;case 9:return o++,[3,7];case 10:a=0,A=t.nonPositionedFloats,x.label=11;case 11:return a<A.length?(y=A[a],[4,this.renderStack(y)]):[3,14];case 12:x.sent(),x.label=13;case 13:return a++,[3,11];case 14:l=0,h=t.nonPositionedInlineLevel,x.label=15;case 15:return l<h.length?(y=h[l],[4,this.renderStack(y)]):[3,18];case 16:x.sent(),x.label=17;case 17:return l++,[3,15];case 18:d=0,f=t.inlineLevel,x.label=19;case 19:return d<f.length?(y=f[d],[4,this.renderNode(y)]):[3,22];case 20:x.sent(),x.label=21;case 21:return d++,[3,19];case 22:m=0,_=t.zeroOrAutoZIndexOrTransformedOrOpacity,x.label=23;case 23:return m<_.length?(y=_[m],[4,this.renderStack(y)]):[3,26];case 24:x.sent(),x.label=25;case 25:return m++,[3,23];case 26:u=0,B=t.positiveZIndex,x.label=27;case 27:return u<B.length?(y=B[u],[4,this.renderStack(y)]):[3,30];case 28:x.sent(),x.label=29;case 29:return u++,[3,27];case 30:return[2]}})})},e.prototype.mask=function(t){this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(this.canvas.width,0),this.ctx.lineTo(this.canvas.width,this.canvas.height),this.ctx.lineTo(0,this.canvas.height),this.ctx.lineTo(0,0),this.formatPath(t.slice(0).reverse()),this.ctx.closePath()},e.prototype.path=function(t){this.ctx.beginPath(),this.formatPath(t),this.ctx.closePath()},e.prototype.formatPath=function(t){var i=this;t.forEach(function(s,o){var n=wi(s)?s.start:s;o===0?i.ctx.moveTo(n.x,n.y):i.ctx.lineTo(n.x,n.y),wi(s)&&i.ctx.bezierCurveTo(s.startControl.x,s.startControl.y,s.endControl.x,s.endControl.y,s.end.x,s.end.y)})},e.prototype.renderRepeat=function(t,i,s,o){this.path(t),this.ctx.fillStyle=i,this.ctx.translate(s,o),this.ctx.fill(),this.ctx.translate(-s,-o)},e.prototype.resizeImage=function(t,i,s){var o;if(t.width===i&&t.height===s)return t;var n=(o=this.canvas.ownerDocument)!==null&&o!==void 0?o:document,a=n.createElement("canvas");a.width=Math.max(1,i),a.height=Math.max(1,s);var A=a.getContext("2d");return A.drawImage(t,0,0,t.width,t.height,0,0,i,s),a},e.prototype.renderBackgroundImage=function(t){return ai(this,void 0,void 0,function(){var i,s,o,n,a,A;return ei(this,function(l){switch(l.label){case 0:i=t.styles.backgroundImage.length-1,s=function(h){var d,f,m,R,ue,ae,j,z,E,_,R,ue,ae,j,z,u,B,y,x,P,v,b,C,I,E,S,R,D,K,j,z,le,ue,ae,Be,be,xe,Ie,Fe,Qe,Ge,V;return ei(this,function(Z){switch(Z.label){case 0:if(h.type!==0)return[3,5];d=void 0,f=h.url,Z.label=1;case 1:return Z.trys.push([1,3,,4]),[4,o.context.cache.match(f)];case 2:return d=Z.sent(),[3,4];case 3:return Z.sent(),o.context.logger.error("Error loading background-image "+f),[3,4];case 4:return d&&(m=Al(t,i,[d.width,d.height,d.width/d.height]),R=m[0],ue=m[1],ae=m[2],j=m[3],z=m[4],E=o.ctx.createPattern(o.resizeImage(d,j,z),"repeat"),o.renderRepeat(R,E,ue,ae)),[3,6];case 5:wE(h)?(_=Al(t,i,[null,null,null]),R=_[0],ue=_[1],ae=_[2],j=_[3],z=_[4],u=vE(h.angle,j,z),B=u[0],y=u[1],x=u[2],P=u[3],v=u[4],b=document.createElement("canvas"),b.width=j,b.height=z,C=b.getContext("2d"),I=C.createLinearGradient(y,P,x,v),Gd(h.stops,B).forEach(function(L){return I.addColorStop(L.stop,jt(L.color))}),C.fillStyle=I,C.fillRect(0,0,j,z),j>0&&z>0&&(E=o.ctx.createPattern(b,"repeat"),o.renderRepeat(R,E,ue,ae))):bE(h)&&(S=Al(t,i,[null,null,null]),R=S[0],D=S[1],K=S[2],j=S[3],z=S[4],le=h.position.length===0?[wc]:h.position,ue=xt(le[0],j),ae=xt(le[le.length-1],z),Be=BE(h,ue,ae,j,z),be=Be[0],xe=Be[1],be>0&&xe>0&&(Ie=o.ctx.createRadialGradient(D+ue,K+ae,0,D+ue,K+ae,be),Gd(h.stops,be*2).forEach(function(L){return Ie.addColorStop(L.stop,jt(L.color))}),o.path(R),o.ctx.fillStyle=Ie,be!==xe?(Fe=t.bounds.left+.5*t.bounds.width,Qe=t.bounds.top+.5*t.bounds.height,Ge=xe/be,V=1/Ge,o.ctx.save(),o.ctx.translate(Fe,Qe),o.ctx.transform(1,0,0,Ge,0,0),o.ctx.translate(-Fe,-Qe),o.ctx.fillRect(D,V*(K-Qe)+Qe,j,z*V),o.ctx.restore()):o.ctx.fill())),Z.label=6;case 6:return i--,[2]}})},o=this,n=0,a=t.styles.backgroundImage.slice(0).reverse(),l.label=1;case 1:return n<a.length?(A=a[n],[5,s(A)]):[3,4];case 2:l.sent(),l.label=3;case 3:return n++,[3,1];case 4:return[2]}})})},e.prototype.renderSolidBorder=function(t,i,s){return ai(this,void 0,void 0,function(){return ei(this,function(o){return this.path(Bp(s,i)),this.ctx.fillStyle=jt(t),this.ctx.fill(),[2]})})},e.prototype.renderDoubleBorder=function(t,i,s,o){return ai(this,void 0,void 0,function(){var n,a;return ei(this,function(A){switch(A.label){case 0:return i<3?[4,this.renderSolidBorder(t,s,o)]:[3,2];case 1:return A.sent(),[2];case 2:return n=I1(o,s),this.path(n),this.ctx.fillStyle=jt(t),this.ctx.fill(),a=F1(o,s),this.path(a),this.ctx.fill(),[2]}})})},e.prototype.renderNodeBackgroundAndBorders=function(t){return ai(this,void 0,void 0,function(){var i,s,o,n,a,A,l,h,d=this;return ei(this,function(f){switch(f.label){case 0:return this.applyEffects(t.getEffects(2)),i=t.container.styles,s=!Ps(i.backgroundColor)||i.backgroundImage.length,o=[{style:i.borderTopStyle,color:i.borderTopColor,width:i.borderTopWidth},{style:i.borderRightStyle,color:i.borderRightColor,width:i.borderRightWidth},{style:i.borderBottomStyle,color:i.borderBottomColor,width:i.borderBottomWidth},{style:i.borderLeftStyle,color:i.borderLeftColor,width:i.borderLeftWidth}],n=Q1(pr(i.backgroundClip,0),t.curves),s||i.boxShadow.length?(this.ctx.save(),this.path(n),this.ctx.clip(),Ps(i.backgroundColor)||(this.ctx.fillStyle=jt(i.backgroundColor),this.ctx.fill()),[4,this.renderBackgroundImage(t.container)]):[3,2];case 1:f.sent(),this.ctx.restore(),i.boxShadow.slice(0).reverse().forEach(function(m){d.ctx.save();var _=_a(t.curves),u=m.inset?0:O1,B=C1(_,-u+(m.inset?1:-1)*m.spread.number,(m.inset?1:-1)*m.spread.number,m.spread.number*(m.inset?-2:2),m.spread.number*(m.inset?-2:2));m.inset?(d.path(_),d.ctx.clip(),d.mask(B)):(d.mask(_),d.ctx.clip(),d.path(B)),d.ctx.shadowOffsetX=m.offsetX.number+u,d.ctx.shadowOffsetY=m.offsetY.number,d.ctx.shadowColor=jt(m.color),d.ctx.shadowBlur=m.blur.number,d.ctx.fillStyle=m.inset?jt(m.color):"rgba(0,0,0,1)",d.ctx.fill(),d.ctx.restore()}),f.label=2;case 2:a=0,A=0,l=o,f.label=3;case 3:return A<l.length?(h=l[A],h.style!==0&&!Ps(h.color)&&h.width>0?h.style!==2?[3,5]:[4,this.renderDashedDottedBorder(h.color,h.width,a,t.curves,2)]:[3,11]):[3,13];case 4:return f.sent(),[3,11];case 5:return h.style!==3?[3,7]:[4,this.renderDashedDottedBorder(h.color,h.width,a,t.curves,3)];case 6:return f.sent(),[3,11];case 7:return h.style!==4?[3,9]:[4,this.renderDoubleBorder(h.color,h.width,a,t.curves)];case 8:return f.sent(),[3,11];case 9:return[4,this.renderSolidBorder(h.color,a,t.curves)];case 10:f.sent(),f.label=11;case 11:a++,f.label=12;case 12:return A++,[3,3];case 13:return[2]}})})},e.prototype.renderDashedDottedBorder=function(t,i,s,o,n){return ai(this,void 0,void 0,function(){var a,A,l,h,d,f,m,_,u,B,y,x,P,v,b,C,b,C;return ei(this,function(I){return this.ctx.save(),a=M1(o,s),A=Bp(o,s),n===2&&(this.path(A),this.ctx.clip()),wi(A[0])?(l=A[0].start.x,h=A[0].start.y):(l=A[0].x,h=A[0].y),wi(A[1])?(d=A[1].end.x,f=A[1].end.y):(d=A[1].x,f=A[1].y),s===0||s===2?m=Math.abs(l-d):m=Math.abs(h-f),this.ctx.beginPath(),n===3?this.formatPath(a):this.formatPath(A.slice(0,2)),_=i<3?i*3:i*2,u=i<3?i*2:i,n===3&&(_=i,u=i),B=!0,m<=_*2?B=!1:m<=_*2+u?(y=m/(2*_+u),_*=y,u*=y):(x=Math.floor((m+u)/(_+u)),P=(m-x*_)/(x-1),v=(m-(x+1)*_)/x,u=v<=0||Math.abs(u-P)<Math.abs(u-v)?P:v),B&&(n===3?this.ctx.setLineDash([0,_+u]):this.ctx.setLineDash([_,u])),n===3?(this.ctx.lineCap="round",this.ctx.lineWidth=i):this.ctx.lineWidth=i*2+1.1,this.ctx.strokeStyle=jt(t),this.ctx.stroke(),this.ctx.setLineDash([]),n===2&&(wi(A[0])&&(b=A[3],C=A[0],this.ctx.beginPath(),this.formatPath([new Le(b.end.x,b.end.y),new Le(C.start.x,C.start.y)]),this.ctx.stroke()),wi(A[1])&&(b=A[1],C=A[2],this.ctx.beginPath(),this.formatPath([new Le(b.end.x,b.end.y),new Le(C.start.x,C.start.y)]),this.ctx.stroke())),this.ctx.restore(),[2]})})},e.prototype.render=function(t){return ai(this,void 0,void 0,function(){var i;return ei(this,function(s){switch(s.label){case 0:return this.options.backgroundColor&&(this.ctx.fillStyle=jt(this.options.backgroundColor),this.ctx.fillRect(this.options.x,this.options.y,this.options.width,this.options.height)),i=E1(t),[4,this.renderStack(i)];case 1:return s.sent(),this.applyEffects([]),[2,this.canvas]}})})},e}(am),N1=function(r){return r instanceof jg||r instanceof Gg?!0:r instanceof Ic&&r.type!==fa&&r.type!==pa},Q1=function(r,e){switch(r){case 0:return _a(e);case 2:return P1(e);case 1:default:return va(e)}},H1=function(r){switch(r){case 1:return"center";case 2:return"right";case 0:default:return"left"}},V1=["-apple-system","system-ui"],G1=function(r){return/iPhone OS 15_(0|1)/.test(window.navigator.userAgent)?r.filter(function(e){return V1.indexOf(e)===-1}):r},j1=function(r){Ti(e,r);function e(t,i){var s=r.call(this,t,i)||this;return s.canvas=i.canvas?i.canvas:document.createElement("canvas"),s.ctx=s.canvas.getContext("2d"),s.options=i,s.canvas.width=Math.floor(i.width*i.scale),s.canvas.height=Math.floor(i.height*i.scale),s.canvas.style.width=i.width+"px",s.canvas.style.height=i.height+"px",s.ctx.scale(s.options.scale,s.options.scale),s.ctx.translate(-i.x,-i.y),s.context.logger.debug("EXPERIMENTAL ForeignObject renderer initialized ("+i.width+"x"+i.height+" at "+i.x+","+i.y+") with scale "+i.scale),s}return e.prototype.render=function(t){return ai(this,void 0,void 0,function(){var i,s;return ei(this,function(o){switch(o.label){case 0:return i=sc(this.options.width*this.options.scale,this.options.height*this.options.scale,this.options.scale,this.options.scale,t),[4,z1(i)];case 1:return s=o.sent(),this.options.backgroundColor&&(this.ctx.fillStyle=jt(this.options.backgroundColor),this.ctx.fillRect(0,0,this.options.width*this.options.scale,this.options.height*this.options.scale)),this.ctx.drawImage(s,-this.options.x*this.options.scale,-this.options.y*this.options.scale),[2,this.canvas]}})})},e}(am),z1=function(r){return new Promise(function(e,t){var i=new Image;i.onload=function(){e(i)},i.onerror=t,i.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(new XMLSerializer().serializeToString(r))})},K1=function(){function r(e){var t=e.id,i=e.enabled;this.id=t,this.enabled=i,this.start=Date.now()}return r.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.enabled&&(typeof window<"u"&&window.console&&typeof console.debug=="function"?console.debug.apply(console,wn([this.id,this.getTime()+"ms"],e)):this.info.apply(this,e))},r.prototype.getTime=function(){return Date.now()-this.start},r.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.enabled&&typeof window<"u"&&window.console&&typeof console.info=="function"&&console.info.apply(console,wn([this.id,this.getTime()+"ms"],e))},r.prototype.warn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.enabled&&(typeof window<"u"&&window.console&&typeof console.warn=="function"?console.warn.apply(console,wn([this.id,this.getTime()+"ms"],e)):this.info.apply(this,e))},r.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.enabled&&(typeof window<"u"&&window.console&&typeof console.error=="function"?console.error.apply(console,wn([this.id,this.getTime()+"ms"],e)):this.info.apply(this,e))},r.instances={},r}(),W1=function(){function r(e,t){var i;this.windowBounds=t,this.instanceName="#"+r.instanceCount++,this.logger=new K1({id:this.instanceName,enabled:e.logging}),this.cache=(i=e.cache)!==null&&i!==void 0?i:new d1(this,e)}return r.instanceCount=1,r}(),yp=function(r,e){return e===void 0&&(e={}),X1(r,e)};typeof window<"u"&&tm.setContext(window);var X1=function(r,e){return ai(void 0,void 0,void 0,function(){var t,i,s,o,n,a,A,l,h,d,f,m,_,u,B,y,x,P,v,b,I,C,I,E,S,R,D,K,j,z,le,ue,ae,Be,be,xe,Ie,Fe,Qe,Ge;return ei(this,function(V){switch(V.label){case 0:if(!r||typeof r!="object")return[2,Promise.reject("Invalid element provided as first argument")];if(t=r.ownerDocument,!t)throw new Error("Element is not attached to a Document");if(i=t.defaultView,!i)throw new Error("Document is not attached to a Window");return s={allowTaint:(E=e.allowTaint)!==null&&E!==void 0?E:!1,imageTimeout:(S=e.imageTimeout)!==null&&S!==void 0?S:15e3,proxy:e.proxy,useCORS:(R=e.useCORS)!==null&&R!==void 0?R:!1},o=Vl({logging:(D=e.logging)!==null&&D!==void 0?D:!0,cache:e.cache},s),n={windowWidth:(K=e.windowWidth)!==null&&K!==void 0?K:i.innerWidth,windowHeight:(j=e.windowHeight)!==null&&j!==void 0?j:i.innerHeight,scrollX:(z=e.scrollX)!==null&&z!==void 0?z:i.pageXOffset,scrollY:(le=e.scrollY)!==null&&le!==void 0?le:i.pageYOffset},a=new As(n.scrollX,n.scrollY,n.windowWidth,n.windowHeight),A=new W1(o,a),l=(ue=e.foreignObjectRendering)!==null&&ue!==void 0?ue:!1,h={allowTaint:(ae=e.allowTaint)!==null&&ae!==void 0?ae:!1,onclone:e.onclone,ignoreElements:e.ignoreElements,inlineImages:l,copyStyles:l},A.logger.debug("Starting document clone with size "+a.width+"x"+a.height+" scrolled to "+-a.left+","+-a.top),d=new mp(A,r,h),f=d.clonedReferenceElement,f?[4,d.toIFrame(t,a)]:[2,Promise.reject("Unable to find element in cloned iframe")];case 1:return m=V.sent(),_=Fc(f)||JF(f)?Cb(f.ownerDocument):Ia(A,f),u=_.width,B=_.height,y=_.left,x=_.top,P=Y1(A,f,e.backgroundColor),v={canvas:e.canvas,backgroundColor:P,scale:(be=(Be=e.scale)!==null&&Be!==void 0?Be:i.devicePixelRatio)!==null&&be!==void 0?be:1,x:((xe=e.x)!==null&&xe!==void 0?xe:0)+y,y:((Ie=e.y)!==null&&Ie!==void 0?Ie:0)+x,width:(Fe=e.width)!==null&&Fe!==void 0?Fe:Math.ceil(u),height:(Qe=e.height)!==null&&Qe!==void 0?Qe:Math.ceil(B)},l?(A.logger.debug("Document cloned, using foreign object rendering"),I=new j1(A,v),[4,I.render(f)]):[3,3];case 2:return b=V.sent(),[3,5];case 3:return A.logger.debug("Document cloned, element located at "+y+","+x+" with size "+u+"x"+B+" using computed rendering"),A.logger.debug("Starting DOM parsing"),C=Wg(A,f),P===C.styles.backgroundColor&&(C.styles.backgroundColor=os.TRANSPARENT),A.logger.debug("Starting renderer for element at "+v.x+","+v.y+" with size "+v.width+"x"+v.height),I=new k1(A,v),[4,I.render(C)];case 4:b=V.sent(),V.label=5;case 5:return(!((Ge=e.removeContainer)!==null&&Ge!==void 0)||Ge)&&(mp.destroy(m)||A.logger.error("Cannot detach cloned iframe as it is not in the DOM anymore")),A.logger.debug("Finished rendering"),[2,b]}})})},Y1=function(r,e,t){var i=e.ownerDocument,s=i.documentElement?wo(r,getComputedStyle(i.documentElement).backgroundColor):os.TRANSPARENT,o=i.body?wo(r,getComputedStyle(i.body).backgroundColor):os.TRANSPARENT,n=typeof t=="string"?wo(r,t):t===null?os.TRANSPARENT:4294967295;return e===i.documentElement?Ps(s)?Ps(o)?n:o:s:n};class J1{constructor(e){this.language="en",this.localeService=e.localeService||new Kw,this.scene=new bv(this,{canvasId:e.canvasId,canvasElement:e.canvasElement,keyboardEventsElement:e.keyboardEventsElement,contextAttr:{preserveDrawingBuffer:e.preserveDrawingBuffer!==!1,premultipliedAlpha:!!e.premultipliedAlpha,antialias:e.antialias!==!1},spinnerElementId:e.spinnerElementId,transparent:e.transparent!==!1,gammaInput:!0,gammaOutput:!1,backgroundColor:e.backgroundColor,backgroundColorFromAmbientLight:e.backgroundColorFromAmbientLight,ticksPerRender:1,ticksPerOcclusionTest:20,units:e.units,scale:e.scale,origin:e.origin,saoEnabled:e.saoEnabled,alphaDepthMask:e.alphaDepthMask!==!1,entityOffsetsEnabled:!!e.entityOffsetsEnabled,pickSurfacePrecisionEnabled:!!e.pickSurfacePrecisionEnabled,logarithmicDepthBufferEnabled:!!e.logarithmicDepthBufferEnabled,pbrEnabled:!!e.pbrEnabled,colorTextureEnabled:e.colorTextureEnabled!==!1,dtxEnabled:!!e.dtxEnabled,numCachedSectionPlanes:e.numCachedSectionPlanes}),this.metaScene=new bb(this,this.scene),this.id=e.id||this.scene.id,this.camera=this.scene.camera,this.cameraFlight=new Us(this.scene,{duration:.5}),this.cameraControl=new Bb(this.scene,{doublePickFlyTo:!0}),this._plugins=[],this._eventSubs={}}get capabilities(){return this.scene.capabilities}on(e,t){let i=this._eventSubs[e];i||(i=[],this._eventSubs[e]=i),i.push(t)}fire(e,t){const i=this._eventSubs[e];if(i)for(let s=0,o=i.length;s<o;s++)i[s](t)}off(e){}log(e){console.log(`[xeokit viewer ${this.id}]: ${e}`)}error(e){console.error(`[xeokit viewer ${this.id}]: ${e}`)}addPlugin(e){this._plugins.push(e)}removePlugin(e){for(let t=0,i=this._plugins.length;t<i;t++){const s=this._plugins[t];if(s===e){s.clear&&s.clear(),this._plugins.splice(t,1);return}}}sendToPlugins(e,t){for(let i=0,s=this._plugins.length;i<s;i++){const o=this._plugins[i];o.send&&o.send(e,t)}}clear(){throw`Viewer#clear() no longer implemented - use '#sendToPlugins("clear") instead`}resetView(){throw"Viewer#resetView() no longer implemented - use CameraMemento & ObjectsMemento classes instead"}beginSnapshot(){this._snapshotBegun||(this.scene._renderer.beginSnapshot(),this._snapshotBegun=!0)}getSnapshot(e={}){const t=!this._snapshotBegun,i=e.width!==void 0&&e.height!==void 0,s=this.scene.canvas.canvas,o=s.clientWidth,n=s.clientHeight,a=e.width?Math.floor(e.width):s.width,A=e.height?Math.floor(e.height):s.height;i&&(s.width=a,s.height=A),this._snapshotBegun||this.beginSnapshot({width:a,height:A}),e.includeGizmos||this.sendToPlugins("snapshotStarting");const l={};for(let d=0,f=this._plugins.length;d<f;d++){const m=this._plugins[d];if(m.getContainerElement){const _=m.getContainerElement();_!==document.body&&(l[_.id]||(l[_.id]=!0,yp(_).then(function(u){document.body.appendChild(u)})))}}this.scene._renderer.renderSnapshot();const h=this.scene._renderer.readSnapshot(e);return i&&(s.width=o,s.height=n,this.scene.glRedraw()),e.includeGizmos||this.sendToPlugins("snapshotFinished"),t&&this.endSnapshot(),h}async getSnapshotWithPlugins(e={}){const t=!this._snapshotBegun,i=e.width!==void 0&&e.height!==void 0,s=this.scene.canvas.canvas,o=s.clientWidth,n=s.clientHeight,a=e.width?Math.floor(e.width):s.width,A=e.height?Math.floor(e.height):s.height;i&&(s.width=a,s.height=A),this._snapshotBegun||this.beginSnapshot(),e.includeGizmos||this.sendToPlugins("snapshotStarting"),this.scene._renderer.renderSnapshot();const l=this.scene._renderer.readSnapshotAsCanvas();i&&(s.width=o,s.height=n,this.scene.glRedraw());const h={},d=[];for(let m=0,_=this._plugins.length;m<_;m++){const u=this._plugins[m];if(u.getContainerElement){const B=u.getContainerElement();B!==document.body&&(h[B.id]||(h[B.id]=!0,d.push(B)))}}for(let m=0,_=d.length;m<_;m++){const u=d[m];await yp(u,{canvas:l,backgroundColor:null,scale:l.width/u.clientWidth})}e.includeGizmos||this.sendToPlugins("snapshotFinished"),t&&this.endSnapshot();let f=e.format||"png";return f!=="jpeg"&&f!=="png"&&f!=="bmp"&&(console.error("Unsupported image format: '"+f+"' - supported types are 'jpeg', 'bmp' and 'png' - defaulting to 'png'"),f="png"),e.includeGizmos||this.sendToPlugins("snapshotFinished"),t&&this.endSnapshot(),l.toDataURL(`image/${f}`)}endSnapshot(){this._snapshotBegun&&(this.scene._renderer.endSnapshot(),this.scene._renderer.render({force:!0}),this._snapshotBegun=!1)}destroy(){const e=this._plugins.slice();for(let t=0,i=e.length;t<i;t++)e[t].destroy();this.scene.destroy()}}function ls(r,e){if(!r)throw new Error(e||"loader assertion failed.")}const Fr=!!(typeof process!="object"||String(process)!=="[object process]"||process.browser),xp=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);xp&&parseFloat(xp[1]);const Z1="3.2.6";function Gi(r,e){if(!r)throw new Error(e||"loaders.gl assertion failed.")}const ll={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document},q1=ll.global||ll.self||ll.window||{},Mr=typeof process!="object"||String(process)!=="[object process]"||process.browser,Mc=typeof importScripts=="function",$1=typeof window<"u"&&typeof window.orientation<"u",wp=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);wp&&parseFloat(wp[1]);function He(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}class eM{constructor(e,t){He(this,"name",void 0),He(this,"workerThread",void 0),He(this,"isRunning",!0),He(this,"result",void 0),He(this,"_resolve",()=>{}),He(this,"_reject",()=>{}),this.name=e,this.workerThread=t,this.result=new Promise((i,s)=>{this._resolve=i,this._reject=s})}postMessage(e,t){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:t})}done(e){Gi(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){Gi(this.isRunning),this.isRunning=!1,this._reject(e)}}class cl{}const hl=new Map;function tM(r){Gi(r.source&&!r.url||!r.source&&r.url);let e=hl.get(r.source||r.url);return e||(r.url&&(e=iM(r.url),hl.set(r.url,e)),r.source&&(e=Am(r.source),hl.set(r.source,e))),Gi(e),e}function iM(r){if(!r.startsWith("http"))return r;const e=sM(r);return Am(e)}function Am(r){const e=new Blob([r],{type:"application/javascript"});return URL.createObjectURL(e)}function sM(r){return`try {
  importScripts('`.concat(r,`');
} catch (error) {
  console.error(error);
  throw error;
}`)}function lm(r,e=!0,t){const i=t||new Set;if(r){if(bp(r))i.add(r);else if(bp(r.buffer))i.add(r.buffer);else if(!ArrayBuffer.isView(r)){if(e&&typeof r=="object")for(const s in r)lm(r[s],e,i)}}return t===void 0?Array.from(i):[]}function bp(r){return r?r instanceof ArrayBuffer||typeof MessagePort<"u"&&r instanceof MessagePort||typeof ImageBitmap<"u"&&r instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&r instanceof OffscreenCanvas:!1}const ul=()=>{};class cc{static isSupported(){return typeof Worker<"u"&&Mr||typeof cl!==void 0}constructor(e){He(this,"name",void 0),He(this,"source",void 0),He(this,"url",void 0),He(this,"terminated",!1),He(this,"worker",void 0),He(this,"onMessage",void 0),He(this,"onError",void 0),He(this,"_loadableURL","");const{name:t,source:i,url:s}=e;Gi(i||s),this.name=t,this.source=i,this.url=s,this.onMessage=ul,this.onError=o=>console.log(o),this.worker=Mr?this._createBrowserWorker():this._createNodeWorker()}destroy(){this.onMessage=ul,this.onError=ul,this.worker.terminate(),this.terminated=!0}get isRunning(){return!!this.onMessage}postMessage(e,t){t=t||lm(e),this.worker.postMessage(e,t)}_getErrorFromErrorEvent(e){let t="Failed to load ";return t+="worker ".concat(this.name," from ").concat(this.url,". "),e.message&&(t+="".concat(e.message," in ")),e.lineno&&(t+=":".concat(e.lineno,":").concat(e.colno)),new Error(t)}_createBrowserWorker(){this._loadableURL=tM({source:this.source,url:this.url});const e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=t=>{t.data?this.onMessage(t.data):this.onError(new Error("No data received"))},e.onerror=t=>{this.onError(this._getErrorFromErrorEvent(t)),this.terminated=!0},e.onmessageerror=t=>console.error(t),e}_createNodeWorker(){let e;if(this.url){const i=this.url.includes(":/")||this.url.startsWith("/")?this.url:"./".concat(this.url);e=new cl(i,{eval:!1})}else if(this.source)e=new cl(this.source,{eval:!0});else throw new Error("no worker");return e.on("message",t=>{this.onMessage(t)}),e.on("error",t=>{this.onError(t)}),e.on("exit",t=>{}),e}}class rM{static isSupported(){return cc.isSupported()}constructor(e){He(this,"name","unnamed"),He(this,"source",void 0),He(this,"url",void 0),He(this,"maxConcurrency",1),He(this,"maxMobileConcurrency",1),He(this,"onDebug",()=>{}),He(this,"reuseWorkers",!0),He(this,"props",{}),He(this,"jobQueue",[]),He(this,"idleQueue",[]),He(this,"count",0),He(this,"isDestroyed",!1),this.source=e.source,this.url=e.url,this.setProps(e)}destroy(){this.idleQueue.forEach(e=>e.destroy()),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},e.name!==void 0&&(this.name=e.name),e.maxConcurrency!==void 0&&(this.maxConcurrency=e.maxConcurrency),e.maxMobileConcurrency!==void 0&&(this.maxMobileConcurrency=e.maxMobileConcurrency),e.reuseWorkers!==void 0&&(this.reuseWorkers=e.reuseWorkers),e.onDebug!==void 0&&(this.onDebug=e.onDebug)}async startJob(e,t=(s,o,n)=>s.done(n),i=(s,o)=>s.error(o)){const s=new Promise(o=>(this.jobQueue.push({name:e,onMessage:t,onError:i,onStart:o}),this));return this._startQueuedJob(),await s}async _startQueuedJob(){if(!this.jobQueue.length)return;const e=this._getAvailableWorker();if(!e)return;const t=this.jobQueue.shift();if(t){this.onDebug({message:"Starting job",name:t.name,workerThread:e,backlog:this.jobQueue.length});const i=new eM(t.name,e);e.onMessage=s=>t.onMessage(i,s.type,s.payload),e.onError=s=>t.onError(i,s),t.onStart(i);try{await i.result}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const e="".concat(this.name.toLowerCase()," (#").concat(this.count," of ").concat(this.maxConcurrency,")");return new cc({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return $1?this.maxMobileConcurrency:this.maxConcurrency}}const oM={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}};class rs{static isSupported(){return cc.isSupported()}static getWorkerFarm(e={}){return rs._workerFarm=rs._workerFarm||new rs({}),rs._workerFarm.setProps(e),rs._workerFarm}constructor(e){He(this,"props",void 0),He(this,"workerPools",new Map),this.props={...oM},this.setProps(e),this.workerPools=new Map}destroy(){for(const e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props={...this.props,...e};for(const t of this.workerPools.values())t.setProps(this._getWorkerPoolProps())}getWorkerPool(e){const{name:t,source:i,url:s}=e;let o=this.workerPools.get(t);return o||(o=new rM({name:t,source:i,url:s}),o.setProps(this._getWorkerPoolProps()),this.workerPools.set(t,o)),o}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}}He(rs,"_workerFarm",void 0);const nM="latest";function aM(r,e={}){const t=e[r.id]||{},i="".concat(r.id,"-worker.js");let s=t.workerUrl;if(!s&&r.id==="compression"&&(s=e.workerUrl),e._workerType==="test"&&(s="modules/".concat(r.module,"/dist/").concat(i)),!s){let o=r.version;o==="latest"&&(o=nM);const n=o?"@".concat(o):"";s="https://unpkg.com/@loaders.gl/".concat(r.module).concat(n,"/dist/").concat(i)}return Gi(s),s}function AM(r,e=Z1){Gi(r,"no worker provided");const t=r.version;return!(!e||!t)}var lM={},cM=Object.freeze({__proto__:null,default:lM});const hM="3.2.6",dl={};async function Ns(r,e=null,t={}){return e&&(r=uM(r,e,t)),dl[r]=dl[r]||dM(r),await dl[r]}function uM(r,e,t){if(r.startsWith("http"))return r;const i=t.modules||{};return i[r]?i[r]:Mr?t.CDN?(Gi(t.CDN.startsWith("http")),"".concat(t.CDN,"/").concat(e,"@").concat(hM,"/dist/libs/").concat(r)):Mc?"../src/libs/".concat(r):"modules/".concat(e,"/src/libs/").concat(r):"modules/".concat(e,"/dist/libs/").concat(r)}async function dM(r){if(r.endsWith("wasm"))return await(await fetch(r)).arrayBuffer();if(!Mr)try{return cM&&void 0}catch{return null}if(Mc)return importScripts(r);const t=await(await fetch(r)).text();return pM(t,r)}function pM(r,e){if(!Mr)return;if(Mc)return eval.call(q1,r),null;const t=document.createElement("script");t.id=e;try{t.appendChild(document.createTextNode(r))}catch{t.text=r}return document.body.appendChild(t),null}function fM(r,e){return!rs.isSupported()||!Mr&&!(e!=null&&e._nodeWorkers)?!1:r.worker&&(e==null?void 0:e.worker)}async function gM(r,e,t,i,s){const o=r.id,n=aM(r,t),A=rs.getWorkerFarm(t).getWorkerPool({name:o,url:n});t=JSON.parse(JSON.stringify(t)),i=JSON.parse(JSON.stringify(i||{}));const l=await A.startJob("process-on-worker",mM.bind(null,s));return l.postMessage("process",{input:e,options:t,context:i}),await(await l.result).result}async function mM(r,e,t,i){switch(t){case"done":e.done(i);break;case"error":e.error(new Error(i.error));break;case"process":const{id:s,input:o,options:n}=i;try{const a=await r(o,n);e.postMessage("done",{id:s,result:a})}catch(a){const A=a instanceof Error?a.message:"unknown error";e.postMessage("error",{id:s,error:A})}break;default:console.warn("parse-with-worker unknown message ".concat(t))}}function _M(r,e=5){return typeof r=="string"?r.slice(0,e):ArrayBuffer.isView(r)?Cp(r.buffer,r.byteOffset,e):r instanceof ArrayBuffer?Cp(r,0,e):""}function Cp(r,e,t){if(r.byteLength<=e+t)return"";const i=new DataView(r);let s="";for(let o=0;o<t;o++)s+=String.fromCharCode(i.getUint8(e+o));return s}function vM(r){try{return JSON.parse(r)}catch{throw new Error('Failed to parse JSON from data starting with "'.concat(_M(r),'"'))}}function cm(r){return r&&typeof r=="object"&&r.isBuffer}function BM(r){return cm(r)?new Uint8Array(r.buffer,r.byteOffset,r.length).slice().buffer:r}function hm(r){if(cm(r))return BM(r);if(r instanceof ArrayBuffer)return r;if(ArrayBuffer.isView(r))return r.byteOffset===0&&r.byteLength===r.buffer.byteLength?r.buffer:r.buffer.slice(r.byteOffset,r.byteOffset+r.byteLength);if(typeof r=="string"){const e=r;return new TextEncoder().encode(e).buffer}if(r&&typeof r=="object"&&r._toArrayBuffer)return r._toArrayBuffer();throw new Error("toArrayBuffer")}function PM(r,e,t){if(t=t||r.byteLength,r.byteLength<t||e.byteLength<t)return!1;const i=new Uint8Array(r),s=new Uint8Array(e);for(let o=0;o<i.length;++o)if(i[o]!==s[o])return!1;return!0}function yM(...r){const e=r.map(o=>o instanceof ArrayBuffer?new Uint8Array(o):o),t=e.reduce((o,n)=>o+n.byteLength,0),i=new Uint8Array(t);let s=0;for(const o of e)i.set(o,s),s+=o.byteLength;return i.buffer}function um(r,e,t){const i=t!==void 0?new Uint8Array(r).subarray(e,e+t):new Uint8Array(r).subarray(e);return new Uint8Array(i).buffer}function Vo(r,e){return ls(r>=0),ls(e>0),r+(e-1)&~(e-1)}function xM(r,e,t){let i;if(r instanceof ArrayBuffer)i=new Uint8Array(r);else{const s=r.byteOffset,o=r.byteLength;i=new Uint8Array(r.buffer||r.arrayBuffer,s,o)}return e.set(i,t),t+Vo(i.byteLength,4)}async function wM(r){const e=[];for await(const t of r)e.push(t);return yM(...e)}let bM="";const Ep={};function CM(r){for(const e in Ep)if(r.startsWith(e)){const t=Ep[e];r=r.replace(e,t)}return!r.startsWith("http://")&&!r.startsWith("https://")&&(r="".concat(bM).concat(r)),r}function EM(r){const e=r&&r.lastIndexOf("/");return e>=0?r.substr(e+1):""}const IM=r=>typeof r=="boolean",Io=r=>typeof r=="function",Go=r=>r!==null&&typeof r=="object",Ip=r=>Go(r)&&r.constructor==={}.constructor,FM=r=>r&&typeof r[Symbol.iterator]=="function",MM=r=>r&&typeof r[Symbol.asyncIterator]=="function",Lr=r=>typeof Response<"u"&&r instanceof Response||r&&r.arrayBuffer&&r.text&&r.json,jo=r=>typeof Blob<"u"&&r instanceof Blob,SM=r=>r&&typeof r=="object"&&r.isBuffer,TM=r=>typeof ReadableStream<"u"&&r instanceof ReadableStream||Go(r)&&Io(r.tee)&&Io(r.cancel)&&Io(r.getReader),DM=r=>Go(r)&&Io(r.read)&&Io(r.pipe)&&IM(r.readable),dm=r=>TM(r)||DM(r),RM=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,LM=/^([-\w.]+\/[-\w.+]+)/;function UM(r){const e=LM.exec(r);return e?e[1]:r}function Fp(r){const e=RM.exec(r);return e?e[1]:""}const OM=/\?.*/;function ka(r){if(Lr(r)){const e=pl(r.url||""),t=r.headers.get("content-type")||"";return{url:e,type:UM(t)||Fp(e)}}return jo(r)?{url:pl(r.name||""),type:r.type||""}:typeof r=="string"?{url:pl(r),type:Fp(r)}:{url:"",type:""}}function kM(r){return Lr(r)?r.headers["content-length"]||-1:jo(r)?r.size:typeof r=="string"?r.length:r instanceof ArrayBuffer||ArrayBuffer.isView(r)?r.byteLength:-1}function pl(r){return r.replace(OM,"")}async function pm(r){if(Lr(r))return r;const e={},t=kM(r);t>=0&&(e["content-length"]=String(t));const{url:i,type:s}=ka(r);s&&(e["content-type"]=s);const o=await HM(r);o&&(e["x-first-bytes"]=o),typeof r=="string"&&(r=new TextEncoder().encode(r));const n=new Response(r,{headers:e});return Object.defineProperty(n,"url",{value:i}),n}async function NM(r){if(!r.ok){const e=await QM(r);throw new Error(e)}}async function QM(r){let e="Failed to fetch resource ".concat(r.url," (").concat(r.status,"): ");try{const t=r.headers.get("Content-Type");let i=r.statusText;t.includes("application/json")&&(i+=" ".concat(await r.text())),e+=i,e=e.length>60?"".concat(e.slice(0,60),"..."):e}catch{}return e}async function HM(r){if(typeof r=="string")return"data:,".concat(r.slice(0,5));if(r instanceof Blob){const t=r.slice(0,5);return await new Promise(i=>{const s=new FileReader;s.onload=o=>{var n;return i(o==null||(n=o.target)===null||n===void 0?void 0:n.result)},s.readAsDataURL(t)})}if(r instanceof ArrayBuffer){const t=r.slice(0,5),i=VM(t);return"data:base64,".concat(i)}return null}function VM(r){let e="";const t=new Uint8Array(r);for(let i=0;i<t.byteLength;i++)e+=String.fromCharCode(t[i]);return btoa(e)}async function Mp(r,e){if(typeof r=="string"){r=CM(r);let t=e;return e!=null&&e.fetch&&typeof(e==null?void 0:e.fetch)!="function"&&(t=e.fetch),await fetch(r,t)}return await pm(r)}function GM(r){if(typeof window<"u"&&typeof window.process=="object"&&window.process.type==="renderer"||typeof process<"u"&&typeof process.versions=="object"&&process.versions.electron)return!0;const t=typeof navigator=="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent;return!!(t&&t.indexOf("Electron")>=0)}function jM(){return!(typeof process=="object"&&String(process)==="[object process]"&&!process.browser)||GM()}const sa={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document,process:typeof process=="object"&&process},Sp=sa.window||sa.self||sa.global,Tp=sa.process||{},fm=typeof __VERSION__<"u"?__VERSION__:"untranspiled source",Na=jM();function zM(r){try{const e=window[r],t="__storage_test__";return e.setItem(t,t),e.removeItem(t),e}catch{return null}}class KM{constructor(e,t,i="sessionStorage"){this.storage=zM(i),this.id=e,this.config={},Object.assign(this.config,t),this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){return this.config={},this.updateConfiguration(e)}updateConfiguration(e){if(Object.assign(this.config,e),this.storage){const t=JSON.stringify(this.config);this.storage.setItem(this.id,t)}return this}_loadConfiguration(){let e={};if(this.storage){const t=this.storage.getItem(this.id);e=t?JSON.parse(t):{}}return Object.assign(this.config,e),this}}function WM(r){let e;return r<10?e="".concat(r.toFixed(2),"ms"):r<100?e="".concat(r.toFixed(1),"ms"):r<1e3?e="".concat(r.toFixed(0),"ms"):e="".concat((r/1e3).toFixed(2),"s"),e}function XM(r,e=8){const t=Math.max(e-r.length,0);return"".concat(" ".repeat(t)).concat(r)}function fl(r,e,t,i=600){const s=r.src.replace(/\(/g,"%28").replace(/\)/g,"%29");r.width>i&&(t=Math.min(t,i/r.width));const o=r.width*t,n=r.height*t,a=["font-size:1px;","padding:".concat(Math.floor(n/2),"px ").concat(Math.floor(o/2),"px;"),"line-height:".concat(n,"px;"),"background:url(".concat(s,");"),"background-size:".concat(o,"px ").concat(n,"px;"),"color:transparent;"].join("");return["".concat(e," %c+"),a]}const Dp={BLACK:30,RED:31,GREEN:32,YELLOW:33,BLUE:34,MAGENTA:35,CYAN:36,WHITE:37,BRIGHT_BLACK:90,BRIGHT_RED:91,BRIGHT_GREEN:92,BRIGHT_YELLOW:93,BRIGHT_BLUE:94,BRIGHT_MAGENTA:95,BRIGHT_CYAN:96,BRIGHT_WHITE:97};function Rp(r){return typeof r=="string"?Dp[r.toUpperCase()]||Dp.WHITE:r}function YM(r,e,t){return!Na&&typeof r=="string"&&(e&&(e=Rp(e),r="\x1B[".concat(e,"m").concat(r,"\x1B[39m")),t&&(e=Rp(t),r="\x1B[".concat(t+10,"m").concat(r,"\x1B[49m"))),r}function JM(r,e=["constructor"]){const t=Object.getPrototypeOf(r),i=Object.getOwnPropertyNames(t);for(const s of i)typeof r[s]=="function"&&(e.find(o=>s===o)||(r[s]=r[s].bind(r)))}function Pa(r,e){if(!r)throw new Error(e||"Assertion failed")}function Ar(){let r;if(Na&&Sp.performance)r=Sp.performance.now();else if(Tp.hrtime){const e=Tp.hrtime();r=e[0]*1e3+e[1]/1e6}else r=Date.now();return r}const lr={debug:Na&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},ZM={enabled:!0,level:0};function Pi(){}const Lp={},Up={once:!0};function qM(r){for(const e in r)for(const t in r[e])return t||"untitled";return"empty"}class gm{constructor({id:e}={id:""}){this.id=e,this.VERSION=fm,this._startTs=Ar(),this._deltaTs=Ar(),this.LOG_THROTTLE_TIMEOUT=0,this._storage=new KM("__probe-".concat(this.id,"__"),ZM),this.userData={},this.timeStamp("".concat(this.id," started")),JM(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((Ar()-this._startTs).toPrecision(10))}getDelta(){return Number((Ar()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(e=!0){return this._storage.updateConfiguration({enabled:e}),this}setLevel(e){return this._storage.updateConfiguration({level:e}),this}assert(e,t){Pa(e,t)}warn(e){return this._getLogFunction(0,e,lr.warn,arguments,Up)}error(e){return this._getLogFunction(0,e,lr.error,arguments)}deprecated(e,t){return this.warn("`".concat(e,"` is deprecated and will be removed in a later version. Use `").concat(t,"` instead"))}removed(e,t){return this.error("`".concat(e,"` has been removed. Use `").concat(t,"` instead"))}probe(e,t){return this._getLogFunction(e,t,lr.log,arguments,{time:!0,once:!0})}log(e,t){return this._getLogFunction(e,t,lr.debug,arguments)}info(e,t){return this._getLogFunction(e,t,console.info,arguments)}once(e,t){return this._getLogFunction(e,t,lr.debug||lr.info,arguments,Up)}table(e,t,i){return t?this._getLogFunction(e,t,console.table||Pi,i&&[i],{tag:qM(t)}):Pi}image({logLevel:e,priority:t,image:i,message:s="",scale:o=1}){return this._shouldLog(e||t)?Na?t2({image:i,message:s,scale:o}):e2({image:i,message:s,scale:o}):Pi}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}get(e){return this._storage.config[e]}set(e,t){this._storage.updateConfiguration({[e]:t})}time(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}timeEnd(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,t){return this._getLogFunction(e,t,console.timeStamp||Pi)}group(e,t,i={collapsed:!1}){i=Op({logLevel:e,message:t,opts:i});const{collapsed:s}=i;return i.method=(s?console.groupCollapsed:console.group)||console.info,this._getLogFunction(i)}groupCollapsed(e,t,i={}){return this.group(e,t,Object.assign({},i,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||Pi)}withGroup(e,t,i){this.group(e,t)();try{i()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=mm(e)}_getLogFunction(e,t,i,s=[],o){if(this._shouldLog(e)){o=Op({logLevel:e,message:t,args:s,opts:o}),i=i||o.method,Pa(i),o.total=this.getTotal(),o.delta=this.getDelta(),this._deltaTs=Ar();const n=o.tag||o.message;if(o.once)if(!Lp[n])Lp[n]=Ar();else return Pi;return t=$M(this.id,o.message,o),i.bind(console,t,...o.args)}return Pi}}gm.VERSION=fm;function mm(r){if(!r)return 0;let e;switch(typeof r){case"number":e=r;break;case"object":e=r.logLevel||r.priority||0;break;default:return 0}return Pa(Number.isFinite(e)&&e>=0),e}function Op(r){const{logLevel:e,message:t}=r;r.logLevel=mm(e);const i=r.args?Array.from(r.args):[];for(;i.length&&i.shift()!==t;);switch(r.args=i,typeof e){case"string":case"function":t!==void 0&&i.unshift(t),r.message=e;break;case"object":Object.assign(r,e);break}typeof r.message=="function"&&(r.message=r.message());const s=typeof r.message;return Pa(s==="string"||s==="object"),Object.assign(r,r.opts)}function $M(r,e,t){if(typeof e=="string"){const i=t.time?XM(WM(t.total)):"";e=t.time?"".concat(r,": ").concat(i,"  ").concat(e):"".concat(r,": ").concat(e),e=YM(e,t.color,t.background)}return e}function e2({image:r,message:e="",scale:t=1}){let i=null;try{i=Qa.require("asciify-image")}catch{}return i?()=>i(r,{fit:"box",width:"".concat(Math.round(80*t),"%")}).then(s=>console.log(s)):Pi}function t2({image:r,message:e="",scale:t=1}){if(typeof r=="string"){const s=new Image;return s.onload=()=>{const o=fl(s,e,t);console.log(...o)},s.src=r,Pi}const i=r.nodeName||"";if(i.toLowerCase()==="img")return console.log(...fl(r,e,t)),Pi;if(i.toLowerCase()==="canvas"){const s=new Image;return s.onload=()=>console.log(...fl(s,e,t)),s.src=r.toDataURL(),Pi}return Pi}const kp=new gm({id:"loaders.gl"});class i2{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}}class s2{constructor(){He(this,"console",void 0),this.console=console}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}}const _m={fetch:null,mimeType:void 0,nothrow:!1,log:new s2,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:Fr,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},r2={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function vm(){globalThis.loaders=globalThis.loaders||{};const{loaders:r}=globalThis;return r._state=r._state||{},r._state}const Bm=()=>{const r=vm();return r.globalOptions=r.globalOptions||{..._m},r.globalOptions};function o2(r,e,t,i){return t=t||[],t=Array.isArray(t)?t:[t],a2(r,t),l2(e,r,i)}function n2(r,e){const t=Bm(),i=r||t;return typeof i.fetch=="function"?i.fetch:Go(i.fetch)?s=>Mp(s,i):e!=null&&e.fetch?e==null?void 0:e.fetch:Mp}function a2(r,e){Np(r,null,_m,r2,e);for(const t of e){const i=r&&r[t.id]||{},s=t.options&&t.options[t.id]||{},o=t.deprecatedOptions&&t.deprecatedOptions[t.id]||{};Np(i,t.id,s,o,e)}}function Np(r,e,t,i,s){const o=e||"Top level",n=e?"".concat(e,"."):"";for(const a in r){const A=!e&&Go(r[a]),l=a==="baseUri"&&!e,h=a==="workerUrl"&&e;if(!(a in t)&&!l&&!h){if(a in i)kp.warn("".concat(o," loader option '").concat(n).concat(a,"' no longer supported, use '").concat(i[a],"'"))();else if(!A){const d=A2(a,s);kp.warn("".concat(o," loader option '").concat(n).concat(a,"' not recognized. ").concat(d))()}}}}function A2(r,e){const t=r.toLowerCase();let i="";for(const s of e)for(const o in s.options){if(r===o)return"Did you mean '".concat(s.id,".").concat(o,"'?");const n=o.toLowerCase();(t.startsWith(n)||n.startsWith(t))&&(i=i||"Did you mean '".concat(s.id,".").concat(o,"'?"))}return i}function l2(r,e,t){const s={...r.options||{}};return c2(s,t),s.log===null&&(s.log=new i2),Qp(s,Bm()),Qp(s,e),s}function Qp(r,e){for(const t in e)if(t in e){const i=e[t];Ip(i)&&Ip(r[t])?r[t]={...r[t],...e[t]}:r[t]=e[t]}}function c2(r,e){e&&!("baseUri"in r)&&(r.baseUri=e)}function Pm(r){var e;return r?(Array.isArray(r)&&(r=r[0]),Array.isArray((e=r)===null||e===void 0?void 0:e.extensions)):!1}function ym(r){var e,t;ls(r,"null loader"),ls(Pm(r),"invalid loader");let i;return Array.isArray(r)&&(i=r[1],r=r[0],r={...r,options:{...r.options,...i}}),((e=r)!==null&&e!==void 0&&e.parseTextSync||(t=r)!==null&&t!==void 0&&t.parseText)&&(r.text=!0),r.text||(r.binary=!0),r}const h2=()=>{const r=vm();return r.loaderRegistry=r.loaderRegistry||[],r.loaderRegistry};function u2(){return h2()}function d2(r){if(typeof window<"u"&&typeof window.process=="object"&&window.process.type==="renderer"||typeof process<"u"&&typeof process.versions=="object"&&process.versions.electron)return!0;const t=typeof navigator=="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent;return!!(t&&t.indexOf("Electron")>=0)}function zo(){return!(typeof process=="object"&&String(process)==="[object process]"&&!process.browser)||d2()}const ra={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document,process:typeof process=="object"&&process},Wn=ra.window||ra.self||ra.global,lo=ra.process||{},xm=typeof __VERSION__<"u"?__VERSION__:"untranspiled source";zo();function p2(r){try{const e=window[r],t="__storage_test__";return e.setItem(t,t),e.removeItem(t),e}catch{return null}}class f2{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"sessionStorage";He(this,"storage",void 0),He(this,"id",void 0),He(this,"config",{}),this.storage=p2(i),this.id=e,this.config={},Object.assign(this.config,t),this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){return this.config={},this.updateConfiguration(e)}updateConfiguration(e){if(Object.assign(this.config,e),this.storage){const t=JSON.stringify(this.config);this.storage.setItem(this.id,t)}return this}_loadConfiguration(){let e={};if(this.storage){const t=this.storage.getItem(this.id);e=t?JSON.parse(t):{}}return Object.assign(this.config,e),this}}function g2(r){let e;return r<10?e="".concat(r.toFixed(2),"ms"):r<100?e="".concat(r.toFixed(1),"ms"):r<1e3?e="".concat(r.toFixed(0),"ms"):e="".concat((r/1e3).toFixed(2),"s"),e}function m2(r){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:8;const t=Math.max(e-r.length,0);return"".concat(" ".repeat(t)).concat(r)}function gl(r,e,t){let i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:600;const s=r.src.replace(/\(/g,"%28").replace(/\)/g,"%29");r.width>i&&(t=Math.min(t,i/r.width));const o=r.width*t,n=r.height*t,a=["font-size:1px;","padding:".concat(Math.floor(n/2),"px ").concat(Math.floor(o/2),"px;"),"line-height:".concat(n,"px;"),"background:url(".concat(s,");"),"background-size:".concat(o,"px ").concat(n,"px;"),"color:transparent;"].join("");return["".concat(e," %c+"),a]}let ya;(function(r){r[r.BLACK=30]="BLACK",r[r.RED=31]="RED",r[r.GREEN=32]="GREEN",r[r.YELLOW=33]="YELLOW",r[r.BLUE=34]="BLUE",r[r.MAGENTA=35]="MAGENTA",r[r.CYAN=36]="CYAN",r[r.WHITE=37]="WHITE",r[r.BRIGHT_BLACK=90]="BRIGHT_BLACK",r[r.BRIGHT_RED=91]="BRIGHT_RED",r[r.BRIGHT_GREEN=92]="BRIGHT_GREEN",r[r.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",r[r.BRIGHT_BLUE=94]="BRIGHT_BLUE",r[r.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",r[r.BRIGHT_CYAN=96]="BRIGHT_CYAN",r[r.BRIGHT_WHITE=97]="BRIGHT_WHITE"})(ya||(ya={}));function Hp(r){return typeof r=="string"?ya[r.toUpperCase()]||ya.WHITE:r}function _2(r,e,t){return!zo&&typeof r=="string"&&(e&&(e=Hp(e),r="\x1B[".concat(e,"m").concat(r,"\x1B[39m")),t&&(e=Hp(t),r="\x1B[".concat(t+10,"m").concat(r,"\x1B[49m"))),r}function v2(r){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:["constructor"];const t=Object.getPrototypeOf(r),i=Object.getOwnPropertyNames(t);for(const s of i)typeof r[s]=="function"&&(e.find(o=>s===o)||(r[s]=r[s].bind(r)))}function xa(r,e){if(!r)throw new Error(e||"Assertion failed")}function cr(){let r;if(zo&&"performance"in Wn){var e,t;r=Wn==null||(e=Wn.performance)===null||e===void 0||(t=e.now)===null||t===void 0?void 0:t.call(e)}else if("hrtime"in lo){var i;const s=lo==null||(i=lo.hrtime)===null||i===void 0?void 0:i.call(lo);r=s[0]*1e3+s[1]/1e6}else r=Date.now();return r}const hr={debug:zo&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},B2={enabled:!0,level:0};function yi(){}const Vp={},Gp={once:!0};class wm{constructor(){let{id:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{id:""};He(this,"id",void 0),He(this,"VERSION",xm),He(this,"_startTs",cr()),He(this,"_deltaTs",cr()),He(this,"_storage",void 0),He(this,"userData",{}),He(this,"LOG_THROTTLE_TIMEOUT",0),this.id=e,this._storage=new f2("__probe-".concat(this.id,"__"),B2),this.userData={},this.timeStamp("".concat(this.id," started")),v2(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((cr()-this._startTs).toPrecision(10))}getDelta(){return Number((cr()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return this._storage.updateConfiguration({enabled:e}),this}setLevel(e){return this._storage.updateConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,t){this._storage.updateConfiguration({[e]:t})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(e,t){xa(e,t)}warn(e){return this._getLogFunction(0,e,hr.warn,arguments,Gp)}error(e){return this._getLogFunction(0,e,hr.error,arguments)}deprecated(e,t){return this.warn("`".concat(e,"` is deprecated and will be removed in a later version. Use `").concat(t,"` instead"))}removed(e,t){return this.error("`".concat(e,"` has been removed. Use `").concat(t,"` instead"))}probe(e,t){return this._getLogFunction(e,t,hr.log,arguments,{time:!0,once:!0})}log(e,t){return this._getLogFunction(e,t,hr.debug,arguments)}info(e,t){return this._getLogFunction(e,t,console.info,arguments)}once(e,t){for(var i=arguments.length,s=new Array(i>2?i-2:0),o=2;o<i;o++)s[o-2]=arguments[o];return this._getLogFunction(e,t,hr.debug||hr.info,arguments,Gp)}table(e,t,i){return t?this._getLogFunction(e,t,console.table||yi,i&&[i],{tag:w2(t)}):yi}image(e){let{logLevel:t,priority:i,image:s,message:o="",scale:n=1}=e;return this._shouldLog(t||i)?zo?x2({image:s,message:o,scale:n}):y2({image:s,message:o,scale:n}):yi}time(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}timeEnd(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,t){return this._getLogFunction(e,t,console.timeStamp||yi)}group(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{collapsed:!1};const s=jp({logLevel:e,message:t,opts:i}),{collapsed:o}=i;return s.method=(o?console.groupCollapsed:console.group)||console.info,this._getLogFunction(s)}groupCollapsed(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return this.group(e,t,Object.assign({},i,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||yi)}withGroup(e,t,i){this.group(e,t)();try{i()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=bm(e)}_getLogFunction(e,t,i,s,o){if(this._shouldLog(e)){o=jp({logLevel:e,message:t,args:s,opts:o}),i=i||o.method,xa(i),o.total=this.getTotal(),o.delta=this.getDelta(),this._deltaTs=cr();const n=o.tag||o.message;if(o.once)if(!Vp[n])Vp[n]=cr();else return yi;return t=P2(this.id,o.message,o),i.bind(console,t,...o.args)}return yi}}He(wm,"VERSION",xm);function bm(r){if(!r)return 0;let e;switch(typeof r){case"number":e=r;break;case"object":e=r.logLevel||r.priority||0;break;default:return 0}return xa(Number.isFinite(e)&&e>=0),e}function jp(r){const{logLevel:e,message:t}=r;r.logLevel=bm(e);const i=r.args?Array.from(r.args):[];for(;i.length&&i.shift()!==t;);switch(typeof e){case"string":case"function":t!==void 0&&i.unshift(t),r.message=e;break;case"object":Object.assign(r,e);break}typeof r.message=="function"&&(r.message=r.message());const s=typeof r.message;return xa(s==="string"||s==="object"),Object.assign(r,{args:i},r.opts)}function P2(r,e,t){if(typeof e=="string"){const i=t.time?m2(g2(t.total)):"";e=t.time?"".concat(r,": ").concat(i,"  ").concat(e):"".concat(r,": ").concat(e),e=_2(e,t.color,t.background)}return e}function y2(r){let{image:e,message:t="",scale:i=1}=r,s=null;try{s=Qa.require("asciify-image")}catch{}return s?()=>s(e,{fit:"box",width:"".concat(Math.round(80*i),"%")}).then(o=>console.log(o)):yi}function x2(r){let{image:e,message:t="",scale:i=1}=r;if(typeof e=="string"){const o=new Image;return o.onload=()=>{const n=gl(o,t,i);console.log(...n)},o.src=e,yi}const s=e.nodeName||"";if(s.toLowerCase()==="img")return console.log(...gl(e,t,i)),yi;if(s.toLowerCase()==="canvas"){const o=new Image;return o.onload=()=>console.log(...gl(o,t,i)),o.src=e.toDataURL(),yi}return yi}function w2(r){for(const e in r)for(const t in r[e])return t||"untitled";return"empty"}const b2=new wm({id:"loaders.gl"}),C2=/\.([^.]+)$/;async function E2(r,e=[],t,i){if(!Cm(r))return null;let s=zp(r,e,{...t,nothrow:!0});if(s)return s;if(jo(r)&&(r=await r.slice(0,10).arrayBuffer(),s=zp(r,e,t)),!s&&!(t!=null&&t.nothrow))throw new Error(Em(r));return s}function zp(r,e=[],t,i){if(!Cm(r))return null;if(e&&!Array.isArray(e))return ym(e);let s=[];e&&(s=s.concat(e)),t!=null&&t.ignoreRegisteredLoaders||s.push(...u2()),F2(s);const o=I2(r,s,t);if(!o&&!(t!=null&&t.nothrow))throw new Error(Em(r));return o}function I2(r,e,t,i){const{url:s,type:o}=ka(r),n=s||void 0;let a=null,A="";if(t!=null&&t.mimeType&&(a=ml(e,t==null?void 0:t.mimeType),A="match forced by supplied MIME type ".concat(t==null?void 0:t.mimeType)),a=a||M2(e,n),A=A||(a?"matched url ".concat(n):""),a=a||ml(e,o),A=A||(a?"matched MIME type ".concat(o):""),a=a||T2(e,r),A=A||(a?"matched initial data ".concat(Im(r)):""),a=a||ml(e,t==null?void 0:t.fallbackMimeType),A=A||(a?"matched fallback MIME type ".concat(o):""),A){var l;b2.log(1,"selectLoader selected ".concat((l=a)===null||l===void 0?void 0:l.name,": ").concat(A,"."))}return a}function Cm(r){return!(r instanceof Response&&r.status===204)}function Em(r){const{url:e,type:t}=ka(r);let i="No valid loader found (";i+=e?"".concat(EM(e),", "):"no url provided, ",i+="MIME type: ".concat(t?'"'.concat(t,'"'):"not provided",", ");const s=r?Im(r):"";return i+=s?' first bytes: "'.concat(s,'"'):"first bytes: not available",i+=")",i}function F2(r){for(const e of r)ym(e)}function M2(r,e){const t=e&&C2.exec(e),i=t&&t[1];return i?S2(r,i):null}function S2(r,e){e=e.toLowerCase();for(const t of r)for(const i of t.extensions)if(i.toLowerCase()===e)return t;return null}function ml(r,e){for(const t of r)if(t.mimeTypes&&t.mimeTypes.includes(e)||e==="application/x.".concat(t.id))return t;return null}function T2(r,e){if(!e)return null;for(const t of r)if(typeof e=="string"){if(D2(e,t))return t}else if(ArrayBuffer.isView(e)){if(Kp(e.buffer,e.byteOffset,t))return t}else if(e instanceof ArrayBuffer&&Kp(e,0,t))return t;return null}function D2(r,e){return e.testText?e.testText(r):(Array.isArray(e.tests)?e.tests:[e.tests]).some(i=>r.startsWith(i))}function Kp(r,e,t){return(Array.isArray(t.tests)?t.tests:[t.tests]).some(s=>R2(r,e,t,s))}function R2(r,e,t,i){if(i instanceof ArrayBuffer)return PM(i,r,i.byteLength);switch(typeof i){case"function":return i(r,t);case"string":const s=hc(r,e,i.length);return i===s;default:return!1}}function Im(r,e=5){return typeof r=="string"?r.slice(0,e):ArrayBuffer.isView(r)?hc(r.buffer,r.byteOffset,e):r instanceof ArrayBuffer?hc(r,0,e):""}function hc(r,e,t){if(r.byteLength<e+t)return"";const i=new DataView(r);let s="";for(let o=0;o<t;o++)s+=String.fromCharCode(i.getUint8(e+o));return s}const L2=256*1024;function*U2(r,e){const t=(e==null?void 0:e.chunkSize)||L2;let i=0;const s=new TextEncoder;for(;i<r.length;){const o=Math.min(r.length-i,t),n=r.slice(i,i+o);i+=o,yield s.encode(n)}}const O2=256*1024;function*k2(r,e={}){const{chunkSize:t=O2}=e;let i=0;for(;i<r.byteLength;){const s=Math.min(r.byteLength-i,t),o=new ArrayBuffer(s),n=new Uint8Array(r,i,s);new Uint8Array(o).set(n),i+=s,yield o}}const N2=1024*1024;async function*Q2(r,e){const t=(e==null?void 0:e.chunkSize)||N2;let i=0;for(;i<r.size;){const s=i+t,o=await r.slice(i,s).arrayBuffer();i=s,yield o}}function Wp(r,e){return Fr?H2(r,e):V2(r)}async function*H2(r,e){const t=r.getReader();let i;try{for(;;){const s=i||t.read();e!=null&&e._streamReadAhead&&(i=t.read());const{done:o,value:n}=await s;if(o)return;yield hm(n)}}catch{t.releaseLock()}}async function*V2(r,e){for await(const t of r)yield hm(t)}function G2(r,e){if(typeof r=="string")return U2(r,e);if(r instanceof ArrayBuffer)return k2(r,e);if(jo(r))return Q2(r,e);if(dm(r))return Wp(r,e);if(Lr(r))return Wp(r.body,e);throw new Error("makeIterator")}const Fm="Cannot convert supplied data type";function j2(r,e,t){if(e.text&&typeof r=="string")return r;if(SM(r)&&(r=r.buffer),r instanceof ArrayBuffer){const i=r;return e.text&&!e.binary?new TextDecoder("utf8").decode(i):i}if(ArrayBuffer.isView(r)){if(e.text&&!e.binary)return new TextDecoder("utf8").decode(r);let i=r.buffer;const s=r.byteLength||r.length;return(r.byteOffset!==0||s!==i.byteLength)&&(i=i.slice(r.byteOffset,r.byteOffset+s)),i}throw new Error(Fm)}async function z2(r,e,t){const i=r instanceof ArrayBuffer||ArrayBuffer.isView(r);if(typeof r=="string"||i)return j2(r,e);if(jo(r)&&(r=await pm(r)),Lr(r)){const s=r;return await NM(s),e.binary?await s.arrayBuffer():await s.text()}if(dm(r)&&(r=G2(r,t)),FM(r)||MM(r))return wM(r);throw new Error(Fm)}function K2(r,e,t=null){if(t)return t;const i={fetch:n2(e,r),...r};return Array.isArray(i.loaders)||(i.loaders=null),i}function W2(r,e){if(!e&&r&&!Array.isArray(r))return r;let t;if(r&&(t=Array.isArray(r)?r:[r]),e&&e.loaders){const i=Array.isArray(e.loaders)?e.loaders:[e.loaders];t=t?[...t,...i]:i}return t&&t.length?t:null}async function Sc(r,e,t,i){Gi(!i||typeof i=="object"),e&&!Array.isArray(e)&&!Pm(e)&&(i=void 0,t=e,e=void 0),r=await r,t=t||{};const{url:s}=ka(r),n=W2(e,i),a=await E2(r,n,t);return a?(t=o2(t,a,n,s),i=K2({url:s,parse:Sc,loaders:n},t,i),await X2(a,r,t,i)):null}async function X2(r,e,t,i){if(AM(r),Lr(e)){const s=e,{ok:o,redirected:n,status:a,statusText:A,type:l,url:h}=s,d=Object.fromEntries(s.headers.entries());i.response={headers:d,ok:o,redirected:n,status:a,statusText:A,type:l,url:h}}if(e=await z2(e,r,t),r.parseTextSync&&typeof e=="string")return t.dataType="text",r.parseTextSync(e,t,i,r);if(fM(r,t))return await gM(r,e,t,i,Sc);if(r.parseText&&typeof e=="string")return await r.parseText(e,t,i,r);if(r.parse)return await r.parse(e,t,i,r);throw Gi(!r.parseSync),new Error("".concat(r.id," loader - no parser found and worker is disabled"))}const Y2="3.2.6",J2="3.2.6",Mm="3.2.6",Z2="https://unpkg.com/@loaders.gl/textures@".concat(Mm,"/dist/libs/basis_encoder.wasm"),q2="https://unpkg.com/@loaders.gl/textures@".concat(Mm,"/dist/libs/basis_encoder.js");let _l;async function Xp(r){const e=r.modules||{};return e.basis?e.basis:(_l=_l||$2(r),await _l)}async function $2(r){let e=null,t=null;return[e,t]=await Promise.all([await Ns("basis_transcoder.js","textures",r),await Ns("basis_transcoder.wasm","textures",r)]),e=e||globalThis.BASIS,await eS(e,t)}function eS(r,e){const t={};return e&&(t.wasmBinary=e),new Promise(i=>{r(t).then(s=>{const{BasisFile:o,initializeBasis:n}=s;n(),i({BasisFile:o})})})}let vl;async function Yp(r){const e=r.modules||{};return e.basisEncoder?e.basisEncoder:(vl=vl||tS(r),await vl)}async function tS(r){let e=null,t=null;return[e,t]=await Promise.all([await Ns(q2,"textures",r),await Ns(Z2,"textures",r)]),e=e||globalThis.BASIS,await iS(e,t)}function iS(r,e){const t={};return e&&(t.wasmBinary=e),new Promise(i=>{r(t).then(s=>{const{BasisFile:o,KTX2File:n,initializeBasis:a,BasisEncoder:A}=s;a(),i({BasisFile:o,KTX2File:n,BasisEncoder:A})})})}const ur={COMPRESSED_RGB_S3TC_DXT1_EXT:33776,COMPRESSED_RGBA_S3TC_DXT1_EXT:33777,COMPRESSED_RGBA_S3TC_DXT3_EXT:33778,COMPRESSED_RGBA_S3TC_DXT5_EXT:33779,COMPRESSED_R11_EAC:37488,COMPRESSED_SIGNED_R11_EAC:37489,COMPRESSED_RG11_EAC:37490,COMPRESSED_SIGNED_RG11_EAC:37491,COMPRESSED_RGB8_ETC2:37492,COMPRESSED_RGBA8_ETC2_EAC:37493,COMPRESSED_SRGB8_ETC2:37494,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:37495,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:37496,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:37497,COMPRESSED_RGB_PVRTC_4BPPV1_IMG:35840,COMPRESSED_RGBA_PVRTC_4BPPV1_IMG:35842,COMPRESSED_RGB_PVRTC_2BPPV1_IMG:35841,COMPRESSED_RGBA_PVRTC_2BPPV1_IMG:35843,COMPRESSED_RGB_ETC1_WEBGL:36196,COMPRESSED_RGB_ATC_WEBGL:35986,COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL:35987,COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL:34798,COMPRESSED_RGBA_ASTC_4X4_KHR:37808,COMPRESSED_RGBA_ASTC_5X4_KHR:37809,COMPRESSED_RGBA_ASTC_5X5_KHR:37810,COMPRESSED_RGBA_ASTC_6X5_KHR:37811,COMPRESSED_RGBA_ASTC_6X6_KHR:37812,COMPRESSED_RGBA_ASTC_8X5_KHR:37813,COMPRESSED_RGBA_ASTC_8X6_KHR:37814,COMPRESSED_RGBA_ASTC_8X8_KHR:37815,COMPRESSED_RGBA_ASTC_10X5_KHR:37816,COMPRESSED_RGBA_ASTC_10X6_KHR:37817,COMPRESSED_RGBA_ASTC_10X8_KHR:37818,COMPRESSED_RGBA_ASTC_10X10_KHR:37819,COMPRESSED_RGBA_ASTC_12X10_KHR:37820,COMPRESSED_RGBA_ASTC_12X12_KHR:37821,COMPRESSED_SRGB8_ALPHA8_ASTC_4X4_KHR:37840,COMPRESSED_SRGB8_ALPHA8_ASTC_5X4_KHR:37841,COMPRESSED_SRGB8_ALPHA8_ASTC_5X5_KHR:37842,COMPRESSED_SRGB8_ALPHA8_ASTC_6X5_KHR:37843,COMPRESSED_SRGB8_ALPHA8_ASTC_6X6_KHR:37844,COMPRESSED_SRGB8_ALPHA8_ASTC_8X5_KHR:37845,COMPRESSED_SRGB8_ALPHA8_ASTC_8X6_KHR:37846,COMPRESSED_SRGB8_ALPHA8_ASTC_8X8_KHR:37847,COMPRESSED_SRGB8_ALPHA8_ASTC_10X5_KHR:37848,COMPRESSED_SRGB8_ALPHA8_ASTC_10X6_KHR:37849,COMPRESSED_SRGB8_ALPHA8_ASTC_10X8_KHR:37850,COMPRESSED_SRGB8_ALPHA8_ASTC_10X10_KHR:37851,COMPRESSED_SRGB8_ALPHA8_ASTC_12X10_KHR:37852,COMPRESSED_SRGB8_ALPHA8_ASTC_12X12_KHR:37853,COMPRESSED_RED_RGTC1_EXT:36283,COMPRESSED_SIGNED_RED_RGTC1_EXT:36284,COMPRESSED_RED_GREEN_RGTC2_EXT:36285,COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT:36286,COMPRESSED_SRGB_S3TC_DXT1_EXT:35916,COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:35917,COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT:35918,COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:35919},sS=["","WEBKIT_","MOZ_"],Jp={WEBGL_compressed_texture_s3tc:"dxt",WEBGL_compressed_texture_s3tc_srgb:"dxt-srgb",WEBGL_compressed_texture_etc1:"etc1",WEBGL_compressed_texture_etc:"etc2",WEBGL_compressed_texture_pvrtc:"pvrtc",WEBGL_compressed_texture_atc:"atc",WEBGL_compressed_texture_astc:"astc",EXT_texture_compression_rgtc:"rgtc"};let Xn=null;function rS(r){if(!Xn){r=r||oS()||void 0,Xn=new Set;for(const e of sS)for(const t in Jp)if(r&&r.getExtension("".concat(e).concat(t))){const i=Jp[t];Xn.add(i)}}return Xn}function oS(){try{return document.createElement("canvas").getContext("webgl")}catch{return null}}var Zp,qp,$p,ef,tf,sf,rf,of;(function(r){r[r.NONE=0]="NONE",r[r.BASISLZ=1]="BASISLZ",r[r.ZSTD=2]="ZSTD",r[r.ZLIB=3]="ZLIB"})(Zp||(Zp={})),function(r){r[r.BASICFORMAT=0]="BASICFORMAT"}(qp||(qp={})),function(r){r[r.UNSPECIFIED=0]="UNSPECIFIED",r[r.ETC1S=163]="ETC1S",r[r.UASTC=166]="UASTC"}($p||($p={})),function(r){r[r.UNSPECIFIED=0]="UNSPECIFIED",r[r.SRGB=1]="SRGB"}(ef||(ef={})),function(r){r[r.UNSPECIFIED=0]="UNSPECIFIED",r[r.LINEAR=1]="LINEAR",r[r.SRGB=2]="SRGB",r[r.ITU=3]="ITU",r[r.NTSC=4]="NTSC",r[r.SLOG=5]="SLOG",r[r.SLOG2=6]="SLOG2"}(tf||(tf={})),function(r){r[r.ALPHA_STRAIGHT=0]="ALPHA_STRAIGHT",r[r.ALPHA_PREMULTIPLIED=1]="ALPHA_PREMULTIPLIED"}(sf||(sf={})),function(r){r[r.RGB=0]="RGB",r[r.RRR=3]="RRR",r[r.GGG=4]="GGG",r[r.AAA=15]="AAA"}(rf||(rf={})),function(r){r[r.RGB=0]="RGB",r[r.RGBA=3]="RGBA",r[r.RRR=4]="RRR",r[r.RRRG=5]="RRRG"}(of||(of={}));const di=[171,75,84,88,32,50,48,187,13,10,26,10];function nS(r){const e=new Uint8Array(r);return!(e.byteLength<di.length||e[0]!==di[0]||e[1]!==di[1]||e[2]!==di[2]||e[3]!==di[3]||e[4]!==di[4]||e[5]!==di[5]||e[6]!==di[6]||e[7]!==di[7]||e[8]!==di[8]||e[9]!==di[9]||e[10]!==di[10]||e[11]!==di[11])}const aS={etc1:{basisFormat:0,compressed:!0,format:ur.COMPRESSED_RGB_ETC1_WEBGL},etc2:{basisFormat:1,compressed:!0},bc1:{basisFormat:2,compressed:!0,format:ur.COMPRESSED_RGB_S3TC_DXT1_EXT},bc3:{basisFormat:3,compressed:!0,format:ur.COMPRESSED_RGBA_S3TC_DXT5_EXT},bc4:{basisFormat:4,compressed:!0},bc5:{basisFormat:5,compressed:!0},"bc7-m6-opaque-only":{basisFormat:6,compressed:!0},"bc7-m5":{basisFormat:7,compressed:!0},"pvrtc1-4-rgb":{basisFormat:8,compressed:!0,format:ur.COMPRESSED_RGB_PVRTC_4BPPV1_IMG},"pvrtc1-4-rgba":{basisFormat:9,compressed:!0,format:ur.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG},"astc-4x4":{basisFormat:10,compressed:!0,format:ur.COMPRESSED_RGBA_ASTC_4X4_KHR},"atc-rgb":{basisFormat:11,compressed:!0},"atc-rgba-interpolated-alpha":{basisFormat:12,compressed:!0},rgba32:{basisFormat:13,compressed:!1},rgb565:{basisFormat:14,compressed:!1},bgr565:{basisFormat:15,compressed:!1},rgba4444:{basisFormat:16,compressed:!1}};async function AS(r,e){if(e.basis.containerFormat==="auto"){if(nS(r)){const i=await Yp(e);return nf(i.KTX2File,r,e)}const{BasisFile:t}=await Xp(e);return Bl(t,r,e)}switch(e.basis.module){case"encoder":const t=await Yp(e);switch(e.basis.containerFormat){case"ktx2":return nf(t.KTX2File,r,e);case"basis":default:return Bl(t.BasisFile,r,e)}case"transcoder":default:const{BasisFile:i}=await Xp(e);return Bl(i,r,e)}}function Bl(r,e,t){const i=new r(new Uint8Array(e));try{if(!i.startTranscoding())throw new Error("Failed to start basis transcoding");const s=i.getNumImages(),o=[];for(let n=0;n<s;n++){const a=i.getNumLevels(n),A=[];for(let l=0;l<a;l++)A.push(lS(i,n,l,t));o.push(A)}return o}finally{i.close(),i.delete()}}function lS(r,e,t,i){const s=r.getImageWidth(e,t),o=r.getImageHeight(e,t),n=r.getHasAlpha(),{compressed:a,format:A,basisFormat:l}=Sm(i,n),h=r.getImageTranscodedSizeInBytes(e,t,l),d=new Uint8Array(h);if(!r.transcodeImage(d,e,t,l,0,0))throw new Error("failed to start Basis transcoding");return{width:s,height:o,data:d,compressed:a,format:A,hasAlpha:n}}function nf(r,e,t){const i=new r(new Uint8Array(e));try{if(!i.startTranscoding())throw new Error("failed to start KTX2 transcoding");const s=i.getLevels(),o=[];for(let n=0;n<s;n++){o.push(cS(i,n,t));break}return[o]}finally{i.close(),i.delete()}}function cS(r,e,t){const{alphaFlag:i,height:s,width:o}=r.getImageLevelInfo(e,0,0),{compressed:n,format:a,basisFormat:A}=Sm(t,i),l=r.getImageTranscodedSizeInBytes(e,0,0,A),h=new Uint8Array(l);if(!r.transcodeImage(h,e,0,0,A,0,-1,-1))throw new Error("Failed to transcode KTX2 image");return{width:o,height:s,data:h,compressed:n,hasAlpha:i,format:a}}function Sm(r,e){let t=r&&r.basis&&r.basis.format;return t==="auto"&&(t=Tm()),typeof t=="object"&&(t=e?t.alpha:t.noAlpha),t=t.toLowerCase(),aS[t]}function Tm(){const r=rS();return r.has("astc")?"astc-4x4":r.has("dxt")?{alpha:"bc3",noAlpha:"bc1"}:r.has("pvrtc")?{alpha:"pvrtc1-4-rgba",noAlpha:"pvrtc1-4-rgb"}:r.has("etc1")?"etc1":r.has("etc2")?"etc2":"rgb565"}const hS={name:"Basis",id:"basis",module:"textures",version:J2,worker:!0,extensions:["basis","ktx2"],mimeTypes:["application/octet-stream","image/ktx2"],tests:["sB"],binary:!0,options:{basis:{format:"auto",libraryPath:"libs/",containerFormat:"auto",module:"transcoder"}}},uS={...hS,parse:AS},dS="3.2.6",{_parseImageNode:pS}=globalThis,uc=typeof Image<"u",dc=typeof ImageBitmap<"u",fS=!!pS,pc=Fr?!0:fS;function gS(r){switch(r){case"auto":return dc||uc||pc;case"imagebitmap":return dc;case"image":return uc;case"data":return pc;default:throw new Error("@loaders.gl/images: image ".concat(r," not supported in this environment"))}}function mS(){if(dc)return"imagebitmap";if(uc)return"image";if(pc)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}function _S(r){const e=BS(r);if(!e)throw new Error("Not an image");return e}function vS(r){switch(_S(r)){case"data":return r;case"image":case"imagebitmap":const e=document.createElement("canvas"),t=e.getContext("2d");if(!t)throw new Error("getImageData");return e.width=r.width,e.height=r.height,t.drawImage(r,0,0),t.getImageData(0,0,r.width,r.height);default:throw new Error("getImageData")}}function BS(r){return typeof ImageBitmap<"u"&&r instanceof ImageBitmap?"imagebitmap":typeof Image<"u"&&r instanceof Image?"image":r&&typeof r=="object"&&r.data&&r.width&&r.height?"data":null}const PS=/^data:image\/svg\+xml/,yS=/\.svg((\?|#).*)?$/;function Tc(r){return r&&(PS.test(r)||yS.test(r))}function xS(r,e){if(Tc(e)){let i=new TextDecoder().decode(r);try{typeof unescape=="function"&&typeof encodeURIComponent=="function"&&(i=unescape(encodeURIComponent(i)))}catch(o){throw new Error(o.message)}return"data:image/svg+xml;base64,".concat(btoa(i))}return Dm(r,e)}function Dm(r,e){if(Tc(e))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(r)])}async function Rm(r,e,t){const i=xS(r,t),s=self.URL||self.webkitURL,o=typeof i!="string"&&s.createObjectURL(i);try{return await wS(o||i,e)}finally{o&&s.revokeObjectURL(o)}}async function wS(r,e){const t=new Image;return t.src=r,e.image&&e.image.decode&&t.decode?(await t.decode(),t):await new Promise((i,s)=>{try{t.onload=()=>i(t),t.onerror=o=>s(new Error("Could not load image ".concat(r,": ").concat(o)))}catch(o){s(o)}})}const bS={};let af=!0;async function CS(r,e,t){let i;Tc(t)?i=await Rm(r,e,t):i=Dm(r,t);const s=e&&e.imagebitmap;return await ES(i,s)}async function ES(r,e=null){if((IS(e)||!af)&&(e=null),e)try{return await createImageBitmap(r,e)}catch(t){console.warn(t),af=!1}return await createImageBitmap(r)}function IS(r){for(const e in r||bS)return!1;return!0}const Ni=!1,Fo=!0;function Dc(r){const e=Ko(r);return FS(e)||TS(e)||MS(e)||SS(e)}function FS(r){const e=Ko(r);return e.byteLength>=24&&e.getUint32(0,Ni)===2303741511?{mimeType:"image/png",width:e.getUint32(16,Ni),height:e.getUint32(20,Ni)}:null}function MS(r){const e=Ko(r);return e.byteLength>=10&&e.getUint32(0,Ni)===1195984440?{mimeType:"image/gif",width:e.getUint16(6,Fo),height:e.getUint16(8,Fo)}:null}function SS(r){const e=Ko(r);return e.byteLength>=14&&e.getUint16(0,Ni)===16973&&e.getUint32(2,Fo)===e.byteLength?{mimeType:"image/bmp",width:e.getUint32(18,Fo),height:e.getUint32(22,Fo)}:null}function TS(r){const e=Ko(r);if(!(e.byteLength>=3&&e.getUint16(0,Ni)===65496&&e.getUint8(2)===255))return null;const{tableMarkers:i,sofMarkers:s}=DS();let o=2;for(;o+9<e.byteLength;){const n=e.getUint16(o,Ni);if(s.has(n))return{mimeType:"image/jpeg",height:e.getUint16(o+5,Ni),width:e.getUint16(o+7,Ni)};if(!i.has(n))return null;o+=2,o+=e.getUint16(o,Ni)}return null}function DS(){const r=new Set([65499,65476,65484,65501,65534]);for(let t=65504;t<65520;++t)r.add(t);return{tableMarkers:r,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}function Ko(r){if(r instanceof DataView)return r;if(ArrayBuffer.isView(r))return new DataView(r.buffer);if(r instanceof ArrayBuffer)return new DataView(r);throw new Error("toDataView")}async function RS(r,e){const{mimeType:t}=Dc(r)||{},i=globalThis._parseImageNode;return ls(i),await i(r,t)}async function LS(r,e,t){e=e||{};const s=(e.image||{}).type||"auto",{url:o}=t||{},n=US(s);let a;switch(n){case"imagebitmap":a=await CS(r,e,o);break;case"image":a=await Rm(r,e,o);break;case"data":a=await RS(r);break;default:ls(!1)}return s==="data"&&(a=vS(a)),a}function US(r){switch(r){case"auto":case"data":return mS();default:return gS(r),r}}const OS=["png","jpg","jpeg","gif","webp","bmp","ico","svg"],kS=["image/png","image/jpeg","image/gif","image/webp","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],NS={image:{type:"auto",decode:!0}},QS={id:"image",module:"images",name:"Images",version:dS,mimeTypes:kS,extensions:OS,parse:LS,tests:[r=>!!Dc(new DataView(r))],options:NS},HS=["image/png","image/jpeg","image/gif"],Pl={};function VS(r){return Pl[r]===void 0&&(Pl[r]=GS(r)),Pl[r]}function GS(r){switch(r){case"image/webp":return jS();case"image/svg":return Fr;default:if(!Fr){const{_parseImageNode:e}=globalThis;return!!e&&HS.includes(r)}return!0}}function jS(){if(!Fr)return!1;try{return document.createElement("canvas").toDataURL("image/webp").indexOf("data:image/webp")===0}catch{return!1}}function gi(r,e){if(!r)throw new Error(e||"assert failed: gltf")}function Lm(r,e){if(r.startsWith("data:")||r.startsWith("http:")||r.startsWith("https:"))return r;const i=e.baseUri||e.uri;if(!i)throw new Error("'baseUri' must be provided to resolve relative url ".concat(r));return i.substr(0,i.lastIndexOf("/")+1)+r}function zS(r,e,t){const i=r.bufferViews[t];gi(i);const s=i.buffer,o=e[s];gi(o);const n=(i.byteOffset||0)+o.byteOffset;return new Uint8Array(o.arrayBuffer,n,i.byteLength)}const Af=["SCALAR","VEC2","VEC3","VEC4"],KS=[[Int8Array,5120],[Uint8Array,5121],[Int16Array,5122],[Uint16Array,5123],[Uint32Array,5125],[Float32Array,5126],[Float64Array,5130]],WS=new Map(KS),XS={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},YS={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},JS={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};function Um(r){return Af[r-1]||Af[0]}function Om(r){const e=WS.get(r.constructor);if(!e)throw new Error("Illegal typed array");return e}function km(r,e){const t=JS[r.componentType],i=XS[r.type],s=YS[r.componentType],o=r.count*i,n=r.count*i*s;return gi(n>=0&&n<=e.byteLength),{ArrayType:t,length:o,byteLength:n}}const ZS={asset:{version:"2.0",generator:"loaders.gl"},buffers:[]};class Ei{constructor(e){He(this,"gltf",void 0),He(this,"sourceBuffers",void 0),He(this,"byteLength",void 0),this.gltf=e||{json:{...ZS},buffers:[]},this.sourceBuffers=[],this.byteLength=0,this.gltf.buffers&&this.gltf.buffers[0]&&(this.byteLength=this.gltf.buffers[0].byteLength,this.sourceBuffers=[this.gltf.buffers[0]])}get json(){return this.gltf.json}getApplicationData(e){return this.json[e]}getExtraData(e){return(this.json.extras||{})[e]}getExtension(e){const t=this.getUsedExtensions().find(s=>s===e),i=this.json.extensions||{};return t?i[e]||!0:null}getRequiredExtension(e){return this.getRequiredExtensions().find(i=>i===e)?this.getExtension(e):null}getRequiredExtensions(){return this.json.extensionsRequired||[]}getUsedExtensions(){return this.json.extensionsUsed||[]}getObjectExtension(e,t){return(e.extensions||{})[t]}getScene(e){return this.getObject("scenes",e)}getNode(e){return this.getObject("nodes",e)}getSkin(e){return this.getObject("skins",e)}getMesh(e){return this.getObject("meshes",e)}getMaterial(e){return this.getObject("materials",e)}getAccessor(e){return this.getObject("accessors",e)}getTexture(e){return this.getObject("textures",e)}getSampler(e){return this.getObject("samplers",e)}getImage(e){return this.getObject("images",e)}getBufferView(e){return this.getObject("bufferViews",e)}getBuffer(e){return this.getObject("buffers",e)}getObject(e,t){if(typeof t=="object")return t;const i=this.json[e]&&this.json[e][t];if(!i)throw new Error("glTF file error: Could not find ".concat(e,"[").concat(t,"]"));return i}getTypedArrayForBufferView(e){e=this.getBufferView(e);const t=e.buffer,i=this.gltf.buffers[t];gi(i);const s=(e.byteOffset||0)+i.byteOffset;return new Uint8Array(i.arrayBuffer,s,e.byteLength)}getTypedArrayForAccessor(e){e=this.getAccessor(e);const t=this.getBufferView(e.bufferView),s=this.getBuffer(t.buffer).data,{ArrayType:o,length:n}=km(e,t),a=t.byteOffset+e.byteOffset;return new o(s,a,n)}getTypedArrayForImageData(e){e=this.getAccessor(e);const t=this.getBufferView(e.bufferView),s=this.getBuffer(t.buffer).data,o=t.byteOffset||0;return new Uint8Array(s,o,t.byteLength)}addApplicationData(e,t){return this.json[e]=t,this}addExtraData(e,t){return this.json.extras=this.json.extras||{},this.json.extras[e]=t,this}addObjectExtension(e,t,i){return e.extensions=e.extensions||{},e.extensions[t]=i,this.registerUsedExtension(t),this}setObjectExtension(e,t,i){const s=e.extensions||{};s[t]=i}removeObjectExtension(e,t){const i=e.extensions||{},s=i[t];return delete i[t],s}addExtension(e,t={}){return gi(t),this.json.extensions=this.json.extensions||{},this.json.extensions[e]=t,this.registerUsedExtension(e),t}addRequiredExtension(e,t={}){return gi(t),this.addExtension(e,t),this.registerRequiredExtension(e),t}registerUsedExtension(e){this.json.extensionsUsed=this.json.extensionsUsed||[],this.json.extensionsUsed.find(t=>t===e)||this.json.extensionsUsed.push(e)}registerRequiredExtension(e){this.registerUsedExtension(e),this.json.extensionsRequired=this.json.extensionsRequired||[],this.json.extensionsRequired.find(t=>t===e)||this.json.extensionsRequired.push(e)}removeExtension(e){this.json.extensionsRequired&&this._removeStringFromArray(this.json.extensionsRequired,e),this.json.extensionsUsed&&this._removeStringFromArray(this.json.extensionsUsed,e),this.json.extensions&&delete this.json.extensions[e]}setDefaultScene(e){this.json.scene=e}addScene(e){const{nodeIndices:t}=e;return this.json.scenes=this.json.scenes||[],this.json.scenes.push({nodes:t}),this.json.scenes.length-1}addNode(e){const{meshIndex:t,matrix:i}=e;this.json.nodes=this.json.nodes||[];const s={mesh:t};return i&&(s.matrix=i),this.json.nodes.push(s),this.json.nodes.length-1}addMesh(e){const{attributes:t,indices:i,material:s,mode:o=4}=e,a={primitives:[{attributes:this._addAttributes(t),mode:o}]};if(i){const A=this._addIndices(i);a.primitives[0].indices=A}return Number.isFinite(s)&&(a.primitives[0].material=s),this.json.meshes=this.json.meshes||[],this.json.meshes.push(a),this.json.meshes.length-1}addPointCloud(e){const i={primitives:[{attributes:this._addAttributes(e),mode:0}]};return this.json.meshes=this.json.meshes||[],this.json.meshes.push(i),this.json.meshes.length-1}addImage(e,t){const i=Dc(e),s=t||(i==null?void 0:i.mimeType),n={bufferView:this.addBufferView(e),mimeType:s};return this.json.images=this.json.images||[],this.json.images.push(n),this.json.images.length-1}addBufferView(e){const t=e.byteLength;gi(Number.isFinite(t)),this.sourceBuffers=this.sourceBuffers||[],this.sourceBuffers.push(e);const i={buffer:0,byteOffset:this.byteLength,byteLength:t};return this.byteLength+=Vo(t,4),this.json.bufferViews=this.json.bufferViews||[],this.json.bufferViews.push(i),this.json.bufferViews.length-1}addAccessor(e,t){const i={bufferView:e,type:Um(t.size),componentType:t.componentType,count:t.count,max:t.max,min:t.min};return this.json.accessors=this.json.accessors||[],this.json.accessors.push(i),this.json.accessors.length-1}addBinaryBuffer(e,t={size:3}){const i=this.addBufferView(e);let s={min:t.min,max:t.max};(!s.min||!s.max)&&(s=this._getAccessorMinMax(e,t.size));const o={size:t.size,componentType:Om(e),count:Math.round(e.length/t.size),min:s.min,max:s.max};return this.addAccessor(i,Object.assign(o,t))}addTexture(e){const{imageIndex:t}=e,i={source:t};return this.json.textures=this.json.textures||[],this.json.textures.push(i),this.json.textures.length-1}addMaterial(e){return this.json.materials=this.json.materials||[],this.json.materials.push(e),this.json.materials.length-1}createBinaryChunk(){var e,t;this.gltf.buffers=[];const i=this.byteLength,s=new ArrayBuffer(i),o=new Uint8Array(s);let n=0;for(const a of this.sourceBuffers||[])n=xM(a,o,n);(e=this.json)!==null&&e!==void 0&&(t=e.buffers)!==null&&t!==void 0&&t[0]?this.json.buffers[0].byteLength=i:this.json.buffers=[{byteLength:i}],this.gltf.binary=s,this.sourceBuffers=[s]}_removeStringFromArray(e,t){let i=!0;for(;i;){const s=e.indexOf(t);s>-1?e.splice(s,1):i=!1}}_addAttributes(e={}){const t={};for(const i in e){const s=e[i],o=this._getGltfAttributeName(i),n=this.addBinaryBuffer(s.value,s);t[o]=n}return t}_addIndices(e){return this.addBinaryBuffer(e,{size:1})}_getGltfAttributeName(e){switch(e.toLowerCase()){case"position":case"positions":case"vertices":return"POSITION";case"normal":case"normals":return"NORMAL";case"color":case"colors":return"COLOR_0";case"texcoord":case"texcoords":return"TEXCOORD_0";default:return e}}_getAccessorMinMax(e,t){const i={min:null,max:null};if(e.length<t)return i;i.min=[],i.max=[];const s=e.subarray(0,t);for(const o of s)i.min.push(o),i.max.push(o);for(let o=t;o<e.length;o+=t)for(let n=0;n<t;n++)i.min[0+n]=Math.min(i.min[0+n],e[o+n]),i.max[0+n]=Math.max(i.max[0+n],e[o+n]);return i}}const qS="B9h9z9tFBBBF8fL9gBB9gLaaaaaFa9gEaaaB9gFaFa9gEaaaFaEMcBFFFGGGEIIILF9wFFFLEFBFKNFaFCx/IFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBF8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBGy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBEn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBIi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBKI9z9iqlBOc+x8ycGBM/qQFTa8jUUUUBCU/EBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAGTkUUUBRNCUoBAG9uC/wgBZHKCUGAKCUG9JyRVAECFJRICBRcGXEXAcAF9PQFAVAFAclAcAVJAF9JyRMGXGXAG9FQBAMCbJHKC9wZRSAKCIrCEJCGrRQANCUGJRfCBRbAIRTEXGXAOATlAQ9PQBCBRISEMATAQJRIGXAS9FQBCBRtCBREEXGXAOAIlCi9PQBCBRISLMANCU/CBJAEJRKGXGXGXGXGXATAECKrJ2BBAtCKZrCEZfIBFGEBMAKhB83EBAKCNJhB83EBSEMAKAI2BIAI2BBHmCKrHYAYCE6HYy86BBAKCFJAICIJAYJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCGJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCEJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCIJAYAmJHY2BBAI2BFHmCKrHPAPCE6HPy86BBAKCLJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCKJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCOJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCNJAYAmJHY2BBAI2BGHmCKrHPAPCE6HPy86BBAKCVJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCcJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCMJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCSJAYAmJHm2BBAI2BEHICKrHYAYCE6HYy86BBAKCQJAmAYJHm2BBAICIrCEZHYAYCE6HYy86BBAKCfJAmAYJHm2BBAICGrCEZHYAYCE6HYy86BBAKCbJAmAYJHK2BBAICEZHIAICE6HIy86BBAKAIJRISGMAKAI2BNAI2BBHmCIrHYAYCb6HYy86BBAKCFJAICNJAYJHY2BBAmCbZHmAmCb6Hmy86BBAKCGJAYAmJHm2BBAI2BFHYCIrHPAPCb6HPy86BBAKCEJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCIJAmAYJHm2BBAI2BGHYCIrHPAPCb6HPy86BBAKCLJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCKJAmAYJHm2BBAI2BEHYCIrHPAPCb6HPy86BBAKCOJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCNJAmAYJHm2BBAI2BIHYCIrHPAPCb6HPy86BBAKCVJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCcJAmAYJHm2BBAI2BLHYCIrHPAPCb6HPy86BBAKCMJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCSJAmAYJHm2BBAI2BKHYCIrHPAPCb6HPy86BBAKCQJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCfJAmAYJHm2BBAI2BOHICIrHYAYCb6HYy86BBAKCbJAmAYJHK2BBAICbZHIAICb6HIy86BBAKAIJRISFMAKAI8pBB83BBAKCNJAICNJ8pBB83BBAICTJRIMAtCGJRtAECTJHEAS9JQBMMGXAIQBCBRISEMGXAM9FQBANAbJ2BBRtCBRKAfREEXAEANCU/CBJAKJ2BBHTCFrCBATCFZl9zAtJHt86BBAEAGJREAKCFJHKAM9HQBMMAfCFJRfAIRTAbCFJHbAG9HQBMMABAcAG9sJANCUGJAMAG9sTkUUUBpANANCUGJAMCaJAG9sJAGTkUUUBpMAMCBAIyAcJRcAIQBMC9+RKSFMCBC99AOAIlAGCAAGCA9Ly6yRKMALCU/EBJ8kUUUUBAKM+OmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUFT+JUUUBpALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM+lLKFaF99GaG99FaG99GXGXAGCI9HQBAF9FQFEXGXGX9DBBB8/9DBBB+/ABCGJHG1BB+yAB1BBHE+yHI+L+TABCFJHL1BBHK+yHO+L+THN9DBBBB9gHVyAN9DBB/+hANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE86BBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG86BBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG86BBABCIJRBAFCaJHFQBSGMMAF9FQBEXGXGX9DBBB8/9DBBB+/ABCIJHG8uFB+yAB8uFBHE+yHI+L+TABCGJHL8uFBHK+yHO+L+THN9DBBBB9gHVyAN9DB/+g6ANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE87FBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG87FBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG87FBABCNJRBAFCaJHFQBMMM/SEIEaE99EaF99GXAF9FQBCBREABRIEXGXGX9D/zI818/AICKJ8uFBHLCEq+y+VHKAI8uFB+y+UHO9DB/+g6+U9DBBB8/9DBBB+/AO9DBBBB9gy+SHN+L9DBBB9P9d9FQBAN+oRVSFMCUUUU94RVMAICIJ8uFBRcAICGJ8uFBRMABALCFJCEZAEqCFWJAV87FBGXGXAKAM+y+UHN9DB/+g6+U9DBBB8/9DBBB+/AN9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRMSFMCUUUU94RMMABALCGJCEZAEqCFWJAM87FBGXGXAKAc+y+UHK9DB/+g6+U9DBBB8/9DBBB+/AK9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRcSFMCUUUU94RcMABALCaJCEZAEqCFWJAc87FBGXGX9DBBU8/AOAO+U+TANAN+U+TAKAK+U+THO9DBBBBAO9DBBBB9gy+R9DB/+g6+U9DBBB8/+SHO+L9DBBB9P9d9FQBAO+oRcSFMCUUUU94RcMABALCEZAEqCFWJAc87FBAICNJRIAECIJREAFCaJHFQBMMM9JBGXAGCGrAF9sHF9FQBEXABAB8oGBHGCNWCN91+yAGCi91CnWCUUU/8EJ+++U84GBABCIJRBAFCaJHFQBMMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEM/lFFFaGXGXAFABqCEZ9FQBABRESFMGXGXAGCT9PQBABRESFMABREEXAEAF8oGBjGBAECIJAFCIJ8oGBjGBAECNJAFCNJ8oGBjGBAECSJAFCSJ8oGBjGBAECTJREAFCTJRFAGC9wJHGCb9LQBMMAGCI9JQBEXAEAF8oGBjGBAFCIJRFAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF2BB86BBAECFJREAFCFJRFAGCaJHGQBMMABMoFFGaGXGXABCEZ9FQBABRESFMAFCgFZC+BwsN9sRIGXGXAGCT9PQBABRESFMABREEXAEAIjGBAECSJAIjGBAECNJAIjGBAECIJAIjGBAECTJREAGC9wJHGCb9LQBMMAGCI9JQBEXAEAIjGBAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF86BBAECFJREAGCaJHGQBMMABMMMFBCUNMIT9kBB",$S="B9h9z9tFBBBF8dL9gBB9gLaaaaaFa9gEaaaB9gGaaB9gFaFaEQSBBFBFFGEGEGIILF9wFFFLEFBFKNFaFCx/aFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBG8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBIy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBKi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBNn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBcI9z9iqlBMc/j9JSIBTEM9+FLa8jUUUUBCTlRBCBRFEXCBRGCBREEXABCNJAGJAECUaAFAGrCFZHIy86BBAEAIJREAGCFJHGCN9HQBMAFCx+YUUBJAE86BBAFCEWCxkUUBJAB8pEN83EBAFCFJHFCUG9HQBMMkRIbaG97FaK978jUUUUBCU/KBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAG/8cBBCUoBAG9uC/wgBZHKCUGAKCUG9JyRNAECFJRKCBRVGXEXAVAF9PQFANAFAVlAVANJAF9JyRcGXGXAG9FQBAcCbJHIC9wZHMCE9sRSAMCFWRQAICIrCEJCGrRfCBRbEXAKRTCBRtGXEXGXAOATlAf9PQBCBRKSLMALCU/CBJAtAM9sJRmATAfJRKCBREGXAMCoB9JQBAOAKlC/gB9JQBCBRIEXAmAIJREGXGXGXGXGXATAICKrJ2BBHYCEZfIBFGEBMAECBDtDMIBSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAEAKDBBBDMIBAKCTJRKMGXGXGXGXGXAYCGrCEZfIBFGEBMAECBDtDMITSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAEAKDBBBDMITAKCTJRKMGXGXGXGXGXAYCIrCEZfIBFGEBMAECBDtDMIASEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAEAKDBBBDMIAAKCTJRKMGXGXGXGXGXAYCKrfIBFGEBMAECBDtDMI8wSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCIJAnDeBJAYCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCNJAnDeBJAYCx+YUUBJ2BBJRKSFMAEAKDBBBDMI8wAKCTJRKMAICoBJREAICUFJAM9LQFAERIAOAKlC/fB9LQBMMGXAEAM9PQBAECErRIEXGXAOAKlCi9PQBCBRKSOMAmAEJRYGXGXGXGXGXATAECKrJ2BBAICKZrCEZfIBFGEBMAYCBDtDMIBSEMAYAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAYAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAYAKDBBBDMIBAKCTJRKMAICGJRIAECTJHEAM9JQBMMGXAK9FQBAKRTAtCFJHtCI6QGSFMMCBRKSEMGXAM9FQBALCUGJAbJREALAbJDBGBRnCBRYEXAEALCU/CBJAYJHIDBIBHdCFD9tAdCFDbHPD9OD9hD9RHdAIAMJDBIBHiCFD9tAiAPD9OD9hD9RHiDQBTFtGmEYIPLdKeOnH8ZAIAQJDBIBHpCFD9tApAPD9OD9hD9RHpAIASJDBIBHyCFD9tAyAPD9OD9hD9RHyDQBTFtGmEYIPLdKeOnH8cDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGEAnD9uHnDyBjGBAEAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJHIAnA8ZA8cDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHnDyBjGBAIAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJHIAnAdAiDQNiV8ZcpMyS8cQ8df8eb8fHdApAyDQNiV8ZcpMyS8cQ8df8eb8fHiDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGED9uHnDyBjGBAIAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJHIAnAdAiDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHnDyBjGBAIAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJREAYCTJHYAM9JQBMMAbCIJHbAG9JQBMMABAVAG9sJALCUGJAcAG9s/8cBBALALCUGJAcCaJAG9sJAG/8cBBMAcCBAKyAVJRVAKQBMC9+RKSFMCBC99AOAKlAGCAAGCA9Ly6yRKMALCU/KBJ8kUUUUBAKMNBT+BUUUBM+KmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUF/8MBALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM/xLGEaK978jUUUUBCAlHE8kUUUUBGXGXAGCI9HQBGXAFC98ZHI9FQBABRGCBRLEXAGAGDBBBHKCiD+rFCiD+sFD/6FHOAKCND+rFCiD+sFD/6FAOD/gFAKCTD+rFCiD+sFD/6FHND/gFD/kFD/lFHVCBDtD+2FHcAOCUUUU94DtHMD9OD9RD/kFHO9DBB/+hDYAOAOD/mFAVAVD/mFANAcANAMD9OD9RD/kFHOAOD/mFD/kFD/kFD/jFD/nFHND/mF9DBBX9LDYHcD/kFCgFDtD9OAKCUUU94DtD9OD9QAOAND/mFAcD/kFCND+rFCU/+EDtD9OD9QAVAND/mFAcD/kFCTD+rFCUU/8ODtD9OD9QDMBBAGCTJRGALCIJHLAI9JQBMMAIAF9PQFAEAFCEZHLCGWHGqCBCTAGl/8MBAEABAICGWJHIAG/8cBBGXAL9FQBAEAEDBIBHKCiD+rFCiD+sFD/6FHOAKCND+rFCiD+sFD/6FAOD/gFAKCTD+rFCiD+sFD/6FHND/gFD/kFD/lFHVCBDtD+2FHcAOCUUUU94DtHMD9OD9RD/kFHO9DBB/+hDYAOAOD/mFAVAVD/mFANAcANAMD9OD9RD/kFHOAOD/mFD/kFD/kFD/jFD/nFHND/mF9DBBX9LDYHcD/kFCgFDtD9OAKCUUU94DtD9OD9QAOAND/mFAcD/kFCND+rFCU/+EDtD9OD9QAVAND/mFAcD/kFCTD+rFCUU/8ODtD9OD9QDMIBMAIAEAG/8cBBSFMABAFC98ZHGT+HUUUBAGAF9PQBAEAFCEZHICEWHLJCBCAALl/8MBAEABAGCEWJHGAL/8cBBAEAIT+HUUUBAGAEAL/8cBBMAECAJ8kUUUUBM+yEGGaO97GXAF9FQBCBRGEXABCTJHEAEDBBBHICBDtHLCUU98D8cFCUU98D8cEHKD9OABDBBBHOAIDQILKOSQfbPden8c8d8e8fCggFDtD9OD/6FAOAIDQBFGENVcMTtmYi8ZpyHICTD+sFD/6FHND/gFAICTD+rFCTD+sFD/6FHVD/gFD/kFD/lFHI9DB/+g6DYAVAIALD+2FHLAVCUUUU94DtHcD9OD9RD/kFHVAVD/mFAIAID/mFANALANAcD9OD9RD/kFHIAID/mFD/kFD/kFD/jFD/nFHND/mF9DBBX9LDYHLD/kFCTD+rFAVAND/mFALD/kFCggEDtD9OD9QHVAIAND/mFALD/kFCaDbCBDnGCBDnECBDnKCBDnOCBDncCBDnMCBDnfCBDnbD9OHIDQNVi8ZcMpySQ8c8dfb8e8fD9QDMBBABAOAKD9OAVAIDQBFTtGEmYILPdKOenD9QDMBBABCAJRBAGCIJHGAF9JQBMMM94FEa8jUUUUBCAlHE8kUUUUBABAFC98ZHIT+JUUUBGXAIAF9PQBAEAFCEZHLCEWHFJCBCAAFl/8MBAEABAICEWJHBAF/8cBBAEALT+JUUUBABAEAF/8cBBMAECAJ8kUUUUBM/hEIGaF97FaL978jUUUUBCTlRGGXAF9FQBCBREEXAGABDBBBHIABCTJHLDBBBHKDQILKOSQfbPden8c8d8e8fHOCTD+sFHNCID+rFDMIBAB9DBBU8/DY9D/zI818/DYANCEDtD9QD/6FD/nFHNAIAKDQBFGENVcMTtmYi8ZpyHICTD+rFCTD+sFD/6FD/mFHKAKD/mFANAICTD+sFD/6FD/mFHVAVD/mFANAOCTD+rFCTD+sFD/6FD/mFHOAOD/mFD/kFD/kFD/lFCBDtD+4FD/jF9DB/+g6DYHND/mF9DBBX9LDYHID/kFCggEDtHcD9OAVAND/mFAID/kFCTD+rFD9QHVAOAND/mFAID/kFCTD+rFAKAND/mFAID/kFAcD9OD9QHNDQBFTtGEmYILPdKOenHID8dBAGDBIBDyB+t+J83EBABCNJAID8dFAGDBIBDyF+t+J83EBALAVANDQNVi8ZcMpySQ8c8dfb8e8fHND8dBAGDBIBDyG+t+J83EBABCiJAND8dFAGDBIBDyE+t+J83EBABCAJRBAECIJHEAF9JQBMMM/3FGEaF978jUUUUBCoBlREGXAGCGrAF9sHIC98ZHL9FQBCBRGABRFEXAFAFDBBBHKCND+rFCND+sFD/6FAKCiD+sFCnD+rFCUUU/8EDtD+uFD/mFDMBBAFCTJRFAGCIJHGAL9JQBMMGXALAI9PQBAEAICEZHGCGWHFqCBCoBAFl/8MBAEABALCGWJHLAF/8cBBGXAG9FQBAEAEDBIBHKCND+rFCND+sFD/6FAKCiD+sFCnD+rFCUUU/8EDtD+uFD/mFDMIBMALAEAF/8cBBMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEMMMFBCUNMIT9tBB",eT=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),tT=new Uint8Array([32,0,65,253,3,1,2,34,4,106,6,5,11,8,7,20,13,33,12,16,128,9,116,64,19,113,127,15,10,21,22,14,255,66,24,54,136,107,18,23,192,26,114,118,132,17,77,101,130,144,27,87,131,44,45,74,156,154,70,167]),iT={0:"",1:"meshopt_decodeFilterOct",2:"meshopt_decodeFilterQuat",3:"meshopt_decodeFilterExp",NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},sT={0:"meshopt_decodeVertexBuffer",1:"meshopt_decodeIndexBuffer",2:"meshopt_decodeIndexSequence",ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};async function rT(r,e,t,i,s,o="NONE"){const n=await oT();AT(n,n.exports[sT[s]],r,e,t,i,n.exports[iT[o||"NONE"]])}let yl;async function oT(){return yl||(yl=nT()),yl}async function nT(){let r=qS;WebAssembly.validate(eT)&&(r=$S,console.log("Warning: meshopt_decoder is using experimental SIMD support"));const e=await WebAssembly.instantiate(aT(r),{});return await e.instance.exports.__wasm_call_ctors(),e.instance}function aT(r){const e=new Uint8Array(r.length);for(let i=0;i<r.length;++i){const s=r.charCodeAt(i);e[i]=s>96?s-71:s>64?s-65:s>47?s+4:s>46?63:62}let t=0;for(let i=0;i<r.length;++i)e[t++]=e[i]<60?tT[e[i]]:(e[i]-60)*64+e[++i];return e.buffer.slice(0,t)}function AT(r,e,t,i,s,o,n){const a=r.exports.sbrk,A=i+3&-4,l=a(A*s),h=a(o.length),d=new Uint8Array(r.exports.memory.buffer);d.set(o,h);const f=e(l,i,s,h,o.length);if(f===0&&n&&n(l,A,s),t.set(d.subarray(l,l+i*s)),a(l-a(0)),f!==0)throw new Error("Malformed buffer data: ".concat(f))}const Rc="EXT_meshopt_compression",lT=Rc;async function cT(r,e){var t;const i=new Ei(r);if(!(e!=null&&(t=e.gltf)!==null&&t!==void 0&&t.decompressMeshes))return;const s=[];for(const o of r.json.bufferViews||[])s.push(hT(i,o));await Promise.all(s),i.removeExtension(Rc)}async function hT(r,e){const t=r.getObjectExtension(e,Rc);if(t){const{byteOffset:i=0,byteLength:s=0,byteStride:o,count:n,mode:a,filter:A="NONE",buffer:l}=t,h=r.gltf.buffers[l],d=new Uint8Array(h.arrayBuffer,h.byteOffset+i,s),f=new Uint8Array(r.gltf.buffers[e.buffer].arrayBuffer,e.byteOffset,e.byteLength);return await rT(f,n,o,d,a,A),f}return null}var uT=Object.freeze({__proto__:null,name:lT,decode:cT});const fr="EXT_texture_webp",dT=fr;function pT(r,e){const t=new Ei(r);if(!VS("image/webp")){if(t.getRequiredExtensions().includes(fr))throw new Error("gltf: Required extension ".concat(fr," not supported by browser"));return}const{json:i}=t;for(const s of i.textures||[]){const o=t.getObjectExtension(s,fr);o&&(s.source=o.source),t.removeObjectExtension(s,fr)}t.removeExtension(fr)}var fT=Object.freeze({__proto__:null,name:dT,preprocess:pT});const oa="KHR_texture_basisu",gT=oa;function mT(r,e){const t=new Ei(r),{json:i}=t;for(const s of i.textures||[]){const o=t.getObjectExtension(s,oa);o&&(s.source=o.source),t.removeObjectExtension(s,oa)}t.removeExtension(oa)}var _T=Object.freeze({__proto__:null,name:gT,preprocess:mT});const vT="3.2.6",BT={draco:{decoderType:typeof WebAssembly=="object"?"wasm":"js",libraryPath:"libs/",extraAttributes:{},attributeNameEntry:void 0}},PT={name:"Draco",id:"draco",module:"draco",shapes:["mesh"],version:vT,worker:!0,extensions:["drc"],mimeTypes:["application/octet-stream"],binary:!0,tests:["DRACO"],options:BT};function yT(r){let e=1/0,t=1/0,i=1/0,s=-1/0,o=-1/0,n=-1/0;const a=r.POSITION?r.POSITION.value:[],A=a&&a.length;for(let l=0;l<A;l+=3){const h=a[l],d=a[l+1],f=a[l+2];e=h<e?h:e,t=d<t?d:t,i=f<i?f:i,s=h>s?h:s,o=d>o?d:o,n=f>n?f:n}return[[e,t,i],[s,o,n]]}function xT(r,e){if(!r)throw new Error("loader assertion failed.")}class _r{constructor(e,t){He(this,"fields",void 0),He(this,"metadata",void 0),xT(Array.isArray(e)),wT(e),this.fields=e,this.metadata=t||new Map}compareTo(e){if(this.metadata!==e.metadata||this.fields.length!==e.fields.length)return!1;for(let t=0;t<this.fields.length;++t)if(!this.fields[t].compareTo(e.fields[t]))return!1;return!0}select(...e){const t=Object.create(null);for(const s of e)t[s]=!0;const i=this.fields.filter(s=>t[s.name]);return new _r(i,this.metadata)}selectAt(...e){const t=e.map(i=>this.fields[i]).filter(Boolean);return new _r(t,this.metadata)}assign(e){let t,i=this.metadata;if(e instanceof _r){const n=e;t=n.fields,i=lf(lf(new Map,this.metadata),n.metadata)}else t=e;const s=Object.create(null);for(const n of this.fields)s[n.name]=n;for(const n of t)s[n.name]=n;const o=Object.values(s);return new _r(o,i)}}function wT(r){const e={};for(const t of r)e[t.name]&&console.warn("Schema: duplicated field name",t.name,t),e[t.name]=!0}function lf(r,e){return new Map([...r||new Map,...e||new Map])}class wa{constructor(e,t,i=!1,s=new Map){He(this,"name",void 0),He(this,"type",void 0),He(this,"nullable",void 0),He(this,"metadata",void 0),this.name=e,this.type=t,this.nullable=i,this.metadata=s}get typeId(){return this.type&&this.type.typeId}clone(){return new wa(this.name,this.type,this.nullable,this.metadata)}compareTo(e){return this.name===e.name&&this.type===e.type&&this.nullable===e.nullable&&this.metadata===e.metadata}toString(){return"".concat(this.type).concat(this.nullable?", nullable":"").concat(this.metadata?", metadata: ".concat(this.metadata):"")}}let Et;(function(r){r[r.NONE=0]="NONE",r[r.Null=1]="Null",r[r.Int=2]="Int",r[r.Float=3]="Float",r[r.Binary=4]="Binary",r[r.Utf8=5]="Utf8",r[r.Bool=6]="Bool",r[r.Decimal=7]="Decimal",r[r.Date=8]="Date",r[r.Time=9]="Time",r[r.Timestamp=10]="Timestamp",r[r.Interval=11]="Interval",r[r.List=12]="List",r[r.Struct=13]="Struct",r[r.Union=14]="Union",r[r.FixedSizeBinary=15]="FixedSizeBinary",r[r.FixedSizeList=16]="FixedSizeList",r[r.Map=17]="Map",r[r.Dictionary=-1]="Dictionary",r[r.Int8=-2]="Int8",r[r.Int16=-3]="Int16",r[r.Int32=-4]="Int32",r[r.Int64=-5]="Int64",r[r.Uint8=-6]="Uint8",r[r.Uint16=-7]="Uint16",r[r.Uint32=-8]="Uint32",r[r.Uint64=-9]="Uint64",r[r.Float16=-10]="Float16",r[r.Float32=-11]="Float32",r[r.Float64=-12]="Float64",r[r.DateDay=-13]="DateDay",r[r.DateMillisecond=-14]="DateMillisecond",r[r.TimestampSecond=-15]="TimestampSecond",r[r.TimestampMillisecond=-16]="TimestampMillisecond",r[r.TimestampMicrosecond=-17]="TimestampMicrosecond",r[r.TimestampNanosecond=-18]="TimestampNanosecond",r[r.TimeSecond=-19]="TimeSecond",r[r.TimeMillisecond=-20]="TimeMillisecond",r[r.TimeMicrosecond=-21]="TimeMicrosecond",r[r.TimeNanosecond=-22]="TimeNanosecond",r[r.DenseUnion=-23]="DenseUnion",r[r.SparseUnion=-24]="SparseUnion",r[r.IntervalDayTime=-25]="IntervalDayTime",r[r.IntervalYearMonth=-26]="IntervalYearMonth"})(Et||(Et={}));let Nm,Qm,Hm;class Lc{static isNull(e){return e&&e.typeId===Et.Null}static isInt(e){return e&&e.typeId===Et.Int}static isFloat(e){return e&&e.typeId===Et.Float}static isBinary(e){return e&&e.typeId===Et.Binary}static isUtf8(e){return e&&e.typeId===Et.Utf8}static isBool(e){return e&&e.typeId===Et.Bool}static isDecimal(e){return e&&e.typeId===Et.Decimal}static isDate(e){return e&&e.typeId===Et.Date}static isTime(e){return e&&e.typeId===Et.Time}static isTimestamp(e){return e&&e.typeId===Et.Timestamp}static isInterval(e){return e&&e.typeId===Et.Interval}static isList(e){return e&&e.typeId===Et.List}static isStruct(e){return e&&e.typeId===Et.Struct}static isUnion(e){return e&&e.typeId===Et.Union}static isFixedSizeBinary(e){return e&&e.typeId===Et.FixedSizeBinary}static isFixedSizeList(e){return e&&e.typeId===Et.FixedSizeList}static isMap(e){return e&&e.typeId===Et.Map}static isDictionary(e){return e&&e.typeId===Et.Dictionary}get typeId(){return Et.NONE}compareTo(e){return this===e}}Nm=Symbol.toStringTag;class Ur extends Lc{constructor(e,t){super(),He(this,"isSigned",void 0),He(this,"bitWidth",void 0),this.isSigned=e,this.bitWidth=t}get typeId(){return Et.Int}get[Nm](){return"Int"}toString(){return"".concat(this.isSigned?"I":"Ui","nt").concat(this.bitWidth)}}class bT extends Ur{constructor(){super(!0,8)}}class CT extends Ur{constructor(){super(!0,16)}}class ET extends Ur{constructor(){super(!0,32)}}class IT extends Ur{constructor(){super(!1,8)}}class FT extends Ur{constructor(){super(!1,16)}}class MT extends Ur{constructor(){super(!1,32)}}const Vm={HALF:16,SINGLE:32,DOUBLE:64};Qm=Symbol.toStringTag;class Gm extends Lc{constructor(e){super(),He(this,"precision",void 0),this.precision=e}get typeId(){return Et.Float}get[Qm](){return"Float"}toString(){return"Float".concat(this.precision)}}class ST extends Gm{constructor(){super(Vm.SINGLE)}}class TT extends Gm{constructor(){super(Vm.DOUBLE)}}Hm=Symbol.toStringTag;class DT extends Lc{constructor(e,t){super(),He(this,"listSize",void 0),He(this,"children",void 0),this.listSize=e,this.children=[t]}get typeId(){return Et.FixedSizeList}get valueType(){return this.children[0].type}get valueField(){return this.children[0]}get[Hm](){return"FixedSizeList"}toString(){return"FixedSizeList[".concat(this.listSize,"]<").concat(this.valueType,">")}}function RT(r){switch(r.constructor){case Int8Array:return new bT;case Uint8Array:return new IT;case Int16Array:return new CT;case Uint16Array:return new FT;case Int32Array:return new ET;case Uint32Array:return new MT;case Float32Array:return new ST;case Float64Array:return new TT;default:throw new Error("array type not supported")}}function LT(r,e,t){const i=RT(e.value),s=t||UT(e);return new wa(r,new DT(e.size,new wa("value",i)),!1,s)}function UT(r){const e=new Map;return"byteOffset"in r&&e.set("byteOffset",r.byteOffset.toString(10)),"byteStride"in r&&e.set("byteStride",r.byteStride.toString(10)),"normalized"in r&&e.set("normalized",r.normalized.toString()),e}function OT(r,e,t){const i=jm(e.metadata),s=[],o=kT(e.attributes);for(const n in r){const a=r[n],A=cf(n,a,o[n]);s.push(A)}if(t){const n=cf("indices",t);s.push(n)}return new _r(s,i)}function kT(r){const e={};for(const t in r){const i=r[t];e[i.name||"undefined"]=i}return e}function cf(r,e,t){const i=t?jm(t.metadata):void 0;return LT(r,e,i)}function jm(r){const e=new Map;for(const t in r)e.set("".concat(t,".string"),JSON.stringify(r[t]));return e}const hf={POSITION:"POSITION",NORMAL:"NORMAL",COLOR:"COLOR_0",TEX_COORD:"TEXCOORD_0"},NT={1:Int8Array,2:Uint8Array,3:Int16Array,4:Uint16Array,5:Int32Array,6:Uint32Array,9:Float32Array},QT=4;class HT{constructor(e){He(this,"draco",void 0),He(this,"decoder",void 0),He(this,"metadataQuerier",void 0),this.draco=e,this.decoder=new this.draco.Decoder,this.metadataQuerier=new this.draco.MetadataQuerier}destroy(){this.draco.destroy(this.decoder),this.draco.destroy(this.metadataQuerier)}parseSync(e,t={}){const i=new this.draco.DecoderBuffer;i.Init(new Int8Array(e),e.byteLength),this._disableAttributeTransforms(t);const s=this.decoder.GetEncodedGeometryType(i),o=s===this.draco.TRIANGULAR_MESH?new this.draco.Mesh:new this.draco.PointCloud;try{let n;switch(s){case this.draco.TRIANGULAR_MESH:n=this.decoder.DecodeBufferToMesh(i,o);break;case this.draco.POINT_CLOUD:n=this.decoder.DecodeBufferToPointCloud(i,o);break;default:throw new Error("DRACO: Unknown geometry type.")}if(!n.ok()||!o.ptr){const f="DRACO decompression failed: ".concat(n.error_msg());throw new Error(f)}const a=this._getDracoLoaderData(o,s,t),A=this._getMeshData(o,a,t),l=yT(A.attributes),h=OT(A.attributes,a,A.indices);return{loader:"draco",loaderData:a,header:{vertexCount:o.num_points(),boundingBox:l},...A,schema:h}}finally{this.draco.destroy(i),o&&this.draco.destroy(o)}}_getDracoLoaderData(e,t,i){const s=this._getTopLevelMetadata(e),o=this._getDracoAttributes(e,i);return{geometry_type:t,num_attributes:e.num_attributes(),num_points:e.num_points(),num_faces:e instanceof this.draco.Mesh?e.num_faces():0,metadata:s,attributes:o}}_getDracoAttributes(e,t){const i={};for(let s=0;s<e.num_attributes();s++){const o=this.decoder.GetAttribute(e,s),n=this._getAttributeMetadata(e,s);i[o.unique_id()]={unique_id:o.unique_id(),attribute_type:o.attribute_type(),data_type:o.data_type(),num_components:o.num_components(),byte_offset:o.byte_offset(),byte_stride:o.byte_stride(),normalized:o.normalized(),attribute_index:s,metadata:n};const a=this._getQuantizationTransform(o,t);a&&(i[o.unique_id()].quantization_transform=a);const A=this._getOctahedronTransform(o,t);A&&(i[o.unique_id()].octahedron_transform=A)}return i}_getMeshData(e,t,i){const s=this._getMeshAttributes(t,e,i);if(!s.POSITION)throw new Error("DRACO: No position attribute found.");if(e instanceof this.draco.Mesh)switch(i.topology){case"triangle-strip":return{topology:"triangle-strip",mode:4,attributes:s,indices:{value:this._getTriangleStripIndices(e),size:1}};case"triangle-list":default:return{topology:"triangle-list",mode:5,attributes:s,indices:{value:this._getTriangleListIndices(e),size:1}}}return{topology:"point-list",mode:0,attributes:s}}_getMeshAttributes(e,t,i){const s={};for(const o of Object.values(e.attributes)){const n=this._deduceAttributeName(o,i);o.name=n;const{value:a,size:A}=this._getAttributeValues(t,o);s[n]={value:a,size:A,byteOffset:o.byte_offset,byteStride:o.byte_stride,normalized:o.normalized}}return s}_getTriangleListIndices(e){const i=e.num_faces()*3,s=i*QT,o=this.draco._malloc(s);try{return this.decoder.GetTrianglesUInt32Array(e,s,o),new Uint32Array(this.draco.HEAPF32.buffer,o,i).slice()}finally{this.draco._free(o)}}_getTriangleStripIndices(e){const t=new this.draco.DracoInt32Array;try{return this.decoder.GetTriangleStripsFromMesh(e,t),jT(t)}finally{this.draco.destroy(t)}}_getAttributeValues(e,t){const i=NT[t.data_type],s=t.num_components,n=e.num_points()*s,a=n*i.BYTES_PER_ELEMENT,A=VT(this.draco,i);let l;const h=this.draco._malloc(a);try{const d=this.decoder.GetAttribute(e,t.attribute_index);this.decoder.GetAttributeDataArrayForAllPoints(e,d,A,a,h),l=new i(this.draco.HEAPF32.buffer,h,n).slice()}finally{this.draco._free(h)}return{value:l,size:s}}_deduceAttributeName(e,t){const i=e.unique_id;for(const[n,a]of Object.entries(t.extraAttributes||{}))if(a===i)return n;const s=e.attribute_type;for(const n in hf)if(this.draco[n]===s)return hf[n];const o=t.attributeNameEntry||"name";return e.metadata[o]?e.metadata[o].string:"CUSTOM_ATTRIBUTE_".concat(i)}_getTopLevelMetadata(e){const t=this.decoder.GetMetadata(e);return this._getDracoMetadata(t)}_getAttributeMetadata(e,t){const i=this.decoder.GetAttributeMetadata(e,t);return this._getDracoMetadata(i)}_getDracoMetadata(e){if(!e||!e.ptr)return{};const t={},i=this.metadataQuerier.NumEntries(e);for(let s=0;s<i;s++){const o=this.metadataQuerier.GetEntryName(e,s);t[o]=this._getDracoMetadataField(e,o)}return t}_getDracoMetadataField(e,t){const i=new this.draco.DracoInt32Array;try{this.metadataQuerier.GetIntEntryArray(e,t,i);const s=GT(i);return{int:this.metadataQuerier.GetIntEntry(e,t),string:this.metadataQuerier.GetStringEntry(e,t),double:this.metadataQuerier.GetDoubleEntry(e,t),intArray:s}}finally{this.draco.destroy(i)}}_disableAttributeTransforms(e){const{quantizedAttributes:t=[],octahedronAttributes:i=[]}=e,s=[...t,...i];for(const o of s)this.decoder.SkipAttributeTransform(this.draco[o])}_getQuantizationTransform(e,t){const{quantizedAttributes:i=[]}=t,s=e.attribute_type();if(i.map(n=>this.decoder[n]).includes(s)){const n=new this.draco.AttributeQuantizationTransform;try{if(n.InitFromAttribute(e))return{quantization_bits:n.quantization_bits(),range:n.range(),min_values:new Float32Array([1,2,3]).map(a=>n.min_value(a))}}finally{this.draco.destroy(n)}}return null}_getOctahedronTransform(e,t){const{octahedronAttributes:i=[]}=t,s=e.attribute_type();if(i.map(n=>this.decoder[n]).includes(s)){const n=new this.draco.AttributeQuantizationTransform;try{if(n.InitFromAttribute(e))return{quantization_bits:n.quantization_bits()}}finally{this.draco.destroy(n)}}return null}}function VT(r,e){switch(e){case Float32Array:return r.DT_FLOAT32;case Int8Array:return r.DT_INT8;case Int16Array:return r.DT_INT16;case Int32Array:return r.DT_INT32;case Uint8Array:return r.DT_UINT8;case Uint16Array:return r.DT_UINT16;case Uint32Array:return r.DT_UINT32;default:return r.DT_INVALID}}function GT(r){const e=r.size(),t=new Int32Array(e);for(let i=0;i<e;i++)t[i]=r.GetValue(i);return t}function jT(r){const e=r.size(),t=new Int32Array(e);for(let i=0;i<e;i++)t[i]=r.GetValue(i);return t}const Uc="1.4.1",zT="https://www.gstatic.com/draco/versioned/decoders/".concat(Uc,"/draco_decoder.js"),KT="https://www.gstatic.com/draco/versioned/decoders/".concat(Uc,"/draco_wasm_wrapper.js"),WT="https://www.gstatic.com/draco/versioned/decoders/".concat(Uc,"/draco_decoder.wasm");let co;async function XT(r){const e=r.modules||{};return e.draco3d?co=co||e.draco3d.createDecoderModule({}).then(t=>({draco:t})):co=co||YT(r),await co}async function YT(r){let e,t;switch(r.draco&&r.draco.decoderType){case"js":e=await Ns(zT,"draco",r);break;case"wasm":default:[e,t]=await Promise.all([await Ns(KT,"draco",r),await Ns(WT,"draco",r)])}return e=e||globalThis.DracoDecoderModule,await JT(e,t)}function JT(r,e){const t={};return e&&(t.wasmBinary=e),new Promise(i=>{r({...t,onModuleLoaded:s=>i({draco:s})})})}const ZT={...PT,parse:qT};async function qT(r,e){const{draco:t}=await XT(e),i=new HT(t);try{return i.parseSync(r,e==null?void 0:e.draco)}finally{i.destroy()}}function $T(r){const e={};for(const t in r){const i=r[t];if(t!=="indices"){const s=zm(i);e[t]=s}}return e}function zm(r){const{buffer:e,size:t,count:i}=eD(r);return{value:e,size:t,byteOffset:0,count:i,type:Um(t),componentType:Om(e)}}function eD(r){let e=r,t=1,i=0;return r&&r.value&&(e=r.value,t=r.size||1),e&&(ArrayBuffer.isView(e)||(e=tD(e,Float32Array)),i=e.length/t),{buffer:e,size:t,count:i}}function tD(r,e,t=!1){return r?Array.isArray(r)?new e(r):t&&!(r instanceof e)?new e(r):r:null}const Sr="KHR_draco_mesh_compression",iD=Sr;function sD(r,e,t){const i=new Ei(r);for(const s of Km(i))i.getObjectExtension(s,Sr)}async function rD(r,e,t){var i;if(!(e!=null&&(i=e.gltf)!==null&&i!==void 0&&i.decompressMeshes))return;const s=new Ei(r),o=[];for(const n of Km(s))s.getObjectExtension(n,Sr)&&o.push(nD(s,n,e,t));await Promise.all(o),s.removeExtension(Sr)}function oD(r,e={}){const t=new Ei(r);for(const i of t.json.meshes||[])aD(),t.addRequiredExtension(Sr)}async function nD(r,e,t,i){const s=r.getObjectExtension(e,Sr);if(!s)return;const o=r.getTypedArrayForBufferView(s.bufferView),n=um(o.buffer,o.byteOffset),{parse:a}=i,A={...t};delete A["3d-tiles"];const l=await a(n,ZT,A,i),h=$T(l.attributes);for(const[d,f]of Object.entries(h))if(d in e.attributes){const m=e.attributes[d],_=r.getAccessor(m);_!=null&&_.min&&_!==null&&_!==void 0&&_.max&&(f.min=_.min,f.max=_.max)}e.attributes=h,l.indices&&(e.indices=zm(l.indices)),AD(e)}function aD(r,e,t=4,i,s){if(!i.DracoWriter)throw new Error("options.gltf.DracoWriter not provided")}function AD(r){if(!r.attributes&&Object.keys(r.attributes).length>0)throw new Error("glTF: Empty primitive detected: Draco decompression failure?")}function*Km(r){for(const e of r.json.meshes||[])for(const t of e.primitives)yield t}var lD=Object.freeze({__proto__:null,name:iD,preprocess:sD,decode:rD,encode:oD});const Ds="KHR_lights_punctual",cD=Ds;async function hD(r){const e=new Ei(r),{json:t}=e,i=e.getExtension(Ds);i&&(e.json.lights=i.lights,e.removeExtension(Ds));for(const s of t.nodes||[]){const o=e.getObjectExtension(s,Ds);o&&(s.light=o.light),e.removeObjectExtension(s,Ds)}}async function uD(r){const e=new Ei(r),{json:t}=e;if(t.lights){const i=e.addExtension(Ds);gi(!i.lights),i.lights=t.lights,delete t.lights}if(e.json.lights){for(const i of e.json.lights){const s=i.node;e.addObjectExtension(s,Ds,i)}delete e.json.lights}}var dD=Object.freeze({__proto__:null,name:cD,decode:hD,encode:uD});const Oo="KHR_materials_unlit",pD=Oo;async function fD(r){const e=new Ei(r),{json:t}=e;e.removeExtension(Oo);for(const i of t.materials||[])i.extensions&&i.extensions.KHR_materials_unlit&&(i.unlit=!0),e.removeObjectExtension(i,Oo)}function gD(r){const e=new Ei(r),{json:t}=e;if(e.materials)for(const i of t.materials||[])i.unlit&&(delete i.unlit,e.addObjectExtension(i,Oo,{}),e.addExtension(Oo))}var mD=Object.freeze({__proto__:null,name:pD,decode:fD,encode:gD});const Bo="KHR_techniques_webgl",_D=Bo;async function vD(r){const e=new Ei(r),{json:t}=e,i=e.getExtension(Bo);if(i){const s=PD(i,e);for(const o of t.materials||[]){const n=e.getObjectExtension(o,Bo);n&&(o.technique=Object.assign({},n,s[n.technique]),o.technique.values=yD(o.technique,e)),e.removeObjectExtension(o,Bo)}e.removeExtension(Bo)}}async function BD(r,e){}function PD(r,e){const{programs:t=[],shaders:i=[],techniques:s=[]}=r,o=new TextDecoder;return i.forEach(n=>{if(Number.isFinite(n.bufferView))n.code=o.decode(e.getTypedArrayForBufferView(n.bufferView));else throw new Error("KHR_techniques_webgl: no shader code")}),t.forEach(n=>{n.fragmentShader=i[n.fragmentShader],n.vertexShader=i[n.vertexShader]}),s.forEach(n=>{n.program=t[n.program]}),s}function yD(r,e){const t=Object.assign({},r.values);return Object.keys(r.uniforms||{}).forEach(i=>{r.uniforms[i].value&&!(i in t)&&(t[i]=r.uniforms[i].value)}),Object.keys(t).forEach(i=>{typeof t[i]=="object"&&t[i].index!==void 0&&(t[i].texture=e.getTexture(t[i].index))}),t}var xD=Object.freeze({__proto__:null,name:_D,decode:vD,encode:BD});const Wm=[uT,fT,_T,lD,dD,mD,xD];function wD(r,e={},t){const i=Wm.filter(o=>Xm(o.name,e));for(const o of i){var s;(s=o.preprocess)===null||s===void 0||s.call(o,r,e,t)}}async function bD(r,e={},t){const i=Wm.filter(o=>Xm(o.name,e));for(const o of i){var s;await((s=o.decode)===null||s===void 0?void 0:s.call(o,r,e,t))}}function Xm(r,e){var t;const i=(e==null||(t=e.gltf)===null||t===void 0?void 0:t.excludeExtensions)||{};return!(r in i&&!i[r])}const xl="KHR_binary_glTF";function CD(r){const e=new Ei(r),{json:t}=e;for(const i of t.images||[]){const s=e.getObjectExtension(i,xl);s&&Object.assign(i,s),e.removeObjectExtension(i,xl)}t.buffers&&t.buffers[0]&&delete t.buffers[0].uri,e.removeExtension(xl)}const uf={accessors:"accessor",animations:"animation",buffers:"buffer",bufferViews:"bufferView",images:"image",materials:"material",meshes:"mesh",nodes:"node",samplers:"sampler",scenes:"scene",skins:"skin",textures:"texture"},ED={accessor:"accessors",animations:"animation",buffer:"buffers",bufferView:"bufferViews",image:"images",material:"materials",mesh:"meshes",node:"nodes",sampler:"samplers",scene:"scenes",skin:"skins",texture:"textures"};class ID{constructor(){He(this,"idToIndexMap",{animations:{},accessors:{},buffers:{},bufferViews:{},images:{},materials:{},meshes:{},nodes:{},samplers:{},scenes:{},skins:{},textures:{}}),He(this,"json",void 0)}normalize(e,t){this.json=e.json;const i=e.json;switch(i.asset&&i.asset.version){case"2.0":return;case void 0:case"1.0":break;default:console.warn("glTF: Unknown version ".concat(i.asset.version));return}if(!t.normalize)throw new Error("glTF v1 is not supported.");console.warn("Converting glTF v1 to glTF v2 format. This is experimental and may fail."),this._addAsset(i),this._convertTopLevelObjectsToArrays(i),CD(e),this._convertObjectIdsToArrayIndices(i),this._updateObjects(i),this._updateMaterial(i)}_addAsset(e){e.asset=e.asset||{},e.asset.version="2.0",e.asset.generator=e.asset.generator||"Normalized to glTF 2.0 by loaders.gl"}_convertTopLevelObjectsToArrays(e){for(const t in uf)this._convertTopLevelObjectToArray(e,t)}_convertTopLevelObjectToArray(e,t){const i=e[t];if(!(!i||Array.isArray(i))){e[t]=[];for(const s in i){const o=i[s];o.id=o.id||s;const n=e[t].length;e[t].push(o),this.idToIndexMap[t][s]=n}}}_convertObjectIdsToArrayIndices(e){for(const t in uf)this._convertIdsToIndices(e,t);"scene"in e&&(e.scene=this._convertIdToIndex(e.scene,"scene"));for(const t of e.textures)this._convertTextureIds(t);for(const t of e.meshes)this._convertMeshIds(t);for(const t of e.nodes)this._convertNodeIds(t);for(const t of e.scenes)this._convertSceneIds(t)}_convertTextureIds(e){e.source&&(e.source=this._convertIdToIndex(e.source,"image"))}_convertMeshIds(e){for(const t of e.primitives){const{attributes:i,indices:s,material:o}=t;for(const n in i)i[n]=this._convertIdToIndex(i[n],"accessor");s&&(t.indices=this._convertIdToIndex(s,"accessor")),o&&(t.material=this._convertIdToIndex(o,"material"))}}_convertNodeIds(e){e.children&&(e.children=e.children.map(t=>this._convertIdToIndex(t,"node"))),e.meshes&&(e.meshes=e.meshes.map(t=>this._convertIdToIndex(t,"mesh")))}_convertSceneIds(e){e.nodes&&(e.nodes=e.nodes.map(t=>this._convertIdToIndex(t,"node")))}_convertIdsToIndices(e,t){e[t]||(console.warn("gltf v1: json doesn't contain attribute ".concat(t)),e[t]=[]);for(const i of e[t])for(const s in i){const o=i[s],n=this._convertIdToIndex(o,s);i[s]=n}}_convertIdToIndex(e,t){const i=ED[t];if(i in this.idToIndexMap){const s=this.idToIndexMap[i][e];if(!Number.isFinite(s))throw new Error("gltf v1: failed to resolve ".concat(t," with id ").concat(e));return s}return e}_updateObjects(e){for(const t of this.json.buffers)delete t.type}_updateMaterial(e){for(const s of e.materials){var t,i;s.pbrMetallicRoughness={baseColorFactor:[1,1,1,1],metallicFactor:1,roughnessFactor:1};const o=((t=s.values)===null||t===void 0?void 0:t.tex)||((i=s.values)===null||i===void 0?void 0:i.texture2d_0),n=e.textures.findIndex(a=>a.id===o);n!==-1&&(s.pbrMetallicRoughness.baseColorTexture={index:n})}}}function FD(r,e={}){return new ID().normalize(r,e)}const MD={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},SD={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},Bi={TEXTURE_MAG_FILTER:10240,TEXTURE_MIN_FILTER:10241,TEXTURE_WRAP_S:10242,TEXTURE_WRAP_T:10243,REPEAT:10497,LINEAR:9729,NEAREST_MIPMAP_LINEAR:9986},TD={magFilter:Bi.TEXTURE_MAG_FILTER,minFilter:Bi.TEXTURE_MIN_FILTER,wrapS:Bi.TEXTURE_WRAP_S,wrapT:Bi.TEXTURE_WRAP_T},DD={[Bi.TEXTURE_MAG_FILTER]:Bi.LINEAR,[Bi.TEXTURE_MIN_FILTER]:Bi.NEAREST_MIPMAP_LINEAR,[Bi.TEXTURE_WRAP_S]:Bi.REPEAT,[Bi.TEXTURE_WRAP_T]:Bi.REPEAT};function RD(r){return SD[r]}function LD(r){return MD[r]}class UD{constructor(){He(this,"baseUri",""),He(this,"json",{}),He(this,"buffers",[]),He(this,"images",[])}postProcess(e,t={}){const{json:i,buffers:s=[],images:o=[],baseUri:n=""}=e;return gi(i),this.baseUri=n,this.json=i,this.buffers=s,this.images=o,this._resolveTree(this.json,t),this.json}_resolveTree(e,t={}){e.bufferViews&&(e.bufferViews=e.bufferViews.map((i,s)=>this._resolveBufferView(i,s))),e.images&&(e.images=e.images.map((i,s)=>this._resolveImage(i,s))),e.samplers&&(e.samplers=e.samplers.map((i,s)=>this._resolveSampler(i,s))),e.textures&&(e.textures=e.textures.map((i,s)=>this._resolveTexture(i,s))),e.accessors&&(e.accessors=e.accessors.map((i,s)=>this._resolveAccessor(i,s))),e.materials&&(e.materials=e.materials.map((i,s)=>this._resolveMaterial(i,s))),e.meshes&&(e.meshes=e.meshes.map((i,s)=>this._resolveMesh(i,s))),e.nodes&&(e.nodes=e.nodes.map((i,s)=>this._resolveNode(i,s))),e.skins&&(e.skins=e.skins.map((i,s)=>this._resolveSkin(i,s))),e.scenes&&(e.scenes=e.scenes.map((i,s)=>this._resolveScene(i,s))),e.scene!==void 0&&(e.scene=e.scenes[this.json.scene])}getScene(e){return this._get("scenes",e)}getNode(e){return this._get("nodes",e)}getSkin(e){return this._get("skins",e)}getMesh(e){return this._get("meshes",e)}getMaterial(e){return this._get("materials",e)}getAccessor(e){return this._get("accessors",e)}getCamera(e){return null}getTexture(e){return this._get("textures",e)}getSampler(e){return this._get("samplers",e)}getImage(e){return this._get("images",e)}getBufferView(e){return this._get("bufferViews",e)}getBuffer(e){return this._get("buffers",e)}_get(e,t){if(typeof t=="object")return t;const i=this.json[e]&&this.json[e][t];return i||console.warn("glTF file error: Could not find ".concat(e,"[").concat(t,"]")),i}_resolveScene(e,t){return e.id=e.id||"scene-".concat(t),e.nodes=(e.nodes||[]).map(i=>this.getNode(i)),e}_resolveNode(e,t){return e.id=e.id||"node-".concat(t),e.children&&(e.children=e.children.map(i=>this.getNode(i))),e.mesh!==void 0?e.mesh=this.getMesh(e.mesh):e.meshes!==void 0&&e.meshes.length&&(e.mesh=e.meshes.reduce((i,s)=>{const o=this.getMesh(s);return i.id=o.id,i.primitives=i.primitives.concat(o.primitives),i},{primitives:[]})),e.camera!==void 0&&(e.camera=this.getCamera(e.camera)),e.skin!==void 0&&(e.skin=this.getSkin(e.skin)),e}_resolveSkin(e,t){return e.id=e.id||"skin-".concat(t),e.inverseBindMatrices=this.getAccessor(e.inverseBindMatrices),e}_resolveMesh(e,t){return e.id=e.id||"mesh-".concat(t),e.primitives&&(e.primitives=e.primitives.map(i=>{i={...i};const s=i.attributes;i.attributes={};for(const o in s)i.attributes[o]=this.getAccessor(s[o]);return i.indices!==void 0&&(i.indices=this.getAccessor(i.indices)),i.material!==void 0&&(i.material=this.getMaterial(i.material)),i})),e}_resolveMaterial(e,t){if(e.id=e.id||"material-".concat(t),e.normalTexture&&(e.normalTexture={...e.normalTexture},e.normalTexture.texture=this.getTexture(e.normalTexture.index)),e.occlusionTexture&&(e.occlustionTexture={...e.occlustionTexture},e.occlusionTexture.texture=this.getTexture(e.occlusionTexture.index)),e.emissiveTexture&&(e.emmisiveTexture={...e.emmisiveTexture},e.emissiveTexture.texture=this.getTexture(e.emissiveTexture.index)),e.emissiveFactor||(e.emissiveFactor=e.emmisiveTexture?[1,1,1]:[0,0,0]),e.pbrMetallicRoughness){e.pbrMetallicRoughness={...e.pbrMetallicRoughness};const i=e.pbrMetallicRoughness;i.baseColorTexture&&(i.baseColorTexture={...i.baseColorTexture},i.baseColorTexture.texture=this.getTexture(i.baseColorTexture.index)),i.metallicRoughnessTexture&&(i.metallicRoughnessTexture={...i.metallicRoughnessTexture},i.metallicRoughnessTexture.texture=this.getTexture(i.metallicRoughnessTexture.index))}return e}_resolveAccessor(e,t){if(e.id=e.id||"accessor-".concat(t),e.bufferView!==void 0&&(e.bufferView=this.getBufferView(e.bufferView)),e.bytesPerComponent=RD(e.componentType),e.components=LD(e.type),e.bytesPerElement=e.bytesPerComponent*e.components,e.bufferView){const i=e.bufferView.buffer,{ArrayType:s,byteLength:o}=km(e,e.bufferView),n=(e.bufferView.byteOffset||0)+(e.byteOffset||0)+i.byteOffset;let a=i.arrayBuffer.slice(n,n+o);e.bufferView.byteStride&&(a=this._getValueFromInterleavedBuffer(i,n,e.bufferView.byteStride,e.bytesPerElement,e.count)),e.value=new s(a)}return e}_getValueFromInterleavedBuffer(e,t,i,s,o){const n=new Uint8Array(o*s);for(let a=0;a<o;a++){const A=t+a*i;n.set(new Uint8Array(e.arrayBuffer.slice(A,A+s)),a*s)}return n.buffer}_resolveTexture(e,t){return e.id=e.id||"texture-".concat(t),e.sampler="sampler"in e?this.getSampler(e.sampler):DD,e.source=this.getImage(e.source),e}_resolveSampler(e,t){e.id=e.id||"sampler-".concat(t),e.parameters={};for(const i in e){const s=this._enumSamplerParameter(i);s!==void 0&&(e.parameters[s]=e[i])}return e}_enumSamplerParameter(e){return TD[e]}_resolveImage(e,t){e.id=e.id||"image-".concat(t),e.bufferView!==void 0&&(e.bufferView=this.getBufferView(e.bufferView));const i=this.images[t];return i&&(e.image=i),e}_resolveBufferView(e,t){const i=e.buffer,s={id:"bufferView-".concat(t),...e,buffer:this.buffers[i]},o=this.buffers[i].arrayBuffer;let n=this.buffers[i].byteOffset||0;return"byteOffset"in e&&(n+=e.byteOffset),s.data=new Uint8Array(o,n,e.byteLength),s}_resolveCamera(e,t){return e.id=e.id||"camera-".concat(t),e.perspective,e.orthographic,e}}function OD(r,e){return new UD().postProcess(r,e)}const df=1735152710,Oc=12,ba=8,kD=1313821514,ND=5130562,QD=0,HD=1,VD=0,Tr=!0;function GD(r,e=0){return"".concat(String.fromCharCode(r.getUint8(e+0))).concat(String.fromCharCode(r.getUint8(e+1))).concat(String.fromCharCode(r.getUint8(e+2))).concat(String.fromCharCode(r.getUint8(e+3)))}function jD(r,e=0,t={}){const i=new DataView(r),{magic:s=df}=t,o=i.getUint32(e,!1);return o===s||o===df}function zD(r,e,t=0,i={}){const s=new DataView(e),o=GD(s,t+0),n=s.getUint32(t+4,Tr),a=s.getUint32(t+8,Tr);switch(Object.assign(r,{header:{byteOffset:t,byteLength:a,hasBinChunk:!1},type:o,version:n,json:{},binChunks:[]}),t+=Oc,r.version){case 1:return KD(r,s,t);case 2:return WD(r,s,t,i={});default:throw new Error("Invalid GLB version ".concat(r.version,". Only supports v1 and v2."))}}function KD(r,e,t){ls(r.header.byteLength>Oc+ba);const i=e.getUint32(t+0,Tr),s=e.getUint32(t+4,Tr);return t+=ba,ls(s===VD),fc(r,e,t,i),t+=i,t+=gc(r,e,t,r.header.byteLength),t}function WD(r,e,t,i){return ls(r.header.byteLength>Oc+ba),XD(r,e,t,i),t+r.header.byteLength}function XD(r,e,t,i){for(;t+8<=r.header.byteLength;){const s=e.getUint32(t+0,Tr),o=e.getUint32(t+4,Tr);switch(t+=ba,o){case kD:fc(r,e,t,s);break;case ND:gc(r,e,t,s);break;case QD:i.strict||fc(r,e,t,s);break;case HD:i.strict||gc(r,e,t,s);break}t+=Vo(s,4)}return t}function fc(r,e,t,i){const s=new Uint8Array(e.buffer,t,i),n=new TextDecoder("utf8").decode(s);return r.json=JSON.parse(n),Vo(i,4)}function gc(r,e,t,i){return r.header.hasBinChunk=!0,r.binChunks.push({byteOffset:t,byteLength:i,arrayBuffer:e.buffer}),Vo(i,4)}async function YD(r,e,t=0,i,s){var o,n,a,A;JD(r,e,t,i),FD(r,{normalize:i==null||(o=i.gltf)===null||o===void 0?void 0:o.normalize}),wD(r,i,s);const l=[];if(i!=null&&(n=i.gltf)!==null&&n!==void 0&&n.loadBuffers&&r.json.buffers&&await ZD(r,i,s),i!=null&&(a=i.gltf)!==null&&a!==void 0&&a.loadImages){const d=qD(r,i,s);l.push(d)}const h=bD(r,i,s);return l.push(h),await Promise.all(l),i!=null&&(A=i.gltf)!==null&&A!==void 0&&A.postProcess?OD(r,i):r}function JD(r,e,t,i){if(i.uri&&(r.baseUri=i.uri),e instanceof ArrayBuffer&&!jD(e,t,i)&&(e=new TextDecoder().decode(e)),typeof e=="string")r.json=vM(e);else if(e instanceof ArrayBuffer){const n={};t=zD(n,e,t,i.glb),gi(n.type==="glTF","Invalid GLB magic string ".concat(n.type)),r._glb=n,r.json=n.json}else gi(!1,"GLTF: must be ArrayBuffer or string");const s=r.json.buffers||[];if(r.buffers=new Array(s.length).fill(null),r._glb&&r._glb.header.hasBinChunk){const{binChunks:n}=r._glb;r.buffers[0]={arrayBuffer:n[0].arrayBuffer,byteOffset:n[0].byteOffset,byteLength:n[0].byteLength}}const o=r.json.images||[];r.images=new Array(o.length).fill({})}async function ZD(r,e,t){const i=r.json.buffers||[];for(let n=0;n<i.length;++n){const a=i[n];if(a.uri){var s,o;const{fetch:A}=t;gi(A);const l=Lm(a.uri,e),h=await(t==null||(s=t.fetch)===null||s===void 0?void 0:s.call(t,l)),d=await(h==null||(o=h.arrayBuffer)===null||o===void 0?void 0:o.call(h));r.buffers[n]={arrayBuffer:d,byteOffset:0,byteLength:d.byteLength},delete a.uri}else r.buffers[n]===null&&(r.buffers[n]={arrayBuffer:new ArrayBuffer(a.byteLength),byteOffset:0,byteLength:a.byteLength})}}async function qD(r,e,t){const i=$D(r),s=r.json.images||[],o=[];for(const n of i)o.push(eR(r,s[n],n,e,t));return await Promise.all(o)}function $D(r){const e=new Set,t=r.json.textures||[];for(const i of t)i.source!==void 0&&e.add(i.source);return Array.from(e).sort()}async function eR(r,e,t,i,s){const{fetch:o,parse:n}=s;let a;if(e.uri){const l=Lm(e.uri,i);a=await(await o(l)).arrayBuffer()}if(Number.isFinite(e.bufferView)){const l=zS(r.json,r.buffers,e.bufferView);a=um(l.buffer,l.byteOffset,l.byteLength)}gi(a,"glTF image has no data");let A=await n(a,[QS,uS],{mimeType:e.mimeType,basis:i.basis||{format:Tm()}},s);A&&A[0]&&(A={compressed:!0,mipmaps:!1,width:A[0].width,height:A[0].height,data:A[0]}),r.images=r.images||[],r.images[t]=A}const mc={name:"glTF",id:"gltf",module:"gltf",version:Y2,extensions:["gltf","glb"],mimeTypes:["model/gltf+json","model/gltf-binary"],text:!0,binary:!0,tests:["glTF"],parse:tR,options:{gltf:{normalize:!0,loadBuffers:!0,loadImages:!0,decompressMeshes:!0,postProcess:!0},log:console},deprecatedOptions:{fetchImages:"gltf.loadImages",createImages:"gltf.loadImages",decompress:"gltf.decompressMeshes",postProcess:"gltf.postProcess",gltf:{decompress:"gltf.decompressMeshes"}}};async function tR(r,e={},t){e={...mc.options,...e},e.gltf={...mc.options.gltf,...e.gltf};const{byteOffset:i=0}=e;return await YD({},r,i,e,t)}class iR{constructor(e){}load(e,t,i,s,o,n,a){s=s||{},rR(e,t,i,s,o,function(){Bt.scheduleTask(function(){o.scene.fire("modelLoaded",o.id),o.fire("loaded",!0,!1)}),n&&n()},function(A){e.error(A),a&&a(A),o.fire("error",A)})}parse(e,t,i,s,o,n,a){s=s||{},_c(e,"",t,i,s,o,function(){o.scene.fire("modelLoaded",o.id),o.fire("loaded",!0,!1),n&&n()})}}function sR(r){const e={},t={},i=r.metaObjects||[],s={};for(let o=0,n=i.length;o<n;o++){const a=i[o];s[a.id]=a}for(let o=0,n=i.length;o<n;o++){const a=i[o];if(a.parent!==void 0&&a.parent!==null){const A=s[a.parent];if(a.type===A.type){let l=A;for(;l.parent&&s[l.parent].type===l.type;)l=s[l.parent];const h=e[l.id]||(e[l.id]={numChildren:0,countChildren:0});h.numChildren++,t[a.id]=l}}}return{metaObjectsMap:s,eachRootStats:e,eachChildRoot:t}}function rR(r,e,t,i,s,o,n){const a=r.viewer.scene.canvas.spinner;a.processes++,e.split(".").pop()==="glb"?r.dataSource.getGLB(e,l=>{i.basePath=pf(e),_c(r,e,l,t,i,s,o),a.processes--},l=>{a.processes--,n(l)}):r.dataSource.getGLTF(e,l=>{i.basePath=pf(e),_c(r,e,l,t,i,s,o),a.processes--},l=>{a.processes--,n(l)})}function pf(r){const e=r.lastIndexOf("/");return e!==0?r.substring(0,e+1):""}function _c(r,e,t,i,s,o,n){const a=r.viewer.scene.canvas.spinner;a.processes++,Sc(t,mc,{baseUri:s.basePath}).then(A=>{const l={src:e,entityId:s.entityId,metaModelCorrections:i?sR(i):null,loadBuffer:s.loadBuffer,basePath:s.basePath,handlenode:s.handlenode,backfaces:!!s.backfaces,gltfData:A,scene:o.scene,plugin:r,sceneModel:o,numObjects:0,nodes:[],nextId:0,log:h=>{r.log(h)}};oR(l),aR(l),cR(l),o.finalize(),a.processes--,n()})}function oR(r){const t=r.gltfData.textures;if(t)for(let i=0,s=t.length;i<s;i++)nR(r,t[i])}function nR(r,e){if(!e.source||!e.source.image)return;const t=`texture-${r.nextId++}`;let i=aa;switch(e.sampler.minFilter){case 9728:i=To;break;case 9729:i=Qi;break;case 9984:i=Bc;break;case 9985:i=Pc;break;case 9986:i=aa;break;case 9987:i=zf;break}let s=Qi;switch(e.sampler.magFilter){case 9728:s=To;break;case 9729:s=Qi;break}let o=Ht;switch(e.sampler.wrapS){case 33071:o=Ls;break;case 33648:o=Pr;break;case 10497:o=Ht;break}let n=Ht;switch(e.sampler.wrapT){case 33071:n=Ls;break;case 33648:n=Pr;break;case 10497:n=Ht;break}let a=Ht;switch(e.sampler.wrapR){case 33071:a=Ls;break;case 33648:a=Pr;break;case 10497:a=Ht;break}r.sceneModel.createTexture({id:t,image:e.source.image,flipY:!!e.flipY,minFilter:i,magFilter:s,wrapS:o,wrapT:n,wrapR:a,encoding:wt}),e._textureId=t}function aR(r){const t=r.gltfData.materials;if(t)for(let i=0,s=t.length;i<s;i++){const o=t[i];o._textureSetId=AR(r,o),o._attributes=lR(r,o)}}function AR(r,e){const t={};e.normalTexture&&(t.normalTextureId=e.normalTexture.texture._textureId),e.occlusionTexture&&(t.occlusionTextureId=e.occlusionTexture.texture._textureId),e.emissiveTexture&&(t.emissiveTextureId=e.emissiveTexture.texture._textureId);const i=e.pbrMetallicRoughness;if(e.pbrMetallicRoughness){const o=e.pbrMetallicRoughness,n=o.baseColorTexture||o.colorTexture;n&&(n.texture?t.colorTextureId=n.texture._textureId:t.colorTextureId=r.gltfData.textures[n.index]._textureId),i.metallicRoughnessTexture&&(t.metallicRoughnessTextureId=i.metallicRoughnessTexture.texture._textureId)}const s=e.extensions;if(s){const o=s.KHR_materials_pbrSpecularGlossiness;if(o){o.specularTexture;const n=o.specularColorTexture;n!=null&&(t.colorTextureId=r.gltfData.textures[n.index]._textureId)}}return t.normalTextureId!==void 0||t.occlusionTextureId!==void 0||t.emissiveTextureId!==void 0||t.colorTextureId!==void 0||t.metallicRoughnessTextureId!==void 0?(t.id=`textureSet-${r.nextId++};`,r.sceneModel.createTextureSet(t),t.id):null}function lR(r,e){const t=e.extensions,i={color:new Float32Array([1,1,1,1]),opacity:1,metallic:0,roughness:1,doubleSided:!0};if(t){const o=t.KHR_materials_pbrSpecularGlossiness;if(o){const a=o.diffuseFactor;a!=null&&i.color.set(a)}const n=t.KHR_materials_common;if(n){const a=n.technique,A=n.values||{},l=a==="BLINN",h=a==="PHONG",d=a==="LAMBERT",f=A.diffuse;f&&(l||h||d)&&(Se.isString(f)||i.color.set(f));const m=A.transparency;m!=null&&(i.opacity=m);const _=A.transparent;_!=null&&(i.opacity=_)}}const s=e.pbrMetallicRoughness;if(s){const o=s.baseColorFactor;o&&(i.color[0]=o[0],i.color[1]=o[1],i.color[2]=o[2],i.opacity=o[3]);const n=s.metallicFactor;n!=null&&(i.metallic=n);const a=s.roughnessFactor;a!=null&&(i.roughness=a)}return i.doubleSided=e.doubleSided!==!1,i}function cR(r){const e=r.gltfData,t=e.scene||e.scenes[0];if(!t){Zm(r,"glTF has no default scene");return}hR(r,t)}function hR(r,e){const t=e.nodes;if(t){for(let i=0,s=t.length;i<s;i++){const o=t[i];Ym(r,o)}for(let i=0,s=t.length;i<s;i++){const o=t[i];Jm(r,o,0,null)}}}function Ym(r,e){const t=e.mesh;if(t&&(t.instances=t.instances?t.instances+1:1),e.children){const i=e.children;for(let s=0,o=i.length;s<o;s++){const n=i[s];if(!n){Zm(r,"Node not found: "+s);continue}Ym(r,n)}}}const ki=[];function Jm(r,e,t,i){r.gltfData;let s;e.matrix&&(s=e.matrix,i?i=c.mulMat4(i,s,c.mat4()):i=s),e.translation&&(s=c.translationMat4v(e.translation),i?i=c.mulMat4(i,s,c.mat4()):i=s),e.rotation&&(s=c.quaternionToMat4(e.rotation),i?i=c.mulMat4(i,s,c.mat4()):i=s),e.scale&&(s=c.scalingMat4v(e.scale),i?i=c.mulMat4(i,s,c.mat4()):i=s);const o=r.sceneModel;if(e.mesh){const n=e.mesh;if(r.handlenode){const l={};if(!r.handlenode(r.sceneModel.id,e,l))return;l.createEntity}const a=i?i.slice():c.identityMat4(),A=n.primitives.length;if(A>0)for(let l=0;l<A;l++){const h=n.primitives[l];if(h.mode<4)continue;const d={id:o.id+"."+r.numObjects++},f=h.material;f?(d.textureSetId=f._textureSetId,d.color=f._attributes.color,d.opacity=f._attributes.opacity,d.metallic=f._attributes.metallic,d.roughness=f._attributes.roughness):(d.color=new Float32Array([1,1,1]),d.opacity=1);const m=r.backfaces!==!1||f&&f.doubleSided!==!1;switch(h.mode){case 0:d.primitive="points";break;case 1:d.primitive="lines";break;case 2:d.primitive="lines";break;case 3:d.primitive="lines";break;case 4:d.primitive=m?"triangles":"solid";break;case 5:d.primitive=m?"triangles":"solid";break;case 6:d.primitive=m?"triangles":"solid";break;default:d.primitive=m?"triangles":"solid"}const _=h.attributes.POSITION;if(!_)continue;d.localPositions=_.value,d.positions=new Float64Array(d.localPositions.length),h.attributes.NORMAL&&(d.normals=h.attributes.NORMAL.value),h.attributes.TEXCOORD_0&&(d.uv=h.attributes.TEXCOORD_0.value),h.indices&&(d.indices=h.indices.value),c.transformPositions3(a,d.localPositions,d.positions);const u=c.vec3();Cl(d.positions,d.positions,u)&&(d.origin=u),o.createMesh(d),ki.push(d.id)}}if(e.children){const n=e.children;for(let a=0,A=n.length;a<A;a++){const l=n[a];Jm(r,l,t+1,i)}}if(r.entityId)t===0&&(o.createEntity({id:r.entityId,meshIds:ki,isObject:!0}),ki.length=0);else{const n=e.name;if((n!=null||t===0)&&ki.length>0){n==null&&r.log("Warning: 'name' properties not found on glTF scene nodes - will randomly-generate object IDs in XKT");let a=n;if(r.metaModelCorrections){const A=r.metaModelCorrections.eachChildRoot[a];if(A){const l=r.metaModelCorrections.eachRootStats[A.id];l.countChildren++,l.countChildren>=l.numChildren&&(o.createEntity({id:A.id,meshIds:ki,isObject:!0}),ki.length=0)}else r.metaModelCorrections.metaObjectsMap[a]&&(o.createEntity({id:a,meshIds:ki,isObject:!0}),ki.length=0)}else o.createEntity({id:a,meshIds:ki,isObject:!0}),ki.length=0}}}function Zm(r,e){r.plugin.error(e)}const ff={DEFAULT:{}};class uR extends kf{constructor(e,t={}){super("GLTFLoader",e,t),this._sceneModelLoader=new iR(this,t),this.dataSource=t.dataSource,this.objectDefaults=t.objectDefaults}set dataSource(e){this._dataSource=e||new Gw}get dataSource(){return this._dataSource}set objectDefaults(e){this._objectDefaults=e||ff}get objectDefaults(){return this._objectDefaults}load(e={}){e.id&&this.viewer.scene.components[e.id]&&(this.error("Component with this ID already exists in viewer: "+e.id+" - will autogenerate this ID"),delete e.id);const t=new Vw(this.viewer.scene,Se.apply(e,{isModel:!0,dtxEnabled:e.dtxEnabled})),i=t.id;if(!e.src&&!e.gltf)return this.error("load() param expected: src or gltf"),t;if(e.metaModelSrc||e.metaModelJSON){const s=e.objectDefaults||this._objectDefaults||ff,o=n=>{this.viewer.metaScene.createMetaModel(i,n,{includeTypes:e.includeTypes,excludeTypes:e.excludeTypes}),this.viewer.scene.canvas.spinner.processes--;let a;if(e.includeTypes){a={};for(let A=0,l=e.includeTypes.length;A<l;A++)a[e.includeTypes[A]]=!0}if(e.excludeTypes){a||(a={});for(let A=0,l=e.excludeTypes.length;A<l;A++)a[e.excludeTypes[A]]=!0}e.readableGeometry=!1,e.handleGLTFNode=(A,l,h)=>{const d=l.name;if(!d)return!0;const f=d,m=this.viewer.metaScene.metaObjects[f],_=(m?m.type:"DEFAULT")||"DEFAULT";h.createEntity={id:f,isObject:!0};const u=s[_];return u&&(u.visible===!1&&(h.createEntity.visible=!1),u.colorize&&(h.createEntity.colorize=u.colorize),u.pickable===!1&&(h.createEntity.pickable=!1),u.opacity!==void 0&&u.opacity!==null&&(h.createEntity.opacity=u.opacity)),!0},e.src?this._sceneModelLoader.load(this,e.src,n,e,t):this._sceneModelLoader.parse(this,e.gltf,n,e,t)};if(e.metaModelSrc){const n=e.metaModelSrc;this.viewer.scene.canvas.spinner.processes++,this._dataSource.getMetaModel(n,a=>{this.viewer.scene.canvas.spinner.processes--,o(a)},a=>{this.error(`load(): Failed to load model metadata for model '${i} from  '${n}' - ${a}`),this.viewer.scene.canvas.spinner.processes--})}else e.metaModelJSON&&o(e.metaModelJSON)}else e.handleGLTFNode=(s,o,n)=>{const a=o.name;if(!a)return!0;const A=a;return n.createEntity={id:A,isObject:!0},!0},e.src?this._sceneModelLoader.load(this,e.src,null,e,t):this._sceneModelLoader.parse(this,e.gltf,null,e,t);return t.once("destroyed",()=>{this.viewer.metaScene.destroyMetaModel(i)}),t}destroy(){super.destroy()}}c.vec3();c.vec3();c.mat4();c.vec3();c.AABB3();c.vec3();c.vec3();c.mat4();c.AABB3();c.vec3();c.vec3();class dR{createRootNode(){return document.createElement("ul")}createNodeElement(e,t,i,s,o){const n=document.createElement("li");if(n.id=e.nodeId,e.xrayed&&n.classList.add("xrayed-node"),e.children.length>0){const l=document.createElement("a");l.href="#",l.id=`switch-${e.nodeId}`,l.textContent="+",l.classList.add("plus"),t&&l.addEventListener("click",t),n.appendChild(l)}const a=document.createElement("input");a.id=`checkbox-${e.nodeId}`,a.type="checkbox",a.checked=e.checked,a.style["pointer-events"]="all",i&&a.addEventListener("change",i),n.appendChild(a);const A=document.createElement("span");return A.textContent=e.title,n.appendChild(A),s&&(A.oncontextmenu=s),o&&(A.onclick=o),n}createDisabledNodeElement(e){const t=document.createElement("li"),i=document.createElement("a");i.href="#",i.textContent="!",i.classList.add("warn"),i.classList.add("warning"),t.appendChild(i);const s=document.createElement("span");return s.textContent=e,t.appendChild(s),t}addChildren(e,t){const i=document.createElement("ul");t.forEach(s=>{i.appendChild(s)}),e.parentElement.appendChild(i)}expand(e,t,i){e.classList.remove("plus"),e.classList.add("minus"),e.textContent="-",e.removeEventListener("click",t),e.addEventListener("click",i)}collapse(e,t,i){if(!e)return;const s=e.parentElement;if(!s)return;const o=s.querySelector("ul");o&&(s.removeChild(o),e.classList.remove("minus"),e.classList.add("plus"),e.textContent="+",e.removeEventListener("click",i),e.addEventListener("click",t))}isExpanded(e){return e.parentElement.getElementsByTagName("li")[0]!==void 0}getId(e){return e.parentElement.id}getIdFromCheckbox(e){return e.id.replace("checkbox-","")}getSwitchElement(e){return document.getElementById(`switch-${e}`)}isChecked(e){return e.checked}setCheckbox(e,t){const i=document.getElementById(`checkbox-${e}`);i&&t!==i.checked&&(i.checked=t)}setXRayed(e,t){const i=document.getElementById(e);i&&(t?i.classList.add("xrayed-node"):i.classList.remove("xrayed-node"))}setHighlighted(e,t){const i=document.getElementById(e);i&&(t?(i.scrollIntoView({block:"center"}),i.classList.add("highlighted-node")):i.classList.remove("highlighted-node"))}}const wl=[];class pR extends kf{constructor(e,t={}){super("TreeViewPlugin",e),this.errors=[],this.valid=!0;const i=t.containerElement||document.getElementById(t.containerElementId);if(!(i instanceof HTMLElement)){this.error("Mandatory config expected: valid containerElementId or containerElement");return}for(let s=0;;s++)if(!wl[s]){wl[s]=this,this._index=s,this._id=`tree-${s}`;break}if(this._containerElement=i,this._metaModels={},this._autoAddModels=t.autoAddModels!==!1,this._autoExpandDepth=t.autoExpandDepth||0,this._sortNodes=t.sortNodes!==!1,this._viewer=e,this._rootElement=null,this._muteSceneEvents=!1,this._muteTreeEvents=!1,this._rootNodes=[],this._objectNodes={},this._nodeNodes={},this._rootNames={},this._sortNodes=t.sortNodes,this._pruneEmptyNodes=t.pruneEmptyNodes,this._showListItemElementId=null,this._renderService=t.renderService||new dR,!this._renderService)throw new Error("TreeViewPlugin: no render service set");if(this._containerElement.oncontextmenu=s=>{s.preventDefault()},this._onObjectVisibility=this._viewer.scene.on("objectVisibility",s=>{if(this._muteSceneEvents)return;const o=s.id,n=this._objectNodes[o];if(!n)return;const a=s.visible;if(!(a!==n.checked))return;this._muteTreeEvents=!0,n.checked=a,a?n.numVisibleEntities++:n.numVisibleEntities--,this._renderService.setCheckbox(n.nodeId,a);let l=n.parent;for(;l;)l.checked=a,a?l.numVisibleEntities++:l.numVisibleEntities--,this._renderService.setCheckbox(l.nodeId,l.numVisibleEntities>0),l=l.parent;this._muteTreeEvents=!1}),this._onObjectXrayed=this._viewer.scene.on("objectXRayed",s=>{if(this._muteSceneEvents)return;const o=s.id,n=this._objectNodes[o];if(!n)return;this._muteTreeEvents=!0;const a=s.xrayed;a!==n.xrayed&&(n.xrayed=a,this._renderService.setXRayed(n.nodeId,a),this._muteTreeEvents=!1)}),this._switchExpandHandler=s=>{s.preventDefault(),s.stopPropagation();const o=s.target;this._expandSwitchElement(o)},this._switchCollapseHandler=s=>{s.preventDefault(),s.stopPropagation();const o=s.target;this._collapseSwitchElement(o)},this._checkboxChangeHandler=s=>{if(this._muteTreeEvents)return;this._muteSceneEvents=!0;const o=s.target,n=this._renderService.isChecked(o),a=this._renderService.getIdFromCheckbox(o),A=this._nodeNodes[a],l=this._viewer.scene.objects;let h=0;this._withNodeTree(A,f=>{const m=f.objectId,_=l[m],u=f.children.length===0;f.numVisibleEntities=n?f.numEntities:0,u&&n!==f.checked&&h++,f.checked=n,this._renderService.setCheckbox(f.nodeId,n),_&&(_.visible=n)});let d=A.parent;for(;d;)d.checked=n,n?d.numVisibleEntities+=h:d.numVisibleEntities-=h,this._renderService.setCheckbox(d.nodeId,d.numVisibleEntities>0),d=d.parent;this._muteSceneEvents=!1},this._hierarchy=t.hierarchy||"containment",this._autoExpandDepth=t.autoExpandDepth||0,this._autoAddModels){const s=Object.keys(this.viewer.metaScene.metaModels);for(let o=0,n=s.length;o<n;o++){const a=s[o];this.viewer.metaScene.metaModels[a].finalized&&this.addModel(a)}this.viewer.scene.on("modelLoaded",o=>{this.viewer.metaScene.metaModels[o]&&this.addModel(o)})}this.hierarchy=t.hierarchy}set hierarchy(e){e=e||"containment",e!=="containment"&&e!=="storeys"&&e!=="types"&&(this.error("Unsupported value for `hierarchy' - defaulting to 'containment'"),e="containment"),this._hierarchy!==e&&(this._hierarchy=e,this._createNodes())}get hierarchy(){return this._hierarchy}addModel(e,t={}){if(!this._containerElement)return;const i=this.viewer.scene.models[e];if(!i)throw"Model not found: "+e;const s=this.viewer.metaScene.metaModels[e];if(!s){this.error("MetaModel not found: "+e);return}if(this._metaModels[e]){this.warn("Model already added: "+e);return}this._metaModels[e]=s,t&&t.rootName&&(this._rootNames[e]=t.rootName),i.on("destroyed",()=>{this.removeModel(i.id)}),this._createNodes()}removeModel(e){!this._containerElement||!this._metaModels[e]||(this._rootNames[e]&&delete this._rootNames[e],delete this._metaModels[e],this._createNodes())}showNode(e){this.unShowNode();const t=this._objectNodes[e];if(!t)return;const i=t.nodeId,s=this._renderService.getSwitchElement(i);if(s)return this._expandSwitchElement(s),s.scrollIntoView(),!0;const o=[];o.unshift(t);let n=t.parent;for(;n;)o.unshift(n),n=n.parent;for(let a=0,A=o.length;a<A;a++){const l=this._renderService.getSwitchElement(o[a].nodeId);l&&this._expandSwitchElement(l)}this._renderService.setHighlighted(i,!0),this._showListItemElementId=i}unShowNode(){this._showListItemElementId&&(this._renderService.setHighlighted(this._showListItemElementId,!1),this._showListItemElementId=null)}expandToDepth(e){this.collapse();const t=(i,s)=>{if(s===e)return;const o=this._renderService.getSwitchElement(i.nodeId);if(o){this._expandSwitchElement(o);const A=i.children;for(var n=0,a=A.length;n<a;n++){const l=A[n];t(l,s+1)}}};for(let i=0,s=this._rootNodes.length;i<s;i++){const o=this._rootNodes[i];t(o,0)}}collapse(){for(let e=0,t=this._rootNodes.length;e<t;e++){const s=this._rootNodes[e].objectId;this._collapseNode(s)}}withNodeTree(e,t){t(e);const i=e.children;if(i)for(let s=0,o=i.length;s<o;s++)this.withNodeTree(i[s],t)}destroy(){this._containerElement&&(this._metaModels={},this._rootElement&&!this._destroyed&&(this._rootElement.parentNode.removeChild(this._rootElement),this._viewer.scene.off(this._onObjectVisibility),this._destroyed=!0),delete wl[this._index],super.destroy())}_createNodes(){this._rootElement&&(this._rootElement.parentNode.removeChild(this._rootElement),this._rootElement=null),this._rootNodes=[],this._objectNodes={},this._nodeNodes={},this._validate(),this.valid||this._hierarchy!=="storeys"?this._createEnabledNodes():this._createDisabledNodes()}_validate(){switch(this.errors=[],this._hierarchy){case"storeys":this.valid=this._validateMetaModelForStoreysHierarchy();break;case"types":this.valid=this._rootNodes.length>0;break;case"containment":default:this.valid=this._rootNodes.length>0;break}return this.valid}_validateMetaModelForStoreysHierarchy(e=0,t,i){return!0}_createEnabledNodes(){switch(this._pruneEmptyNodes&&this._findEmptyNodes(),this._hierarchy){case"storeys":this._createStoreysNodes(),this._rootNodes.length===0&&this.error("Failed to build storeys hierarchy");break;case"types":this._createTypesNodes();break;case"containment":default:this._createContainmentNodes()}this._sortNodes&&this._doSortNodes(),this._synchNodesToEntities(),this._createTrees(),this.expandToDepth(this._autoExpandDepth)}_createDisabledNodes(){const e=this._renderService.createRootNode();this._rootElement=e,this._containerElement.appendChild(e);const t=this._viewer.metaScene.rootMetaObjects;for(let i in t){const s=t[i],o=s.type,n=s.name,a=n&&n!==""&&n!=="Undefined"&&n!=="Default"?n:o,A=this._renderService.createDisabledNodeElement(a);e.appendChild(A)}}_findEmptyNodes(){const e=this._viewer.metaScene.rootMetaObjects;for(let t in e)this._findEmptyNodes2(e[t])}_findEmptyNodes2(e,t=0){const s=this.viewer.scene,o=e.children,n=e.id,a=s.objects[n];if(e._countEntities=0,a&&e._countEntities++,o)for(let A=0,l=o.length;A<l;A++){const h=o[A];h._countEntities=this._findEmptyNodes2(h),e._countEntities+=h._countEntities}return e._countEntities}_createStoreysNodes(){const e=this._viewer.metaScene.rootMetaObjects;for(let t in e)this._createStoreysNodes2(e[t],null,null,null)}_createStoreysNodes2(e,t,i,s){if(this._pruneEmptyNodes&&e._countEntities===0)return;const o=e.type,n=e.name,a=e.children,A=e.id;if(o==="IfcBuilding")t={nodeId:`${this._id}-${A}`,objectId:A,title:e.metaModels.length===0?"na":this._rootNames[e.metaModels[0].id]||(n&&n!==""&&n!=="Undefined"&&n!=="Default"?n:o),type:o,parent:null,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]},this._rootNodes.push(t),this._objectNodes[t.objectId]=t,this._nodeNodes[t.nodeId]=t;else if(o==="IfcBuildingStorey"){if(!t){this.error("Failed to build storeys hierarchy for model '"+this.metaModel.id+"' - model does not have an IfcBuilding object, or is not an IFC model");return}i={nodeId:`${this._id}-${A}`,objectId:A,title:n&&n!==""&&n!=="Undefined"&&n!=="Default"?n:o,type:o,parent:t,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]},t.children.push(i),this._objectNodes[i.objectId]=i,this._nodeNodes[i.nodeId]=i,s={}}else if(i&&this._viewer.scene.objects[A]){s=s||{};let d=s[o];d||(d={nodeId:`${this._id}-${i.objectId}-${o}`,objectId:`${i.objectId}-${o}`,title:o,type:o,parent:i,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]},i.children.push(d),this._objectNodes[d.objectId]=d,this._nodeNodes[d.nodeId]=d,s[o]=d);const f={nodeId:`${this._id}-${A}`,objectId:A,title:n&&n!==""&&n!=="Undefined"&&n!=="Default"?n:o,type:o,parent:d,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]};d.children.push(f),this._objectNodes[f.objectId]=f,this._nodeNodes[f.nodeId]=f}if(a)for(let l=0,h=a.length;l<h;l++){const d=a[l];this._createStoreysNodes2(d,t,i,s)}}_createTypesNodes(){const e=this._viewer.metaScene.rootMetaObjects;for(let t in e)this._createTypesNodes2(e[t],null,null)}_createTypesNodes2(e,t,i){if(this._pruneEmptyNodes&&e._countEntities===0)return;const s=e.type,o=e.name,n=e.children,a=e.id;if(!e.parent)t={nodeId:`${this._id}-${a}`,objectId:a,title:e.metaModels.length===0?"na":this._rootNames[e.metaModels[0].id]||(o&&o!==""&&o!=="Undefined"&&o!=="Default"?o:s),type:s,parent:null,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]},this._rootNodes.push(t),this._objectNodes[t.objectId]=t,this._nodeNodes[t.nodeId]=t,i={};else if(t&&this._viewer.scene.objects[a]){let h=i[s];h||(h={nodeId:`${this._id}-${t.objectId}-${s}`,objectId:`${t.objectId}-${s}`,title:s,type:s,parent:t,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]},t.children.push(h),this._objectNodes[h.objectId]=h,this._nodeNodes[h.nodeId]=h,i[s]=h);const d={nodeId:`${this._id}-${a}`,objectId:a,title:o&&o!==""&&o!=="Default"?o:s,type:s,parent:h,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]};h.children.push(d),this._objectNodes[d.objectId]=d,this._nodeNodes[d.nodeId]=d}if(n)for(let A=0,l=n.length;A<l;A++){const h=n[A];this._createTypesNodes2(h,t,i)}}_createContainmentNodes(){const e=this._viewer.metaScene.rootMetaObjects;for(let t in e)this._createContainmentNodes2(e[t],null)}_createContainmentNodes2(e,t){if(this._pruneEmptyNodes&&e._countEntities===0)return;const i=e.type,s=e.name||i,o=e.children,n=e.id,a={nodeId:`${this._id}-${n}`,objectId:n,title:t?s&&s!==""&&s!=="Undefined"&&s!=="Default"?s:i:e.metaModels.length===0?"na":this._rootNames[e.metaModels[0].id]||s,type:i,parent:t,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]};if(t?t.children.push(a):this._rootNodes.push(a),this._objectNodes[a.objectId]=a,this._nodeNodes[a.nodeId]=a,o)for(let A=0,l=o.length;A<l;A++){const h=o[A];this._createContainmentNodes2(h,a)}}_doSortNodes(){for(let e=0,t=this._rootNodes.length;e<t;e++){const i=this._rootNodes[e];this._sortChildren(i)}}_sortChildren(e){const t=e.children;if(!(!t||t.length===0)){this._hierarchy==="storeys"&&e.type==="IfcBuilding"?t.sort(this._getSpatialSortFunc()):t.sort(this._alphaSortFunc);for(let i=0,s=t.length;i<s;i++){const o=t[i];this._sortChildren(o)}}}_getSpatialSortFunc(){const e=this.viewer,t=e.scene,i=t.camera,s=e.metaScene;return this._spatialSortFunc||(this._spatialSortFunc=(o,n)=>{(!o.aabb||!n.aabb)&&(o.aabb||(o.aabb=t.getAABB(s.getObjectIDsInSubtree(o.objectId))),n.aabb||(n.aabb=t.getAABB(s.getObjectIDsInSubtree(n.objectId))));let a=0;return i.xUp?a=0:i.yUp?a=1:a=2,o.aabb[a]>n.aabb[a]?-1:o.aabb[a]<n.aabb[a]?1:0})}_alphaSortFunc(e,t){const i=e.title.toUpperCase(),s=t.title.toUpperCase();return i<s?-1:i>s?1:0}_synchNodesToEntities(){const e=Object.keys(this.viewer.metaScene.metaObjects),t=this._viewer.metaScene.metaObjects,i=this._viewer.scene.objects;for(let s=0,o=e.length;s<o;s++){const n=e[s];if(t[n]){const A=this._objectNodes[n];if(A){const l=i[n];if(l){const h=l.visible;A.numEntities=1,A.xrayed=l.xrayed,h?(A.numVisibleEntities=1,A.checked=!0):(A.numVisibleEntities=0,A.checked=!1);let d=A.parent;for(;d;)d.numEntities++,h&&(d.numVisibleEntities++,d.checked=!0),d=d.parent}}}}}_withNodeTree(e,t){t(e);const i=e.children;if(i)for(let s=0,o=i.length;s<o;s++)this._withNodeTree(i[s],t)}_createTrees(){if(this._rootNodes.length===0)return;const e=this._rootNodes.map(i=>this._createNodeElement(i)),t=this._renderService.createRootNode();e.forEach(i=>{t.appendChild(i)}),this._containerElement.appendChild(t),this._rootElement=t}_createNodeElement(e){const t=s=>{this.fire("contextmenu",{event:s,viewer:this._viewer,treeViewPlugin:this,treeViewNode:e}),s.preventDefault()},i=s=>{this.fire("nodeTitleClicked",{event:s,viewer:this._viewer,treeViewPlugin:this,treeViewNode:e}),s.preventDefault()};return this._renderService.createNodeElement(e,this._switchExpandHandler,this._checkboxChangeHandler,t,i)}_expandSwitchElement(e){if(this._renderService.isExpanded(e))return;const i=this._renderService.getId(e),s=this._nodeNodes[i].children.map(o=>this._createNodeElement(o));this._renderService.addChildren(e,s),this._renderService.expand(e,this._switchExpandHandler,this._switchCollapseHandler)}_collapseNode(e){const t=this._renderService.getSwitchElement(e);this._collapseSwitchElement(t)}_collapseSwitchElement(e){this._renderService.collapse(e,this._switchExpandHandler,this._switchCollapseHandler)}}/*! pako 2.1.0 https://github.com/nodeca/pako @license (MIT AND Zlib) */(function(r,e){typeof vc=="object"&&typeof Qa<"u"?e(vc):typeof define=="function"&&define.amd?define(["exports"],e):e((r=typeof globalThis<"u"?globalThis:r||self).pako={})})(void 0,function(r){function e(p){let w=p.length;for(;--w>=0;)p[w]=0}const t=256,i=286,s=30,o=15,n=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),a=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),A=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),l=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),h=new Array(576);e(h);const d=new Array(60);e(d);const f=new Array(512);e(f);const m=new Array(256);e(m);const _=new Array(29);e(_);const u=new Array(s);function B(p,w,g,T,M){this.static_tree=p,this.extra_bits=w,this.extra_base=g,this.elems=T,this.max_length=M,this.has_stree=p&&p.length}let y,x,P;function v(p,w){this.dyn_tree=p,this.max_code=0,this.stat_desc=w}e(u);const b=p=>p<256?f[p]:f[256+(p>>>7)],C=(p,w)=>{p.pending_buf[p.pending++]=255&w,p.pending_buf[p.pending++]=w>>>8&255},I=(p,w,g)=>{p.bi_valid>16-g?(p.bi_buf|=w<<p.bi_valid&65535,C(p,p.bi_buf),p.bi_buf=w>>16-p.bi_valid,p.bi_valid+=g-16):(p.bi_buf|=w<<p.bi_valid&65535,p.bi_valid+=g)},E=(p,w,g)=>{I(p,g[2*w],g[2*w+1])},S=(p,w)=>{let g=0;do g|=1&p,p>>>=1,g<<=1;while(--w>0);return g>>>1},R=(p,w,g)=>{const T=new Array(16);let M,F,q=0;for(M=1;M<=o;M++)q=q+g[M-1]<<1,T[M]=q;for(F=0;F<=w;F++){let N=p[2*F+1];N!==0&&(p[2*F]=S(T[N]++,N))}},D=p=>{let w;for(w=0;w<i;w++)p.dyn_ltree[2*w]=0;for(w=0;w<s;w++)p.dyn_dtree[2*w]=0;for(w=0;w<19;w++)p.bl_tree[2*w]=0;p.dyn_ltree[512]=1,p.opt_len=p.static_len=0,p.sym_next=p.matches=0},K=p=>{p.bi_valid>8?C(p,p.bi_buf):p.bi_valid>0&&(p.pending_buf[p.pending++]=p.bi_buf),p.bi_buf=0,p.bi_valid=0},j=(p,w,g,T)=>{const M=2*w,F=2*g;return p[M]<p[F]||p[M]===p[F]&&T[w]<=T[g]},z=(p,w,g)=>{const T=p.heap[g];let M=g<<1;for(;M<=p.heap_len&&(M<p.heap_len&&j(w,p.heap[M+1],p.heap[M],p.depth)&&M++,!j(w,T,p.heap[M],p.depth));)p.heap[g]=p.heap[M],g=M,M<<=1;p.heap[g]=T},le=(p,w,g)=>{let T,M,F,q,N=0;if(p.sym_next!==0)do T=255&p.pending_buf[p.sym_buf+N++],T+=(255&p.pending_buf[p.sym_buf+N++])<<8,M=p.pending_buf[p.sym_buf+N++],T===0?E(p,M,w):(F=m[M],E(p,F+t+1,w),q=n[F],q!==0&&(M-=_[F],I(p,M,q)),T--,F=b(T),E(p,F,g),q=a[F],q!==0&&(T-=u[F],I(p,T,q)));while(N<p.sym_next);E(p,256,w)},ue=(p,w)=>{const g=w.dyn_tree,T=w.stat_desc.static_tree,M=w.stat_desc.has_stree,F=w.stat_desc.elems;let q,N,_e,H=-1;for(p.heap_len=0,p.heap_max=573,q=0;q<F;q++)g[2*q]!==0?(p.heap[++p.heap_len]=H=q,p.depth[q]=0):g[2*q+1]=0;for(;p.heap_len<2;)_e=p.heap[++p.heap_len]=H<2?++H:0,g[2*_e]=1,p.depth[_e]=0,p.opt_len--,M&&(p.static_len-=T[2*_e+1]);for(w.max_code=H,q=p.heap_len>>1;q>=1;q--)z(p,g,q);_e=F;do q=p.heap[1],p.heap[1]=p.heap[p.heap_len--],z(p,g,1),N=p.heap[1],p.heap[--p.heap_max]=q,p.heap[--p.heap_max]=N,g[2*_e]=g[2*q]+g[2*N],p.depth[_e]=(p.depth[q]>=p.depth[N]?p.depth[q]:p.depth[N])+1,g[2*q+1]=g[2*N+1]=_e,p.heap[1]=_e++,z(p,g,1);while(p.heap_len>=2);p.heap[--p.heap_max]=p.heap[1],((J,$e)=>{const Ve=$e.dyn_tree,ve=$e.max_code,Tt=$e.stat_desc.static_tree,lt=$e.stat_desc.has_stree,We=$e.stat_desc.extra_bits,dt=$e.stat_desc.extra_base,qe=$e.stat_desc.max_length;let we,Ye,pt,Me,At,et,Xe=0;for(Me=0;Me<=o;Me++)J.bl_count[Me]=0;for(Ve[2*J.heap[J.heap_max]+1]=0,we=J.heap_max+1;we<573;we++)Ye=J.heap[we],Me=Ve[2*Ve[2*Ye+1]+1]+1,Me>qe&&(Me=qe,Xe++),Ve[2*Ye+1]=Me,Ye>ve||(J.bl_count[Me]++,At=0,Ye>=dt&&(At=We[Ye-dt]),et=Ve[2*Ye],J.opt_len+=et*(Me+At),lt&&(J.static_len+=et*(Tt[2*Ye+1]+At)));if(Xe!==0){do{for(Me=qe-1;J.bl_count[Me]===0;)Me--;J.bl_count[Me]--,J.bl_count[Me+1]+=2,J.bl_count[qe]--,Xe-=2}while(Xe>0);for(Me=qe;Me!==0;Me--)for(Ye=J.bl_count[Me];Ye!==0;)pt=J.heap[--we],pt>ve||(Ve[2*pt+1]!==Me&&(J.opt_len+=(Me-Ve[2*pt+1])*Ve[2*pt],Ve[2*pt+1]=Me),Ye--)}})(p,w),R(g,H,p.bl_count)},ae=(p,w,g)=>{let T,M,F=-1,q=w[1],N=0,_e=7,H=4;for(q===0&&(_e=138,H=3),w[2*(g+1)+1]=65535,T=0;T<=g;T++)M=q,q=w[2*(T+1)+1],++N<_e&&M===q||(N<H?p.bl_tree[2*M]+=N:M!==0?(M!==F&&p.bl_tree[2*M]++,p.bl_tree[32]++):N<=10?p.bl_tree[34]++:p.bl_tree[36]++,N=0,F=M,q===0?(_e=138,H=3):M===q?(_e=6,H=3):(_e=7,H=4))},Be=(p,w,g)=>{let T,M,F=-1,q=w[1],N=0,_e=7,H=4;for(q===0&&(_e=138,H=3),T=0;T<=g;T++)if(M=q,q=w[2*(T+1)+1],!(++N<_e&&M===q)){if(N<H)do E(p,M,p.bl_tree);while(--N!=0);else M!==0?(M!==F&&(E(p,M,p.bl_tree),N--),E(p,16,p.bl_tree),I(p,N-3,2)):N<=10?(E(p,17,p.bl_tree),I(p,N-3,3)):(E(p,18,p.bl_tree),I(p,N-11,7));N=0,F=M,q===0?(_e=138,H=3):M===q?(_e=6,H=3):(_e=7,H=4)}};let be=!1;const xe=(p,w,g,T)=>{I(p,0+(T?1:0),3),K(p),C(p,g),C(p,~g),g&&p.pending_buf.set(p.window.subarray(w,w+g),p.pending),p.pending+=g};var Ie=(p,w,g,T)=>{let M,F,q=0;p.level>0?(p.strm.data_type===2&&(p.strm.data_type=(N=>{let _e,H=4093624447;for(_e=0;_e<=31;_e++,H>>>=1)if(1&H&&N.dyn_ltree[2*_e]!==0)return 0;if(N.dyn_ltree[18]!==0||N.dyn_ltree[20]!==0||N.dyn_ltree[26]!==0)return 1;for(_e=32;_e<t;_e++)if(N.dyn_ltree[2*_e]!==0)return 1;return 0})(p)),ue(p,p.l_desc),ue(p,p.d_desc),q=(N=>{let _e;for(ae(N,N.dyn_ltree,N.l_desc.max_code),ae(N,N.dyn_dtree,N.d_desc.max_code),ue(N,N.bl_desc),_e=18;_e>=3&&N.bl_tree[2*l[_e]+1]===0;_e--);return N.opt_len+=3*(_e+1)+5+5+4,_e})(p),M=p.opt_len+3+7>>>3,F=p.static_len+3+7>>>3,F<=M&&(M=F)):M=F=g+5,g+4<=M&&w!==-1?xe(p,w,g,T):p.strategy===4||F===M?(I(p,2+(T?1:0),3),le(p,h,d)):(I(p,4+(T?1:0),3),((N,_e,H,J)=>{let $e;for(I(N,_e-257,5),I(N,H-1,5),I(N,J-4,4),$e=0;$e<J;$e++)I(N,N.bl_tree[2*l[$e]+1],3);Be(N,N.dyn_ltree,_e-1),Be(N,N.dyn_dtree,H-1)})(p,p.l_desc.max_code+1,p.d_desc.max_code+1,q+1),le(p,p.dyn_ltree,p.dyn_dtree)),D(p),T&&K(p)},Fe={_tr_init:p=>{be||((()=>{let w,g,T,M,F;const q=new Array(16);for(T=0,M=0;M<28;M++)for(_[M]=T,w=0;w<1<<n[M];w++)m[T++]=M;for(m[T-1]=M,F=0,M=0;M<16;M++)for(u[M]=F,w=0;w<1<<a[M];w++)f[F++]=M;for(F>>=7;M<s;M++)for(u[M]=F<<7,w=0;w<1<<a[M]-7;w++)f[256+F++]=M;for(g=0;g<=o;g++)q[g]=0;for(w=0;w<=143;)h[2*w+1]=8,w++,q[8]++;for(;w<=255;)h[2*w+1]=9,w++,q[9]++;for(;w<=279;)h[2*w+1]=7,w++,q[7]++;for(;w<=287;)h[2*w+1]=8,w++,q[8]++;for(R(h,287,q),w=0;w<s;w++)d[2*w+1]=5,d[2*w]=S(w,5);y=new B(h,n,257,i,o),x=new B(d,a,0,s,o),P=new B(new Array(0),A,0,19,7)})(),be=!0),p.l_desc=new v(p.dyn_ltree,y),p.d_desc=new v(p.dyn_dtree,x),p.bl_desc=new v(p.bl_tree,P),p.bi_buf=0,p.bi_valid=0,D(p)},_tr_stored_block:xe,_tr_flush_block:Ie,_tr_tally:(p,w,g)=>(p.pending_buf[p.sym_buf+p.sym_next++]=w,p.pending_buf[p.sym_buf+p.sym_next++]=w>>8,p.pending_buf[p.sym_buf+p.sym_next++]=g,w===0?p.dyn_ltree[2*g]++:(p.matches++,w--,p.dyn_ltree[2*(m[g]+t+1)]++,p.dyn_dtree[2*b(w)]++),p.sym_next===p.sym_end),_tr_align:p=>{I(p,2,3),E(p,256,h),(w=>{w.bi_valid===16?(C(w,w.bi_buf),w.bi_buf=0,w.bi_valid=0):w.bi_valid>=8&&(w.pending_buf[w.pending++]=255&w.bi_buf,w.bi_buf>>=8,w.bi_valid-=8)})(p)}},Qe=(p,w,g,T)=>{let M=65535&p|0,F=p>>>16&65535|0,q=0;for(;g!==0;){q=g>2e3?2e3:g,g-=q;do M=M+w[T++]|0,F=F+M|0;while(--q);M%=65521,F%=65521}return M|F<<16|0};const Ge=new Uint32Array((()=>{let p,w=[];for(var g=0;g<256;g++){p=g;for(var T=0;T<8;T++)p=1&p?3988292384^p>>>1:p>>>1;w[g]=p}return w})());var V=(p,w,g,T)=>{const M=Ge,F=T+g;p^=-1;for(let q=T;q<F;q++)p=p>>>8^M[255&(p^w[q])];return-1^p},Z={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},L={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:Q,_tr_stored_block:O,_tr_flush_block:W,_tr_tally:X,_tr_align:te}=Fe,{Z_NO_FLUSH:se,Z_PARTIAL_FLUSH:ie,Z_FULL_FLUSH:oe,Z_FINISH:he,Z_BLOCK:ce,Z_OK:$,Z_STREAM_END:ee,Z_STREAM_ERROR:ge,Z_DATA_ERROR:re,Z_BUF_ERROR:me,Z_DEFAULT_COMPRESSION:de,Z_FILTERED:Y,Z_HUFFMAN_ONLY:Ue,Z_RLE:pe,Z_FIXED:De,Z_DEFAULT_STRATEGY:fe,Z_UNKNOWN:je,Z_DEFLATED:Ae}=L,Re=258,ze=262,ne=42,ke=113,Ke=666,Ne=(p,w)=>(p.msg=Z[w],w),it=p=>2*p-(p>4?9:0),Ze=p=>{let w=p.length;for(;--w>=0;)p[w]=0},at=p=>{let w,g,T,M=p.w_size;w=p.hash_size,T=w;do g=p.head[--T],p.head[T]=g>=M?g-M:0;while(--w);w=M,T=w;do g=p.prev[--T],p.prev[T]=g>=M?g-M:0;while(--w)};let Ce=(p,w,g)=>(w<<p.hash_shift^g)&p.hash_mask;const ot=p=>{const w=p.state;let g=w.pending;g>p.avail_out&&(g=p.avail_out),g!==0&&(p.output.set(w.pending_buf.subarray(w.pending_out,w.pending_out+g),p.next_out),p.next_out+=g,w.pending_out+=g,p.total_out+=g,p.avail_out-=g,w.pending-=g,w.pending===0&&(w.pending_out=0))},Je=(p,w)=>{W(p,p.block_start>=0?p.block_start:-1,p.strstart-p.block_start,w),p.block_start=p.strstart,ot(p.strm)},Te=(p,w)=>{p.pending_buf[p.pending++]=w},Pe=(p,w)=>{p.pending_buf[p.pending++]=w>>>8&255,p.pending_buf[p.pending++]=255&w},ht=(p,w,g,T)=>{let M=p.avail_in;return M>T&&(M=T),M===0?0:(p.avail_in-=M,w.set(p.input.subarray(p.next_in,p.next_in+M),g),p.state.wrap===1?p.adler=Qe(p.adler,w,M,g):p.state.wrap===2&&(p.adler=V(p.adler,w,M,g)),p.next_in+=M,p.total_in+=M,M)},St=(p,w)=>{let g,T,M=p.max_chain_length,F=p.strstart,q=p.prev_length,N=p.nice_match;const _e=p.strstart>p.w_size-ze?p.strstart-(p.w_size-ze):0,H=p.window,J=p.w_mask,$e=p.prev,Ve=p.strstart+Re;let ve=H[F+q-1],Tt=H[F+q];p.prev_length>=p.good_match&&(M>>=2),N>p.lookahead&&(N=p.lookahead);do if(g=w,H[g+q]===Tt&&H[g+q-1]===ve&&H[g]===H[F]&&H[++g]===H[F+1]){F+=2,g++;do;while(H[++F]===H[++g]&&H[++F]===H[++g]&&H[++F]===H[++g]&&H[++F]===H[++g]&&H[++F]===H[++g]&&H[++F]===H[++g]&&H[++F]===H[++g]&&H[++F]===H[++g]&&F<Ve);if(T=Re-(Ve-F),F=Ve-Re,T>q){if(p.match_start=w,q=T,T>=N)break;ve=H[F+q-1],Tt=H[F+q]}}while((w=$e[w&J])>_e&&--M!=0);return q<=p.lookahead?q:p.lookahead},ut=p=>{const w=p.w_size;let g,T,M;do{if(T=p.window_size-p.lookahead-p.strstart,p.strstart>=w+(w-ze)&&(p.window.set(p.window.subarray(w,w+w-T),0),p.match_start-=w,p.strstart-=w,p.block_start-=w,p.insert>p.strstart&&(p.insert=p.strstart),at(p),T+=w),p.strm.avail_in===0)break;if(g=ht(p.strm,p.window,p.strstart+p.lookahead,T),p.lookahead+=g,p.lookahead+p.insert>=3)for(M=p.strstart-p.insert,p.ins_h=p.window[M],p.ins_h=Ce(p,p.ins_h,p.window[M+1]);p.insert&&(p.ins_h=Ce(p,p.ins_h,p.window[M+3-1]),p.prev[M&p.w_mask]=p.head[p.ins_h],p.head[p.ins_h]=M,M++,p.insert--,!(p.lookahead+p.insert<3)););}while(p.lookahead<ze&&p.strm.avail_in!==0)},gt=(p,w)=>{let g,T,M,F=p.pending_buf_size-5>p.w_size?p.w_size:p.pending_buf_size-5,q=0,N=p.strm.avail_in;do{if(g=65535,M=p.bi_valid+42>>3,p.strm.avail_out<M||(M=p.strm.avail_out-M,T=p.strstart-p.block_start,g>T+p.strm.avail_in&&(g=T+p.strm.avail_in),g>M&&(g=M),g<F&&(g===0&&w!==he||w===se||g!==T+p.strm.avail_in)))break;q=w===he&&g===T+p.strm.avail_in?1:0,O(p,0,0,q),p.pending_buf[p.pending-4]=g,p.pending_buf[p.pending-3]=g>>8,p.pending_buf[p.pending-2]=~g,p.pending_buf[p.pending-1]=~g>>8,ot(p.strm),T&&(T>g&&(T=g),p.strm.output.set(p.window.subarray(p.block_start,p.block_start+T),p.strm.next_out),p.strm.next_out+=T,p.strm.avail_out-=T,p.strm.total_out+=T,p.block_start+=T,g-=T),g&&(ht(p.strm,p.strm.output,p.strm.next_out,g),p.strm.next_out+=g,p.strm.avail_out-=g,p.strm.total_out+=g)}while(q===0);return N-=p.strm.avail_in,N&&(N>=p.w_size?(p.matches=2,p.window.set(p.strm.input.subarray(p.strm.next_in-p.w_size,p.strm.next_in),0),p.strstart=p.w_size,p.insert=p.strstart):(p.window_size-p.strstart<=N&&(p.strstart-=p.w_size,p.window.set(p.window.subarray(p.w_size,p.w_size+p.strstart),0),p.matches<2&&p.matches++,p.insert>p.strstart&&(p.insert=p.strstart)),p.window.set(p.strm.input.subarray(p.strm.next_in-N,p.strm.next_in),p.strstart),p.strstart+=N,p.insert+=N>p.w_size-p.insert?p.w_size-p.insert:N),p.block_start=p.strstart),p.high_water<p.strstart&&(p.high_water=p.strstart),q?4:w!==se&&w!==he&&p.strm.avail_in===0&&p.strstart===p.block_start?2:(M=p.window_size-p.strstart,p.strm.avail_in>M&&p.block_start>=p.w_size&&(p.block_start-=p.w_size,p.strstart-=p.w_size,p.window.set(p.window.subarray(p.w_size,p.w_size+p.strstart),0),p.matches<2&&p.matches++,M+=p.w_size,p.insert>p.strstart&&(p.insert=p.strstart)),M>p.strm.avail_in&&(M=p.strm.avail_in),M&&(ht(p.strm,p.window,p.strstart,M),p.strstart+=M,p.insert+=M>p.w_size-p.insert?p.w_size-p.insert:M),p.high_water<p.strstart&&(p.high_water=p.strstart),M=p.bi_valid+42>>3,M=p.pending_buf_size-M>65535?65535:p.pending_buf_size-M,F=M>p.w_size?p.w_size:M,T=p.strstart-p.block_start,(T>=F||(T||w===he)&&w!==se&&p.strm.avail_in===0&&T<=M)&&(g=T>M?M:T,q=w===he&&p.strm.avail_in===0&&g===T?1:0,O(p,p.block_start,g,q),p.block_start+=g,ot(p.strm)),q?3:1)},kt=(p,w)=>{let g,T;for(;;){if(p.lookahead<ze){if(ut(p),p.lookahead<ze&&w===se)return 1;if(p.lookahead===0)break}if(g=0,p.lookahead>=3&&(p.ins_h=Ce(p,p.ins_h,p.window[p.strstart+3-1]),g=p.prev[p.strstart&p.w_mask]=p.head[p.ins_h],p.head[p.ins_h]=p.strstart),g!==0&&p.strstart-g<=p.w_size-ze&&(p.match_length=St(p,g)),p.match_length>=3)if(T=X(p,p.strstart-p.match_start,p.match_length-3),p.lookahead-=p.match_length,p.match_length<=p.max_lazy_match&&p.lookahead>=3){p.match_length--;do p.strstart++,p.ins_h=Ce(p,p.ins_h,p.window[p.strstart+3-1]),g=p.prev[p.strstart&p.w_mask]=p.head[p.ins_h],p.head[p.ins_h]=p.strstart;while(--p.match_length!=0);p.strstart++}else p.strstart+=p.match_length,p.match_length=0,p.ins_h=p.window[p.strstart],p.ins_h=Ce(p,p.ins_h,p.window[p.strstart+1]);else T=X(p,0,p.window[p.strstart]),p.lookahead--,p.strstart++;if(T&&(Je(p,!1),p.strm.avail_out===0))return 1}return p.insert=p.strstart<2?p.strstart:2,w===he?(Je(p,!0),p.strm.avail_out===0?3:4):p.sym_next&&(Je(p,!1),p.strm.avail_out===0)?1:2},Ii=(p,w)=>{let g,T,M;for(;;){if(p.lookahead<ze){if(ut(p),p.lookahead<ze&&w===se)return 1;if(p.lookahead===0)break}if(g=0,p.lookahead>=3&&(p.ins_h=Ce(p,p.ins_h,p.window[p.strstart+3-1]),g=p.prev[p.strstart&p.w_mask]=p.head[p.ins_h],p.head[p.ins_h]=p.strstart),p.prev_length=p.match_length,p.prev_match=p.match_start,p.match_length=2,g!==0&&p.prev_length<p.max_lazy_match&&p.strstart-g<=p.w_size-ze&&(p.match_length=St(p,g),p.match_length<=5&&(p.strategy===Y||p.match_length===3&&p.strstart-p.match_start>4096)&&(p.match_length=2)),p.prev_length>=3&&p.match_length<=p.prev_length){M=p.strstart+p.lookahead-3,T=X(p,p.strstart-1-p.prev_match,p.prev_length-3),p.lookahead-=p.prev_length-1,p.prev_length-=2;do++p.strstart<=M&&(p.ins_h=Ce(p,p.ins_h,p.window[p.strstart+3-1]),g=p.prev[p.strstart&p.w_mask]=p.head[p.ins_h],p.head[p.ins_h]=p.strstart);while(--p.prev_length!=0);if(p.match_available=0,p.match_length=2,p.strstart++,T&&(Je(p,!1),p.strm.avail_out===0))return 1}else if(p.match_available){if(T=X(p,0,p.window[p.strstart-1]),T&&Je(p,!1),p.strstart++,p.lookahead--,p.strm.avail_out===0)return 1}else p.match_available=1,p.strstart++,p.lookahead--}return p.match_available&&(T=X(p,0,p.window[p.strstart-1]),p.match_available=0),p.insert=p.strstart<2?p.strstart:2,w===he?(Je(p,!0),p.strm.avail_out===0?3:4):p.sym_next&&(Je(p,!1),p.strm.avail_out===0)?1:2};function yt(p,w,g,T,M){this.good_length=p,this.max_lazy=w,this.nice_length=g,this.max_chain=T,this.func=M}const Or=[new yt(0,0,0,0,gt),new yt(4,4,8,4,kt),new yt(4,5,16,8,kt),new yt(4,6,32,32,kt),new yt(4,4,16,16,Ii),new yt(8,16,32,32,Ii),new yt(8,16,128,128,Ii),new yt(8,32,128,256,Ii),new yt(32,128,258,1024,Ii),new yt(32,258,258,4096,Ii)];function e_(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=Ae,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(1146),this.dyn_dtree=new Uint16Array(122),this.bl_tree=new Uint16Array(78),Ze(this.dyn_ltree),Ze(this.dyn_dtree),Ze(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(16),this.heap=new Uint16Array(573),Ze(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(573),Ze(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const kr=p=>{if(!p)return 1;const w=p.state;return!w||w.strm!==p||w.status!==ne&&w.status!==57&&w.status!==69&&w.status!==73&&w.status!==91&&w.status!==103&&w.status!==ke&&w.status!==Ke?1:0},kc=p=>{if(kr(p))return Ne(p,ge);p.total_in=p.total_out=0,p.data_type=je;const w=p.state;return w.pending=0,w.pending_out=0,w.wrap<0&&(w.wrap=-w.wrap),w.status=w.wrap===2?57:w.wrap?ne:ke,p.adler=w.wrap===2?0:1,w.last_flush=-2,Q(w),$},Nc=p=>{const w=kc(p);var g;return w===$&&((g=p.state).window_size=2*g.w_size,Ze(g.head),g.max_lazy_match=Or[g.level].max_lazy,g.good_match=Or[g.level].good_length,g.nice_match=Or[g.level].nice_length,g.max_chain_length=Or[g.level].max_chain,g.strstart=0,g.block_start=0,g.lookahead=0,g.insert=0,g.match_length=g.prev_length=2,g.match_available=0,g.ins_h=0),w},Qc=(p,w,g,T,M,F)=>{if(!p)return ge;let q=1;if(w===de&&(w=6),T<0?(q=0,T=-T):T>15&&(q=2,T-=16),M<1||M>9||g!==Ae||T<8||T>15||w<0||w>9||F<0||F>De||T===8&&q!==1)return Ne(p,ge);T===8&&(T=9);const N=new e_;return p.state=N,N.strm=p,N.status=ne,N.wrap=q,N.gzhead=null,N.w_bits=T,N.w_size=1<<N.w_bits,N.w_mask=N.w_size-1,N.hash_bits=M+7,N.hash_size=1<<N.hash_bits,N.hash_mask=N.hash_size-1,N.hash_shift=~~((N.hash_bits+3-1)/3),N.window=new Uint8Array(2*N.w_size),N.head=new Uint16Array(N.hash_size),N.prev=new Uint16Array(N.w_size),N.lit_bufsize=1<<M+6,N.pending_buf_size=4*N.lit_bufsize,N.pending_buf=new Uint8Array(N.pending_buf_size),N.sym_buf=N.lit_bufsize,N.sym_end=3*(N.lit_bufsize-1),N.level=w,N.strategy=F,N.method=g,Nc(p)};var Nr={deflateInit:(p,w)=>Qc(p,w,Ae,15,8,fe),deflateInit2:Qc,deflateReset:Nc,deflateResetKeep:kc,deflateSetHeader:(p,w)=>kr(p)||p.state.wrap!==2?ge:(p.state.gzhead=w,$),deflate:(p,w)=>{if(kr(p)||w>ce||w<0)return p?Ne(p,ge):ge;const g=p.state;if(!p.output||p.avail_in!==0&&!p.input||g.status===Ke&&w!==he)return Ne(p,p.avail_out===0?me:ge);const T=g.last_flush;if(g.last_flush=w,g.pending!==0){if(ot(p),p.avail_out===0)return g.last_flush=-1,$}else if(p.avail_in===0&&it(w)<=it(T)&&w!==he)return Ne(p,me);if(g.status===Ke&&p.avail_in!==0)return Ne(p,me);if(g.status===ne&&g.wrap===0&&(g.status=ke),g.status===ne){let M=Ae+(g.w_bits-8<<4)<<8,F=-1;if(F=g.strategy>=Ue||g.level<2?0:g.level<6?1:g.level===6?2:3,M|=F<<6,g.strstart!==0&&(M|=32),M+=31-M%31,Pe(g,M),g.strstart!==0&&(Pe(g,p.adler>>>16),Pe(g,65535&p.adler)),p.adler=1,g.status=ke,ot(p),g.pending!==0)return g.last_flush=-1,$}if(g.status===57){if(p.adler=0,Te(g,31),Te(g,139),Te(g,8),g.gzhead)Te(g,(g.gzhead.text?1:0)+(g.gzhead.hcrc?2:0)+(g.gzhead.extra?4:0)+(g.gzhead.name?8:0)+(g.gzhead.comment?16:0)),Te(g,255&g.gzhead.time),Te(g,g.gzhead.time>>8&255),Te(g,g.gzhead.time>>16&255),Te(g,g.gzhead.time>>24&255),Te(g,g.level===9?2:g.strategy>=Ue||g.level<2?4:0),Te(g,255&g.gzhead.os),g.gzhead.extra&&g.gzhead.extra.length&&(Te(g,255&g.gzhead.extra.length),Te(g,g.gzhead.extra.length>>8&255)),g.gzhead.hcrc&&(p.adler=V(p.adler,g.pending_buf,g.pending,0)),g.gzindex=0,g.status=69;else if(Te(g,0),Te(g,0),Te(g,0),Te(g,0),Te(g,0),Te(g,g.level===9?2:g.strategy>=Ue||g.level<2?4:0),Te(g,3),g.status=ke,ot(p),g.pending!==0)return g.last_flush=-1,$}if(g.status===69){if(g.gzhead.extra){let M=g.pending,F=(65535&g.gzhead.extra.length)-g.gzindex;for(;g.pending+F>g.pending_buf_size;){let N=g.pending_buf_size-g.pending;if(g.pending_buf.set(g.gzhead.extra.subarray(g.gzindex,g.gzindex+N),g.pending),g.pending=g.pending_buf_size,g.gzhead.hcrc&&g.pending>M&&(p.adler=V(p.adler,g.pending_buf,g.pending-M,M)),g.gzindex+=N,ot(p),g.pending!==0)return g.last_flush=-1,$;M=0,F-=N}let q=new Uint8Array(g.gzhead.extra);g.pending_buf.set(q.subarray(g.gzindex,g.gzindex+F),g.pending),g.pending+=F,g.gzhead.hcrc&&g.pending>M&&(p.adler=V(p.adler,g.pending_buf,g.pending-M,M)),g.gzindex=0}g.status=73}if(g.status===73){if(g.gzhead.name){let M,F=g.pending;do{if(g.pending===g.pending_buf_size){if(g.gzhead.hcrc&&g.pending>F&&(p.adler=V(p.adler,g.pending_buf,g.pending-F,F)),ot(p),g.pending!==0)return g.last_flush=-1,$;F=0}M=g.gzindex<g.gzhead.name.length?255&g.gzhead.name.charCodeAt(g.gzindex++):0,Te(g,M)}while(M!==0);g.gzhead.hcrc&&g.pending>F&&(p.adler=V(p.adler,g.pending_buf,g.pending-F,F)),g.gzindex=0}g.status=91}if(g.status===91){if(g.gzhead.comment){let M,F=g.pending;do{if(g.pending===g.pending_buf_size){if(g.gzhead.hcrc&&g.pending>F&&(p.adler=V(p.adler,g.pending_buf,g.pending-F,F)),ot(p),g.pending!==0)return g.last_flush=-1,$;F=0}M=g.gzindex<g.gzhead.comment.length?255&g.gzhead.comment.charCodeAt(g.gzindex++):0,Te(g,M)}while(M!==0);g.gzhead.hcrc&&g.pending>F&&(p.adler=V(p.adler,g.pending_buf,g.pending-F,F))}g.status=103}if(g.status===103){if(g.gzhead.hcrc){if(g.pending+2>g.pending_buf_size&&(ot(p),g.pending!==0))return g.last_flush=-1,$;Te(g,255&p.adler),Te(g,p.adler>>8&255),p.adler=0}if(g.status=ke,ot(p),g.pending!==0)return g.last_flush=-1,$}if(p.avail_in!==0||g.lookahead!==0||w!==se&&g.status!==Ke){let M=g.level===0?gt(g,w):g.strategy===Ue?((F,q)=>{let N;for(;;){if(F.lookahead===0&&(ut(F),F.lookahead===0)){if(q===se)return 1;break}if(F.match_length=0,N=X(F,0,F.window[F.strstart]),F.lookahead--,F.strstart++,N&&(Je(F,!1),F.strm.avail_out===0))return 1}return F.insert=0,q===he?(Je(F,!0),F.strm.avail_out===0?3:4):F.sym_next&&(Je(F,!1),F.strm.avail_out===0)?1:2})(g,w):g.strategy===pe?((F,q)=>{let N,_e,H,J;const $e=F.window;for(;;){if(F.lookahead<=Re){if(ut(F),F.lookahead<=Re&&q===se)return 1;if(F.lookahead===0)break}if(F.match_length=0,F.lookahead>=3&&F.strstart>0&&(H=F.strstart-1,_e=$e[H],_e===$e[++H]&&_e===$e[++H]&&_e===$e[++H])){J=F.strstart+Re;do;while(_e===$e[++H]&&_e===$e[++H]&&_e===$e[++H]&&_e===$e[++H]&&_e===$e[++H]&&_e===$e[++H]&&_e===$e[++H]&&_e===$e[++H]&&H<J);F.match_length=Re-(J-H),F.match_length>F.lookahead&&(F.match_length=F.lookahead)}if(F.match_length>=3?(N=X(F,1,F.match_length-3),F.lookahead-=F.match_length,F.strstart+=F.match_length,F.match_length=0):(N=X(F,0,F.window[F.strstart]),F.lookahead--,F.strstart++),N&&(Je(F,!1),F.strm.avail_out===0))return 1}return F.insert=0,q===he?(Je(F,!0),F.strm.avail_out===0?3:4):F.sym_next&&(Je(F,!1),F.strm.avail_out===0)?1:2})(g,w):Or[g.level].func(g,w);if(M!==3&&M!==4||(g.status=Ke),M===1||M===3)return p.avail_out===0&&(g.last_flush=-1),$;if(M===2&&(w===ie?te(g):w!==ce&&(O(g,0,0,!1),w===oe&&(Ze(g.head),g.lookahead===0&&(g.strstart=0,g.block_start=0,g.insert=0))),ot(p),p.avail_out===0))return g.last_flush=-1,$}return w!==he?$:g.wrap<=0?ee:(g.wrap===2?(Te(g,255&p.adler),Te(g,p.adler>>8&255),Te(g,p.adler>>16&255),Te(g,p.adler>>24&255),Te(g,255&p.total_in),Te(g,p.total_in>>8&255),Te(g,p.total_in>>16&255),Te(g,p.total_in>>24&255)):(Pe(g,p.adler>>>16),Pe(g,65535&p.adler)),ot(p),g.wrap>0&&(g.wrap=-g.wrap),g.pending!==0?$:ee)},deflateEnd:p=>{if(kr(p))return ge;const w=p.state.status;return p.state=null,w===ke?Ne(p,re):$},deflateSetDictionary:(p,w)=>{let g=w.length;if(kr(p))return ge;const T=p.state,M=T.wrap;if(M===2||M===1&&T.status!==ne||T.lookahead)return ge;if(M===1&&(p.adler=Qe(p.adler,w,g,0)),T.wrap=0,g>=T.w_size){M===0&&(Ze(T.head),T.strstart=0,T.block_start=0,T.insert=0);let _e=new Uint8Array(T.w_size);_e.set(w.subarray(g-T.w_size,g),0),w=_e,g=T.w_size}const F=p.avail_in,q=p.next_in,N=p.input;for(p.avail_in=g,p.next_in=0,p.input=w,ut(T);T.lookahead>=3;){let _e=T.strstart,H=T.lookahead-2;do T.ins_h=Ce(T,T.ins_h,T.window[_e+3-1]),T.prev[_e&T.w_mask]=T.head[T.ins_h],T.head[T.ins_h]=_e,_e++;while(--H);T.strstart=_e,T.lookahead=2,ut(T)}return T.strstart+=T.lookahead,T.block_start=T.strstart,T.insert=T.lookahead,T.lookahead=0,T.match_length=T.prev_length=2,T.match_available=0,p.next_in=q,p.input=N,p.avail_in=F,T.wrap=M,$},deflateInfo:"pako deflate (from Nodeca project)"};const t_=(p,w)=>Object.prototype.hasOwnProperty.call(p,w);var Hc=function(p){const w=Array.prototype.slice.call(arguments,1);for(;w.length;){const g=w.shift();if(g){if(typeof g!="object")throw new TypeError(g+"must be non-object");for(const T in g)t_(g,T)&&(p[T]=g[T])}}return p},Vc=p=>{let w=0;for(let T=0,M=p.length;T<M;T++)w+=p[T].length;const g=new Uint8Array(w);for(let T=0,M=0,F=p.length;T<F;T++){let q=p[T];g.set(q,M),M+=q.length}return g};let Gc=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{Gc=!1}const Qr=new Uint8Array(256);for(let p=0;p<256;p++)Qr[p]=p>=252?6:p>=248?5:p>=240?4:p>=224?3:p>=192?2:1;Qr[254]=Qr[254]=1;var Ha=p=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(p);let w,g,T,M,F,q=p.length,N=0;for(M=0;M<q;M++)g=p.charCodeAt(M),(64512&g)==55296&&M+1<q&&(T=p.charCodeAt(M+1),(64512&T)==56320&&(g=65536+(g-55296<<10)+(T-56320),M++)),N+=g<128?1:g<2048?2:g<65536?3:4;for(w=new Uint8Array(N),F=0,M=0;F<N;M++)g=p.charCodeAt(M),(64512&g)==55296&&M+1<q&&(T=p.charCodeAt(M+1),(64512&T)==56320&&(g=65536+(g-55296<<10)+(T-56320),M++)),g<128?w[F++]=g:g<2048?(w[F++]=192|g>>>6,w[F++]=128|63&g):g<65536?(w[F++]=224|g>>>12,w[F++]=128|g>>>6&63,w[F++]=128|63&g):(w[F++]=240|g>>>18,w[F++]=128|g>>>12&63,w[F++]=128|g>>>6&63,w[F++]=128|63&g);return w},i_=(p,w)=>{const g=w||p.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(p.subarray(0,w));let T,M;const F=new Array(2*g);for(M=0,T=0;T<g;){let q=p[T++];if(q<128){F[M++]=q;continue}let N=Qr[q];if(N>4)F[M++]=65533,T+=N-1;else{for(q&=N===2?31:N===3?15:7;N>1&&T<g;)q=q<<6|63&p[T++],N--;N>1?F[M++]=65533:q<65536?F[M++]=q:(q-=65536,F[M++]=55296|q>>10&1023,F[M++]=56320|1023&q)}}return((q,N)=>{if(N<65534&&q.subarray&&Gc)return String.fromCharCode.apply(null,q.length===N?q:q.subarray(0,N));let _e="";for(let H=0;H<N;H++)_e+=String.fromCharCode(q[H]);return _e})(F,M)},s_=(p,w)=>{(w=w||p.length)>p.length&&(w=p.length);let g=w-1;for(;g>=0&&(192&p[g])==128;)g--;return g<0||g===0?w:g+Qr[p[g]]>w?g:w},jc=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const zc=Object.prototype.toString,{Z_NO_FLUSH:r_,Z_SYNC_FLUSH:o_,Z_FULL_FLUSH:n_,Z_FINISH:a_,Z_OK:Wo,Z_STREAM_END:A_,Z_DEFAULT_COMPRESSION:l_,Z_DEFAULT_STRATEGY:c_,Z_DEFLATED:h_}=L;function Hr(p){this.options=Hc({level:l_,method:h_,chunkSize:16384,windowBits:15,memLevel:8,strategy:c_},p||{});let w=this.options;w.raw&&w.windowBits>0?w.windowBits=-w.windowBits:w.gzip&&w.windowBits>0&&w.windowBits<16&&(w.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new jc,this.strm.avail_out=0;let g=Nr.deflateInit2(this.strm,w.level,w.method,w.windowBits,w.memLevel,w.strategy);if(g!==Wo)throw new Error(Z[g]);if(w.header&&Nr.deflateSetHeader(this.strm,w.header),w.dictionary){let T;if(T=typeof w.dictionary=="string"?Ha(w.dictionary):zc.call(w.dictionary)==="[object ArrayBuffer]"?new Uint8Array(w.dictionary):w.dictionary,g=Nr.deflateSetDictionary(this.strm,T),g!==Wo)throw new Error(Z[g]);this._dict_set=!0}}function Va(p,w){const g=new Hr(w);if(g.push(p,!0),g.err)throw g.msg||Z[g.err];return g.result}Hr.prototype.push=function(p,w){const g=this.strm,T=this.options.chunkSize;let M,F;if(this.ended)return!1;for(F=w===~~w?w:w===!0?a_:r_,typeof p=="string"?g.input=Ha(p):zc.call(p)==="[object ArrayBuffer]"?g.input=new Uint8Array(p):g.input=p,g.next_in=0,g.avail_in=g.input.length;;)if(g.avail_out===0&&(g.output=new Uint8Array(T),g.next_out=0,g.avail_out=T),(F===o_||F===n_)&&g.avail_out<=6)this.onData(g.output.subarray(0,g.next_out)),g.avail_out=0;else{if(M=Nr.deflate(g,F),M===A_)return g.next_out>0&&this.onData(g.output.subarray(0,g.next_out)),M=Nr.deflateEnd(this.strm),this.onEnd(M),this.ended=!0,M===Wo;if(g.avail_out!==0){if(F>0&&g.next_out>0)this.onData(g.output.subarray(0,g.next_out)),g.avail_out=0;else if(g.avail_in===0)break}else this.onData(g.output)}return!0},Hr.prototype.onData=function(p){this.chunks.push(p)},Hr.prototype.onEnd=function(p){p===Wo&&(this.result=Vc(this.chunks)),this.chunks=[],this.err=p,this.msg=this.strm.msg};var u_={Deflate:Hr,deflate:Va,deflateRaw:function(p,w){return(w=w||{}).raw=!0,Va(p,w)},gzip:function(p,w){return(w=w||{}).gzip=!0,Va(p,w)},constants:L};const Xo=16209;var d_=function(p,w){let g,T,M,F,q,N,_e,H,J,$e,Ve,ve,Tt,lt,We,dt,qe,we,Ye,pt,Me,At,et,Xe;const rt=p.state;g=p.next_in,et=p.input,T=g+(p.avail_in-5),M=p.next_out,Xe=p.output,F=M-(w-p.avail_out),q=M+(p.avail_out-257),N=rt.dmax,_e=rt.wsize,H=rt.whave,J=rt.wnext,$e=rt.window,Ve=rt.hold,ve=rt.bits,Tt=rt.lencode,lt=rt.distcode,We=(1<<rt.lenbits)-1,dt=(1<<rt.distbits)-1;e:do{ve<15&&(Ve+=et[g++]<<ve,ve+=8,Ve+=et[g++]<<ve,ve+=8),qe=Tt[Ve&We];t:for(;;){if(we=qe>>>24,Ve>>>=we,ve-=we,we=qe>>>16&255,we===0)Xe[M++]=65535&qe;else{if(!(16&we)){if(!(64&we)){qe=Tt[(65535&qe)+(Ve&(1<<we)-1)];continue t}if(32&we){rt.mode=16191;break e}p.msg="invalid literal/length code",rt.mode=Xo;break e}Ye=65535&qe,we&=15,we&&(ve<we&&(Ve+=et[g++]<<ve,ve+=8),Ye+=Ve&(1<<we)-1,Ve>>>=we,ve-=we),ve<15&&(Ve+=et[g++]<<ve,ve+=8,Ve+=et[g++]<<ve,ve+=8),qe=lt[Ve&dt];i:for(;;){if(we=qe>>>24,Ve>>>=we,ve-=we,we=qe>>>16&255,!(16&we)){if(!(64&we)){qe=lt[(65535&qe)+(Ve&(1<<we)-1)];continue i}p.msg="invalid distance code",rt.mode=Xo;break e}if(pt=65535&qe,we&=15,ve<we&&(Ve+=et[g++]<<ve,ve+=8,ve<we&&(Ve+=et[g++]<<ve,ve+=8)),pt+=Ve&(1<<we)-1,pt>N){p.msg="invalid distance too far back",rt.mode=Xo;break e}if(Ve>>>=we,ve-=we,we=M-F,pt>we){if(we=pt-we,we>H&&rt.sane){p.msg="invalid distance too far back",rt.mode=Xo;break e}if(Me=0,At=$e,J===0){if(Me+=_e-we,we<Ye){Ye-=we;do Xe[M++]=$e[Me++];while(--we);Me=M-pt,At=Xe}}else if(J<we){if(Me+=_e+J-we,we-=J,we<Ye){Ye-=we;do Xe[M++]=$e[Me++];while(--we);if(Me=0,J<Ye){we=J,Ye-=we;do Xe[M++]=$e[Me++];while(--we);Me=M-pt,At=Xe}}}else if(Me+=J-we,we<Ye){Ye-=we;do Xe[M++]=$e[Me++];while(--we);Me=M-pt,At=Xe}for(;Ye>2;)Xe[M++]=At[Me++],Xe[M++]=At[Me++],Xe[M++]=At[Me++],Ye-=3;Ye&&(Xe[M++]=At[Me++],Ye>1&&(Xe[M++]=At[Me++]))}else{Me=M-pt;do Xe[M++]=Xe[Me++],Xe[M++]=Xe[Me++],Xe[M++]=Xe[Me++],Ye-=3;while(Ye>2);Ye&&(Xe[M++]=Xe[Me++],Ye>1&&(Xe[M++]=Xe[Me++]))}break}}break}}while(g<T&&M<q);Ye=ve>>3,g-=Ye,ve-=Ye<<3,Ve&=(1<<ve)-1,p.next_in=g,p.next_out=M,p.avail_in=g<T?T-g+5:5-(g-T),p.avail_out=M<q?q-M+257:257-(M-q),rt.hold=Ve,rt.bits=ve};const Yo=15,p_=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),f_=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),g_=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),m_=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var Vr=(p,w,g,T,M,F,q,N)=>{const _e=N.bits;let H,J,$e,Ve,ve,Tt,lt=0,We=0,dt=0,qe=0,we=0,Ye=0,pt=0,Me=0,At=0,et=0,Xe=null;const rt=new Uint16Array(16),ii=new Uint16Array(16);let zr,tn,sn,rn=null;for(lt=0;lt<=Yo;lt++)rt[lt]=0;for(We=0;We<T;We++)rt[w[g+We]]++;for(we=_e,qe=Yo;qe>=1&&rt[qe]===0;qe--);if(we>qe&&(we=qe),qe===0)return M[F++]=20971520,M[F++]=20971520,N.bits=1,0;for(dt=1;dt<qe&&rt[dt]===0;dt++);for(we<dt&&(we=dt),Me=1,lt=1;lt<=Yo;lt++)if(Me<<=1,Me-=rt[lt],Me<0)return-1;if(Me>0&&(p===0||qe!==1))return-1;for(ii[1]=0,lt=1;lt<Yo;lt++)ii[lt+1]=ii[lt]+rt[lt];for(We=0;We<T;We++)w[g+We]!==0&&(q[ii[w[g+We]]++]=We);if(p===0?(Xe=rn=q,Tt=20):p===1?(Xe=p_,rn=f_,Tt=257):(Xe=g_,rn=m_,Tt=0),et=0,We=0,lt=dt,ve=F,Ye=we,pt=0,$e=-1,At=1<<we,Ve=At-1,p===1&&At>852||p===2&&At>592)return 1;for(;;){zr=lt-pt,q[We]+1<Tt?(tn=0,sn=q[We]):q[We]>=Tt?(tn=rn[q[We]-Tt],sn=Xe[q[We]-Tt]):(tn=96,sn=0),H=1<<lt-pt,J=1<<Ye,dt=J;do J-=H,M[ve+(et>>pt)+J]=zr<<24|tn<<16|sn|0;while(J!==0);for(H=1<<lt-1;et&H;)H>>=1;if(H!==0?(et&=H-1,et+=H):et=0,We++,--rt[lt]==0){if(lt===qe)break;lt=w[g+q[We]]}if(lt>we&&(et&Ve)!==$e){for(pt===0&&(pt=we),ve+=dt,Ye=lt-pt,Me=1<<Ye;Ye+pt<qe&&(Me-=rt[Ye+pt],!(Me<=0));)Ye++,Me<<=1;if(At+=1<<Ye,p===1&&At>852||p===2&&At>592)return 1;$e=et&Ve,M[$e]=we<<24|Ye<<16|ve-F|0}}return et!==0&&(M[ve+et]=lt-pt<<24|64<<16|0),N.bits=we,0};const{Z_FINISH:Kc,Z_BLOCK:__,Z_TREES:Jo,Z_OK:ws,Z_STREAM_END:v_,Z_NEED_DICT:B_,Z_STREAM_ERROR:mi,Z_DATA_ERROR:Wc,Z_MEM_ERROR:Xc,Z_BUF_ERROR:P_,Z_DEFLATED:Yc}=L,Zo=16180,qo=16190,Xi=16191,Ga=16192,ja=16194,$o=16199,en=16200,za=16206,bt=16209,Jc=p=>(p>>>24&255)+(p>>>8&65280)+((65280&p)<<8)+((255&p)<<24);function y_(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const bs=p=>{if(!p)return 1;const w=p.state;return!w||w.strm!==p||w.mode<Zo||w.mode>16211?1:0},Zc=p=>{if(bs(p))return mi;const w=p.state;return p.total_in=p.total_out=w.total=0,p.msg="",w.wrap&&(p.adler=1&w.wrap),w.mode=Zo,w.last=0,w.havedict=0,w.flags=-1,w.dmax=32768,w.head=null,w.hold=0,w.bits=0,w.lencode=w.lendyn=new Int32Array(852),w.distcode=w.distdyn=new Int32Array(592),w.sane=1,w.back=-1,ws},qc=p=>{if(bs(p))return mi;const w=p.state;return w.wsize=0,w.whave=0,w.wnext=0,Zc(p)},$c=(p,w)=>{let g;if(bs(p))return mi;const T=p.state;return w<0?(g=0,w=-w):(g=5+(w>>4),w<48&&(w&=15)),w&&(w<8||w>15)?mi:(T.window!==null&&T.wbits!==w&&(T.window=null),T.wrap=g,T.wbits=w,qc(p))},eh=(p,w)=>{if(!p)return mi;const g=new y_;p.state=g,g.strm=p,g.window=null,g.mode=Zo;const T=$c(p,w);return T!==ws&&(p.state=null),T};let Ka,Wa,th=!0;const x_=p=>{if(th){Ka=new Int32Array(512),Wa=new Int32Array(32);let w=0;for(;w<144;)p.lens[w++]=8;for(;w<256;)p.lens[w++]=9;for(;w<280;)p.lens[w++]=7;for(;w<288;)p.lens[w++]=8;for(Vr(1,p.lens,0,288,Ka,0,p.work,{bits:9}),w=0;w<32;)p.lens[w++]=5;Vr(2,p.lens,0,32,Wa,0,p.work,{bits:5}),th=!1}p.lencode=Ka,p.lenbits=9,p.distcode=Wa,p.distbits=5},ih=(p,w,g,T)=>{let M;const F=p.state;return F.window===null&&(F.wsize=1<<F.wbits,F.wnext=0,F.whave=0,F.window=new Uint8Array(F.wsize)),T>=F.wsize?(F.window.set(w.subarray(g-F.wsize,g),0),F.wnext=0,F.whave=F.wsize):(M=F.wsize-F.wnext,M>T&&(M=T),F.window.set(w.subarray(g-T,g-T+M),F.wnext),(T-=M)?(F.window.set(w.subarray(g-T,g),0),F.wnext=T,F.whave=F.wsize):(F.wnext+=M,F.wnext===F.wsize&&(F.wnext=0),F.whave<F.wsize&&(F.whave+=M))),0};var Yi={inflateReset:qc,inflateReset2:$c,inflateResetKeep:Zc,inflateInit:p=>eh(p,15),inflateInit2:eh,inflate:(p,w)=>{let g,T,M,F,q,N,_e,H,J,$e,Ve,ve,Tt,lt,We,dt,qe,we,Ye,pt,Me,At,et=0;const Xe=new Uint8Array(4);let rt,ii;const zr=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(bs(p)||!p.output||!p.input&&p.avail_in!==0)return mi;g=p.state,g.mode===Xi&&(g.mode=Ga),q=p.next_out,M=p.output,_e=p.avail_out,F=p.next_in,T=p.input,N=p.avail_in,H=g.hold,J=g.bits,$e=N,Ve=_e,At=ws;e:for(;;)switch(g.mode){case Zo:if(g.wrap===0){g.mode=Ga;break}for(;J<16;){if(N===0)break e;N--,H+=T[F++]<<J,J+=8}if(2&g.wrap&&H===35615){g.wbits===0&&(g.wbits=15),g.check=0,Xe[0]=255&H,Xe[1]=H>>>8&255,g.check=V(g.check,Xe,2,0),H=0,J=0,g.mode=16181;break}if(g.head&&(g.head.done=!1),!(1&g.wrap)||(((255&H)<<8)+(H>>8))%31){p.msg="incorrect header check",g.mode=bt;break}if((15&H)!==Yc){p.msg="unknown compression method",g.mode=bt;break}if(H>>>=4,J-=4,Me=8+(15&H),g.wbits===0&&(g.wbits=Me),Me>15||Me>g.wbits){p.msg="invalid window size",g.mode=bt;break}g.dmax=1<<g.wbits,g.flags=0,p.adler=g.check=1,g.mode=512&H?16189:Xi,H=0,J=0;break;case 16181:for(;J<16;){if(N===0)break e;N--,H+=T[F++]<<J,J+=8}if(g.flags=H,(255&g.flags)!==Yc){p.msg="unknown compression method",g.mode=bt;break}if(57344&g.flags){p.msg="unknown header flags set",g.mode=bt;break}g.head&&(g.head.text=H>>8&1),512&g.flags&&4&g.wrap&&(Xe[0]=255&H,Xe[1]=H>>>8&255,g.check=V(g.check,Xe,2,0)),H=0,J=0,g.mode=16182;case 16182:for(;J<32;){if(N===0)break e;N--,H+=T[F++]<<J,J+=8}g.head&&(g.head.time=H),512&g.flags&&4&g.wrap&&(Xe[0]=255&H,Xe[1]=H>>>8&255,Xe[2]=H>>>16&255,Xe[3]=H>>>24&255,g.check=V(g.check,Xe,4,0)),H=0,J=0,g.mode=16183;case 16183:for(;J<16;){if(N===0)break e;N--,H+=T[F++]<<J,J+=8}g.head&&(g.head.xflags=255&H,g.head.os=H>>8),512&g.flags&&4&g.wrap&&(Xe[0]=255&H,Xe[1]=H>>>8&255,g.check=V(g.check,Xe,2,0)),H=0,J=0,g.mode=16184;case 16184:if(1024&g.flags){for(;J<16;){if(N===0)break e;N--,H+=T[F++]<<J,J+=8}g.length=H,g.head&&(g.head.extra_len=H),512&g.flags&&4&g.wrap&&(Xe[0]=255&H,Xe[1]=H>>>8&255,g.check=V(g.check,Xe,2,0)),H=0,J=0}else g.head&&(g.head.extra=null);g.mode=16185;case 16185:if(1024&g.flags&&(ve=g.length,ve>N&&(ve=N),ve&&(g.head&&(Me=g.head.extra_len-g.length,g.head.extra||(g.head.extra=new Uint8Array(g.head.extra_len)),g.head.extra.set(T.subarray(F,F+ve),Me)),512&g.flags&&4&g.wrap&&(g.check=V(g.check,T,ve,F)),N-=ve,F+=ve,g.length-=ve),g.length))break e;g.length=0,g.mode=16186;case 16186:if(2048&g.flags){if(N===0)break e;ve=0;do Me=T[F+ve++],g.head&&Me&&g.length<65536&&(g.head.name+=String.fromCharCode(Me));while(Me&&ve<N);if(512&g.flags&&4&g.wrap&&(g.check=V(g.check,T,ve,F)),N-=ve,F+=ve,Me)break e}else g.head&&(g.head.name=null);g.length=0,g.mode=16187;case 16187:if(4096&g.flags){if(N===0)break e;ve=0;do Me=T[F+ve++],g.head&&Me&&g.length<65536&&(g.head.comment+=String.fromCharCode(Me));while(Me&&ve<N);if(512&g.flags&&4&g.wrap&&(g.check=V(g.check,T,ve,F)),N-=ve,F+=ve,Me)break e}else g.head&&(g.head.comment=null);g.mode=16188;case 16188:if(512&g.flags){for(;J<16;){if(N===0)break e;N--,H+=T[F++]<<J,J+=8}if(4&g.wrap&&H!==(65535&g.check)){p.msg="header crc mismatch",g.mode=bt;break}H=0,J=0}g.head&&(g.head.hcrc=g.flags>>9&1,g.head.done=!0),p.adler=g.check=0,g.mode=Xi;break;case 16189:for(;J<32;){if(N===0)break e;N--,H+=T[F++]<<J,J+=8}p.adler=g.check=Jc(H),H=0,J=0,g.mode=qo;case qo:if(g.havedict===0)return p.next_out=q,p.avail_out=_e,p.next_in=F,p.avail_in=N,g.hold=H,g.bits=J,B_;p.adler=g.check=1,g.mode=Xi;case Xi:if(w===__||w===Jo)break e;case Ga:if(g.last){H>>>=7&J,J-=7&J,g.mode=za;break}for(;J<3;){if(N===0)break e;N--,H+=T[F++]<<J,J+=8}switch(g.last=1&H,H>>>=1,J-=1,3&H){case 0:g.mode=16193;break;case 1:if(x_(g),g.mode=$o,w===Jo){H>>>=2,J-=2;break e}break;case 2:g.mode=16196;break;case 3:p.msg="invalid block type",g.mode=bt}H>>>=2,J-=2;break;case 16193:for(H>>>=7&J,J-=7&J;J<32;){if(N===0)break e;N--,H+=T[F++]<<J,J+=8}if((65535&H)!=(H>>>16^65535)){p.msg="invalid stored block lengths",g.mode=bt;break}if(g.length=65535&H,H=0,J=0,g.mode=ja,w===Jo)break e;case ja:g.mode=16195;case 16195:if(ve=g.length,ve){if(ve>N&&(ve=N),ve>_e&&(ve=_e),ve===0)break e;M.set(T.subarray(F,F+ve),q),N-=ve,F+=ve,_e-=ve,q+=ve,g.length-=ve;break}g.mode=Xi;break;case 16196:for(;J<14;){if(N===0)break e;N--,H+=T[F++]<<J,J+=8}if(g.nlen=257+(31&H),H>>>=5,J-=5,g.ndist=1+(31&H),H>>>=5,J-=5,g.ncode=4+(15&H),H>>>=4,J-=4,g.nlen>286||g.ndist>30){p.msg="too many length or distance symbols",g.mode=bt;break}g.have=0,g.mode=16197;case 16197:for(;g.have<g.ncode;){for(;J<3;){if(N===0)break e;N--,H+=T[F++]<<J,J+=8}g.lens[zr[g.have++]]=7&H,H>>>=3,J-=3}for(;g.have<19;)g.lens[zr[g.have++]]=0;if(g.lencode=g.lendyn,g.lenbits=7,rt={bits:g.lenbits},At=Vr(0,g.lens,0,19,g.lencode,0,g.work,rt),g.lenbits=rt.bits,At){p.msg="invalid code lengths set",g.mode=bt;break}g.have=0,g.mode=16198;case 16198:for(;g.have<g.nlen+g.ndist;){for(;et=g.lencode[H&(1<<g.lenbits)-1],We=et>>>24,dt=et>>>16&255,qe=65535&et,!(We<=J);){if(N===0)break e;N--,H+=T[F++]<<J,J+=8}if(qe<16)H>>>=We,J-=We,g.lens[g.have++]=qe;else{if(qe===16){for(ii=We+2;J<ii;){if(N===0)break e;N--,H+=T[F++]<<J,J+=8}if(H>>>=We,J-=We,g.have===0){p.msg="invalid bit length repeat",g.mode=bt;break}Me=g.lens[g.have-1],ve=3+(3&H),H>>>=2,J-=2}else if(qe===17){for(ii=We+3;J<ii;){if(N===0)break e;N--,H+=T[F++]<<J,J+=8}H>>>=We,J-=We,Me=0,ve=3+(7&H),H>>>=3,J-=3}else{for(ii=We+7;J<ii;){if(N===0)break e;N--,H+=T[F++]<<J,J+=8}H>>>=We,J-=We,Me=0,ve=11+(127&H),H>>>=7,J-=7}if(g.have+ve>g.nlen+g.ndist){p.msg="invalid bit length repeat",g.mode=bt;break}for(;ve--;)g.lens[g.have++]=Me}}if(g.mode===bt)break;if(g.lens[256]===0){p.msg="invalid code -- missing end-of-block",g.mode=bt;break}if(g.lenbits=9,rt={bits:g.lenbits},At=Vr(1,g.lens,0,g.nlen,g.lencode,0,g.work,rt),g.lenbits=rt.bits,At){p.msg="invalid literal/lengths set",g.mode=bt;break}if(g.distbits=6,g.distcode=g.distdyn,rt={bits:g.distbits},At=Vr(2,g.lens,g.nlen,g.ndist,g.distcode,0,g.work,rt),g.distbits=rt.bits,At){p.msg="invalid distances set",g.mode=bt;break}if(g.mode=$o,w===Jo)break e;case $o:g.mode=en;case en:if(N>=6&&_e>=258){p.next_out=q,p.avail_out=_e,p.next_in=F,p.avail_in=N,g.hold=H,g.bits=J,d_(p,Ve),q=p.next_out,M=p.output,_e=p.avail_out,F=p.next_in,T=p.input,N=p.avail_in,H=g.hold,J=g.bits,g.mode===Xi&&(g.back=-1);break}for(g.back=0;et=g.lencode[H&(1<<g.lenbits)-1],We=et>>>24,dt=et>>>16&255,qe=65535&et,!(We<=J);){if(N===0)break e;N--,H+=T[F++]<<J,J+=8}if(dt&&!(240&dt)){for(we=We,Ye=dt,pt=qe;et=g.lencode[pt+((H&(1<<we+Ye)-1)>>we)],We=et>>>24,dt=et>>>16&255,qe=65535&et,!(we+We<=J);){if(N===0)break e;N--,H+=T[F++]<<J,J+=8}H>>>=we,J-=we,g.back+=we}if(H>>>=We,J-=We,g.back+=We,g.length=qe,dt===0){g.mode=16205;break}if(32&dt){g.back=-1,g.mode=Xi;break}if(64&dt){p.msg="invalid literal/length code",g.mode=bt;break}g.extra=15&dt,g.mode=16201;case 16201:if(g.extra){for(ii=g.extra;J<ii;){if(N===0)break e;N--,H+=T[F++]<<J,J+=8}g.length+=H&(1<<g.extra)-1,H>>>=g.extra,J-=g.extra,g.back+=g.extra}g.was=g.length,g.mode=16202;case 16202:for(;et=g.distcode[H&(1<<g.distbits)-1],We=et>>>24,dt=et>>>16&255,qe=65535&et,!(We<=J);){if(N===0)break e;N--,H+=T[F++]<<J,J+=8}if(!(240&dt)){for(we=We,Ye=dt,pt=qe;et=g.distcode[pt+((H&(1<<we+Ye)-1)>>we)],We=et>>>24,dt=et>>>16&255,qe=65535&et,!(we+We<=J);){if(N===0)break e;N--,H+=T[F++]<<J,J+=8}H>>>=we,J-=we,g.back+=we}if(H>>>=We,J-=We,g.back+=We,64&dt){p.msg="invalid distance code",g.mode=bt;break}g.offset=qe,g.extra=15&dt,g.mode=16203;case 16203:if(g.extra){for(ii=g.extra;J<ii;){if(N===0)break e;N--,H+=T[F++]<<J,J+=8}g.offset+=H&(1<<g.extra)-1,H>>>=g.extra,J-=g.extra,g.back+=g.extra}if(g.offset>g.dmax){p.msg="invalid distance too far back",g.mode=bt;break}g.mode=16204;case 16204:if(_e===0)break e;if(ve=Ve-_e,g.offset>ve){if(ve=g.offset-ve,ve>g.whave&&g.sane){p.msg="invalid distance too far back",g.mode=bt;break}ve>g.wnext?(ve-=g.wnext,Tt=g.wsize-ve):Tt=g.wnext-ve,ve>g.length&&(ve=g.length),lt=g.window}else lt=M,Tt=q-g.offset,ve=g.length;ve>_e&&(ve=_e),_e-=ve,g.length-=ve;do M[q++]=lt[Tt++];while(--ve);g.length===0&&(g.mode=en);break;case 16205:if(_e===0)break e;M[q++]=g.length,_e--,g.mode=en;break;case za:if(g.wrap){for(;J<32;){if(N===0)break e;N--,H|=T[F++]<<J,J+=8}if(Ve-=_e,p.total_out+=Ve,g.total+=Ve,4&g.wrap&&Ve&&(p.adler=g.check=g.flags?V(g.check,M,Ve,q-Ve):Qe(g.check,M,Ve,q-Ve)),Ve=_e,4&g.wrap&&(g.flags?H:Jc(H))!==g.check){p.msg="incorrect data check",g.mode=bt;break}H=0,J=0}g.mode=16207;case 16207:if(g.wrap&&g.flags){for(;J<32;){if(N===0)break e;N--,H+=T[F++]<<J,J+=8}if(4&g.wrap&&H!==(4294967295&g.total)){p.msg="incorrect length check",g.mode=bt;break}H=0,J=0}g.mode=16208;case 16208:At=v_;break e;case bt:At=Wc;break e;case 16210:return Xc;default:return mi}return p.next_out=q,p.avail_out=_e,p.next_in=F,p.avail_in=N,g.hold=H,g.bits=J,(g.wsize||Ve!==p.avail_out&&g.mode<bt&&(g.mode<za||w!==Kc))&&ih(p,p.output,p.next_out,Ve-p.avail_out),$e-=p.avail_in,Ve-=p.avail_out,p.total_in+=$e,p.total_out+=Ve,g.total+=Ve,4&g.wrap&&Ve&&(p.adler=g.check=g.flags?V(g.check,M,Ve,p.next_out-Ve):Qe(g.check,M,Ve,p.next_out-Ve)),p.data_type=g.bits+(g.last?64:0)+(g.mode===Xi?128:0)+(g.mode===$o||g.mode===ja?256:0),($e===0&&Ve===0||w===Kc)&&At===ws&&(At=P_),At},inflateEnd:p=>{if(bs(p))return mi;let w=p.state;return w.window&&(w.window=null),p.state=null,ws},inflateGetHeader:(p,w)=>{if(bs(p))return mi;const g=p.state;return 2&g.wrap?(g.head=w,w.done=!1,ws):mi},inflateSetDictionary:(p,w)=>{const g=w.length;let T,M,F;return bs(p)?mi:(T=p.state,T.wrap!==0&&T.mode!==qo?mi:T.mode===qo&&(M=1,M=Qe(M,w,g,0),M!==T.check)?Wc:(F=ih(p,w,g,g),F?(T.mode=16210,Xc):(T.havedict=1,ws)))},inflateInfo:"pako inflate (from Nodeca project)"},w_=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const sh=Object.prototype.toString,{Z_NO_FLUSH:b_,Z_FINISH:C_,Z_OK:Gr,Z_STREAM_END:Xa,Z_NEED_DICT:Ya,Z_STREAM_ERROR:E_,Z_DATA_ERROR:rh,Z_MEM_ERROR:I_}=L;function jr(p){this.options=Hc({chunkSize:65536,windowBits:15,to:""},p||{});const w=this.options;w.raw&&w.windowBits>=0&&w.windowBits<16&&(w.windowBits=-w.windowBits,w.windowBits===0&&(w.windowBits=-15)),!(w.windowBits>=0&&w.windowBits<16)||p&&p.windowBits||(w.windowBits+=32),w.windowBits>15&&w.windowBits<48&&!(15&w.windowBits)&&(w.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new jc,this.strm.avail_out=0;let g=Yi.inflateInit2(this.strm,w.windowBits);if(g!==Gr)throw new Error(Z[g]);if(this.header=new w_,Yi.inflateGetHeader(this.strm,this.header),w.dictionary&&(typeof w.dictionary=="string"?w.dictionary=Ha(w.dictionary):sh.call(w.dictionary)==="[object ArrayBuffer]"&&(w.dictionary=new Uint8Array(w.dictionary)),w.raw&&(g=Yi.inflateSetDictionary(this.strm,w.dictionary),g!==Gr)))throw new Error(Z[g])}function Ja(p,w){const g=new jr(w);if(g.push(p),g.err)throw g.msg||Z[g.err];return g.result}jr.prototype.push=function(p,w){const g=this.strm,T=this.options.chunkSize,M=this.options.dictionary;let F,q,N;if(this.ended)return!1;for(q=w===~~w?w:w===!0?C_:b_,sh.call(p)==="[object ArrayBuffer]"?g.input=new Uint8Array(p):g.input=p,g.next_in=0,g.avail_in=g.input.length;;){for(g.avail_out===0&&(g.output=new Uint8Array(T),g.next_out=0,g.avail_out=T),F=Yi.inflate(g,q),F===Ya&&M&&(F=Yi.inflateSetDictionary(g,M),F===Gr?F=Yi.inflate(g,q):F===rh&&(F=Ya));g.avail_in>0&&F===Xa&&g.state.wrap>0&&p[g.next_in]!==0;)Yi.inflateReset(g),F=Yi.inflate(g,q);switch(F){case E_:case rh:case Ya:case I_:return this.onEnd(F),this.ended=!0,!1}if(N=g.avail_out,g.next_out&&(g.avail_out===0||F===Xa))if(this.options.to==="string"){let _e=s_(g.output,g.next_out),H=g.next_out-_e,J=i_(g.output,_e);g.next_out=H,g.avail_out=T-H,H&&g.output.set(g.output.subarray(_e,_e+H),0),this.onData(J)}else this.onData(g.output.length===g.next_out?g.output:g.output.subarray(0,g.next_out));if(F!==Gr||N!==0){if(F===Xa)return F=Yi.inflateEnd(this.strm),this.onEnd(F),this.ended=!0,!0;if(g.avail_in===0)break}}return!0},jr.prototype.onData=function(p){this.chunks.push(p)},jr.prototype.onEnd=function(p){p===Gr&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=Vc(this.chunks)),this.chunks=[],this.err=p,this.msg=this.strm.msg};var F_={Inflate:jr,inflate:Ja,inflateRaw:function(p,w){return(w=w||{}).raw=!0,Ja(p,w)},ungzip:Ja,constants:L};const{Deflate:M_,deflate:S_,deflateRaw:T_,gzip:D_}=u_,{Inflate:R_,inflate:L_,inflateRaw:U_,ungzip:O_}=F_;var oh=M_,nh=S_,ah=T_,Ah=D_,lh=R_,ch=L_,hh=U_,uh=O_,dh=L,k_={Deflate:oh,deflate:nh,deflateRaw:ah,gzip:Ah,Inflate:lh,inflate:ch,inflateRaw:hh,ungzip:uh,constants:dh};r.Deflate=oh,r.Inflate=lh,r.constants=dh,r.default=k_,r.deflate=nh,r.deflateRaw=ah,r.gzip=Ah,r.inflate=ch,r.inflateRaw=hh,r.ungzip=uh,Object.defineProperty(r,"__esModule",{value:!0})});var Ki=Object.freeze({__proto__:null});let ni=window.pako||Ki;ni.inflate||(ni=ni.default);const fR=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();function gR(r){return{positions:r[0],normals:r[1],indices:r[2],edgeIndices:r[3],meshPositions:r[4],meshIndices:r[5],meshEdgesIndices:r[6],meshColors:r[7],entityIDs:r[8],entityMeshes:r[9],entityIsObjects:r[10],positionsDecodeMatrix:r[11]}}function mR(r){return{positions:new Uint16Array(ni.inflate(r.positions).buffer),normals:new Int8Array(ni.inflate(r.normals).buffer),indices:new Uint32Array(ni.inflate(r.indices).buffer),edgeIndices:new Uint32Array(ni.inflate(r.edgeIndices).buffer),meshPositions:new Uint32Array(ni.inflate(r.meshPositions).buffer),meshIndices:new Uint32Array(ni.inflate(r.meshIndices).buffer),meshEdgesIndices:new Uint32Array(ni.inflate(r.meshEdgesIndices).buffer),meshColors:new Uint8Array(ni.inflate(r.meshColors).buffer),entityIDs:ni.inflate(r.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(ni.inflate(r.entityMeshes).buffer),entityIsObjects:new Uint8Array(ni.inflate(r.entityIsObjects).buffer),positionsDecodeMatrix:new Float32Array(ni.inflate(r.positionsDecodeMatrix).buffer)}}function _R(r,e,t,i,s,o){o.getNextId(),i.positionsCompression="precompressed",i.normalsCompression="precompressed";const n=t.positions,a=t.normals,A=t.indices,l=t.edgeIndices,h=t.meshPositions,d=t.meshIndices,f=t.meshEdgesIndices,m=t.meshColors,_=JSON.parse(t.entityIDs),u=t.entityMeshes,B=t.entityIsObjects,y=h.length,x=u.length;for(let P=0;P<x;P++){const v=_[P],b=e.globalizeObjectIds?c.globalizeObjectId(i.id,v):v,C=r.metaScene.metaObjects[b],I={},E={};if(C){if(e.excludeTypesMap&&C.type&&e.excludeTypesMap[C.type]||e.includeTypesMap&&C.type&&!e.includeTypesMap[C.type])continue;const D=e.objectDefaults?e.objectDefaults[C.type]||e.objectDefaults.DEFAULT:null;D&&(D.visible===!1&&(I.visible=!1),D.pickable===!1&&(I.pickable=!1),D.colorize&&(E.color=D.colorize),D.opacity!==void 0&&D.opacity!==null&&(E.opacity=D.opacity))}else if(e.excludeUnclassifiedObjects)continue;const S=P===x-1,R=[];for(let D=u[P],K=S?u.length:u[P+1];D<K;D++){const j=D===y-1,z=b+".mesh."+D,le=fR(m.subarray(D*4,D*4+3)),ue=m[D*4+3]/255;i.createMesh(Se.apply(E,{id:z,primitive:"triangles",positionsCompressed:n.subarray(h[D],j?n.length:h[D+1]),normalsCompressed:a.subarray(h[D],j?n.length:h[D+1]),indices:A.subarray(d[D],j?A.length:d[D+1]),edgeIndices:l.subarray(f[D],j?l.length:f[D+1]),positionsDecodeMatrix:t.positionsDecodeMatrix,color:le,opacity:ue})),R.push(z)}i.createEntity(Se.apply(I,{id:b,isObject:B[P]===1,meshIds:R}))}}const gf={version:1,parse:function(r,e,t,i,s,o){const n=gR(t),a=mR(n);_R(r,e,a,i,s,o)}};let zt=window.pako||Ki;zt.inflate||(zt=zt.default);function vR(r){return{positions:r[0],normals:r[1],indices:r[2],edgeIndices:r[3],meshPositions:r[4],meshIndices:r[5],meshEdgesIndices:r[6],meshColors:r[7],entityIDs:r[8],entityMeshes:r[9],entityIsObjects:r[10],positionsDecodeMatrix:r[11],entityMeshIds:r[12],entityMatrices:r[13],entityUsesInstancing:r[14]}}function BR(r){return{positions:new Uint16Array(zt.inflate(r.positions).buffer),normals:new Int8Array(zt.inflate(r.normals).buffer),indices:new Uint32Array(zt.inflate(r.indices).buffer),edgeIndices:new Uint32Array(zt.inflate(r.edgeIndices).buffer),meshPositions:new Uint32Array(zt.inflate(r.meshPositions).buffer),meshIndices:new Uint32Array(zt.inflate(r.meshIndices).buffer),meshEdgesIndices:new Uint32Array(zt.inflate(r.meshEdgesIndices).buffer),meshColors:new Uint8Array(zt.inflate(r.meshColors).buffer),entityIDs:zt.inflate(r.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(zt.inflate(r.entityMeshes).buffer),entityIsObjects:new Uint8Array(zt.inflate(r.entityIsObjects).buffer),positionsDecodeMatrix:new Float32Array(zt.inflate(r.positionsDecodeMatrix).buffer),entityMeshIds:new Uint32Array(zt.inflate(r.entityMeshIds).buffer),entityMatrices:new Float32Array(zt.inflate(r.entityMatrices).buffer),entityUsesInstancing:new Uint8Array(zt.inflate(r.entityUsesInstancing).buffer)}}const PR=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();function yR(r,e,t,i,s,o){const n=o.getNextId();i.positionsCompression="precompressed",i.normalsCompression="precompressed";const a=t.positions,A=t.normals,l=t.indices,h=t.edgeIndices,d=t.meshPositions,f=t.meshIndices,m=t.meshEdgesIndices,_=t.meshColors,u=JSON.parse(t.entityIDs),B=t.entityMeshes,y=t.entityIsObjects,x=t.entityMeshIds,P=t.entityMatrices,v=t.entityUsesInstancing,b=d.length,C=B.length,I={};for(let E=0;E<C;E++){const S=u[E],R=e.globalizeObjectIds?c.globalizeObjectId(i.id,S):S,D=r.metaScene.metaObjects[R],K={},j={},z=P.subarray(E*16,E*16+16);if(D){if(e.excludeTypesMap&&D.type&&e.excludeTypesMap[D.type]||e.includeTypesMap&&D.type&&!e.includeTypesMap[D.type])continue;const ae=e.objectDefaults?e.objectDefaults[D.type]||e.objectDefaults.DEFAULT:null;ae&&(ae.visible===!1&&(K.visible=!1),ae.pickable===!1&&(K.pickable=!1),ae.colorize&&(j.color=ae.colorize),ae.opacity!==void 0&&ae.opacity!==null&&(j.opacity=ae.opacity))}else if(e.excludeUnclassifiedObjects)continue;const le=E===C-1,ue=[];for(let ae=B[E],Be=le?x.length:B[E+1];ae<Be;ae++){const be=x[ae],xe=be===b-1,Ie=o.getNextId(),Fe=PR(_.subarray(be*4,be*4+3)),Qe=_[be*4+3]/255,Ge=a.subarray(d[be],xe?a.length:d[be+1]),V=A.subarray(d[be],xe?a.length:d[be+1]),Z=l.subarray(f[be],xe?l.length:f[be+1]),L=h.subarray(m[be],xe?h.length:m[be+1]);if(v[E]===1){const Q=`${n}.geometry.${Ie}.${be}`;Q in I||(i.createGeometry({id:Q,positionsCompressed:Ge,normalsCompressed:V,indices:Z,edgeIndices:L,primitive:"triangles",positionsDecodeMatrix:t.positionsDecodeMatrix}),I[Q]=!0),i.createMesh(Se.apply(j,{id:Ie,color:Fe,opacity:Qe,matrix:z,geometryId:Q})),ue.push(Ie)}else i.createMesh(Se.apply(j,{id:Ie,primitive:"triangles",positionsCompressed:Ge,normalsCompressed:V,indices:Z,edgeIndices:L,positionsDecodeMatrix:t.positionsDecodeMatrix,color:Fe,opacity:Qe})),ue.push(Ie)}ue.length&&i.createEntity(Se.apply(K,{id:R,isObject:y[E]===1,meshIds:ue}))}}const mf={version:2,parse:function(r,e,t,i,s,o){const n=vR(t),a=BR(n);yR(r,e,a,i,s,o)}};let Qt=window.pako||Ki;Qt.inflate||(Qt=Qt.default);function xR(r){return{positions:r[0],normals:r[1],indices:r[2],edgeIndices:r[3],meshPositions:r[4],meshIndices:r[5],meshEdgesIndices:r[6],meshColors:r[7],entityIDs:r[8],entityMeshes:r[9],entityIsObjects:r[10],instancedPositionsDecodeMatrix:r[11],batchedPositionsDecodeMatrix:r[12],entityMeshIds:r[13],entityMatrices:r[14],entityUsesInstancing:r[15]}}function wR(r){return{positions:new Uint16Array(Qt.inflate(r.positions).buffer),normals:new Int8Array(Qt.inflate(r.normals).buffer),indices:new Uint32Array(Qt.inflate(r.indices).buffer),edgeIndices:new Uint32Array(Qt.inflate(r.edgeIndices).buffer),meshPositions:new Uint32Array(Qt.inflate(r.meshPositions).buffer),meshIndices:new Uint32Array(Qt.inflate(r.meshIndices).buffer),meshEdgesIndices:new Uint32Array(Qt.inflate(r.meshEdgesIndices).buffer),meshColors:new Uint8Array(Qt.inflate(r.meshColors).buffer),entityIDs:Qt.inflate(r.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(Qt.inflate(r.entityMeshes).buffer),entityIsObjects:new Uint8Array(Qt.inflate(r.entityIsObjects).buffer),instancedPositionsDecodeMatrix:new Float32Array(Qt.inflate(r.instancedPositionsDecodeMatrix).buffer),batchedPositionsDecodeMatrix:new Float32Array(Qt.inflate(r.batchedPositionsDecodeMatrix).buffer),entityMeshIds:new Uint32Array(Qt.inflate(r.entityMeshIds).buffer),entityMatrices:new Float32Array(Qt.inflate(r.entityMatrices).buffer),entityUsesInstancing:new Uint8Array(Qt.inflate(r.entityUsesInstancing).buffer)}}const bR=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();function CR(r,e,t,i,s,o){const n=o.getNextId();i.positionsCompression="precompressed",i.normalsCompression="precompressed";const a=t.positions,A=t.normals,l=t.indices,h=t.edgeIndices,d=t.meshPositions,f=t.meshIndices,m=t.meshEdgesIndices,_=t.meshColors,u=JSON.parse(t.entityIDs),B=t.entityMeshes,y=t.entityIsObjects,x=t.entityMeshIds,P=t.entityMatrices,v=t.entityUsesInstancing,b=d.length,C=B.length,I={};for(let j=0;j<C;j++){const z=u[j],le=e.globalizeObjectIds?c.globalizeObjectId(i.id,z):z,ue=r.metaScene.metaObjects[le],ae={},Be={},be=P.subarray(j*16,j*16+16);if(ue){if(e.excludeTypesMap&&ue.type&&e.excludeTypesMap[ue.type]||e.includeTypesMap&&ue.type&&!e.includeTypesMap[ue.type])continue;const Fe=e.objectDefaults?e.objectDefaults[ue.type]||e.objectDefaults.DEFAULT:null;Fe&&(Fe.visible===!1&&(ae.visible=!1),Fe.pickable===!1&&(ae.pickable=!1),Fe.colorize&&(Be.color=Fe.colorize),Fe.opacity!==void 0&&Fe.opacity!==null&&(Be.opacity=Fe.opacity))}else if(e.excludeUnclassifiedObjects)continue;const xe=j===C-1,Ie=[];for(let Fe=B[j],Qe=xe?x.length:B[j+1];Fe<Qe;Fe++){var E=x[Fe];const Ge=E===b-1,V=`${n}.${le}.mesh.${E}`,Z=bR(_.subarray(E*4,E*4+3)),L=_[E*4+3]/255;var S=a.subarray(d[E],Ge?a.length:d[E+1]),R=A.subarray(d[E],Ge?a.length:d[E+1]),D=l.subarray(f[E],Ge?l.length:f[E+1]),K=h.subarray(m[E],Ge?h.length:m[E+1]);if(v[j]===1){const Q=`${n}.geometry.${V}.${E}`;Q in I||(i.createGeometry({id:Q,positionsCompressed:S,normalsCompressed:R,indices:D,edgeIndices:K,primitive:"triangles",positionsDecodeMatrix:t.instancedPositionsDecodeMatrix}),I[Q]=!0),i.createMesh(Se.apply(Be,{id:V,color:Z,opacity:L,matrix:be,geometryId:Q})),Ie.push(V)}else i.createMesh(Se.apply(Be,{id:V,primitive:"triangles",positionsCompressed:S,normalsCompressed:R,indices:D,edgeIndices:K,positionsDecodeMatrix:t.batchedPositionsDecodeMatrix,color:Z,opacity:L})),Ie.push(V)}Ie.length&&i.createEntity(Se.apply(ae,{id:le,isObject:y[j]===1,meshIds:Ie}))}}const _f={version:3,parse:function(r,e,t,i,s,o){const n=xR(t),a=wR(n);CR(r,e,a,i,s,o)}};let Kt=window.pako||Ki;Kt.inflate||(Kt=Kt.default);function ER(r){return{positions:r[0],normals:r[1],indices:r[2],edgeIndices:r[3],decodeMatrices:r[4],matrices:r[5],eachPrimitivePositionsAndNormalsPortion:r[6],eachPrimitiveIndicesPortion:r[7],eachPrimitiveEdgeIndicesPortion:r[8],eachPrimitiveDecodeMatricesPortion:r[9],eachPrimitiveColor:r[10],primitiveInstances:r[11],eachEntityId:r[12],eachEntityPrimitiveInstancesPortion:r[13],eachEntityMatricesPortion:r[14],eachEntityMatrix:r[15]}}function IR(r){return{positions:new Uint16Array(Kt.inflate(r.positions).buffer),normals:new Int8Array(Kt.inflate(r.normals).buffer),indices:new Uint32Array(Kt.inflate(r.indices).buffer),edgeIndices:new Uint32Array(Kt.inflate(r.edgeIndices).buffer),decodeMatrices:new Float32Array(Kt.inflate(r.decodeMatrices).buffer),matrices:new Float32Array(Kt.inflate(r.matrices).buffer),eachPrimitivePositionsAndNormalsPortion:new Uint32Array(Kt.inflate(r.eachPrimitivePositionsAndNormalsPortion).buffer),eachPrimitiveIndicesPortion:new Uint32Array(Kt.inflate(r.eachPrimitiveIndicesPortion).buffer),eachPrimitiveEdgeIndicesPortion:new Uint32Array(Kt.inflate(r.eachPrimitiveEdgeIndicesPortion).buffer),eachPrimitiveDecodeMatricesPortion:new Uint32Array(Kt.inflate(r.eachPrimitiveDecodeMatricesPortion).buffer),eachPrimitiveColor:new Uint8Array(Kt.inflate(r.eachPrimitiveColor).buffer),primitiveInstances:new Uint32Array(Kt.inflate(r.primitiveInstances).buffer),eachEntityId:Kt.inflate(r.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array(Kt.inflate(r.eachEntityPrimitiveInstancesPortion).buffer),eachEntityMatricesPortion:new Uint32Array(Kt.inflate(r.eachEntityMatricesPortion).buffer)}}const FR=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();function MR(r,e,t,i,s,o){const n=o.getNextId();i.positionsCompression="precompressed",i.normalsCompression="precompressed";const a=t.positions,A=t.normals,l=t.indices,h=t.edgeIndices,d=t.decodeMatrices,f=t.matrices,m=t.eachPrimitivePositionsAndNormalsPortion,_=t.eachPrimitiveIndicesPortion,u=t.eachPrimitiveEdgeIndicesPortion,B=t.eachPrimitiveDecodeMatricesPortion,y=t.eachPrimitiveColor,x=t.primitiveInstances,P=JSON.parse(t.eachEntityId),v=t.eachEntityPrimitiveInstancesPortion,b=t.eachEntityMatricesPortion,C=m.length,I=x.length,E=new Uint8Array(C),S=new Uint32Array(C),R=P.length;for(let j=0;j<C;j++)S[j]=j;S.sort((j,z)=>B[j]<B[z]?-1:B[j]>B[z]?1:0);for(let j=0;j<I;j++){const z=x[j];E[z]++}const D={};for(let j=0;j<R;j++){const z=R-1,le=j===z,ue=v[j],ae=le?v[z]:v[j+1];for(let Be=ue;Be<ae;Be++){const be=x[Be];E[be]>1||(D[be]=j)}}for(let j=0;j<C;j++){const z=S[j],le=z===C-1,ae=E[z]>1,Be=FR(y.subarray(z*4,z*4+3)),be=y[z*4+3]/255,xe=a.subarray(m[z],le?a.length:m[z+1]),Ie=A.subarray(m[z],le?A.length:m[z+1]),Fe=l.subarray(_[z],le?l.length:_[z+1]),Qe=h.subarray(u[z],le?h.length:u[z+1]),Ge=d.subarray(B[z],B[z]+16);if(ae){const V=`${n}-geometry.${z}`;i.createGeometry({id:V,primitive:"triangles",positionsCompressed:xe,normalsCompressed:Ie,indices:Fe,edgeIndices:Qe,positionsDecodeMatrix:Ge})}else{const V=`${n}-${z}`,Z=D[z];P[Z];const L={};i.createMesh(Se.apply(L,{id:V,primitive:"triangles",positionsCompressed:xe,normalsCompressed:Ie,indices:Fe,edgeIndices:Qe,positionsDecodeMatrix:Ge,color:Be,opacity:be}))}}let K=0;for(let j=0;j<R;j++){const z=R-1,le=j===z,ue=P[j],ae=v[j],Be=le?v[z]:v[j+1],be=[];for(let xe=ae;xe<Be;xe++){const Ie=x[xe];if(E[Ie]>1){const Ge={},V=`${n}-instance.${K++}`,Z=`${n}-geometry.${Ie}`,L=b[j]*16,Q=f.subarray(L,L+16);i.createMesh(Se.apply(Ge,{id:V,geometryId:Z,matrix:Q})),be.push(V)}else be.push(Ie)}if(be.length>0){const xe={};i.createEntity(Se.apply(xe,{id:ue,isObject:!0,meshIds:be}))}}}const vf={version:4,parse:function(r,e,t,i,s,o){const n=ER(t),a=IR(n);MR(r,e,a,i,s,o)}};let $t=window.pako||Ki;$t.inflate||($t=$t.default);function SR(r){return{positions:r[0],normals:r[1],indices:r[2],edgeIndices:r[3],matrices:r[4],eachPrimitivePositionsAndNormalsPortion:r[5],eachPrimitiveIndicesPortion:r[6],eachPrimitiveEdgeIndicesPortion:r[7],eachPrimitiveColor:r[8],primitiveInstances:r[9],eachEntityId:r[10],eachEntityPrimitiveInstancesPortion:r[11],eachEntityMatricesPortion:r[12]}}function TR(r){return{positions:new Float32Array($t.inflate(r.positions).buffer),normals:new Int8Array($t.inflate(r.normals).buffer),indices:new Uint32Array($t.inflate(r.indices).buffer),edgeIndices:new Uint32Array($t.inflate(r.edgeIndices).buffer),matrices:new Float32Array($t.inflate(r.matrices).buffer),eachPrimitivePositionsAndNormalsPortion:new Uint32Array($t.inflate(r.eachPrimitivePositionsAndNormalsPortion).buffer),eachPrimitiveIndicesPortion:new Uint32Array($t.inflate(r.eachPrimitiveIndicesPortion).buffer),eachPrimitiveEdgeIndicesPortion:new Uint32Array($t.inflate(r.eachPrimitiveEdgeIndicesPortion).buffer),eachPrimitiveColor:new Uint8Array($t.inflate(r.eachPrimitiveColor).buffer),primitiveInstances:new Uint32Array($t.inflate(r.primitiveInstances).buffer),eachEntityId:$t.inflate(r.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array($t.inflate(r.eachEntityPrimitiveInstancesPortion).buffer),eachEntityMatricesPortion:new Uint32Array($t.inflate(r.eachEntityMatricesPortion).buffer)}}const DR=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();function RR(r,e,t,i,s,o){const n=o.getNextId();i.positionsCompression="disabled",i.normalsCompression="precompressed";const a=t.positions,A=t.normals,l=t.indices,h=t.edgeIndices,d=t.matrices,f=t.eachPrimitivePositionsAndNormalsPortion,m=t.eachPrimitiveIndicesPortion,_=t.eachPrimitiveEdgeIndicesPortion,u=t.eachPrimitiveColor,B=t.primitiveInstances,y=JSON.parse(t.eachEntityId),x=t.eachEntityPrimitiveInstancesPortion,P=t.eachEntityMatricesPortion,v=f.length,b=B.length,C=new Uint8Array(v),I=y.length;for(let R=0;R<b;R++){const D=B[R];C[D]++}const E={};for(let R=0;R<I;R++){const D=I-1,K=R===D,j=x[R],z=K?x[D]:x[R+1];for(let le=j;le<z;le++){const ue=B[le];C[ue]>1||(E[ue]=R)}}for(let R=0;R<v;R++){const D=R===v-1,j=C[R]>1,z=DR(u.subarray(R*4,R*4+3)),le=u[R*4+3]/255,ue=a.subarray(f[R],D?a.length:f[R+1]),ae=A.subarray(f[R],D?A.length:f[R+1]),Be=l.subarray(m[R],D?l.length:m[R+1]),be=h.subarray(_[R],D?h.length:_[R+1]);if(j){const xe=`${n}-geometry.${R}`;i.createGeometry({id:xe,primitive:"triangles",positionsCompressed:ue,normalsCompressed:ae,indices:Be,edgeIndices:be})}else{const xe=R,Ie=E[R];y[Ie];const Fe={};i.createMesh(Se.apply(Fe,{id:xe,primitive:"triangles",positionsCompressed:ue,normalsCompressed:ae,indices:Be,edgeIndices:be,color:z,opacity:le}))}}let S=0;for(let R=0;R<I;R++){const D=I-1,K=R===D,j=y[R],z=x[R],le=K?x[D]:x[R+1],ue=[];for(let ae=z;ae<le;ae++){const Be=B[ae];if(C[Be]>1){const Ie={},Fe="instance."+S++,Qe="geometry"+Be,Ge=P[R]*16,V=d.subarray(Ge,Ge+16);i.createMesh(Se.apply(Ie,{id:Fe,geometryId:Qe,matrix:V})),ue.push(Fe)}else ue.push(Be)}if(ue.length>0){const ae={};i.createEntity(Se.apply(ae,{id:j,isObject:!0,meshIds:ue}))}}}const Bf={version:5,parse:function(r,e,t,i,s,o){const n=SR(t),a=TR(n);RR(r,e,a,i,s,o)}};let Mo=window.pako||Ki;Mo.inflate||(Mo=Mo.default);function LR(r){return{positions:r[0],normals:r[1],indices:r[2],edgeIndices:r[3],matrices:r[4],reusedPrimitivesDecodeMatrix:r[5],eachPrimitivePositionsAndNormalsPortion:r[6],eachPrimitiveIndicesPortion:r[7],eachPrimitiveEdgeIndicesPortion:r[8],eachPrimitiveColorAndOpacity:r[9],primitiveInstances:r[10],eachEntityId:r[11],eachEntityPrimitiveInstancesPortion:r[12],eachEntityMatricesPortion:r[13],eachTileAABB:r[14],eachTileEntitiesPortion:r[15]}}function UR(r){function e(t,i){return t.length===0?[]:Mo.inflate(t,i).buffer}return{positions:new Uint16Array(e(r.positions)),normals:new Int8Array(e(r.normals)),indices:new Uint32Array(e(r.indices)),edgeIndices:new Uint32Array(e(r.edgeIndices)),matrices:new Float32Array(e(r.matrices)),reusedPrimitivesDecodeMatrix:new Float32Array(e(r.reusedPrimitivesDecodeMatrix)),eachPrimitivePositionsAndNormalsPortion:new Uint32Array(e(r.eachPrimitivePositionsAndNormalsPortion)),eachPrimitiveIndicesPortion:new Uint32Array(e(r.eachPrimitiveIndicesPortion)),eachPrimitiveEdgeIndicesPortion:new Uint32Array(e(r.eachPrimitiveEdgeIndicesPortion)),eachPrimitiveColorAndOpacity:new Uint8Array(e(r.eachPrimitiveColorAndOpacity)),primitiveInstances:new Uint32Array(e(r.primitiveInstances)),eachEntityId:Mo.inflate(r.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array(e(r.eachEntityPrimitiveInstancesPortion)),eachEntityMatricesPortion:new Uint32Array(e(r.eachEntityMatricesPortion)),eachTileAABB:new Float64Array(e(r.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(e(r.eachTileEntitiesPortion))}}const OR=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();function kR(r,e,t,i,s,o){const n=o.getNextId(),a=t.positions,A=t.normals,l=t.indices,h=t.edgeIndices,d=t.matrices,f=t.reusedPrimitivesDecodeMatrix,m=t.eachPrimitivePositionsAndNormalsPortion,_=t.eachPrimitiveIndicesPortion,u=t.eachPrimitiveEdgeIndicesPortion,B=t.eachPrimitiveColorAndOpacity,y=t.primitiveInstances,x=JSON.parse(t.eachEntityId),P=t.eachEntityPrimitiveInstancesPortion,v=t.eachEntityMatricesPortion,b=t.eachTileAABB,C=t.eachTileEntitiesPortion,I=m.length,E=y.length,S=x.length,R=C.length,D=new Uint32Array(I);for(let z=0;z<E;z++){const le=y[z];D[le]!==void 0?D[le]++:D[le]=1}const K=c.vec3(),j=c.AABB3();for(let z=0;z<R;z++){const le=R-1,ue=z===le,ae=C[z],Be=ue?S:C[z+1],be=z*6,xe=b.subarray(be,be+6);c.getAABB3Center(xe,K),j[0]=xe[0]-K[0],j[1]=xe[1]-K[1],j[2]=xe[2]-K[2],j[3]=xe[3]-K[0],j[4]=xe[4]-K[1],j[5]=xe[5]-K[2];const Ie=st.createPositionsDecodeMatrix(j),Fe={};for(let Qe=ae;Qe<Be;Qe++){const Ge=x[Qe],V=e.globalizeObjectIds?c.globalizeObjectId(i.id,Ge):Ge,Z=v[Qe],L=d.slice(Z,Z+16),Q=S-1,O=Qe===Q,W=P[Qe],X=O?y.length:P[Qe+1],te=[],se=r.metaScene.metaObjects[V],ie={},oe={};if(se){if(e.excludeTypesMap&&se.type&&e.excludeTypesMap[se.type]||e.includeTypesMap&&se.type&&!e.includeTypesMap[se.type])continue;const he=e.objectDefaults?e.objectDefaults[se.type]||e.objectDefaults.DEFAULT:null;he&&(he.visible===!1&&(ie.visible=!1),he.pickable===!1&&(ie.pickable=!1),he.colorize&&(oe.color=he.colorize),he.opacity!==void 0&&he.opacity!==null&&(oe.opacity=he.opacity))}else if(e.excludeUnclassifiedObjects)continue;for(let he=W;he<X;he++){const ce=y[he],ee=D[ce]>1,ge=ce===I-1,re=a.subarray(m[ce],ge?a.length:m[ce+1]),me=A.subarray(m[ce],ge?A.length:m[ce+1]),de=l.subarray(_[ce],ge?l.length:_[ce+1]),Y=h.subarray(u[ce],ge?h.length:u[ce+1]),Ue=OR(B.subarray(ce*4,ce*4+3)),pe=B[ce*4+3]/255,De=o.getNextId();if(ee){const fe=`${n}-geometry.${z}.${ce}`;Fe[fe]||(i.createGeometry({id:fe,primitive:"triangles",positionsCompressed:re,indices:de,edgeIndices:Y,positionsDecodeMatrix:f}),Fe[fe]=!0),i.createMesh(Se.apply(oe,{id:De,geometryId:fe,origin:K,matrix:L,color:Ue,opacity:pe})),te.push(De)}else i.createMesh(Se.apply(oe,{id:De,origin:K,primitive:"triangles",positionsCompressed:re,normalsCompressed:me,indices:de,edgeIndices:Y,positionsDecodeMatrix:Ie,color:Ue,opacity:pe})),te.push(De)}te.length>0&&i.createEntity(Se.apply(ie,{id:V,isObject:!0,meshIds:te}))}}}const Pf={version:6,parse:function(r,e,t,i,s,o){const n=LR(t),a=UR(n);kR(r,e,a,i,s,o)}};let So=window.pako||Ki;So.inflate||(So=So.default);function NR(r){return{positions:r[0],normals:r[1],colors:r[2],indices:r[3],edgeIndices:r[4],matrices:r[5],reusedGeometriesDecodeMatrix:r[6],eachGeometryPrimitiveType:r[7],eachGeometryPositionsPortion:r[8],eachGeometryNormalsPortion:r[9],eachGeometryColorsPortion:r[10],eachGeometryIndicesPortion:r[11],eachGeometryEdgeIndicesPortion:r[12],eachMeshGeometriesPortion:r[13],eachMeshMatricesPortion:r[14],eachMeshMaterial:r[15],eachEntityId:r[16],eachEntityMeshesPortion:r[17],eachTileAABB:r[18],eachTileEntitiesPortion:r[19]}}function QR(r){function e(t,i){return t.length===0?[]:So.inflate(t,i).buffer}return{positions:new Uint16Array(e(r.positions)),normals:new Int8Array(e(r.normals)),colors:new Uint8Array(e(r.colors)),indices:new Uint32Array(e(r.indices)),edgeIndices:new Uint32Array(e(r.edgeIndices)),matrices:new Float32Array(e(r.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(e(r.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(e(r.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(e(r.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(e(r.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(e(r.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(e(r.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(e(r.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(e(r.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(e(r.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(e(r.eachMeshMaterial)),eachEntityId:So.inflate(r.eachEntityId,{to:"string"}),eachEntityMeshesPortion:new Uint32Array(e(r.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(e(r.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(e(r.eachTileEntitiesPortion))}}const HR=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();function yf(r){const e=[];for(let t=0,i=r.length;t<i;t+=3)e.push(r[t]),e.push(r[t+1]),e.push(r[t+2]),e.push(1);return e}function VR(r,e,t,i,s,o){const n=o.getNextId(),a=t.positions,A=t.normals,l=t.colors,h=t.indices,d=t.edgeIndices,f=t.matrices,m=t.reusedGeometriesDecodeMatrix,_=t.eachGeometryPrimitiveType,u=t.eachGeometryPositionsPortion,B=t.eachGeometryNormalsPortion,y=t.eachGeometryColorsPortion,x=t.eachGeometryIndicesPortion,P=t.eachGeometryEdgeIndicesPortion,v=t.eachMeshGeometriesPortion,b=t.eachMeshMatricesPortion,C=t.eachMeshMaterial,I=JSON.parse(t.eachEntityId),E=t.eachEntityMeshesPortion,S=t.eachTileAABB,R=t.eachTileEntitiesPortion,D=u.length,K=v.length,j=I.length,z=R.length,le=new Uint32Array(D);for(let Be=0;Be<K;Be++){const be=v[Be];le[be]!==void 0?le[be]++:le[be]=1}const ue=c.vec3(),ae=c.AABB3();for(let Be=0;Be<z;Be++){const be=z-1,xe=Be===be,Ie=R[Be],Fe=xe?j:R[Be+1],Qe=Be*6,Ge=S.subarray(Qe,Qe+6);c.getAABB3Center(Ge,ue),ae[0]=Ge[0]-ue[0],ae[1]=Ge[1]-ue[1],ae[2]=Ge[2]-ue[2],ae[3]=Ge[3]-ue[0],ae[4]=Ge[4]-ue[1],ae[5]=Ge[5]-ue[2];const V=st.createPositionsDecodeMatrix(ae),Z={};for(let L=Ie;L<Fe;L++){const Q=I[L],O=e.globalizeObjectIds?c.globalizeObjectId(i.id,Q):Q,W=j-1,X=L===W,te=E[L],se=X?v.length:E[L+1],ie=[],oe=r.metaScene.metaObjects[O],he={},ce={};if(oe){if(e.excludeTypesMap&&oe.type&&e.excludeTypesMap[oe.type]||e.includeTypesMap&&oe.type&&!e.includeTypesMap[oe.type])continue;const $=e.objectDefaults?e.objectDefaults[oe.type]||e.objectDefaults.DEFAULT:null;$&&($.visible===!1&&(he.visible=!1),$.pickable===!1&&(he.pickable=!1),$.colorize&&(ce.color=$.colorize),$.opacity!==void 0&&$.opacity!==null&&(ce.opacity=$.opacity),$.metallic!==void 0&&$.metallic!==null&&(ce.metallic=$.metallic),$.roughness!==void 0&&$.roughness!==null&&(ce.roughness=$.roughness))}else if(e.excludeUnclassifiedObjects)continue;for(let $=te;$<se;$++){const ee=v[$],re=le[ee]>1,me=ee===D-1,de=HR(C.subarray($*6,$*6+3)),Y=C[$*6+3]/255,Ue=C[$*6+4]/255,pe=C[$*6+5]/255,De=o.getNextId();if(re){const fe=b[$],je=f.slice(fe,fe+16),Ae=`${n}-geometry.${Be}.${ee}`;if(!Z[Ae]){const Re=_[ee];let ze,ne,ke,Ke,Ne,it;switch(Re){case 0:ze="solid",ne=a.subarray(u[ee],me?a.length:u[ee+1]),ke=A.subarray(B[ee],me?A.length:B[ee+1]),Ne=h.subarray(x[ee],me?h.length:x[ee+1]),it=d.subarray(P[ee],me?d.length:P[ee+1]);break;case 1:ze="surface",ne=a.subarray(u[ee],me?a.length:u[ee+1]),ke=A.subarray(B[ee],me?A.length:B[ee+1]),Ne=h.subarray(x[ee],me?h.length:x[ee+1]),it=d.subarray(P[ee],me?d.length:P[ee+1]);break;case 2:ze="points",ne=a.subarray(u[ee],me?a.length:u[ee+1]),Ke=yf(l.subarray(y[ee],me?l.length:y[ee+1]));break;case 3:ze="lines",ne=a.subarray(u[ee],me?a.length:u[ee+1]),Ne=h.subarray(x[ee],me?h.length:x[ee+1]);break;default:continue}i.createGeometry({id:Ae,primitive:ze,positionsCompressed:ne,normalsCompressed:ke,colors:Ke,indices:Ne,edgeIndices:it,positionsDecodeMatrix:m}),Z[Ae]=!0}i.createMesh(Se.apply(ce,{id:De,geometryId:Ae,origin:ue,matrix:je,color:de,metallic:Ue,roughness:pe,opacity:Y})),ie.push(De)}else{const fe=_[ee];let je,Ae,Re,ze,ne,ke;switch(fe){case 0:je="solid",Ae=a.subarray(u[ee],me?a.length:u[ee+1]),Re=A.subarray(B[ee],me?A.length:B[ee+1]),ne=h.subarray(x[ee],me?h.length:x[ee+1]),ke=d.subarray(P[ee],me?d.length:P[ee+1]);break;case 1:je="surface",Ae=a.subarray(u[ee],me?a.length:u[ee+1]),Re=A.subarray(B[ee],me?A.length:B[ee+1]),ne=h.subarray(x[ee],me?h.length:x[ee+1]),ke=d.subarray(P[ee],me?d.length:P[ee+1]);break;case 2:je="points",Ae=a.subarray(u[ee],me?a.length:u[ee+1]),ze=yf(l.subarray(y[ee],me?l.length:y[ee+1]));break;case 3:je="lines",Ae=a.subarray(u[ee],me?a.length:u[ee+1]),ne=h.subarray(x[ee],me?h.length:x[ee+1]);break;default:continue}i.createMesh(Se.apply(ce,{id:De,origin:ue,primitive:je,positionsCompressed:Ae,normalsCompressed:Re,colors:ze,indices:ne,edgeIndices:ke,positionsDecodeMatrix:V,color:de,metallic:Ue,roughness:pe,opacity:Y})),ie.push(De)}}ie.length>0&&i.createEntity(Se.apply(he,{id:O,isObject:!0,meshIds:ie}))}}}const xf={version:7,parse:function(r,e,t,i,s,o){const n=NR(t),a=QR(n);VR(r,e,a,i,s,o)}};let Rs=window.pako||Ki;Rs.inflate||(Rs=Rs.default);const ts=c.vec4(),wf=c.vec4();function GR(r){return{types:r[0],eachMetaObjectId:r[1],eachMetaObjectType:r[2],eachMetaObjectName:r[3],eachMetaObjectParent:r[4],positions:r[5],normals:r[6],colors:r[7],indices:r[8],edgeIndices:r[9],matrices:r[10],reusedGeometriesDecodeMatrix:r[11],eachGeometryPrimitiveType:r[12],eachGeometryPositionsPortion:r[13],eachGeometryNormalsPortion:r[14],eachGeometryColorsPortion:r[15],eachGeometryIndicesPortion:r[16],eachGeometryEdgeIndicesPortion:r[17],eachMeshGeometriesPortion:r[18],eachMeshMatricesPortion:r[19],eachMeshMaterial:r[20],eachEntityMetaObject:r[21],eachEntityMeshesPortion:r[22],eachTileAABB:r[23],eachTileEntitiesPortion:r[24]}}function jR(r){function e(t,i){return t.length===0?[]:Rs.inflate(t,i).buffer}return{types:Rs.inflate(r.types,{to:"string"}),eachMetaObjectId:Rs.inflate(r.eachMetaObjectId,{to:"string"}),eachMetaObjectType:new Uint32Array(e(r.eachMetaObjectType)),eachMetaObjectName:Rs.inflate(r.eachMetaObjectName,{to:"string"}),eachMetaObjectParent:new Uint32Array(e(r.eachMetaObjectParent)),positions:new Uint16Array(e(r.positions)),normals:new Int8Array(e(r.normals)),colors:new Uint8Array(e(r.colors)),indices:new Uint32Array(e(r.indices)),edgeIndices:new Uint32Array(e(r.edgeIndices)),matrices:new Float32Array(e(r.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(e(r.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(e(r.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(e(r.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(e(r.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(e(r.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(e(r.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(e(r.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(e(r.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(e(r.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(e(r.eachMeshMaterial)),eachEntityMetaObject:new Uint32Array(e(r.eachEntityMetaObject)),eachEntityMeshesPortion:new Uint32Array(e(r.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(e(r.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(e(r.eachTileEntitiesPortion))}}const zR=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();function bf(r){const e=[];for(let t=0,i=r.length;t<i;t+=3)e.push(r[t]),e.push(r[t+1]),e.push(r[t+2]),e.push(1);return e}function KR(r,e,t,i,s,o){const n=o.getNextId(),a=JSON.parse(t.types),A=JSON.parse(t.eachMetaObjectId),l=t.eachMetaObjectType,h=JSON.parse(t.eachMetaObjectName),d=t.eachMetaObjectParent,f=t.positions,m=t.normals,_=t.colors,u=t.indices,B=t.edgeIndices,y=t.matrices,x=t.reusedGeometriesDecodeMatrix,P=t.eachGeometryPrimitiveType,v=t.eachGeometryPositionsPortion,b=t.eachGeometryNormalsPortion,C=t.eachGeometryColorsPortion,I=t.eachGeometryIndicesPortion,E=t.eachGeometryEdgeIndicesPortion,S=t.eachMeshGeometriesPortion,R=t.eachMeshMatricesPortion,D=t.eachMeshMaterial,K=t.eachEntityMetaObject,j=t.eachEntityMeshesPortion,z=t.eachTileAABB,le=t.eachTileEntitiesPortion,ue=A.length,ae=v.length,Be=S.length,be=K.length,xe=le.length;if(s){const V={metaObjects:[]};for(let Z=0;Z<ue;Z++){const L=A[Z],Q=l[Z],O=a[Q]||"default",W=h[Z],X=d[Z],te=X!==Z?A[X]:null;V.metaObjects.push({id:L,type:O,name:W,parent:te})}s.loadData(V,{includeTypes:e.includeTypes,excludeTypes:e.excludeTypes,globalizeObjectIds:e.globalizeObjectIds})}const Ie=new Uint32Array(ae);for(let V=0;V<Be;V++){const Z=S[V];Ie[Z]!==void 0?Ie[Z]++:Ie[Z]=1}const Fe=c.vec3(),Qe=c.AABB3(),Ge={};for(let V=0;V<xe;V++){const Z=xe-1,L=V===Z,Q=le[V],O=L?be:le[V+1],W=V*6,X=z.subarray(W,W+6);c.getAABB3Center(X,Fe),Qe[0]=X[0]-Fe[0],Qe[1]=X[1]-Fe[1],Qe[2]=X[2]-Fe[2],Qe[3]=X[3]-Fe[0],Qe[4]=X[4]-Fe[1],Qe[5]=X[5]-Fe[2];const te=st.createPositionsDecodeMatrix(Qe),se={};for(let ie=Q;ie<O;ie++){const oe=K[ie],ce=A[oe],$=e.globalizeObjectIds?c.globalizeObjectId(i.id,ce):ce,ee=be-1,ge=ie===ee,re=j[ie],me=ge?S.length:j[ie+1],de=[],Y=r.metaScene.metaObjects[$],Ue={},pe={};if(Y){if(e.excludeTypesMap&&Y.type&&e.excludeTypesMap[Y.type]||e.includeTypesMap&&Y.type&&!e.includeTypesMap[Y.type])continue;const De=e.objectDefaults?e.objectDefaults[Y.type]||e.objectDefaults.DEFAULT:null;De&&(De.visible===!1&&(Ue.visible=!1),De.pickable===!1&&(Ue.pickable=!1),De.colorize&&(pe.color=De.colorize),De.opacity!==void 0&&De.opacity!==null&&(pe.opacity=De.opacity),De.metallic!==void 0&&De.metallic!==null&&(pe.metallic=De.metallic),De.roughness!==void 0&&De.roughness!==null&&(pe.roughness=De.roughness))}else if(e.excludeUnclassifiedObjects)continue;for(let De=re;De<me;De++){const fe=S[De],Ae=Ie[fe]>1,Re=fe===ae-1,ze=zR(D.subarray(De*6,De*6+3)),ne=D[De*6+3]/255,ke=D[De*6+4]/255,Ke=D[De*6+5]/255,Ne=o.getNextId();if(Ae){const it=R[De],Ze=y.slice(it,it+16),at=`${n}-geometry.${V}.${fe}`;let Ce=Ge[at];if(!Ce){Ce={batchThisMesh:!e.reuseGeometries};const ot=P[fe];let Je=!1;switch(ot){case 0:Ce.primitiveName="solid",Ce.geometryPositions=f.subarray(v[fe],Re?f.length:v[fe+1]),Ce.geometryNormals=m.subarray(b[fe],Re?m.length:b[fe+1]),Ce.geometryIndices=u.subarray(I[fe],Re?u.length:I[fe+1]),Ce.geometryEdgeIndices=B.subarray(E[fe],Re?B.length:E[fe+1]),Je=Ce.geometryPositions.length>0&&Ce.geometryIndices.length>0;break;case 1:Ce.primitiveName="surface",Ce.geometryPositions=f.subarray(v[fe],Re?f.length:v[fe+1]),Ce.geometryNormals=m.subarray(b[fe],Re?m.length:b[fe+1]),Ce.geometryIndices=u.subarray(I[fe],Re?u.length:I[fe+1]),Ce.geometryEdgeIndices=B.subarray(E[fe],Re?B.length:E[fe+1]),Je=Ce.geometryPositions.length>0&&Ce.geometryIndices.length>0;break;case 2:Ce.primitiveName="points",Ce.geometryPositions=f.subarray(v[fe],Re?f.length:v[fe+1]),Ce.geometryColors=bf(_.subarray(C[fe],Re?_.length:C[fe+1])),Je=Ce.geometryPositions.length>0;break;case 3:Ce.primitiveName="lines",Ce.geometryPositions=f.subarray(v[fe],Re?f.length:v[fe+1]),Ce.geometryIndices=u.subarray(I[fe],Re?u.length:I[fe+1]),Je=Ce.geometryPositions.length>0&&Ce.geometryIndices.length>0;break;default:continue}if(Je||(Ce=null),Ce&&(Ce.geometryPositions.length>1e3,Ce.batchThisMesh)){Ce.decompressedPositions=new Float32Array(Ce.geometryPositions.length);const Te=Ce.geometryPositions,Pe=Ce.decompressedPositions;for(let ht=0,St=Te.length;ht<St;ht+=3)Pe[ht+0]=Te[ht+0]*x[0]+x[12],Pe[ht+1]=Te[ht+1]*x[5]+x[13],Pe[ht+2]=Te[ht+2]*x[10]+x[14];Ce.geometryPositions=null,Ge[at]=Ce}}if(Ce)if(Ce.batchThisMesh){const ot=Ce.decompressedPositions,Je=new Uint16Array(ot.length);for(let Te=0,Pe=ot.length;Te<Pe;Te+=3)ts[0]=ot[Te+0],ts[1]=ot[Te+1],ts[2]=ot[Te+2],ts[3]=1,c.transformVec4(Ze,ts,wf),st.compressPosition(wf,Qe,ts),Je[Te+0]=ts[0],Je[Te+1]=ts[1],Je[Te+2]=ts[2];i.createMesh(Se.apply(pe,{id:Ne,origin:Fe,primitive:Ce.primitiveName,positionsCompressed:Je,normalsCompressed:Ce.geometryNormals,colorsCompressed:Ce.geometryColors,indices:Ce.geometryIndices,edgeIndices:Ce.geometryEdgeIndices,positionsDecodeMatrix:te,color:ze,metallic:ke,roughness:Ke,opacity:ne})),de.push(Ne)}else se[at]||(i.createGeometry({id:at,primitive:Ce.primitiveName,positionsCompressed:Ce.geometryPositions,normalsCompressed:Ce.geometryNormals,colorsCompressed:Ce.geometryColors,indices:Ce.geometryIndices,edgeIndices:Ce.geometryEdgeIndices,positionsDecodeMatrix:x}),se[at]=!0),i.createMesh(Se.apply(pe,{id:Ne,geometryId:at,origin:Fe,matrix:Ze,color:ze,metallic:ke,roughness:Ke,opacity:ne})),de.push(Ne)}else{const it=P[fe];let Ze,at,Ce,ot,Je,Te,Pe=!1;switch(it){case 0:Ze="solid",at=f.subarray(v[fe],Re?f.length:v[fe+1]),Ce=m.subarray(b[fe],Re?m.length:b[fe+1]),Je=u.subarray(I[fe],Re?u.length:I[fe+1]),Te=B.subarray(E[fe],Re?B.length:E[fe+1]),Pe=at.length>0&&Je.length>0;break;case 1:Ze="surface",at=f.subarray(v[fe],Re?f.length:v[fe+1]),Ce=m.subarray(b[fe],Re?m.length:b[fe+1]),Je=u.subarray(I[fe],Re?u.length:I[fe+1]),Te=B.subarray(E[fe],Re?B.length:E[fe+1]),Pe=at.length>0&&Je.length>0;break;case 2:Ze="points",at=f.subarray(v[fe],Re?f.length:v[fe+1]),ot=bf(_.subarray(C[fe],Re?_.length:C[fe+1])),Pe=at.length>0;break;case 3:Ze="lines",at=f.subarray(v[fe],Re?f.length:v[fe+1]),Je=u.subarray(I[fe],Re?u.length:I[fe+1]),Pe=at.length>0&&Je.length>0;break;default:continue}Pe&&(i.createMesh(Se.apply(pe,{id:Ne,origin:Fe,primitive:Ze,positionsCompressed:at,normalsCompressed:Ce,colorsCompressed:ot,indices:Je,edgeIndices:Te,positionsDecodeMatrix:te,color:ze,metallic:ke,roughness:Ke,opacity:ne})),de.push(Ne))}}de.length>0&&i.createEntity(Se.apply(Ue,{id:$,isObject:!0,meshIds:de}))}}}const Cf={version:8,parse:function(r,e,t,i,s,o){const n=GR(t),a=jR(n);KR(r,e,a,i,s,o)}};let Cr=window.pako||Ki;Cr.inflate||(Cr=Cr.default);const is=c.vec4(),Ef=c.vec4();function WR(r){return{metadata:r[0],positions:r[1],normals:r[2],colors:r[3],indices:r[4],edgeIndices:r[5],matrices:r[6],reusedGeometriesDecodeMatrix:r[7],eachGeometryPrimitiveType:r[8],eachGeometryPositionsPortion:r[9],eachGeometryNormalsPortion:r[10],eachGeometryColorsPortion:r[11],eachGeometryIndicesPortion:r[12],eachGeometryEdgeIndicesPortion:r[13],eachMeshGeometriesPortion:r[14],eachMeshMatricesPortion:r[15],eachMeshMaterial:r[16],eachEntityId:r[17],eachEntityMeshesPortion:r[18],eachTileAABB:r[19],eachTileEntitiesPortion:r[20]}}function XR(r){function e(t,i){return t.length===0?[]:Cr.inflate(t,i).buffer}return{metadata:JSON.parse(Cr.inflate(r.metadata,{to:"string"})),positions:new Uint16Array(e(r.positions)),normals:new Int8Array(e(r.normals)),colors:new Uint8Array(e(r.colors)),indices:new Uint32Array(e(r.indices)),edgeIndices:new Uint32Array(e(r.edgeIndices)),matrices:new Float32Array(e(r.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(e(r.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(e(r.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(e(r.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(e(r.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(e(r.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(e(r.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(e(r.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(e(r.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(e(r.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(e(r.eachMeshMaterial)),eachEntityId:JSON.parse(Cr.inflate(r.eachEntityId,{to:"string"})),eachEntityMeshesPortion:new Uint32Array(e(r.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(e(r.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(e(r.eachTileEntitiesPortion))}}const YR=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();function JR(r,e,t,i,s,o){const n=o.getNextId(),a=t.metadata,A=t.positions,l=t.normals,h=t.colors,d=t.indices,f=t.edgeIndices,m=t.matrices,_=t.reusedGeometriesDecodeMatrix,u=t.eachGeometryPrimitiveType,B=t.eachGeometryPositionsPortion,y=t.eachGeometryNormalsPortion,x=t.eachGeometryColorsPortion,P=t.eachGeometryIndicesPortion,v=t.eachGeometryEdgeIndicesPortion,b=t.eachMeshGeometriesPortion,C=t.eachMeshMatricesPortion,I=t.eachMeshMaterial,E=t.eachEntityId,S=t.eachEntityMeshesPortion,R=t.eachTileAABB,D=t.eachTileEntitiesPortion,K=B.length,j=b.length,z=S.length,le=D.length;s&&s.loadData(a,{includeTypes:e.includeTypes,excludeTypes:e.excludeTypes,globalizeObjectIds:e.globalizeObjectIds});const ue=new Uint32Array(K);for(let xe=0;xe<j;xe++){const Ie=b[xe];ue[Ie]!==void 0?ue[Ie]++:ue[Ie]=1}const ae=c.vec3(),Be=c.AABB3(),be={};for(let xe=0;xe<le;xe++){const Ie=le-1,Fe=xe===Ie,Qe=D[xe],Ge=Fe?z-1:D[xe+1]-1,V=xe*6,Z=R.subarray(V,V+6);c.getAABB3Center(Z,ae),Be[0]=Z[0]-ae[0],Be[1]=Z[1]-ae[1],Be[2]=Z[2]-ae[2],Be[3]=Z[3]-ae[0],Be[4]=Z[4]-ae[1],Be[5]=Z[5]-ae[2];const L=st.createPositionsDecodeMatrix(Be),Q={};for(let O=Qe;O<=Ge;O++){const W=E[O],X=e.globalizeObjectIds?c.globalizeObjectId(i.id,W):W,te=z-1,se=O===te,ie=S[O],oe=se?b.length-1:S[O+1]-1,he=[],ce=r.metaScene.metaObjects[X],$={},ee={};if(ce){if(e.excludeTypesMap&&ce.type&&e.excludeTypesMap[ce.type]||e.includeTypesMap&&ce.type&&!e.includeTypesMap[ce.type])continue;const ge=e.objectDefaults?e.objectDefaults[ce.type]||e.objectDefaults.DEFAULT:null;ge&&(ge.visible===!1&&($.visible=!1),ge.pickable===!1&&($.pickable=!1),ge.colorize&&(ee.color=ge.colorize),ge.opacity!==void 0&&ge.opacity!==null&&(ee.opacity=ge.opacity),ge.metallic!==void 0&&ge.metallic!==null&&(ee.metallic=ge.metallic),ge.roughness!==void 0&&ge.roughness!==null&&(ee.roughness=ge.roughness))}else if(e.excludeUnclassifiedObjects)continue;for(let ge=ie;ge<=oe;ge++){const re=b[ge],de=ue[re]>1,Y=re===K-1,Ue=YR(I.subarray(ge*6,ge*6+3)),pe=I[ge*6+3]/255,De=I[ge*6+4]/255,fe=I[ge*6+5]/255,je=o.getNextId();if(de){const Ae=C[ge],Re=m.slice(Ae,Ae+16),ze=`${n}-geometry.${xe}.${re}`;let ne=be[ze];if(!ne){ne={batchThisMesh:!e.reuseGeometries};const ke=u[re];let Ke=!1;switch(ke){case 0:ne.primitiveName="solid",ne.geometryPositions=A.subarray(B[re],Y?A.length:B[re+1]),ne.geometryNormals=l.subarray(y[re],Y?l.length:y[re+1]),ne.geometryIndices=d.subarray(P[re],Y?d.length:P[re+1]),ne.geometryEdgeIndices=f.subarray(v[re],Y?f.length:v[re+1]),Ke=ne.geometryPositions.length>0&&ne.geometryIndices.length>0;break;case 1:ne.primitiveName="surface",ne.geometryPositions=A.subarray(B[re],Y?A.length:B[re+1]),ne.geometryNormals=l.subarray(y[re],Y?l.length:y[re+1]),ne.geometryIndices=d.subarray(P[re],Y?d.length:P[re+1]),ne.geometryEdgeIndices=f.subarray(v[re],Y?f.length:v[re+1]),Ke=ne.geometryPositions.length>0&&ne.geometryIndices.length>0;break;case 2:ne.primitiveName="points",ne.geometryPositions=A.subarray(B[re],Y?A.length:B[re+1]),ne.geometryColors=h.subarray(x[re],Y?h.length:x[re+1]),Ke=ne.geometryPositions.length>0;break;case 3:ne.primitiveName="lines",ne.geometryPositions=A.subarray(B[re],Y?A.length:B[re+1]),ne.geometryIndices=d.subarray(P[re],Y?d.length:P[re+1]),Ke=ne.geometryPositions.length>0&&ne.geometryIndices.length>0;break;default:continue}if(Ke||(ne=null),ne&&(ne.geometryPositions.length>1e3,ne.batchThisMesh)){ne.decompressedPositions=new Float32Array(ne.geometryPositions.length),ne.transformedAndRecompressedPositions=new Uint16Array(ne.geometryPositions.length);const Ne=ne.geometryPositions,it=ne.decompressedPositions;for(let Ze=0,at=Ne.length;Ze<at;Ze+=3)it[Ze+0]=Ne[Ze+0]*_[0]+_[12],it[Ze+1]=Ne[Ze+1]*_[5]+_[13],it[Ze+2]=Ne[Ze+2]*_[10]+_[14];ne.geometryPositions=null,be[ze]=ne}}if(ne)if(ne.batchThisMesh){const ke=ne.decompressedPositions,Ke=ne.transformedAndRecompressedPositions;for(let Ne=0,it=ke.length;Ne<it;Ne+=3)is[0]=ke[Ne+0],is[1]=ke[Ne+1],is[2]=ke[Ne+2],is[3]=1,c.transformVec4(Re,is,Ef),st.compressPosition(Ef,Be,is),Ke[Ne+0]=is[0],Ke[Ne+1]=is[1],Ke[Ne+2]=is[2];i.createMesh(Se.apply(ee,{id:je,origin:ae,primitive:ne.primitiveName,positionsCompressed:Ke,normalsCompressed:ne.geometryNormals,colorsCompressed:ne.geometryColors,indices:ne.geometryIndices,edgeIndices:ne.geometryEdgeIndices,positionsDecodeMatrix:L,color:Ue,metallic:De,roughness:fe,opacity:pe})),he.push(je)}else Q[ze]||(i.createGeometry({id:ze,primitive:ne.primitiveName,positionsCompressed:ne.geometryPositions,normalsCompressed:ne.geometryNormals,colorsCompressed:ne.geometryColors,indices:ne.geometryIndices,edgeIndices:ne.geometryEdgeIndices,positionsDecodeMatrix:_}),Q[ze]=!0),i.createMesh(Se.apply(ee,{id:je,geometryId:ze,origin:ae,matrix:Re,color:Ue,metallic:De,roughness:fe,opacity:pe})),he.push(je)}else{const Ae=u[re];let Re,ze,ne,ke,Ke,Ne,it=!1;switch(Ae){case 0:Re="solid",ze=A.subarray(B[re],Y?A.length:B[re+1]),ne=l.subarray(y[re],Y?l.length:y[re+1]),Ke=d.subarray(P[re],Y?d.length:P[re+1]),Ne=f.subarray(v[re],Y?f.length:v[re+1]),it=ze.length>0&&Ke.length>0;break;case 1:Re="surface",ze=A.subarray(B[re],Y?A.length:B[re+1]),ne=l.subarray(y[re],Y?l.length:y[re+1]),Ke=d.subarray(P[re],Y?d.length:P[re+1]),Ne=f.subarray(v[re],Y?f.length:v[re+1]),it=ze.length>0&&Ke.length>0;break;case 2:Re="points",ze=A.subarray(B[re],Y?A.length:B[re+1]),ke=h.subarray(x[re],Y?h.length:x[re+1]),it=ze.length>0;break;case 3:Re="lines",ze=A.subarray(B[re],Y?A.length:B[re+1]),Ke=d.subarray(P[re],Y?d.length:P[re+1]),it=ze.length>0&&Ke.length>0;break;default:continue}it&&(i.createMesh(Se.apply(ee,{id:je,origin:ae,primitive:Re,positionsCompressed:ze,normalsCompressed:ne,colorsCompressed:ke,indices:Ke,edgeIndices:Ne,positionsDecodeMatrix:L,color:Ue,metallic:De,roughness:fe,opacity:pe})),he.push(je))}}he.length>0&&i.createEntity(Se.apply($,{id:X,isObject:!0,meshIds:he}))}}}const If={version:9,parse:function(r,e,t,i,s,o){const n=WR(t),a=XR(n);JR(r,e,a,i,s,o)}};let Er=window.pako||Ki;Er.inflate||(Er=Er.default);const ss=c.vec4(),Ff=c.vec4(),ZR=9;function qR(r){let e=0;return{metadata:r[e++],textureData:r[e++],eachTextureDataPortion:r[e++],eachTextureAttributes:r[e++],positions:r[e++],normals:r[e++],colors:r[e++],uvs:r[e++],indices:r[e++],edgeIndices:r[e++],eachTextureSetTextures:r[e++],matrices:r[e++],reusedGeometriesDecodeMatrix:r[e++],eachGeometryPrimitiveType:r[e++],eachGeometryPositionsPortion:r[e++],eachGeometryNormalsPortion:r[e++],eachGeometryColorsPortion:r[e++],eachGeometryUVsPortion:r[e++],eachGeometryIndicesPortion:r[e++],eachGeometryEdgeIndicesPortion:r[e++],eachMeshGeometriesPortion:r[e++],eachMeshMatricesPortion:r[e++],eachMeshTextureSet:r[e++],eachMeshMaterialAttributes:r[e++],eachEntityId:r[e++],eachEntityMeshesPortion:r[e++],eachTileAABB:r[e++],eachTileEntitiesPortion:r[e++]}}function $R(r){function e(t,i){return t.length===0?[]:Er.inflate(t,i).buffer}return{metadata:JSON.parse(Er.inflate(r.metadata,{to:"string"})),textureData:new Uint8Array(e(r.textureData)),eachTextureDataPortion:new Uint32Array(e(r.eachTextureDataPortion)),eachTextureAttributes:new Uint16Array(e(r.eachTextureAttributes)),positions:new Uint16Array(e(r.positions)),normals:new Int8Array(e(r.normals)),colors:new Uint8Array(e(r.colors)),uvs:new Float32Array(e(r.uvs)),indices:new Uint32Array(e(r.indices)),edgeIndices:new Uint32Array(e(r.edgeIndices)),eachTextureSetTextures:new Int32Array(e(r.eachTextureSetTextures)),matrices:new Float32Array(e(r.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(e(r.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(e(r.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(e(r.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(e(r.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(e(r.eachGeometryColorsPortion)),eachGeometryUVsPortion:new Uint32Array(e(r.eachGeometryUVsPortion)),eachGeometryIndicesPortion:new Uint32Array(e(r.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(e(r.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(e(r.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(e(r.eachMeshMatricesPortion)),eachMeshTextureSet:new Int32Array(e(r.eachMeshTextureSet)),eachMeshMaterialAttributes:new Uint8Array(e(r.eachMeshMaterialAttributes)),eachEntityId:JSON.parse(Er.inflate(r.eachEntityId,{to:"string"})),eachEntityMeshesPortion:new Uint32Array(e(r.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(e(r.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(e(r.eachTileEntitiesPortion))}}const eL=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();(function(){const r=document.createElement("canvas"),e=r.getContext("2d");return function(t){return r.width=t.width,r.height=t.height,e.putImageData(t,0,0),r.toDataURL()}})();function tL(r,e,t,i,s,o){const n=o.getNextId(),a=t.metadata,A=t.textureData,l=t.eachTextureDataPortion,h=t.eachTextureAttributes,d=t.positions,f=t.normals,m=t.colors,_=t.uvs,u=t.indices,B=t.edgeIndices,y=t.eachTextureSetTextures,x=t.matrices,P=t.reusedGeometriesDecodeMatrix,v=t.eachGeometryPrimitiveType,b=t.eachGeometryPositionsPortion,C=t.eachGeometryNormalsPortion,I=t.eachGeometryColorsPortion,E=t.eachGeometryUVsPortion,S=t.eachGeometryIndicesPortion,R=t.eachGeometryEdgeIndicesPortion,D=t.eachMeshGeometriesPortion,K=t.eachMeshMatricesPortion,j=t.eachMeshTextureSet,z=t.eachMeshMaterialAttributes,le=t.eachEntityId,ue=t.eachEntityMeshesPortion,ae=t.eachTileAABB,Be=t.eachTileEntitiesPortion,be=l.length,xe=y.length/5,Ie=b.length,Fe=D.length,Qe=ue.length,Ge=Be.length;s&&s.loadData(a,{includeTypes:e.includeTypes,excludeTypes:e.excludeTypes,globalizeObjectIds:e.globalizeObjectIds});for(let O=0;O<be;O++){const W=O===be-1,X=l[O],te=W?A.length:l[O+1],ie=te-X>0,oe=O*ZR,he=h[oe+0]===1,ce=h[oe+1];h[oe+2],h[oe+3];const $=h[oe+4],ee=h[oe+5],ge=h[oe+6],re=h[oe+7],me=h[oe+8];if(ie){const Y=new Uint8Array(A.subarray(X,te)).buffer,Ue=`${n}-texture-${O}`;if(he)i.createTexture({id:Ue,buffers:[Y],minFilter:$,magFilter:ee,wrapS:ge,wrapT:re,wrapR:me});else{const pe=ce===Yv?"image/jpeg":ce===Jv?"image/png":"image/gif",De=new Blob([Y],{type:pe}),je=(window.URL||window.webkitURL).createObjectURL(De),Ae=document.createElement("img");Ae.src=je,i.createTexture({id:Ue,image:Ae,minFilter:$,magFilter:ee,wrapS:ge,wrapT:re,wrapR:me})}}}for(let O=0;O<xe;O++){const W=O*5,X=`${n}-textureSet-${O}`,te=y[W+0],se=y[W+1],ie=y[W+2],oe=y[W+3],he=y[W+4];i.createTextureSet({id:X,colorTextureId:te>=0?`${n}-texture-${te}`:null,normalsTextureId:ie>=0?`${n}-texture-${ie}`:null,metallicRoughnessTextureId:se>=0?`${n}-texture-${se}`:null,emissiveTextureId:oe>=0?`${n}-texture-${oe}`:null,occlusionTextureId:he>=0?`${n}-texture-${he}`:null})}const V=new Uint32Array(Ie);for(let O=0;O<Fe;O++){const W=D[O];V[W]!==void 0?V[W]++:V[W]=1}const Z=c.vec3(),L=c.AABB3(),Q={};for(let O=0;O<Ge;O++){const W=Ge-1,X=O===W,te=Be[O],se=X?Qe-1:Be[O+1]-1,ie=O*6,oe=ae.subarray(ie,ie+6);c.getAABB3Center(oe,Z),L[0]=oe[0]-Z[0],L[1]=oe[1]-Z[1],L[2]=oe[2]-Z[2],L[3]=oe[3]-Z[0],L[4]=oe[4]-Z[1],L[5]=oe[5]-Z[2];const he=st.createPositionsDecodeMatrix(L),ce={};for(let $=te;$<=se;$++){const ee=le[$],ge=e.globalizeObjectIds?c.globalizeObjectId(i.id,ee):ee,re=Qe-1,me=$===re,de=ue[$],Y=me?D.length-1:ue[$+1]-1,Ue=[],pe=r.metaScene.metaObjects[ge],De={},fe={};if(pe){if(e.excludeTypesMap&&pe.type&&e.excludeTypesMap[pe.type]||e.includeTypesMap&&pe.type&&!e.includeTypesMap[pe.type])continue;const je=e.objectDefaults?e.objectDefaults[pe.type]||e.objectDefaults.DEFAULT:null;je&&(je.visible===!1&&(De.visible=!1),je.pickable===!1&&(De.pickable=!1),je.colorize&&(fe.color=je.colorize),je.opacity!==void 0&&je.opacity!==null&&(fe.opacity=je.opacity),je.metallic!==void 0&&je.metallic!==null&&(fe.metallic=je.metallic),je.roughness!==void 0&&je.roughness!==null&&(fe.roughness=je.roughness))}else if(e.excludeUnclassifiedObjects)continue;for(let je=de;je<=Y;je++){const Ae=D[je],ze=V[Ae]>1,ne=Ae===Ie-1,ke=j[je],Ke=ke>=0?`${n}-textureSet-${ke}`:null,Ne=eL(z.subarray(je*6,je*6+3)),it=z[je*6+3]/255,Ze=z[je*6+4]/255,at=z[je*6+5]/255,Ce=o.getNextId();if(ze){const ot=K[je],Je=x.slice(ot,ot+16),Te=`${n}-geometry.${O}.${Ae}`;let Pe=Q[Te];if(!Pe){Pe={batchThisMesh:!e.reuseGeometries};const ht=v[Ae];let St=!1;switch(ht){case 0:Pe.primitiveName="solid",Pe.geometryPositions=d.subarray(b[Ae],ne?d.length:b[Ae+1]),Pe.geometryNormals=f.subarray(C[Ae],ne?f.length:C[Ae+1]),Pe.geometryUVs=_.subarray(E[Ae],ne?_.length:E[Ae+1]),Pe.geometryIndices=u.subarray(S[Ae],ne?u.length:S[Ae+1]),Pe.geometryEdgeIndices=B.subarray(R[Ae],ne?B.length:R[Ae+1]),St=Pe.geometryPositions.length>0&&Pe.geometryIndices.length>0;break;case 1:Pe.primitiveName="surface",Pe.geometryPositions=d.subarray(b[Ae],ne?d.length:b[Ae+1]),Pe.geometryNormals=f.subarray(C[Ae],ne?f.length:C[Ae+1]),Pe.geometryUVs=_.subarray(E[Ae],ne?_.length:E[Ae+1]),Pe.geometryIndices=u.subarray(S[Ae],ne?u.length:S[Ae+1]),Pe.geometryEdgeIndices=B.subarray(R[Ae],ne?B.length:R[Ae+1]),St=Pe.geometryPositions.length>0&&Pe.geometryIndices.length>0;break;case 2:Pe.primitiveName="points",Pe.geometryPositions=d.subarray(b[Ae],ne?d.length:b[Ae+1]),Pe.geometryColors=m.subarray(I[Ae],ne?m.length:I[Ae+1]),St=Pe.geometryPositions.length>0;break;case 3:Pe.primitiveName="lines",Pe.geometryPositions=d.subarray(b[Ae],ne?d.length:b[Ae+1]),Pe.geometryIndices=u.subarray(S[Ae],ne?u.length:S[Ae+1]),St=Pe.geometryPositions.length>0&&Pe.geometryIndices.length>0;break;case 4:Pe.primitiveName="lines",Pe.geometryPositions=d.subarray(b[Ae],ne?d.length:b[Ae+1]),Pe.geometryIndices=Mf(Pe.geometryPositions,u.subarray(S[Ae],ne?u.length:S[Ae+1])),St=Pe.geometryPositions.length>0&&Pe.geometryIndices.length>0;break;default:continue}if(St||(Pe=null),Pe&&(Pe.geometryPositions.length>1e3,Pe.batchThisMesh)){Pe.decompressedPositions=new Float32Array(Pe.geometryPositions.length),Pe.transformedAndRecompressedPositions=new Uint16Array(Pe.geometryPositions.length);const ut=Pe.geometryPositions,gt=Pe.decompressedPositions;for(let kt=0,Ii=ut.length;kt<Ii;kt+=3)gt[kt+0]=ut[kt+0]*P[0]+P[12],gt[kt+1]=ut[kt+1]*P[5]+P[13],gt[kt+2]=ut[kt+2]*P[10]+P[14];Pe.geometryPositions=null,Q[Te]=Pe}}if(Pe)if(Pe.batchThisMesh){const ht=Pe.decompressedPositions,St=Pe.transformedAndRecompressedPositions;for(let ut=0,gt=ht.length;ut<gt;ut+=3)ss[0]=ht[ut+0],ss[1]=ht[ut+1],ss[2]=ht[ut+2],ss[3]=1,c.transformVec4(Je,ss,Ff),st.compressPosition(Ff,L,ss),St[ut+0]=ss[0],St[ut+1]=ss[1],St[ut+2]=ss[2];i.createMesh(Se.apply(fe,{id:Ce,textureSetId:Ke,origin:Z,primitive:Pe.primitiveName,positionsCompressed:St,normalsCompressed:Pe.geometryNormals,uv:Pe.geometryUVs,colorsCompressed:Pe.geometryColors,indices:Pe.geometryIndices,edgeIndices:Pe.geometryEdgeIndices,positionsDecodeMatrix:he,color:Ne,metallic:Ze,roughness:at,opacity:it})),Ue.push(Ce)}else ce[Te]||(i.createGeometry({id:Te,primitive:Pe.primitiveName,positionsCompressed:Pe.geometryPositions,normalsCompressed:Pe.geometryNormals,uv:Pe.geometryUVs,colorsCompressed:Pe.geometryColors,indices:Pe.geometryIndices,edgeIndices:Pe.geometryEdgeIndices,positionsDecodeMatrix:P}),ce[Te]=!0),i.createMesh(Se.apply(fe,{id:Ce,geometryId:Te,textureSetId:Ke,matrix:Je,color:Ne,metallic:Ze,roughness:at,opacity:it,origin:Z})),Ue.push(Ce)}else{const ot=v[Ae];let Je,Te,Pe,ht,St,ut,gt,kt=!1;switch(ot){case 0:Je="solid",Te=d.subarray(b[Ae],ne?d.length:b[Ae+1]),Pe=f.subarray(C[Ae],ne?f.length:C[Ae+1]),ht=_.subarray(E[Ae],ne?_.length:E[Ae+1]),ut=u.subarray(S[Ae],ne?u.length:S[Ae+1]),gt=B.subarray(R[Ae],ne?B.length:R[Ae+1]),kt=Te.length>0&&ut.length>0;break;case 1:Je="surface",Te=d.subarray(b[Ae],ne?d.length:b[Ae+1]),Pe=f.subarray(C[Ae],ne?f.length:C[Ae+1]),ht=_.subarray(E[Ae],ne?_.length:E[Ae+1]),ut=u.subarray(S[Ae],ne?u.length:S[Ae+1]),gt=B.subarray(R[Ae],ne?B.length:R[Ae+1]),kt=Te.length>0&&ut.length>0;break;case 2:Je="points",Te=d.subarray(b[Ae],ne?d.length:b[Ae+1]),St=m.subarray(I[Ae],ne?m.length:I[Ae+1]),kt=Te.length>0;break;case 3:Je="lines",Te=d.subarray(b[Ae],ne?d.length:b[Ae+1]),ut=u.subarray(S[Ae],ne?u.length:S[Ae+1]),kt=Te.length>0&&ut.length>0;break;case 4:Je="lines",Te=d.subarray(b[Ae],ne?d.length:b[Ae+1]),ut=Mf(Te,u.subarray(S[Ae],ne?u.length:S[Ae+1])),kt=Te.length>0&&ut.length>0;break;default:continue}kt&&(i.createMesh(Se.apply(fe,{id:Ce,textureSetId:Ke,origin:Z,primitive:Je,positionsCompressed:Te,normalsCompressed:Pe,uv:ht&&ht.length>0?ht:null,colorsCompressed:St,indices:ut,edgeIndices:gt,positionsDecodeMatrix:he,color:Ne,metallic:Ze,roughness:at,opacity:it})),Ue.push(Ce))}}Ue.length>0&&i.createEntity(Se.apply(De,{id:ge,isObject:!0,meshIds:Ue}))}}}function Mf(r,e){const t=[];if(e.length>1)for(let i=0,s=e.length-1;i<s;i++)t.push(e[i]),t.push(e[i+1]);else if(r.length>1)for(let i=0,s=r.length/3-1;i<s;i++)t.push(i),t.push(i+1);return t}const Sf={version:10,parse:function(r,e,t,i,s,o){const n=qR(t),a=$R(n);tL(r,e,a,i,s,o)}},Wi={};Wi[gf.version]=gf;Wi[mf.version]=mf;Wi[_f.version]=_f;Wi[vf.version]=vf;Wi[Bf.version]=Bf;Wi[Pf.version]=Pf;Wi[xf.version]=xf;Wi[Cf.version]=Cf;Wi[If.version]=If;Wi[Sf.version]=Sf;var qm={};(function(r){var e="File format is not recognized.",t="CRC failed.",i="File contains encrypted entry.",s="File is using Zip64 (4gb+ file size).",o="Error while reading zip file.",n="Error while writing zip file.",a="Error while writing file data.",A="Error while reading file data.",l="File already exists.",h=524288,d="text/plain",f;try{f=new Blob([new DataView(new ArrayBuffer(0))]).size===0}catch{}function m(){this.crc=-1}m.prototype.append=function(Q){for(var O=this.crc|0,W=this.table,X=0,te=Q.length|0;X<te;X++)O=O>>>8^W[(O^Q[X])&255];this.crc=O},m.prototype.get=function(){return~this.crc},m.prototype.table=function(){var L,Q,O,W=[];for(L=0;L<256;L++){for(O=L,Q=0;Q<8;Q++)O&1?O=O>>>1^3988292384:O=O>>>1;W[L]=O}return W}();function _(){}_.prototype.append=function(Q,O){return Q},_.prototype.flush=function(){};function u(L,Q,O){if(Q<0||O<0||Q+O>L.size)throw new RangeError("offset:"+Q+", length:"+O+", size:"+L.size);if(L.slice)return L.slice(Q,Q+O);if(L.webkitSlice)return L.webkitSlice(Q,Q+O);if(L.mozSlice)return L.mozSlice(Q,Q+O);if(L.msSlice)return L.msSlice(Q,Q+O)}function B(L,Q){var O,W;return O=new ArrayBuffer(L),W=new Uint8Array(O),Q&&W.set(Q,0),{buffer:O,array:W,view:new DataView(O)}}function y(){}function x(L){var Q=this,O;function W(te,se){var ie=new Blob([L],{type:d});O=new v(ie),O.init(function(){Q.size=O.size,te()},se)}function X(te,se,ie,oe){O.readUint8Array(te,se,ie,oe)}Q.size=0,Q.init=W,Q.readUint8Array=X}x.prototype=new y,x.prototype.constructor=x;function P(L){var Q=this,O;function W(te){for(var se=L.length;L.charAt(se-1)=="=";)se--;O=L.indexOf(",")+1,Q.size=Math.floor((se-O)*.75),te()}function X(te,se,ie){var oe,he=B(se),ce=Math.floor(te/3)*4,$=Math.ceil((te+se)/3)*4,ee=r.atob(L.substring(ce+O,$+O)),ge=te-Math.floor(ce/4)*3;for(oe=ge;oe<ge+se;oe++)he.array[oe-ge]=ee.charCodeAt(oe);ie(he.array)}Q.size=0,Q.init=W,Q.readUint8Array=X}P.prototype=new y,P.prototype.constructor=P;function v(L){var Q=this;function O(X){Q.size=L.size,X()}function W(X,te,se,ie){var oe=new FileReader;oe.onload=function(he){se(new Uint8Array(he.target.result))},oe.onerror=ie;try{oe.readAsArrayBuffer(u(L,X,te))}catch(he){ie(he)}}Q.size=0,Q.init=O,Q.readUint8Array=W}v.prototype=new y,v.prototype.constructor=v;function b(){}b.prototype.getData=function(L){L(this.data)};function C(L){var Q=this,O;function W(se){O=new Blob([],{type:d}),se()}function X(se,ie){O=new Blob([O,f?se:se.buffer],{type:d}),ie()}function te(se,ie){var oe=new FileReader;oe.onload=function(he){se(he.target.result)},oe.onerror=ie,oe.readAsText(O,L)}Q.init=W,Q.writeUint8Array=X,Q.getData=te}C.prototype=new b,C.prototype.constructor=C;function I(L){var Q=this,O="",W="";function X(ie){O+="data:"+(L||"")+";base64,",ie()}function te(ie,oe){var he,ce=W.length,$=W;for(W="",he=0;he<Math.floor((ce+ie.length)/3)*3-ce;he++)$+=String.fromCharCode(ie[he]);for(;he<ie.length;he++)W+=String.fromCharCode(ie[he]);$.length>2?O+=r.btoa($):W=$,oe()}function se(ie){ie(O+r.btoa(W))}Q.init=X,Q.writeUint8Array=te,Q.getData=se}I.prototype=new b,I.prototype.constructor=I;function E(L){var Q,O=this;function W(se){Q=new Blob([],{type:L}),se()}function X(se,ie){Q=new Blob([Q,f?se:se.buffer],{type:L}),ie()}function te(se){se(Q)}O.init=W,O.writeUint8Array=X,O.getData=te}E.prototype=new b,E.prototype.constructor=E;function S(L,Q,O,W,X,te,se,ie,oe,he){var ce=0,$,ee,ge=Q.sn,re;function me(){L.removeEventListener("message",de,!1),ie(ee,re)}function de(Ue){var pe=Ue.data,De=pe.data,fe=pe.error;if(fe){fe.toString=function(){return"Error: "+this.message},oe(fe);return}if(pe.sn===ge)switch(typeof pe.codecTime=="number"&&(L.codecTime+=pe.codecTime),typeof pe.crcTime=="number"&&(L.crcTime+=pe.crcTime),pe.type){case"append":De?(ee+=De.length,W.writeUint8Array(De,function(){Y()},he)):Y();break;case"flush":re=pe.crc,De?(ee+=De.length,W.writeUint8Array(De,function(){me()},he)):me();break;case"progress":se&&se($+pe.loaded,te);break;case"importScripts":case"newTask":case"echo":break;default:console.warn("zip.js:launchWorkerProcess: unknown message: ",pe)}}function Y(){$=ce*h,$<=te?O.readUint8Array(X+$,Math.min(h,te-$),function(Ue){se&&se($,te);var pe=$===0?Q:{sn:ge};pe.type="append",pe.data=Ue;try{L.postMessage(pe,[Ue.buffer])}catch{L.postMessage(pe)}ce++},oe):L.postMessage({sn:ge,type:"flush"})}ee=0,L.addEventListener("message",de,!1),Y()}function R(L,Q,O,W,X,te,se,ie,oe,he){var ce=0,$,ee=0,ge=te==="input",re=te==="output",me=new m;function de(){var Y;if($=ce*h,$<X)Q.readUint8Array(W+$,Math.min(h,X-$),function(Ue){var pe;try{pe=L.append(Ue,function(De){se&&se($+De,X)})}catch(De){oe(De);return}pe?(ee+=pe.length,O.writeUint8Array(pe,function(){ce++,setTimeout(de,1)},he),re&&me.append(pe)):(ce++,setTimeout(de,1)),ge&&me.append(Ue),se&&se($,X)},oe);else{try{Y=L.flush()}catch(Ue){oe(Ue);return}Y?(re&&me.append(Y),ee+=Y.length,O.writeUint8Array(Y,function(){ie(ee,me.get())},he)):ie(ee,me.get())}}de()}function D(L,Q,O,W,X,te,se,ie,oe,he,ce){var $=se?"output":"none";if(r.zip.useWebWorkers){var ee={sn:Q,codecClass:"Inflater",crcType:$};S(L,ee,O,W,X,te,oe,ie,he,ce)}else R(new r.zip.Inflater,O,W,X,te,$,oe,ie,he,ce)}function K(L,Q,O,W,X,te,se,ie,oe){var he="input";if(r.zip.useWebWorkers){var ce={sn:Q,options:{level:X},codecClass:"Deflater",crcType:he};S(L,ce,O,W,0,O.size,se,te,ie,oe)}else R(new r.zip.Deflater,O,W,0,O.size,he,se,te,ie,oe)}function j(L,Q,O,W,X,te,se,ie,oe,he,ce){var $="input";if(r.zip.useWebWorkers&&se){var ee={sn:Q,codecClass:"NOOP",crcType:$};S(L,ee,O,W,X,te,oe,ie,he,ce)}else R(new _,O,W,X,te,$,oe,ie,he,ce)}function z(L){var Q,O="",W,X=["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","_","_","_","","","","","","","","","+","+","","","+","+","-","-","+","-","+","","","+","+","-","-","","-","+","","","","","","","i","","","","+","+","_","_","","","_","","","","","","","","","","","","","","","","","","","_","","","","","","","","","","","","_"," "];for(Q=0;Q<L.length;Q++)W=L.charCodeAt(Q)&255,W>127?O+=X[W-128]:O+=String.fromCharCode(W);return O}function le(L){return decodeURIComponent(escape(L))}function ue(L){var Q,O="";for(Q=0;Q<L.length;Q++)O+=String.fromCharCode(L[Q]);return O}function ae(L){var Q=(L&4294901760)>>16,O=L&65535;try{return new Date(1980+((Q&65024)>>9),((Q&480)>>5)-1,Q&31,(O&63488)>>11,(O&2016)>>5,(O&31)*2,0)}catch{}}function Be(L,Q,O,W,X){if(L.version=Q.view.getUint16(O,!0),L.bitFlag=Q.view.getUint16(O+2,!0),L.compressionMethod=Q.view.getUint16(O+4,!0),L.lastModDateRaw=Q.view.getUint32(O+6,!0),L.lastModDate=ae(L.lastModDateRaw),(L.bitFlag&1)===1){X(i);return}if((W||(L.bitFlag&8)!=8)&&(L.crc32=Q.view.getUint32(O+10,!0),L.compressedSize=Q.view.getUint32(O+14,!0),L.uncompressedSize=Q.view.getUint32(O+18,!0)),L.compressedSize===4294967295||L.uncompressedSize===4294967295){X(s);return}L.filenameLength=Q.view.getUint16(O+22,!0),L.extraFieldLength=Q.view.getUint16(O+24,!0)}function be(L,Q,O){var W=0;function X(){}X.prototype.getData=function(ie,oe,he,ce){var $=this;function ee(de){var Y=B(4);return Y.view.setUint32(0,de),$.crc32==Y.view.getUint32(0)}function ge(de,Y){ce&&!ee(Y)?O(t):ie.getData(function(Ue){oe(Ue)})}function re(de){O(de||A)}function me(de){O(de||a)}L.readUint8Array($.offset,30,function(de){var Y=B(de.length,de),Ue;if(Y.view.getUint32(0)!=1347093252){O(e);return}Be($,Y,4,!1,O),Ue=$.offset+30+$.filenameLength+$.extraFieldLength,ie.init(function(){$.compressionMethod===0?j($._worker,W++,L,ie,Ue,$.compressedSize,ce,ge,he,re,me):D($._worker,W++,L,ie,Ue,$.compressedSize,ce,ge,he,re,me)},me)},re)};function te(ie){var oe=22;if(L.size<oe){O(e);return}var he=256*256,ce=oe+he;$(oe,function(){$(Math.min(ce,L.size),function(){O(e)})});function $(ee,ge){L.readUint8Array(L.size-ee,ee,function(re){for(var me=re.length-oe;me>=0;me--)if(re[me]===80&&re[me+1]===75&&re[me+2]===5&&re[me+3]===6){ie(new DataView(re.buffer,me,oe));return}ge()},function(){O(o)})}}var se={getEntries:function(ie){var oe=this._worker;te(function(he){var ce,$;if(ce=he.getUint32(16,!0),$=he.getUint16(8,!0),ce<0||ce>=L.size){O(e);return}L.readUint8Array(ce,L.size-ce,function(ee){var ge,re=0,me=[],de,Y,Ue,pe=B(ee.length,ee);for(ge=0;ge<$;ge++){if(de=new X,de._worker=oe,pe.view.getUint32(re)!=1347092738){O(e);return}Be(de,pe,re+6,!0,O),de.commentLength=pe.view.getUint16(re+32,!0),de.directory=(pe.view.getUint8(re+38)&16)==16,de.offset=pe.view.getUint32(re+42,!0),Y=ue(pe.array.subarray(re+46,re+46+de.filenameLength)),de.filename=(de.bitFlag&2048)===2048?le(Y):z(Y),!de.directory&&de.filename.charAt(de.filename.length-1)=="/"&&(de.directory=!0),Ue=ue(pe.array.subarray(re+46+de.filenameLength+de.extraFieldLength,re+46+de.filenameLength+de.extraFieldLength+de.commentLength)),de.comment=(de.bitFlag&2048)===2048?le(Ue):z(Ue),me.push(de),re+=46+de.filenameLength+de.extraFieldLength+de.commentLength}ie(me)},function(){O(o)})})},close:function(ie){this._worker&&(this._worker.terminate(),this._worker=null),ie&&ie()},_worker:null};r.zip.useWebWorkers?V("inflater",function(ie){se._worker=ie,Q(se)},function(ie){O(ie)}):Q(se)}function xe(L){return unescape(encodeURIComponent(L))}function Ie(L){var Q,O=[];for(Q=0;Q<L.length;Q++)O.push(L.charCodeAt(Q));return O}function Fe(L,Q,O,W){var X={},te=[],se=0,ie=0;function oe($){O($||n)}function he($){O($||A)}var ce={add:function($,ee,ge,re,me){var de,Y,Ue,pe=this._worker;function De(Ae){var Re;Ue=me.lastModDate||new Date,de=B(26),X[$]={headerArray:de.array,directory:me.directory,filename:Y,offset:se,comment:Ie(xe(me.comment||""))},de.view.setUint32(0,335546376),me.version&&de.view.setUint8(0,me.version),!W&&me.level!==0&&!me.directory&&de.view.setUint16(4,2048),de.view.setUint16(6,(Ue.getHours()<<6|Ue.getMinutes())<<5|Ue.getSeconds()/2,!0),de.view.setUint16(8,(Ue.getFullYear()-1980<<4|Ue.getMonth()+1)<<5|Ue.getDate(),!0),de.view.setUint16(22,Y.length,!0),Re=B(30+Y.length),Re.view.setUint32(0,1347093252),Re.array.set(de.array,4),Re.array.set(Y,30),se+=Re.array.length,L.writeUint8Array(Re.array,Ae,oe)}function fe(Ae,Re){var ze=B(16);se+=Ae||0,ze.view.setUint32(0,1347094280),typeof Re<"u"&&(de.view.setUint32(10,Re,!0),ze.view.setUint32(4,Re,!0)),ee&&(ze.view.setUint32(8,Ae,!0),de.view.setUint32(14,Ae,!0),ze.view.setUint32(12,ee.size,!0),de.view.setUint32(18,ee.size,!0)),L.writeUint8Array(ze.array,function(){se+=16,ge()},oe)}function je(){if(me=me||{},$=$.trim(),me.directory&&$.charAt($.length-1)!="/"&&($+="/"),X.hasOwnProperty($)){O(l);return}Y=Ie(xe($)),te.push($),De(function(){ee?W||me.level===0?j(pe,ie++,ee,L,0,ee.size,!0,fe,re,he,oe):K(pe,ie++,ee,L,me.level,fe,re,he,oe):fe()})}ee?ee.init(je,he):je()},close:function($){this._worker&&(this._worker.terminate(),this._worker=null);var ee,ge=0,re=0,me,de;for(me=0;me<te.length;me++)de=X[te[me]],ge+=46+de.filename.length+de.comment.length;for(ee=B(ge+22),me=0;me<te.length;me++)de=X[te[me]],ee.view.setUint32(re,1347092738),ee.view.setUint16(re+4,5120),ee.array.set(de.headerArray,re+6),ee.view.setUint16(re+32,de.comment.length,!0),de.directory&&ee.view.setUint8(re+38,16),ee.view.setUint32(re+42,de.offset,!0),ee.array.set(de.filename,re+46),ee.array.set(de.comment,re+46+de.filename.length),re+=46+de.filename.length+de.comment.length;ee.view.setUint32(re,1347093766),ee.view.setUint16(re+8,te.length,!0),ee.view.setUint16(re+10,te.length,!0),ee.view.setUint32(re+12,ge,!0),ee.view.setUint32(re+16,se,!0),L.writeUint8Array(ee.array,function(){L.getData($)},oe)},_worker:null};r.zip.useWebWorkers?V("deflater",function($){ce._worker=$,Q(ce)},function($){O($)}):Q(ce)}function Qe(L){var Q=document.createElement("a");return L.map(function(O){return Q.href=O,Q.href})}var Ge={deflater:["z-worker.js","deflate.js"],inflater:["z-worker.js","inflate.js"]};function V(L,Q,O){if(r.zip.workerScripts!==null&&r.zip.workerScriptsPath!==null){O(new Error("Either zip.workerScripts or zip.workerScriptsPath may be set, not both."));return}var W;if(r.zip.workerScripts){if(W=r.zip.workerScripts[L],!Array.isArray(W)){O(new Error("zip.workerScripts."+L+" is not an array!"));return}W=Qe(W)}else W=Ge[L].slice(0),W[0]=(r.zip.workerScriptsPath||"")+W[0];var X=new Worker(W[0]);X.codecTime=X.crcTime=0,X.postMessage({type:"importScripts",scripts:W.slice(1)}),X.addEventListener("message",te);function te(ie){var oe=ie.data;if(oe.error){X.terminate(),O(oe.error);return}oe.type==="importScripts"&&(X.removeEventListener("message",te),X.removeEventListener("error",se),Q(X))}X.addEventListener("error",se);function se(ie){X.terminate(),O(ie)}}function Z(L){console.error(L)}r.zip={Reader:y,Writer:b,BlobReader:v,Data64URIReader:P,TextReader:x,BlobWriter:E,Data64URIWriter:I,TextWriter:C,createReader:function(L,Q,O){O=O||Z,L.init(function(){be(L,Q,O)},O)},createWriter:function(L,Q,O,W){O=O||Z,W=!!W,L.init(function(){Fe(L,Q,O,W)},O)},useWebWorkers:!0,workerScriptsPath:null,workerScripts:null}})(qm);const iL=function(r){var e="HTTP Range not supported.",t=r.Reader,i=r.Writer,s,o;try{o=new Blob([new DataView(new ArrayBuffer(0))]).size===0}catch{}function n(f){var m=document.createElement("a");return m.href=f,m.protocol==="http:"||m.protocol==="https:"}function a(f){var m=this;function _(y,x){var P;m.data?y():(P=new XMLHttpRequest,P.addEventListener("load",function(){m.size||(m.size=Number(P.getResponseHeader("Content-Length"))||Number(P.response.byteLength)),m.data=new Uint8Array(P.response),y()},!1),P.addEventListener("error",x,!1),P.open("GET",f),P.responseType="arraybuffer",P.send())}function u(y,x){if(!n(f)){_(y,x);return}var P=new XMLHttpRequest;P.addEventListener("load",function(){m.size=Number(P.getResponseHeader("Content-Length")),m.size?y():_(y,x)},!1),P.addEventListener("error",x,!1),P.open("HEAD",f),P.send()}function B(y,x,P,v){_(function(){P(new Uint8Array(m.data.subarray(y,y+x)))},v)}m.size=0,m.init=u,m.readUint8Array=B}a.prototype=new t,a.prototype.constructor=a;function A(f){var m=this;function _(y,x){var P=new XMLHttpRequest;P.addEventListener("load",function(){m.size=Number(P.getResponseHeader("Content-Length")),P.getResponseHeader("Accept-Ranges")=="bytes"?y():x(e)},!1),P.addEventListener("error",x,!1),P.open("HEAD",f),P.send()}function u(y,x,P,v){var b=new XMLHttpRequest;b.open("GET",f),b.responseType="arraybuffer",b.setRequestHeader("Range","bytes="+y+"-"+(y+x-1)),b.addEventListener("load",function(){P(b.response)},!1),b.addEventListener("error",v,!1),b.send()}function B(y,x,P,v){u(y,x,function(b){P(new Uint8Array(b))},v)}m.size=0,m.init=_,m.readUint8Array=B}A.prototype=new t,A.prototype.constructor=A;function l(f){var m=this;function _(B,y){m.size=f.byteLength,B()}function u(B,y,x,P){x(new Uint8Array(f.slice(B,B+y)))}m.size=0,m.init=_,m.readUint8Array=u}l.prototype=new t,l.prototype.constructor=l;function h(){var f,m=this;function _(y,x){f=new Uint8Array,y()}function u(y,x,P){var v=new Uint8Array(f.length+y.length);v.set(f),v.set(y,f.length),f=v,x()}function B(y){y(f.buffer)}m.init=_,m.writeUint8Array=u,m.getData=B}h.prototype=new i,h.prototype.constructor=h;function d(f,m){var _,u=this;function B(P,v){f.createWriter(function(b){_=b,P()},v)}function y(P,v,b){var C=new Blob([o?P:P.buffer],{type:m});_.onwrite=function(){_.onwrite=null,v()},_.onerror=b,_.write(C)}function x(P){f.file(P)}u.init=B,u.writeUint8Array=y,u.getData=x}d.prototype=new i,d.prototype.constructor=d,r.FileWriter=d,r.HttpReader=a,r.HttpRangeReader=A,r.ArrayBufferReader=l,r.ArrayBufferWriter=h,r.fs&&(s=r.fs.ZipDirectoryEntry,s.prototype.addHttpContent=function(f,m,_){function u(B,y,x,P){if(B.directory)return P?new s(B.fs,y,x,B):new r.fs.ZipFileEntry(B.fs,y,x,B);throw"Parent entry is not a directory."}return u(this,f,{data:m,Reader:_?A:a})},s.prototype.importHttpContent=function(f,m,_,u){this.importZip(m?new A(f):new a(f),_,u)},r.fs.FS.prototype.importHttpContent=function(f,m,_,u){this.entries=[],this.root=new s(this),this.root.importHttpContent(f,m,_,u)})},sL=qm.zip;iL(sL);c.vec2();c.vec3();c.vec3();c.vec3();var rL=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function oL(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var $m={exports:{}};(function(r,e){(function(t,i){r.exports=i()})(rL,function(){var t=function(){function i(m){return n.appendChild(m.dom),m}function s(m){for(var _=0;_<n.children.length;_++)n.children[_].style.display=_===m?"block":"none";o=m}var o=0,n=document.createElement("div");n.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",n.addEventListener("click",function(m){m.preventDefault(),s(++o%n.children.length)},!1);var a=(performance||Date).now(),A=a,l=0,h=i(new t.Panel("FPS","#0ff","#002")),d=i(new t.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var f=i(new t.Panel("MB","#f08","#201"));return s(0),{REVISION:16,dom:n,addPanel:i,showPanel:s,begin:function(){a=(performance||Date).now()},end:function(){l++;var m=(performance||Date).now();if(d.update(m-a,200),m>A+1e3&&(h.update(1e3*l/(m-A),100),A=m,l=0,f)){var _=performance.memory;f.update(_.usedJSHeapSize/1048576,_.jsHeapSizeLimit/1048576)}return m},update:function(){a=this.end()},domElement:n,setMode:s}};return t.Panel=function(i,s,o){var n=1/0,a=0,A=Math.round,l=A(window.devicePixelRatio||1),h=80*l,d=48*l,f=3*l,m=2*l,_=3*l,u=15*l,B=74*l,y=30*l,x=document.createElement("canvas");x.width=h,x.height=d,x.style.cssText="width:80px;height:48px";var P=x.getContext("2d");return P.font="bold "+9*l+"px Helvetica,Arial,sans-serif",P.textBaseline="top",P.fillStyle=o,P.fillRect(0,0,h,d),P.fillStyle=s,P.fillText(i,f,m),P.fillRect(_,u,B,y),P.fillStyle=o,P.globalAlpha=.9,P.fillRect(_,u,B,y),{dom:x,update:function(v,b){n=Math.min(n,v),a=Math.max(a,v),P.fillStyle=o,P.globalAlpha=1,P.fillRect(0,0,h,u),P.fillStyle=s,P.fillText(A(v)+" "+i+" ("+A(n)+"-"+A(a)+")",f,m),P.drawImage(x,_+l,u,B-l,y,_,u,B-l,y),P.fillRect(_+B-l,u,l,y),P.fillStyle=o,P.globalAlpha=.9,P.fillRect(_+B-l,u,l,A((1-v/b)*y))}}},t})})($m);var nL=$m.exports;const aL=oL(nL);function AL(r){const e=new pR(r,{containerElement:document.getElementById("treeViewContainer"),hierarchy:"types",autoExpandDepth:1}),t=new bl({items:[[{title:"View Fit",doAction:function(i){const s=i.viewer.scene,o=[];i.treeViewPlugin.withNodeTree(i.treeViewNode,n=>{n.objectId&&o.push(n.objectId)}),s.setObjectsVisible(o,!0),s.setObjectsHighlighted(o,!0),i.viewer.cameraFlight.flyTo({projection:"perspective",aabb:s.getAABB(o),duration:.5},()=>{setTimeout(function(){s.setObjectsHighlighted(s.highlightedObjectIds,!1)},500)})}},{title:"View Fit All",doAction:function(i){const s=i.viewer.scene;i.viewer.cameraFlight.flyTo({projection:"perspective",aabb:s.getAABB({}),duration:.5})}}],[{title:"Hide",doAction:function(i){i.treeViewPlugin.withNodeTree(i.treeViewNode,s=>{if(s.objectId){const o=i.viewer.scene.objects[s.objectId];o&&(o.visible=!1)}})}},{title:"Hide Others",doAction:function(i){const s=i.viewer.scene;s.setObjectsVisible(s.visibleObjectIds,!1),s.setObjectsXRayed(s.xrayedObjectIds,!1),s.setObjectsSelected(s.selectedObjectIds,!1),s.setObjectsHighlighted(s.highlightedObjectIds,!1),i.treeViewPlugin.withNodeTree(i.treeViewNode,o=>{if(o.objectId){const n=s.objects[o.objectId];n&&(n.visible=!0)}})}},{title:"Hide All",getEnabled:function(i){return i.viewer.scene.visibleObjectIds.length>0},doAction:function(i){i.viewer.scene.setObjectsVisible(i.viewer.scene.visibleObjectIds,!1)}}],[{title:"Show",doAction:function(i){i.treeViewPlugin.withNodeTree(i.treeViewNode,s=>{if(s.objectId){const o=i.viewer.scene.objects[s.objectId];o&&(o.visible=!0,o.xrayed=!1,o.selected=!1)}})}},{title:"Show Others",doAction:function(i){const s=i.viewer.scene;s.setObjectsVisible(s.objectIds,!0),s.setObjectsXRayed(s.xrayedObjectIds,!1),s.setObjectsSelected(s.selectedObjectIds,!1),i.treeViewPlugin.withNodeTree(i.treeViewNode,o=>{if(o.objectId){const n=s.objects[o.objectId];n&&(n.visible=!1)}})}},{title:"Show All",getEnabled:function(i){const s=i.viewer.scene;return s.numVisibleObjects<s.numObjects},doAction:function(i){const s=i.viewer.scene;s.setObjectsVisible(s.objectIds,!0),s.setObjectsXRayed(s.xrayedObjectIds,!1),s.setObjectsSelected(s.selectedObjectIds,!1)}}],[{title:"X-Ray",doAction:function(i){i.treeViewPlugin.withNodeTree(i.treeViewNode,s=>{if(s.objectId){const o=i.viewer.scene.objects[s.objectId];o&&(o.xrayed=!0,o.visible=!0)}})}},{title:"Undo X-Ray",doAction:function(i){i.treeViewPlugin.withNodeTree(i.treeViewNode,s=>{if(s.objectId){const o=i.viewer.scene.objects[s.objectId];o&&(o.xrayed=!1)}})}},{title:"X-Ray Others",doAction:function(i){const s=i.viewer.scene;s.setObjectsVisible(s.objectIds,!0),s.setObjectsXRayed(s.objectIds,!0),s.setObjectsSelected(s.selectedObjectIds,!1),s.setObjectsHighlighted(s.highlightedObjectIds,!1),i.treeViewPlugin.withNodeTree(i.treeViewNode,o=>{if(o.objectId){const n=s.objects[o.objectId];n&&(n.xrayed=!1)}})}},{title:"Reset X-Ray",getEnabled:function(i){return i.viewer.scene.numXRayedObjects>0},doAction:function(i){i.viewer.scene.setObjectsXRayed(i.viewer.scene.xrayedObjectIds,!1)}}],[{title:"Select",doAction:function(i){i.treeViewPlugin.withNodeTree(i.treeViewNode,s=>{if(s.objectId){const o=i.viewer.scene.objects[s.objectId];o&&(o.selected=!0,o.visible=!0)}})}},{title:"Deselect",doAction:function(i){i.treeViewPlugin.withNodeTree(i.treeViewNode,s=>{if(s.objectId){const o=i.viewer.scene.objects[s.objectId];o&&(o.selected=!1)}})}},{title:"Clear Selection",getEnabled:function(i){return i.viewer.scene.numSelectedObjects>0},doAction:function(i){i.viewer.scene.setObjectsSelected(i.viewer.scene.selectedObjectIds,!1)}}]]});return e.on("contextmenu",i=>{t.context={viewer:i.viewer,treeViewPlugin:i.treeViewPlugin,treeViewNode:i.treeViewNode,entity:i.viewer.scene.objects[i.treeViewNode.objectId]},t.show(i.event.pageX,i.event.pageY)}),e.on("nodeTitleClicked",i=>{var A;const s=r.scene,o=[];i.treeViewPlugin.withNodeTree(i.treeViewNode,l=>{l.objectId&&o.push(l.objectId)}),r.cameraFlight.flyTo({aabb:s.getAABB(o),duration:.5});const n=((A=r.metaScene.metaObjects[i.treeViewNode.objectId])==null?void 0:A.propertySets)??[],a={};for(const l of n)for(const h of l.properties)a[h.name]=h.value;console.log(a)}),e}function lL(r,e){const t=new bl({enabled:!0,context:{viewer:r},items:[[{title:"Hide All",getEnabled:function(a){return a.viewer.scene.numVisibleObjects>0},doAction:function(a){a.viewer.scene.setObjectsVisible(a.viewer.scene.visibleObjectIds,!1)}},{title:"Show All",getEnabled:function(a){const A=a.viewer.scene;return A.numVisibleObjects<A.numObjects},doAction:function(a){const A=a.viewer.scene;A.setObjectsVisible(A.objectIds,!0),A.setObjectsXRayed(A.xrayedObjectIds,!1),A.setObjectsSelected(A.selectedObjectIds,!1)}}],[{title:"View Fit All",doAction:function(a){a.viewer.cameraFlight.flyTo({aabb:a.viewer.scene.getAABB()})}}]]}),i=new bl({items:[[{title:"View Fit",doAction:function(a){const A=a.viewer,l=A.scene,h=a.entity;A.cameraFlight.flyTo({aabb:h.aabb,duration:.5},()=>{setTimeout(function(){l.setObjectsHighlighted(l.highlightedObjectIds,!1)},500)})}},{title:"View Fit All",doAction:function(a){const A=a.viewer.scene;a.viewer.cameraFlight.flyTo({projection:"perspective",aabb:A.getAABB(),duration:.5})}},{title:"Show in Tree",doAction:function(a){const A=a.entity.id;a.treeViewPlugin.showNode(A)}}],[{title:"Hide",getEnabled:function(a){return a.entity.visible},doAction:function(a){a.entity.visible=!1}},{title:"Hide Others",doAction:function(a){const A=a.viewer,l=A.scene,h=a.entity,d=A.metaScene.metaObjects[h.id];d&&(l.setObjectsVisible(l.visibleObjectIds,!1),l.setObjectsXRayed(l.xrayedObjectIds,!1),l.setObjectsSelected(l.selectedObjectIds,!1),l.setObjectsHighlighted(l.highlightedObjectIds,!1),d.withMetaObjectsInSubtree(f=>{const m=l.objects[f.id];m&&(m.visible=!0)}))}},{title:"Hide All",getEnabled:function(a){return a.viewer.scene.numVisibleObjects>0},doAction:function(a){a.viewer.scene.setObjectsVisible(a.viewer.scene.visibleObjectIds,!1)}},{title:"Show All",getEnabled:function(a){const A=a.viewer.scene;return A.numVisibleObjects<A.numObjects},doAction:function(a){const A=a.viewer.scene;A.setObjectsVisible(A.objectIds,!0)}}],[{title:"X-Ray",getEnabled:function(a){return!a.entity.xrayed},doAction:function(a){a.entity.xrayed=!0}},{title:"Undo X-Ray",getEnabled:function(a){return a.entity.xrayed},doAction:function(a){a.entity.xrayed=!1}},{title:"X-Ray Others",doAction:function(a){const A=a.viewer,l=A.scene,h=a.entity,d=A.metaScene.metaObjects[h.id];d&&(l.setObjectsVisible(l.objectIds,!0),l.setObjectsXRayed(l.objectIds,!0),l.setObjectsSelected(l.selectedObjectIds,!1),l.setObjectsHighlighted(l.highlightedObjectIds,!1),d.withMetaObjectsInSubtree(f=>{const m=l.objects[f.id];m&&(m.xrayed=!1)}))}},{title:"Reset X-Ray",getEnabled:function(a){return a.viewer.scene.numXRayedObjects>0},doAction:function(a){a.viewer.scene.setObjectsXRayed(a.viewer.scene.xrayedObjectIds,!1)}}],[{title:"Select",getEnabled:function(a){return!a.entity.selected},doAction:function(a){a.entity.selected=!0}},{title:"Undo select",getEnabled:function(a){return a.entity.selected},doAction:function(a){a.entity.selected=!1}},{title:"Clear Selection",getEnabled:function(a){return a.viewer.scene.numSelectedObjects>0},doAction:function(a){a.viewer.scene.setObjectsSelected(a.viewer.scene.selectedObjectIds,!1)}}]],enabled:!0});r.cameraControl.on("rightClick",function(a){var A=r.scene.pick({canvasPos:a.canvasPos});A&&A.entity.isObject?(i.context={viewer:r,treeViewPlugin:e,entity:A.entity},i.show(a.pagePos[0],a.pagePos[1])):(t.context={viewer:r},t.show(a.pagePos[0],a.pagePos[1])),a.event.preventDefault()});let s=0,o=0,n="";document.querySelector("#xeokit_canvas").addEventListener("mousedown",a=>{s=a.offsetX,o=a.offsetY}),document.querySelector("#xeokit_canvas").addEventListener("mouseup",a=>{if(a.offsetX!=s||a.offsetY!=o)return;const A=r.scene.pick({canvasPos:[a.offsetX,a.offsetY],pickSurfacePrecision:!0});if(!(!A||!A.entity))switch(n="",a.button){case 0:a.shiftKey?r.scene.setObjectsSelected([A.entity.id],!A.entity.selected):r.scene.selectedObjectIds.length==0?r.scene.setObjectsSelected([A.entity.id],!A.entity.selected):(r.scene.setObjectsSelected(r.scene.selectedObjectIds,!1),r.scene.setObjectsSelected([A.entity.id],!0));break;case 1:r.cameraFlight.flyTo({aabb:A.entity.aabb,duration:.5});break}}),document.querySelector("#xeokit_canvas").addEventListener("mousemove",a=>{if(r.scene.setObjectsSelected([n],!1),a.buttons!=0)return;const A=r.scene.pick({canvasPos:[a.offsetX,a.offsetY],pickSurfacePrecision:!0});!A||!A.entity||(n=A.entity.id,r.scene.setObjectsSelected([n],!0))})}const Dr=new J1({canvasId:"xeokit_canvas",transparent:!0,dtxEnabled:!0}),Ca=new aL;Ca.showPanel(0);document.body.appendChild(Ca.dom);console.log(Dr.scene);Dr.scene.on("tick",r=>{Ca.begin(),Ca.end()});const Tf=document.querySelector("input");Tf.addEventListener("change",async()=>{const r=await Tf.files[0].arrayBuffer(),t=new uR(Dr).load({id:"myModel",gltf:r});t.on("loaded",()=>{Dr.cameraFlight.jumpTo(t)}),t.on("error",i=>{console.log(i)})});const cL=AL(Dr);lL(Dr,cL)});export default hL();
